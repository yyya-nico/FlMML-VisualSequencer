var $n=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var B=(t,e,r)=>($n(t,e,"read from private field"),r?r.call(t):e.get(t)),ke=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},xe=(t,e,r,a)=>($n(t,e,"write to private field"),a?a.call(t,r):e.set(t,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function r(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(s){if(s.ep)return;s.ep=!0;const n=r(s);fetch(s.href,n)}})();const da="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var at=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function fa(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Qn={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(t,e){(function(r,a){t.exports=a()})(self,function(){return(()=>{var r={587:(n,c,h)=>{var m;(m=(function(l,g){Object.defineProperty(g,"__esModule",{value:!0}),g.MsgTypes=g.SAMPLE_RATE=void 0,g.SAMPLE_RATE=44100,g.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(c,[h,c]))===void 0||(n.exports=m)},581:(n,c,h)=>{var m;(m=(function(l,g){Object.defineProperty(g,"__esModule",{value:!0}),g.FlMMLAudioExportError=void 0;class f extends Error{constructor(...k){super(...k),this.name="FlMMLAudioExportError"}}g.FlMMLAudioExportError=f}).apply(c,[h,c]))===void 0||(n.exports=m)},643:function(n,c,h){var m,l,g=this&&this.__awaiter||function(f,d,k,D){return new(k||(k=Promise))(function(_,b){function E(M){try{A(D.next(M))}catch(S){b(S)}}function w(M){try{A(D.throw(M))}catch(S){b(S)}}function A(M){var S;M.done?_(M.value):(S=M.value,S instanceof k?S:new k(function(U){U(S)})).then(E,w)}A((D=D.apply(f,d||[])).next())})};m=[h,c,h(587),h(581),h(158)],(l=(function(f,d,k,D,_){Object.defineProperty(d,"__esModule",{value:!0}),d.FlMMLonHTML5=d.FlMMLAudioExportError=d.FlMML=void 0,Object.defineProperty(d,"FlMMLAudioExportError",{enumerable:!0,get:function(){return D.FlMMLAudioExportError}});const b="flmml-on-html5.worker.js";class E{constructor(A=b){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof A=="string"&&(A={workerURL:A});const M=A.workerURL||b,S=A.infoInterval>=0?A.infoInterval:125;this.bufferSize=A.bufferSize>=128?Math.floor(A.bufferSize-A.bufferSize%128):8192,this.bufferMultiple=A.bufferMultiple>=1?Math.floor(A.bufferMultiple):32,this.lamejsURL=A.lamejsURL,(this.worker=new Worker(A.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${M}")`],{type:"application/javascript"})):M)).addEventListener("message",U=>{this.onMessage(U)}),this.setInfoInterval(S)}static initWebAudio(){const A=E.audioCtx=new AudioContext({sampleRate:k.SAMPLE_RATE}),M=A.createBufferSource();M.connect(A.destination),M.start(0),A.resume(),M.stop()}static hookInitWebAudio(A){const M=document.querySelectorAll(A);M.forEach(S=>{S.addEventListener("click",function U(){E.audioCtx||E.initWebAudio(),M.forEach($=>{$.removeEventListener("click",U,!0)})},!0)})}static prepare(A){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{E.hookInitWebAudio(A)}):E.hookInitWebAudio(A)}onMessage(A){const M=A.data;switch(M.type){case k.MsgTypes.COMPCOMP:this.totalMSec=M.info.totalMSec,this.totalTimeStr=M.info.totalTimeStr,this.warnings=M.info.warnings,this.metaTitle=M.info.metaTitle,this.metaComment=M.info.metaComment,this.metaArtist=M.info.metaArtist,this.metaCoding=M.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case k.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(M),this.trigger("buffering",{progress:M.progress});break;case k.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case k.MsgTypes.SYNCINFO:this._isPlaying=M.info._isPlaying,this._isPaused=M.info._isPaused,this.nowMSec=M.info.nowMSec,this.nowTimeStr=M.info.nowTimeStr,this.voiceCount=M.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case k.MsgTypes.PLAYSOUND:this.playSound();break;case k.MsgTypes.STOPSOUND:this.stopSound();break;case k.MsgTypes.EXPORT:M.data?this.completeAudioExport(M.data):this.errorAudioExport(M.errorMsg)}}boot(){this.worker.postMessage({type:k.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const A=E.audioCtx,M=this.gainNode=A.createGain();M.gain.value=this.volume/127,M.connect(A.destination),g(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(U=>{const $=new FileReader;$.onload=G=>{A.audioWorklet.addModule(G.target.result).then(U)},$.readAsDataURL(new Blob([_.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const S=this.workletNode=new AudioWorkletNode(A,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});S.connect(M),this.worker.postMessage({type:k.MsgTypes.PLAYSOUND,workletPort:S.port},[S.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:k.MsgTypes.STOPSOUND})}trigger(A,M){const S=this.events[A];if(!S)return;const U={};for(let $ in M)U[$]=M[$];for(let $=0,G=S.length;$<G;$++)S[$]&&S[$].call(this,U)}exportAudio(A,M,S={}){return E.audioCtx||E.initWebAudio(),this.booted||this.boot(),new Promise((U,$)=>{this.audioExportResolve?$(new D.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:k.MsgTypes.EXPORT,mml:A,format:M},S)),this.audioExportResolve=U,this.audioExportReject=$)})}completeAudioExport(A){this.audioExportResolve&&(this.audioExportResolve(A),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(A){this.audioExportReject&&(this.audioExportReject(new D.FlMMLAudioExportError(A)),this.audioExportResolve=null,this.audioExportReject=null)}play(A){E.audioCtx||E.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:k.MsgTypes.PLAY,mml:A})}stop(){this.worker.postMessage({type:k.MsgTypes.STOP})}pause(){this.worker.postMessage({type:k.MsgTypes.PAUSE})}exportWav(A){return this.exportAudio(A,"wav")}exportMp3(A,M){return this.exportAudio(A,"mp3",{bitrate:M})}setMasterVolume(A){this.volume=A,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(A){this.worker.postMessage({type:k.MsgTypes.SYNCINFO,interval:A})}syncInfo(){this.worker.postMessage({type:k.MsgTypes.SYNCINFO,interval:null})}addEventListener(A,M){let S=this.events[A];S||(S=this.events[A]=[]);for(let U=S.length;U--;)if(S[U]===M)return!1;return S.push(M),!0}removeEventListener(A,M){const S=this.events[A];if(!S)return!1;for(let U=S.length;U--;)if(S[U]===M)return S.splice(U,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}d.FlMML=E,d.FlMMLonHTML5=E}).apply(c,m))===void 0||(n.exports=l)},158:(n,c,h)=>{h.r(c),h.d(c,{FlMMLWorkletScript:()=>m});const m='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},a={};function s(n){var c=a[n];if(c!==void 0)return c.exports;var h=a[n]={exports:{}};return r[n].call(h.exports,h,h.exports,s),h.exports}return s.d=(n,c)=>{for(var h in c)s.o(c,h)&&!s.o(n,h)&&Object.defineProperty(n,h,{enumerable:!0,get:c[h]})},s.o=(n,c)=>Object.prototype.hasOwnProperty.call(n,c),s.r=n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},s(643)})()})})(Qn);var Zn=Qn.exports;function pt(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var er={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(t,e){(function(r){t.exports=r()})(function(){return function r(a,s,n){function c(l,g){if(!s[l]){if(!a[l]){var f=typeof pt=="function"&&pt;if(!g&&f)return f(l,!0);if(h)return h(l,!0);var d=new Error("Cannot find module '"+l+"'");throw d.code="MODULE_NOT_FOUND",d}var k=s[l]={exports:{}};a[l][0].call(k.exports,function(D){var _=a[l][1][D];return c(_||D)},k,k.exports,r,a,s,n)}return s[l].exports}for(var h=typeof pt=="function"&&pt,m=0;m<n.length;m++)c(n[m]);return c}({1:[function(r,a,s){(function(n){var c=n.MutationObserver||n.WebKitMutationObserver,h;if(c){var m=0,l=new c(D),g=n.document.createTextNode("");l.observe(g,{characterData:!0}),h=function(){g.data=m=++m%2}}else if(!n.setImmediate&&typeof n.MessageChannel<"u"){var f=new n.MessageChannel;f.port1.onmessage=D,h=function(){f.port2.postMessage(0)}}else"document"in n&&"onreadystatechange"in n.document.createElement("script")?h=function(){var b=n.document.createElement("script");b.onreadystatechange=function(){D(),b.onreadystatechange=null,b.parentNode.removeChild(b),b=null},n.document.documentElement.appendChild(b)}:h=function(){setTimeout(D,0)};var d,k=[];function D(){d=!0;for(var b,E,w=k.length;w;){for(E=k,k=[],b=-1;++b<w;)E[b]();w=k.length}d=!1}a.exports=_;function _(b){k.push(b)===1&&!d&&h()}}).call(this,typeof at<"u"?at:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,a,s){var n=r(1);function c(){}var h={},m=["REJECTED"],l=["FULFILLED"],g=["PENDING"];a.exports=f;function f(S){if(typeof S!="function")throw new TypeError("resolver must be a function");this.state=g,this.queue=[],this.outcome=void 0,S!==c&&_(this,S)}f.prototype.catch=function(S){return this.then(null,S)},f.prototype.then=function(S,U){if(typeof S!="function"&&this.state===l||typeof U!="function"&&this.state===m)return this;var $=new this.constructor(c);if(this.state!==g){var G=this.state===l?S:U;k($,G,this.outcome)}else this.queue.push(new d($,S,U));return $};function d(S,U,$){this.promise=S,typeof U=="function"&&(this.onFulfilled=U,this.callFulfilled=this.otherCallFulfilled),typeof $=="function"&&(this.onRejected=$,this.callRejected=this.otherCallRejected)}d.prototype.callFulfilled=function(S){h.resolve(this.promise,S)},d.prototype.otherCallFulfilled=function(S){k(this.promise,this.onFulfilled,S)},d.prototype.callRejected=function(S){h.reject(this.promise,S)},d.prototype.otherCallRejected=function(S){k(this.promise,this.onRejected,S)};function k(S,U,$){n(function(){var G;try{G=U($)}catch(ce){return h.reject(S,ce)}G===S?h.reject(S,new TypeError("Cannot resolve promise with itself")):h.resolve(S,G)})}h.resolve=function(S,U){var $=b(D,U);if($.status==="error")return h.reject(S,$.value);var G=$.value;if(G)_(S,G);else{S.state=l,S.outcome=U;for(var ce=-1,oe=S.queue.length;++ce<oe;)S.queue[ce].callFulfilled(U)}return S},h.reject=function(S,U){S.state=m,S.outcome=U;for(var $=-1,G=S.queue.length;++$<G;)S.queue[$].callRejected(U);return S};function D(S){var U=S&&S.then;if(S&&(typeof S=="object"||typeof S=="function")&&typeof U=="function")return function(){U.apply(S,arguments)}}function _(S,U){var $=!1;function G(ye){$||($=!0,h.reject(S,ye))}function ce(ye){$||($=!0,h.resolve(S,ye))}function oe(){U(ce,G)}var pe=b(oe);pe.status==="error"&&G(pe.value)}function b(S,U){var $={};try{$.value=S(U),$.status="success"}catch(G){$.status="error",$.value=G}return $}f.resolve=E;function E(S){return S instanceof this?S:h.resolve(new this(c),S)}f.reject=w;function w(S){var U=new this(c);return h.reject(U,S)}f.all=A;function A(S){var U=this;if(Object.prototype.toString.call(S)!=="[object Array]")return this.reject(new TypeError("must be an array"));var $=S.length,G=!1;if(!$)return this.resolve([]);for(var ce=new Array($),oe=0,pe=-1,ye=new this(c);++pe<$;)me(S[pe],pe);return ye;function me(N,x){U.resolve(N).then(F,function(Y){G||(G=!0,h.reject(ye,Y))});function F(Y){ce[x]=Y,++oe===$&&!G&&(G=!0,h.resolve(ye,ce))}}}f.race=M;function M(S){var U=this;if(Object.prototype.toString.call(S)!=="[object Array]")return this.reject(new TypeError("must be an array"));var $=S.length,G=!1;if(!$)return this.resolve([]);for(var ce=-1,oe=new this(c);++ce<$;)pe(S[ce]);return oe;function pe(ye){U.resolve(ye).then(function(me){G||(G=!0,h.resolve(oe,me))},function(me){G||(G=!0,h.reject(oe,me))})}}},{1:1}],3:[function(r,a,s){(function(n){typeof n.Promise!="function"&&(n.Promise=r(2))}).call(this,typeof at<"u"?at:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,a,s){var n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(o){return typeof o}:function(o){return o&&typeof Symbol=="function"&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o};function c(o,u){if(!(o instanceof u))throw new TypeError("Cannot call a class as a function")}function h(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var m=h();function l(){try{if(!m||!m.open)return!1;var o=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),u=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!o||u)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function g(o,u){o=o||[],u=u||{};try{return new Blob(o,u)}catch(p){if(p.name!=="TypeError")throw p;for(var i=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,v=new i,y=0;y<o.length;y+=1)v.append(o[y]);return v.getBlob(u.type)}}typeof Promise>"u"&&r(3);var f=Promise;function d(o,u){u&&o.then(function(i){u(null,i)},function(i){u(i)})}function k(o,u,i){typeof u=="function"&&o.then(u),typeof i=="function"&&o.catch(i)}function D(o){return typeof o!="string"&&(console.warn(o+" used as a key, but it is not a string."),o=String(o)),o}function _(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var b="local-forage-detect-blob-support",E=void 0,w={},A=Object.prototype.toString,M="readonly",S="readwrite";function U(o){for(var u=o.length,i=new ArrayBuffer(u),v=new Uint8Array(i),y=0;y<u;y++)v[y]=o.charCodeAt(y);return i}function $(o){return new f(function(u){var i=o.transaction(b,S),v=g([""]);i.objectStore(b).put(v,"key"),i.onabort=function(y){y.preventDefault(),y.stopPropagation(),u(!1)},i.oncomplete=function(){var y=navigator.userAgent.match(/Chrome\/(\d+)/),p=navigator.userAgent.match(/Edge\//);u(p||!y||parseInt(y[1],10)>=43)}}).catch(function(){return!1})}function G(o){return typeof E=="boolean"?f.resolve(E):$(o).then(function(u){return E=u,E})}function ce(o){var u=w[o.name],i={};i.promise=new f(function(v,y){i.resolve=v,i.reject=y}),u.deferredOperations.push(i),u.dbReady?u.dbReady=u.dbReady.then(function(){return i.promise}):u.dbReady=i.promise}function oe(o){var u=w[o.name],i=u.deferredOperations.pop();if(i)return i.resolve(),i.promise}function pe(o,u){var i=w[o.name],v=i.deferredOperations.pop();if(v)return v.reject(u),v.promise}function ye(o,u){return new f(function(i,v){if(w[o.name]=w[o.name]||J(),o.db)if(u)ce(o),o.db.close();else return i(o.db);var y=[o.name];u&&y.push(o.version);var p=m.open.apply(m,y);u&&(p.onupgradeneeded=function(C){var L=p.result;try{L.createObjectStore(o.storeName),C.oldVersion<=1&&L.createObjectStore(b)}catch(O){if(O.name==="ConstraintError")console.warn('The database "'+o.name+'" has been upgraded from version '+C.oldVersion+" to version "+C.newVersion+', but the storage "'+o.storeName+'" already exists.');else throw O}}),p.onerror=function(C){C.preventDefault(),v(p.error)},p.onsuccess=function(){var C=p.result;C.onversionchange=function(L){L.target.close()},i(C),oe(o)}})}function me(o){return ye(o,!1)}function N(o){return ye(o,!0)}function x(o,u){if(!o.db)return!0;var i=!o.db.objectStoreNames.contains(o.storeName),v=o.version<o.db.version,y=o.version>o.db.version;if(v&&(o.version!==u&&console.warn('The database "'+o.name+`" can't be downgraded from version `+o.db.version+" to version "+o.version+"."),o.version=o.db.version),y||i){if(i){var p=o.db.version+1;p>o.version&&(o.version=p)}return!0}return!1}function F(o){return new f(function(u,i){var v=new FileReader;v.onerror=i,v.onloadend=function(y){var p=btoa(y.target.result||"");u({__local_forage_encoded_blob:!0,data:p,type:o.type})},v.readAsBinaryString(o)})}function Y(o){var u=U(atob(o.data));return g([u],{type:o.type})}function z(o){return o&&o.__local_forage_encoded_blob}function Q(o){var u=this,i=u._initReady().then(function(){var v=w[u._dbInfo.name];if(v&&v.dbReady)return v.dbReady});return k(i,o,o),i}function j(o){ce(o);for(var u=w[o.name],i=u.forages,v=0;v<i.length;v++){var y=i[v];y._dbInfo.db&&(y._dbInfo.db.close(),y._dbInfo.db=null)}return o.db=null,me(o).then(function(p){return o.db=p,x(o)?N(o):p}).then(function(p){o.db=u.db=p;for(var C=0;C<i.length;C++)i[C]._dbInfo.db=p}).catch(function(p){throw pe(o,p),p})}function Z(o,u,i,v){v===void 0&&(v=1);try{var y=o.db.transaction(o.storeName,u);i(null,y)}catch(p){if(v>0&&(!o.db||p.name==="InvalidStateError"||p.name==="NotFoundError"))return f.resolve().then(function(){if(!o.db||p.name==="NotFoundError"&&!o.db.objectStoreNames.contains(o.storeName)&&o.version<=o.db.version)return o.db&&(o.version=o.db.version+1),N(o)}).then(function(){return j(o).then(function(){Z(o,u,i,v-1)})}).catch(i);i(p)}}function J(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function le(o){var u=this,i={db:null};if(o)for(var v in o)i[v]=o[v];var y=w[i.name];y||(y=J(),w[i.name]=y),y.forages.push(u),u._initReady||(u._initReady=u.ready,u.ready=Q);var p=[];function C(){return f.resolve()}for(var L=0;L<y.forages.length;L++){var O=y.forages[L];O!==u&&p.push(O._initReady().catch(C))}var P=y.forages.slice(0);return f.all(p).then(function(){return i.db=y.db,me(i)}).then(function(R){return i.db=R,x(i,u._defaultConfig.version)?N(i):R}).then(function(R){i.db=y.db=R,u._dbInfo=i;for(var H=0;H<P.length;H++){var ne=P[H];ne!==u&&(ne._dbInfo.db=i.db,ne._dbInfo.version=i.version)}})}function we(o,u){var i=this;o=D(o);var v=new f(function(y,p){i.ready().then(function(){Z(i._dbInfo,M,function(C,L){if(C)return p(C);try{var O=L.objectStore(i._dbInfo.storeName),P=O.get(o);P.onsuccess=function(){var R=P.result;R===void 0&&(R=null),z(R)&&(R=Y(R)),y(R)},P.onerror=function(){p(P.error)}}catch(R){p(R)}})}).catch(p)});return d(v,u),v}function Ne(o,u){var i=this,v=new f(function(y,p){i.ready().then(function(){Z(i._dbInfo,M,function(C,L){if(C)return p(C);try{var O=L.objectStore(i._dbInfo.storeName),P=O.openCursor(),R=1;P.onsuccess=function(){var H=P.result;if(H){var ne=H.value;z(ne)&&(ne=Y(ne));var se=o(ne,H.key,R++);se!==void 0?y(se):H.continue()}else y()},P.onerror=function(){p(P.error)}}catch(H){p(H)}})}).catch(p)});return d(v,u),v}function I(o,u,i){var v=this;o=D(o);var y=new f(function(p,C){var L;v.ready().then(function(){return L=v._dbInfo,A.call(u)==="[object Blob]"?G(L.db).then(function(O){return O?u:F(u)}):u}).then(function(O){Z(v._dbInfo,S,function(P,R){if(P)return C(P);try{var H=R.objectStore(v._dbInfo.storeName);O===null&&(O=void 0);var ne=H.put(O,o);R.oncomplete=function(){O===void 0&&(O=null),p(O)},R.onabort=R.onerror=function(){var se=ne.error?ne.error:ne.transaction.error;C(se)}}catch(se){C(se)}})}).catch(C)});return d(y,i),y}function V(o,u){var i=this;o=D(o);var v=new f(function(y,p){i.ready().then(function(){Z(i._dbInfo,S,function(C,L){if(C)return p(C);try{var O=L.objectStore(i._dbInfo.storeName),P=O.delete(o);L.oncomplete=function(){y()},L.onerror=function(){p(P.error)},L.onabort=function(){var R=P.error?P.error:P.transaction.error;p(R)}}catch(R){p(R)}})}).catch(p)});return d(v,u),v}function q(o){var u=this,i=new f(function(v,y){u.ready().then(function(){Z(u._dbInfo,S,function(p,C){if(p)return y(p);try{var L=C.objectStore(u._dbInfo.storeName),O=L.clear();C.oncomplete=function(){v()},C.onabort=C.onerror=function(){var P=O.error?O.error:O.transaction.error;y(P)}}catch(P){y(P)}})}).catch(y)});return d(i,o),i}function W(o){var u=this,i=new f(function(v,y){u.ready().then(function(){Z(u._dbInfo,M,function(p,C){if(p)return y(p);try{var L=C.objectStore(u._dbInfo.storeName),O=L.count();O.onsuccess=function(){v(O.result)},O.onerror=function(){y(O.error)}}catch(P){y(P)}})}).catch(y)});return d(i,o),i}function ee(o,u){var i=this,v=new f(function(y,p){if(o<0){y(null);return}i.ready().then(function(){Z(i._dbInfo,M,function(C,L){if(C)return p(C);try{var O=L.objectStore(i._dbInfo.storeName),P=!1,R=O.openKeyCursor();R.onsuccess=function(){var H=R.result;if(!H){y(null);return}o===0||P?y(H.key):(P=!0,H.advance(o))},R.onerror=function(){p(R.error)}}catch(H){p(H)}})}).catch(p)});return d(v,u),v}function X(o){var u=this,i=new f(function(v,y){u.ready().then(function(){Z(u._dbInfo,M,function(p,C){if(p)return y(p);try{var L=C.objectStore(u._dbInfo.storeName),O=L.openKeyCursor(),P=[];O.onsuccess=function(){var R=O.result;if(!R){v(P);return}P.push(R.key),R.continue()},O.onerror=function(){y(O.error)}}catch(R){y(R)}})}).catch(y)});return d(i,o),i}function ue(o,u){u=_.apply(this,arguments);var i=this.config();o=typeof o!="function"&&o||{},o.name||(o.name=o.name||i.name,o.storeName=o.storeName||i.storeName);var v=this,y;if(!o.name)y=f.reject("Invalid arguments");else{var p=o.name===i.name&&v._dbInfo.db,C=p?f.resolve(v._dbInfo.db):me(o).then(function(L){var O=w[o.name],P=O.forages;O.db=L;for(var R=0;R<P.length;R++)P[R]._dbInfo.db=L;return L});o.storeName?y=C.then(function(L){if(L.objectStoreNames.contains(o.storeName)){var O=L.version+1;ce(o);var P=w[o.name],R=P.forages;L.close();for(var H=0;H<R.length;H++){var ne=R[H];ne._dbInfo.db=null,ne._dbInfo.version=O}var se=new f(function(ie,be){var ve=m.open(o.name,O);ve.onerror=function(Ie){var nt=ve.result;nt.close(),be(Ie)},ve.onupgradeneeded=function(){var Ie=ve.result;Ie.deleteObjectStore(o.storeName)},ve.onsuccess=function(){var Ie=ve.result;Ie.close(),ie(Ie)}});return se.then(function(ie){P.db=ie;for(var be=0;be<R.length;be++){var ve=R[be];ve._dbInfo.db=ie,oe(ve._dbInfo)}}).catch(function(ie){throw(pe(o,ie)||f.resolve()).catch(function(){}),ie})}}):y=C.then(function(L){ce(o);var O=w[o.name],P=O.forages;L.close();for(var R=0;R<P.length;R++){var H=P[R];H._dbInfo.db=null}var ne=new f(function(se,ie){var be=m.deleteDatabase(o.name);be.onerror=function(){var ve=be.result;ve&&ve.close(),ie(be.error)},be.onblocked=function(){console.warn('dropInstance blocked for database "'+o.name+'" until all open connections are closed')},be.onsuccess=function(){var ve=be.result;ve&&ve.close(),se(ve)}});return ne.then(function(se){O.db=se;for(var ie=0;ie<P.length;ie++){var be=P[ie];oe(be._dbInfo)}}).catch(function(se){throw(pe(o,se)||f.resolve()).catch(function(){}),se})})}return d(y,u),y}var Ye={_driver:"asyncStorage",_initStorage:le,_support:l(),iterate:Ne,getItem:we,setItem:I,removeItem:V,clear:q,length:W,key:ee,keys:X,dropInstance:ue};function xr(){return typeof openDatabase=="function"}var Be="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Nr="~~local_forage_type~",wn=/^~~local_forage_type~([^~]+)~/,mt="__lfsc__:",Ut=mt.length,Ft="arbf",$t="blob",kn="si08",Tn="ui08",xn="uic8",Nn="si16",In="si32",Cn="ur16",An="ui32",Dn="fl32",Ln="fl64",_n=Ut+Ft.length,Mn=Object.prototype.toString;function On(o){var u=o.length*.75,i=o.length,v,y=0,p,C,L,O;o[o.length-1]==="="&&(u--,o[o.length-2]==="="&&u--);var P=new ArrayBuffer(u),R=new Uint8Array(P);for(v=0;v<i;v+=4)p=Be.indexOf(o[v]),C=Be.indexOf(o[v+1]),L=Be.indexOf(o[v+2]),O=Be.indexOf(o[v+3]),R[y++]=p<<2|C>>4,R[y++]=(C&15)<<4|L>>2,R[y++]=(L&3)<<6|O&63;return P}function Vt(o){var u=new Uint8Array(o),i="",v;for(v=0;v<u.length;v+=3)i+=Be[u[v]>>2],i+=Be[(u[v]&3)<<4|u[v+1]>>4],i+=Be[(u[v+1]&15)<<2|u[v+2]>>6],i+=Be[u[v+2]&63];return u.length%3===2?i=i.substring(0,i.length-1)+"=":u.length%3===1&&(i=i.substring(0,i.length-2)+"=="),i}function Ir(o,u){var i="";if(o&&(i=Mn.call(o)),o&&(i==="[object ArrayBuffer]"||o.buffer&&Mn.call(o.buffer)==="[object ArrayBuffer]")){var v,y=mt;o instanceof ArrayBuffer?(v=o,y+=Ft):(v=o.buffer,i==="[object Int8Array]"?y+=kn:i==="[object Uint8Array]"?y+=Tn:i==="[object Uint8ClampedArray]"?y+=xn:i==="[object Int16Array]"?y+=Nn:i==="[object Uint16Array]"?y+=Cn:i==="[object Int32Array]"?y+=In:i==="[object Uint32Array]"?y+=An:i==="[object Float32Array]"?y+=Dn:i==="[object Float64Array]"?y+=Ln:u(new Error("Failed to get type for BinaryArray"))),u(y+Vt(v))}else if(i==="[object Blob]"){var p=new FileReader;p.onload=function(){var C=Nr+o.type+"~"+Vt(this.result);u(mt+$t+C)},p.readAsArrayBuffer(o)}else try{u(JSON.stringify(o))}catch(C){console.error("Couldn't convert value into a JSON string: ",o),u(null,C)}}function Cr(o){if(o.substring(0,Ut)!==mt)return JSON.parse(o);var u=o.substring(_n),i=o.substring(Ut,_n),v;if(i===$t&&wn.test(u)){var y=u.match(wn);v=y[1],u=u.substring(y[0].length)}var p=On(u);switch(i){case Ft:return p;case $t:return g([p],{type:v});case kn:return new Int8Array(p);case Tn:return new Uint8Array(p);case xn:return new Uint8ClampedArray(p);case Nn:return new Int16Array(p);case Cn:return new Uint16Array(p);case In:return new Int32Array(p);case An:return new Uint32Array(p);case Dn:return new Float32Array(p);case Ln:return new Float64Array(p);default:throw new Error("Unkown type: "+i)}}var Wt={serialize:Ir,deserialize:Cr,stringToBuffer:On,bufferToString:Vt};function Pn(o,u,i,v){o.executeSql("CREATE TABLE IF NOT EXISTS "+u.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],i,v)}function Ar(o){var u=this,i={db:null};if(o)for(var v in o)i[v]=typeof o[v]!="string"?o[v].toString():o[v];var y=new f(function(p,C){try{i.db=openDatabase(i.name,String(i.version),i.description,i.size)}catch(L){return C(L)}i.db.transaction(function(L){Pn(L,i,function(){u._dbInfo=i,p()},function(O,P){C(P)})},C)});return i.serializer=Wt,y}function Re(o,u,i,v,y,p){o.executeSql(i,v,y,function(C,L){L.code===L.SYNTAX_ERR?C.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[u.storeName],function(O,P){P.rows.length?p(O,L):Pn(O,u,function(){O.executeSql(i,v,y,p)},p)},p):p(C,L)},p)}function Dr(o,u){var i=this;o=D(o);var v=new f(function(y,p){i.ready().then(function(){var C=i._dbInfo;C.db.transaction(function(L){Re(L,C,"SELECT * FROM "+C.storeName+" WHERE key = ? LIMIT 1",[o],function(O,P){var R=P.rows.length?P.rows.item(0).value:null;R&&(R=C.serializer.deserialize(R)),y(R)},function(O,P){p(P)})})}).catch(p)});return d(v,u),v}function Lr(o,u){var i=this,v=new f(function(y,p){i.ready().then(function(){var C=i._dbInfo;C.db.transaction(function(L){Re(L,C,"SELECT * FROM "+C.storeName,[],function(O,P){for(var R=P.rows,H=R.length,ne=0;ne<H;ne++){var se=R.item(ne),ie=se.value;if(ie&&(ie=C.serializer.deserialize(ie)),ie=o(ie,se.key,ne+1),ie!==void 0){y(ie);return}}y()},function(O,P){p(P)})})}).catch(p)});return d(v,u),v}function jn(o,u,i,v){var y=this;o=D(o);var p=new f(function(C,L){y.ready().then(function(){u===void 0&&(u=null);var O=u,P=y._dbInfo;P.serializer.serialize(u,function(R,H){H?L(H):P.db.transaction(function(ne){Re(ne,P,"INSERT OR REPLACE INTO "+P.storeName+" (key, value) VALUES (?, ?)",[o,R],function(){C(O)},function(se,ie){L(ie)})},function(ne){if(ne.code===ne.QUOTA_ERR){if(v>0){C(jn.apply(y,[o,O,i,v-1]));return}L(ne)}})})}).catch(L)});return d(p,i),p}function _r(o,u,i){return jn.apply(this,[o,u,i,1])}function Mr(o,u){var i=this;o=D(o);var v=new f(function(y,p){i.ready().then(function(){var C=i._dbInfo;C.db.transaction(function(L){Re(L,C,"DELETE FROM "+C.storeName+" WHERE key = ?",[o],function(){y()},function(O,P){p(P)})})}).catch(p)});return d(v,u),v}function Or(o){var u=this,i=new f(function(v,y){u.ready().then(function(){var p=u._dbInfo;p.db.transaction(function(C){Re(C,p,"DELETE FROM "+p.storeName,[],function(){v()},function(L,O){y(O)})})}).catch(y)});return d(i,o),i}function Pr(o){var u=this,i=new f(function(v,y){u.ready().then(function(){var p=u._dbInfo;p.db.transaction(function(C){Re(C,p,"SELECT COUNT(key) as c FROM "+p.storeName,[],function(L,O){var P=O.rows.item(0).c;v(P)},function(L,O){y(O)})})}).catch(y)});return d(i,o),i}function jr(o,u){var i=this,v=new f(function(y,p){i.ready().then(function(){var C=i._dbInfo;C.db.transaction(function(L){Re(L,C,"SELECT key FROM "+C.storeName+" WHERE id = ? LIMIT 1",[o+1],function(O,P){var R=P.rows.length?P.rows.item(0).key:null;y(R)},function(O,P){p(P)})})}).catch(p)});return d(v,u),v}function Br(o){var u=this,i=new f(function(v,y){u.ready().then(function(){var p=u._dbInfo;p.db.transaction(function(C){Re(C,p,"SELECT key FROM "+p.storeName,[],function(L,O){for(var P=[],R=0;R<O.rows.length;R++)P.push(O.rows.item(R).key);v(P)},function(L,O){y(O)})})}).catch(y)});return d(i,o),i}function Rr(o){return new f(function(u,i){o.transaction(function(v){v.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(y,p){for(var C=[],L=0;L<p.rows.length;L++)C.push(p.rows.item(L).name);u({db:o,storeNames:C})},function(y,p){i(p)})},function(v){i(v)})})}function Ur(o,u){u=_.apply(this,arguments);var i=this.config();o=typeof o!="function"&&o||{},o.name||(o.name=o.name||i.name,o.storeName=o.storeName||i.storeName);var v=this,y;return o.name?y=new f(function(p){var C;o.name===i.name?C=v._dbInfo.db:C=openDatabase(o.name,"","",0),o.storeName?p({db:C,storeNames:[o.storeName]}):p(Rr(C))}).then(function(p){return new f(function(C,L){p.db.transaction(function(O){function P(se){return new f(function(ie,be){O.executeSql("DROP TABLE IF EXISTS "+se,[],function(){ie()},function(ve,Ie){be(Ie)})})}for(var R=[],H=0,ne=p.storeNames.length;H<ne;H++)R.push(P(p.storeNames[H]));f.all(R).then(function(){C()}).catch(function(se){L(se)})},function(O){L(O)})})}):y=f.reject("Invalid arguments"),d(y,u),y}var Fr={_driver:"webSQLStorage",_initStorage:Ar,_support:xr(),iterate:Lr,getItem:Dr,setItem:_r,removeItem:Mr,clear:Or,length:Pr,key:jr,keys:Br,dropInstance:Ur};function $r(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function Bn(o,u){var i=o.name+"/";return o.storeName!==u.storeName&&(i+=o.storeName+"/"),i}function Vr(){var o="_localforage_support_test";try{return localStorage.setItem(o,!0),localStorage.removeItem(o),!1}catch{return!0}}function Wr(){return!Vr()||localStorage.length>0}function zr(o){var u=this,i={};if(o)for(var v in o)i[v]=o[v];return i.keyPrefix=Bn(o,u._defaultConfig),Wr()?(u._dbInfo=i,i.serializer=Wt,f.resolve()):f.reject()}function Hr(o){var u=this,i=u.ready().then(function(){for(var v=u._dbInfo.keyPrefix,y=localStorage.length-1;y>=0;y--){var p=localStorage.key(y);p.indexOf(v)===0&&localStorage.removeItem(p)}});return d(i,o),i}function qr(o,u){var i=this;o=D(o);var v=i.ready().then(function(){var y=i._dbInfo,p=localStorage.getItem(y.keyPrefix+o);return p&&(p=y.serializer.deserialize(p)),p});return d(v,u),v}function Yr(o,u){var i=this,v=i.ready().then(function(){for(var y=i._dbInfo,p=y.keyPrefix,C=p.length,L=localStorage.length,O=1,P=0;P<L;P++){var R=localStorage.key(P);if(R.indexOf(p)===0){var H=localStorage.getItem(R);if(H&&(H=y.serializer.deserialize(H)),H=o(H,R.substring(C),O++),H!==void 0)return H}}});return d(v,u),v}function Gr(o,u){var i=this,v=i.ready().then(function(){var y=i._dbInfo,p;try{p=localStorage.key(o)}catch{p=null}return p&&(p=p.substring(y.keyPrefix.length)),p});return d(v,u),v}function Kr(o){var u=this,i=u.ready().then(function(){for(var v=u._dbInfo,y=localStorage.length,p=[],C=0;C<y;C++){var L=localStorage.key(C);L.indexOf(v.keyPrefix)===0&&p.push(L.substring(v.keyPrefix.length))}return p});return d(i,o),i}function Jr(o){var u=this,i=u.keys().then(function(v){return v.length});return d(i,o),i}function Xr(o,u){var i=this;o=D(o);var v=i.ready().then(function(){var y=i._dbInfo;localStorage.removeItem(y.keyPrefix+o)});return d(v,u),v}function Qr(o,u,i){var v=this;o=D(o);var y=v.ready().then(function(){u===void 0&&(u=null);var p=u;return new f(function(C,L){var O=v._dbInfo;O.serializer.serialize(u,function(P,R){if(R)L(R);else try{localStorage.setItem(O.keyPrefix+o,P),C(p)}catch(H){(H.name==="QuotaExceededError"||H.name==="NS_ERROR_DOM_QUOTA_REACHED")&&L(H),L(H)}})})});return d(y,i),y}function Zr(o,u){if(u=_.apply(this,arguments),o=typeof o!="function"&&o||{},!o.name){var i=this.config();o.name=o.name||i.name,o.storeName=o.storeName||i.storeName}var v=this,y;return o.name?y=new f(function(p){o.storeName?p(Bn(o,v._defaultConfig)):p(o.name+"/")}).then(function(p){for(var C=localStorage.length-1;C>=0;C--){var L=localStorage.key(C);L.indexOf(p)===0&&localStorage.removeItem(L)}}):y=f.reject("Invalid arguments"),d(y,u),y}var ea={_driver:"localStorageWrapper",_initStorage:zr,_support:$r(),iterate:Yr,getItem:qr,setItem:Qr,removeItem:Xr,clear:Hr,length:Jr,key:Gr,keys:Kr,dropInstance:Zr},ta=function(u,i){return u===i||typeof u=="number"&&typeof i=="number"&&isNaN(u)&&isNaN(i)},na=function(u,i){for(var v=u.length,y=0;y<v;){if(ta(u[y],i))return!0;y++}return!1},Rn=Array.isArray||function(o){return Object.prototype.toString.call(o)==="[object Array]"},tt={},Un={},Ge={INDEXEDDB:Ye,WEBSQL:Fr,LOCALSTORAGE:ea},ra=[Ge.INDEXEDDB._driver,Ge.WEBSQL._driver,Ge.LOCALSTORAGE._driver],ht=["dropInstance"],zt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(ht),aa={description:"",driver:ra.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function oa(o,u){o[u]=function(){var i=arguments;return o.ready().then(function(){return o[u].apply(o,i)})}}function Ht(){for(var o=1;o<arguments.length;o++){var u=arguments[o];if(u)for(var i in u)u.hasOwnProperty(i)&&(Rn(u[i])?arguments[0][i]=u[i].slice():arguments[0][i]=u[i])}return arguments[0]}var sa=function(){function o(u){c(this,o);for(var i in Ge)if(Ge.hasOwnProperty(i)){var v=Ge[i],y=v._driver;this[i]=y,tt[y]||this.defineDriver(v)}this._defaultConfig=Ht({},aa),this._config=Ht({},this._defaultConfig,u),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return o.prototype.config=function(i){if((typeof i>"u"?"undefined":n(i))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var v in i){if(v==="storeName"&&(i[v]=i[v].replace(/\W/g,"_")),v==="version"&&typeof i[v]!="number")return new Error("Database version must be a number.");this._config[v]=i[v]}return"driver"in i&&i.driver?this.setDriver(this._config.driver):!0}else return typeof i=="string"?this._config[i]:this._config},o.prototype.defineDriver=function(i,v,y){var p=new f(function(C,L){try{var O=i._driver,P=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!i._driver){L(P);return}for(var R=zt.concat("_initStorage"),H=0,ne=R.length;H<ne;H++){var se=R[H],ie=!na(ht,se);if((ie||i[se])&&typeof i[se]!="function"){L(P);return}}var be=function(){for(var nt=function(la){return function(){var ua=new Error("Method "+la+" is not implemented by the current driver"),Fn=f.reject(ua);return d(Fn,arguments[arguments.length-1]),Fn}},qt=0,ca=ht.length;qt<ca;qt++){var Yt=ht[qt];i[Yt]||(i[Yt]=nt(Yt))}};be();var ve=function(nt){tt[O]&&console.info("Redefining LocalForage driver: "+O),tt[O]=i,Un[O]=nt,C()};"_support"in i?i._support&&typeof i._support=="function"?i._support().then(ve,L):ve(!!i._support):ve(!0)}catch(Ie){L(Ie)}});return k(p,v,y),p},o.prototype.driver=function(){return this._driver||null},o.prototype.getDriver=function(i,v,y){var p=tt[i]?f.resolve(tt[i]):f.reject(new Error("Driver not found."));return k(p,v,y),p},o.prototype.getSerializer=function(i){var v=f.resolve(Wt);return k(v,i),v},o.prototype.ready=function(i){var v=this,y=v._driverSet.then(function(){return v._ready===null&&(v._ready=v._initDriver()),v._ready});return k(y,i,i),y},o.prototype.setDriver=function(i,v,y){var p=this;Rn(i)||(i=[i]);var C=this._getSupportedDrivers(i);function L(){p._config.driver=p.driver()}function O(H){return p._extend(H),L(),p._ready=p._initStorage(p._config),p._ready}function P(H){return function(){var ne=0;function se(){for(;ne<H.length;){var ie=H[ne];return ne++,p._dbInfo=null,p._ready=null,p.getDriver(ie).then(O).catch(se)}L();var be=new Error("No available storage method found.");return p._driverSet=f.reject(be),p._driverSet}return se()}}var R=this._driverSet!==null?this._driverSet.catch(function(){return f.resolve()}):f.resolve();return this._driverSet=R.then(function(){var H=C[0];return p._dbInfo=null,p._ready=null,p.getDriver(H).then(function(ne){p._driver=ne._driver,L(),p._wrapLibraryMethodsWithReady(),p._initDriver=P(C)})}).catch(function(){L();var H=new Error("No available storage method found.");return p._driverSet=f.reject(H),p._driverSet}),k(this._driverSet,v,y),this._driverSet},o.prototype.supports=function(i){return!!Un[i]},o.prototype._extend=function(i){Ht(this,i)},o.prototype._getSupportedDrivers=function(i){for(var v=[],y=0,p=i.length;y<p;y++){var C=i[y];this.supports(C)&&v.push(C)}return v},o.prototype._wrapLibraryMethodsWithReady=function(){for(var i=0,v=zt.length;i<v;i++)oa(this,zt[i])},o.prototype.createInstance=function(i){return new o(i)},o}(),ia=new sa;a.exports=ia},{3:3}]},{},[4])(4)})})(er);var ma=er.exports;const nn=fa(ma);function vt(t){if(typeof t!="string"||!t)throw new Error("expected a non-empty string, got: "+t)}function Gt(t){if(typeof t!="number")throw new Error("expected a number, got: "+t)}const ha=1,pa=1,qe="emoji",Ze="keyvalue",pn="favorites",va="tokens",tr="tokens",ga="unicode",nr="count",ya="group",ba="order",rr="group-order",rn="eTag",Tt="url",Vn="skinTone",et="readonly",vn="readwrite",ar="skinUnicodes",Ea="skinUnicodes",Sa="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",wa="en";function ka(t,e){const r=new Set,a=[];for(const s of t){const n=e(s);r.has(n)||(r.add(n),a.push(s))}return a}function Wn(t){return ka(t,e=>e.unicode)}function Ta(t){function e(r,a,s){const n=a?t.createObjectStore(r,{keyPath:a}):t.createObjectStore(r);if(s)for(const[c,[h,m]]of Object.entries(s))n.createIndex(c,h,{multiEntry:m});return n}e(Ze),e(qe,ga,{[tr]:[va,!0],[rr]:[[ya,ba]],[ar]:[Ea,!0]}),e(pn,void 0,{[nr]:[""]})}const an={},Et={},xt={};function or(t,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>t(r.result)}async function xa(t){const e=await new Promise((r,a)=>{const s=indexedDB.open(t,ha);an[t]=s,s.onupgradeneeded=n=>{n.oldVersion<pa&&Ta(s.result)},or(r,a,s)});return e.onclose=()=>gn(t),e}function Na(t){return Et[t]||(Et[t]=xa(t)),Et[t]}function je(t,e,r,a){return new Promise((s,n)=>{const c=t.transaction(e,r,{durability:"relaxed"}),h=typeof e=="string"?c.objectStore(e):e.map(l=>c.objectStore(l));let m;a(h,c,l=>{m=l}),c.oncomplete=()=>s(m),c.onerror=()=>n(c.error)})}function gn(t){const e=an[t],r=e&&e.result;if(r){r.close();const a=xt[t];if(a)for(const s of a)s()}delete an[t],delete Et[t],delete xt[t]}function Ia(t){return new Promise((e,r)=>{gn(t);const a=indexedDB.deleteDatabase(t);or(e,r,a)})}function Ca(t,e){let r=xt[t];r||(r=xt[t]=[]),r.push(e)}const Aa=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function Ke(t){return t.split(/[\s_]+/).map(e=>!e.match(/\w/)||Aa.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const Da=2;function sr(t){return t.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Da)}function La(t){return t.map(({annotation:r,emoticon:a,group:s,order:n,shortcodes:c,skins:h,tags:m,emoji:l,version:g})=>{const f=[...new Set(sr([...(c||[]).map(Ke).flat(),...m.map(Ke).flat(),...Ke(r),a]))].sort(),d={annotation:r,group:s,order:n,tags:m,tokens:f,unicode:l,version:g};if(a&&(d.emoticon=a),c&&(d.shortcodes=c),h){d.skinTones=[],d.skinUnicodes=[],d.skinVersions=[];for(const{tone:k,emoji:D,version:_}of h)d.skinTones.push(k),d.skinUnicodes.push(D),d.skinVersions.push(_)}return d})}function ir(t,e,r,a){t[e](r).onsuccess=s=>a&&a(s.target.result)}function He(t,e,r){ir(t,"get",e,r)}function cr(t,e,r){ir(t,"getAll",e,r)}function yn(t){t.commit&&t.commit()}function _a(t,e){let r=t[0];for(let a=1;a<t.length;a++){const s=t[a];e(r)>e(s)&&(r=s)}return r}function lr(t,e){const r=_a(t,s=>s.length),a=[];for(const s of r)t.some(n=>n.findIndex(c=>e(c)===e(s))===-1)||a.push(s);return a}async function Ma(t){return!await bn(t,Ze,Tt)}async function Oa(t,e,r){const[a,s]=await Promise.all([rn,Tt].map(n=>bn(t,Ze,n)));return a===r&&s===e}async function Pa(t,e){return je(t,qe,et,(a,s,n)=>{let c;const h=()=>{a.getAll(c&&IDBKeyRange.lowerBound(c,!0),50).onsuccess=m=>{const l=m.target.result;for(const g of l)if(c=g.unicode,e(g))return n(g);if(l.length<50)return n();h()}};h()})}async function ur(t,e,r,a){try{const s=La(e);await je(t,[qe,Ze],vn,([n,c],h)=>{let m,l,g=0;function f(){++g===2&&d()}function d(){if(!(m===a&&l===r)){n.clear();for(const k of s)n.put(k);c.put(a,rn),c.put(r,Tt),yn(h)}}He(c,rn,k=>{m=k,f()}),He(c,Tt,k=>{l=k,f()})})}finally{}}async function ja(t,e){return je(t,qe,et,(r,a,s)=>{const n=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);cr(r.index(rr),n,s)})}async function dr(t,e){const r=sr(Ke(e));return r.length?je(t,qe,et,(a,s,n)=>{const c=[],h=()=>{c.length===r.length&&m()},m=()=>{const l=lr(c,g=>g.unicode);n(l.sort((g,f)=>g.order<f.order?-1:1))};for(let l=0;l<r.length;l++){const g=r[l],f=l===r.length-1?IDBKeyRange.bound(g,g+"￿",!1,!0):IDBKeyRange.only(g);cr(a.index(tr),f,d=>{c.push(d),h()})}}):[]}async function Ba(t,e){const r=await dr(t,e);return r.length?r.filter(a=>(a.shortcodes||[]).map(n=>n.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Pa(t,s=>(s.shortcodes||[]).includes(e.toLowerCase()))||null}async function Ra(t,e){return je(t,qe,et,(r,a,s)=>He(r,e,n=>{if(n)return s(n);He(r.index(ar),e,c=>s(c||null))}))}function bn(t,e,r){return je(t,e,et,(a,s,n)=>He(a,r,n))}function Ua(t,e,r,a){return je(t,e,vn,(s,n)=>{s.put(a,r),yn(n)})}function Fa(t,e){return je(t,pn,vn,(r,a)=>He(r,e,s=>{r.put((s||0)+1,e),yn(a)}))}function $a(t,e,r){return r===0?[]:je(t,[pn,qe],et,([a,s],n,c)=>{const h=[];a.index(nr).openCursor(void 0,"prev").onsuccess=m=>{const l=m.target.result;if(!l)return c(h);function g(k){if(h.push(k),h.length===r)return c(h);l.continue()}const f=l.primaryKey,d=e.byName(f);if(d)return g(d);He(s,f,k=>{if(k)return g(k);l.continue()})}})}const gt="";function Va(t,e){const r=new Map;for(const s of t){const n=e(s);for(const c of n){let h=r;for(let l=0;l<c.length;l++){const g=c.charAt(l);let f=h.get(g);f||(f=new Map,h.set(g,f)),h=f}let m=h.get(gt);m||(m=[],h.set(gt,m)),m.push(s)}}return(s,n)=>{let c=r;for(let l=0;l<s.length;l++){const g=s.charAt(l),f=c.get(g);if(f)c=f;else return[]}if(n)return c.get(gt)||[];const h=[],m=[c];for(;m.length;){const g=[...m.shift().entries()].sort((f,d)=>f[0]<d[0]?-1:1);for(const[f,d]of g)f===gt?h.push(...d):m.push(d)}return h}}const Wa=["name","url"];function za(t){const e=t&&Array.isArray(t),r=e&&t.length&&(!t[0]||Wa.some(a=>!(a in t[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function zn(t){za(t);const e=(d,k)=>d.name.toLowerCase()<k.name.toLowerCase()?-1:1,r=t.sort(e),s=Va(t,d=>[...new Set((d.shortcodes||[]).map(k=>Ke(k)).flat())]),n=d=>s(d,!0),c=d=>s(d,!1),h=d=>{const k=Ke(d),D=k.map((_,b)=>(b<k.length-1?n:c)(_));return lr(D,_=>_.name).sort(e)},m=new Map,l=new Map;for(const d of t){l.set(d.name.toLowerCase(),d);for(const k of d.shortcodes||[])m.set(k.toLowerCase(),d)}return{all:r,search:h,byShortcode:d=>m.get(d.toLowerCase()),byName:d=>l.get(d.toLowerCase())}}const Ha=typeof wrappedJSObject<"u";function rt(t){if(!t)return t;if(Ha&&(t=structuredClone(t)),delete t.tokens,t.skinTones){const e=t.skinTones.length;t.skins=Array(e);for(let r=0;r<e;r++)t.skins[r]={tone:t.skinTones[r],unicode:t.skinUnicodes[r],version:t.skinVersions[r]};delete t.skinTones,delete t.skinUnicodes,delete t.skinVersions}return t}function fr(t){t||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const qa=["annotation","emoji","group","order","tags","version"];function Ya(t){if(!t||!Array.isArray(t)||!t[0]||typeof t[0]!="object"||qa.some(e=>!(e in t[0])))throw new Error("Emoji data is in the wrong format")}function mr(t,e){if(Math.floor(t.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+t.status)}async function Ga(t){const e=await fetch(t,{method:"HEAD"});mr(e,t);const r=e.headers.get("etag");return fr(r),r}async function on(t){const e=await fetch(t);mr(e,t);const r=e.headers.get("etag");fr(r);const a=await e.json();return Ya(a),[r,a]}function Ka(t){for(var e="",r=new Uint8Array(t),a=r.byteLength,s=-1;++s<a;)e+=String.fromCharCode(r[s]);return e}function Ja(t){for(var e=t.length,r=new ArrayBuffer(e),a=new Uint8Array(r),s=-1;++s<e;)a[s]=t.charCodeAt(s);return r}async function hr(t){const e=JSON.stringify(t);let r=Ja(e);const a=await crypto.subtle.digest("SHA-1",r),s=Ka(a);return btoa(s)}async function Xa(t,e){let r,a=await Ga(e);if(!a){const s=await on(e);a=s[0],r=s[1],a||(a=await hr(r))}await Oa(t,e,a)||(r||(r=(await on(e))[1]),await ur(t,r,e,a))}async function Qa(t,e){let[r,a]=await on(e);r||(r=await hr(a)),await ur(t,a,e,r)}class Za{constructor({dataSource:e=Sa,locale:r=wa,customEmoji:a=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=zn(a),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await Na(this._dbName);Ca(this._dbName,this._clear);const r=this.dataSource;await Ma(e)?await Qa(e,r):this._lazyUpdate=Xa(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return Gt(e),await this.ready(),Wn(await ja(this._db,e)).map(rt)}async getEmojiBySearchQuery(e){vt(e),await this.ready();const r=this._custom.search(e),a=Wn(await dr(this._db,e)).map(rt);return[...r,...a]}async getEmojiByShortcode(e){vt(e),await this.ready();const r=this._custom.byShortcode(e);return r||rt(await Ba(this._db,e))}async getEmojiByUnicodeOrName(e){vt(e),await this.ready();const r=this._custom.byName(e);return r||rt(await Ra(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await bn(this._db,Ze,Vn)||0}async setPreferredSkinTone(e){return Gt(e),await this.ready(),Ua(this._db,Ze,Vn,e)}async incrementFavoriteEmojiCount(e){return vt(e),await this.ready(),Fa(this._db,e)}async getTopFavoriteEmoji(e){return Gt(e),await this.ready(),(await $a(this._db,this._custom,e)).map(rt)}set customEmoji(e){this._custom=zn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await gn(this._dbName)}async delete(){await this._shutdown(),await Ia(this._dbName)}}const sn=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([t,e,r])=>({id:t,emoji:e,name:r})),Kt=sn.slice(1),eo=2,Hn=6,pr=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function qn(t){return t.unicode.includes("‍")}const to={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},no=1e3,ro="🖐️",ao=8,oo=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],vr='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',so=(t,e)=>t<e?-1:t>e?1:0,Yn=(t,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const a=r.getContext("2d");return a.textBaseline="top",a.font=`100px ${vr}`,a.fillStyle=e,a.scale(.01,.01),a.fillText(t,0,0),a.getImageData(0,0,1,1).data},io=(t,e)=>{const r=[...t].join(","),a=[...e].join(",");return r===a&&!r.startsWith("0,0,0,")};function co(t){const e=Yn(t,"#000"),r=Yn(t,"#fff");return e&&r&&io(e,r)}function lo(){const t=Object.entries(to);try{for(const[e,r]of t)if(co(e))return r}catch{}finally{}return t[0][1]}let Jt;const Xt=()=>(Jt||(Jt=new Promise(t=>pr(()=>t(lo())))),Jt),cn=new Map,uo="️",fo="\uD83C",mo="‍",ho=127995,po=57339;function vo(t,e){if(e===0)return t;const r=t.indexOf(mo);return r!==-1?t.substring(0,r)+String.fromCodePoint(ho+e-1)+t.substring(r):(t.endsWith(uo)&&(t=t.substring(0,t.length-1)),t+fo+String.fromCodePoint(po+e-1))}function _e(t){t.preventDefault(),t.stopPropagation()}function Qt(t,e,r){return e+=t?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function gr(t,e){const r=new Set,a=[];for(const s of t){const n=e(s);r.has(n)||(r.add(n),a.push(s))}return a}function go(t,e){const r=a=>{const s={};for(const n of a)typeof n.tone=="number"&&n.version<=e&&(s[n.tone]=n.unicode);return s};return t.map(({unicode:a,skins:s,shortcodes:n,url:c,name:h,category:m,annotation:l})=>({unicode:a,name:h,shortcodes:n,url:c,category:m,annotation:l,id:a||h,skins:s&&r(s)}))}const St=requestAnimationFrame;let yo=typeof ResizeObserver=="function";function bo(t,e,r){let a;yo?(a=new ResizeObserver(s=>r(s[0].contentRect.width)),a.observe(t)):St(()=>r(t.getBoundingClientRect().width)),e.addEventListener("abort",()=>{a&&a.disconnect()})}function Gn(t){{const e=document.createRange();return e.selectNode(t.firstChild),e.getBoundingClientRect().width}}let Zt;function Eo(t,e,r){for(const a of t){const s=r(a),n=Gn(s);typeof Zt>"u"&&(Zt=Gn(e));const c=n/1.8<Zt;cn.set(a.unicode,c)}}function So(t){return gr(t,e=>e)}function wo(t){t&&(t.scrollTop=0)}function it(t,e,r){let a=t.get(e);return a||(a=r(),t.set(e,a)),a}function Kn(t){return""+t}function ko(t){const e=document.createElement("template");return e.innerHTML=t,e}const To=new WeakMap,xo=new WeakMap,No=Symbol("un-keyed"),Io="replaceChildren"in Element.prototype;function Co(t,e){Io?t.replaceChildren(...e):(t.innerHTML="",t.append(...e))}function Ao(t,e){let r=t.firstChild,a=0;for(;r;){if(e[a]!==r)return!0;r=r.nextSibling,a++}return a!==e.length}function Do(t,e){const{targetNode:r}=e;let{targetParentNode:a}=e,s=!1;a?s=Ao(a,t):(s=!0,e.targetNode=void 0,e.targetParentNode=a=r.parentNode),s&&Co(a,t)}function Lo(t,e){for(const r of e){const{targetNode:a,currentExpression:s,binding:{expressionIndex:n,attributeName:c,attributeValuePre:h,attributeValuePost:m}}=r,l=t[n];if(s!==l)if(r.currentExpression=l,c)a.setAttribute(c,h+Kn(l)+m);else{let g;Array.isArray(l)?Do(l,r):l instanceof Element?(g=l,a.replaceWith(g)):a.nodeValue=Kn(l),g&&(r.targetNode=g)}}}function _o(t){let e="",r=!1,a=!1,s=-1;const n=new Map,c=[];for(let m=0,l=t.length;m<l;m++){const g=t[m];if(e+=g,m===l-1)break;for(let E=0;E<g.length;E++)switch(g.charAt(E)){case"<":{g.charAt(E+1)==="/"?c.pop():(r=!0,c.push(++s));break}case">":{r=!1,a=!1;break}case"=":{a=!0;break}}const f=c[c.length-1],d=it(n,f,()=>[]);let k,D,_;if(a){const E=/(\S+)="?([^"=]*)$/.exec(g);k=E[1],D=E[2],_=/^[^">]*/.exec(t[m+1])[0]}const b={attributeName:k,attributeValuePre:D,attributeValuePost:_,expressionIndex:m};d.push(b),!r&&!a&&(e+=" ")}return{template:ko(e),elementsToBindings:n}}function Mo(t,e){const r=[],a=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT);let s=t,n=-1;do{const c=e.get(++n);if(c)for(let h=0;h<c.length;h++){const m=c[h],l=m.attributeName?s:s.firstChild,g={binding:m,targetNode:l,targetParentNode:void 0,currentExpression:void 0};r.push(g)}}while(s=a.nextNode());return r}function Oo(t){const{template:e,elementsToBindings:r}=it(To,t,()=>_o(t)),a=e.cloneNode(!0).content.firstElementChild,s=Mo(a,r);return function(c){return Lo(c,s),a}}function Po(t){const e=it(xo,t,()=>new Map);let r=No;function a(n,...c){const h=it(e,n,()=>new Map);return it(h,r,()=>Oo(n))(c)}function s(n,c,h){return n.map((m,l)=>{const g=r;r=h(m);try{return c(m,l)}finally{r=g}})}return{map:s,html:a}}function jo(t,e,r,a,s,n,c,h){const{labelWithSkin:m,titleForEmoji:l,unicodeWithSkin:g}=r,{html:f,map:d}=Po(e);function k(b,E,w){return d(b,(A,M)=>f`<button role="${E?"option":"menuitem"}" aria-selected="${e.searchMode?M===e.activeSearchItem:""}" aria-label="${m(A,e.currentSkinTone)}" title="${l(A)}" class="emoji ${E&&M===e.activeSearchItem?"active":""}" id="${`${w}-${A.id}`}">${A.unicode?g(A,e.currentSkinTone):f`<img class="custom-emoji" src="${A.url}" alt="" loading="lazy">`}</button>`,A=>`${w}-${A.id}`)}const _=f`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${d(e.skinTones,(b,E)=>f`<div id="skintone-${E}" class="emoji ${E===e.activeSkinTone?"active":""}" aria-selected="${E===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[E]}" aria-label="${e.i18n.skinTones[E]}">${b}</div>`,b=>b)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${d(e.groups,b=>f`<button role="tab" class="nav-button" aria-controls="tab-${b.id}" aria-label="${e.i18n.categories[b.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===b.id}" title="${e.i18n.categories[b.name]}" data-group-id="${b.id}"><div class="nav-emoji emoji">${b.emoji}</div></button>`,b=>b.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${d(e.currentEmojisWithCategories,(b,E)=>f`<div><div id="menu-label-${E}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:b.category?b.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${E}" id="${e.searchMode?"search-results":""}">${k(b.emojis,e.searchMode,"emo")}</div></div>`,b=>b.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${k(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(h){t.appendChild(_);const b=(E,w)=>{for(const A of t.querySelectorAll(`[${E}]`))w(A,A.getAttribute(E))};for(const E of["click","focusout","input","keydown","keyup"])b(`data-on-${E}`,(w,A)=>{w.addEventListener(E,a[A])});b("data-ref",(E,w)=>{n[w]=E}),b("data-action",(E,w)=>{s[w](E)}),c.addEventListener("abort",()=>{t.removeChild(_)})}}const Nt=typeof queueMicrotask=="function"?queueMicrotask:t=>Promise.resolve().then(t);function Bo(t){let e=!1,r;const a=new Map,s=new Set;let n;const c=()=>{if(e)return;const l=[...s];s.clear();try{for(const g of l)g()}finally{n=!1,s.size&&(n=!0,Nt(c))}},h=new Proxy({},{get(l,g){if(r){let f=a.get(g);f||(f=new Set,a.set(g,f)),f.add(r)}return l[g]},set(l,g,f){l[g]=f;const d=a.get(g);if(d){for(const k of d)s.add(k);n||(n=!0,Nt(c))}return!0}}),m=l=>{const g=()=>{const f=r;r=g;try{return l()}finally{r=f}};return g()};return t.addEventListener("abort",()=>{e=!0}),{state:h,createEffect:m}}function en(t,e,r){if(t.length!==e.length)return!1;for(let a=0;a<t.length;a++)if(!r(t[a],e[a]))return!1;return!0}const tn=[],{assign:yt}=Object;function Ro(t,e){const r={},a=new AbortController,s=a.signal,{state:n,createEffect:c}=Bo(s);yt(n,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),yt(n,e),yt(n,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:ao,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:Kt,databaseLoaded:!1,activeSearchItemId:void 0}),c(()=>{n.currentGroup!==n.groups[n.currentGroupIndex]&&(n.currentGroup=n.groups[n.currentGroupIndex])});const h=I=>{t.getElementById(I).focus()},m=I=>t.getElementById(`emo-${I.id}`),l=(I,V)=>{r.rootElement.dispatchEvent(new CustomEvent(I,{detail:V,bubbles:!0,composed:!0}))},g=(I,V)=>I.id===V.id,f=(I,V)=>{const{category:q,emojis:W}=I,{category:ee,emojis:X}=V;return q!==ee?!1:en(W,X,g)},d=I=>{en(n.currentEmojis,I,g)||(n.currentEmojis=I)},k=I=>{n.searchMode!==I&&(n.searchMode=I)},D=I=>{en(n.currentEmojisWithCategories,I,f)||(n.currentEmojisWithCategories=I)},_=(I,V)=>V&&I.skins&&I.skins[V]||I.unicode,w={labelWithSkin:(I,V)=>So([I.name||_(I,V),I.annotation,...I.shortcodes||tn].filter(Boolean)).join(", "),titleForEmoji:I=>I.annotation||(I.shortcodes||tn).join(", "),unicodeWithSkin:_},A={onClickSkinToneButton:Z,onEmojiClick:z,onNavClick:x,onNavKeydown:F,onSearchKeydown:N,onSkinToneOptionsClick:j,onSkinToneOptionsFocusOut:we,onSkinToneOptionsKeydown:J,onSkinToneOptionsKeyup:le,onSearchInput:Ne},M={calculateEmojiGridStyle:$};let S=!0;c(()=>{jo(t,n,w,A,M,r,s,S),S=!1}),n.emojiVersion||Xt().then(I=>{I||(n.message=n.i18n.emojiUnsupportedMessage)}),c(()=>{async function I(){let V=!1;const q=setTimeout(()=>{V=!0,n.message=n.i18n.loadingMessage},no);try{await n.database.ready(),n.databaseLoaded=!0}catch(W){console.error(W),n.message=n.i18n.networkErrorMessage}finally{clearTimeout(q),V&&(V=!1,n.message="")}}n.database&&I()}),c(()=>{n.pickerStyle=`
      --num-groups: ${n.groups.length}; 
      --indicator-opacity: ${n.searchMode?0:1}; 
      --num-skintones: ${Hn};`}),c(()=>{n.customEmoji&&n.database&&U()}),c(()=>{n.customEmoji&&n.customEmoji.length?n.groups!==sn&&(n.groups=sn):n.groups!==Kt&&(n.currentGroupIndex&&n.currentGroupIndex--,n.groups=Kt)}),c(()=>{async function I(){n.databaseLoaded&&(n.currentSkinTone=await n.database.getPreferredSkinTone())}I()}),c(()=>{n.skinTones=Array(Hn).fill().map((I,V)=>vo(n.skinToneEmoji,V))}),c(()=>{n.skinToneButtonText=n.skinTones[n.currentSkinTone]}),c(()=>{n.skinToneButtonLabel=n.i18n.skinToneLabel.replace("{skinTone}",n.i18n.skinTones[n.currentSkinTone])}),c(()=>{async function I(){const{database:V}=n,q=(await Promise.all(oo.map(W=>V.getEmojiByUnicodeOrName(W)))).filter(Boolean);n.defaultFavoriteEmojis=q}n.databaseLoaded&&I()});function U(){n.database.customEmoji=n.customEmoji||tn}c(()=>{async function I(){U();const{database:V,defaultFavoriteEmojis:q,numColumns:W}=n,ee=await V.getTopFavoriteEmoji(W),X=await pe(gr([...ee,...q],ue=>ue.unicode||ue.name).slice(0,W));n.currentFavorites=X}n.databaseLoaded&&n.defaultFavoriteEmojis&&I()});function $(I){bo(I,s,V=>{{const q=getComputedStyle(r.rootElement),W=parseInt(q.getPropertyValue("--num-columns"),10),ee=q.getPropertyValue("direction")==="rtl",ue=I.parentElement.getBoundingClientRect().width-V;n.numColumns=W,n.scrollbarWidth=ue,n.isRtl=ee}})}c(()=>{async function I(){const{searchText:V,currentGroup:q,databaseLoaded:W,customEmoji:ee}=n;if(!W)n.currentEmojis=[],n.searchMode=!1;else if(V.length>=eo){const X=await me(V);n.searchText===V&&(d(X),k(!0))}else{const{id:X}=q;if(X!==-1||ee&&ee.length){const ue=await ye(X);n.currentGroup.id===X&&(d(ue),k(!1))}}}I()}),c(()=>{const{currentEmojis:I,emojiVersion:V}=n,q=I.filter(W=>W.unicode).filter(W=>qn(W)&&!cn.has(W.unicode));if(!V&&q.length)d(I),St(()=>G(q));else{const W=V?I:I.filter(ce);d(W),St(()=>wo(r.tabpanelElement))}});function G(I){Eo(I,r.baselineEmoji,m),n.currentEmojis=n.currentEmojis}function ce(I){return!I.unicode||!qn(I)||cn.get(I.unicode)}async function oe(I){const V=n.emojiVersion||await Xt();return I.filter(({version:q})=>!q||q<=V)}async function pe(I){return go(I,n.emojiVersion||await Xt())}async function ye(I){const V=I===-1?n.customEmoji:await n.database.getEmojiByGroup(I);return pe(await oe(V))}async function me(I){return pe(await oe(await n.database.getEmojiBySearchQuery(I)))}c(()=>{}),c(()=>{function I(){const{searchMode:q,currentEmojis:W}=n;if(q)return[{category:"",emojis:W}];const ee=new Map;for(const X of W){const ue=X.category||"";let Ye=ee.get(ue);Ye||(Ye=[],ee.set(ue,Ye)),Ye.push(X)}return[...ee.entries()].map(([X,ue])=>({category:X,emojis:ue})).sort((X,ue)=>n.customCategorySorting(X.category,ue.category))}const V=I();D(V)}),c(()=>{n.activeSearchItemId=n.activeSearchItem!==-1&&n.currentEmojis[n.activeSearchItem].id}),c(()=>{const{rawSearchText:I}=n;pr(()=>{n.searchText=(I||"").trim(),n.activeSearchItem=-1})});function N(I){if(!n.searchMode||!n.currentEmojis.length)return;const V=q=>{_e(I),n.activeSearchItem=Qt(q,n.activeSearchItem,n.currentEmojis)};switch(I.key){case"ArrowDown":return V(!1);case"ArrowUp":return V(!0);case"Enter":if(n.activeSearchItem===-1)n.activeSearchItem=0;else return _e(I),Y(n.currentEmojis[n.activeSearchItem].id)}}function x(I){const{target:V}=I,q=V.closest(".nav-button");if(!q)return;const W=parseInt(q.dataset.groupId,10);r.searchElement.value="",n.rawSearchText="",n.searchText="",n.activeSearchItem=-1,n.currentGroupIndex=n.groups.findIndex(ee=>ee.id===W)}function F(I){const{target:V,key:q}=I,W=ee=>{ee&&(_e(I),ee.focus())};switch(q){case"ArrowLeft":return W(V.previousElementSibling);case"ArrowRight":return W(V.nextElementSibling);case"Home":return W(V.parentElement.firstElementChild);case"End":return W(V.parentElement.lastElementChild)}}async function Y(I){const V=await n.database.getEmojiByUnicodeOrName(I),q=[...n.currentEmojis,...n.currentFavorites].find(ee=>ee.id===I),W=q.unicode&&_(q,n.currentSkinTone);await n.database.incrementFavoriteEmojiCount(I),l("emoji-click",{emoji:V,skinTone:n.currentSkinTone,...W&&{unicode:W},...q.name&&{name:q.name}})}async function z(I){const{target:V}=I;if(!V.classList.contains("emoji"))return;_e(I);const q=V.id.substring(4);Y(q)}function Q(I){n.currentSkinTone=I,n.skinTonePickerExpanded=!1,h("skintone-button"),l("skin-tone-change",{skinTone:I}),n.database.setPreferredSkinTone(I)}function j(I){const{target:{id:V}}=I,q=V&&V.match(/^skintone-(\d)/);if(!q)return;_e(I);const W=parseInt(q[1],10);Q(W)}function Z(I){n.skinTonePickerExpanded=!n.skinTonePickerExpanded,n.activeSkinTone=n.currentSkinTone,n.skinTonePickerExpanded&&(_e(I),St(()=>h("skintone-list")))}c(()=>{n.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{n.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):n.skinTonePickerExpandedAfterAnimation=!1});function J(I){if(!n.skinTonePickerExpanded)return;const V=async q=>{_e(I),n.activeSkinTone=q};switch(I.key){case"ArrowUp":return V(Qt(!0,n.activeSkinTone,n.skinTones));case"ArrowDown":return V(Qt(!1,n.activeSkinTone,n.skinTones));case"Home":return V(0);case"End":return V(n.skinTones.length-1);case"Enter":return _e(I),Q(n.activeSkinTone);case"Escape":return _e(I),n.skinTonePickerExpanded=!1,h("skintone-button")}}function le(I){if(n.skinTonePickerExpanded)switch(I.key){case" ":return _e(I),Q(n.activeSkinTone)}}async function we(I){const{relatedTarget:V}=I;(!V||V.id!=="skintone-list")&&(n.skinTonePickerExpanded=!1)}function Ne(I){n.rawSearchText=I.target.value}return{$set(I){yt(n,I)},$destroy(){a.abort()}}}const Uo="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Fo="en";var $o={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Vo=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const yr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],Wo=`:host{--emoji-font-family:${vr}}`;class En extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=Vo+Wo,this.shadowRoot.appendChild(r),this._ctx={locale:Fo,dataSource:Uo,skinToneEmoji:ro,customCategorySorting:so,customEmoji:null,i18n:$o,emojiVersion:null,...e};for(const a of yr)a!=="database"&&Object.prototype.hasOwnProperty.call(this,a)&&(this._ctx[a]=this[a],delete this[a]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Ro(this.shadowRoot,this._ctx))}disconnectedCallback(){Nt(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,a){this._set(e.replace(/-([a-z])/g,(s,n)=>n.toUpperCase()),e==="emoji-version"?parseFloat(a):a)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:a}=this._ctx;(!a||a.locale!==e||a.dataSource!==r)&&this._set("database",new Za({locale:e,dataSource:r}))}_dbFlush(){Nt(()=>this._dbCreate())}}const br={};for(const t of yr)br[t]={get(){return t==="database"&&this._dbCreate(),this._ctx[t]},set(e){if(t==="database")throw new Error("database is read-only");this._set(t,e)}};Object.defineProperties(En.prototype,br);customElements.get("emoji-picker")||customElements.define("emoji-picker",En);var ln={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(t,e){(function(r,a){a(e)})(at,function(r){var a="dnd-poly-",s=a+"snapback",n="dnd-poly-",c=n+"dragstart-pending",h=n+"dragstart-cancel",m=["none","copy","copyLink","copyMove","link","linkMove","move","all"],l=["none","copy","move","link"],g=function(){var N=!1;try{var x=Object.defineProperty({},"passive",{get:function(){N=!0}});window.addEventListener("test",null,x)}catch{}return N}();function f(N){return N&&N.tagName}function d(N,x,F){F===void 0&&(F=!0),document.addEventListener(N,x,!!g&&{passive:F})}function k(N,x){document.removeEventListener(N,x)}function D(N,x,F,Y){Y===void 0&&(Y=!1);var z=g?{passive:!0,capture:Y}:Y;return N.addEventListener(x,F,z),{off:function(){N.removeEventListener(x,F,z)}}}function _(N){return N.length===0?0:N.reduce(function(x,F){return F+x},0)/N.length}function b(N,x){for(var F=0;F<N.changedTouches.length;F++)if(N.changedTouches[F].identifier===x)return!0;return!1}function E(N,x,F){for(var Y=[],z=[],Q=0;Q<x.touches.length;Q++){var j=x.touches[Q];Y.push(j[N+"X"]),z.push(j[N+"Y"])}F.x=_(Y),F.y=_(z)}var w=["","-webkit-"];function A(N,x,F,Y,z){z===void 0&&(z=!0);var Q=x.x,j=x.y;Y&&(Q+=Y.x,j+=Y.y),z&&(Q-=parseInt(N.offsetWidth,10)/2,j-=parseInt(N.offsetHeight,10)/2);for(var Z="translate3d("+Q+"px,"+j+"px, 0)",J=0;J<w.length;J++){var le=w[J]+"transform";N.style[le]=Z+" "+F[J]}}var M=function(){function N(x,F){this.t=x,this.i=F,this.s=l[0]}return Object.defineProperty(N.prototype,"dropEffect",{get:function(){return this.s},set:function(x){this.t.mode!==0&&m.indexOf(x)>-1&&(this.s=x)},enumerable:!0,configurable:!0}),Object.defineProperty(N.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(N.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(x){this.t.mode===2&&m.indexOf(x)>-1&&(this.t.effectAllowed=x)},enumerable:!0,configurable:!0}),N.prototype.setData=function(x,F){if(this.t.mode===2){if(x.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[x]=F,this.t.types.indexOf(x)===-1&&this.t.types.push(x)}},N.prototype.getData=function(x){if(this.t.mode===1||this.t.mode===2)return this.t.data[x]||""},N.prototype.clearData=function(x){if(this.t.mode===2){if(x&&this.t.data[x]){delete this.t.data[x];var F=this.t.types.indexOf(x);return void(F>-1&&this.t.types.splice(F,1))}this.t.data={},this.t.types=[]}},N.prototype.setDragImage=function(x,F,Y){this.t.mode===2&&this.i(x,F,Y)},N}();function S(N,x){return N?N===m[0]?l[0]:N.indexOf(m[1])===0||N===m[7]?l[1]:N.indexOf(m[4])===0?l[3]:N===m[6]?l[2]:l[1]:x.nodeType===3&&x.tagName==="A"?l[3]:l[1]}function U(N,x,F,Y,z,Q,j){Q===void 0&&(Q=!0),j===void 0&&(j=null);var Z=function(le,we,Ne,I,V,q,W){W===void 0&&(W=null);var ee=we.changedTouches[0],X=new Event(Ne,{bubbles:!0,cancelable:I});X.dataTransfer=q,X.relatedTarget=W,X.screenX=ee.screenX,X.screenY=ee.screenY,X.clientX=ee.clientX,X.clientY=ee.clientY,X.pageX=ee.pageX,X.pageY=ee.pageY;var ue=le.getBoundingClientRect();return X.offsetX=X.clientX-ue.left,X.offsetY=X.clientY-ue.top,X}(x,F,N,Q,document.defaultView,z,j),J=!x.dispatchEvent(Z);return Y.mode=0,J}function $(N,x){if(!N||N===m[7])return x;if(x===l[1]){if(N.indexOf(l[1])===0)return l[1]}else if(x===l[3]){if(N.indexOf(l[3])===0||N.indexOf("Link")>-1)return l[3]}else if(x===l[2]&&(N.indexOf(l[2])===0||N.indexOf("Move")>-1))return l[2];return l[0]}var G,ce=function(){function N(x,F,Y,z){this.h=x,this.o=F,this.u=Y,this.l=z,this.v=0,this.p=null,this.g=null,this.m=x,this.I=x.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),d("touchmove",this.j,!1),d("touchend",this.S,!1),d("touchcancel",this.S,!1)}return N.prototype.A=function(){var x=this;this.v=1,this.O=l[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var F=this.u;if(this.N=new M(this.D,function(Z,J,le){F=Z,typeof J!="number"&&typeof le!="number"||(x.P={x:J||0,y:le||0})}),this.D.mode=2,this.N.dropEffect=l[0],U("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;E("page",this.m,this.F);var Y,z=this.o.dragImageSetup(F);if(this.L=(Y=z,w.map(function(Z){var J=Y.style[Z+"transform"];return J&&J!=="none"?J.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),z.style.position="absolute",z.style.left="0px",z.style.top="0px",z.style.zIndex="999999",z.classList.add("dnd-poly-drag-image"),z.classList.add("dnd-poly-icon"),this._=z,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var Q=getComputedStyle(F);this.P={x:0-parseInt(Q.marginLeft,10),y:0-parseInt(Q.marginTop,10)}}else{var j=F.getBoundingClientRect();Q=getComputedStyle(F),this.P={x:j.left-this.I.clientX-parseInt(Q.marginLeft,10)+j.width/2,y:j.top-this.I.clientY-parseInt(Q.marginTop,10)+j.height/2}}return A(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){x.X||(x.X=!0,x.Y(),x.X=!1)},this.o.iterationInterval),!0},N.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),k("touchmove",this.j),k("touchend",this.S),k("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},N.prototype.C=function(x){var F=this;if(b(x,this.I.identifier)!==!1){if(this.m=x,this.v===0){var Y=void 0;if(this.o.dragStartConditionOverride)try{Y=this.o.dragStartConditionOverride(x)}catch{Y=!1}else Y=x.touches.length===1;return Y?void(this.A()===!0&&(this.h.preventDefault(),x.preventDefault())):void this.T()}if(x.preventDefault(),E("client",x,this.M),E("page",x,this.F),this.o.dragImageTranslateOverride)try{var z=!1;if(this.o.dragImageTranslateOverride(x,{x:this.M.x,y:this.M.y},this.p,function(Q,j){F._&&(z=!0,F.M.x+=Q,F.M.y+=j,F.F.x+=Q,F.F.y+=j,A(F._,F.F,F.L,F.P,F.o.dragImageCenterOnTouch))}),z)return}catch{}A(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},N.prototype.k=function(x){if(b(x,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(x.preventDefault(),this.v=x.type==="touchcancel"?3:2):this.T()}},N.prototype.Y=function(){var x=this,F=this.O;this.D.mode=3,this.N.dropEffect=l[0];var Y=U("drag",this.u,this.m,this.D,this.N);if(Y&&(this.O=l[0]),Y||this.v===2||this.v===3)return this.q(this.v)?void function(Z,J,le,we){var Ne=getComputedStyle(Z);if(Ne.visibility!=="hidden"&&Ne.display!=="none"){J.classList.add(s);var I=getComputedStyle(J),V=parseFloat(I.transitionDuration);if(isNaN(V)||V===0)we();else{var q=Z.getBoundingClientRect(),W={x:q.left,y:q.top};W.x+=document.body.scrollLeft||document.documentElement.scrollLeft,W.y+=document.body.scrollTop||document.documentElement.scrollTop,W.x-=parseInt(Ne.marginLeft,10),W.y-=parseInt(Ne.marginTop,10);var ee=parseFloat(I.transitionDelay),X=Math.round(1e3*(V+ee));A(J,W,le,void 0,!1),setTimeout(we,X)}}else we()}(this.u,this._,this.L,function(){x.B()}):void this.B();var z=this.o.elementFromPoint(this.M.x,this.M.y),Q=this.g;z!==this.p&&z!==this.g&&(this.p=z,this.g!==null&&(this.D.mode=3,this.N.dropEffect=l[0],U("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=S(this.D.effectAllowed,this.u),U("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=$(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),Q!==this.g&&f(Q)&&(this.D.mode=3,this.N.dropEffect=l[0],U("dragleave",Q,this.m,this.D,this.N,!1,this.g)),f(this.g)&&(this.D.mode=3,this.N.dropEffect=S(this.D.effectAllowed,this.u),U("dragover",this.g,this.m,this.D,this.N)===!1?this.O=l[0]:this.O=$(this.N.effectAllowed,this.N.dropEffect)),F!==this.O&&this._.classList.remove(a+F);var j=a+this.O;this._.classList.add(j)},N.prototype.q=function(x){var F=this.O===l[0]||this.g===null||x===3;return F?f(this.g)&&(this.D.mode=3,this.N.dropEffect=l[0],U("dragleave",this.g,this.m,this.D,this.N,!1)):f(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,U("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=l[0]),F},N.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,U("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},N}(),oe={iterationInterval:150,tryFindDraggableTarget:function(N){var x=N.target;do if(x.draggable!==!1&&(x.draggable===!0||x.getAttribute&&x.getAttribute("draggable")==="true"))return x;while((x=x.parentNode)&&x!==document.body)},dragImageSetup:function(N){var x=N.cloneNode(!0);return function F(Y,z){if(Y.nodeType===1){for(var Q=getComputedStyle(Y),j=0;j<Q.length;j++){var Z=Q[j];z.style.setProperty(Z,Q.getPropertyValue(Z),Q.getPropertyPriority(Z))}if(z.style.pointerEvents="none",z.removeAttribute("id"),z.removeAttribute("class"),z.removeAttribute("draggable"),z.nodeName==="CANVAS"){var J=Y,le=z,we=J.getContext("2d").getImageData(0,0,J.width,J.height);le.getContext("2d").putImageData(we,0,0)}}if(Y.hasChildNodes())for(j=0;j<Y.childNodes.length;j++)F(Y.childNodes[j],z.childNodes[j])}(N,x),x},elementFromPoint:function(N,x){return document.elementFromPoint(N,x)}};function pe(N){if(!G){var x=oe.tryFindDraggableTarget(N);if(x)try{G=new ce(N,oe,x,me)}catch(F){throw me(oe,N,3),F}}}function ye(N){var x=N.target,F=function(J){z.off(),Q.off(),j.off(),Z.off(),x&&x.dispatchEvent(new CustomEvent(h,{bubbles:!0,cancelable:!0})),clearTimeout(Y)};x&&x.dispatchEvent(new CustomEvent(c,{bubbles:!0,cancelable:!0}));var Y=window.setTimeout(function(){z.off(),Q.off(),j.off(),Z.off(),pe(N)},oe.holdToDrag),z=D(x,"touchend",F),Q=D(x,"touchcancel",F),j=D(x,"touchmove",F),Z=D(window,"scroll",F,!0)}function me(N,x,F){if(F===0&&N.defaultActionOverride)try{N.defaultActionOverride(x),x.defaultPrevented}catch{}G=null}r.polyfill=function(N){if(N&&Object.keys(N).forEach(function(z){oe[z]=N[z]}),!oe.forceApply){var x=(F={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},Y=!!window.chrome||/chrome/i.test(navigator.userAgent),F.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||Y&&"ontouchstart"in document.documentElement),F);if(x.userAgentSupportingNativeDnD&&x.draggable&&x.dragEvents)return!1}var F,Y;return oe.holdToDrag?d("touchstart",ye,!1):d("touchstart",pe,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(ln,ln.exports);var zo=ln.exports;const Ho=t=>typeof t!="string"?t:t.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),Ce=(t,e)=>{t.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{t.classList.add(e)})})},qo=()=>{const t=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${t.height}px`);t.addEventListener("resize",e),e()};let Jn;const Yo=(t=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),a=()=>{clearTimeout(r),clearTimeout(Jn),Jn=setTimeout(()=>{t.removeEventListener("scroll",a),e()},100)};t.addEventListener("scroll",a)}),un=t=>{try{return JSON.parse(t),!0}catch{return!1}},Go="0.6.4 Beta",We=document.querySelector(".editor"),fe=document.getElementById("tones"),Ee=document.getElementById("action"),ae=document.getElementById("musical-score"),$e=document.getElementById("add-track"),ct=document.getElementById("remove-track"),ze=document.getElementById("dialog"),re=document.forms["dialog-form"];re._title=re.querySelector(".form-title");re.description=re.querySelector(".description");re.inputs=re.querySelector(".inputs");re.buttons=re.querySelector(".buttons");const It=document.getElementById("play"),Ct=document.getElementById("clear"),Ko=document.getElementById("warn-out"),Jo=document.getElementById("mml"),Le=document.getElementById("copy"),Ue=document.getElementById("paste"),Ve=document.getElementById("save"),dn=document.getElementById("open"),Rt=document.getElementById("ctrl"),At=document.getElementById("undo"),Dt=document.getElementById("redo");var ut,de,Ae,Je;class Xo{constructor(){ke(this,ut,`#COMMENT Generated by FlMML VisualSequencer v${Go}`);ke(this,de,[]);ke(this,Ae,(e,r)=>{});ke(this,Je,(e,r)=>{})}set onChange(e){xe(this,Ae,e)}set onError(e){xe(this,Je,e)}setMmlArr(e){xe(this,de,e),B(this,Ae).call(this,this.getMmlArr(),this.getMml())}setMml(e){xe(this,de,e.split(`
`)),B(this,de).at(-2)===""&&B(this,de).at(-1)===B(this,ut)&&B(this,de).splice(-2,2),B(this,Ae).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return B(this,de)}getMml(){return B(this,de).length?B(this,de).concat(["",B(this,ut)]).join(`
`):""}getMmlLine(e){return B(this,de)[e]}insert(e,r){Object.hasOwn(B(this,de),e)||e===0?(B(this,de).splice(e,0,r),B(this,Ae).call(this,this.getMmlArr(),this.getMml())):B(this,Je).call(this,"範囲外の書き換え指定",`範囲${B(this,de).length-1}までのところ、${e}`)}append(e){B(this,de).push(e),B(this,Ae).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(B(this,de),e)?(B(this,de)[e]+=r,B(this,Ae).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(B(this,de),e)?(B(this,de)[e]=r+B(this,de)[e],B(this,Ae).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(B(this,de),e)?(B(this,de)[e]=r,B(this,Ae).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(B(this,de),e)&&B(this,de).splice(e,r).length!==0?B(this,Ae).call(this,this.getMmlArr(),this.getMml()):B(this,Je).call(this,"無効な指定",`範囲${B(this,de).length-1}までの中で${e}から${r}削除するのはできません`)}}ut=new WeakMap,de=new WeakMap,Ae=new WeakMap,Je=new WeakMap;var he,Xe,dt,Fe;class Qo{constructor(e,r){ke(this,he,[]);ke(this,Xe,[]);ke(this,dt,null);ke(this,Fe,null);this.tonesElem=e,this.areaElem=r,xe(this,Fe,this.areaElem.querySelector(".track.active"))}set activeTrack(e){B(this,Fe).classList.remove("active"),xe(this,Fe,e),B(this,Fe).classList.add("active")}get activeTrack(){return B(this,Fe)}blocksDataUpdate(){xe(this,he,[...this.areaElem.querySelectorAll(".track button")].map(this.extractBlockData))}extractBlockData(e){return{label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),...e.dataset,elem:e}}saveBlocksData(){clearTimeout(B(this,dt)),xe(this,dt,setTimeout(()=>{const e=JSON.parse(JSON.stringify(B(this,he)));nn.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){nn.getItem("BlocksData").then(e=>{e&&(xe(this,he,e.map(r=>{const a=r.tone;return(a==null?void 0:a.tone)!==void 0&&(a==null?void 0:a.tonePitch)!==void 0&&(r.tone=a.tone,r.tonePitch=a.tonePitch),r})),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(te),this.calcPlayFromHere())})}parseBlocks(){const e=B(this,he);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let a=0;e.forEach(s=>{if(s.trackNo!==a){const g=document.createElement("ul");g.classList.add("track"),this.activeTrack=g,this.areaElem.insertBefore(g,$e),a=s.trackNo}const n=document.createElement("li"),c='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',h=(()=>{const g=document.createElement("div");return g.innerHTML=c,g.firstElementChild})(),m=document.querySelector(`[class*="${s.className.replace(/ material-icons| droppable| bounce| pop| done| inactive/g,"")}"]`),l=(m==null?void 0:m.cloneNode(!0))||h;s.label&&(l.ariaLabel=s.label),l.className=s.className,s.tonePitch&&(s.label!=="無調整"&&(l.textContent=s.label),l.dataset.tone=s.tone,m?m.replaceWith(l.cloneNode(!0)):r.appendChild(l.cloneNode(!0)),l.dataset.tonePitch=s.tonePitch),s.tempo&&(l.dataset.tempo=s.tempo),s.noteValue&&(l.dataset.noteValue=s.noteValue),s.rest&&(l.dataset.rest=s.rest),s.octave&&(l.dataset.octave=s.octave),s.velocity&&(l.dataset.velocity=s.velocity),s.noteShift&&(l.dataset.noteShift=s.noteShift),s.detune&&(l.dataset.detune=s.detune),s.tieSlur&&(l.dataset.tieSlur=s.tieSlur,s.tieSlur==="&"?l.ariaLabel="スラー":l.ariaLabel="タイ"),s.repeatStartEnd&&(l.dataset.repeatStartEnd=s.repeatStartEnd,s.repeatStartEnd.startsWith("/:")?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆"):s.repeatStartEnd===":/"&&(l.ariaLabel="リピート終了")),s.repeatBreak&&(l.dataset.repeatBreak=s.repeatBreak),s.polyStartEnd&&(l.dataset.polyStartEnd=s.polyStartEnd),s.macroDef&&(l.dataset.macroDef=s.macroDef,l.textContent=s.macroDef===";"?";":"$="),s.macroArgUse&&(l.dataset.macroArgUse=s.macroArgUse),s.macroUse&&(l.dataset.macroUse=s.macroUse),s.metaData&&(l.dataset.metaData=s.metaData),s.otherAction&&(l.dataset.otherAction=s.otherAction,l.textContent=s.otherAction.length>4?"…":s.otherAction),n.appendChild(l),this.activeTrack.appendChild(n)})}exportMml(e){e.setMmlArr([]);let r=0,a=0;const s=B(this,he).filter(b=>b.tone!==void 0),n=()=>s.filter(b=>b.trackNo===a),c=()=>new Set(n().map(b=>b.tone));let h=c(),m=0,l=!1,g={noteValue:4,dots:0},f=!1,d=!1;const k=B(this,he).findIndex(b=>b.elem.classList.contains("play-from-here")),D=k!==-1,_=D?B(this,he)[k].trackNo:-1;B(this,he).forEach((b,E)=>{const{tone:w,tonePitch:A}=b,M=!D||d||D&&b.trackNo===_&&E>=k;if(b.trackNo!==a&&(h.size?([...h].forEach((S,U)=>{e.appendToStr(r+U,";")}),r+=h.size):(e.appendToStr(r,";"),r++),a=b.trackNo,h=c(),l=!1,d=!1),w!==void 0)m=[...h].indexOf(w),l||([...h].forEach((S,U)=>{S&&e.beforeInsertToStr(r+U,S+" ")}),l=!0),[...h].forEach((S,U)=>{let $=A||"";U!==m&&($=$.replace(/[a-g]/,f?"*":"r")),M||($=$.replace(/[a-gr*]\+?[0-9]*\.*/i,"")),e.appendToStr(r+U,$)});else if(b.rest||b.tieSlur){let S=b.rest||b.tieSlur;M||(S=S.replace(/[r&]\+?[0-9]*\.*/i,"")),h.size?[...h].forEach((U,$)=>{e.appendToStr(r+$,S)}):e.appendToStr(r,S)}else if(b.noteValue||b.repeatStartEnd||b.repeatBreak||b.polyStartEnd){const S=U=>{if(!U)return g;const $=Number((U.match(/[0-9]+/)||[g.noteValue])[0]),G=(U.match(/\.+/)||[""])[0].length;return{noteValue:$,dots:G}};b.noteValue?g=S(b.noteValue):b.polyStartEnd==="["?f=!0:b.polyStartEnd==="]"&&(f=!1),h.size?[...h].forEach((U,$)=>{if(e.appendToStr(r+$,b.noteValue||b.repeatStartEnd||b.repeatBreak||b.polyStartEnd||""),b.polyStartEnd==="]"){const G=e.getMmlLine(r+$).match(/\[(.+?)\]/);if(G){const ce=G[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(ce){const oe=[...ce].map(me=>({type:me[1]==="r"?"rest":me[1]==="*"?"otherNote":"note",num:S(me[0])}));oe.filter(N=>N.type==="note").map(N=>N.num),oe.filter(N=>N.type==="otherNote").map(N=>N.num),oe.filter(N=>N.type==="rest").map(N=>N.num);let pe=G[0].replace(/\*\+?[0-9]*\.*/g,"");const ye=e.getMmlLine(r+$).replace(/\[.+?\]/,pe);e.rewrite(r+$,ye)}}}}):e.appendToStr(r,b.noteValue||b.repeatStartEnd||b.repeatBreak||b.polyStartEnd||"")}else if(b.metaData)b.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,b.metaData.replace(`
`,"")||""),r++;else if(b.macroDef)d=b.macroDef!==";",e.appendToStr(r,b.macroDef||"");else{let S;M?S=A||b.tempo||b.octave||b.velocity||b.noteShift||b.detune||b.tieSlur||b.macroArgUse||b.macroUse||b.otherAction||"":S=(A==null?void 0:A.replace(/[a-g]\+?[0-9]*\.*/i,""))||b.tempo||b.octave||b.velocity||b.noteShift||b.detune||b.tieSlur||b.otherAction||"",e.appendToStr(r,S),/;/.test(S)&&(r+=h.size||1,h=c(),l=!1)}}),[...h].slice(0,-1).forEach((b,E)=>{e.appendToStr(r+E,";")})}importMml(e){const r=e.getMmlArr(),a=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_.]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig,s=new Set,n=new Set;let c=0,h="",m=!1,l=!1;const g=d=>(d.match(a)||[]).reduce((D,_)=>(_=_.trim(),_&&(E=>{const w={};if(w.tone={},w.trackNo=c,E.startsWith("#")){const A={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};w.label=(Object.entries(A).find(M=>E.startsWith(M[0]))||[,void 0])[1],w.className="meta-data",w.metaData=E+`
`}else if(/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(E)){h=E,n.add(h);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(E)){n.has(h)||n.add(h);const A=[...n].indexOf(h)+1;w.label="無調整",w.className=`material-icons note note-${A}`,w.tone=h,w.tonePitch=E,m&&(l=!0)}else if(E.startsWith("t"))w.className="material-icons tempo",w.tempo=E;else if(E.startsWith("l"))w.className="material-icons note-value",w.noteValue=E;else if(E.startsWith("r"))w.className="material-icons rest",w.rest=E;else if(/^o[0-8]|[><]+$/i.test(E))w.className="material-icons octave",w.octave=E;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(E))w.className="material-icons velocity",w.velocity=E;else if(E.startsWith("@ns")||E.startsWith("ns"))w.className="material-icons note-shift",w.noteShift=E;else if(E.startsWith("@d"))w.className="material-icons detune",w.detune=E;else if(E.startsWith("&"))w.className="tie-slur",w.tieSlur=E;else if(E.startsWith("/*"))w.className="other-action",w.otherAction=E;else if(E.startsWith("/:"))w.className="repeat-start-end",w.repeatStartEnd=E;else if(E.startsWith(":/"))w.className="material-icons repeat-start-end",w.repeatStartEnd=E;else if(E.startsWith("/"))w.className="repeat-break",w.repeatBreak=E;else if(E.startsWith("[")||E.startsWith("]"))w.className="poly-start-end",w.polyStartEnd=E;else if(/^\$.*?=$/.test(E))w.className="macro-def",w.macroDef=E.replaceAll(" ",""),s.add(w.macroDef.slice(0,-1)),m=!0;else if(E.startsWith("%"))w.className="macro-arg-use",w.macroArgUse=E;else if(E.startsWith("$")){w.className="macro-use";const A=[...s].sort((M,S)=>S.length-M.length).find(M=>E.includes(M));if(A){w.macroUse=A,D.push(w);const M=E.replace(A,"");M!==""&&(D=D.concat(g(M)));return}else w.macroUse=E}else if(E.startsWith(";")){if(c++,m&&!l){const A=[...n].join(" ");A&&(w.className="other-action",w.otherAction=A,D.push(w),n.clear())}h="",m=!1,l=!1;return}else w.className="other-action",w.otherAction=E;D.push(w)})(_),D),[]);this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((d,k)=>{k?d.remove():(d.textContent="",this.activeTrack=d)}),K=null;const f=r.map(g).flat();xe(this,he,f),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}getBlocksData(){return B(this,he)}setBlocksData(e){this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((r,a)=>{a?r.remove():(r.textContent="",this.activeTrack=r)}),K=null,xe(this,he,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData(),this.exportMml(te),this.calcPlayFromHere()}playRendering(e=-1){const r=B(this,he);if(!r.length)return;const a=e!==-1,s=r[e],n=a?s.trackNo:-1;let c=120,h=0;[fe,Ee,ae].forEach(D=>{D.classList.add("no-op")});const m=document.querySelector(".wrap"),l=document.getElementsByClassName("track"),f=(m.clientHeight-32)/l.length;[...l].forEach(D=>{D.style.setProperty("--max-height",`${f}px`)}),$e.disabled=!0,ct.disabled=!0;const d=(D,{scoreNoteValue:_=4,ignorePlayFromHere:b=!1}={})=>{var Q;let E=!1,w=-1,A=!1,M=!1;const S=[],U=performance.now(),$=(Q=D[0])==null?void 0:Q.trackNo,G=l[$],ce=h++,oe=D.findIndex(j=>j===s);let pe=null;const ye=new Promise(j=>pe=j);let me=0,N=0;const x=j=>{if(!j)return _;const Z=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(j),J=Z&&Z[1]?Number(Z[1]):_,le=Z?Z[2].length:0;return J*2**le/(2**(le+1)-1)},F=j=>{const Z=le=>{!M&&G.scrollTo({top:le,behavior:"smooth"}),M=!0,Yo(G).then(()=>{M=!1})},J=le=>G.clientHeight*le;(N===0||j.elem.offsetTop>G.scrollTop+J(.8)||j.elem.offsetTop<G.scrollTop+J(.2))&&Z(j.elem.offsetTop-J(.2))},Y=j=>{const Z=J=>{const le=J-U,we=60/c*4/j*1e3;le<me+we?B(this,Xe)[ce]=requestAnimationFrame(Z):(me+=we,z())};B(this,Xe)[ce]=requestAnimationFrame(Z)},z=async()=>{var le,we,Ne,I,V;const j=D[N];if(!j||N>=D.length){pe({scoreNoteValue:_});return}F(j);const Z=q=>{let W=0;return D.findIndex((ee,X)=>{var ue;if(X>q+1){if((ue=ee.repeatStartEnd)!=null&&ue.startsWith("/:"))W++;else if(ee.repeatStartEnd===":/"){if(W===0)return!0;W--}}return!1})},J=!a||b||a&&j.trackNo===n&&N>=oe;if(A){j.macroDef===";"&&(A=!1),N++,z();return}else if(j.tonePitch)if(J&&Ce(j.elem,"bounce"),N++,E||!J)z();else{const q=x(j.tonePitch);Y(q)}else if(j.rest||j.tieSlur)if(J&&Ce(j.elem,"pop"),N++,j.tieSlur==="&"||!J)z();else{const q=x(j.rest||j.tieSlur);Y(q)}else if(j.polyStartEnd)if(E=j.polyStartEnd==="[",J&&Ce(j.elem,"pop"),E||!J)N++,z();else{const q=x(D[N++-1].tonePitch);Y(q)}else if(j.macroDef&&j.macroDef!==";"){A=!0,N++,z();return}else{if(j.tempo&&(c=Number(j.tempo.replace("t",""))||c),j.noteValue&&(_=x(j.noteValue)),(le=j.repeatStartEnd)!=null&&le.startsWith("/:")){S[we=++w]??(S[we]={}),(Ne=S[w]).start??(Ne.start=N);const q=j.repeatStartEnd.replace("/:","");if((I=S[w]).count??(I.count=q===""?2:Number(q)),S[w].count){if(S[w].end)if(S[w].remaining===0){j.elem.dataset.repeatStartEnd=`/:${S[w].remaining}`,N=S[w].end,z();return}else D.slice(S[w].start+1,S[w].end-1).filter(W=>{var ee;return(ee=W.repeatStartEnd)==null?void 0:ee.startsWith("/:")}).forEach(W=>{W.elem.dataset.repeatStartEnd=W.repeatStartEnd});else S[w].remaining=S[w].count;j.elem.dataset.repeatStartEnd=`/:${S[w].remaining}`}else{N=Z(S[w].start),z(),J&&(Ce(j.elem,"pop"),Ce(j.elem,"done"));return}}else if(j.repeatBreak){if(S[w].remaining===1){S[w].end||(S[w].end=Z(S[w].start)),N=S[w].end,z(),J&&(Ce(j.elem,"pop"),Ce(j.elem,"done"));return}}else if(j.repeatStartEnd===":/"){if((V=S[w]).end??(V.end=N),S[w].remaining){S[w].remaining--,N=S[w].start,w--,z(),J&&(Ce(j.elem,"pop"),Ce(j.elem,"done"));return}S.pop(),w--}else if(j.macroUse&&J){const q=ee=>{const X=r[ee].trackNo;let ue=ee+1;for(;r[ue].macroDef!==";"&&r[ue].trackNo===X;)ue++;return ue},W={};if(W.start=r.findIndex(ee=>{var X;return(X=ee.macroDef)==null?void 0:X.startsWith(j.macroUse)}),W.start>-1){W.end=q(W.start),W.blocks=r.slice(W.start+1,W.end);const ee=performance.now();_=(await d(W.blocks,{scoreNoteValue:_,ignorePlayFromHere:!0})).scoreNoteValue;const X=performance.now();me+=X-ee}}N++,z(),J&&Ce(j.elem,"pop")}J&&Ce(j.elem,"done")};return z(),ye},k=r.at(-1).trackNo+1;for(let D=0;D<k;D++){const _=r.filter(b=>b.trackNo===D);d(_)}}stopRendering(){[fe,Ee,ae].forEach(e=>{e.classList.remove("no-op")}),$e.disabled=!1,ct.disabled=!1,B(this,he).forEach(e=>{e.elem.classList.remove("done")}),B(this,he).filter(e=>{var r;return(r=e.repeatStartEnd)==null?void 0:r.startsWith("/:")}).forEach(e=>{e.elem.dataset.repeatStartEnd=e.repeatStartEnd}),B(this,Xe).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!B(this,he).length)return;const e=B(this,he).at(-1).trackNo+1;for(let r=0;r<e;r++)B(this,he).filter(s=>s.polyStartEnd&&s.trackNo===r).forEach((s,n)=>{n%2===0?(s.elem.dataset.polyStartEnd="[",s.elem.textContent="["):(s.elem.dataset.polyStartEnd="]",s.elem.textContent="]")});this.blocksDataUpdate()}calcPlayFromHere(){if(!B(this,he).length)return;B(this,he).filter(s=>s.elem.classList.contains("inactive")).forEach(s=>{s.elem.classList.remove("inactive")});const e=B(this,he).find(s=>s.elem.classList.contains("play-from-here"));if(!e){Le.disabled=Ve.disabled=!1;return}const r=B(this,he).indexOf(e);B(this,he).filter((s,n)=>s.playFromHere?!1:s.trackNo!==e.trackNo?!0:n<r).forEach(s=>{s.elem.classList.add("inactive")}),Le.disabled=Ve.disabled=!0}}he=new WeakMap,Xe=new WeakMap,dt=new WeakMap,Fe=new WeakMap;var ge,Ot,ft,Qe;class Zo{constructor(){ke(this,ge,[[],[]]);ke(this,Ot,70);ke(this,ft,e=>{});ke(this,Qe,e=>{})}set onPushstate(e){xe(this,ft,e)}set onPopstate(e){xe(this,Qe,e)}pushState(e){B(this,ge)[0].push(e),B(this,ft).call(this,e),B(this,ge)[0].length>B(this,Ot)&&B(this,ge)[0].shift(),B(this,ge)[1].length=0,console.log(B(this,ge))}undo(){const e=B(this,ge)[0].pop();return B(this,Qe).call(this,{reason:"undo",data:e}),e&&B(this,ge)[1].unshift(e),console.log(B(this,ge)),{canUndo:!!B(this,ge)[0].length,canRedo:!!B(this,ge)[1].length}}redo(){const e=B(this,ge)[1].shift();return B(this,Qe).call(this,{reason:"redo",data:e}),e&&B(this,ge)[0].push(e),console.log(B(this,ge)),{canUndo:!!B(this,ge)[0].length,canRedo:!!B(this,ge)[1].length}}clear(){B(this,ge)[0].length=0,B(this,ge)[1].length=0,console.log(B(this,ge))}}ge=new WeakMap,Ot=new WeakMap,ft=new WeakMap,Qe=new WeakMap;const De=[1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,384];let K=fe.querySelector("button"),Er=!1,Me=!1;const Pe={timeStamp:-1,tempo:120,scoreNoteValue:"4"};let fn=null,mn=!1,bt=null;const Sr=()=>{T.activeTrack.querySelectorAll("button").forEach(t=>{t.classList.remove("done")}),mn=!1},Lt=()=>{if(clearTimeout(fn),K&&K.closest(".track")!==T.activeTrack){K=T.activeTrack.querySelector("button");return}let t=K;const e=()=>{const n=performance.measure("stepElapsed","stepPoint");performance.mark("stepPoint");const c=n.duration,m=(g=>{const f=60/Pe.tempo*4/g*1e3,{noteValue:d,dots:k}=De.reduce((D,_,b)=>{const E=Math.log2(f/(2*f-_));if(E<0||Number.isNaN(E))return D;const w=E-Math.floor(E);return w<D.smallerFractional?{noteValue:_,dots:Math.round(E),smallerFractional:w}:D},{noteValue:null,dots:null,smallerFractional:1});if(d+".".repeat(k)===Pe.scoreNoteValue)return"";if(String(d)===Pe.scoreNoteValue){const D=Pe.scoreNoteValue.match(/\.*/),_=D?D[0].length:0;return".".repeat(k-_)}else return d+".".repeat(k)})(c);(g=>{const f=bt;"tonePitch"in f.dataset?f.dataset.tonePitch=f.dataset.tonePitch+g:"rest"in f.dataset&&(f.dataset.rest="r"+g)})(m),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te)};if(!t){if(mn){console.log("end1");return}Te.stop(),e(),Pe.timeStamp=-1,bt=null,performance.clearMarks("stepPoint"),setTimeout(()=>{K=T.activeTrack.querySelector("button"),Sr()},2e3),mn=!0,console.log("end2");return}(()=>{if("tonePitch"in t.dataset){t.dataset.tonePitch=t.dataset.tonePitch.match(/[><]*?[a-g]\+?/i)[0],Oe(t,{noteValue:"1..."}),t.classList.add("bounce");return}"rest"in t.dataset&&(t.dataset.rest="r"),t.classList.add("done")})();const a=()=>{var n;K=t=((n=t.parentElement.nextElementSibling)==null?void 0:n.firstElementChild)||null};if("tonePitch"in t.dataset||Te.stop(),!["tonePitch","rest"].some(n=>n in t.dataset)){if("tempo"in t.dataset){const n=Number(t.dataset.tempo.replace("t",""));Pe.tempo=n}else"noteValue"in t.dataset&&(Pe.scoreNoteValue=(t.dataset.noteValue.match(/[0-9]+\.*/)||[Pe.scoreNoteValue])[0]);a(),Lt(),console.log("end3");return}if((()=>{const n=60/Pe.tempo*4*1e3*1.825;fn=setTimeout(Lt,n)})(),!performance.getEntriesByName("stepPoint")[0]){performance.mark("stepPoint"),bt=t,a(),console.log("end4");return}e(),bt=t,a()};var Pt,jt,Bt;class es{constructor(e){ke(this,Pt,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name"},{label:"音の定義",type:"text",name:"tone-def",autofocus:!0}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}]},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"0",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}]},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0"}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}]},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"0",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}]},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"0",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}]},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8"}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}]},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127"}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}]},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift"}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}]},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune"}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}]},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"0",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}]},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0"}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}]},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg"}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}]},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use"}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}]},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg"}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}]},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}]},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action"}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}]},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}]},step:{title:"ステップ音価記録",description:`ステップ音価記録は、簡単に音価を指定できる機能です。

各トラックの空白部分をテンポよくクリック、またはスペースキーを押して最初の音符から順に音価を決定します。
途中から指定をやり直したいときは、やり直したい音符をクリックすることでそこからやり直せます。

この画面は、Shiftキーを押しながらステップ音価記録ブロックをクリックすることで再度表示できます。`,buttons:[{className:"primaly",value:"set-step",textContent:"開始"},{value:"cancel-step",textContent:"やめる"}]}});ke(this,jt,e=>{const r=B(this,Pt)[e];Object.keys(r).forEach(a=>{switch(a){case"title":re._title.textContent=r.title;break;case"description":(()=>{const s=document.createElement("p");s.innerHTML=r.description.replaceAll(`
`,"<br>"),re.description.appendChild(s)})();break;case"inputs":r.inputs.forEach(s=>{const n=document.createElement("input");let c=n;Object.entries(s).forEach(([h,m])=>{if(h==="label"){const l=document.createElement("label");l.textContent=m,l.appendChild(n),c=l}else if(h==="select"){const l=document.createElement("select");l.name=s.name;const g=m;if(""in g){const f=document.createElement("option");f.value="",f.textContent=g[""],l.appendChild(f)}Object.entries(g).forEach(([f,d])=>{if(f==="")return;const k=document.createElement("option");k.value=f,k.textContent=d,l.appendChild(k)}),n.replaceWith(l)}else n[h]=m}),re.inputs.appendChild(c)});break;case"buttons":r.buttons.forEach(s=>{const n=document.createElement("button");Object.entries(s).forEach(([c,h])=>{n[c]=h}),re.buttons.appendChild(n)});break}})});ke(this,Bt,(e,r)=>{re._title.textContent="",re.description.textContent="",re.inputs.textContent="",re.buttons.textContent="",B(this,jt).call(this,e);for(const[a,s]of Object.entries(r))a==="run"?s():re.elements[a].value=s;this.type=e});this.type=null,this.submitTarget=null,this.resolve=null,e.addEventListener("submit",r=>{const a=this.submitTarget,s=r.submitter.value,n=JSON.parse(JSON.stringify(a.dataset));switch(s){case"set-tone":const h=a.className;document.querySelectorAll(`[class*="${h}"]`).forEach(d=>{d.ariaLabel=e.elements["tone-name"].value,(!d.classList.contains("material-icons")||e.elements["tone-name"].value!=="無調整")&&(d.classList.remove("material-icons"),d.textContent=e.elements["tone-name"].value),d.dataset.tone=e.elements["tone-def"].value});break;case"set-tone-pitch":a.dataset.tonePitch=a.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]+e.elements["tone-pitch"].value+".".repeat(e.elements.dot.value);break;case"set-tempo":a.dataset.tempo="t"+e.elements.tempo.value;break;case"set-note-value":a.dataset.noteValue="l"+e.elements["note-value"].value+".".repeat(e.elements.dot.value);break;case"set-rest":a.dataset.rest="r"+e.elements.rest.value+".".repeat(e.elements.dot.value);break;case"set-octave":a.dataset.octave="o"+e.elements.octave.value;break;case"set-octave-relative":a.dataset.octave=e.elements.octave.value>0?"<".repeat(e.elements.octave.value):">".repeat(-e.elements.octave.value);break;case"set-velocity":a.dataset.velocity="@v"+e.elements.velocity.value;break;case"set-velocity-relative":a.dataset.velocity=(e.elements.velocity.value>=0?"(":")")+Math.abs(e.elements.velocity.value);break;case"set-note-shift":a.dataset.noteShift="ns"+e.elements["note-shift"].value;break;case"set-note-shift-relative":a.dataset.noteShift="@ns"+e.elements["note-shift"].value;break;case"set-detune":a.dataset.detune="@d"+e.elements.detune.value;break;case"set-tie-slur":a.dataset.tieSlur="&"+e.elements["tie-slur"].value+".".repeat(e.elements.dot.value),a.dataset.tieSlur==="&"?a.ariaLabel="スラー":a.ariaLabel="タイ";break;case"set-repeat":a.dataset.repeatStartEnd="/:"+e.elements.repeat.value;break;case"set-macro-def":const m=a.dataset.macroDef;a.dataset.macroDef="$"+e.elements["macro-def-name"].value+(e.elements["macro-def-arg"].value!==""?`{${e.elements["macro-def-arg"].value}}`:"")+"=",ae.querySelectorAll(`[data-macro-use="${m.replace("=","")}"]`).forEach(d=>{d.dataset.macroUse=a.dataset.macroDef.replace("=","")});break;case"set-macro-arg-use":a.dataset.macroArgUse="%"+e.elements["macro-arg-use"].value;break;case"set-macro-use":a.dataset.macroUse="$"+e.elements["macro-use-name"].value+(e.elements["macro-use-arg"].value!==""?`{${e.elements["macro-use-arg"].value}}`:"");break;case"set-meta-data":a.ariaLabel=e.elements["select-meta-data"].selectedOptions[0].label,a.dataset.metaData=e.elements["select-meta-data"].value.replace("{n}",e.elements.number.value).replace("{desc}",e.elements.text.value);break;case"set-other-action":a.dataset.otherAction=e.elements["other-action"].value,a.textContent=a.dataset.otherAction.length>4?"…":a.dataset.otherAction;break;case"remove-left":case"remove-right":const l=a.parentElement,g=T.activeTrack,f=g.children;for([...f].indexOf(l),K=null;[...f].includes(l);){const d=s==="remove-left",k=d?g.firstElementChild:g.lastElementChild;Se.pushState({operation:"remove",removedElem:k,removedIndex:d?0:f.length-1,parent:g}),k.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere();break;case"set-step":Er=!0,Me=!0;break;case"cancel-step":Me=!1;break}const c=JSON.parse(JSON.stringify(a.dataset));JSON.stringify(n)!==JSON.stringify(c)&&Se.pushState({operation:"valueChange",target:a,beforeChange:n,afterChange:c}),this.resolve()})}async prompt(e,r,a){return B(this,Bt).call(this,e,r),this.submitTarget=a,ze.showModal(),new Promise(s=>this.resolve=s)}}Pt=new WeakMap,jt=new WeakMap,Bt=new WeakMap;Zn.FlMML.prepare(".editor");const Te=new Zn.FlMML({workerURL:da}),te=new Xo;nn.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const T=new Qo(fe,ae),Se=new Zo,_t=new es(re),ts={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},ns=new En({i18n:ts,locale:"ja"});zo.polyfill({holdToDrag:500});qo();const lt=t=>`<span class="material-icons">${t}</span>`,wr=lt("play_arrow")+"再生",rs=lt("stop")+"停止",hn=()=>{const t=[...ae.querySelectorAll(".track button")].findIndex(e=>e.classList.contains("play-from-here"));T.playRendering(t)},as=()=>{Ko.innerHTML=Te.getWarnings().replaceAll(`
`,"<br>")};Te.addEventListener("compilecomplete",as);const os=()=>{It.innerHTML=wr,T.stopRendering(),Te.removeEventListener("compilecomplete",hn),Ct.disabled=!1};Te.addEventListener("complete",os);te.onChange=(t,e)=>{Jo.innerHTML=e?`<pre><code>${Ho(e).replaceAll(`
`,"<br>")}</code></pre>`:"(なし)";const r=!!t.length;Le.disabled=Ve.disabled=!r};te.onError=(t,e)=>{alert(t+`
`+e)};T.checkSavedBlocksData();const Oe=(t,e={})=>{var b;const r=()=>{let E=t.parentElement;for(;E&&!("noteValue"in E.firstElementChild.dataset);)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null},a=()=>{var w;let E=t.parentElement;for(;E&&!((w=E.firstElementChild.dataset.octave)!=null&&w.startsWith("o"));)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null},s=()=>{var A;let E=t.parentElement.nextElementSibling,w="";for(;E&&((A=E.firstElementChild.dataset.tieSlur)!=null&&A.match(/&[0-9]+\.*/));)w+=E.firstElementChild.dataset.tieSlur,E=E.nextElementSibling;return w},n=((b=r())==null?void 0:b.dataset.noteValue)||"",c=a(),h=c?[...T.activeTrack.children].indexOf(c.parentElement):0,m=(c==null?void 0:c.dataset.octave)||"",l=[...T.activeTrack.children].indexOf(t.parentElement),g=[...T.activeTrack.children].slice(h,l).filter(E=>"tonePitch"in E.firstElementChild.dataset||"octave"in E.firstElementChild.dataset&&!E.firstElementChild.dataset.octave.startsWith("o")).map(E=>((E.firstElementChild.dataset.tonePitch||E.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),f={down:">",up:"<"},d=(E,w)=>(E.match(new RegExp(w,"g"))||[]).length,k=(()=>{const E=-d(g,f.down)+d(g,f.up);return E<0?f.down.repeat(-E):E>0?f.up.repeat(E):""})(),D=s(),_=e.noteValue?t.dataset.tonePitch.replace(/[0-9]+\.*/,"")+e.noteValue:t.dataset.tonePitch;Te.play(t.dataset.tone+n+m+k+_+D)};Se.onPopstate=t=>{const e=t.data,r=a=>!!e.parent.closest("#"+a);switch(t.reason){case"undo":switch(e==null?void 0:e.operation){case"append":te.delete(e.index);break;case"delete":te.insert(e.index,e.mmlText);break;case"rewrite":te.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere());break;case"move":const a=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(a,e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere());break;case"valueChange":for(const[s,n]of Object.entries(e.beforeChange))e.target.dataset[s]=n;"tone"in e.target.dataset&&Oe(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere());break;case"clear":e.tonesChildren.forEach(s=>{fe.querySelector("ul").appendChild(s)}),e.musicalScoreChildren.forEach(s=>{ae.insertBefore(s,$e)}),K=e.lastTouchedButton,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":te.append(e.mmlText);break;case"delete":te.delete(e.index);break;case"rewrite":te.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere()),"tonePitch"in K.dataset&&(Oe(K),K.classList.add("bounce"));break;case"move":const a=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(a,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere());break;case"valueChange":for(const[n,c]of Object.entries(e.afterChange))e.target.dataset[n]=c;"tone"in e.target.dataset&&Oe(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te);break;case"remove":const s=e.removedElem.className;e.removedElem.remove(),r("tones")&&ae.querySelectorAll(`[class*="${s}"]`).forEach(n=>{n.parentElement.remove()}),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere();break;case"clear":fe.querySelector("ul").textContent="",ae.querySelectorAll(".track").forEach((n,c)=>{c?n.remove():(n.textContent="",T.activeTrack=n)}),K=null,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te);break}break}};const kr=()=>{const t=[...fe.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!t.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",t=>{var r;const e=t.ctrlKey||Rt.checked;switch((r=t.key)==null?void 0:r.toLowerCase()){case" ":Me?(t.preventDefault(),Lt()):document.activeElement.tagName.toLowerCase()!=="input"&&(t.preventDefault(),It.click());break;case"s":e&&(t.preventDefault(),!Ve.disabled&&Ve.click());break;case"o":e&&(t.preventDefault(),!dn.disabled&&dn.click());break;case"z":e&&Se.undo();break;case"y":e&&Se.redo();break}});const wt=t=>{const e=re.elements[t];let r=e.valueAsNumber,a=De.findIndex(s=>s===r);e.addEventListener("input",()=>{const s=e.valueAsNumber;s!==r&&(s===0?(a=-1,e.value=""):s>r||Number.isNaN(r)?e.value=De[++a]:s<r&&(e.value=De[--a]),r=e.valueAsNumber)})},ot=async t=>{const{dataset:e}=t,r={tempo:a=>({tempo:a.replace("t","")}),noteValue:a=>({"note-value":(a.match(/[0-9]+/)||[""])[0],dot:(a.match(/\.+/)||[""])[0].length,run:()=>{wt("note-value")}}),rest:a=>({rest:(a.match(/[0-9]+/)||[""])[0],dot:(a.match(/\.+/)||[""])[0].length,run:()=>{wt("rest")}}),octave:a=>({octave:a.startsWith("o")?a.replace("o",""):(a.match(/[><]+/)||[""])[0].length}),velocity:a=>({velocity:a.startsWith("@v")?a.replace("@v",""):Number((a.match(/[0-9]+/)||[""])[0])*(a.startsWith("(")?1:-1)}),noteShift:a=>({"note-shift":(a.match(/[0-9]+/)||[""])[0]}),detune:a=>({detune:a.replace("@d","")}),tieSlur:a=>({"tie-slur":(a.match(/[0-9]+/)||[""])[0],dot:(a.match(/\.+/)||[""])[0].length,run:()=>{wt("tie-slur")}}),repeatStartEnd:a=>({repeat:a.replace("/:","")}),macroDef:a=>({"macro-def-name":(a.match(/\$([^\{\=]*)[\{\=]/)||[,""])[1],"macro-def-arg":(a.match(/\{([^\}]*)\}/)||[,""])[1]}),macroArgUse:a=>({"macro-arg-use":a.replace("%","")}),macroUse:a=>({"macro-use-name":(a.match(/\$([^\{]*)\{?/)||[,""])[1],"macro-use-arg":(a.match(/\{([^\}]*)\}/)||[,""])[1]}),metaData:a=>({run:()=>{const n=a.split(" "),c=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let h=c.findIndex(d=>n[0].startsWith(d));h===-1&&(h=0),re.elements["select-meta-data"].selectedIndex=h;const m=d=>re.elements[d].previousSibling,l=()=>re.elements["select-meta-data"].selectedOptions[0],g=(d,k)=>{m("number").nodeValue=d[0],re.elements.number.value=d[1],re.elements.number.parentElement.style.display=d[2]?"none":"",m("text").nodeValue=k[0],re.elements.text.value=k[1],re.elements.text.parentElement.style.display=k[2]?"none":""},f=d=>{var _,b,E;const k=d===h,D=c[d];switch(D){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const w=k?n.slice(1).join(" ")??"":"";g(["無効","",!0],[l().label,w,!1]);break;case"#OCTAVE":case"#VELOCITY":g(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const A=D==="#WAV9",M=k?((_=n.slice(1).join(" "))==null?void 0:_.split(","))??[]:[];g(["波形番号",M[0]??0,!1],A?["初期変位,ループフラグ,データ",`${M[1]??0},${M[2]??0},${M[3]??""}`,!1]:["データ",M[1]??"",!1]),re.elements.number.min=0,re.elements.number.max=A?15:31;break;case"#OPM":case"#OPN":g(["音色番号",k?((b=n[0])==null?void 0:b.split("@")[1])??0:0,!1],["データ",k?((E=n.slice(1).join(" "))==null?void 0:E.slice(1,-1))??"":"",!1]),re.elements.number.min=0,re.elements.number.max=127;break;case"#FMGAIN":g(["音量利得",k?n[1].replace(`
`,"")??91:91,!1],["無効","",!0]),re.elements.number.min=-127,re.elements.number.max=127;break;case"#USING":g(["和音重ね数",k?n[2].replace(`
`,"")??2:2,!1],["無効","",!0]),re.elements.number.min=1,re.elements.number.max="";break}};f(h),re.elements["select-meta-data"].addEventListener("change",d=>{f(d.target.selectedIndex)})}}),otherAction:a=>({"other-action":a}),remove:()=>({}),step:()=>({})};for(const a of Object.keys(e)){const s=r[a];if(s){let n=e[a];switch(a){case"repeatStartEnd":if(n===":/"){const m=(()=>{var g;let l=t.parentElement;for(;l&&!((g=l.firstElementChild.dataset.repeatStartEnd)!=null&&g.startsWith("/:"));)l=l.previousElementSibling;return(l==null?void 0:l.firstElementChild)||null})();if(m)t=m;else{const l=T.activeTrack,g=document.createElement("li"),d=Ee.querySelector(".repeat-start-end").cloneNode(!0);g.appendChild(d),l.insertBefore(g,t.parentElement),t=d}n=t.dataset.repeatStartEnd}break;case"macroDef":if(n===";")return;break}const c=s(n);await _t.prompt(a,c,t);break}}};We.addEventListener("click",async t=>{const e=t.ctrlKey||Rt.checked,r=s=>!!t.target.closest("#"+s),a=t.target.tagName.toLowerCase()==="button";if(![fe,Ee,ae].some(s=>s.classList.contains("no-op"))){if(r("tones"))if(a)K=t.target,await _t.prompt("tone",{"tone-name":t.target.ariaLabel,"tone-def":t.target.dataset.tone,run:()=>{const s=re.elements["tone-name"];s.insertAdjacentElement("afterend",ns);const n=document.querySelector("emoji-picker");s.addEventListener("focus",()=>{n.classList.add("expaned")},{once:!0}),n.addEventListener("emoji-click",c=>s.value=c.detail.unicode)}},t.target),Te.play(t.target.dataset.tone+t.target.dataset.tonePitch),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te);else{const s=fe.querySelector("ul"),n=document.createElement("li"),h=`<button class="material-icons note ${kr()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;n.innerHTML=h;const m=n.firstElementChild;s.appendChild(n),K=m,Te.play(m.dataset.tone+m.dataset.tonePitch),Se.pushState({operation:"copy",toIndex:-1,newElem:n,parent:s})}else if(r("action")){if(a){if("otherAction"in t.target.dataset)await ot(t.target);else if("step"in t.target.dataset){Er&&!t.shiftKey?Me=!Me:await ot(t.target),Me?(t.target.classList.add("enable"),t.target.ariaLabel="ステップ音価記録(有効)",K=T.activeTrack.querySelector("button")):(t.target.classList.remove("enable"),t.target.ariaLabel="ステップ音価記録(無効)",Sr(),Te.stop(),clearTimeout(fn));return}const s=T.activeTrack,n=document.createElement("li"),c=t.target.cloneNode(!0);if(["metaData","macroDef","macroArgUse","macroUse"].some(h=>h in c.dataset)&&await ot(c),"tieSlur"in c.dataset?c.ariaLabel="スラー":"repeatStartEnd"in c.dataset?(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"):"polyStartEnd"in c.dataset?(c.dataset.polyStartEnd="[",c.textContent="["):"macroDef"in c.dataset?c.textContent="$=":"playFromHere"in c.dataset&&(ae.querySelectorAll(".track button").forEach(h=>{h.classList.add("inactive")}),Le.disabled=Ve.disabled=!0),n.appendChild(c),s.appendChild(n),K=c,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere(),Se.pushState({operation:"copy",toIndex:-1,newElem:n,parent:s}),["repeatStartEnd","polyStartEnd","macroDef"].some(h=>h in K.dataset)){const h=document.createElement("li"),m=t.target.cloneNode(!0);"repeatStartEnd"in K.dataset?(m.ariaLabel="リピート終了",m.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(m.dataset.polyStartEnd="]",m.textContent="]"):"macroDef"in K.dataset&&(m.dataset.macroDef=";",m.textContent=";"),h.appendChild(m),K.parentElement.insertAdjacentElement("afterend",h),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te),Se.pushState({operation:"copy",toIndex:-1,newElem:h,parent:s})}}}else if(r("musical-score")){if(a&&t.target!==$e&&t.target!==ct)t.target.closest(".track")&&(T.activeTrack=t.target.closest(".track")),Me||("tone"in t.target.dataset?(Oe(t.target),Ce(t.target,"bounce"),e&&(await _t.prompt("tonePitch",{"tone-pitch":(t.target.dataset.tonePitch.match(/[0-9]+/)||[""])[0],dot:(t.target.dataset.tonePitch.match(/\.+/)||[""])[0].length,run:()=>{wt("tone-pitch")}},t.target),Oe(t.target))):await ot(t.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te)),K=t.target;else if(t.target.closest(".track")&&(T.activeTrack=t.target.closest(".track")),Me)Lt();else if(K){const s=T.activeTrack,n=document.createElement("li"),c=K.cloneNode(!0);if("repeatStartEnd"in c.dataset&&(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"+(c.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),n.appendChild(c),s.appendChild(n),K=c,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere(),Se.pushState({operation:"copy",toIndex:-1,newElem:n,parent:s}),"tonePitch"in c.dataset)c.dataset.tonePitch=c.dataset.tonePitch.replace(/[><]+/,""),Oe(c),c.classList.add("bounce");else if("repeatStartEnd"in K.dataset){const h=document.createElement("li"),m=K.cloneNode(!0);m.classList.add("material-icons"),m.ariaLabel="リピート終了",m.textContent="repeat",m.dataset.repeatStartEnd=":/",h.appendChild(m),K.parentElement.insertAdjacentElement("afterend",h),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te),Se.pushState({operation:"copy",toIndex:-1,newElem:h,parent:s})}}}}});We.addEventListener("contextmenu",t=>{var s,n,c,h;if(Me)return;const e=m=>m.closest("#tones, #musical-score"),r=m=>!!t.target.closest("#"+m),a=t.target.tagName.toLowerCase()==="button";if(!((s=e(t.target))!=null&&s.classList.contains("no-op"))&&e(t.target)){const m=a&&t.target!==$e&&t.target!==ct?t.target:K;if(!m||e(m)!==e(t.target))return;t.preventDefault(),T.activeTrack=m.closest(".track")||T.activeTrack;const l=m.parentElement,g=m.className,f=((n=m.closest("#tones"))==null?void 0:n.querySelector("ul"))||T.activeTrack,d=[...f.children].indexOf(l);K=((c=l.previousElementSibling)==null?void 0:c.firstElementChild)||((h=l.nextElementSibling)==null?void 0:h.firstElementChild)||null,Se.pushState({operation:"remove",removedElem:l,removedIndex:d,parent:f}),r("tones")?ae.querySelectorAll(`[class*="${g}"]`).forEach(k=>{k.parentElement.remove()}):"macroDef"in m.dataset?ae.querySelectorAll(`[data-macro-use="${m.dataset.macroDef.replace("=","")}"]`).forEach(k=>{k.parentElement.remove()}):"playFromHere"in m.dataset&&(ae.querySelectorAll(".inactive").forEach(k=>{k.classList.remove("inactive")}),Le.disabled=Ve.disabled=!1),l.remove(),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere()}});let kt=null,Sn=!1,Mt=null;We.addEventListener("touchstart",t=>{kt=[...t.touches].at(-1).pageY,Mt=setTimeout(()=>{Sn=!0},500)});const Tr=t=>{if(Me)return;const e=t.ctrlKey||Rt.checked,r=c=>!!t.target.closest("#"+c),a=t.target.tagName.toLowerCase()==="button";if(t.type==="touchmove"){const c=[...t.touches].at(-1).pageY;if(Sn){t.cancelable&&t.preventDefault();return}else if(c-kt<-30)t.deltaY=-1,clearTimeout(Mt);else if(c-kt>30)t.deltaY=1,clearTimeout(Mt);else{t.cancelable&&t.preventDefault();return}kt=c}const s=t.deltaY<0;let n=a?t.target:(K==null?void 0:K.closest("#musical-score"))&&K;if(n){if(r("musical-score")){if(ae.classList.contains("no-op"))return;t.preventDefault();let c=JSON.parse(JSON.stringify(n.dataset));if(!e&&"tone"in n.dataset){const m=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],l={down:">",up:"<"},g=n.dataset.tonePitch,f=m.findIndex(E=>g.match(/[a-g]\+?/)[0]===E),d=(E,w)=>(E.match(new RegExp(w,"g"))||[]).length,k={down:d(g,l.down),up:d(g,l.up)},D=l.down.repeat(k.down)+l.up.repeat(k.up),_=(g.match(/[0-9]+/)||[""])[0],b=(n.dataset.tonePitch.match(/\.+/)||[""])[0];s?f===m.length-1?k.down?n.dataset.tonePitch=D.substring(1)+m.at(0)+_+b:n.dataset.tonePitch=D+l.up+m.at(0)+_+b:n.dataset.tonePitch=D+m[f+1]+_+b:f===0?k.up?n.dataset.tonePitch=D.substring(1)+m.at(-1)+_+b:n.dataset.tonePitch=D+l.down+m.at(-1)+_+b:n.dataset.tonePitch=D+m[f-1]+_+b,Oe(n)}else{const m=s?1:-1,l=(g,f=-1/0,d=1/0)=>g+m<f||g+m>d?0:m;if(e&&"tonePitch"in n.dataset){const g=Number((n.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),f=(n.dataset.tonePitch.match(/\.+/)||[""])[0],d=l(g,0,384),k=De.findIndex(_=>_===g),D=g+d!==0?De[k+d]:"";n.dataset.tonePitch=n.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+D+f,Oe(n)}else if("tempo"in n.dataset){const g=Number(n.dataset.tempo.replace("t","")),f=l(g,0);n.dataset.tempo="t"+(g+f*10)}else if("noteValue"in n.dataset){const g=Number((n.dataset.noteValue.match(/[0-9]+/)||[""])[0]),f=l(g,1,384),d=De.findIndex(k=>k===g);n.dataset.noteValue=n.dataset.noteValue.replace(/[0-9]+/,De[d+f])}else if("rest"in n.dataset){const g=Number((n.dataset.rest.match(/[0-9]+/)||[""])[0]),f=(n.dataset.rest.match(/\.+/)||[""])[0],d=l(g,0,384),k=De.findIndex(_=>_===g),D=g+d!==0?De[k+d]:"";n.dataset.rest="r"+D+f}else if("octave"in n.dataset)if(n.dataset.octave.startsWith("o")){const f=Number(n.dataset.octave.replace("o","")),d=l(f,0,8);n.dataset.octave="o"+(f+d)}else{const f=(n.dataset.octave.match(/<+/)||[""])[0].length-(n.dataset.octave.match(/>+/)||[""])[0].length,d=l(f,-8,8);n.dataset.octave=f+d>0?"<".repeat(f+d):">".repeat(-(f+d))}else if("velocity"in n.dataset)if(n.dataset.velocity.startsWith("@v")){const f=Number(n.dataset.velocity.replace("@v","")),d=l(f,0,127);n.dataset.velocity="@v"+(f+d)}else{const f=Number((n.dataset.velocity.match(/[0-9]+/)||[""])[0])*(n.dataset.velocity.startsWith("(")?1:-1),d=l(f,-127,127);n.dataset.velocity=(f+d>=0?"(":")")+Math.abs(f+d)}else if("noteShift"in n.dataset){const g=Number((n.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),f=m;n.dataset.noteShift=n.dataset.noteShift.match(/@?ns/)[0]+(g+f)}else if("detune"in n.dataset){const g=Number(n.dataset.detune.replace("@d","")),f=m;n.dataset.detune="@d"+(g+f)}else if("tieSlur"in n.dataset){const g=Number((n.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),f=(n.dataset.tieSlur.match(/\.+/)||[""])[0],d=l(g,0,384),k=De.findIndex(_=>_===g),D=g+d!==0?De[k+d]:"";n.dataset.tieSlur="&"+D+f,n.dataset.tieSlur==="&"?n.ariaLabel="スラー":n.ariaLabel="タイ"}else if("repeatStartEnd"in n.dataset){if(n.dataset.repeatStartEnd===":/"){const D=(()=>{var b;let _=n.parentElement;for(;_&&!((b=_.firstElementChild.dataset.repeatStartEnd)!=null&&b.startsWith("/:"));)_=_.previousElementSibling;return(_==null?void 0:_.firstElementChild)||null})();if(D)n=D;else{const _=T.activeTrack,b=document.createElement("li"),w=Ee.querySelector(".repeat-start-end").cloneNode(!0);b.appendChild(w),_.insertBefore(b,n.parentElement),n=w}c=JSON.parse(JSON.stringify(n.dataset))}const g=Number((n.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),f=l(g,-1),d=g+f!==-1?g+f:"";n.dataset.repeatStartEnd="/:"+d}}const h=JSON.parse(JSON.stringify(n.dataset));JSON.stringify(c)!==JSON.stringify(h)&&Se.pushState({operation:"valueChange",target:n,beforeChange:c,afterChange:h}),K=n,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te)}}else return};We.addEventListener("wheel",Tr);We.addEventListener("touchmove",Tr);We.addEventListener("touchend",()=>{clearTimeout(Mt),Sn=!1});let st={};We.addEventListener("dragstart",t=>{st={from:t.target.nodeType===1&&t.target.closest("#tones, #action, #musical-score"),item:t.target},t.dataTransfer.effectAllowed="copyMove"});let Xn=null;[fe,Ee,ae].forEach(t=>{const e=n=>{const c=n.ctrlKey||Rt.checked,{from:h=null}=st,m=n.dataTransfer;switch(h){case fe:switch(t){case fe:n.preventDefault(),c?m.dropEffect="copy":m.dropEffect="move";break;case Ee:break;case ae:n.preventDefault(),m.dropEffect="copy";break}break;case Ee:switch(t){case fe:break;case Ee:break;case ae:n.preventDefault(),m.dropEffect="copy";break}break;case ae:switch(t){case fe:break;case Ee:break;case ae:n.preventDefault(),c?m.dropEffect="copy":m.dropEffect="move";break}break}Xn=m.dropEffect};t.addEventListener("dragover",e);const r=n=>{const{from:c=null}=st,h=n.target.tagName.toLowerCase()==="button",m=()=>n.target.classList.add("droppable");switch(c){case fe:switch(t){case fe:n.preventDefault(),h&&m();break;case Ee:break;case ae:n.preventDefault(),h&&m();break}break;case Ee:switch(t){case fe:break;case Ee:break;case ae:n.preventDefault(),h&&m();break}break;case ae:switch(t){case fe:break;case Ee:break;case ae:n.preventDefault(),h&&m();break}break}};t.addEventListener("dragenter",r);const a=n=>{const{from:c=null}=st,h=n.target.tagName.toLowerCase()==="button",m=()=>n.target.classList.remove("droppable");switch(c){case fe:switch(t){case fe:h&&m();break;case Ee:break;case ae:h&&m();break}break;case Ee:switch(t){case fe:break;case Ee:break;case ae:h&&m();break}break;case ae:switch(t){case fe:break;case Ee:break;case ae:h&&m();break}break}};t.addEventListener("dragleave",a),t.addEventListener("drop",async n=>{var k,D;if(n.preventDefault(),(k=n.dataTransfer.items)!=null&&k.length)return;n.dataTransfer.dropEffect=n.dataTransfer.dropEffect!=="none"?n.dataTransfer.dropEffect:Xn;const{from:c,item:h}=st,m=((D=n.target.closest("#tones"))==null?void 0:D.querySelector("ul"))||n.target.closest(".track")||T.activeTrack,l=[...t.querySelectorAll("button")].indexOf(h),g=[...t.querySelectorAll("button")].indexOf(n.target),f=n.target.tagName.toLowerCase()==="button";let d;switch(n.dataTransfer.dropEffect){case"copy":const _=document.createElement("li"),b=h.cloneNode(!0);if(t===fe){const E=[...h.classList].find(w=>w.includes("note-"));b.classList.replace(E,kr())}else c===Ee&&("tieSlur"in b.dataset?b.ariaLabel="スラー":["metaData","macroDef","macroArgUse","macroUse","otherAction"].some(E=>E in b.dataset)&&await ot(b));"repeatStartEnd"in b.dataset?(b.classList.remove("material-icons"),b.ariaLabel="リピート開始",b.textContent="◆",b.dataset.repeatStartEnd="/:"+(b.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in b.dataset?(b.dataset.polyStartEnd="[",b.textContent="["):"macroDef"in b.dataset&&(b.dataset.macroDef===";"&&(b.dataset.macroDef="$="),b.textContent="$="),_.appendChild(b),d=_;break;case"move":d=h.parentElement;break}if(f&&n.target.id!=="add-track"&&n.target.id!=="remove-track"){const _=n.dataTransfer.dropEffect==="copy"||g<l?"beforebegin":"afterend";n.target.parentElement.insertAdjacentElement(_,d)}else m.appendChild(d);switch(K=d.firstElementChild,t===ae&&(T.activeTrack=m,T.blocksDataUpdate(),n.dataTransfer.dropEffect==="move"&&T.calcPoly(),T.saveBlocksData(),T.exportMml(te),T.calcPlayFromHere(),"tonePitch"in K.dataset&&(K.dataset.tonePitch=K.dataset.tonePitch.replace(/[><]+/,""),Oe(K),K.classList.add("bounce"))),n.dataTransfer.dropEffect){case"copy":Se.pushState({operation:"copy",toIndex:g,newElem:d,parent:m});break;case"move":Se.pushState({operation:"move",fromIndex:l,toIndex:g,elem:d,parent:m});break}if(n.dataTransfer.dropEffect==="copy"&&["repeatStartEnd","polyStartEnd","macroDef"].some(_=>_ in K.dataset)){const _=document.createElement("li"),b=h.cloneNode(!0);"repeatStartEnd"in K.dataset?(b.classList.add("material-icons"),b.ariaLabel="リピート終了",b.textContent="repeat",b.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(b.dataset.polyStartEnd="]",b.textContent="]"):"macroDef"in K.dataset&&(b.dataset.macroDef=";",b.textContent=";"),_.appendChild(b),d.insertAdjacentElement("afterend",_),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te),Se.pushState({operation:"copy",toIndex:g+1,newElem:_,parent:m})}});const s=n=>{[...document.getElementsByClassName("droppable")].forEach(c=>{c.classList.remove("droppable")})};t.addEventListener("dragend",s)});We.addEventListener("animationend",t=>{t.target.classList.remove("bounce"),t.target.classList.remove("pop")});$e.addEventListener("click",t=>{t.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),T.activeTrack=e,ae.insertBefore(e,$e)});ct.addEventListener("click",t=>{t.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),T.activeTrack=r,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te)});ze.addEventListener("pointerdown",t=>{t.target===ze&&ze.addEventListener("pointerup",e=>{e.target===ze&&ze.close()},{once:!0})});ze.addEventListener("close",()=>{switch(_t.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});It.addEventListener("click",()=>{const t=Te.isPlaying();t?(Te.stop(),T.stopRendering(),Te.removeEventListener("compilecomplete",hn),Ct.disabled=!1):(Te.play(te.getMml()),Te.addEventListener("compilecomplete",hn),Ct.disabled=!0),It.innerHTML=t?wr:rs});Ct.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const t=[...ae.children];t.pop(),Se.pushState({operation:"clear",tonesChildren:[...fe.querySelector("ul").children],musicalScoreChildren:t,lastTouchedButton:K}),fe.querySelector("ul").textContent="";const e=fe.querySelector("ul"),r=document.createElement("li"),a='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=a;const s=r.firstElementChild;e.appendChild(r),K=s,ae.querySelectorAll(".track").forEach((n,c)=>{c?n.remove():(n.textContent="",T.activeTrack=n)}),Te.play(""),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(te)}});Le.addEventListener("click",async t=>{const e=t.shiftKey?JSON.stringify(T.getBlocksData()):te.getMml(),r=Le.innerHTML;Le.disabled=!0,navigator.clipboard.writeText(e).then(()=>{Le.disabled=!0,Le.innerHTML=lt("content_copy")+"コピーしました",t.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータをコピーしました。"),setTimeout(()=>{Le.innerHTML=r,Le.disabled=!1},1500)}).catch(a=>alert(`コピーできませんでした
`+a))});Ue.addEventListener("click",()=>{const t=Ue.innerHTML;Ue.disabled=!0,navigator.clipboard.readText().then(e=>{Ue.disabled=!0,e?(un(e)?T.setBlocksData(JSON.parse(e)):(te.setMml(e.replace(/\r/g,"")),T.importMml(te)),Ue.innerHTML=lt("content_paste")+"貼り付けました",un(e)&&alert("JSONブロックデータが貼り付けられました。")):Ue.innerHTML=lt("content_paste")+"内容がありません",setTimeout(()=>{Ue.innerHTML=t,Ue.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});Ve.addEventListener("click",t=>{var c;const r=((c=te.getMmlArr().find(h=>h.startsWith("#TITLE")))==null?void 0:c.split(" ").slice(1).join(" "))??"無題",a=t.shiftKey?JSON.stringify(T.getBlocksData()):te.getMml(),s=new Blob([a],{type:t.shiftKey?"application/json":"text/plain"}),n=document.createElement("a");n.download=r+(t.shiftKey?".json":".mml"),n.href=URL.createObjectURL(s),n.click(),URL.revokeObjectURL(n.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。"),t.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータを保存しました。")});dn.addEventListener("click",()=>{const t=document.createElement("input"),e=new FileReader;t.type="file",t.accept=".mml,.flmml,.txt,.json",t.click(),t.onchange=()=>{e.onload=()=>{const r=e.result;un(r)?(T.setBlocksData(JSON.parse(r)),alert("JSONブロックデータが読み込まれました。")):(te.setMml(r.replace(/\r/g,"")),T.importMml(te))},e.readAsText(t.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");Se.onPushstate=t=>{At.disabled=!1,Dt.disabled=!0};At.addEventListener("click",()=>{const{canUndo:t,canRedo:e}=Se.undo();At.disabled=!t,Dt.disabled=!e});Dt.addEventListener("click",()=>{const{canUndo:t,canRedo:e}=Se.redo();At.disabled=!t,Dt.disabled=!e});
