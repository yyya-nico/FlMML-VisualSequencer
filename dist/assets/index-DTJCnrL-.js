var Gn=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var A=(n,e,r)=>(Gn(n,e,"read from private field"),r?r.call(n):e.get(n)),fe=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},ke=(n,e,r,a)=>(Gn(n,e,"write to private field"),a?a.call(n,r):e.set(n,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const c of t.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function r(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(o){if(o.ep)return;o.ep=!0;const t=r(o);fetch(o.href,t)}})();const ya="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var ct=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ba(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var or={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(r,a){n.exports=a()})(self,function(){return(()=>{var r={587:(t,c,m)=>{var h;(h=(function(d,E){Object.defineProperty(E,"__esModule",{value:!0}),E.MsgTypes=E.SAMPLE_RATE=void 0,E.SAMPLE_RATE=44100,E.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(c,[m,c]))===void 0||(t.exports=h)},581:(t,c,m)=>{var h;(h=(function(d,E){Object.defineProperty(E,"__esModule",{value:!0}),E.FlMMLAudioExportError=void 0;class f extends Error{constructor(...w){super(...w),this.name="FlMMLAudioExportError"}}E.FlMMLAudioExportError=f}).apply(c,[m,c]))===void 0||(t.exports=h)},643:function(t,c,m){var h,d,E=this&&this.__awaiter||function(f,g,w,C){return new(w||(w=Promise))(function(M,l){function y(R){try{D(C.next(R))}catch(S){l(S)}}function _(R){try{D(C.throw(R))}catch(S){l(S)}}function D(R){var S;R.done?M(R.value):(S=R.value,S instanceof w?S:new w(function($){$(S)})).then(y,_)}D((C=C.apply(f,g||[])).next())})};h=[m,c,m(587),m(581),m(158)],(d=(function(f,g,w,C,M){Object.defineProperty(g,"__esModule",{value:!0}),g.FlMMLonHTML5=g.FlMMLAudioExportError=g.FlMML=void 0,Object.defineProperty(g,"FlMMLAudioExportError",{enumerable:!0,get:function(){return C.FlMMLAudioExportError}});const l="flmml-on-html5.worker.js";class y{constructor(D=l){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof D=="string"&&(D={workerURL:D});const R=D.workerURL||l,S=D.infoInterval>=0?D.infoInterval:125;this.bufferSize=D.bufferSize>=128?Math.floor(D.bufferSize-D.bufferSize%128):8192,this.bufferMultiple=D.bufferMultiple>=1?Math.floor(D.bufferMultiple):32,this.lamejsURL=D.lamejsURL,(this.worker=new Worker(D.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${R}")`],{type:"application/javascript"})):R)).addEventListener("message",$=>{this.onMessage($)}),this.setInfoInterval(S)}static initWebAudio(){const D=y.audioCtx=new AudioContext({sampleRate:w.SAMPLE_RATE}),R=D.createBufferSource();R.connect(D.destination),R.start(0),D.resume(),R.stop()}static hookInitWebAudio(D){const R=document.querySelectorAll(D);R.forEach(S=>{S.addEventListener("click",function $(){y.audioCtx||y.initWebAudio(),R.forEach(V=>{V.removeEventListener("click",$,!0)})},!0)})}static prepare(D){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{y.hookInitWebAudio(D)}):y.hookInitWebAudio(D)}onMessage(D){const R=D.data;switch(R.type){case w.MsgTypes.COMPCOMP:this.totalMSec=R.info.totalMSec,this.totalTimeStr=R.info.totalTimeStr,this.warnings=R.info.warnings,this.metaTitle=R.info.metaTitle,this.metaComment=R.info.metaComment,this.metaArtist=R.info.metaArtist,this.metaCoding=R.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case w.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(R),this.trigger("buffering",{progress:R.progress});break;case w.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case w.MsgTypes.SYNCINFO:this._isPlaying=R.info._isPlaying,this._isPaused=R.info._isPaused,this.nowMSec=R.info.nowMSec,this.nowTimeStr=R.info.nowTimeStr,this.voiceCount=R.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case w.MsgTypes.PLAYSOUND:this.playSound();break;case w.MsgTypes.STOPSOUND:this.stopSound();break;case w.MsgTypes.EXPORT:R.data?this.completeAudioExport(R.data):this.errorAudioExport(R.errorMsg)}}boot(){this.worker.postMessage({type:w.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const D=y.audioCtx,R=this.gainNode=D.createGain();R.gain.value=this.volume/127,R.connect(D.destination),E(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise($=>{const V=new FileReader;V.onload=K=>{D.audioWorklet.addModule(K.target.result).then($)},V.readAsDataURL(new Blob([M.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const S=this.workletNode=new AudioWorkletNode(D,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});S.connect(R),this.worker.postMessage({type:w.MsgTypes.PLAYSOUND,workletPort:S.port},[S.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:w.MsgTypes.STOPSOUND})}trigger(D,R){const S=this.events[D];if(!S)return;const $={};for(let V in R)$[V]=R[V];for(let V=0,K=S.length;V<K;V++)S[V]&&S[V].call(this,$)}exportAudio(D,R,S={}){return y.audioCtx||y.initWebAudio(),this.booted||this.boot(),new Promise(($,V)=>{this.audioExportResolve?V(new C.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:w.MsgTypes.EXPORT,mml:D,format:R},S)),this.audioExportResolve=$,this.audioExportReject=V)})}completeAudioExport(D){this.audioExportResolve&&(this.audioExportResolve(D),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(D){this.audioExportReject&&(this.audioExportReject(new C.FlMMLAudioExportError(D)),this.audioExportResolve=null,this.audioExportReject=null)}play(D){y.audioCtx||y.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:w.MsgTypes.PLAY,mml:D})}stop(){this.worker.postMessage({type:w.MsgTypes.STOP})}pause(){this.worker.postMessage({type:w.MsgTypes.PAUSE})}exportWav(D){return this.exportAudio(D,"wav")}exportMp3(D,R){return this.exportAudio(D,"mp3",{bitrate:R})}setMasterVolume(D){this.volume=D,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(D){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:D})}syncInfo(){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:null})}addEventListener(D,R){let S=this.events[D];S||(S=this.events[D]=[]);for(let $=S.length;$--;)if(S[$]===R)return!1;return S.push(R),!0}removeEventListener(D,R){const S=this.events[D];if(!S)return!1;for(let $=S.length;$--;)if(S[$]===R)return S.splice($,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}g.FlMML=y,g.FlMMLonHTML5=y}).apply(c,h))===void 0||(t.exports=d)},158:(t,c,m)=>{m.r(c),m.d(c,{FlMMLWorkletScript:()=>h});const h='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},a={};function o(t){var c=a[t];if(c!==void 0)return c.exports;var m=a[t]={exports:{}};return r[t].call(m.exports,m,m.exports,o),m.exports}return o.d=(t,c)=>{for(var m in c)o.o(c,m)&&!o.o(t,m)&&Object.defineProperty(t,m,{enumerable:!0,get:c[m]})},o.o=(t,c)=>Object.prototype.hasOwnProperty.call(t,c),o.r=t=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o(643)})()})})(or);var ir=or.exports;function yt(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var sr={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(r){n.exports=r()})(function(){return function r(a,o,t){function c(d,E){if(!o[d]){if(!a[d]){var f=typeof yt=="function"&&yt;if(!E&&f)return f(d,!0);if(m)return m(d,!0);var g=new Error("Cannot find module '"+d+"'");throw g.code="MODULE_NOT_FOUND",g}var w=o[d]={exports:{}};a[d][0].call(w.exports,function(C){var M=a[d][1][C];return c(M||C)},w,w.exports,r,a,o,t)}return o[d].exports}for(var m=typeof yt=="function"&&yt,h=0;h<t.length;h++)c(t[h]);return c}({1:[function(r,a,o){(function(t){var c=t.MutationObserver||t.WebKitMutationObserver,m;if(c){var h=0,d=new c(C),E=t.document.createTextNode("");d.observe(E,{characterData:!0}),m=function(){E.data=h=++h%2}}else if(!t.setImmediate&&typeof t.MessageChannel<"u"){var f=new t.MessageChannel;f.port1.onmessage=C,m=function(){f.port2.postMessage(0)}}else"document"in t&&"onreadystatechange"in t.document.createElement("script")?m=function(){var l=t.document.createElement("script");l.onreadystatechange=function(){C(),l.onreadystatechange=null,l.parentNode.removeChild(l),l=null},t.document.documentElement.appendChild(l)}:m=function(){setTimeout(C,0)};var g,w=[];function C(){g=!0;for(var l,y,_=w.length;_;){for(y=w,w=[],l=-1;++l<_;)y[l]();_=w.length}g=!1}a.exports=M;function M(l){w.push(l)===1&&!g&&m()}}).call(this,typeof ct<"u"?ct:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,a,o){var t=r(1);function c(){}var m={},h=["REJECTED"],d=["FULFILLED"],E=["PENDING"];a.exports=f;function f(S){if(typeof S!="function")throw new TypeError("resolver must be a function");this.state=E,this.queue=[],this.outcome=void 0,S!==c&&M(this,S)}f.prototype.catch=function(S){return this.then(null,S)},f.prototype.then=function(S,$){if(typeof S!="function"&&this.state===d||typeof $!="function"&&this.state===h)return this;var V=new this.constructor(c);if(this.state!==E){var K=this.state===d?S:$;w(V,K,this.outcome)}else this.queue.push(new g(V,S,$));return V};function g(S,$,V){this.promise=S,typeof $=="function"&&(this.onFulfilled=$,this.callFulfilled=this.otherCallFulfilled),typeof V=="function"&&(this.onRejected=V,this.callRejected=this.otherCallRejected)}g.prototype.callFulfilled=function(S){m.resolve(this.promise,S)},g.prototype.otherCallFulfilled=function(S){w(this.promise,this.onFulfilled,S)},g.prototype.callRejected=function(S){m.reject(this.promise,S)},g.prototype.otherCallRejected=function(S){w(this.promise,this.onRejected,S)};function w(S,$,V){t(function(){var K;try{K=$(V)}catch(se){return m.reject(S,se)}K===S?m.reject(S,new TypeError("Cannot resolve promise with itself")):m.resolve(S,K)})}m.resolve=function(S,$){var V=l(C,$);if(V.status==="error")return m.reject(S,V.value);var K=V.value;if(K)M(S,K);else{S.state=d,S.outcome=$;for(var se=-1,ae=S.queue.length;++se<ae;)S.queue[se].callFulfilled($)}return S},m.reject=function(S,$){S.state=h,S.outcome=$;for(var V=-1,K=S.queue.length;++V<K;)S.queue[V].callRejected($);return S};function C(S){var $=S&&S.then;if(S&&(typeof S=="object"||typeof S=="function")&&typeof $=="function")return function(){$.apply(S,arguments)}}function M(S,$){var V=!1;function K(ge){V||(V=!0,m.reject(S,ge))}function se(ge){V||(V=!0,m.resolve(S,ge))}function ae(){$(se,K)}var he=l(ae);he.status==="error"&&K(he.value)}function l(S,$){var V={};try{V.value=S($),V.status="success"}catch(K){V.status="error",V.value=K}return V}f.resolve=y;function y(S){return S instanceof this?S:m.resolve(new this(c),S)}f.reject=_;function _(S){var $=new this(c);return m.reject($,S)}f.all=D;function D(S){var $=this;if(Object.prototype.toString.call(S)!=="[object Array]")return this.reject(new TypeError("must be an array"));var V=S.length,K=!1;if(!V)return this.resolve([]);for(var se=new Array(V),ae=0,he=-1,ge=new this(c);++he<V;)de(S[he],he);return ge;function de(N,k){$.resolve(N).then(U,function(q){K||(K=!0,m.reject(ge,q))});function U(q){se[k]=q,++ae===V&&!K&&(K=!0,m.resolve(ge,se))}}}f.race=R;function R(S){var $=this;if(Object.prototype.toString.call(S)!=="[object Array]")return this.reject(new TypeError("must be an array"));var V=S.length,K=!1;if(!V)return this.resolve([]);for(var se=-1,ae=new this(c);++se<V;)he(S[se]);return ae;function he(ge){$.resolve(ge).then(function(de){K||(K=!0,m.resolve(ae,de))},function(de){K||(K=!0,m.reject(ae,de))})}}},{1:1}],3:[function(r,a,o){(function(t){typeof t.Promise!="function"&&(t.Promise=r(2))}).call(this,typeof ct<"u"?ct:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,a,o){var t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i};function c(i,u){if(!(i instanceof u))throw new TypeError("Cannot call a class as a function")}function m(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var h=m();function d(){try{if(!h||!h.open)return!1;var i=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),u=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!i||u)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function E(i,u){i=i||[],u=u||{};try{return new Blob(i,u)}catch(p){if(p.name!=="TypeError")throw p;for(var s=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,v=new s,b=0;b<i.length;b+=1)v.append(i[b]);return v.getBlob(u.type)}}typeof Promise>"u"&&r(3);var f=Promise;function g(i,u){u&&i.then(function(s){u(null,s)},function(s){u(s)})}function w(i,u,s){typeof u=="function"&&i.then(u),typeof s=="function"&&i.catch(s)}function C(i){return typeof i!="string"&&(console.warn(i+" used as a key, but it is not a string."),i=String(i)),i}function M(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var l="local-forage-detect-blob-support",y=void 0,_={},D=Object.prototype.toString,R="readonly",S="readwrite";function $(i){for(var u=i.length,s=new ArrayBuffer(u),v=new Uint8Array(s),b=0;b<u;b++)v[b]=i.charCodeAt(b);return s}function V(i){return new f(function(u){var s=i.transaction(l,S),v=E([""]);s.objectStore(l).put(v,"key"),s.onabort=function(b){b.preventDefault(),b.stopPropagation(),u(!1)},s.oncomplete=function(){var b=navigator.userAgent.match(/Chrome\/(\d+)/),p=navigator.userAgent.match(/Edge\//);u(p||!b||parseInt(b[1],10)>=43)}}).catch(function(){return!1})}function K(i){return typeof y=="boolean"?f.resolve(y):V(i).then(function(u){return y=u,y})}function se(i){var u=_[i.name],s={};s.promise=new f(function(v,b){s.resolve=v,s.reject=b}),u.deferredOperations.push(s),u.dbReady?u.dbReady=u.dbReady.then(function(){return s.promise}):u.dbReady=s.promise}function ae(i){var u=_[i.name],s=u.deferredOperations.pop();if(s)return s.resolve(),s.promise}function he(i,u){var s=_[i.name],v=s.deferredOperations.pop();if(v)return v.reject(u),v.promise}function ge(i,u){return new f(function(s,v){if(_[i.name]=_[i.name]||J(),i.db)if(u)se(i),i.db.close();else return s(i.db);var b=[i.name];u&&b.push(i.version);var p=h.open.apply(h,b);u&&(p.onupgradeneeded=function(I){var L=p.result;try{L.createObjectStore(i.storeName),I.oldVersion<=1&&L.createObjectStore(l)}catch(O){if(O.name==="ConstraintError")console.warn('The database "'+i.name+'" has been upgraded from version '+I.oldVersion+" to version "+I.newVersion+', but the storage "'+i.storeName+'" already exists.');else throw O}}),p.onerror=function(I){I.preventDefault(),v(p.error)},p.onsuccess=function(){var I=p.result;I.onversionchange=function(L){L.target.close()},s(I),ae(i)}})}function de(i){return ge(i,!1)}function N(i){return ge(i,!0)}function k(i,u){if(!i.db)return!0;var s=!i.db.objectStoreNames.contains(i.storeName),v=i.version<i.db.version,b=i.version>i.db.version;if(v&&(i.version!==u&&console.warn('The database "'+i.name+`" can't be downgraded from version `+i.db.version+" to version "+i.version+"."),i.version=i.db.version),b||s){if(s){var p=i.db.version+1;p>i.version&&(i.version=p)}return!0}return!1}function U(i){return new f(function(u,s){var v=new FileReader;v.onerror=s,v.onloadend=function(b){var p=btoa(b.target.result||"");u({__local_forage_encoded_blob:!0,data:p,type:i.type})},v.readAsBinaryString(i)})}function q(i){var u=$(atob(i.data));return E([u],{type:i.type})}function W(i){return i&&i.__local_forage_encoded_blob}function X(i){var u=this,s=u._initReady().then(function(){var v=_[u._dbInfo.name];if(v&&v.dbReady)return v.dbReady});return w(s,i,i),s}function j(i){se(i);for(var u=_[i.name],s=u.forages,v=0;v<s.length;v++){var b=s[v];b._dbInfo.db&&(b._dbInfo.db.close(),b._dbInfo.db=null)}return i.db=null,de(i).then(function(p){return i.db=p,k(i)?N(i):p}).then(function(p){i.db=u.db=p;for(var I=0;I<s.length;I++)s[I]._dbInfo.db=p}).catch(function(p){throw he(i,p),p})}function Q(i,u,s,v){v===void 0&&(v=1);try{var b=i.db.transaction(i.storeName,u);s(null,b)}catch(p){if(v>0&&(!i.db||p.name==="InvalidStateError"||p.name==="NotFoundError"))return f.resolve().then(function(){if(!i.db||p.name==="NotFoundError"&&!i.db.objectStoreNames.contains(i.storeName)&&i.version<=i.db.version)return i.db&&(i.version=i.db.version+1),N(i)}).then(function(){return j(i).then(function(){Q(i,u,s,v-1)})}).catch(s);s(p)}}function J(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function ce(i){var u=this,s={db:null};if(i)for(var v in i)s[v]=i[v];var b=_[s.name];b||(b=J(),_[s.name]=b),b.forages.push(u),u._initReady||(u._initReady=u.ready,u.ready=X);var p=[];function I(){return f.resolve()}for(var L=0;L<b.forages.length;L++){var O=b.forages[L];O!==u&&p.push(O._initReady().catch(I))}var P=b.forages.slice(0);return f.all(p).then(function(){return s.db=b.db,de(s)}).then(function(F){return s.db=F,k(s,u._defaultConfig.version)?N(s):F}).then(function(F){s.db=b.db=F,u._dbInfo=s;for(var z=0;z<P.length;z++){var te=P[z];te!==u&&(te._dbInfo.db=s.db,te._dbInfo.version=s.version)}})}function Te(i,u){var s=this;i=C(i);var v=new f(function(b,p){s.ready().then(function(){Q(s._dbInfo,R,function(I,L){if(I)return p(I);try{var O=L.objectStore(s._dbInfo.storeName),P=O.get(i);P.onsuccess=function(){var F=P.result;F===void 0&&(F=null),W(F)&&(F=q(F)),b(F)},P.onerror=function(){p(P.error)}}catch(F){p(F)}})}).catch(p)});return g(v,u),v}function Ne(i,u){var s=this,v=new f(function(b,p){s.ready().then(function(){Q(s._dbInfo,R,function(I,L){if(I)return p(I);try{var O=L.objectStore(s._dbInfo.storeName),P=O.openCursor(),F=1;P.onsuccess=function(){var z=P.result;if(z){var te=z.value;W(te)&&(te=q(te));var oe=i(te,z.key,F++);oe!==void 0?b(oe):z.continue()}else b()},P.onerror=function(){p(P.error)}}catch(z){p(z)}})}).catch(p)});return g(v,u),v}function x(i,u,s){var v=this;i=C(i);var b=new f(function(p,I){var L;v.ready().then(function(){return L=v._dbInfo,D.call(u)==="[object Blob]"?K(L.db).then(function(O){return O?u:U(u)}):u}).then(function(O){Q(v._dbInfo,S,function(P,F){if(P)return I(P);try{var z=F.objectStore(v._dbInfo.storeName);O===null&&(O=void 0);var te=z.put(O,i);F.oncomplete=function(){O===void 0&&(O=null),p(O)},F.onabort=F.onerror=function(){var oe=te.error?te.error:te.transaction.error;I(oe)}}catch(oe){I(oe)}})}).catch(I)});return g(b,s),b}function B(i,u){var s=this;i=C(i);var v=new f(function(b,p){s.ready().then(function(){Q(s._dbInfo,S,function(I,L){if(I)return p(I);try{var O=L.objectStore(s._dbInfo.storeName),P=O.delete(i);L.oncomplete=function(){b()},L.onerror=function(){p(P.error)},L.onabort=function(){var F=P.error?P.error:P.transaction.error;p(F)}}catch(F){p(F)}})}).catch(p)});return g(v,u),v}function H(i){var u=this,s=new f(function(v,b){u.ready().then(function(){Q(u._dbInfo,S,function(p,I){if(p)return b(p);try{var L=I.objectStore(u._dbInfo.storeName),O=L.clear();I.oncomplete=function(){v()},I.onabort=I.onerror=function(){var P=O.error?O.error:O.transaction.error;b(P)}}catch(P){b(P)}})}).catch(b)});return g(s,i),s}function Y(i){var u=this,s=new f(function(v,b){u.ready().then(function(){Q(u._dbInfo,R,function(p,I){if(p)return b(p);try{var L=I.objectStore(u._dbInfo.storeName),O=L.count();O.onsuccess=function(){v(O.result)},O.onerror=function(){b(O.error)}}catch(P){b(P)}})}).catch(b)});return g(s,i),s}function ee(i,u){var s=this,v=new f(function(b,p){if(i<0){b(null);return}s.ready().then(function(){Q(s._dbInfo,R,function(I,L){if(I)return p(I);try{var O=L.objectStore(s._dbInfo.storeName),P=!1,F=O.openKeyCursor();F.onsuccess=function(){var z=F.result;if(!z){b(null);return}i===0||P?b(z.key):(P=!0,z.advance(i))},F.onerror=function(){p(F.error)}}catch(z){p(z)}})}).catch(p)});return g(v,u),v}function ne(i){var u=this,s=new f(function(v,b){u.ready().then(function(){Q(u._dbInfo,R,function(p,I){if(p)return b(p);try{var L=I.objectStore(u._dbInfo.storeName),O=L.openKeyCursor(),P=[];O.onsuccess=function(){var F=O.result;if(!F){v(P);return}P.push(F.key),F.continue()},O.onerror=function(){b(O.error)}}catch(F){b(F)}})}).catch(b)});return g(s,i),s}function we(i,u){u=M.apply(this,arguments);var s=this.config();i=typeof i!="function"&&i||{},i.name||(i.name=i.name||s.name,i.storeName=i.storeName||s.storeName);var v=this,b;if(!i.name)b=f.reject("Invalid arguments");else{var p=i.name===s.name&&v._dbInfo.db,I=p?f.resolve(v._dbInfo.db):de(i).then(function(L){var O=_[i.name],P=O.forages;O.db=L;for(var F=0;F<P.length;F++)P[F]._dbInfo.db=L;return L});i.storeName?b=I.then(function(L){if(L.objectStoreNames.contains(i.storeName)){var O=L.version+1;se(i);var P=_[i.name],F=P.forages;L.close();for(var z=0;z<F.length;z++){var te=F[z];te._dbInfo.db=null,te._dbInfo.version=O}var oe=new f(function(ie,ye){var pe=h.open(i.name,O);pe.onerror=function(Ie){var it=pe.result;it.close(),ye(Ie)},pe.onupgradeneeded=function(){var Ie=pe.result;Ie.deleteObjectStore(i.storeName)},pe.onsuccess=function(){var Ie=pe.result;Ie.close(),ie(Ie)}});return oe.then(function(ie){P.db=ie;for(var ye=0;ye<F.length;ye++){var pe=F[ye];pe._dbInfo.db=ie,ae(pe._dbInfo)}}).catch(function(ie){throw(he(i,ie)||f.resolve()).catch(function(){}),ie})}}):b=I.then(function(L){se(i);var O=_[i.name],P=O.forages;L.close();for(var F=0;F<P.length;F++){var z=P[F];z._dbInfo.db=null}var te=new f(function(oe,ie){var ye=h.deleteDatabase(i.name);ye.onerror=function(){var pe=ye.result;pe&&pe.close(),ie(ye.error)},ye.onblocked=function(){console.warn('dropInstance blocked for database "'+i.name+'" until all open connections are closed')},ye.onsuccess=function(){var pe=ye.result;pe&&pe.close(),oe(pe)}});return te.then(function(oe){O.db=oe;for(var ie=0;ie<P.length;ie++){var ye=P[ie];ae(ye._dbInfo)}}).catch(function(oe){throw(he(i,oe)||f.resolve()).catch(function(){}),oe})})}return g(b,u),b}var Ke={_driver:"asyncStorage",_initStorage:ce,_support:d(),iterate:Ne,getItem:Te,setItem:x,removeItem:B,clear:H,length:Y,key:ee,keys:ne,dropInstance:we};function _r(){return typeof openDatabase=="function"}var Re="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Mr="~~local_forage_type~",Dn=/^~~local_forage_type~([^~]+)~/,vt="__lfsc__:",qt=vt.length,Yt="arbf",Gt="blob",An="si08",Ln="ui08",_n="uic8",Mn="si16",On="si32",Pn="ur16",jn="ui32",Bn="fl32",Rn="fl64",Fn=qt+Yt.length,$n=Object.prototype.toString;function Un(i){var u=i.length*.75,s=i.length,v,b=0,p,I,L,O;i[i.length-1]==="="&&(u--,i[i.length-2]==="="&&u--);var P=new ArrayBuffer(u),F=new Uint8Array(P);for(v=0;v<s;v+=4)p=Re.indexOf(i[v]),I=Re.indexOf(i[v+1]),L=Re.indexOf(i[v+2]),O=Re.indexOf(i[v+3]),F[b++]=p<<2|I>>4,F[b++]=(I&15)<<4|L>>2,F[b++]=(L&3)<<6|O&63;return P}function Kt(i){var u=new Uint8Array(i),s="",v;for(v=0;v<u.length;v+=3)s+=Re[u[v]>>2],s+=Re[(u[v]&3)<<4|u[v+1]>>4],s+=Re[(u[v+1]&15)<<2|u[v+2]>>6],s+=Re[u[v+2]&63];return u.length%3===2?s=s.substring(0,s.length-1)+"=":u.length%3===1&&(s=s.substring(0,s.length-2)+"=="),s}function Or(i,u){var s="";if(i&&(s=$n.call(i)),i&&(s==="[object ArrayBuffer]"||i.buffer&&$n.call(i.buffer)==="[object ArrayBuffer]")){var v,b=vt;i instanceof ArrayBuffer?(v=i,b+=Yt):(v=i.buffer,s==="[object Int8Array]"?b+=An:s==="[object Uint8Array]"?b+=Ln:s==="[object Uint8ClampedArray]"?b+=_n:s==="[object Int16Array]"?b+=Mn:s==="[object Uint16Array]"?b+=Pn:s==="[object Int32Array]"?b+=On:s==="[object Uint32Array]"?b+=jn:s==="[object Float32Array]"?b+=Bn:s==="[object Float64Array]"?b+=Rn:u(new Error("Failed to get type for BinaryArray"))),u(b+Kt(v))}else if(s==="[object Blob]"){var p=new FileReader;p.onload=function(){var I=Mr+i.type+"~"+Kt(this.result);u(vt+Gt+I)},p.readAsArrayBuffer(i)}else try{u(JSON.stringify(i))}catch(I){console.error("Couldn't convert value into a JSON string: ",i),u(null,I)}}function Pr(i){if(i.substring(0,qt)!==vt)return JSON.parse(i);var u=i.substring(Fn),s=i.substring(qt,Fn),v;if(s===Gt&&Dn.test(u)){var b=u.match(Dn);v=b[1],u=u.substring(b[0].length)}var p=Un(u);switch(s){case Yt:return p;case Gt:return E([p],{type:v});case An:return new Int8Array(p);case Ln:return new Uint8Array(p);case _n:return new Uint8ClampedArray(p);case Mn:return new Int16Array(p);case Pn:return new Uint16Array(p);case On:return new Int32Array(p);case jn:return new Uint32Array(p);case Bn:return new Float32Array(p);case Rn:return new Float64Array(p);default:throw new Error("Unkown type: "+s)}}var Jt={serialize:Or,deserialize:Pr,stringToBuffer:Un,bufferToString:Kt};function Vn(i,u,s,v){i.executeSql("CREATE TABLE IF NOT EXISTS "+u.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],s,v)}function jr(i){var u=this,s={db:null};if(i)for(var v in i)s[v]=typeof i[v]!="string"?i[v].toString():i[v];var b=new f(function(p,I){try{s.db=openDatabase(s.name,String(s.version),s.description,s.size)}catch(L){return I(L)}s.db.transaction(function(L){Vn(L,s,function(){u._dbInfo=s,p()},function(O,P){I(P)})},I)});return s.serializer=Jt,b}function Fe(i,u,s,v,b,p){i.executeSql(s,v,b,function(I,L){L.code===L.SYNTAX_ERR?I.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[u.storeName],function(O,P){P.rows.length?p(O,L):Vn(O,u,function(){O.executeSql(s,v,b,p)},p)},p):p(I,L)},p)}function Br(i,u){var s=this;i=C(i);var v=new f(function(b,p){s.ready().then(function(){var I=s._dbInfo;I.db.transaction(function(L){Fe(L,I,"SELECT * FROM "+I.storeName+" WHERE key = ? LIMIT 1",[i],function(O,P){var F=P.rows.length?P.rows.item(0).value:null;F&&(F=I.serializer.deserialize(F)),b(F)},function(O,P){p(P)})})}).catch(p)});return g(v,u),v}function Rr(i,u){var s=this,v=new f(function(b,p){s.ready().then(function(){var I=s._dbInfo;I.db.transaction(function(L){Fe(L,I,"SELECT * FROM "+I.storeName,[],function(O,P){for(var F=P.rows,z=F.length,te=0;te<z;te++){var oe=F.item(te),ie=oe.value;if(ie&&(ie=I.serializer.deserialize(ie)),ie=i(ie,oe.key,te+1),ie!==void 0){b(ie);return}}b()},function(O,P){p(P)})})}).catch(p)});return g(v,u),v}function Wn(i,u,s,v){var b=this;i=C(i);var p=new f(function(I,L){b.ready().then(function(){u===void 0&&(u=null);var O=u,P=b._dbInfo;P.serializer.serialize(u,function(F,z){z?L(z):P.db.transaction(function(te){Fe(te,P,"INSERT OR REPLACE INTO "+P.storeName+" (key, value) VALUES (?, ?)",[i,F],function(){I(O)},function(oe,ie){L(ie)})},function(te){if(te.code===te.QUOTA_ERR){if(v>0){I(Wn.apply(b,[i,O,s,v-1]));return}L(te)}})})}).catch(L)});return g(p,s),p}function Fr(i,u,s){return Wn.apply(this,[i,u,s,1])}function $r(i,u){var s=this;i=C(i);var v=new f(function(b,p){s.ready().then(function(){var I=s._dbInfo;I.db.transaction(function(L){Fe(L,I,"DELETE FROM "+I.storeName+" WHERE key = ?",[i],function(){b()},function(O,P){p(P)})})}).catch(p)});return g(v,u),v}function Ur(i){var u=this,s=new f(function(v,b){u.ready().then(function(){var p=u._dbInfo;p.db.transaction(function(I){Fe(I,p,"DELETE FROM "+p.storeName,[],function(){v()},function(L,O){b(O)})})}).catch(b)});return g(s,i),s}function Vr(i){var u=this,s=new f(function(v,b){u.ready().then(function(){var p=u._dbInfo;p.db.transaction(function(I){Fe(I,p,"SELECT COUNT(key) as c FROM "+p.storeName,[],function(L,O){var P=O.rows.item(0).c;v(P)},function(L,O){b(O)})})}).catch(b)});return g(s,i),s}function Wr(i,u){var s=this,v=new f(function(b,p){s.ready().then(function(){var I=s._dbInfo;I.db.transaction(function(L){Fe(L,I,"SELECT key FROM "+I.storeName+" WHERE id = ? LIMIT 1",[i+1],function(O,P){var F=P.rows.length?P.rows.item(0).key:null;b(F)},function(O,P){p(P)})})}).catch(p)});return g(v,u),v}function zr(i){var u=this,s=new f(function(v,b){u.ready().then(function(){var p=u._dbInfo;p.db.transaction(function(I){Fe(I,p,"SELECT key FROM "+p.storeName,[],function(L,O){for(var P=[],F=0;F<O.rows.length;F++)P.push(O.rows.item(F).key);v(P)},function(L,O){b(O)})})}).catch(b)});return g(s,i),s}function Hr(i){return new f(function(u,s){i.transaction(function(v){v.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(b,p){for(var I=[],L=0;L<p.rows.length;L++)I.push(p.rows.item(L).name);u({db:i,storeNames:I})},function(b,p){s(p)})},function(v){s(v)})})}function qr(i,u){u=M.apply(this,arguments);var s=this.config();i=typeof i!="function"&&i||{},i.name||(i.name=i.name||s.name,i.storeName=i.storeName||s.storeName);var v=this,b;return i.name?b=new f(function(p){var I;i.name===s.name?I=v._dbInfo.db:I=openDatabase(i.name,"","",0),i.storeName?p({db:I,storeNames:[i.storeName]}):p(Hr(I))}).then(function(p){return new f(function(I,L){p.db.transaction(function(O){function P(oe){return new f(function(ie,ye){O.executeSql("DROP TABLE IF EXISTS "+oe,[],function(){ie()},function(pe,Ie){ye(Ie)})})}for(var F=[],z=0,te=p.storeNames.length;z<te;z++)F.push(P(p.storeNames[z]));f.all(F).then(function(){I()}).catch(function(oe){L(oe)})},function(O){L(O)})})}):b=f.reject("Invalid arguments"),g(b,u),b}var Yr={_driver:"webSQLStorage",_initStorage:jr,_support:_r(),iterate:Rr,getItem:Br,setItem:Fr,removeItem:$r,clear:Ur,length:Vr,key:Wr,keys:zr,dropInstance:qr};function Gr(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function zn(i,u){var s=i.name+"/";return i.storeName!==u.storeName&&(s+=i.storeName+"/"),s}function Kr(){var i="_localforage_support_test";try{return localStorage.setItem(i,!0),localStorage.removeItem(i),!1}catch{return!0}}function Jr(){return!Kr()||localStorage.length>0}function Xr(i){var u=this,s={};if(i)for(var v in i)s[v]=i[v];return s.keyPrefix=zn(i,u._defaultConfig),Jr()?(u._dbInfo=s,s.serializer=Jt,f.resolve()):f.reject()}function Qr(i){var u=this,s=u.ready().then(function(){for(var v=u._dbInfo.keyPrefix,b=localStorage.length-1;b>=0;b--){var p=localStorage.key(b);p.indexOf(v)===0&&localStorage.removeItem(p)}});return g(s,i),s}function Zr(i,u){var s=this;i=C(i);var v=s.ready().then(function(){var b=s._dbInfo,p=localStorage.getItem(b.keyPrefix+i);return p&&(p=b.serializer.deserialize(p)),p});return g(v,u),v}function ea(i,u){var s=this,v=s.ready().then(function(){for(var b=s._dbInfo,p=b.keyPrefix,I=p.length,L=localStorage.length,O=1,P=0;P<L;P++){var F=localStorage.key(P);if(F.indexOf(p)===0){var z=localStorage.getItem(F);if(z&&(z=b.serializer.deserialize(z)),z=i(z,F.substring(I),O++),z!==void 0)return z}}});return g(v,u),v}function ta(i,u){var s=this,v=s.ready().then(function(){var b=s._dbInfo,p;try{p=localStorage.key(i)}catch{p=null}return p&&(p=p.substring(b.keyPrefix.length)),p});return g(v,u),v}function na(i){var u=this,s=u.ready().then(function(){for(var v=u._dbInfo,b=localStorage.length,p=[],I=0;I<b;I++){var L=localStorage.key(I);L.indexOf(v.keyPrefix)===0&&p.push(L.substring(v.keyPrefix.length))}return p});return g(s,i),s}function ra(i){var u=this,s=u.keys().then(function(v){return v.length});return g(s,i),s}function aa(i,u){var s=this;i=C(i);var v=s.ready().then(function(){var b=s._dbInfo;localStorage.removeItem(b.keyPrefix+i)});return g(v,u),v}function oa(i,u,s){var v=this;i=C(i);var b=v.ready().then(function(){u===void 0&&(u=null);var p=u;return new f(function(I,L){var O=v._dbInfo;O.serializer.serialize(u,function(P,F){if(F)L(F);else try{localStorage.setItem(O.keyPrefix+i,P),I(p)}catch(z){(z.name==="QuotaExceededError"||z.name==="NS_ERROR_DOM_QUOTA_REACHED")&&L(z),L(z)}})})});return g(b,s),b}function ia(i,u){if(u=M.apply(this,arguments),i=typeof i!="function"&&i||{},!i.name){var s=this.config();i.name=i.name||s.name,i.storeName=i.storeName||s.storeName}var v=this,b;return i.name?b=new f(function(p){i.storeName?p(zn(i,v._defaultConfig)):p(i.name+"/")}).then(function(p){for(var I=localStorage.length-1;I>=0;I--){var L=localStorage.key(I);L.indexOf(p)===0&&localStorage.removeItem(L)}}):b=f.reject("Invalid arguments"),g(b,u),b}var sa={_driver:"localStorageWrapper",_initStorage:Xr,_support:Gr(),iterate:ea,getItem:Zr,setItem:oa,removeItem:aa,clear:Qr,length:ra,key:ta,keys:na,dropInstance:ia},ca=function(u,s){return u===s||typeof u=="number"&&typeof s=="number"&&isNaN(u)&&isNaN(s)},la=function(u,s){for(var v=u.length,b=0;b<v;){if(ca(u[b],s))return!0;b++}return!1},Hn=Array.isArray||function(i){return Object.prototype.toString.call(i)==="[object Array]"},ot={},qn={},Je={INDEXEDDB:Ke,WEBSQL:Yr,LOCALSTORAGE:sa},ua=[Je.INDEXEDDB._driver,Je.WEBSQL._driver,Je.LOCALSTORAGE._driver],gt=["dropInstance"],Xt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(gt),da={description:"",driver:ua.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function fa(i,u){i[u]=function(){var s=arguments;return i.ready().then(function(){return i[u].apply(i,s)})}}function Qt(){for(var i=1;i<arguments.length;i++){var u=arguments[i];if(u)for(var s in u)u.hasOwnProperty(s)&&(Hn(u[s])?arguments[0][s]=u[s].slice():arguments[0][s]=u[s])}return arguments[0]}var ma=function(){function i(u){c(this,i);for(var s in Je)if(Je.hasOwnProperty(s)){var v=Je[s],b=v._driver;this[s]=b,ot[b]||this.defineDriver(v)}this._defaultConfig=Qt({},da),this._config=Qt({},this._defaultConfig,u),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return i.prototype.config=function(s){if((typeof s>"u"?"undefined":t(s))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var v in s){if(v==="storeName"&&(s[v]=s[v].replace(/\W/g,"_")),v==="version"&&typeof s[v]!="number")return new Error("Database version must be a number.");this._config[v]=s[v]}return"driver"in s&&s.driver?this.setDriver(this._config.driver):!0}else return typeof s=="string"?this._config[s]:this._config},i.prototype.defineDriver=function(s,v,b){var p=new f(function(I,L){try{var O=s._driver,P=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!s._driver){L(P);return}for(var F=Xt.concat("_initStorage"),z=0,te=F.length;z<te;z++){var oe=F[z],ie=!la(gt,oe);if((ie||s[oe])&&typeof s[oe]!="function"){L(P);return}}var ye=function(){for(var it=function(va){return function(){var ga=new Error("Method "+va+" is not implemented by the current driver"),Yn=f.reject(ga);return g(Yn,arguments[arguments.length-1]),Yn}},Zt=0,pa=gt.length;Zt<pa;Zt++){var en=gt[Zt];s[en]||(s[en]=it(en))}};ye();var pe=function(it){ot[O]&&console.info("Redefining LocalForage driver: "+O),ot[O]=s,qn[O]=it,I()};"_support"in s?s._support&&typeof s._support=="function"?s._support().then(pe,L):pe(!!s._support):pe(!0)}catch(Ie){L(Ie)}});return w(p,v,b),p},i.prototype.driver=function(){return this._driver||null},i.prototype.getDriver=function(s,v,b){var p=ot[s]?f.resolve(ot[s]):f.reject(new Error("Driver not found."));return w(p,v,b),p},i.prototype.getSerializer=function(s){var v=f.resolve(Jt);return w(v,s),v},i.prototype.ready=function(s){var v=this,b=v._driverSet.then(function(){return v._ready===null&&(v._ready=v._initDriver()),v._ready});return w(b,s,s),b},i.prototype.setDriver=function(s,v,b){var p=this;Hn(s)||(s=[s]);var I=this._getSupportedDrivers(s);function L(){p._config.driver=p.driver()}function O(z){return p._extend(z),L(),p._ready=p._initStorage(p._config),p._ready}function P(z){return function(){var te=0;function oe(){for(;te<z.length;){var ie=z[te];return te++,p._dbInfo=null,p._ready=null,p.getDriver(ie).then(O).catch(oe)}L();var ye=new Error("No available storage method found.");return p._driverSet=f.reject(ye),p._driverSet}return oe()}}var F=this._driverSet!==null?this._driverSet.catch(function(){return f.resolve()}):f.resolve();return this._driverSet=F.then(function(){var z=I[0];return p._dbInfo=null,p._ready=null,p.getDriver(z).then(function(te){p._driver=te._driver,L(),p._wrapLibraryMethodsWithReady(),p._initDriver=P(I)})}).catch(function(){L();var z=new Error("No available storage method found.");return p._driverSet=f.reject(z),p._driverSet}),w(this._driverSet,v,b),this._driverSet},i.prototype.supports=function(s){return!!qn[s]},i.prototype._extend=function(s){Qt(this,s)},i.prototype._getSupportedDrivers=function(s){for(var v=[],b=0,p=s.length;b<p;b++){var I=s[b];this.supports(I)&&v.push(I)}return v},i.prototype._wrapLibraryMethodsWithReady=function(){for(var s=0,v=Xt.length;s<v;s++)fa(this,Xt[s])},i.prototype.createInstance=function(s){return new i(s)},i}(),ha=new ma;a.exports=ha},{3:3}]},{},[4])(4)})})(sr);var Ea=sr.exports;const un=ba(Ea);function bt(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function tn(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const Sa=1,wa=1,Ge="emoji",nt="keyvalue",wn="favorites",Ta="tokens",cr="tokens",xa="unicode",lr="count",ka="group",Na="order",ur="group-order",dn="eTag",Nt="url",Kn="skinTone",at="readonly",Tn="readwrite",dr="skinUnicodes",Ia="skinUnicodes",Ca="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Da="en";function Aa(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function Jn(n){return Aa(n,e=>e.unicode)}function La(n){function e(r,a,o){const t=a?n.createObjectStore(r,{keyPath:a}):n.createObjectStore(r);if(o)for(const[c,[m,h]]of Object.entries(o))t.createIndex(c,m,{multiEntry:h});return t}e(nt),e(Ge,xa,{[cr]:[Ta,!0],[ur]:[[ka,Na]],[dr]:[Ia,!0]}),e(wn,void 0,{[lr]:[""]})}const fn={},Tt={},It={};function fr(n,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>n(r.result)}async function _a(n){const e=await new Promise((r,a)=>{const o=indexedDB.open(n,Sa);fn[n]=o,o.onupgradeneeded=t=>{t.oldVersion<wa&&La(o.result)},fr(r,a,o)});return e.onclose=()=>xn(n),e}function Ma(n){return Tt[n]||(Tt[n]=_a(n)),Tt[n]}function Be(n,e,r,a){return new Promise((o,t)=>{const c=n.transaction(e,r,{durability:"relaxed"}),m=typeof e=="string"?c.objectStore(e):e.map(d=>c.objectStore(d));let h;a(m,c,d=>{h=d}),c.oncomplete=()=>o(h),c.onerror=()=>t(c.error)})}function xn(n){const e=fn[n],r=e&&e.result;if(r){r.close();const a=It[n];if(a)for(const o of a)o()}delete fn[n],delete Tt[n],delete It[n]}function Oa(n){return new Promise((e,r)=>{xn(n);const a=indexedDB.deleteDatabase(n);fr(e,r,a)})}function Pa(n,e){let r=It[n];r||(r=It[n]=[]),r.push(e)}const ja=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function Xe(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||ja.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const Ba=2;function mr(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Ba)}function Ra(n){return n.map(({annotation:r,emoticon:a,group:o,order:t,shortcodes:c,skins:m,tags:h,emoji:d,version:E})=>{const f=[...new Set(mr([...(c||[]).map(Xe).flat(),...h.map(Xe).flat(),...Xe(r),a]))].sort(),g={annotation:r,group:o,order:t,tags:h,tokens:f,unicode:d,version:E};if(a&&(g.emoticon=a),c&&(g.shortcodes=c),m){g.skinTones=[],g.skinUnicodes=[],g.skinVersions=[];for(const{tone:w,emoji:C,version:M}of m)g.skinTones.push(w),g.skinUnicodes.push(C),g.skinVersions.push(M)}return g})}function hr(n,e,r,a){n[e](r).onsuccess=o=>a&&a(o.target.result)}function Ye(n,e,r){hr(n,"get",e,r)}function pr(n,e,r){hr(n,"getAll",e,r)}function kn(n){n.commit&&n.commit()}function Fa(n,e){let r=n[0];for(let a=1;a<n.length;a++){const o=n[a];e(r)>e(o)&&(r=o)}return r}function vr(n,e){const r=Fa(n,o=>o.length),a=[];for(const o of r)n.some(t=>t.findIndex(c=>e(c)===e(o))===-1)||a.push(o);return a}async function $a(n){return!await Nn(n,nt,Nt)}async function Ua(n,e,r){const[a,o]=await Promise.all([dn,Nt].map(t=>Nn(n,nt,t)));return a===r&&o===e}async function Va(n,e){return Be(n,Ge,at,(a,o,t)=>{let c;const m=()=>{a.getAll(c&&IDBKeyRange.lowerBound(c,!0),50).onsuccess=h=>{const d=h.target.result;for(const E of d)if(c=E.unicode,e(E))return t(E);if(d.length<50)return t();m()}};m()})}async function gr(n,e,r,a){try{const o=Ra(e);await Be(n,[Ge,nt],Tn,([t,c],m)=>{let h,d,E=0;function f(){++E===2&&g()}function g(){if(!(h===a&&d===r)){t.clear();for(const w of o)t.put(w);c.put(a,dn),c.put(r,Nt),kn(m)}}Ye(c,dn,w=>{h=w,f()}),Ye(c,Nt,w=>{d=w,f()})})}finally{}}async function Wa(n,e){return Be(n,Ge,at,(r,a,o)=>{const t=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);pr(r.index(ur),t,o)})}async function yr(n,e){const r=mr(Xe(e));return r.length?Be(n,Ge,at,(a,o,t)=>{const c=[],m=()=>{c.length===r.length&&h()},h=()=>{const d=vr(c,E=>E.unicode);t(d.sort((E,f)=>E.order<f.order?-1:1))};for(let d=0;d<r.length;d++){const E=r[d],f=d===r.length-1?IDBKeyRange.bound(E,E+"￿",!1,!0):IDBKeyRange.only(E);pr(a.index(cr),f,g=>{c.push(g),m()})}}):[]}async function za(n,e){const r=await yr(n,e);return r.length?r.filter(a=>(a.shortcodes||[]).map(t=>t.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Va(n,o=>(o.shortcodes||[]).includes(e.toLowerCase()))||null}async function Ha(n,e){return Be(n,Ge,at,(r,a,o)=>Ye(r,e,t=>{if(t)return o(t);Ye(r.index(dr),e,c=>o(c||null))}))}function Nn(n,e,r){return Be(n,e,at,(a,o,t)=>Ye(a,r,t))}function qa(n,e,r,a){return Be(n,e,Tn,(o,t)=>{o.put(a,r),kn(t)})}function Ya(n,e){return Be(n,wn,Tn,(r,a)=>Ye(r,e,o=>{r.put((o||0)+1,e),kn(a)}))}function Ga(n,e,r){return r===0?[]:Be(n,[wn,Ge],at,([a,o],t,c)=>{const m=[];a.index(lr).openCursor(void 0,"prev").onsuccess=h=>{const d=h.target.result;if(!d)return c(m);function E(w){if(m.push(w),m.length===r)return c(m);d.continue()}const f=d.primaryKey,g=e.byName(f);if(g)return E(g);Ye(o,f,w=>{if(w)return E(w);d.continue()})}})}const Et="";function Ka(n,e){const r=new Map;for(const o of n){const t=e(o);for(const c of t){let m=r;for(let d=0;d<c.length;d++){const E=c.charAt(d);let f=m.get(E);f||(f=new Map,m.set(E,f)),m=f}let h=m.get(Et);h||(h=[],m.set(Et,h)),h.push(o)}}return(o,t)=>{let c=r;for(let d=0;d<o.length;d++){const E=o.charAt(d),f=c.get(E);if(f)c=f;else return[]}if(t)return c.get(Et)||[];const m=[],h=[c];for(;h.length;){const E=[...h.shift().entries()].sort((f,g)=>f[0]<g[0]?-1:1);for(const[f,g]of E)f===Et?m.push(...g):h.push(g)}return m}}const Ja=["name","url"];function Xa(n){const e=n&&Array.isArray(n),r=e&&n.length&&(!n[0]||Ja.some(a=>!(a in n[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function Xn(n){Xa(n);const e=(g,w)=>g.name.toLowerCase()<w.name.toLowerCase()?-1:1,r=n.sort(e),o=Ka(n,g=>[...new Set((g.shortcodes||[]).map(w=>Xe(w)).flat())]),t=g=>o(g,!0),c=g=>o(g,!1),m=g=>{const w=Xe(g),C=w.map((M,l)=>(l<w.length-1?t:c)(M));return vr(C,M=>M.name).sort(e)},h=new Map,d=new Map;for(const g of n){d.set(g.name.toLowerCase(),g);for(const w of g.shortcodes||[])h.set(w.toLowerCase(),g)}return{all:r,search:m,byShortcode:g=>h.get(g.toLowerCase()),byName:g=>d.get(g.toLowerCase())}}const Qa=typeof wrappedJSObject<"u";function st(n){if(!n)return n;if(Qa&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let r=0;r<e;r++)n.skins[r]={tone:n.skinTones[r],unicode:n.skinUnicodes[r],version:n.skinVersions[r]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function br(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const Za=["annotation","emoji","group","order","tags","version"];function eo(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||Za.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function Er(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function to(n){const e=await fetch(n,{method:"HEAD"});Er(e,n);const r=e.headers.get("etag");return br(r),r}async function mn(n){const e=await fetch(n);Er(e,n);const r=e.headers.get("etag");br(r);const a=await e.json();return eo(a),[r,a]}function no(n){for(var e="",r=new Uint8Array(n),a=r.byteLength,o=-1;++o<a;)e+=String.fromCharCode(r[o]);return e}function ro(n){for(var e=n.length,r=new ArrayBuffer(e),a=new Uint8Array(r),o=-1;++o<e;)a[o]=n.charCodeAt(o);return r}async function Sr(n){const e=JSON.stringify(n);let r=ro(e);const a=await crypto.subtle.digest("SHA-1",r),o=no(a);return btoa(o)}async function ao(n,e){let r,a=await to(e);if(!a){const o=await mn(e);a=o[0],r=o[1],a||(a=await Sr(r))}await Ua(n,e,a)||(r||(r=(await mn(e))[1]),await gr(n,r,e,a))}async function oo(n,e){let[r,a]=await mn(e);r||(r=await Sr(a)),await gr(n,a,e,r)}class io{constructor({dataSource:e=Ca,locale:r=Da,customEmoji:a=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=Xn(a),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await Ma(this._dbName);Pa(this._dbName,this._clear);const r=this.dataSource;await $a(e)?await oo(e,r):this._lazyUpdate=ao(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return tn(e),await this.ready(),Jn(await Wa(this._db,e)).map(st)}async getEmojiBySearchQuery(e){bt(e),await this.ready();const r=this._custom.search(e),a=Jn(await yr(this._db,e)).map(st);return[...r,...a]}async getEmojiByShortcode(e){bt(e),await this.ready();const r=this._custom.byShortcode(e);return r||st(await za(this._db,e))}async getEmojiByUnicodeOrName(e){bt(e),await this.ready();const r=this._custom.byName(e);return r||st(await Ha(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await Nn(this._db,nt,Kn)||0}async setPreferredSkinTone(e){return tn(e),await this.ready(),qa(this._db,nt,Kn,e)}async incrementFavoriteEmojiCount(e){return bt(e),await this.ready(),Ya(this._db,e)}async getTopFavoriteEmoji(e){return tn(e),await this.ready(),(await Ga(this._db,this._custom,e)).map(st)}set customEmoji(e){this._custom=Xn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await xn(this._dbName)}async delete(){await this._shutdown(),await Oa(this._dbName)}}const hn=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([n,e,r])=>({id:n,emoji:e,name:r})),nn=hn.slice(1),so=2,Qn=6,wr=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function Zn(n){return n.unicode.includes("‍")}const co={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},lo=1e3,uo="🖐️",fo=8,mo=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],Tr='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',ho=(n,e)=>n<e?-1:n>e?1:0,er=(n,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const a=r.getContext("2d");return a.textBaseline="top",a.font=`100px ${Tr}`,a.fillStyle=e,a.scale(.01,.01),a.fillText(n,0,0),a.getImageData(0,0,1,1).data},po=(n,e)=>{const r=[...n].join(","),a=[...e].join(",");return r===a&&!r.startsWith("0,0,0,")};function vo(n){const e=er(n,"#000"),r=er(n,"#fff");return e&&r&&po(e,r)}function go(){const n=Object.entries(co);try{for(const[e,r]of n)if(vo(e))return r}catch{}finally{}return n[0][1]}let rn;const an=()=>(rn||(rn=new Promise(n=>wr(()=>n(go())))),rn),pn=new Map,yo="️",bo="\uD83C",Eo="‍",So=127995,wo=57339;function To(n,e){if(e===0)return n;const r=n.indexOf(Eo);return r!==-1?n.substring(0,r)+String.fromCodePoint(So+e-1)+n.substring(r):(n.endsWith(yo)&&(n=n.substring(0,n.length-1)),n+bo+String.fromCodePoint(wo+e-1))}function _e(n){n.preventDefault(),n.stopPropagation()}function on(n,e,r){return e+=n?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function xr(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function xo(n,e){const r=a=>{const o={};for(const t of a)typeof t.tone=="number"&&t.version<=e&&(o[t.tone]=t.unicode);return o};return n.map(({unicode:a,skins:o,shortcodes:t,url:c,name:m,category:h,annotation:d})=>({unicode:a,name:m,shortcodes:t,url:c,category:h,annotation:d,id:a||m,skins:o&&r(o)}))}const xt=requestAnimationFrame;let ko=typeof ResizeObserver=="function";function No(n,e,r){let a;ko?(a=new ResizeObserver(o=>r(o[0].contentRect.width)),a.observe(n)):xt(()=>r(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{a&&a.disconnect()})}function tr(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let sn;function Io(n,e,r){for(const a of n){const o=r(a),t=tr(o);typeof sn>"u"&&(sn=tr(e));const c=t/1.8<sn;pn.set(a.unicode,c)}}function Co(n){return xr(n,e=>e)}function Do(n){n&&(n.scrollTop=0)}function ut(n,e,r){let a=n.get(e);return a||(a=r(),n.set(e,a)),a}function nr(n){return""+n}function Ao(n){const e=document.createElement("template");return e.innerHTML=n,e}const Lo=new WeakMap,_o=new WeakMap,Mo=Symbol("un-keyed"),Oo="replaceChildren"in Element.prototype;function Po(n,e){Oo?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function jo(n,e){let r=n.firstChild,a=0;for(;r;){if(e[a]!==r)return!0;r=r.nextSibling,a++}return a!==e.length}function Bo(n,e){const{targetNode:r}=e;let{targetParentNode:a}=e,o=!1;a?o=jo(a,n):(o=!0,e.targetNode=void 0,e.targetParentNode=a=r.parentNode),o&&Po(a,n)}function Ro(n,e){for(const r of e){const{targetNode:a,currentExpression:o,binding:{expressionIndex:t,attributeName:c,attributeValuePre:m,attributeValuePost:h}}=r,d=n[t];if(o!==d)if(r.currentExpression=d,c)a.setAttribute(c,m+nr(d)+h);else{let E;Array.isArray(d)?Bo(d,r):d instanceof Element?(E=d,a.replaceWith(E)):a.nodeValue=nr(d),E&&(r.targetNode=E)}}}function Fo(n){let e="",r=!1,a=!1,o=-1;const t=new Map,c=[];for(let h=0,d=n.length;h<d;h++){const E=n[h];if(e+=E,h===d-1)break;for(let y=0;y<E.length;y++)switch(E.charAt(y)){case"<":{E.charAt(y+1)==="/"?c.pop():(r=!0,c.push(++o));break}case">":{r=!1,a=!1;break}case"=":{a=!0;break}}const f=c[c.length-1],g=ut(t,f,()=>[]);let w,C,M;if(a){const y=/(\S+)="?([^"=]*)$/.exec(E);w=y[1],C=y[2],M=/^[^">]*/.exec(n[h+1])[0]}const l={attributeName:w,attributeValuePre:C,attributeValuePost:M,expressionIndex:h};g.push(l),!r&&!a&&(e+=" ")}return{template:Ao(e),elementsToBindings:t}}function $o(n,e){const r=[],a=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let o=n,t=-1;do{const c=e.get(++t);if(c)for(let m=0;m<c.length;m++){const h=c[m],d=h.attributeName?o:o.firstChild,E={binding:h,targetNode:d,targetParentNode:void 0,currentExpression:void 0};r.push(E)}}while(o=a.nextNode());return r}function Uo(n){const{template:e,elementsToBindings:r}=ut(Lo,n,()=>Fo(n)),a=e.cloneNode(!0).content.firstElementChild,o=$o(a,r);return function(c){return Ro(c,o),a}}function Vo(n){const e=ut(_o,n,()=>new Map);let r=Mo;function a(t,...c){const m=ut(e,t,()=>new Map);return ut(m,r,()=>Uo(t))(c)}function o(t,c,m){return t.map((h,d)=>{const E=r;r=m(h);try{return c(h,d)}finally{r=E}})}return{map:o,html:a}}function Wo(n,e,r,a,o,t,c,m){const{labelWithSkin:h,titleForEmoji:d,unicodeWithSkin:E}=r,{html:f,map:g}=Vo(e);function w(l,y,_){return g(l,(D,R)=>f`<button role="${y?"option":"menuitem"}" aria-selected="${e.searchMode?R===e.activeSearchItem:""}" aria-label="${h(D,e.currentSkinTone)}" title="${d(D)}" class="emoji ${y&&R===e.activeSearchItem?"active":""}" id="${`${_}-${D.id}`}">${D.unicode?E(D,e.currentSkinTone):f`<img class="custom-emoji" src="${D.url}" alt="" loading="lazy">`}</button>`,D=>`${_}-${D.id}`)}const M=f`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${g(e.skinTones,(l,y)=>f`<div id="skintone-${y}" class="emoji ${y===e.activeSkinTone?"active":""}" aria-selected="${y===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[y]}" aria-label="${e.i18n.skinTones[y]}">${l}</div>`,l=>l)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${g(e.groups,l=>f`<button role="tab" class="nav-button" aria-controls="tab-${l.id}" aria-label="${e.i18n.categories[l.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===l.id}" title="${e.i18n.categories[l.name]}" data-group-id="${l.id}"><div class="nav-emoji emoji">${l.emoji}</div></button>`,l=>l.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${g(e.currentEmojisWithCategories,(l,y)=>f`<div><div id="menu-label-${y}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:l.category?l.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${y}" id="${e.searchMode?"search-results":""}">${w(l.emojis,e.searchMode,"emo")}</div></div>`,l=>l.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${w(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(m){n.appendChild(M);const l=(y,_)=>{for(const D of n.querySelectorAll(`[${y}]`))_(D,D.getAttribute(y))};for(const y of["click","focusout","input","keydown","keyup"])l(`data-on-${y}`,(_,D)=>{_.addEventListener(y,a[D])});l("data-ref",(y,_)=>{t[_]=y}),l("data-action",(y,_)=>{o[_](y)}),c.addEventListener("abort",()=>{n.removeChild(M)})}}const Ct=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function zo(n){let e=!1,r;const a=new Map,o=new Set;let t;const c=()=>{if(e)return;const d=[...o];o.clear();try{for(const E of d)E()}finally{t=!1,o.size&&(t=!0,Ct(c))}},m=new Proxy({},{get(d,E){if(r){let f=a.get(E);f||(f=new Set,a.set(E,f)),f.add(r)}return d[E]},set(d,E,f){d[E]=f;const g=a.get(E);if(g){for(const w of g)o.add(w);t||(t=!0,Ct(c))}return!0}}),h=d=>{const E=()=>{const f=r;r=E;try{return d()}finally{r=f}};return E()};return n.addEventListener("abort",()=>{e=!0}),{state:m,createEffect:h}}function cn(n,e,r){if(n.length!==e.length)return!1;for(let a=0;a<n.length;a++)if(!r(n[a],e[a]))return!1;return!0}const ln=[],{assign:St}=Object;function Ho(n,e){const r={},a=new AbortController,o=a.signal,{state:t,createEffect:c}=zo(o);St(t,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),St(t,e),St(t,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:fo,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:nn,databaseLoaded:!1,activeSearchItemId:void 0}),c(()=>{t.currentGroup!==t.groups[t.currentGroupIndex]&&(t.currentGroup=t.groups[t.currentGroupIndex])});const m=x=>{n.getElementById(x).focus()},h=x=>n.getElementById(`emo-${x.id}`),d=(x,B)=>{r.rootElement.dispatchEvent(new CustomEvent(x,{detail:B,bubbles:!0,composed:!0}))},E=(x,B)=>x.id===B.id,f=(x,B)=>{const{category:H,emojis:Y}=x,{category:ee,emojis:ne}=B;return H!==ee?!1:cn(Y,ne,E)},g=x=>{cn(t.currentEmojis,x,E)||(t.currentEmojis=x)},w=x=>{t.searchMode!==x&&(t.searchMode=x)},C=x=>{cn(t.currentEmojisWithCategories,x,f)||(t.currentEmojisWithCategories=x)},M=(x,B)=>B&&x.skins&&x.skins[B]||x.unicode,_={labelWithSkin:(x,B)=>Co([x.name||M(x,B),x.annotation,...x.shortcodes||ln].filter(Boolean)).join(", "),titleForEmoji:x=>x.annotation||(x.shortcodes||ln).join(", "),unicodeWithSkin:M},D={onClickSkinToneButton:Q,onEmojiClick:W,onNavClick:k,onNavKeydown:U,onSearchKeydown:N,onSkinToneOptionsClick:j,onSkinToneOptionsFocusOut:Te,onSkinToneOptionsKeydown:J,onSkinToneOptionsKeyup:ce,onSearchInput:Ne},R={calculateEmojiGridStyle:V};let S=!0;c(()=>{Wo(n,t,_,D,R,r,o,S),S=!1}),t.emojiVersion||an().then(x=>{x||(t.message=t.i18n.emojiUnsupportedMessage)}),c(()=>{async function x(){let B=!1;const H=setTimeout(()=>{B=!0,t.message=t.i18n.loadingMessage},lo);try{await t.database.ready(),t.databaseLoaded=!0}catch(Y){console.error(Y),t.message=t.i18n.networkErrorMessage}finally{clearTimeout(H),B&&(B=!1,t.message="")}}t.database&&x()}),c(()=>{t.pickerStyle=`
      --num-groups: ${t.groups.length}; 
      --indicator-opacity: ${t.searchMode?0:1}; 
      --num-skintones: ${Qn};`}),c(()=>{t.customEmoji&&t.database&&$()}),c(()=>{t.customEmoji&&t.customEmoji.length?t.groups!==hn&&(t.groups=hn):t.groups!==nn&&(t.currentGroupIndex&&t.currentGroupIndex--,t.groups=nn)}),c(()=>{async function x(){t.databaseLoaded&&(t.currentSkinTone=await t.database.getPreferredSkinTone())}x()}),c(()=>{t.skinTones=Array(Qn).fill().map((x,B)=>To(t.skinToneEmoji,B))}),c(()=>{t.skinToneButtonText=t.skinTones[t.currentSkinTone]}),c(()=>{t.skinToneButtonLabel=t.i18n.skinToneLabel.replace("{skinTone}",t.i18n.skinTones[t.currentSkinTone])}),c(()=>{async function x(){const{database:B}=t,H=(await Promise.all(mo.map(Y=>B.getEmojiByUnicodeOrName(Y)))).filter(Boolean);t.defaultFavoriteEmojis=H}t.databaseLoaded&&x()});function $(){t.database.customEmoji=t.customEmoji||ln}c(()=>{async function x(){$();const{database:B,defaultFavoriteEmojis:H,numColumns:Y}=t,ee=await B.getTopFavoriteEmoji(Y),ne=await he(xr([...ee,...H],we=>we.unicode||we.name).slice(0,Y));t.currentFavorites=ne}t.databaseLoaded&&t.defaultFavoriteEmojis&&x()});function V(x){No(x,o,B=>{{const H=getComputedStyle(r.rootElement),Y=parseInt(H.getPropertyValue("--num-columns"),10),ee=H.getPropertyValue("direction")==="rtl",we=x.parentElement.getBoundingClientRect().width-B;t.numColumns=Y,t.scrollbarWidth=we,t.isRtl=ee}})}c(()=>{async function x(){const{searchText:B,currentGroup:H,databaseLoaded:Y,customEmoji:ee}=t;if(!Y)t.currentEmojis=[],t.searchMode=!1;else if(B.length>=so){const ne=await de(B);t.searchText===B&&(g(ne),w(!0))}else{const{id:ne}=H;if(ne!==-1||ee&&ee.length){const we=await ge(ne);t.currentGroup.id===ne&&(g(we),w(!1))}}}x()}),c(()=>{const{currentEmojis:x,emojiVersion:B}=t,H=x.filter(Y=>Y.unicode).filter(Y=>Zn(Y)&&!pn.has(Y.unicode));if(!B&&H.length)g(x),xt(()=>K(H));else{const Y=B?x:x.filter(se);g(Y),xt(()=>Do(r.tabpanelElement))}});function K(x){Io(x,r.baselineEmoji,h),t.currentEmojis=t.currentEmojis}function se(x){return!x.unicode||!Zn(x)||pn.get(x.unicode)}async function ae(x){const B=t.emojiVersion||await an();return x.filter(({version:H})=>!H||H<=B)}async function he(x){return xo(x,t.emojiVersion||await an())}async function ge(x){const B=x===-1?t.customEmoji:await t.database.getEmojiByGroup(x);return he(await ae(B))}async function de(x){return he(await ae(await t.database.getEmojiBySearchQuery(x)))}c(()=>{}),c(()=>{function x(){const{searchMode:H,currentEmojis:Y}=t;if(H)return[{category:"",emojis:Y}];const ee=new Map;for(const ne of Y){const we=ne.category||"";let Ke=ee.get(we);Ke||(Ke=[],ee.set(we,Ke)),Ke.push(ne)}return[...ee.entries()].map(([ne,we])=>({category:ne,emojis:we})).sort((ne,we)=>t.customCategorySorting(ne.category,we.category))}const B=x();C(B)}),c(()=>{t.activeSearchItemId=t.activeSearchItem!==-1&&t.currentEmojis[t.activeSearchItem].id}),c(()=>{const{rawSearchText:x}=t;wr(()=>{t.searchText=(x||"").trim(),t.activeSearchItem=-1})});function N(x){if(!t.searchMode||!t.currentEmojis.length)return;const B=H=>{_e(x),t.activeSearchItem=on(H,t.activeSearchItem,t.currentEmojis)};switch(x.key){case"ArrowDown":return B(!1);case"ArrowUp":return B(!0);case"Enter":if(t.activeSearchItem===-1)t.activeSearchItem=0;else return _e(x),q(t.currentEmojis[t.activeSearchItem].id)}}function k(x){const{target:B}=x,H=B.closest(".nav-button");if(!H)return;const Y=parseInt(H.dataset.groupId,10);r.searchElement.value="",t.rawSearchText="",t.searchText="",t.activeSearchItem=-1,t.currentGroupIndex=t.groups.findIndex(ee=>ee.id===Y)}function U(x){const{target:B,key:H}=x,Y=ee=>{ee&&(_e(x),ee.focus())};switch(H){case"ArrowLeft":return Y(B.previousElementSibling);case"ArrowRight":return Y(B.nextElementSibling);case"Home":return Y(B.parentElement.firstElementChild);case"End":return Y(B.parentElement.lastElementChild)}}async function q(x){const B=await t.database.getEmojiByUnicodeOrName(x),H=[...t.currentEmojis,...t.currentFavorites].find(ee=>ee.id===x),Y=H.unicode&&M(H,t.currentSkinTone);await t.database.incrementFavoriteEmojiCount(x),d("emoji-click",{emoji:B,skinTone:t.currentSkinTone,...Y&&{unicode:Y},...H.name&&{name:H.name}})}async function W(x){const{target:B}=x;if(!B.classList.contains("emoji"))return;_e(x);const H=B.id.substring(4);q(H)}function X(x){t.currentSkinTone=x,t.skinTonePickerExpanded=!1,m("skintone-button"),d("skin-tone-change",{skinTone:x}),t.database.setPreferredSkinTone(x)}function j(x){const{target:{id:B}}=x,H=B&&B.match(/^skintone-(\d)/);if(!H)return;_e(x);const Y=parseInt(H[1],10);X(Y)}function Q(x){t.skinTonePickerExpanded=!t.skinTonePickerExpanded,t.activeSkinTone=t.currentSkinTone,t.skinTonePickerExpanded&&(_e(x),xt(()=>m("skintone-list")))}c(()=>{t.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{t.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):t.skinTonePickerExpandedAfterAnimation=!1});function J(x){if(!t.skinTonePickerExpanded)return;const B=async H=>{_e(x),t.activeSkinTone=H};switch(x.key){case"ArrowUp":return B(on(!0,t.activeSkinTone,t.skinTones));case"ArrowDown":return B(on(!1,t.activeSkinTone,t.skinTones));case"Home":return B(0);case"End":return B(t.skinTones.length-1);case"Enter":return _e(x),X(t.activeSkinTone);case"Escape":return _e(x),t.skinTonePickerExpanded=!1,m("skintone-button")}}function ce(x){if(t.skinTonePickerExpanded)switch(x.key){case" ":return _e(x),X(t.activeSkinTone)}}async function Te(x){const{relatedTarget:B}=x;(!B||B.id!=="skintone-list")&&(t.skinTonePickerExpanded=!1)}function Ne(x){t.rawSearchText=x.target.value}return{$set(x){St(t,x)},$destroy(){a.abort()}}}const qo="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Yo="en";var Go={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Ko=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const kr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],Jo=`:host{--emoji-font-family:${Tr}}`;class In extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=Ko+Jo,this.shadowRoot.appendChild(r),this._ctx={locale:Yo,dataSource:qo,skinToneEmoji:uo,customCategorySorting:ho,customEmoji:null,i18n:Go,emojiVersion:null,...e};for(const a of kr)a!=="database"&&Object.prototype.hasOwnProperty.call(this,a)&&(this._ctx[a]=this[a],delete this[a]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Ho(this.shadowRoot,this._ctx))}disconnectedCallback(){Ct(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,a){this._set(e.replace(/-([a-z])/g,(o,t)=>t.toUpperCase()),e==="emoji-version"?parseFloat(a):a)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:a}=this._ctx;(!a||a.locale!==e||a.dataSource!==r)&&this._set("database",new io({locale:e,dataSource:r}))}_dbFlush(){Ct(()=>this._dbCreate())}}const Nr={};for(const n of kr)Nr[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(In.prototype,Nr);customElements.get("emoji-picker")||customElements.define("emoji-picker",In);var vn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(r,a){a(e)})(ct,function(r){var a="dnd-poly-",o=a+"snapback",t="dnd-poly-",c=t+"dragstart-pending",m=t+"dragstart-cancel",h=["none","copy","copyLink","copyMove","link","linkMove","move","all"],d=["none","copy","move","link"],E=function(){var N=!1;try{var k=Object.defineProperty({},"passive",{get:function(){N=!0}});window.addEventListener("test",null,k)}catch{}return N}();function f(N){return N&&N.tagName}function g(N,k,U){U===void 0&&(U=!0),document.addEventListener(N,k,!!E&&{passive:U})}function w(N,k){document.removeEventListener(N,k)}function C(N,k,U,q){q===void 0&&(q=!1);var W=E?{passive:!0,capture:q}:q;return N.addEventListener(k,U,W),{off:function(){N.removeEventListener(k,U,W)}}}function M(N){return N.length===0?0:N.reduce(function(k,U){return U+k},0)/N.length}function l(N,k){for(var U=0;U<N.changedTouches.length;U++)if(N.changedTouches[U].identifier===k)return!0;return!1}function y(N,k,U){for(var q=[],W=[],X=0;X<k.touches.length;X++){var j=k.touches[X];q.push(j[N+"X"]),W.push(j[N+"Y"])}U.x=M(q),U.y=M(W)}var _=["","-webkit-"];function D(N,k,U,q,W){W===void 0&&(W=!0);var X=k.x,j=k.y;q&&(X+=q.x,j+=q.y),W&&(X-=parseInt(N.offsetWidth,10)/2,j-=parseInt(N.offsetHeight,10)/2);for(var Q="translate3d("+X+"px,"+j+"px, 0)",J=0;J<_.length;J++){var ce=_[J]+"transform";N.style[ce]=Q+" "+U[J]}}var R=function(){function N(k,U){this.t=k,this.i=U,this.s=d[0]}return Object.defineProperty(N.prototype,"dropEffect",{get:function(){return this.s},set:function(k){this.t.mode!==0&&h.indexOf(k)>-1&&(this.s=k)},enumerable:!0,configurable:!0}),Object.defineProperty(N.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(N.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(k){this.t.mode===2&&h.indexOf(k)>-1&&(this.t.effectAllowed=k)},enumerable:!0,configurable:!0}),N.prototype.setData=function(k,U){if(this.t.mode===2){if(k.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[k]=U,this.t.types.indexOf(k)===-1&&this.t.types.push(k)}},N.prototype.getData=function(k){if(this.t.mode===1||this.t.mode===2)return this.t.data[k]||""},N.prototype.clearData=function(k){if(this.t.mode===2){if(k&&this.t.data[k]){delete this.t.data[k];var U=this.t.types.indexOf(k);return void(U>-1&&this.t.types.splice(U,1))}this.t.data={},this.t.types=[]}},N.prototype.setDragImage=function(k,U,q){this.t.mode===2&&this.i(k,U,q)},N}();function S(N,k){return N?N===h[0]?d[0]:N.indexOf(h[1])===0||N===h[7]?d[1]:N.indexOf(h[4])===0?d[3]:N===h[6]?d[2]:d[1]:k.nodeType===3&&k.tagName==="A"?d[3]:d[1]}function $(N,k,U,q,W,X,j){X===void 0&&(X=!0),j===void 0&&(j=null);var Q=function(ce,Te,Ne,x,B,H,Y){Y===void 0&&(Y=null);var ee=Te.changedTouches[0],ne=new Event(Ne,{bubbles:!0,cancelable:x});ne.dataTransfer=H,ne.relatedTarget=Y,ne.screenX=ee.screenX,ne.screenY=ee.screenY,ne.clientX=ee.clientX,ne.clientY=ee.clientY,ne.pageX=ee.pageX,ne.pageY=ee.pageY;var we=ce.getBoundingClientRect();return ne.offsetX=ne.clientX-we.left,ne.offsetY=ne.clientY-we.top,ne}(k,U,N,X,document.defaultView,W,j),J=!k.dispatchEvent(Q);return q.mode=0,J}function V(N,k){if(!N||N===h[7])return k;if(k===d[1]){if(N.indexOf(d[1])===0)return d[1]}else if(k===d[3]){if(N.indexOf(d[3])===0||N.indexOf("Link")>-1)return d[3]}else if(k===d[2]&&(N.indexOf(d[2])===0||N.indexOf("Move")>-1))return d[2];return d[0]}var K,se=function(){function N(k,U,q,W){this.h=k,this.o=U,this.u=q,this.l=W,this.v=0,this.p=null,this.g=null,this.m=k,this.I=k.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),g("touchmove",this.j,!1),g("touchend",this.S,!1),g("touchcancel",this.S,!1)}return N.prototype.A=function(){var k=this;this.v=1,this.O=d[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var U=this.u;if(this.N=new R(this.D,function(Q,J,ce){U=Q,typeof J!="number"&&typeof ce!="number"||(k.P={x:J||0,y:ce||0})}),this.D.mode=2,this.N.dropEffect=d[0],$("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;y("page",this.m,this.F);var q,W=this.o.dragImageSetup(U);if(this.L=(q=W,_.map(function(Q){var J=q.style[Q+"transform"];return J&&J!=="none"?J.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),W.style.position="absolute",W.style.left="0px",W.style.top="0px",W.style.zIndex="999999",W.classList.add("dnd-poly-drag-image"),W.classList.add("dnd-poly-icon"),this._=W,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var X=getComputedStyle(U);this.P={x:0-parseInt(X.marginLeft,10),y:0-parseInt(X.marginTop,10)}}else{var j=U.getBoundingClientRect();X=getComputedStyle(U),this.P={x:j.left-this.I.clientX-parseInt(X.marginLeft,10)+j.width/2,y:j.top-this.I.clientY-parseInt(X.marginTop,10)+j.height/2}}return D(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){k.X||(k.X=!0,k.Y(),k.X=!1)},this.o.iterationInterval),!0},N.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),w("touchmove",this.j),w("touchend",this.S),w("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},N.prototype.C=function(k){var U=this;if(l(k,this.I.identifier)!==!1){if(this.m=k,this.v===0){var q=void 0;if(this.o.dragStartConditionOverride)try{q=this.o.dragStartConditionOverride(k)}catch{q=!1}else q=k.touches.length===1;return q?void(this.A()===!0&&(this.h.preventDefault(),k.preventDefault())):void this.T()}if(k.preventDefault(),y("client",k,this.M),y("page",k,this.F),this.o.dragImageTranslateOverride)try{var W=!1;if(this.o.dragImageTranslateOverride(k,{x:this.M.x,y:this.M.y},this.p,function(X,j){U._&&(W=!0,U.M.x+=X,U.M.y+=j,U.F.x+=X,U.F.y+=j,D(U._,U.F,U.L,U.P,U.o.dragImageCenterOnTouch))}),W)return}catch{}D(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},N.prototype.k=function(k){if(l(k,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(k.preventDefault(),this.v=k.type==="touchcancel"?3:2):this.T()}},N.prototype.Y=function(){var k=this,U=this.O;this.D.mode=3,this.N.dropEffect=d[0];var q=$("drag",this.u,this.m,this.D,this.N);if(q&&(this.O=d[0]),q||this.v===2||this.v===3)return this.q(this.v)?void function(Q,J,ce,Te){var Ne=getComputedStyle(Q);if(Ne.visibility!=="hidden"&&Ne.display!=="none"){J.classList.add(o);var x=getComputedStyle(J),B=parseFloat(x.transitionDuration);if(isNaN(B)||B===0)Te();else{var H=Q.getBoundingClientRect(),Y={x:H.left,y:H.top};Y.x+=document.body.scrollLeft||document.documentElement.scrollLeft,Y.y+=document.body.scrollTop||document.documentElement.scrollTop,Y.x-=parseInt(Ne.marginLeft,10),Y.y-=parseInt(Ne.marginTop,10);var ee=parseFloat(x.transitionDelay),ne=Math.round(1e3*(B+ee));D(J,Y,ce,void 0,!1),setTimeout(Te,ne)}}else Te()}(this.u,this._,this.L,function(){k.B()}):void this.B();var W=this.o.elementFromPoint(this.M.x,this.M.y),X=this.g;W!==this.p&&W!==this.g&&(this.p=W,this.g!==null&&(this.D.mode=3,this.N.dropEffect=d[0],$("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=S(this.D.effectAllowed,this.u),$("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=V(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),X!==this.g&&f(X)&&(this.D.mode=3,this.N.dropEffect=d[0],$("dragleave",X,this.m,this.D,this.N,!1,this.g)),f(this.g)&&(this.D.mode=3,this.N.dropEffect=S(this.D.effectAllowed,this.u),$("dragover",this.g,this.m,this.D,this.N)===!1?this.O=d[0]:this.O=V(this.N.effectAllowed,this.N.dropEffect)),U!==this.O&&this._.classList.remove(a+U);var j=a+this.O;this._.classList.add(j)},N.prototype.q=function(k){var U=this.O===d[0]||this.g===null||k===3;return U?f(this.g)&&(this.D.mode=3,this.N.dropEffect=d[0],$("dragleave",this.g,this.m,this.D,this.N,!1)):f(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,$("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=d[0]),U},N.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,$("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},N}(),ae={iterationInterval:150,tryFindDraggableTarget:function(N){var k=N.target;do if(k.draggable!==!1&&(k.draggable===!0||k.getAttribute&&k.getAttribute("draggable")==="true"))return k;while((k=k.parentNode)&&k!==document.body)},dragImageSetup:function(N){var k=N.cloneNode(!0);return function U(q,W){if(q.nodeType===1){for(var X=getComputedStyle(q),j=0;j<X.length;j++){var Q=X[j];W.style.setProperty(Q,X.getPropertyValue(Q),X.getPropertyPriority(Q))}if(W.style.pointerEvents="none",W.removeAttribute("id"),W.removeAttribute("class"),W.removeAttribute("draggable"),W.nodeName==="CANVAS"){var J=q,ce=W,Te=J.getContext("2d").getImageData(0,0,J.width,J.height);ce.getContext("2d").putImageData(Te,0,0)}}if(q.hasChildNodes())for(j=0;j<q.childNodes.length;j++)U(q.childNodes[j],W.childNodes[j])}(N,k),k},elementFromPoint:function(N,k){return document.elementFromPoint(N,k)}};function he(N){if(!K){var k=ae.tryFindDraggableTarget(N);if(k)try{K=new se(N,ae,k,de)}catch(U){throw de(ae,N,3),U}}}function ge(N){var k=N.target,U=function(J){W.off(),X.off(),j.off(),Q.off(),k&&k.dispatchEvent(new CustomEvent(m,{bubbles:!0,cancelable:!0})),clearTimeout(q)};k&&k.dispatchEvent(new CustomEvent(c,{bubbles:!0,cancelable:!0}));var q=window.setTimeout(function(){W.off(),X.off(),j.off(),Q.off(),he(N)},ae.holdToDrag),W=C(k,"touchend",U),X=C(k,"touchcancel",U),j=C(k,"touchmove",U),Q=C(window,"scroll",U,!0)}function de(N,k,U){if(U===0&&N.defaultActionOverride)try{N.defaultActionOverride(k),k.defaultPrevented}catch{}K=null}r.polyfill=function(N){if(N&&Object.keys(N).forEach(function(W){ae[W]=N[W]}),!ae.forceApply){var k=(U={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},q=!!window.chrome||/chrome/i.test(navigator.userAgent),U.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||q&&"ontouchstart"in document.documentElement),U);if(k.userAgentSupportingNativeDnD&&k.draggable&&k.dragEvents)return!1}var U,q;return ae.holdToDrag?g("touchstart",ge,!1):g("touchstart",he,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(vn,vn.exports);var Xo=vn.exports;const Qo=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),Ce=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},Zo=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let rr;const ei=(n=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),a=()=>{clearTimeout(r),clearTimeout(rr),rr=setTimeout(()=>{n.removeEventListener("scroll",a),e()},100)};n.addEventListener("scroll",a)}),gn=n=>{try{return JSON.parse(n),!0}catch{return!1}},ti="0.6.4 Beta",ze=document.querySelector(".editor"),ue=document.getElementById("tones"),Ee=document.getElementById("action"),re=document.getElementById("musical-score"),je=document.getElementById("add-track"),rt=document.getElementById("remove-track"),He=document.getElementById("dialog"),Se=document.forms["dialog-form"];Se._title=Se.querySelector(".form-title");Se.description=Se.querySelector(".description");Se.inputs=Se.querySelector(".inputs");Se.buttons=Se.querySelector(".buttons");const Dt=document.getElementById("play"),At=document.getElementById("clear"),ni=document.getElementById("warn-out"),ri=document.getElementById("mml"),Le=document.getElementById("copy"),$e=document.getElementById("paste"),We=document.getElementById("save"),yn=document.getElementById("open"),Ht=document.getElementById("ctrl"),Lt=document.getElementById("undo"),_t=document.getElementById("redo");var ft,le,De,Qe;class ai{constructor(){fe(this,ft,`#COMMENT Generated by FlMML VisualSequencer v${ti}`);fe(this,le,[]);fe(this,De,(e,r)=>{});fe(this,Qe,(e,r)=>{})}set onChange(e){ke(this,De,e)}set onError(e){ke(this,Qe,e)}setMmlArr(e){ke(this,le,e),A(this,De).call(this,this.getMmlArr(),this.getMml())}setMml(e){ke(this,le,e.split(`
`)),A(this,le).at(-2)===""&&A(this,le).at(-1)===A(this,ft)&&A(this,le).splice(-2,2),A(this,De).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return A(this,le)}getMml(){return A(this,le).length?A(this,le).concat(["",A(this,ft)]).join(`
`):""}getMmlLine(e){return A(this,le)[e]}insert(e,r){Object.hasOwn(A(this,le),e)||e===0?(A(this,le).splice(e,0,r),A(this,De).call(this,this.getMmlArr(),this.getMml())):A(this,Qe).call(this,"範囲外の書き換え指定",`範囲${A(this,le).length-1}までのところ、${e}`)}append(e){A(this,le).push(e),A(this,De).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(A(this,le),e)?(A(this,le)[e]+=r,A(this,De).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(A(this,le),e)?(A(this,le)[e]=r+A(this,le)[e],A(this,De).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(A(this,le),e)?(A(this,le)[e]=r,A(this,De).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(A(this,le),e)&&A(this,le).splice(e,r).length!==0?A(this,De).call(this,this.getMmlArr(),this.getMml()):A(this,Qe).call(this,"無効な指定",`範囲${A(this,le).length-1}までの中で${e}から${r}削除するのはできません`)}}ft=new WeakMap,le=new WeakMap,De=new WeakMap,Qe=new WeakMap;var me,Ze,et,mt,Ve;class oi{constructor(e,r){fe(this,me,[]);fe(this,Ze,new Set);fe(this,et,[]);fe(this,mt,null);fe(this,Ve,null);this.tonesElem=e,this.areaElem=r,ke(this,Ve,this.areaElem.querySelector(".track.active"))}set activeTrack(e){A(this,Ve).classList.remove("active"),ke(this,Ve,e),A(this,Ve).classList.add("active")}get activeTrack(){return A(this,Ve)}blocksDataUpdate(){ke(this,me,[...this.areaElem.querySelectorAll(".track button")].map(this.extractBlockData))}extractBlockData(e){return{label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),...e.dataset,elem:e}}saveBlocksData(){clearTimeout(A(this,mt)),ke(this,mt,setTimeout(()=>{const e=JSON.parse(JSON.stringify(A(this,me)));un.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){un.getItem("BlocksData").then(e=>{e&&(ke(this,me,e.map(r=>{const a=r.tone;return(a==null?void 0:a.tone)!==void 0&&(a==null?void 0:a.tonePitch)!==void 0&&(r.tone=a.tone,r.tonePitch=a.tonePitch),r})),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Z),this.calcPlayFromHere())})}parseBlocks(){const e=A(this,me);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let a=0;e.forEach(o=>{if(o.trackNo!==a){const E=document.createElement("ul");E.classList.add("track"),this.activeTrack=E,this.areaElem.insertBefore(E,je),a=o.trackNo}const t=document.createElement("li"),c='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',m=(()=>{const E=document.createElement("div");return E.innerHTML=c,E.firstElementChild})(),h=document.querySelector(`[class*="${o.className.replace(/ material-icons| droppable| bounce| pop| done| inactive/g,"")}"]`),d=(h==null?void 0:h.cloneNode(!0))||m;o.label&&(d.ariaLabel=o.label),d.className=o.className,o.tonePitch&&(o.label!=="無調整"&&(d.textContent=o.label),d.dataset.tone=o.tone,h?h.replaceWith(d.cloneNode(!0)):r.appendChild(d.cloneNode(!0)),d.dataset.tonePitch=o.tonePitch),o.tempo&&(d.dataset.tempo=o.tempo),o.noteValue&&(d.dataset.noteValue=o.noteValue),o.rest&&(d.dataset.rest=o.rest),o.octave&&(d.dataset.octave=o.octave),o.velocity&&(d.dataset.velocity=o.velocity),o.noteShift&&(d.dataset.noteShift=o.noteShift),o.detune&&(d.dataset.detune=o.detune),o.tieSlur&&(d.dataset.tieSlur=o.tieSlur,o.tieSlur==="&"?d.ariaLabel="スラー":d.ariaLabel="タイ"),o.repeatStartEnd&&(d.dataset.repeatStartEnd=o.repeatStartEnd,o.repeatStartEnd.startsWith("/:")?(d.classList.remove("material-icons"),d.ariaLabel="リピート開始",d.textContent="◆"):o.repeatStartEnd===":/"&&(d.ariaLabel="リピート終了")),o.repeatBreak&&(d.dataset.repeatBreak=o.repeatBreak),o.polyStartEnd&&(d.dataset.polyStartEnd=o.polyStartEnd),o.macroDef&&(d.dataset.macroDef=o.macroDef,o.macroDef===";"?d.textContent=";":d.textContent="$="),o.macroArgUse&&(d.dataset.macroArgUse=o.macroArgUse),o.macroUse&&(d.dataset.macroUse=o.macroUse),o.metaData&&(d.dataset.metaData=o.metaData),o.otherAction&&(d.dataset.otherAction=o.otherAction,d.textContent=o.otherAction.length>4?"…":o.otherAction),t.appendChild(d),this.activeTrack.appendChild(t)})}exportMml(e){e.setMmlArr([]);let r=0,a=0;const o=A(this,me).filter(l=>l.tone!==void 0),t=()=>o.filter(l=>l.trackNo===a),c=()=>new Set(t().map(l=>l.tone));let m=c(),h=0,d=!1,E={noteValue:4,dots:0},f=!1,g=!1;const w=A(this,me).findIndex(l=>l.elem.classList.contains("play-from-here")),C=w!==-1,M=C?A(this,me)[w].trackNo:-1;A(this,me).forEach((l,y)=>{const{tone:_,tonePitch:D}=l,R=!C||g||C&&l.trackNo===M&&y>=w;if(l.trackNo!==a&&(m.size?([...m].forEach((S,$)=>{e.appendToStr(r+$,";")}),r+=m.size):(e.appendToStr(r,";"),r++),a=l.trackNo,m=c(),d=!1,g=!1),_!==void 0)h=[...m].indexOf(_),d||([...m].forEach((S,$)=>{S&&e.beforeInsertToStr(r+$,S+" ")}),d=!0),[...m].forEach((S,$)=>{let V=D||"";$!==h&&(V=V.replace(/[a-g]/,f?"*":"r")),R||(V=V.replace(/[a-gr*]\+?[0-9]*\.*/i,"")),e.appendToStr(r+$,V)});else if(l.rest||l.tieSlur){let S=l.rest||l.tieSlur;R||(S=S.replace(/[r&]\+?[0-9]*\.*/i,"")),m.size?[...m].forEach(($,V)=>{e.appendToStr(r+V,S)}):e.appendToStr(r,S)}else if(l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd){const S=$=>{if(!$)return E;const V=Number(($.match(/[0-9]+/)||[E.noteValue])[0]),K=($.match(/\.+/)||[""])[0].length;return{noteValue:V,dots:K}};l.noteValue?E=S(l.noteValue):l.polyStartEnd==="["?f=!0:l.polyStartEnd==="]"&&(f=!1),m.size?[...m].forEach(($,V)=>{if(e.appendToStr(r+V,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||""),l.polyStartEnd==="]"){const K=e.getMmlLine(r+V).match(/\[(.+?)\]/);if(K){const se=K[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(se){const ae=[...se].map(de=>({type:de[1]==="r"?"rest":de[1]==="*"?"otherNote":"note",num:S(de[0])}));ae.filter(N=>N.type==="note").map(N=>N.num),ae.filter(N=>N.type==="otherNote").map(N=>N.num),ae.filter(N=>N.type==="rest").map(N=>N.num);let he=K[0].replace(/\*\+?[0-9]*\.*/g,"");const ge=e.getMmlLine(r+V).replace(/\[.+?\]/,he);e.rewrite(r+V,ge)}}}}):e.appendToStr(r,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||"")}else if(l.metaData)l.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,l.metaData.replace(`
`,"")||""),r++;else if(l.macroDef)g=l.macroDef!==";",e.appendToStr(r,l.macroDef||"");else{let S;R?S=D||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.macroArgUse||l.macroUse||l.otherAction||"":S=(D==null?void 0:D.replace(/[a-g]\+?[0-9]*\.*/i,""))||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.otherAction||"",e.appendToStr(r,S),/;/.test(S)&&(r+=m.size||1,m=c(),d=!1)}}),[...m].slice(0,-1).forEach((l,y)=>{e.appendToStr(r+y,";")})}importMml(e){const r=e.getMmlArr(),a=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_.]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig;A(this,Ze).clear();const o=new Set;let t=0,c="",m=!1,h=!1;const d=f=>(f.match(a)||[]).reduce((w,C)=>(C=C.trim(),C&&(l=>{const y={};if(y.tone={},y.trackNo=t,l.startsWith("#")){const _={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};y.label=(Object.entries(_).find(D=>l.startsWith(D[0]))||[,void 0])[1],y.className="meta-data",y.metaData=l+`
`}else if(/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(l)){c=l,o.add(c);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(l)){o.has(c)||o.add(c);const _=[...o].indexOf(c)+1;y.label="無調整",y.className=`material-icons note note-${_}`,y.tone=c,y.tonePitch=l,m&&(h=!0)}else if(l.startsWith("t"))y.className="material-icons tempo",y.tempo=l;else if(l.startsWith("l"))y.className="material-icons note-value",y.noteValue=l;else if(l.startsWith("r"))y.className="material-icons rest",y.rest=l;else if(/^o[0-8]|[><]+$/i.test(l))y.className="material-icons octave",y.octave=l;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(l))y.className="material-icons velocity",y.velocity=l;else if(l.startsWith("@ns")||l.startsWith("ns"))y.className="material-icons note-shift",y.noteShift=l;else if(l.startsWith("@d"))y.className="material-icons detune",y.detune=l;else if(l.startsWith("&"))y.className="tie-slur",y.tieSlur=l;else if(l.startsWith("/*"))y.className="other-action",y.otherAction=l;else if(l.startsWith("/:"))y.className="repeat-start-end",y.repeatStartEnd=l;else if(l.startsWith(":/"))y.className="material-icons repeat-start-end",y.repeatStartEnd=l;else if(l.startsWith("/"))y.className="repeat-break",y.repeatBreak=l;else if(l.startsWith("[")||l.startsWith("]"))y.className="poly-start-end",y.polyStartEnd=l;else if(/^\$.*?=$/.test(l))y.className="macro-def",y.macroDef=l.replaceAll(" ",""),A(this,Ze).add(y.macroDef.replace("=","")),m=!0;else if(l.startsWith("%"))y.className="macro-arg-use",y.macroArgUse=l;else if(l.startsWith("$")){y.className="macro-use";const _=l.replace(/\{.*/,""),D=[...A(this,Ze)].sort((R,S)=>S.length-R.length).find(R=>_.includes(R));if(D){const R=(l.match(/\{[^\}]*\}/)||[""])[0];y.macroUse=`${D}${R}`,w.push(y);const S=l.replace(D,"");S!==""&&(w=w.concat(d(S)));return}else y.macroUse=l}else if(l.startsWith(";")){if(t++,m&&!h){const _=[...o].join(" ");_&&(y.className="other-action",y.otherAction=_,w.push(y),o.clear())}c="",m=!1,h=!1;return}else y.className="other-action",y.otherAction=l;w.push(y)})(C),w),[]);this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((f,g)=>{g?f.remove():(f.textContent="",this.activeTrack=f)}),G=null;const E=r.map(d).flat();ke(this,me,E),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}get blocksData(){return A(this,me)}set blocksData(e){this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((r,a)=>{a?r.remove():(r.textContent="",this.activeTrack=r)}),G=null,ke(this,me,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData(),this.exportMml(Z),this.calcPlayFromHere()}playRendering(e=-1){const r=A(this,me);if(!r.length)return;const a=e!==-1,o=r[e],t=a?o.trackNo:-1;let c=120,m=0;[ue,Ee,re].forEach(C=>{C.classList.add("no-op")});const h=document.querySelector(".wrap"),d=document.getElementsByClassName("track"),f=(h.clientHeight-32)/d.length;[...d].forEach(C=>{C.style.setProperty("--max-height",`${f}px`)}),je.disabled=!0,rt.disabled=!0;const g=(C,{scoreNoteValue:M=4,ignorePlayFromHere:l=!1}={})=>{var X;let y=!1,_=-1,D=!1,R=!1;const S=[],$=performance.now(),V=(X=C[0])==null?void 0:X.trackNo,K=d[V],se=m++,ae=C.findIndex(j=>j===o);let he=null;const ge=new Promise(j=>he=j);let de=0,N=0;const k=j=>{if(!j)return M;const Q=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(j),J=Q&&Q[1]?Number(Q[1]):M,ce=Q?Q[2].length:0;return J*2**ce/(2**(ce+1)-1)},U=j=>{const Q=ce=>{!R&&K.scrollTo({top:ce,behavior:"smooth"}),R=!0,ei(K).then(()=>{R=!1})},J=ce=>K.clientHeight*ce;(N===0||j.elem.offsetTop>K.scrollTop+J(.8)||j.elem.offsetTop<K.scrollTop+J(.2))&&Q(j.elem.offsetTop-J(.2))},q=j=>{const Q=J=>{const ce=J-$,Te=60/c*4/j*1e3;ce<de+Te?A(this,et)[se]=requestAnimationFrame(Q):(de+=Te,W())};A(this,et)[se]=requestAnimationFrame(Q)},W=async()=>{var ce,Te,Ne;const j=C[N];if(!j||N>=C.length){he({scoreNoteValue:M});return}U(j);const Q=x=>{let B=0;return C.findIndex((H,Y)=>{var ee;if(Y>x+1){if((ee=H.repeatStartEnd)!=null&&ee.startsWith("/:"))B++;else if(H.repeatStartEnd===":/"){if(B===0)return!0;B--}}return!1})},J=!a||l||a&&j.trackNo===t&&N>=ae;if(D){j.macroDef===";"&&(D=!1),N++,W();return}else if(j.tonePitch)if(J&&Ce(j.elem,"bounce"),N++,y||!J)W();else{const x=k(j.tonePitch);q(x)}else if(j.rest||j.tieSlur)if(J&&Ce(j.elem,"pop"),N++,j.tieSlur==="&"||!J)W();else{const x=k(j.rest||j.tieSlur);q(x)}else if(j.polyStartEnd)if(y=j.polyStartEnd==="[",J&&Ce(j.elem,"pop"),y||!J)N++,W();else{const x=k(C[N++-1].tonePitch);q(x)}else if(j.macroDef&&j.macroDef!==";"){D=!0,N++,W();return}else{if(j.tempo&&(c=Number(j.tempo.replace("t",""))||c),j.noteValue&&(M=k(j.noteValue)),(ce=j.repeatStartEnd)!=null&&ce.startsWith("/:")){S[Te=++_]??(S[Te]={start:N});let x=j.repeatStartEnd.replace("/:","");if(x=x===""?2:Number(x),x)if(S[_].end){if(!S[_].remaining){j.elem.dataset.repeatStartEnd=`/:${S[_].remaining}`,N=S[_].end,W();return}C.slice(S[_].start+1,S[_].end-1).filter(B=>{var H;return(H=B.repeatStartEnd)==null?void 0:H.startsWith("/:")}).forEach(B=>{B.elem.dataset.repeatStartEnd=B.repeatStartEnd})}else S[_].remaining=x;else{N=Q(N),W(),J&&(Ce(j.elem,"pop"),Ce(j.elem,"done"));return}j.elem.dataset.repeatStartEnd=`/:${S[_].remaining}`}else if(j.repeatBreak){if(S[_].remaining===1){S[_].end||(S[_].end=Q(S[_].start)),N=S[_].end,W(),J&&(Ce(j.elem,"pop"),Ce(j.elem,"done"));return}}else if(j.repeatStartEnd===":/"){if((Ne=S[_]).end??(Ne.end=N),S[_].remaining){S[_].remaining--,N=S[_].start,_--,W(),J&&(Ce(j.elem,"pop"),Ce(j.elem,"done"));return}S.pop(),_--}else if(j.macroUse&&J){const x=H=>{const Y=r[H].trackNo;let ee=H+1;for(;r[ee].macroDef!==";"&&r[ee].trackNo===Y;)ee++;return ee},B={};if(B.start=r.findIndex(H=>{var Y;return(Y=H.macroDef)==null?void 0:Y.startsWith(j.macroUse)}),B.start>-1){B.end=x(B.start),B.blocks=r.slice(B.start+1,B.end);const H=performance.now();M=(await g(B.blocks,{scoreNoteValue:M,ignorePlayFromHere:!0})).scoreNoteValue;const Y=performance.now();de+=Y-H}}N++,W(),J&&Ce(j.elem,"pop")}J&&Ce(j.elem,"done")};return W(),ge},w=r.at(-1).trackNo+1;for(let C=0;C<w;C++){const M=r.filter(l=>l.trackNo===C);g(M)}}stopRendering(){[ue,Ee,re].forEach(e=>{e.classList.remove("no-op")}),je.disabled=!1,rt.disabled=!1,A(this,me).forEach(e=>{e.elem.classList.remove("done")}),A(this,me).filter(e=>{var r;return(r=e.repeatStartEnd)==null?void 0:r.startsWith("/:")}).forEach(e=>{e.elem.dataset.repeatStartEnd=e.repeatStartEnd}),A(this,et).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!A(this,me).length)return;const e=A(this,me).at(-1).trackNo+1;for(let r=0;r<e;r++)A(this,me).filter(o=>o.polyStartEnd&&o.trackNo===r).forEach((o,t)=>{t%2===0?(o.elem.dataset.polyStartEnd="[",o.elem.textContent="["):(o.elem.dataset.polyStartEnd="]",o.elem.textContent="]")});this.blocksDataUpdate()}calcPlayFromHere(){if(!A(this,me).length)return;A(this,me).filter(o=>o.elem.classList.contains("inactive")).forEach(o=>{o.elem.classList.remove("inactive")});const e=A(this,me).find(o=>o.elem.classList.contains("play-from-here"));if(!e){Le.disabled=We.disabled=!1;return}const r=A(this,me).indexOf(e);A(this,me).filter((o,t)=>o.playFromHere?!1:o.trackNo!==e.trackNo?!0:t<r).forEach(o=>{o.elem.classList.add("inactive")}),Le.disabled=We.disabled=!0}}me=new WeakMap,Ze=new WeakMap,et=new WeakMap,mt=new WeakMap,Ve=new WeakMap;var ve,Pt,ht,tt;class ii{constructor(){fe(this,ve,[[],[]]);fe(this,Pt,70);fe(this,ht,e=>{});fe(this,tt,e=>{})}set onPushstate(e){ke(this,ht,e)}set onPopstate(e){ke(this,tt,e)}pushState(e){A(this,ve)[0].push(e),A(this,ht).call(this,e),A(this,ve)[0].length>A(this,Pt)&&A(this,ve)[0].shift(),A(this,ve)[1].length=0,console.log(A(this,ve))}undo(){const e=A(this,ve)[0].pop();return A(this,tt).call(this,{reason:"undo",data:e}),e&&A(this,ve)[1].unshift(e),console.log(A(this,ve)),{canUndo:!!A(this,ve)[0].length,canRedo:!!A(this,ve)[1].length}}redo(){const e=A(this,ve)[1].shift();return A(this,tt).call(this,{reason:"redo",data:e}),e&&A(this,ve)[0].push(e),console.log(A(this,ve)),{canUndo:!!A(this,ve)[0].length,canRedo:!!A(this,ve)[1].length}}clear(){A(this,ve)[0].length=0,A(this,ve)[1].length=0,console.log(A(this,ve))}}ve=new WeakMap,Pt=new WeakMap,ht=new WeakMap,tt=new WeakMap;const Ae=[1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,384];let G=ue.querySelector("button"),Ir=!1,Me=!1;const Pe={timeStamp:-1,tempo:120,scoreNoteValue:"4"};let bn=null,En=!1,wt=null;const Cr=()=>{T.activeTrack.querySelectorAll("button").forEach(n=>{n.classList.remove("done")}),En=!1},Mt=()=>{if(clearTimeout(bn),G&&G.closest(".track")!==T.activeTrack){G=T.activeTrack.querySelector("button");return}let n=G;const e=()=>{const t=performance.measure("stepElapsed","stepPoint");performance.mark("stepPoint");const c=t.duration,h=(E=>{const f=60/Pe.tempo*4/E*1e3,{noteValue:g,dots:w}=Ae.reduce((C,M,l)=>{const y=Math.log2(f/(2*f-M));if(y<0||Number.isNaN(y))return C;const _=y-Math.floor(y);return _<C.smallerFractional?{noteValue:M,dots:Math.round(y),smallerFractional:_}:C},{noteValue:null,dots:null,smallerFractional:1});if(g+".".repeat(w)===Pe.scoreNoteValue)return"";if(String(g)===Pe.scoreNoteValue){const C=Pe.scoreNoteValue.match(/\.*/),M=C?C[0].length:0;return".".repeat(w-M)}else return g+".".repeat(w)})(c);(E=>{const f=wt;"tonePitch"in f.dataset?f.dataset.tonePitch=f.dataset.tonePitch+E:"rest"in f.dataset&&(f.dataset.rest="r"+E)})(h),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)};if(!n){if(En){console.log("end1");return}xe.stop(),e(),Pe.timeStamp=-1,wt=null,performance.clearMarks("stepPoint"),setTimeout(()=>{G=T.activeTrack.querySelector("button"),Cr()},2e3),En=!0,console.log("end2");return}(()=>{if("tonePitch"in n.dataset){n.dataset.tonePitch=n.dataset.tonePitch.match(/[><]*?[a-g]\+?/i)[0],Oe(n,{noteValue:"1..."}),n.classList.add("bounce");return}"rest"in n.dataset&&(n.dataset.rest="r"),n.classList.add("done")})();const a=()=>{var t;G=n=((t=n.parentElement.nextElementSibling)==null?void 0:t.firstElementChild)||null};if("tonePitch"in n.dataset||xe.stop(),!["tonePitch","rest"].some(t=>t in n.dataset)){if("tempo"in n.dataset){const t=Number(n.dataset.tempo.replace("t",""));Pe.tempo=t}else"noteValue"in n.dataset&&(Pe.scoreNoteValue=(n.dataset.noteValue.match(/[0-9]+\.*/)||[Pe.scoreNoteValue])[0]);a(),Mt(),console.log("end3");return}if((()=>{const t=60/Pe.tempo*4*1e3*1.825;bn=setTimeout(Mt,t)})(),!performance.getEntriesByName("stepPoint")[0]){performance.mark("stepPoint"),wt=n,a(),console.log("end4");return}e(),wt=n,a()};var pt,qe,jt,Bt,Rt,Ft,$t,Ut,Vt,Wt,zt;class si{constructor(e){fe(this,pt,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name",value:(e,r)=>r.ariaLabel},{label:"音の定義",type:"text",name:"tone-def",autofocus:!0,value:e=>e}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}],run:(e,r)=>{const{"tone-name":a}=r;a.insertAdjacentElement("afterend",li);const o=document.querySelector("emoji-picker");a.addEventListener("focus",()=>{o.classList.add("expaned")},{once:!0}),o.addEventListener("emoji-click",t=>a.value=t.detail.unicode)},on:{"set-tone":(e,r)=>{const{"tone-name":a,"tone-def":o}=r,t=e.className;document.querySelectorAll(`[class*="${t}"]`).forEach(c=>{c.ariaLabel=a,(!c.classList.contains("material-icons")||a!=="無調整")&&(c.classList.remove("material-icons"),c.textContent=a),c.dataset.tone=o})}}},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}],run:(e,r)=>{const{"tone-pitch":a}=r;A(this,qe).call(this,a)},on:{"set-tone-pitch":(e,r)=>{const{"tone-pitch":a,dot:o}=r;e.dataset.tonePitch=`${e.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]}${a}${".".repeat(o)}`}}},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0",value:e=>e.replace("t","")}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}],on:{"set-tempo":(e,r)=>{const{tempo:a}=r;e.dataset.tempo=`t${a}`}}},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}],run:(e,r)=>{const{"note-value":a}=r;A(this,qe).call(this,a)},on:{"set-note-value":(e,r)=>{const{"note-value":a,dot:o}=r;e.dataset.noteValue=`l${a}${".".repeat(o)}`}}},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}],run:(e,r)=>{const{rest:a}=r;A(this,qe).call(this,a)},on:{"set-rest":(e,r)=>{const{rest:a,dot:o}=r;e.dataset.rest=`r${a}${".".repeat(o)}`}}},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8",value:e=>e.startsWith("o")?e.replace("o",""):(e.match(/[><]+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}],on:{"set-octave":(e,r)=>{const{octave:a}=r;e.dataset.octave=`o${a}`},"set-octave-relative":(e,r)=>{const{octave:a}=r;e.dataset.octave=(a>0?"<":">").repeat(Math.abs(a))}}},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127",value:e=>e.startsWith("@v")?e.replace("@v",""):Number((e.match(/[0-9]+/)||[""])[0])*(e.startsWith("(")?1:-1)}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}],on:{"set-velocity":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=`@v${a}`},"set-velocity-relative":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=(a>0?"(":")").repeat(Math.abs(a))}}},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift",value:e=>(e.match(/[0-9]+/)||[""])[0]}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}],on:{"set-note-shift":(e,r)=>{const{"note-shift":a}=r;e.dataset.noteShift=`ns${a}`},"set-note-shift-relative":(e,r)=>{const{noteShift:a}=r;e.dataset.noteShift=`@ns${a}`}}},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune",value:e=>e.replace("@d","")}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}],on:{"set-detune":(e,r)=>{const{detune:a}=r;e.dataset.detune=`@d${a}`}}},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}],run:(e,r)=>{const{"tie-slur":a}=r;A(this,qe).call(this,a)},on:{"set-tie-slur":(e,r)=>{const{"tie-slur":a,dot:o}=r;e.dataset.tieSlur=`&${a}${".".repeat(o)}`,e.dataset.tieSlur==="&"?e.ariaLabel="スラー":e.ariaLabel="タイ"}}},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0",value:e=>e.replace("/:","")}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}],on:{"set-repeat":(e,r)=>{const{repeat:a}=r;e.dataset.repeatStartEnd=`/:${a}`}}},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name",value:e=>(e.match(/\$([^\{\=]*)/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}],on:{"set-macro-def":(e,r)=>{const{"macro-def-name":a,"macro-def-arg":o}=r;e.dataset.macroDef=`$${a}${o?`{${o}}`:""}=`;const t=(e.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];re.querySelectorAll(`[data-macro-use^="${t}"]`).forEach(c=>{c.dataset.macroUse=c.dataset.macroUse.replace(t,`$${a}`)})}}},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use",value:e=>e.replace("%","")}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}],run:(e,r)=>{const{"macro-arg-use":a}=r,t=(()=>{let E=this.item.parentElement;for(;E&&!E.firstElementChild.dataset.macroDef;)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null})();if(!t||t.dataset.macroDef===";")return;const h=(t.dataset.macroDef.match(/\{([^\}]*)\}/)||[,""])[1].split(","),d=document.createElement("datalist");d.id="macro-arg-use-list",h.forEach(E=>{const f=document.createElement("option");f.value=E,d.appendChild(f)}),a.after(d),a.setAttribute("list","macro-arg-use-list")},on:{"set-macro-arg-use":(e,r)=>{const{"macro-arg-use":a}=r;e.dataset.macroArgUse=`%${a}`}}},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name",value:e=>(e.match(/\$([^\{]*)\{?/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}],run:(e,r)=>{const{"macro-use-name":a}=r,o=document.createElement("datalist");o.id="macro-use-name-list",T.blocksData.filter(c=>c.macroDef&&c.macroDef!==";").map(c=>c.macroDef.replace("=","")).forEach(c=>{const m=document.createElement("option");m.label=(c.match(/\{[^\}]*\}/)||[""])[0],m.value=(c.match(/\$([^\{]*)\{?/)||[,""])[1],o.appendChild(m)}),a.after(o),a.setAttribute("list","macro-use-name-list")},on:{"set-macro-use":(e,r)=>{const{"macro-use-name":a,"macro-use-arg":o}=r;e.dataset.macroUse=`$${a}${o?`{${o}}`:""}`}}},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}],run:(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r,c=e.split(" "),m=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let h=m.findIndex(w=>c[0].startsWith(w));h===-1&&(h=0),a.selectedIndex=h;const d=w=>w.previousSibling,E=()=>a.selectedOptions[0],f=(w,C)=>{d(o).nodeValue=w[0],o.value=w[1],o.parentElement.style.display=w[2]?"none":"",d(t).nodeValue=C[0],t.value=C[1],t.parentElement.style.display=C[2]?"none":""},g=w=>{var l,y,_;const C=w===h,M=m[w];switch(M){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const D=C?c.slice(1).join(" ")??"":"";f(["無効","",!0],[E().label,D,!1]);break;case"#OCTAVE":case"#VELOCITY":f(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const R=M==="#WAV9",S=C?((l=c.slice(1).join(" "))==null?void 0:l.split(","))??[]:[];f(["波形番号",S[0]??0,!1],R?["初期変位,ループフラグ,データ",`${S[1]??0},${S[2]??0},${S[3]??""}`,!1]:["データ",S[1]??"",!1]),o.min=0,o.max=R?15:31;break;case"#OPM":case"#OPN":f(["音色番号",C?((y=c[0])==null?void 0:y.split("@")[1])??0:0,!1],["データ",C?((_=c.slice(1).join(" "))==null?void 0:_.slice(1,-1))??"":"",!1]),o.min=0,o.max=127;break;case"#FMGAIN":f(["音量利得",C?c[1].replace(`
`,"")??91:91,!1],["無効","",!0]),o.min=-127,o.max=127;break;case"#USING":f(["和音重ね数",C?c[2].replace(`
`,"")??2:2,!1],["無効","",!0]),o.min=1,o.max="";break}};g(h),a.addEventListener("change",w=>{g(w.target.selectedIndex)})},on:{"set-meta-data":(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r;e.ariaLabel=a.label,e.dataset.metaData=`${a.value.replace("{n}",o).replace("{desc}",t)}`}}},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action",value:e=>e}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}],on:{"set-other-action":(e,r)=>{const{"other-action":a}=r;e.dataset.otherAction=a,e.textContent=a.length>4?"…":a}}},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}],on:{"remove-left":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(G=null;[...o].includes(r);){const t=a.firstElementChild;be.pushState({operation:"remove",removedElem:t,removedIndex:0,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere()},"remove-right":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(G=null;[...o].includes(r);){const t=a.lastElementChild;be.pushState({operation:"remove",removedElem:t,removedIndex:o.length-1,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere()}}},step:{title:"ステップ音価記録",description:`ステップ音価記録は、簡単に音価を指定できる機能です。

各トラックの空白部分をテンポよくクリック、またはスペースキーを押して最初の音符から順に音価を決定します。
途中から指定をやり直したいときは、やり直したい音符をクリックすることでそこからやり直せます。

この画面は、Shiftキーを押しながらステップ音価記録ブロックをクリックすることで再度表示できます。`,buttons:[{className:"primaly",value:"set-step",textContent:"開始"},{value:"cancel-step",textContent:"やめる"}],on:{"set-step":()=>{Ir=!0,Me=!0},"cancel-step":()=>{Me=!1}}}});fe(this,qe,e=>{let r=e.valueAsNumber,a=Ae.findIndex(o=>o===r);e.addEventListener("input",()=>{const o=e.valueAsNumber;o!==r&&(o===0?(a=-1,e.value=""):o>r||Number.isNaN(r)?e.value=Ae[++a]:o<r&&(e.value=Ae[--a]),r=e.valueAsNumber)})});fe(this,jt,e=>{const r=A(this,pt)[e];A(this,Bt).call(this,r.title),A(this,Rt).call(this,r.description),A(this,Ft).call(this,r.inputs),A(this,$t).call(this,r.buttons),A(this,Ut).call(this,r.run),A(this,Vt).call(this,r.on)});fe(this,Bt,e=>{Se._title.textContent=e||""});fe(this,Rt,e=>{if(Se.description.textContent="",e){const r=document.createElement("p");r.innerText=e,Se.description.appendChild(r)}});fe(this,Ft,e=>{Se.inputs.textContent="",e==null||e.forEach(r=>{const a=document.createElement("input");let o=a;Object.entries(r).forEach(([t,c])=>{if(t==="label"){const m=document.createElement("label");m.textContent=c,m.appendChild(a),o=m}else if(t==="select"){const m=document.createElement("select");m.name=r.name,Object.entries(c).forEach(([h,d])=>{const E=document.createElement("option");E.value=h,E.textContent=d,m.appendChild(E)}),a.replaceWith(m)}else t==="value"&&typeof c=="function"?a.value=c(this.mmlText,this.item):a[t]=c}),Se.inputs.appendChild(o)})});fe(this,$t,e=>{Se.buttons.textContent="",e==null||e.forEach(r=>{const a=document.createElement("button");Object.entries(r).forEach(([o,t])=>{a[o]=t}),Se.buttons.appendChild(a)})});fe(this,Ut,e=>{e&&e(this.mmlText,A(this,Wt).call(this))});fe(this,Vt,e=>{Se.addEventListener("submit",r=>{const a=this.item,o=r.submitter.value,t=A(this,zt).call(this),c=JSON.parse(JSON.stringify(a.dataset));console.log(o),e[o](a,t);const m=JSON.parse(JSON.stringify(a.dataset));JSON.stringify(c)!==JSON.stringify(m)&&be.pushState({operation:"valueChange",target:a,beforeChange:c,afterChange:m}),this.resolve()},{once:!0})});fe(this,Wt,()=>Object.fromEntries([...Se.elements].map(e=>[e.name,e])));fe(this,zt,()=>Object.fromEntries([...Se.elements].map(r=>r instanceof HTMLSelectElement?[r.name,{label:r.selectedOptions[0].label,value:r.value}]:[r.name,r.value])));this.item=null,this.type=null,this.mmlText=null,this.resolve=null}async prompt(e,r){switch(this.item=e,this.type=r||Object.keys(A(this,pt)).find(a=>a in e.dataset),this.mmlText=e.dataset[this.type],this.type){case"repeatStartEnd":if(this.mmlText===":/"){const o=(()=>{var c;let t=e.parentElement;for(;t&&!((c=t.firstElementChild.dataset.repeatStartEnd)!=null&&c.startsWith("/:"));)t=t.previousElementSibling;return(t==null?void 0:t.firstElementChild)||null})();if(o)e=o;else{const t=T.activeTrack,c=document.createElement("li"),h=Ee.querySelector(".repeat-start-end").cloneNode(!0);c.appendChild(h),t.insertBefore(c,e.parentElement),e=h}this.mmlText=e.dataset.repeatStartEnd}break;case"macroDef":if(this.mmlText===";")return;break}return A(this,jt).call(this,this.type),He.showModal(),new Promise(a=>this.resolve=a)}}pt=new WeakMap,qe=new WeakMap,jt=new WeakMap,Bt=new WeakMap,Rt=new WeakMap,Ft=new WeakMap,$t=new WeakMap,Ut=new WeakMap,Vt=new WeakMap,Wt=new WeakMap,zt=new WeakMap;ir.FlMML.prepare(".editor");const xe=new ir.FlMML({workerURL:ya}),Z=new ai;un.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const T=new oi(ue,re),be=new ii,Ue=new si(Se),ci={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},li=new In({i18n:ci,locale:"ja"});Xo.polyfill({holdToDrag:500});Zo();const dt=n=>`<span class="material-icons">${n}</span>`,Dr=dt("play_arrow")+"再生",ui=dt("stop")+"停止",Sn=()=>{const n=[...re.querySelectorAll(".track button")].findIndex(e=>e.classList.contains("play-from-here"));T.playRendering(n)},di=()=>{ni.innerText=xe.getWarnings()};xe.addEventListener("compilecomplete",di);const fi=()=>{Dt.innerHTML=Dr,T.stopRendering(),xe.removeEventListener("compilecomplete",Sn),At.disabled=!1};xe.addEventListener("complete",fi);Z.onChange=(n,e)=>{ri.innerHTML=e?`<pre><code>${Qo(e).replaceAll(`
`,"<br>")}</code></pre>`:"(なし)";const r=!!n.length;Le.disabled=We.disabled=!r};Z.onError=(n,e)=>{alert(n+`
`+e)};T.checkSavedBlocksData();const Oe=(n,e={})=>{var l;const r=()=>{let y=n.parentElement;for(;y&&!("noteValue"in y.firstElementChild.dataset);)y=y.previousElementSibling;return(y==null?void 0:y.firstElementChild)||null},a=()=>{var _;let y=n.parentElement;for(;y&&!((_=y.firstElementChild.dataset.octave)!=null&&_.startsWith("o"));)y=y.previousElementSibling;return(y==null?void 0:y.firstElementChild)||null},o=()=>{var D;let y=n.parentElement.nextElementSibling,_="";for(;y&&((D=y.firstElementChild.dataset.tieSlur)!=null&&D.match(/&[0-9]+\.*/));)_+=y.firstElementChild.dataset.tieSlur,y=y.nextElementSibling;return _},t=((l=r())==null?void 0:l.dataset.noteValue)||"",c=a(),m=c?[...T.activeTrack.children].indexOf(c.parentElement):0,h=(c==null?void 0:c.dataset.octave)||"",d=[...T.activeTrack.children].indexOf(n.parentElement),E=[...T.activeTrack.children].slice(m,d).filter(y=>"tonePitch"in y.firstElementChild.dataset||"octave"in y.firstElementChild.dataset&&!y.firstElementChild.dataset.octave.startsWith("o")).map(y=>((y.firstElementChild.dataset.tonePitch||y.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),f={down:">",up:"<"},g=(y,_)=>(y.match(new RegExp(_,"g"))||[]).length,w=(()=>{const y=-g(E,f.down)+g(E,f.up);return y<0?f.down.repeat(-y):y>0?f.up.repeat(y):""})(),C=o(),M=e.noteValue?n.dataset.tonePitch.replace(/[0-9]+\.*/,"")+e.noteValue:n.dataset.tonePitch;xe.play(n.dataset.tone+t+h+w+M+C)};be.onPopstate=n=>{const e=n.data,r=a=>!!e.parent.closest("#"+a);switch(n.reason){case"undo":switch(e==null?void 0:e.operation){case"append":Z.delete(e.index);break;case"delete":Z.insert(e.index,e.mmlText);break;case"rewrite":Z.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere());break;case"move":const a=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(a,e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere());break;case"valueChange":for(const[o,t]of Object.entries(e.beforeChange))e.target.dataset[o]=t;"tone"in e.target.dataset&&Oe(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere());break;case"clear":e.tonesChildren.forEach(o=>{ue.querySelector("ul").appendChild(o)}),e.musicalScoreChildren.forEach(o=>{re.insertBefore(o,je)}),G=e.lastTouchedButton,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":Z.append(e.mmlText);break;case"delete":Z.delete(e.index);break;case"rewrite":Z.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere()),"tonePitch"in G.dataset&&(Oe(G),G.classList.add("bounce"));break;case"move":const a=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(a,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere());break;case"valueChange":for(const[t,c]of Object.entries(e.afterChange))e.target.dataset[t]=c;"tone"in e.target.dataset&&Oe(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);break;case"remove":const o=e.removedElem.className;e.removedElem.remove(),r("tones")&&re.querySelectorAll(`[class*="${o}"]`).forEach(t=>{t.parentElement.remove()}),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere();break;case"clear":ue.querySelector("ul").textContent="",re.querySelectorAll(".track").forEach((t,c)=>{c?t.remove():(t.textContent="",T.activeTrack=t)}),G=null,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);break}break}};const Ar=()=>{const n=[...ue.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!n.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",n=>{var r;const e=n.ctrlKey||Ht.checked;switch((r=n.key)==null?void 0:r.toLowerCase()){case" ":Me?(n.preventDefault(),Mt()):document.activeElement.tagName.toLowerCase()!=="input"&&(n.preventDefault(),Dt.click());break;case"s":e&&(n.preventDefault(),!We.disabled&&We.click());break;case"o":e&&(n.preventDefault(),!yn.disabled&&yn.click());break;case"z":e&&be.undo();break;case"y":e&&be.redo();break}});ze.addEventListener("click",async n=>{const e=n.ctrlKey||Ht.checked,r=o=>!!n.target.closest("#"+o),a=n.target.tagName.toLowerCase()==="button";if(![ue,Ee,re].some(o=>o.classList.contains("no-op"))){if(r("tones"))if(a)G=n.target,await Ue.prompt(n.target,"tone"),xe.play(n.target.dataset.tone+n.target.dataset.tonePitch),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);else{const o=ue.querySelector("ul"),t=document.createElement("li"),m=`<button class="material-icons note ${Ar()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;t.innerHTML=m;const h=t.firstElementChild;o.appendChild(t),G=h,xe.play(h.dataset.tone+h.dataset.tonePitch),be.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o})}else if(r("action")){if(a){if("otherAction"in n.target.dataset)await Ue.prompt(n.target);else if("step"in n.target.dataset){Ir&&!n.shiftKey?Me=!Me:await Ue.prompt(n.target),Me?(n.target.classList.add("enable"),n.target.ariaLabel="ステップ音価記録(有効)",G=T.activeTrack.querySelector("button")):(n.target.classList.remove("enable"),n.target.ariaLabel="ステップ音価記録(無効)",Cr(),xe.stop(),clearTimeout(bn));return}const o=T.activeTrack,t=document.createElement("li"),c=n.target.cloneNode(!0);if(["metaData","macroDef","macroUse"].some(m=>m in c.dataset)&&await Ue.prompt(c),"tieSlur"in c.dataset?c.ariaLabel="スラー":"repeatStartEnd"in c.dataset?(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"):"polyStartEnd"in c.dataset?(c.dataset.polyStartEnd="[",c.textContent="["):"macroDef"in c.dataset?c.textContent="$=":"playFromHere"in c.dataset&&(re.querySelectorAll(".track button").forEach(m=>{m.classList.add("inactive")}),Le.disabled=We.disabled=!0),t.appendChild(c),o.appendChild(t),G=c,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere(),be.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),["repeatStartEnd","polyStartEnd","macroDef"].some(m=>m in G.dataset)){const m=document.createElement("li"),h=n.target.cloneNode(!0);"repeatStartEnd"in G.dataset?(h.ariaLabel="リピート終了",h.dataset.repeatStartEnd=":/"):"polyStartEnd"in G.dataset?(h.dataset.polyStartEnd="]",h.textContent="]"):"macroDef"in G.dataset&&(h.dataset.macroDef=";",h.textContent=";"),m.appendChild(h),G.parentElement.insertAdjacentElement("afterend",m),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z),be.pushState({operation:"copy",toIndex:-1,newElem:m,parent:o})}}}else if(r("musical-score")){if(a&&n.target!==je&&n.target!==rt)n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Me||("tone"in n.target.dataset?(Oe(n.target),Ce(n.target,"bounce"),e&&(await Ue.prompt(n.target,"tonePitch"),Oe(n.target))):await Ue.prompt(n.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)),G=n.target;else if(n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Me)Mt();else if(G){const o=T.activeTrack,t=document.createElement("li"),c=G.cloneNode(!0);if("repeatStartEnd"in c.dataset&&(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"+(c.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),t.appendChild(c),o.appendChild(t),G=c,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere(),be.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),"tonePitch"in c.dataset)c.dataset.tonePitch=c.dataset.tonePitch.replace(/[><]+/,""),Oe(c),c.classList.add("bounce");else if("repeatStartEnd"in G.dataset){const m=document.createElement("li"),h=G.cloneNode(!0);h.classList.add("material-icons"),h.ariaLabel="リピート終了",h.textContent="repeat",h.dataset.repeatStartEnd=":/",m.appendChild(h),G.parentElement.insertAdjacentElement("afterend",m),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z),be.pushState({operation:"copy",toIndex:-1,newElem:m,parent:o})}}}}});ze.addEventListener("contextmenu",n=>{var o,t,c,m;if(Me)return;const e=h=>h.closest("#tones, #musical-score"),r=h=>!!n.target.closest("#"+h),a=n.target.tagName.toLowerCase()==="button";if(!((o=e(n.target))!=null&&o.classList.contains("no-op"))&&e(n.target)){const h=a&&n.target!==je&&n.target!==rt?n.target:G;if(!h||e(h)!==e(n.target))return;n.preventDefault(),T.activeTrack=h.closest(".track")||T.activeTrack;const d=h.parentElement,E=h.className,f=((t=h.closest("#tones"))==null?void 0:t.querySelector("ul"))||T.activeTrack,g=[...f.children].indexOf(d);if(G=((c=d.previousElementSibling)==null?void 0:c.firstElementChild)||((m=d.nextElementSibling)==null?void 0:m.firstElementChild)||null,be.pushState({operation:"remove",removedElem:d,removedIndex:g,parent:f}),r("tones"))re.querySelectorAll(`[class*="${E}"]`).forEach(w=>{w.parentElement.remove()});else if("macroDef"in h.dataset){const w=(h.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];re.querySelectorAll(`[data-macro-use^="${w}"]`).forEach(C=>{C.parentElement.remove()})}else"playFromHere"in h.dataset&&(re.querySelectorAll(".inactive").forEach(w=>{w.classList.remove("inactive")}),Le.disabled=We.disabled=!1);d.remove(),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere()}});let kt=null,Cn=!1,Ot=null;ze.addEventListener("touchstart",n=>{kt=[...n.touches].at(-1).pageY,Ot=setTimeout(()=>{Cn=!0},500)});const Lr=n=>{if(Me)return;const e=n.ctrlKey||Ht.checked,r=c=>!!n.target.closest("#"+c),a=n.target.tagName.toLowerCase()==="button";if(n.type==="touchmove"){const c=[...n.touches].at(-1).pageY;if(Cn){n.cancelable&&n.preventDefault();return}else if(c-kt<-30)n.deltaY=-1,clearTimeout(Ot);else if(c-kt>30)n.deltaY=1,clearTimeout(Ot);else{n.cancelable&&n.preventDefault();return}kt=c}const o=n.deltaY<0;let t=a&&n.target!==je&&n.target!==rt?n.target:(G==null?void 0:G.closest("#musical-score"))&&G;if(t){if(r("musical-score")){if(re.classList.contains("no-op"))return;n.preventDefault();let c=JSON.parse(JSON.stringify(t.dataset));if(!e&&"tone"in t.dataset){const h=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],d={down:">",up:"<"},E=t.dataset.tonePitch,f=h.findIndex(y=>E.match(/[a-g]\+?/)[0]===y),g=(y,_)=>(y.match(new RegExp(_,"g"))||[]).length,w={down:g(E,d.down),up:g(E,d.up)},C=d.down.repeat(w.down)+d.up.repeat(w.up),M=(E.match(/[0-9]+/)||[""])[0],l=(t.dataset.tonePitch.match(/\.+/)||[""])[0];o?f===h.length-1?w.down?t.dataset.tonePitch=C.substring(1)+h.at(0)+M+l:t.dataset.tonePitch=C+d.up+h.at(0)+M+l:t.dataset.tonePitch=C+h[f+1]+M+l:f===0?w.up?t.dataset.tonePitch=C.substring(1)+h.at(-1)+M+l:t.dataset.tonePitch=C+d.down+h.at(-1)+M+l:t.dataset.tonePitch=C+h[f-1]+M+l,Oe(t)}else{const h=o?1:-1,d=(E,f=-1/0,g=1/0)=>E+h<f||E+h>g?0:h;if(e&&"tonePitch"in t.dataset){const E=Number((t.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),f=(t.dataset.tonePitch.match(/\.+/)||[""])[0],g=d(E,0,384),w=Ae.findIndex(M=>M===E),C=E+g!==0?Ae[w+g]:"";t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+C+f,Oe(t)}else if("tempo"in t.dataset){const E=Number(t.dataset.tempo.replace("t","")),f=d(E,0);t.dataset.tempo="t"+(E+f*10)}else if("noteValue"in t.dataset){const E=Number((t.dataset.noteValue.match(/[0-9]+/)||[""])[0]),f=d(E,1,384),g=Ae.findIndex(w=>w===E);t.dataset.noteValue=t.dataset.noteValue.replace(/[0-9]+/,Ae[g+f])}else if("rest"in t.dataset){const E=Number((t.dataset.rest.match(/[0-9]+/)||[""])[0]),f=(t.dataset.rest.match(/\.+/)||[""])[0],g=d(E,0,384),w=Ae.findIndex(M=>M===E),C=E+g!==0?Ae[w+g]:"";t.dataset.rest="r"+C+f}else if("octave"in t.dataset)if(t.dataset.octave.startsWith("o")){const f=Number(t.dataset.octave.replace("o","")),g=d(f,0,8);t.dataset.octave="o"+(f+g)}else{const f=(t.dataset.octave.match(/<+/)||[""])[0].length-(t.dataset.octave.match(/>+/)||[""])[0].length,g=d(f,-8,8);t.dataset.octave=f+g>0?"<".repeat(f+g):">".repeat(-(f+g))}else if("velocity"in t.dataset)if(t.dataset.velocity.startsWith("@v")){const f=Number(t.dataset.velocity.replace("@v","")),g=d(f,0,127);t.dataset.velocity="@v"+(f+g)}else{const f=Number((t.dataset.velocity.match(/[0-9]+/)||[""])[0])*(t.dataset.velocity.startsWith("(")?1:-1),g=d(f,-127,127);t.dataset.velocity=(f+g>=0?"(":")")+Math.abs(f+g)}else if("noteShift"in t.dataset){const E=Number((t.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),f=h;t.dataset.noteShift=t.dataset.noteShift.match(/@?ns/)[0]+(E+f)}else if("detune"in t.dataset){const E=Number(t.dataset.detune.replace("@d","")),f=h;t.dataset.detune="@d"+(E+f)}else if("tieSlur"in t.dataset){const E=Number((t.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),f=(t.dataset.tieSlur.match(/\.+/)||[""])[0],g=d(E,0,384),w=Ae.findIndex(M=>M===E),C=E+g!==0?Ae[w+g]:"";t.dataset.tieSlur="&"+C+f,t.dataset.tieSlur==="&"?t.ariaLabel="スラー":t.ariaLabel="タイ"}else if("repeatStartEnd"in t.dataset){if(t.dataset.repeatStartEnd===":/"){const C=(()=>{var l;let M=t.parentElement;for(;M&&!((l=M.firstElementChild.dataset.repeatStartEnd)!=null&&l.startsWith("/:"));)M=M.previousElementSibling;return(M==null?void 0:M.firstElementChild)||null})();if(C)t=C;else{const M=T.activeTrack,l=document.createElement("li"),_=Ee.querySelector(".repeat-start-end").cloneNode(!0);l.appendChild(_),M.insertBefore(l,t.parentElement),t=_}c=JSON.parse(JSON.stringify(t.dataset))}const E=Number((t.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),f=d(E,-1),g=E+f!==-1?E+f:"";t.dataset.repeatStartEnd="/:"+g}}const m=JSON.parse(JSON.stringify(t.dataset));JSON.stringify(c)!==JSON.stringify(m)&&be.pushState({operation:"valueChange",target:t,beforeChange:c,afterChange:m}),G=t,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)}}else return};ze.addEventListener("wheel",Lr);ze.addEventListener("touchmove",Lr);ze.addEventListener("touchend",()=>{clearTimeout(Ot),Cn=!1});let lt={};ze.addEventListener("dragstart",n=>{lt={from:n.target.nodeType===1&&n.target.closest("#tones, #action, #musical-score"),item:n.target},n.dataTransfer.effectAllowed="copyMove"});let ar=null;[ue,Ee,re].forEach(n=>{const e=t=>{const c=t.ctrlKey||Ht.checked,{from:m=null}=lt,h=t.dataTransfer;switch(m){case ue:switch(n){case ue:t.preventDefault(),c?h.dropEffect="copy":h.dropEffect="move";break;case Ee:break;case re:t.preventDefault(),h.dropEffect="copy";break}break;case Ee:switch(n){case ue:break;case Ee:break;case re:t.preventDefault(),h.dropEffect="copy";break}break;case re:switch(n){case ue:break;case Ee:break;case re:t.preventDefault(),c?h.dropEffect="copy":h.dropEffect="move";break}break}ar=h.dropEffect};n.addEventListener("dragover",e);const r=t=>{const{from:c=null}=lt,m=t.target.tagName.toLowerCase()==="button",h=()=>t.target.classList.add("droppable");switch(c){case ue:switch(n){case ue:t.preventDefault(),m&&h();break;case Ee:break;case re:t.preventDefault(),m&&h();break}break;case Ee:switch(n){case ue:break;case Ee:break;case re:t.preventDefault(),m&&h();break}break;case re:switch(n){case ue:break;case Ee:break;case re:t.preventDefault(),m&&h();break}break}};n.addEventListener("dragenter",r);const a=t=>{const{from:c=null}=lt,m=t.target.tagName.toLowerCase()==="button",h=()=>t.target.classList.remove("droppable");switch(c){case ue:switch(n){case ue:m&&h();break;case Ee:break;case re:m&&h();break}break;case Ee:switch(n){case ue:break;case Ee:break;case re:m&&h();break}break;case re:switch(n){case ue:break;case Ee:break;case re:m&&h();break}break}};n.addEventListener("dragleave",a),n.addEventListener("drop",async t=>{var w,C;if(t.preventDefault(),(w=t.dataTransfer.items)!=null&&w.length)return;t.dataTransfer.dropEffect=t.dataTransfer.dropEffect!=="none"?t.dataTransfer.dropEffect:ar;const{from:c,item:m}=lt,h=((C=t.target.closest("#tones"))==null?void 0:C.querySelector("ul"))||t.target.closest(".track")||T.activeTrack,d=[...n.querySelectorAll("button")].indexOf(m),E=[...n.querySelectorAll("button")].indexOf(t.target),f=t.target.tagName.toLowerCase()==="button";let g;switch(t.dataTransfer.dropEffect){case"copy":const M=document.createElement("li"),l=m.cloneNode(!0);if(n===ue){const y=[...m.classList].find(_=>_.includes("note-"));l.classList.replace(y,Ar())}else c===Ee&&("tieSlur"in l.dataset?l.ariaLabel="スラー":["metaData","macroDef","macroUse","otherAction"].some(y=>y in l.dataset)&&await Ue.prompt(l));"repeatStartEnd"in l.dataset?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"+(l.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in l.dataset?(l.dataset.polyStartEnd="[",l.textContent="["):"macroDef"in l.dataset&&(l.dataset.macroDef===";"&&(l.dataset.macroDef="$="),l.textContent="$="),M.appendChild(l),g=M;break;case"move":g=m.parentElement;break}if(f&&t.target.id!=="add-track"&&t.target.id!=="remove-track"){const M=t.dataTransfer.dropEffect==="copy"||E<d?"beforebegin":"afterend";t.target.parentElement.insertAdjacentElement(M,g)}else h.appendChild(g);switch(G=g.firstElementChild,n===re&&(T.activeTrack=h,T.blocksDataUpdate(),t.dataTransfer.dropEffect==="move"&&T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere(),"tonePitch"in G.dataset&&(G.dataset.tonePitch=G.dataset.tonePitch.replace(/[><]+/,""),Oe(G),G.classList.add("bounce"))),t.dataTransfer.dropEffect){case"copy":be.pushState({operation:"copy",toIndex:E,newElem:g,parent:h});break;case"move":be.pushState({operation:"move",fromIndex:d,toIndex:E,elem:g,parent:h});break}if(t.dataTransfer.dropEffect==="copy"&&["repeatStartEnd","polyStartEnd","macroDef"].some(M=>M in G.dataset)){const M=document.createElement("li"),l=m.cloneNode(!0);"repeatStartEnd"in G.dataset?(l.classList.add("material-icons"),l.ariaLabel="リピート終了",l.textContent="repeat",l.dataset.repeatStartEnd=":/"):"polyStartEnd"in G.dataset?(l.dataset.polyStartEnd="]",l.textContent="]"):"macroDef"in G.dataset&&(l.dataset.macroDef=";",l.textContent=";"),M.appendChild(l),g.insertAdjacentElement("afterend",M),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z),be.pushState({operation:"copy",toIndex:E+1,newElem:M,parent:h})}});const o=t=>{[...document.getElementsByClassName("droppable")].forEach(c=>{c.classList.remove("droppable")})};n.addEventListener("dragend",o)});ze.addEventListener("animationend",n=>{n.target.classList.remove("bounce"),n.target.classList.remove("pop")});je.addEventListener("click",n=>{n.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),T.activeTrack=e,re.insertBefore(e,je)});rt.addEventListener("click",n=>{n.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),T.activeTrack=r,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)});He.addEventListener("pointerdown",n=>{n.target===He&&He.addEventListener("pointerup",e=>{e.target===He&&He.close()},{once:!0})});He.addEventListener("close",()=>{switch(Ue.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});Dt.addEventListener("click",()=>{const n=xe.isPlaying();n?(xe.stop(),T.stopRendering(),xe.removeEventListener("compilecomplete",Sn),At.disabled=!1):(xe.play(Z.getMml()),xe.addEventListener("compilecomplete",Sn),At.disabled=!0),Dt.innerHTML=n?Dr:ui});At.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const n=[...re.children];n.pop(),be.pushState({operation:"clear",tonesChildren:[...ue.querySelector("ul").children],musicalScoreChildren:n,lastTouchedButton:G}),ue.querySelector("ul").textContent="";const e=ue.querySelector("ul"),r=document.createElement("li"),a='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=a;const o=r.firstElementChild;e.appendChild(r),G=o,re.querySelectorAll(".track").forEach((t,c)=>{c?t.remove():(t.textContent="",T.activeTrack=t)}),xe.play(""),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)}});Le.addEventListener("click",async n=>{const e=n.shiftKey?JSON.stringify(T.blocksData):Z.getMml(),r=Le.innerHTML;Le.disabled=!0,navigator.clipboard.writeText(e).then(()=>{Le.disabled=!0,Le.innerHTML=dt("content_copy")+"コピーしました",n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータをコピーしました。"),setTimeout(()=>{Le.innerHTML=r,Le.disabled=!1},1500)}).catch(a=>alert(`コピーできませんでした
`+a))});$e.addEventListener("click",()=>{const n=$e.innerHTML;$e.disabled=!0,navigator.clipboard.readText().then(e=>{$e.disabled=!0,e?(gn(e)?T.blocksData=JSON.parse(e):(Z.setMml(e.replace(/\r/g,"")),T.importMml(Z)),$e.innerHTML=dt("content_paste")+"貼り付けました",gn(e)&&alert("JSONブロックデータが貼り付けられました。")):$e.innerHTML=dt("content_paste")+"内容がありません",setTimeout(()=>{$e.innerHTML=n,$e.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});We.addEventListener("click",n=>{var c;const r=((c=Z.getMmlArr().find(m=>m.startsWith("#TITLE")))==null?void 0:c.split(" ").slice(1).join(" "))??"無題",a=n.shiftKey?JSON.stringify(T.blocksData):Z.getMml(),o=new Blob([a],{type:n.shiftKey?"application/json":"text/plain"}),t=document.createElement("a");t.download=r+(n.shiftKey?".json":".mml"),t.href=URL.createObjectURL(o),t.click(),URL.revokeObjectURL(t.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。"),n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータを保存しました。")});yn.addEventListener("click",()=>{const n=document.createElement("input"),e=new FileReader;n.type="file",n.accept=".mml,.flmml,.txt,.json",n.click(),n.onchange=()=>{e.onload=()=>{const r=e.result;gn(r)?(T.blocksData=JSON.parse(r),alert("JSONブロックデータが読み込まれました。")):(Z.setMml(r.replace(/\r/g,"")),T.importMml(Z))},e.readAsText(n.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");be.onPushstate=n=>{Lt.disabled=!1,_t.disabled=!0};Lt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=be.undo();Lt.disabled=!n,_t.disabled=!e});_t.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=be.redo();Lt.disabled=!n,_t.disabled=!e});
