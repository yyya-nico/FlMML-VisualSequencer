var $n=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var R=(t,e,r)=>($n(t,e,"read from private field"),r?r.call(t):e.get(t)),Te=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},Ce=(t,e,r,o)=>($n(t,e,"write to private field"),o?o.call(t,r):e.set(t,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function r(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(i){if(i.ep)return;i.ep=!0;const n=r(i);fetch(i.href,n)}})();const ua="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var at=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function da(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Jn={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(t,e){(function(r,o){t.exports=o()})(self,function(){return(()=>{var r={587:(n,c,p)=>{var m;(m=(function(l,g){Object.defineProperty(g,"__esModule",{value:!0}),g.MsgTypes=g.SAMPLE_RATE=void 0,g.SAMPLE_RATE=44100,g.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(c,[p,c]))===void 0||(n.exports=m)},581:(n,c,p)=>{var m;(m=(function(l,g){Object.defineProperty(g,"__esModule",{value:!0}),g.FlMMLAudioExportError=void 0;class f extends Error{constructor(...S){super(...S),this.name="FlMMLAudioExportError"}}g.FlMMLAudioExportError=f}).apply(c,[p,c]))===void 0||(n.exports=m)},643:function(n,c,p){var m,l,g=this&&this.__awaiter||function(f,d,S,D){return new(S||(S=Promise))(function(_,y){function E(M){try{T(D.next(M))}catch(w){y(w)}}function C(M){try{T(D.throw(M))}catch(w){y(w)}}function T(M){var w;M.done?_(M.value):(w=M.value,w instanceof S?w:new S(function(U){U(w)})).then(E,C)}T((D=D.apply(f,d||[])).next())})};m=[p,c,p(587),p(581),p(158)],(l=(function(f,d,S,D,_){Object.defineProperty(d,"__esModule",{value:!0}),d.FlMMLonHTML5=d.FlMMLAudioExportError=d.FlMML=void 0,Object.defineProperty(d,"FlMMLAudioExportError",{enumerable:!0,get:function(){return D.FlMMLAudioExportError}});const y="flmml-on-html5.worker.js";class E{constructor(T=y){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof T=="string"&&(T={workerURL:T});const M=T.workerURL||y,w=T.infoInterval>=0?T.infoInterval:125;this.bufferSize=T.bufferSize>=128?Math.floor(T.bufferSize-T.bufferSize%128):8192,this.bufferMultiple=T.bufferMultiple>=1?Math.floor(T.bufferMultiple):32,this.lamejsURL=T.lamejsURL,(this.worker=new Worker(T.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${M}")`],{type:"application/javascript"})):M)).addEventListener("message",U=>{this.onMessage(U)}),this.setInfoInterval(w)}static initWebAudio(){const T=E.audioCtx=new AudioContext({sampleRate:S.SAMPLE_RATE}),M=T.createBufferSource();M.connect(T.destination),M.start(0),T.resume(),M.stop()}static hookInitWebAudio(T){const M=document.querySelectorAll(T);M.forEach(w=>{w.addEventListener("click",function U(){E.audioCtx||E.initWebAudio(),M.forEach($=>{$.removeEventListener("click",U,!0)})},!0)})}static prepare(T){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{E.hookInitWebAudio(T)}):E.hookInitWebAudio(T)}onMessage(T){const M=T.data;switch(M.type){case S.MsgTypes.COMPCOMP:this.totalMSec=M.info.totalMSec,this.totalTimeStr=M.info.totalTimeStr,this.warnings=M.info.warnings,this.metaTitle=M.info.metaTitle,this.metaComment=M.info.metaComment,this.metaArtist=M.info.metaArtist,this.metaCoding=M.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case S.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(M),this.trigger("buffering",{progress:M.progress});break;case S.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case S.MsgTypes.SYNCINFO:this._isPlaying=M.info._isPlaying,this._isPaused=M.info._isPaused,this.nowMSec=M.info.nowMSec,this.nowTimeStr=M.info.nowTimeStr,this.voiceCount=M.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case S.MsgTypes.PLAYSOUND:this.playSound();break;case S.MsgTypes.STOPSOUND:this.stopSound();break;case S.MsgTypes.EXPORT:M.data?this.completeAudioExport(M.data):this.errorAudioExport(M.errorMsg)}}boot(){this.worker.postMessage({type:S.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const T=E.audioCtx,M=this.gainNode=T.createGain();M.gain.value=this.volume/127,M.connect(T.destination),g(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(U=>{const $=new FileReader;$.onload=G=>{T.audioWorklet.addModule(G.target.result).then(U)},$.readAsDataURL(new Blob([_.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const w=this.workletNode=new AudioWorkletNode(T,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});w.connect(M),this.worker.postMessage({type:S.MsgTypes.PLAYSOUND,workletPort:w.port},[w.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:S.MsgTypes.STOPSOUND})}trigger(T,M){const w=this.events[T];if(!w)return;const U={};for(let $ in M)U[$]=M[$];for(let $=0,G=w.length;$<G;$++)w[$]&&w[$].call(this,U)}exportAudio(T,M,w={}){return E.audioCtx||E.initWebAudio(),this.booted||this.boot(),new Promise((U,$)=>{this.audioExportResolve?$(new D.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:S.MsgTypes.EXPORT,mml:T,format:M},w)),this.audioExportResolve=U,this.audioExportReject=$)})}completeAudioExport(T){this.audioExportResolve&&(this.audioExportResolve(T),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(T){this.audioExportReject&&(this.audioExportReject(new D.FlMMLAudioExportError(T)),this.audioExportResolve=null,this.audioExportReject=null)}play(T){E.audioCtx||E.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:S.MsgTypes.PLAY,mml:T})}stop(){this.worker.postMessage({type:S.MsgTypes.STOP})}pause(){this.worker.postMessage({type:S.MsgTypes.PAUSE})}exportWav(T){return this.exportAudio(T,"wav")}exportMp3(T,M){return this.exportAudio(T,"mp3",{bitrate:M})}setMasterVolume(T){this.volume=T,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(T){this.worker.postMessage({type:S.MsgTypes.SYNCINFO,interval:T})}syncInfo(){this.worker.postMessage({type:S.MsgTypes.SYNCINFO,interval:null})}addEventListener(T,M){let w=this.events[T];w||(w=this.events[T]=[]);for(let U=w.length;U--;)if(w[U]===M)return!1;return w.push(M),!0}removeEventListener(T,M){const w=this.events[T];if(!w)return!1;for(let U=w.length;U--;)if(w[U]===M)return w.splice(U,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}d.FlMML=E,d.FlMMLonHTML5=E}).apply(c,m))===void 0||(n.exports=l)},158:(n,c,p)=>{p.r(c),p.d(c,{FlMMLWorkletScript:()=>m});const m='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},o={};function i(n){var c=o[n];if(c!==void 0)return c.exports;var p=o[n]={exports:{}};return r[n].call(p.exports,p,p.exports,i),p.exports}return i.d=(n,c)=>{for(var p in c)i.o(c,p)&&!i.o(n,p)&&Object.defineProperty(n,p,{enumerable:!0,get:c[p]})},i.o=(n,c)=>Object.prototype.hasOwnProperty.call(n,c),i.r=n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},i(643)})()})})(Jn);var Qn=Jn.exports;function pt(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Zn={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(t,e){(function(r){t.exports=r()})(function(){return function r(o,i,n){function c(l,g){if(!i[l]){if(!o[l]){var f=typeof pt=="function"&&pt;if(!g&&f)return f(l,!0);if(p)return p(l,!0);var d=new Error("Cannot find module '"+l+"'");throw d.code="MODULE_NOT_FOUND",d}var S=i[l]={exports:{}};o[l][0].call(S.exports,function(D){var _=o[l][1][D];return c(_||D)},S,S.exports,r,o,i,n)}return i[l].exports}for(var p=typeof pt=="function"&&pt,m=0;m<n.length;m++)c(n[m]);return c}({1:[function(r,o,i){(function(n){var c=n.MutationObserver||n.WebKitMutationObserver,p;if(c){var m=0,l=new c(D),g=n.document.createTextNode("");l.observe(g,{characterData:!0}),p=function(){g.data=m=++m%2}}else if(!n.setImmediate&&typeof n.MessageChannel<"u"){var f=new n.MessageChannel;f.port1.onmessage=D,p=function(){f.port2.postMessage(0)}}else"document"in n&&"onreadystatechange"in n.document.createElement("script")?p=function(){var y=n.document.createElement("script");y.onreadystatechange=function(){D(),y.onreadystatechange=null,y.parentNode.removeChild(y),y=null},n.document.documentElement.appendChild(y)}:p=function(){setTimeout(D,0)};var d,S=[];function D(){d=!0;for(var y,E,C=S.length;C;){for(E=S,S=[],y=-1;++y<C;)E[y]();C=S.length}d=!1}o.exports=_;function _(y){S.push(y)===1&&!d&&p()}}).call(this,typeof at<"u"?at:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,o,i){var n=r(1);function c(){}var p={},m=["REJECTED"],l=["FULFILLED"],g=["PENDING"];o.exports=f;function f(w){if(typeof w!="function")throw new TypeError("resolver must be a function");this.state=g,this.queue=[],this.outcome=void 0,w!==c&&_(this,w)}f.prototype.catch=function(w){return this.then(null,w)},f.prototype.then=function(w,U){if(typeof w!="function"&&this.state===l||typeof U!="function"&&this.state===m)return this;var $=new this.constructor(c);if(this.state!==g){var G=this.state===l?w:U;S($,G,this.outcome)}else this.queue.push(new d($,w,U));return $};function d(w,U,$){this.promise=w,typeof U=="function"&&(this.onFulfilled=U,this.callFulfilled=this.otherCallFulfilled),typeof $=="function"&&(this.onRejected=$,this.callRejected=this.otherCallRejected)}d.prototype.callFulfilled=function(w){p.resolve(this.promise,w)},d.prototype.otherCallFulfilled=function(w){S(this.promise,this.onFulfilled,w)},d.prototype.callRejected=function(w){p.reject(this.promise,w)},d.prototype.otherCallRejected=function(w){S(this.promise,this.onRejected,w)};function S(w,U,$){n(function(){var G;try{G=U($)}catch(de){return p.reject(w,de)}G===w?p.reject(w,new TypeError("Cannot resolve promise with itself")):p.resolve(w,G)})}p.resolve=function(w,U){var $=y(D,U);if($.status==="error")return p.reject(w,$.value);var G=$.value;if(G)_(w,G);else{w.state=l,w.outcome=U;for(var de=-1,se=w.queue.length;++de<se;)w.queue[de].callFulfilled(U)}return w},p.reject=function(w,U){w.state=m,w.outcome=U;for(var $=-1,G=w.queue.length;++$<G;)w.queue[$].callRejected(U);return w};function D(w){var U=w&&w.then;if(w&&(typeof w=="object"||typeof w=="function")&&typeof U=="function")return function(){U.apply(w,arguments)}}function _(w,U){var $=!1;function G(pe){$||($=!0,p.reject(w,pe))}function de(pe){$||($=!0,p.resolve(w,pe))}function se(){U(de,G)}var ue=y(se);ue.status==="error"&&G(ue.value)}function y(w,U){var $={};try{$.value=w(U),$.status="success"}catch(G){$.status="error",$.value=G}return $}f.resolve=E;function E(w){return w instanceof this?w:p.resolve(new this(c),w)}f.reject=C;function C(w){var U=new this(c);return p.reject(U,w)}f.all=T;function T(w){var U=this;if(Object.prototype.toString.call(w)!=="[object Array]")return this.reject(new TypeError("must be an array"));var $=w.length,G=!1;if(!$)return this.resolve([]);for(var de=new Array($),se=0,ue=-1,pe=new this(c);++ue<$;)he(w[ue],ue);return pe;function he(A,x){U.resolve(A).then(F,function(V){G||(G=!0,p.reject(pe,V))});function F(V){de[x]=V,++se===$&&!G&&(G=!0,p.resolve(pe,de))}}}f.race=M;function M(w){var U=this;if(Object.prototype.toString.call(w)!=="[object Array]")return this.reject(new TypeError("must be an array"));var $=w.length,G=!1;if(!$)return this.resolve([]);for(var de=-1,se=new this(c);++de<$;)ue(w[de]);return se;function ue(pe){U.resolve(pe).then(function(he){G||(G=!0,p.resolve(se,he))},function(he){G||(G=!0,p.reject(se,he))})}}},{1:1}],3:[function(r,o,i){(function(n){typeof n.Promise!="function"&&(n.Promise=r(2))}).call(this,typeof at<"u"?at:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,o,i){var n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};function c(a,u){if(!(a instanceof u))throw new TypeError("Cannot call a class as a function")}function p(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var m=p();function l(){try{if(!m||!m.open)return!1;var a=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),u=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!a||u)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function g(a,u){a=a||[],u=u||{};try{return new Blob(a,u)}catch(h){if(h.name!=="TypeError")throw h;for(var s=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,v=new s,b=0;b<a.length;b+=1)v.append(a[b]);return v.getBlob(u.type)}}typeof Promise>"u"&&r(3);var f=Promise;function d(a,u){u&&a.then(function(s){u(null,s)},function(s){u(s)})}function S(a,u,s){typeof u=="function"&&a.then(u),typeof s=="function"&&a.catch(s)}function D(a){return typeof a!="string"&&(console.warn(a+" used as a key, but it is not a string."),a=String(a)),a}function _(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var y="local-forage-detect-blob-support",E=void 0,C={},T=Object.prototype.toString,M="readonly",w="readwrite";function U(a){for(var u=a.length,s=new ArrayBuffer(u),v=new Uint8Array(s),b=0;b<u;b++)v[b]=a.charCodeAt(b);return s}function $(a){return new f(function(u){var s=a.transaction(y,w),v=g([""]);s.objectStore(y).put(v,"key"),s.onabort=function(b){b.preventDefault(),b.stopPropagation(),u(!1)},s.oncomplete=function(){var b=navigator.userAgent.match(/Chrome\/(\d+)/),h=navigator.userAgent.match(/Edge\//);u(h||!b||parseInt(b[1],10)>=43)}}).catch(function(){return!1})}function G(a){return typeof E=="boolean"?f.resolve(E):$(a).then(function(u){return E=u,E})}function de(a){var u=C[a.name],s={};s.promise=new f(function(v,b){s.resolve=v,s.reject=b}),u.deferredOperations.push(s),u.dbReady?u.dbReady=u.dbReady.then(function(){return s.promise}):u.dbReady=s.promise}function se(a){var u=C[a.name],s=u.deferredOperations.pop();if(s)return s.resolve(),s.promise}function ue(a,u){var s=C[a.name],v=s.deferredOperations.pop();if(v)return v.reject(u),v.promise}function pe(a,u){return new f(function(s,v){if(C[a.name]=C[a.name]||ie(),a.db)if(u)de(a),a.db.close();else return s(a.db);var b=[a.name];u&&b.push(a.version);var h=m.open.apply(m,b);u&&(h.onupgradeneeded=function(I){var L=h.result;try{L.createObjectStore(a.storeName),I.oldVersion<=1&&L.createObjectStore(y)}catch(O){if(O.name==="ConstraintError")console.warn('The database "'+a.name+'" has been upgraded from version '+I.oldVersion+" to version "+I.newVersion+', but the storage "'+a.storeName+'" already exists.');else throw O}}),h.onerror=function(I){I.preventDefault(),v(h.error)},h.onsuccess=function(){var I=h.result;I.onversionchange=function(L){L.target.close()},s(I),se(a)}})}function he(a){return pe(a,!1)}function A(a){return pe(a,!0)}function x(a,u){if(!a.db)return!0;var s=!a.db.objectStoreNames.contains(a.storeName),v=a.version<a.db.version,b=a.version>a.db.version;if(v&&(a.version!==u&&console.warn('The database "'+a.name+`" can't be downgraded from version `+a.db.version+" to version "+a.version+"."),a.version=a.db.version),b||s){if(s){var h=a.db.version+1;h>a.version&&(a.version=h)}return!0}return!1}function F(a){return new f(function(u,s){var v=new FileReader;v.onerror=s,v.onloadend=function(b){var h=btoa(b.target.result||"");u({__local_forage_encoded_blob:!0,data:h,type:a.type})},v.readAsBinaryString(a)})}function V(a){var u=U(atob(a.data));return g([u],{type:a.type})}function Y(a){return a&&a.__local_forage_encoded_blob}function X(a){var u=this,s=u._initReady().then(function(){var v=C[u._dbInfo.name];if(v&&v.dbReady)return v.dbReady});return S(s,a,a),s}function Z(a){de(a);for(var u=C[a.name],s=u.forages,v=0;v<s.length;v++){var b=s[v];b._dbInfo.db&&(b._dbInfo.db.close(),b._dbInfo.db=null)}return a.db=null,he(a).then(function(h){return a.db=h,x(a)?A(a):h}).then(function(h){a.db=u.db=h;for(var I=0;I<s.length;I++)s[I]._dbInfo.db=h}).catch(function(h){throw ue(a,h),h})}function J(a,u,s,v){v===void 0&&(v=1);try{var b=a.db.transaction(a.storeName,u);s(null,b)}catch(h){if(v>0&&(!a.db||h.name==="InvalidStateError"||h.name==="NotFoundError"))return f.resolve().then(function(){if(!a.db||h.name==="NotFoundError"&&!a.db.objectStoreNames.contains(a.storeName)&&a.version<=a.db.version)return a.db&&(a.version=a.db.version+1),A(a)}).then(function(){return Z(a).then(function(){J(a,u,s,v-1)})}).catch(s);s(h)}}function ie(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function W(a){var u=this,s={db:null};if(a)for(var v in a)s[v]=a[v];var b=C[s.name];b||(b=ie(),C[s.name]=b),b.forages.push(u),u._initReady||(u._initReady=u.ready,u.ready=X);var h=[];function I(){return f.resolve()}for(var L=0;L<b.forages.length;L++){var O=b.forages[L];O!==u&&h.push(O._initReady().catch(I))}var P=b.forages.slice(0);return f.all(h).then(function(){return s.db=b.db,he(s)}).then(function(B){return s.db=B,x(s,u._defaultConfig.version)?A(s):B}).then(function(B){s.db=b.db=B,u._dbInfo=s;for(var z=0;z<P.length;z++){var te=P[z];te!==u&&(te._dbInfo.db=s.db,te._dbInfo.version=s.version)}})}function re(a,u){var s=this;a=D(a);var v=new f(function(b,h){s.ready().then(function(){J(s._dbInfo,M,function(I,L){if(I)return h(I);try{var O=L.objectStore(s._dbInfo.storeName),P=O.get(a);P.onsuccess=function(){var B=P.result;B===void 0&&(B=null),Y(B)&&(B=V(B)),b(B)},P.onerror=function(){h(P.error)}}catch(B){h(B)}})}).catch(h)});return d(v,u),v}function ve(a,u){var s=this,v=new f(function(b,h){s.ready().then(function(){J(s._dbInfo,M,function(I,L){if(I)return h(I);try{var O=L.objectStore(s._dbInfo.storeName),P=O.openCursor(),B=1;P.onsuccess=function(){var z=P.result;if(z){var te=z.value;Y(te)&&(te=V(te));var ce=a(te,z.key,B++);ce!==void 0?b(ce):z.continue()}else b()},P.onerror=function(){h(P.error)}}catch(z){h(z)}})}).catch(h)});return d(v,u),v}function k(a,u,s){var v=this;a=D(a);var b=new f(function(h,I){var L;v.ready().then(function(){return L=v._dbInfo,T.call(u)==="[object Blob]"?G(L.db).then(function(O){return O?u:F(u)}):u}).then(function(O){J(v._dbInfo,w,function(P,B){if(P)return I(P);try{var z=B.objectStore(v._dbInfo.storeName);O===null&&(O=void 0);var te=z.put(O,a);B.oncomplete=function(){O===void 0&&(O=null),h(O)},B.onabort=B.onerror=function(){var ce=te.error?te.error:te.transaction.error;I(ce)}}catch(ce){I(ce)}})}).catch(I)});return d(b,s),b}function j(a,u){var s=this;a=D(a);var v=new f(function(b,h){s.ready().then(function(){J(s._dbInfo,w,function(I,L){if(I)return h(I);try{var O=L.objectStore(s._dbInfo.storeName),P=O.delete(a);L.oncomplete=function(){b()},L.onerror=function(){h(P.error)},L.onabort=function(){var B=P.error?P.error:P.transaction.error;h(B)}}catch(B){h(B)}})}).catch(h)});return d(v,u),v}function q(a){var u=this,s=new f(function(v,b){u.ready().then(function(){J(u._dbInfo,w,function(h,I){if(h)return b(h);try{var L=I.objectStore(u._dbInfo.storeName),O=L.clear();I.oncomplete=function(){v()},I.onabort=I.onerror=function(){var P=O.error?O.error:O.transaction.error;b(P)}}catch(P){b(P)}})}).catch(b)});return d(s,a),s}function H(a){var u=this,s=new f(function(v,b){u.ready().then(function(){J(u._dbInfo,M,function(h,I){if(h)return b(h);try{var L=I.objectStore(u._dbInfo.storeName),O=L.count();O.onsuccess=function(){v(O.result)},O.onerror=function(){b(O.error)}}catch(P){b(P)}})}).catch(b)});return d(s,a),s}function ne(a,u){var s=this,v=new f(function(b,h){if(a<0){b(null);return}s.ready().then(function(){J(s._dbInfo,M,function(I,L){if(I)return h(I);try{var O=L.objectStore(s._dbInfo.storeName),P=!1,B=O.openKeyCursor();B.onsuccess=function(){var z=B.result;if(!z){b(null);return}a===0||P?b(z.key):(P=!0,z.advance(a))},B.onerror=function(){h(B.error)}}catch(z){h(z)}})}).catch(h)});return d(v,u),v}function ee(a){var u=this,s=new f(function(v,b){u.ready().then(function(){J(u._dbInfo,M,function(h,I){if(h)return b(h);try{var L=I.objectStore(u._dbInfo.storeName),O=L.openKeyCursor(),P=[];O.onsuccess=function(){var B=O.result;if(!B){v(P);return}P.push(B.key),B.continue()},O.onerror=function(){b(O.error)}}catch(B){b(B)}})}).catch(b)});return d(s,a),s}function we(a,u){u=_.apply(this,arguments);var s=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||s.name,a.storeName=a.storeName||s.storeName);var v=this,b;if(!a.name)b=f.reject("Invalid arguments");else{var h=a.name===s.name&&v._dbInfo.db,I=h?f.resolve(v._dbInfo.db):he(a).then(function(L){var O=C[a.name],P=O.forages;O.db=L;for(var B=0;B<P.length;B++)P[B]._dbInfo.db=L;return L});a.storeName?b=I.then(function(L){if(L.objectStoreNames.contains(a.storeName)){var O=L.version+1;de(a);var P=C[a.name],B=P.forages;L.close();for(var z=0;z<B.length;z++){var te=B[z];te._dbInfo.db=null,te._dbInfo.version=O}var ce=new f(function(le,be){var ge=m.open(a.name,O);ge.onerror=function(Ie){var nt=ge.result;nt.close(),be(Ie)},ge.onupgradeneeded=function(){var Ie=ge.result;Ie.deleteObjectStore(a.storeName)},ge.onsuccess=function(){var Ie=ge.result;Ie.close(),le(Ie)}});return ce.then(function(le){P.db=le;for(var be=0;be<B.length;be++){var ge=B[be];ge._dbInfo.db=le,se(ge._dbInfo)}}).catch(function(le){throw(ue(a,le)||f.resolve()).catch(function(){}),le})}}):b=I.then(function(L){de(a);var O=C[a.name],P=O.forages;L.close();for(var B=0;B<P.length;B++){var z=P[B];z._dbInfo.db=null}var te=new f(function(ce,le){var be=m.deleteDatabase(a.name);be.onerror=function(){var ge=be.result;ge&&ge.close(),le(be.error)},be.onblocked=function(){console.warn('dropInstance blocked for database "'+a.name+'" until all open connections are closed')},be.onsuccess=function(){var ge=be.result;ge&&ge.close(),ce(ge)}});return te.then(function(ce){O.db=ce;for(var le=0;le<P.length;le++){var be=P[le];se(be._dbInfo)}}).catch(function(ce){throw(ue(a,ce)||f.resolve()).catch(function(){}),ce})})}return d(b,u),b}var Ye={_driver:"asyncStorage",_initStorage:W,_support:l(),iterate:ve,getItem:re,setItem:k,removeItem:j,clear:q,length:H,key:ne,keys:ee,dropInstance:we};function kr(){return typeof openDatabase=="function"}var Pe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",xr="~~local_forage_type~",Sn=/^~~local_forage_type~([^~]+)~/,mt="__lfsc__:",Ut=mt.length,$t="arbf",Ft="blob",wn="si08",Tn="ui08",kn="uic8",xn="si16",Cn="si32",In="ur16",Nn="ui32",An="fl32",_n="fl64",Dn=Ut+$t.length,Ln=Object.prototype.toString;function Mn(a){var u=a.length*.75,s=a.length,v,b=0,h,I,L,O;a[a.length-1]==="="&&(u--,a[a.length-2]==="="&&u--);var P=new ArrayBuffer(u),B=new Uint8Array(P);for(v=0;v<s;v+=4)h=Pe.indexOf(a[v]),I=Pe.indexOf(a[v+1]),L=Pe.indexOf(a[v+2]),O=Pe.indexOf(a[v+3]),B[b++]=h<<2|I>>4,B[b++]=(I&15)<<4|L>>2,B[b++]=(L&3)<<6|O&63;return P}function Vt(a){var u=new Uint8Array(a),s="",v;for(v=0;v<u.length;v+=3)s+=Pe[u[v]>>2],s+=Pe[(u[v]&3)<<4|u[v+1]>>4],s+=Pe[(u[v+1]&15)<<2|u[v+2]>>6],s+=Pe[u[v+2]&63];return u.length%3===2?s=s.substring(0,s.length-1)+"=":u.length%3===1&&(s=s.substring(0,s.length-2)+"=="),s}function Cr(a,u){var s="";if(a&&(s=Ln.call(a)),a&&(s==="[object ArrayBuffer]"||a.buffer&&Ln.call(a.buffer)==="[object ArrayBuffer]")){var v,b=mt;a instanceof ArrayBuffer?(v=a,b+=$t):(v=a.buffer,s==="[object Int8Array]"?b+=wn:s==="[object Uint8Array]"?b+=Tn:s==="[object Uint8ClampedArray]"?b+=kn:s==="[object Int16Array]"?b+=xn:s==="[object Uint16Array]"?b+=In:s==="[object Int32Array]"?b+=Cn:s==="[object Uint32Array]"?b+=Nn:s==="[object Float32Array]"?b+=An:s==="[object Float64Array]"?b+=_n:u(new Error("Failed to get type for BinaryArray"))),u(b+Vt(v))}else if(s==="[object Blob]"){var h=new FileReader;h.onload=function(){var I=xr+a.type+"~"+Vt(this.result);u(mt+Ft+I)},h.readAsArrayBuffer(a)}else try{u(JSON.stringify(a))}catch(I){console.error("Couldn't convert value into a JSON string: ",a),u(null,I)}}function Ir(a){if(a.substring(0,Ut)!==mt)return JSON.parse(a);var u=a.substring(Dn),s=a.substring(Ut,Dn),v;if(s===Ft&&Sn.test(u)){var b=u.match(Sn);v=b[1],u=u.substring(b[0].length)}var h=Mn(u);switch(s){case $t:return h;case Ft:return g([h],{type:v});case wn:return new Int8Array(h);case Tn:return new Uint8Array(h);case kn:return new Uint8ClampedArray(h);case xn:return new Int16Array(h);case In:return new Uint16Array(h);case Cn:return new Int32Array(h);case Nn:return new Uint32Array(h);case An:return new Float32Array(h);case _n:return new Float64Array(h);default:throw new Error("Unkown type: "+s)}}var Wt={serialize:Cr,deserialize:Ir,stringToBuffer:Mn,bufferToString:Vt};function On(a,u,s,v){a.executeSql("CREATE TABLE IF NOT EXISTS "+u.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],s,v)}function Nr(a){var u=this,s={db:null};if(a)for(var v in a)s[v]=typeof a[v]!="string"?a[v].toString():a[v];var b=new f(function(h,I){try{s.db=openDatabase(s.name,String(s.version),s.description,s.size)}catch(L){return I(L)}s.db.transaction(function(L){On(L,s,function(){u._dbInfo=s,h()},function(O,P){I(P)})},I)});return s.serializer=Wt,b}function je(a,u,s,v,b,h){a.executeSql(s,v,b,function(I,L){L.code===L.SYNTAX_ERR?I.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[u.storeName],function(O,P){P.rows.length?h(O,L):On(O,u,function(){O.executeSql(s,v,b,h)},h)},h):h(I,L)},h)}function Ar(a,u){var s=this;a=D(a);var v=new f(function(b,h){s.ready().then(function(){var I=s._dbInfo;I.db.transaction(function(L){je(L,I,"SELECT * FROM "+I.storeName+" WHERE key = ? LIMIT 1",[a],function(O,P){var B=P.rows.length?P.rows.item(0).value:null;B&&(B=I.serializer.deserialize(B)),b(B)},function(O,P){h(P)})})}).catch(h)});return d(v,u),v}function _r(a,u){var s=this,v=new f(function(b,h){s.ready().then(function(){var I=s._dbInfo;I.db.transaction(function(L){je(L,I,"SELECT * FROM "+I.storeName,[],function(O,P){for(var B=P.rows,z=B.length,te=0;te<z;te++){var ce=B.item(te),le=ce.value;if(le&&(le=I.serializer.deserialize(le)),le=a(le,ce.key,te+1),le!==void 0){b(le);return}}b()},function(O,P){h(P)})})}).catch(h)});return d(v,u),v}function Pn(a,u,s,v){var b=this;a=D(a);var h=new f(function(I,L){b.ready().then(function(){u===void 0&&(u=null);var O=u,P=b._dbInfo;P.serializer.serialize(u,function(B,z){z?L(z):P.db.transaction(function(te){je(te,P,"INSERT OR REPLACE INTO "+P.storeName+" (key, value) VALUES (?, ?)",[a,B],function(){I(O)},function(ce,le){L(le)})},function(te){if(te.code===te.QUOTA_ERR){if(v>0){I(Pn.apply(b,[a,O,s,v-1]));return}L(te)}})})}).catch(L)});return d(h,s),h}function Dr(a,u,s){return Pn.apply(this,[a,u,s,1])}function Lr(a,u){var s=this;a=D(a);var v=new f(function(b,h){s.ready().then(function(){var I=s._dbInfo;I.db.transaction(function(L){je(L,I,"DELETE FROM "+I.storeName+" WHERE key = ?",[a],function(){b()},function(O,P){h(P)})})}).catch(h)});return d(v,u),v}function Mr(a){var u=this,s=new f(function(v,b){u.ready().then(function(){var h=u._dbInfo;h.db.transaction(function(I){je(I,h,"DELETE FROM "+h.storeName,[],function(){v()},function(L,O){b(O)})})}).catch(b)});return d(s,a),s}function Or(a){var u=this,s=new f(function(v,b){u.ready().then(function(){var h=u._dbInfo;h.db.transaction(function(I){je(I,h,"SELECT COUNT(key) as c FROM "+h.storeName,[],function(L,O){var P=O.rows.item(0).c;v(P)},function(L,O){b(O)})})}).catch(b)});return d(s,a),s}function Pr(a,u){var s=this,v=new f(function(b,h){s.ready().then(function(){var I=s._dbInfo;I.db.transaction(function(L){je(L,I,"SELECT key FROM "+I.storeName+" WHERE id = ? LIMIT 1",[a+1],function(O,P){var B=P.rows.length?P.rows.item(0).key:null;b(B)},function(O,P){h(P)})})}).catch(h)});return d(v,u),v}function jr(a){var u=this,s=new f(function(v,b){u.ready().then(function(){var h=u._dbInfo;h.db.transaction(function(I){je(I,h,"SELECT key FROM "+h.storeName,[],function(L,O){for(var P=[],B=0;B<O.rows.length;B++)P.push(O.rows.item(B).key);v(P)},function(L,O){b(O)})})}).catch(b)});return d(s,a),s}function Br(a){return new f(function(u,s){a.transaction(function(v){v.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(b,h){for(var I=[],L=0;L<h.rows.length;L++)I.push(h.rows.item(L).name);u({db:a,storeNames:I})},function(b,h){s(h)})},function(v){s(v)})})}function Rr(a,u){u=_.apply(this,arguments);var s=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||s.name,a.storeName=a.storeName||s.storeName);var v=this,b;return a.name?b=new f(function(h){var I;a.name===s.name?I=v._dbInfo.db:I=openDatabase(a.name,"","",0),a.storeName?h({db:I,storeNames:[a.storeName]}):h(Br(I))}).then(function(h){return new f(function(I,L){h.db.transaction(function(O){function P(ce){return new f(function(le,be){O.executeSql("DROP TABLE IF EXISTS "+ce,[],function(){le()},function(ge,Ie){be(Ie)})})}for(var B=[],z=0,te=h.storeNames.length;z<te;z++)B.push(P(h.storeNames[z]));f.all(B).then(function(){I()}).catch(function(ce){L(ce)})},function(O){L(O)})})}):b=f.reject("Invalid arguments"),d(b,u),b}var Ur={_driver:"webSQLStorage",_initStorage:Nr,_support:kr(),iterate:_r,getItem:Ar,setItem:Dr,removeItem:Lr,clear:Mr,length:Or,key:Pr,keys:jr,dropInstance:Rr};function $r(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function jn(a,u){var s=a.name+"/";return a.storeName!==u.storeName&&(s+=a.storeName+"/"),s}function Fr(){var a="_localforage_support_test";try{return localStorage.setItem(a,!0),localStorage.removeItem(a),!1}catch{return!0}}function Vr(){return!Fr()||localStorage.length>0}function Wr(a){var u=this,s={};if(a)for(var v in a)s[v]=a[v];return s.keyPrefix=jn(a,u._defaultConfig),Vr()?(u._dbInfo=s,s.serializer=Wt,f.resolve()):f.reject()}function zr(a){var u=this,s=u.ready().then(function(){for(var v=u._dbInfo.keyPrefix,b=localStorage.length-1;b>=0;b--){var h=localStorage.key(b);h.indexOf(v)===0&&localStorage.removeItem(h)}});return d(s,a),s}function qr(a,u){var s=this;a=D(a);var v=s.ready().then(function(){var b=s._dbInfo,h=localStorage.getItem(b.keyPrefix+a);return h&&(h=b.serializer.deserialize(h)),h});return d(v,u),v}function Hr(a,u){var s=this,v=s.ready().then(function(){for(var b=s._dbInfo,h=b.keyPrefix,I=h.length,L=localStorage.length,O=1,P=0;P<L;P++){var B=localStorage.key(P);if(B.indexOf(h)===0){var z=localStorage.getItem(B);if(z&&(z=b.serializer.deserialize(z)),z=a(z,B.substring(I),O++),z!==void 0)return z}}});return d(v,u),v}function Yr(a,u){var s=this,v=s.ready().then(function(){var b=s._dbInfo,h;try{h=localStorage.key(a)}catch{h=null}return h&&(h=h.substring(b.keyPrefix.length)),h});return d(v,u),v}function Gr(a){var u=this,s=u.ready().then(function(){for(var v=u._dbInfo,b=localStorage.length,h=[],I=0;I<b;I++){var L=localStorage.key(I);L.indexOf(v.keyPrefix)===0&&h.push(L.substring(v.keyPrefix.length))}return h});return d(s,a),s}function Kr(a){var u=this,s=u.keys().then(function(v){return v.length});return d(s,a),s}function Xr(a,u){var s=this;a=D(a);var v=s.ready().then(function(){var b=s._dbInfo;localStorage.removeItem(b.keyPrefix+a)});return d(v,u),v}function Jr(a,u,s){var v=this;a=D(a);var b=v.ready().then(function(){u===void 0&&(u=null);var h=u;return new f(function(I,L){var O=v._dbInfo;O.serializer.serialize(u,function(P,B){if(B)L(B);else try{localStorage.setItem(O.keyPrefix+a,P),I(h)}catch(z){(z.name==="QuotaExceededError"||z.name==="NS_ERROR_DOM_QUOTA_REACHED")&&L(z),L(z)}})})});return d(b,s),b}function Qr(a,u){if(u=_.apply(this,arguments),a=typeof a!="function"&&a||{},!a.name){var s=this.config();a.name=a.name||s.name,a.storeName=a.storeName||s.storeName}var v=this,b;return a.name?b=new f(function(h){a.storeName?h(jn(a,v._defaultConfig)):h(a.name+"/")}).then(function(h){for(var I=localStorage.length-1;I>=0;I--){var L=localStorage.key(I);L.indexOf(h)===0&&localStorage.removeItem(L)}}):b=f.reject("Invalid arguments"),d(b,u),b}var Zr={_driver:"localStorageWrapper",_initStorage:Wr,_support:$r(),iterate:Hr,getItem:qr,setItem:Jr,removeItem:Xr,clear:zr,length:Kr,key:Yr,keys:Gr,dropInstance:Qr},ea=function(u,s){return u===s||typeof u=="number"&&typeof s=="number"&&isNaN(u)&&isNaN(s)},ta=function(u,s){for(var v=u.length,b=0;b<v;){if(ea(u[b],s))return!0;b++}return!1},Bn=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},tt={},Rn={},Ge={INDEXEDDB:Ye,WEBSQL:Ur,LOCALSTORAGE:Zr},na=[Ge.INDEXEDDB._driver,Ge.WEBSQL._driver,Ge.LOCALSTORAGE._driver],ht=["dropInstance"],zt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(ht),ra={description:"",driver:na.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function aa(a,u){a[u]=function(){var s=arguments;return a.ready().then(function(){return a[u].apply(a,s)})}}function qt(){for(var a=1;a<arguments.length;a++){var u=arguments[a];if(u)for(var s in u)u.hasOwnProperty(s)&&(Bn(u[s])?arguments[0][s]=u[s].slice():arguments[0][s]=u[s])}return arguments[0]}var oa=function(){function a(u){c(this,a);for(var s in Ge)if(Ge.hasOwnProperty(s)){var v=Ge[s],b=v._driver;this[s]=b,tt[b]||this.defineDriver(v)}this._defaultConfig=qt({},ra),this._config=qt({},this._defaultConfig,u),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return a.prototype.config=function(s){if((typeof s>"u"?"undefined":n(s))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var v in s){if(v==="storeName"&&(s[v]=s[v].replace(/\W/g,"_")),v==="version"&&typeof s[v]!="number")return new Error("Database version must be a number.");this._config[v]=s[v]}return"driver"in s&&s.driver?this.setDriver(this._config.driver):!0}else return typeof s=="string"?this._config[s]:this._config},a.prototype.defineDriver=function(s,v,b){var h=new f(function(I,L){try{var O=s._driver,P=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!s._driver){L(P);return}for(var B=zt.concat("_initStorage"),z=0,te=B.length;z<te;z++){var ce=B[z],le=!ta(ht,ce);if((le||s[ce])&&typeof s[ce]!="function"){L(P);return}}var be=function(){for(var nt=function(ca){return function(){var la=new Error("Method "+ca+" is not implemented by the current driver"),Un=f.reject(la);return d(Un,arguments[arguments.length-1]),Un}},Ht=0,ia=ht.length;Ht<ia;Ht++){var Yt=ht[Ht];s[Yt]||(s[Yt]=nt(Yt))}};be();var ge=function(nt){tt[O]&&console.info("Redefining LocalForage driver: "+O),tt[O]=s,Rn[O]=nt,I()};"_support"in s?s._support&&typeof s._support=="function"?s._support().then(ge,L):ge(!!s._support):ge(!0)}catch(Ie){L(Ie)}});return S(h,v,b),h},a.prototype.driver=function(){return this._driver||null},a.prototype.getDriver=function(s,v,b){var h=tt[s]?f.resolve(tt[s]):f.reject(new Error("Driver not found."));return S(h,v,b),h},a.prototype.getSerializer=function(s){var v=f.resolve(Wt);return S(v,s),v},a.prototype.ready=function(s){var v=this,b=v._driverSet.then(function(){return v._ready===null&&(v._ready=v._initDriver()),v._ready});return S(b,s,s),b},a.prototype.setDriver=function(s,v,b){var h=this;Bn(s)||(s=[s]);var I=this._getSupportedDrivers(s);function L(){h._config.driver=h.driver()}function O(z){return h._extend(z),L(),h._ready=h._initStorage(h._config),h._ready}function P(z){return function(){var te=0;function ce(){for(;te<z.length;){var le=z[te];return te++,h._dbInfo=null,h._ready=null,h.getDriver(le).then(O).catch(ce)}L();var be=new Error("No available storage method found.");return h._driverSet=f.reject(be),h._driverSet}return ce()}}var B=this._driverSet!==null?this._driverSet.catch(function(){return f.resolve()}):f.resolve();return this._driverSet=B.then(function(){var z=I[0];return h._dbInfo=null,h._ready=null,h.getDriver(z).then(function(te){h._driver=te._driver,L(),h._wrapLibraryMethodsWithReady(),h._initDriver=P(I)})}).catch(function(){L();var z=new Error("No available storage method found.");return h._driverSet=f.reject(z),h._driverSet}),S(this._driverSet,v,b),this._driverSet},a.prototype.supports=function(s){return!!Rn[s]},a.prototype._extend=function(s){qt(this,s)},a.prototype._getSupportedDrivers=function(s){for(var v=[],b=0,h=s.length;b<h;b++){var I=s[b];this.supports(I)&&v.push(I)}return v},a.prototype._wrapLibraryMethodsWithReady=function(){for(var s=0,v=zt.length;s<v;s++)aa(this,zt[s])},a.prototype.createInstance=function(s){return new a(s)},a}(),sa=new oa;o.exports=sa},{3:3}]},{},[4])(4)})})(Zn);var fa=Zn.exports;const nn=da(fa);function vt(t){if(typeof t!="string"||!t)throw new Error("expected a non-empty string, got: "+t)}function Gt(t){if(typeof t!="number")throw new Error("expected a number, got: "+t)}const ma=1,ha=1,He="emoji",Ze="keyvalue",hn="favorites",pa="tokens",er="tokens",va="unicode",tr="count",ga="group",ya="order",nr="group-order",rn="eTag",Tt="url",Fn="skinTone",et="readonly",pn="readwrite",rr="skinUnicodes",ba="skinUnicodes",Ea="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Sa="en";function wa(t,e){const r=new Set,o=[];for(const i of t){const n=e(i);r.has(n)||(r.add(n),o.push(i))}return o}function Vn(t){return wa(t,e=>e.unicode)}function Ta(t){function e(r,o,i){const n=o?t.createObjectStore(r,{keyPath:o}):t.createObjectStore(r);if(i)for(const[c,[p,m]]of Object.entries(i))n.createIndex(c,p,{multiEntry:m});return n}e(Ze),e(He,va,{[er]:[pa,!0],[nr]:[[ga,ya]],[rr]:[ba,!0]}),e(hn,void 0,{[tr]:[""]})}const an={},Et={},kt={};function ar(t,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>t(r.result)}async function ka(t){const e=await new Promise((r,o)=>{const i=indexedDB.open(t,ma);an[t]=i,i.onupgradeneeded=n=>{n.oldVersion<ha&&Ta(i.result)},ar(r,o,i)});return e.onclose=()=>vn(t),e}function xa(t){return Et[t]||(Et[t]=ka(t)),Et[t]}function Oe(t,e,r,o){return new Promise((i,n)=>{const c=t.transaction(e,r,{durability:"relaxed"}),p=typeof e=="string"?c.objectStore(e):e.map(l=>c.objectStore(l));let m;o(p,c,l=>{m=l}),c.oncomplete=()=>i(m),c.onerror=()=>n(c.error)})}function vn(t){const e=an[t],r=e&&e.result;if(r){r.close();const o=kt[t];if(o)for(const i of o)i()}delete an[t],delete Et[t],delete kt[t]}function Ca(t){return new Promise((e,r)=>{vn(t);const o=indexedDB.deleteDatabase(t);ar(e,r,o)})}function Ia(t,e){let r=kt[t];r||(r=kt[t]=[]),r.push(e)}const Na=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function Ke(t){return t.split(/[\s_]+/).map(e=>!e.match(/\w/)||Na.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const Aa=2;function or(t){return t.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Aa)}function _a(t){return t.map(({annotation:r,emoticon:o,group:i,order:n,shortcodes:c,skins:p,tags:m,emoji:l,version:g})=>{const f=[...new Set(or([...(c||[]).map(Ke).flat(),...m.map(Ke).flat(),...Ke(r),o]))].sort(),d={annotation:r,group:i,order:n,tags:m,tokens:f,unicode:l,version:g};if(o&&(d.emoticon=o),c&&(d.shortcodes=c),p){d.skinTones=[],d.skinUnicodes=[],d.skinVersions=[];for(const{tone:S,emoji:D,version:_}of p)d.skinTones.push(S),d.skinUnicodes.push(D),d.skinVersions.push(_)}return d})}function sr(t,e,r,o){t[e](r).onsuccess=i=>o&&o(i.target.result)}function qe(t,e,r){sr(t,"get",e,r)}function ir(t,e,r){sr(t,"getAll",e,r)}function gn(t){t.commit&&t.commit()}function Da(t,e){let r=t[0];for(let o=1;o<t.length;o++){const i=t[o];e(r)>e(i)&&(r=i)}return r}function cr(t,e){const r=Da(t,i=>i.length),o=[];for(const i of r)t.some(n=>n.findIndex(c=>e(c)===e(i))===-1)||o.push(i);return o}async function La(t){return!await yn(t,Ze,Tt)}async function Ma(t,e,r){const[o,i]=await Promise.all([rn,Tt].map(n=>yn(t,Ze,n)));return o===r&&i===e}async function Oa(t,e){return Oe(t,He,et,(o,i,n)=>{let c;const p=()=>{o.getAll(c&&IDBKeyRange.lowerBound(c,!0),50).onsuccess=m=>{const l=m.target.result;for(const g of l)if(c=g.unicode,e(g))return n(g);if(l.length<50)return n();p()}};p()})}async function lr(t,e,r,o){try{const i=_a(e);await Oe(t,[He,Ze],pn,([n,c],p)=>{let m,l,g=0;function f(){++g===2&&d()}function d(){if(!(m===o&&l===r)){n.clear();for(const S of i)n.put(S);c.put(o,rn),c.put(r,Tt),gn(p)}}qe(c,rn,S=>{m=S,f()}),qe(c,Tt,S=>{l=S,f()})})}finally{}}async function Pa(t,e){return Oe(t,He,et,(r,o,i)=>{const n=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);ir(r.index(nr),n,i)})}async function ur(t,e){const r=or(Ke(e));return r.length?Oe(t,He,et,(o,i,n)=>{const c=[],p=()=>{c.length===r.length&&m()},m=()=>{const l=cr(c,g=>g.unicode);n(l.sort((g,f)=>g.order<f.order?-1:1))};for(let l=0;l<r.length;l++){const g=r[l],f=l===r.length-1?IDBKeyRange.bound(g,g+"￿",!1,!0):IDBKeyRange.only(g);ir(o.index(er),f,d=>{c.push(d),p()})}}):[]}async function ja(t,e){const r=await ur(t,e);return r.length?r.filter(o=>(o.shortcodes||[]).map(n=>n.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Oa(t,i=>(i.shortcodes||[]).includes(e.toLowerCase()))||null}async function Ba(t,e){return Oe(t,He,et,(r,o,i)=>qe(r,e,n=>{if(n)return i(n);qe(r.index(rr),e,c=>i(c||null))}))}function yn(t,e,r){return Oe(t,e,et,(o,i,n)=>qe(o,r,n))}function Ra(t,e,r,o){return Oe(t,e,pn,(i,n)=>{i.put(o,r),gn(n)})}function Ua(t,e){return Oe(t,hn,pn,(r,o)=>qe(r,e,i=>{r.put((i||0)+1,e),gn(o)}))}function $a(t,e,r){return r===0?[]:Oe(t,[hn,He],et,([o,i],n,c)=>{const p=[];o.index(tr).openCursor(void 0,"prev").onsuccess=m=>{const l=m.target.result;if(!l)return c(p);function g(S){if(p.push(S),p.length===r)return c(p);l.continue()}const f=l.primaryKey,d=e.byName(f);if(d)return g(d);qe(i,f,S=>{if(S)return g(S);l.continue()})}})}const gt="";function Fa(t,e){const r=new Map;for(const i of t){const n=e(i);for(const c of n){let p=r;for(let l=0;l<c.length;l++){const g=c.charAt(l);let f=p.get(g);f||(f=new Map,p.set(g,f)),p=f}let m=p.get(gt);m||(m=[],p.set(gt,m)),m.push(i)}}return(i,n)=>{let c=r;for(let l=0;l<i.length;l++){const g=i.charAt(l),f=c.get(g);if(f)c=f;else return[]}if(n)return c.get(gt)||[];const p=[],m=[c];for(;m.length;){const g=[...m.shift().entries()].sort((f,d)=>f[0]<d[0]?-1:1);for(const[f,d]of g)f===gt?p.push(...d):m.push(d)}return p}}const Va=["name","url"];function Wa(t){const e=t&&Array.isArray(t),r=e&&t.length&&(!t[0]||Va.some(o=>!(o in t[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function Wn(t){Wa(t);const e=(d,S)=>d.name.toLowerCase()<S.name.toLowerCase()?-1:1,r=t.sort(e),i=Fa(t,d=>[...new Set((d.shortcodes||[]).map(S=>Ke(S)).flat())]),n=d=>i(d,!0),c=d=>i(d,!1),p=d=>{const S=Ke(d),D=S.map((_,y)=>(y<S.length-1?n:c)(_));return cr(D,_=>_.name).sort(e)},m=new Map,l=new Map;for(const d of t){l.set(d.name.toLowerCase(),d);for(const S of d.shortcodes||[])m.set(S.toLowerCase(),d)}return{all:r,search:p,byShortcode:d=>m.get(d.toLowerCase()),byName:d=>l.get(d.toLowerCase())}}const za=typeof wrappedJSObject<"u";function rt(t){if(!t)return t;if(za&&(t=structuredClone(t)),delete t.tokens,t.skinTones){const e=t.skinTones.length;t.skins=Array(e);for(let r=0;r<e;r++)t.skins[r]={tone:t.skinTones[r],unicode:t.skinUnicodes[r],version:t.skinVersions[r]};delete t.skinTones,delete t.skinUnicodes,delete t.skinVersions}return t}function dr(t){t||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const qa=["annotation","emoji","group","order","tags","version"];function Ha(t){if(!t||!Array.isArray(t)||!t[0]||typeof t[0]!="object"||qa.some(e=>!(e in t[0])))throw new Error("Emoji data is in the wrong format")}function fr(t,e){if(Math.floor(t.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+t.status)}async function Ya(t){const e=await fetch(t,{method:"HEAD"});fr(e,t);const r=e.headers.get("etag");return dr(r),r}async function on(t){const e=await fetch(t);fr(e,t);const r=e.headers.get("etag");dr(r);const o=await e.json();return Ha(o),[r,o]}function Ga(t){for(var e="",r=new Uint8Array(t),o=r.byteLength,i=-1;++i<o;)e+=String.fromCharCode(r[i]);return e}function Ka(t){for(var e=t.length,r=new ArrayBuffer(e),o=new Uint8Array(r),i=-1;++i<e;)o[i]=t.charCodeAt(i);return r}async function mr(t){const e=JSON.stringify(t);let r=Ka(e);const o=await crypto.subtle.digest("SHA-1",r),i=Ga(o);return btoa(i)}async function Xa(t,e){let r,o=await Ya(e);if(!o){const i=await on(e);o=i[0],r=i[1],o||(o=await mr(r))}await Ma(t,e,o)||(r||(r=(await on(e))[1]),await lr(t,r,e,o))}async function Ja(t,e){let[r,o]=await on(e);r||(r=await mr(o)),await lr(t,o,e,r)}class Qa{constructor({dataSource:e=Ea,locale:r=Sa,customEmoji:o=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=Wn(o),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await xa(this._dbName);Ia(this._dbName,this._clear);const r=this.dataSource;await La(e)?await Ja(e,r):this._lazyUpdate=Xa(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return Gt(e),await this.ready(),Vn(await Pa(this._db,e)).map(rt)}async getEmojiBySearchQuery(e){vt(e),await this.ready();const r=this._custom.search(e),o=Vn(await ur(this._db,e)).map(rt);return[...r,...o]}async getEmojiByShortcode(e){vt(e),await this.ready();const r=this._custom.byShortcode(e);return r||rt(await ja(this._db,e))}async getEmojiByUnicodeOrName(e){vt(e),await this.ready();const r=this._custom.byName(e);return r||rt(await Ba(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await yn(this._db,Ze,Fn)||0}async setPreferredSkinTone(e){return Gt(e),await this.ready(),Ra(this._db,Ze,Fn,e)}async incrementFavoriteEmojiCount(e){return vt(e),await this.ready(),Ua(this._db,e)}async getTopFavoriteEmoji(e){return Gt(e),await this.ready(),(await $a(this._db,this._custom,e)).map(rt)}set customEmoji(e){this._custom=Wn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await vn(this._dbName)}async delete(){await this._shutdown(),await Ca(this._dbName)}}const sn=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([t,e,r])=>({id:t,emoji:e,name:r})),Kt=sn.slice(1),Za=2,zn=6,hr=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function qn(t){return t.unicode.includes("‍")}const eo={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},to=1e3,no="🖐️",ro=8,ao=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],pr='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',oo=(t,e)=>t<e?-1:t>e?1:0,Hn=(t,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const o=r.getContext("2d");return o.textBaseline="top",o.font=`100px ${pr}`,o.fillStyle=e,o.scale(.01,.01),o.fillText(t,0,0),o.getImageData(0,0,1,1).data},so=(t,e)=>{const r=[...t].join(","),o=[...e].join(",");return r===o&&!r.startsWith("0,0,0,")};function io(t){const e=Hn(t,"#000"),r=Hn(t,"#fff");return e&&r&&so(e,r)}function co(){const t=Object.entries(eo);try{for(const[e,r]of t)if(io(e))return r}catch{}finally{}return t[0][1]}let Xt;const Jt=()=>(Xt||(Xt=new Promise(t=>hr(()=>t(co())))),Xt),cn=new Map,lo="️",uo="\uD83C",fo="‍",mo=127995,ho=57339;function po(t,e){if(e===0)return t;const r=t.indexOf(fo);return r!==-1?t.substring(0,r)+String.fromCodePoint(mo+e-1)+t.substring(r):(t.endsWith(lo)&&(t=t.substring(0,t.length-1)),t+uo+String.fromCodePoint(ho+e-1))}function Ae(t){t.preventDefault(),t.stopPropagation()}function Qt(t,e,r){return e+=t?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function vr(t,e){const r=new Set,o=[];for(const i of t){const n=e(i);r.has(n)||(r.add(n),o.push(i))}return o}function vo(t,e){const r=o=>{const i={};for(const n of o)typeof n.tone=="number"&&n.version<=e&&(i[n.tone]=n.unicode);return i};return t.map(({unicode:o,skins:i,shortcodes:n,url:c,name:p,category:m,annotation:l})=>({unicode:o,name:p,shortcodes:n,url:c,category:m,annotation:l,id:o||p,skins:i&&r(i)}))}const St=requestAnimationFrame;let go=typeof ResizeObserver=="function";function yo(t,e,r){let o;go?(o=new ResizeObserver(i=>r(i[0].contentRect.width)),o.observe(t)):St(()=>r(t.getBoundingClientRect().width)),e.addEventListener("abort",()=>{o&&o.disconnect()})}function Yn(t){{const e=document.createRange();return e.selectNode(t.firstChild),e.getBoundingClientRect().width}}let Zt;function bo(t,e,r){for(const o of t){const i=r(o),n=Yn(i);typeof Zt>"u"&&(Zt=Yn(e));const c=n/1.8<Zt;cn.set(o.unicode,c)}}function Eo(t){return vr(t,e=>e)}function So(t){t&&(t.scrollTop=0)}function it(t,e,r){let o=t.get(e);return o||(o=r(),t.set(e,o)),o}function Gn(t){return""+t}function wo(t){const e=document.createElement("template");return e.innerHTML=t,e}const To=new WeakMap,ko=new WeakMap,xo=Symbol("un-keyed"),Co="replaceChildren"in Element.prototype;function Io(t,e){Co?t.replaceChildren(...e):(t.innerHTML="",t.append(...e))}function No(t,e){let r=t.firstChild,o=0;for(;r;){if(e[o]!==r)return!0;r=r.nextSibling,o++}return o!==e.length}function Ao(t,e){const{targetNode:r}=e;let{targetParentNode:o}=e,i=!1;o?i=No(o,t):(i=!0,e.targetNode=void 0,e.targetParentNode=o=r.parentNode),i&&Io(o,t)}function _o(t,e){for(const r of e){const{targetNode:o,currentExpression:i,binding:{expressionIndex:n,attributeName:c,attributeValuePre:p,attributeValuePost:m}}=r,l=t[n];if(i!==l)if(r.currentExpression=l,c)o.setAttribute(c,p+Gn(l)+m);else{let g;Array.isArray(l)?Ao(l,r):l instanceof Element?(g=l,o.replaceWith(g)):o.nodeValue=Gn(l),g&&(r.targetNode=g)}}}function Do(t){let e="",r=!1,o=!1,i=-1;const n=new Map,c=[];for(let m=0,l=t.length;m<l;m++){const g=t[m];if(e+=g,m===l-1)break;for(let E=0;E<g.length;E++)switch(g.charAt(E)){case"<":{g.charAt(E+1)==="/"?c.pop():(r=!0,c.push(++i));break}case">":{r=!1,o=!1;break}case"=":{o=!0;break}}const f=c[c.length-1],d=it(n,f,()=>[]);let S,D,_;if(o){const E=/(\S+)="?([^"=]*)$/.exec(g);S=E[1],D=E[2],_=/^[^">]*/.exec(t[m+1])[0]}const y={attributeName:S,attributeValuePre:D,attributeValuePost:_,expressionIndex:m};d.push(y),!r&&!o&&(e+=" ")}return{template:wo(e),elementsToBindings:n}}function Lo(t,e){const r=[],o=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT);let i=t,n=-1;do{const c=e.get(++n);if(c)for(let p=0;p<c.length;p++){const m=c[p],l=m.attributeName?i:i.firstChild,g={binding:m,targetNode:l,targetParentNode:void 0,currentExpression:void 0};r.push(g)}}while(i=o.nextNode());return r}function Mo(t){const{template:e,elementsToBindings:r}=it(To,t,()=>Do(t)),o=e.cloneNode(!0).content.firstElementChild,i=Lo(o,r);return function(c){return _o(c,i),o}}function Oo(t){const e=it(ko,t,()=>new Map);let r=xo;function o(n,...c){const p=it(e,n,()=>new Map);return it(p,r,()=>Mo(n))(c)}function i(n,c,p){return n.map((m,l)=>{const g=r;r=p(m);try{return c(m,l)}finally{r=g}})}return{map:i,html:o}}function Po(t,e,r,o,i,n,c,p){const{labelWithSkin:m,titleForEmoji:l,unicodeWithSkin:g}=r,{html:f,map:d}=Oo(e);function S(y,E,C){return d(y,(T,M)=>f`<button role="${E?"option":"menuitem"}" aria-selected="${e.searchMode?M===e.activeSearchItem:""}" aria-label="${m(T,e.currentSkinTone)}" title="${l(T)}" class="emoji ${E&&M===e.activeSearchItem?"active":""}" id="${`${C}-${T.id}`}">${T.unicode?g(T,e.currentSkinTone):f`<img class="custom-emoji" src="${T.url}" alt="" loading="lazy">`}</button>`,T=>`${C}-${T.id}`)}const _=f`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${d(e.skinTones,(y,E)=>f`<div id="skintone-${E}" class="emoji ${E===e.activeSkinTone?"active":""}" aria-selected="${E===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[E]}" aria-label="${e.i18n.skinTones[E]}">${y}</div>`,y=>y)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${d(e.groups,y=>f`<button role="tab" class="nav-button" aria-controls="tab-${y.id}" aria-label="${e.i18n.categories[y.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===y.id}" title="${e.i18n.categories[y.name]}" data-group-id="${y.id}"><div class="nav-emoji emoji">${y.emoji}</div></button>`,y=>y.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${d(e.currentEmojisWithCategories,(y,E)=>f`<div><div id="menu-label-${E}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:y.category?y.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${E}" id="${e.searchMode?"search-results":""}">${S(y.emojis,e.searchMode,"emo")}</div></div>`,y=>y.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${S(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(p){t.appendChild(_);const y=(E,C)=>{for(const T of t.querySelectorAll(`[${E}]`))C(T,T.getAttribute(E))};for(const E of["click","focusout","input","keydown","keyup"])y(`data-on-${E}`,(C,T)=>{C.addEventListener(E,o[T])});y("data-ref",(E,C)=>{n[C]=E}),y("data-action",(E,C)=>{i[C](E)}),c.addEventListener("abort",()=>{t.removeChild(_)})}}const xt=typeof queueMicrotask=="function"?queueMicrotask:t=>Promise.resolve().then(t);function jo(t){let e=!1,r;const o=new Map,i=new Set;let n;const c=()=>{if(e)return;const l=[...i];i.clear();try{for(const g of l)g()}finally{n=!1,i.size&&(n=!0,xt(c))}},p=new Proxy({},{get(l,g){if(r){let f=o.get(g);f||(f=new Set,o.set(g,f)),f.add(r)}return l[g]},set(l,g,f){l[g]=f;const d=o.get(g);if(d){for(const S of d)i.add(S);n||(n=!0,xt(c))}return!0}}),m=l=>{const g=()=>{const f=r;r=g;try{return l()}finally{r=f}};return g()};return t.addEventListener("abort",()=>{e=!0}),{state:p,createEffect:m}}function en(t,e,r){if(t.length!==e.length)return!1;for(let o=0;o<t.length;o++)if(!r(t[o],e[o]))return!1;return!0}const tn=[],{assign:yt}=Object;function Bo(t,e){const r={},o=new AbortController,i=o.signal,{state:n,createEffect:c}=jo(i);yt(n,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),yt(n,e),yt(n,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:ro,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:Kt,databaseLoaded:!1,activeSearchItemId:void 0}),c(()=>{n.currentGroup!==n.groups[n.currentGroupIndex]&&(n.currentGroup=n.groups[n.currentGroupIndex])});const p=k=>{t.getElementById(k).focus()},m=k=>t.getElementById(`emo-${k.id}`),l=(k,j)=>{r.rootElement.dispatchEvent(new CustomEvent(k,{detail:j,bubbles:!0,composed:!0}))},g=(k,j)=>k.id===j.id,f=(k,j)=>{const{category:q,emojis:H}=k,{category:ne,emojis:ee}=j;return q!==ne?!1:en(H,ee,g)},d=k=>{en(n.currentEmojis,k,g)||(n.currentEmojis=k)},S=k=>{n.searchMode!==k&&(n.searchMode=k)},D=k=>{en(n.currentEmojisWithCategories,k,f)||(n.currentEmojisWithCategories=k)},_=(k,j)=>j&&k.skins&&k.skins[j]||k.unicode,C={labelWithSkin:(k,j)=>Eo([k.name||_(k,j),k.annotation,...k.shortcodes||tn].filter(Boolean)).join(", "),titleForEmoji:k=>k.annotation||(k.shortcodes||tn).join(", "),unicodeWithSkin:_},T={onClickSkinToneButton:J,onEmojiClick:Y,onNavClick:x,onNavKeydown:F,onSearchKeydown:A,onSkinToneOptionsClick:Z,onSkinToneOptionsFocusOut:re,onSkinToneOptionsKeydown:ie,onSkinToneOptionsKeyup:W,onSearchInput:ve},M={calculateEmojiGridStyle:$};let w=!0;c(()=>{Po(t,n,C,T,M,r,i,w),w=!1}),n.emojiVersion||Jt().then(k=>{k||(n.message=n.i18n.emojiUnsupportedMessage)}),c(()=>{async function k(){let j=!1;const q=setTimeout(()=>{j=!0,n.message=n.i18n.loadingMessage},to);try{await n.database.ready(),n.databaseLoaded=!0}catch(H){console.error(H),n.message=n.i18n.networkErrorMessage}finally{clearTimeout(q),j&&(j=!1,n.message="")}}n.database&&k()}),c(()=>{n.pickerStyle=`
      --num-groups: ${n.groups.length}; 
      --indicator-opacity: ${n.searchMode?0:1}; 
      --num-skintones: ${zn};`}),c(()=>{n.customEmoji&&n.database&&U()}),c(()=>{n.customEmoji&&n.customEmoji.length?n.groups!==sn&&(n.groups=sn):n.groups!==Kt&&(n.currentGroupIndex&&n.currentGroupIndex--,n.groups=Kt)}),c(()=>{async function k(){n.databaseLoaded&&(n.currentSkinTone=await n.database.getPreferredSkinTone())}k()}),c(()=>{n.skinTones=Array(zn).fill().map((k,j)=>po(n.skinToneEmoji,j))}),c(()=>{n.skinToneButtonText=n.skinTones[n.currentSkinTone]}),c(()=>{n.skinToneButtonLabel=n.i18n.skinToneLabel.replace("{skinTone}",n.i18n.skinTones[n.currentSkinTone])}),c(()=>{async function k(){const{database:j}=n,q=(await Promise.all(ao.map(H=>j.getEmojiByUnicodeOrName(H)))).filter(Boolean);n.defaultFavoriteEmojis=q}n.databaseLoaded&&k()});function U(){n.database.customEmoji=n.customEmoji||tn}c(()=>{async function k(){U();const{database:j,defaultFavoriteEmojis:q,numColumns:H}=n,ne=await j.getTopFavoriteEmoji(H),ee=await ue(vr([...ne,...q],we=>we.unicode||we.name).slice(0,H));n.currentFavorites=ee}n.databaseLoaded&&n.defaultFavoriteEmojis&&k()});function $(k){yo(k,i,j=>{{const q=getComputedStyle(r.rootElement),H=parseInt(q.getPropertyValue("--num-columns"),10),ne=q.getPropertyValue("direction")==="rtl",we=k.parentElement.getBoundingClientRect().width-j;n.numColumns=H,n.scrollbarWidth=we,n.isRtl=ne}})}c(()=>{async function k(){const{searchText:j,currentGroup:q,databaseLoaded:H,customEmoji:ne}=n;if(!H)n.currentEmojis=[],n.searchMode=!1;else if(j.length>=Za){const ee=await he(j);n.searchText===j&&(d(ee),S(!0))}else{const{id:ee}=q;if(ee!==-1||ne&&ne.length){const we=await pe(ee);n.currentGroup.id===ee&&(d(we),S(!1))}}}k()}),c(()=>{const{currentEmojis:k,emojiVersion:j}=n,q=k.filter(H=>H.unicode).filter(H=>qn(H)&&!cn.has(H.unicode));if(!j&&q.length)d(k),St(()=>G(q));else{const H=j?k:k.filter(de);d(H),St(()=>So(r.tabpanelElement))}});function G(k){bo(k,r.baselineEmoji,m),n.currentEmojis=n.currentEmojis}function de(k){return!k.unicode||!qn(k)||cn.get(k.unicode)}async function se(k){const j=n.emojiVersion||await Jt();return k.filter(({version:q})=>!q||q<=j)}async function ue(k){return vo(k,n.emojiVersion||await Jt())}async function pe(k){const j=k===-1?n.customEmoji:await n.database.getEmojiByGroup(k);return ue(await se(j))}async function he(k){return ue(await se(await n.database.getEmojiBySearchQuery(k)))}c(()=>{}),c(()=>{function k(){const{searchMode:q,currentEmojis:H}=n;if(q)return[{category:"",emojis:H}];const ne=new Map;for(const ee of H){const we=ee.category||"";let Ye=ne.get(we);Ye||(Ye=[],ne.set(we,Ye)),Ye.push(ee)}return[...ne.entries()].map(([ee,we])=>({category:ee,emojis:we})).sort((ee,we)=>n.customCategorySorting(ee.category,we.category))}const j=k();D(j)}),c(()=>{n.activeSearchItemId=n.activeSearchItem!==-1&&n.currentEmojis[n.activeSearchItem].id}),c(()=>{const{rawSearchText:k}=n;hr(()=>{n.searchText=(k||"").trim(),n.activeSearchItem=-1})});function A(k){if(!n.searchMode||!n.currentEmojis.length)return;const j=q=>{Ae(k),n.activeSearchItem=Qt(q,n.activeSearchItem,n.currentEmojis)};switch(k.key){case"ArrowDown":return j(!1);case"ArrowUp":return j(!0);case"Enter":if(n.activeSearchItem===-1)n.activeSearchItem=0;else return Ae(k),V(n.currentEmojis[n.activeSearchItem].id)}}function x(k){const{target:j}=k,q=j.closest(".nav-button");if(!q)return;const H=parseInt(q.dataset.groupId,10);r.searchElement.value="",n.rawSearchText="",n.searchText="",n.activeSearchItem=-1,n.currentGroupIndex=n.groups.findIndex(ne=>ne.id===H)}function F(k){const{target:j,key:q}=k,H=ne=>{ne&&(Ae(k),ne.focus())};switch(q){case"ArrowLeft":return H(j.previousElementSibling);case"ArrowRight":return H(j.nextElementSibling);case"Home":return H(j.parentElement.firstElementChild);case"End":return H(j.parentElement.lastElementChild)}}async function V(k){const j=await n.database.getEmojiByUnicodeOrName(k),q=[...n.currentEmojis,...n.currentFavorites].find(ne=>ne.id===k),H=q.unicode&&_(q,n.currentSkinTone);await n.database.incrementFavoriteEmojiCount(k),l("emoji-click",{emoji:j,skinTone:n.currentSkinTone,...H&&{unicode:H},...q.name&&{name:q.name}})}async function Y(k){const{target:j}=k;if(!j.classList.contains("emoji"))return;Ae(k);const q=j.id.substring(4);V(q)}function X(k){n.currentSkinTone=k,n.skinTonePickerExpanded=!1,p("skintone-button"),l("skin-tone-change",{skinTone:k}),n.database.setPreferredSkinTone(k)}function Z(k){const{target:{id:j}}=k,q=j&&j.match(/^skintone-(\d)/);if(!q)return;Ae(k);const H=parseInt(q[1],10);X(H)}function J(k){n.skinTonePickerExpanded=!n.skinTonePickerExpanded,n.activeSkinTone=n.currentSkinTone,n.skinTonePickerExpanded&&(Ae(k),St(()=>p("skintone-list")))}c(()=>{n.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{n.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):n.skinTonePickerExpandedAfterAnimation=!1});function ie(k){if(!n.skinTonePickerExpanded)return;const j=async q=>{Ae(k),n.activeSkinTone=q};switch(k.key){case"ArrowUp":return j(Qt(!0,n.activeSkinTone,n.skinTones));case"ArrowDown":return j(Qt(!1,n.activeSkinTone,n.skinTones));case"Home":return j(0);case"End":return j(n.skinTones.length-1);case"Enter":return Ae(k),X(n.activeSkinTone);case"Escape":return Ae(k),n.skinTonePickerExpanded=!1,p("skintone-button")}}function W(k){if(n.skinTonePickerExpanded)switch(k.key){case" ":return Ae(k),X(n.activeSkinTone)}}async function re(k){const{relatedTarget:j}=k;(!j||j.id!=="skintone-list")&&(n.skinTonePickerExpanded=!1)}function ve(k){n.rawSearchText=k.target.value}return{$set(k){yt(n,k)},$destroy(){o.abort()}}}const Ro="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Uo="en";var $o={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Fo=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const gr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],Vo=`:host{--emoji-font-family:${pr}}`;class bn extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=Fo+Vo,this.shadowRoot.appendChild(r),this._ctx={locale:Uo,dataSource:Ro,skinToneEmoji:no,customCategorySorting:oo,customEmoji:null,i18n:$o,emojiVersion:null,...e};for(const o of gr)o!=="database"&&Object.prototype.hasOwnProperty.call(this,o)&&(this._ctx[o]=this[o],delete this[o]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Bo(this.shadowRoot,this._ctx))}disconnectedCallback(){xt(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,o){this._set(e.replace(/-([a-z])/g,(i,n)=>n.toUpperCase()),e==="emoji-version"?parseFloat(o):o)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:o}=this._ctx;(!o||o.locale!==e||o.dataSource!==r)&&this._set("database",new Qa({locale:e,dataSource:r}))}_dbFlush(){xt(()=>this._dbCreate())}}const yr={};for(const t of gr)yr[t]={get(){return t==="database"&&this._dbCreate(),this._ctx[t]},set(e){if(t==="database")throw new Error("database is read-only");this._set(t,e)}};Object.defineProperties(bn.prototype,yr);customElements.get("emoji-picker")||customElements.define("emoji-picker",bn);var ln={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(t,e){(function(r,o){o(e)})(at,function(r){var o="dnd-poly-",i=o+"snapback",n="dnd-poly-",c=n+"dragstart-pending",p=n+"dragstart-cancel",m=["none","copy","copyLink","copyMove","link","linkMove","move","all"],l=["none","copy","move","link"],g=function(){var A=!1;try{var x=Object.defineProperty({},"passive",{get:function(){A=!0}});window.addEventListener("test",null,x)}catch{}return A}();function f(A){return A&&A.tagName}function d(A,x,F){F===void 0&&(F=!0),document.addEventListener(A,x,!!g&&{passive:F})}function S(A,x){document.removeEventListener(A,x)}function D(A,x,F,V){V===void 0&&(V=!1);var Y=g?{passive:!0,capture:V}:V;return A.addEventListener(x,F,Y),{off:function(){A.removeEventListener(x,F,Y)}}}function _(A){return A.length===0?0:A.reduce(function(x,F){return F+x},0)/A.length}function y(A,x){for(var F=0;F<A.changedTouches.length;F++)if(A.changedTouches[F].identifier===x)return!0;return!1}function E(A,x,F){for(var V=[],Y=[],X=0;X<x.touches.length;X++){var Z=x.touches[X];V.push(Z[A+"X"]),Y.push(Z[A+"Y"])}F.x=_(V),F.y=_(Y)}var C=["","-webkit-"];function T(A,x,F,V,Y){Y===void 0&&(Y=!0);var X=x.x,Z=x.y;V&&(X+=V.x,Z+=V.y),Y&&(X-=parseInt(A.offsetWidth,10)/2,Z-=parseInt(A.offsetHeight,10)/2);for(var J="translate3d("+X+"px,"+Z+"px, 0)",ie=0;ie<C.length;ie++){var W=C[ie]+"transform";A.style[W]=J+" "+F[ie]}}var M=function(){function A(x,F){this.t=x,this.i=F,this.s=l[0]}return Object.defineProperty(A.prototype,"dropEffect",{get:function(){return this.s},set:function(x){this.t.mode!==0&&m.indexOf(x)>-1&&(this.s=x)},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(A.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(x){this.t.mode===2&&m.indexOf(x)>-1&&(this.t.effectAllowed=x)},enumerable:!0,configurable:!0}),A.prototype.setData=function(x,F){if(this.t.mode===2){if(x.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[x]=F,this.t.types.indexOf(x)===-1&&this.t.types.push(x)}},A.prototype.getData=function(x){if(this.t.mode===1||this.t.mode===2)return this.t.data[x]||""},A.prototype.clearData=function(x){if(this.t.mode===2){if(x&&this.t.data[x]){delete this.t.data[x];var F=this.t.types.indexOf(x);return void(F>-1&&this.t.types.splice(F,1))}this.t.data={},this.t.types=[]}},A.prototype.setDragImage=function(x,F,V){this.t.mode===2&&this.i(x,F,V)},A}();function w(A,x){return A?A===m[0]?l[0]:A.indexOf(m[1])===0||A===m[7]?l[1]:A.indexOf(m[4])===0?l[3]:A===m[6]?l[2]:l[1]:x.nodeType===3&&x.tagName==="A"?l[3]:l[1]}function U(A,x,F,V,Y,X,Z){X===void 0&&(X=!0),Z===void 0&&(Z=null);var J=function(W,re,ve,k,j,q,H){H===void 0&&(H=null);var ne=re.changedTouches[0],ee=new Event(ve,{bubbles:!0,cancelable:k});ee.dataTransfer=q,ee.relatedTarget=H,ee.screenX=ne.screenX,ee.screenY=ne.screenY,ee.clientX=ne.clientX,ee.clientY=ne.clientY,ee.pageX=ne.pageX,ee.pageY=ne.pageY;var we=W.getBoundingClientRect();return ee.offsetX=ee.clientX-we.left,ee.offsetY=ee.clientY-we.top,ee}(x,F,A,X,document.defaultView,Y,Z),ie=!x.dispatchEvent(J);return V.mode=0,ie}function $(A,x){if(!A||A===m[7])return x;if(x===l[1]){if(A.indexOf(l[1])===0)return l[1]}else if(x===l[3]){if(A.indexOf(l[3])===0||A.indexOf("Link")>-1)return l[3]}else if(x===l[2]&&(A.indexOf(l[2])===0||A.indexOf("Move")>-1))return l[2];return l[0]}var G,de=function(){function A(x,F,V,Y){this.h=x,this.o=F,this.u=V,this.l=Y,this.v=0,this.p=null,this.g=null,this.m=x,this.I=x.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),d("touchmove",this.j,!1),d("touchend",this.S,!1),d("touchcancel",this.S,!1)}return A.prototype.A=function(){var x=this;this.v=1,this.O=l[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var F=this.u;if(this.N=new M(this.D,function(J,ie,W){F=J,typeof ie!="number"&&typeof W!="number"||(x.P={x:ie||0,y:W||0})}),this.D.mode=2,this.N.dropEffect=l[0],U("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;E("page",this.m,this.F);var V,Y=this.o.dragImageSetup(F);if(this.L=(V=Y,C.map(function(J){var ie=V.style[J+"transform"];return ie&&ie!=="none"?ie.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),Y.style.position="absolute",Y.style.left="0px",Y.style.top="0px",Y.style.zIndex="999999",Y.classList.add("dnd-poly-drag-image"),Y.classList.add("dnd-poly-icon"),this._=Y,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var X=getComputedStyle(F);this.P={x:0-parseInt(X.marginLeft,10),y:0-parseInt(X.marginTop,10)}}else{var Z=F.getBoundingClientRect();X=getComputedStyle(F),this.P={x:Z.left-this.I.clientX-parseInt(X.marginLeft,10)+Z.width/2,y:Z.top-this.I.clientY-parseInt(X.marginTop,10)+Z.height/2}}return T(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){x.X||(x.X=!0,x.Y(),x.X=!1)},this.o.iterationInterval),!0},A.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),S("touchmove",this.j),S("touchend",this.S),S("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},A.prototype.C=function(x){var F=this;if(y(x,this.I.identifier)!==!1){if(this.m=x,this.v===0){var V=void 0;if(this.o.dragStartConditionOverride)try{V=this.o.dragStartConditionOverride(x)}catch{V=!1}else V=x.touches.length===1;return V?void(this.A()===!0&&(this.h.preventDefault(),x.preventDefault())):void this.T()}if(x.preventDefault(),E("client",x,this.M),E("page",x,this.F),this.o.dragImageTranslateOverride)try{var Y=!1;if(this.o.dragImageTranslateOverride(x,{x:this.M.x,y:this.M.y},this.p,function(X,Z){F._&&(Y=!0,F.M.x+=X,F.M.y+=Z,F.F.x+=X,F.F.y+=Z,T(F._,F.F,F.L,F.P,F.o.dragImageCenterOnTouch))}),Y)return}catch{}T(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},A.prototype.k=function(x){if(y(x,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(x.preventDefault(),this.v=x.type==="touchcancel"?3:2):this.T()}},A.prototype.Y=function(){var x=this,F=this.O;this.D.mode=3,this.N.dropEffect=l[0];var V=U("drag",this.u,this.m,this.D,this.N);if(V&&(this.O=l[0]),V||this.v===2||this.v===3)return this.q(this.v)?void function(J,ie,W,re){var ve=getComputedStyle(J);if(ve.visibility!=="hidden"&&ve.display!=="none"){ie.classList.add(i);var k=getComputedStyle(ie),j=parseFloat(k.transitionDuration);if(isNaN(j)||j===0)re();else{var q=J.getBoundingClientRect(),H={x:q.left,y:q.top};H.x+=document.body.scrollLeft||document.documentElement.scrollLeft,H.y+=document.body.scrollTop||document.documentElement.scrollTop,H.x-=parseInt(ve.marginLeft,10),H.y-=parseInt(ve.marginTop,10);var ne=parseFloat(k.transitionDelay),ee=Math.round(1e3*(j+ne));T(ie,H,W,void 0,!1),setTimeout(re,ee)}}else re()}(this.u,this._,this.L,function(){x.B()}):void this.B();var Y=this.o.elementFromPoint(this.M.x,this.M.y),X=this.g;Y!==this.p&&Y!==this.g&&(this.p=Y,this.g!==null&&(this.D.mode=3,this.N.dropEffect=l[0],U("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=w(this.D.effectAllowed,this.u),U("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=$(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),X!==this.g&&f(X)&&(this.D.mode=3,this.N.dropEffect=l[0],U("dragleave",X,this.m,this.D,this.N,!1,this.g)),f(this.g)&&(this.D.mode=3,this.N.dropEffect=w(this.D.effectAllowed,this.u),U("dragover",this.g,this.m,this.D,this.N)===!1?this.O=l[0]:this.O=$(this.N.effectAllowed,this.N.dropEffect)),F!==this.O&&this._.classList.remove(o+F);var Z=o+this.O;this._.classList.add(Z)},A.prototype.q=function(x){var F=this.O===l[0]||this.g===null||x===3;return F?f(this.g)&&(this.D.mode=3,this.N.dropEffect=l[0],U("dragleave",this.g,this.m,this.D,this.N,!1)):f(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,U("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=l[0]),F},A.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,U("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},A}(),se={iterationInterval:150,tryFindDraggableTarget:function(A){var x=A.target;do if(x.draggable!==!1&&(x.draggable===!0||x.getAttribute&&x.getAttribute("draggable")==="true"))return x;while((x=x.parentNode)&&x!==document.body)},dragImageSetup:function(A){var x=A.cloneNode(!0);return function F(V,Y){if(V.nodeType===1){for(var X=getComputedStyle(V),Z=0;Z<X.length;Z++){var J=X[Z];Y.style.setProperty(J,X.getPropertyValue(J),X.getPropertyPriority(J))}if(Y.style.pointerEvents="none",Y.removeAttribute("id"),Y.removeAttribute("class"),Y.removeAttribute("draggable"),Y.nodeName==="CANVAS"){var ie=V,W=Y,re=ie.getContext("2d").getImageData(0,0,ie.width,ie.height);W.getContext("2d").putImageData(re,0,0)}}if(V.hasChildNodes())for(Z=0;Z<V.childNodes.length;Z++)F(V.childNodes[Z],Y.childNodes[Z])}(A,x),x},elementFromPoint:function(A,x){return document.elementFromPoint(A,x)}};function ue(A){if(!G){var x=se.tryFindDraggableTarget(A);if(x)try{G=new de(A,se,x,he)}catch(F){throw he(se,A,3),F}}}function pe(A){var x=A.target,F=function(ie){Y.off(),X.off(),Z.off(),J.off(),x&&x.dispatchEvent(new CustomEvent(p,{bubbles:!0,cancelable:!0})),clearTimeout(V)};x&&x.dispatchEvent(new CustomEvent(c,{bubbles:!0,cancelable:!0}));var V=window.setTimeout(function(){Y.off(),X.off(),Z.off(),J.off(),ue(A)},se.holdToDrag),Y=D(x,"touchend",F),X=D(x,"touchcancel",F),Z=D(x,"touchmove",F),J=D(window,"scroll",F,!0)}function he(A,x,F){if(F===0&&A.defaultActionOverride)try{A.defaultActionOverride(x),x.defaultPrevented}catch{}G=null}r.polyfill=function(A){if(A&&Object.keys(A).forEach(function(Y){se[Y]=A[Y]}),!se.forceApply){var x=(F={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},V=!!window.chrome||/chrome/i.test(navigator.userAgent),F.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||V&&"ontouchstart"in document.documentElement),F);if(x.userAgentSupportingNativeDnD&&x.draggable&&x.dragEvents)return!1}var F,V;return se.holdToDrag?d("touchstart",pe,!1):d("touchstart",ue,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(ln,ln.exports);var Wo=ln.exports;const zo=t=>typeof t!="string"?t:t.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),Me=(t,e)=>{t.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{t.classList.add(e)})})},qo=()=>{const t=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${t.height}px`);t.addEventListener("resize",e),e()};let Kn;const Ho=(t=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),o=()=>{clearTimeout(r),clearTimeout(Kn),Kn=setTimeout(()=>{t.removeEventListener("scroll",o),e()},100)};t.addEventListener("scroll",o)}),Yo="0.6.3 Beta",Ve=document.querySelector(".editor"),me=document.getElementById("tones"),Ee=document.getElementById("action"),oe=document.getElementById("musical-score"),Fe=document.getElementById("add-track"),ct=document.getElementById("remove-track"),We=document.getElementById("dialog"),ae=document.forms["dialog-form"];ae._title=ae.querySelector(".form-title");ae.description=ae.querySelector(".description");ae.inputs=ae.querySelector(".inputs");ae.buttons=ae.querySelector(".buttons");const Ct=document.getElementById("play"),It=document.getElementById("clear"),Go=document.getElementById("warn-out"),Ko=document.getElementById("mml"),Ue=document.getElementById("copy"),Be=document.getElementById("paste"),Nt=document.getElementById("save"),un=document.getElementById("open"),Rt=document.getElementById("ctrl"),At=document.getElementById("undo"),_t=document.getElementById("redo");var ut,fe,Ne,Xe;class Xo{constructor(){Te(this,ut,`#COMMENT Generated by FlMML VisualSequencer v${Yo}`);Te(this,fe,[]);Te(this,Ne,(e,r)=>{});Te(this,Xe,(e,r)=>{})}set onChange(e){Ce(this,Ne,e)}set onError(e){Ce(this,Xe,e)}setMmlArr(e){Ce(this,fe,e),R(this,Ne).call(this,this.getMmlArr(),this.getMml())}setMml(e){Ce(this,fe,e.split(`
`)),R(this,fe).at(-2)===""&&R(this,fe).at(-1)===R(this,ut)&&R(this,fe).splice(-2,2),R(this,Ne).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return R(this,fe)}getMml(){return R(this,fe).length?R(this,fe).concat(["",R(this,ut)]).join(`
`):""}getMmlLine(e){return R(this,fe)[e]}insert(e,r){Object.hasOwn(R(this,fe),e)||e===0?(R(this,fe).splice(e,0,r),R(this,Ne).call(this,this.getMmlArr(),this.getMml())):R(this,Xe).call(this,"範囲外の書き換え指定",`範囲${R(this,fe).length-1}までのところ、${e}`)}append(e){R(this,fe).push(e),R(this,Ne).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(R(this,fe),e)?(R(this,fe)[e]+=r,R(this,Ne).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(R(this,fe),e)?(R(this,fe)[e]=r+R(this,fe)[e],R(this,Ne).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(R(this,fe),e)?(R(this,fe)[e]=r,R(this,Ne).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(R(this,fe),e)&&R(this,fe).splice(e,r).length!==0?R(this,Ne).call(this,this.getMmlArr(),this.getMml()):R(this,Xe).call(this,"無効な指定",`範囲${R(this,fe).length-1}までの中で${e}から${r}削除するのはできません`)}}ut=new WeakMap,fe=new WeakMap,Ne=new WeakMap,Xe=new WeakMap;var ke,Je,dt,$e;class Jo{constructor(e,r){Te(this,ke,[]);Te(this,Je,[]);Te(this,dt,null);Te(this,$e,null);this.tonesElem=e,this.areaElem=r,Ce(this,$e,this.areaElem.querySelector(".track.active"))}set activeTrack(e){R(this,$e).classList.remove("active"),Ce(this,$e,e),R(this,$e).classList.add("active")}get activeTrack(){return R(this,$e)}blocksDataUpdate(){Ce(this,ke,[...this.areaElem.querySelectorAll(".track button")].map(e=>({label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),tone:{tone:e.dataset.tone,tonePitch:e.dataset.tonePitch},tempo:e.dataset.tempo,noteValue:e.dataset.noteValue,rest:e.dataset.rest,octave:e.dataset.octave,velocity:e.dataset.velocity,noteShift:e.dataset.noteShift,detune:e.dataset.detune,tieSlur:e.dataset.tieSlur,repeatStartEnd:e.dataset.repeatStartEnd,repeatBreak:e.dataset.repeatBreak,polyStartEnd:e.dataset.polyStartEnd,macroDef:e.dataset.macroDef,macroArgUse:e.dataset.macroArgUse,macroUse:e.dataset.macroUse,metaData:e.dataset.metaData,otherAction:e.dataset.otherAction,elem:e})))}saveBlocksData(){clearTimeout(R(this,dt)),Ce(this,dt,setTimeout(()=>{const e=JSON.parse(JSON.stringify(R(this,ke)));nn.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){nn.getItem("BlocksData").then(e=>{e&&(Ce(this,ke,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Q))})}parseBlocks(){const e=R(this,ke);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let o=0;e.forEach(i=>{if(i.trackNo!==o){const g=document.createElement("ul");g.classList.add("track"),this.activeTrack=g,this.areaElem.insertBefore(g,Fe),o=i.trackNo}const n=document.createElement("li"),c='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',p=(()=>{const g=document.createElement("div");return g.innerHTML=c,g.firstElementChild})(),m=document.querySelector(`[class*="${i.className.replace(/ material-icons| droppable| bounce| pop| done| inactive/g,"")}"]`),l=(m==null?void 0:m.cloneNode(!0))||p;i.label&&(l.ariaLabel=i.label),l.className=i.className,i.tone.tonePitch&&(i.label!=="無調整"&&(l.textContent=i.label),l.dataset.tone=i.tone.tone,m?m.replaceWith(l.cloneNode(!0)):r.appendChild(l.cloneNode(!0)),l.dataset.tonePitch=i.tone.tonePitch),i.tempo&&(l.dataset.tempo=i.tempo),i.noteValue&&(l.dataset.noteValue=i.noteValue),i.rest&&(l.dataset.rest=i.rest),i.octave&&(l.dataset.octave=i.octave),i.velocity&&(l.dataset.velocity=i.velocity),i.noteShift&&(l.dataset.noteShift=i.noteShift),i.detune&&(l.dataset.detune=i.detune),i.tieSlur&&(l.dataset.tieSlur=i.tieSlur,i.tieSlur==="&"?l.ariaLabel="スラー":l.ariaLabel="タイ"),i.repeatStartEnd&&(l.dataset.repeatStartEnd=i.repeatStartEnd,i.repeatStartEnd.startsWith("/:")?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆"):i.repeatStartEnd===":/"&&(l.ariaLabel="リピート終了")),i.repeatBreak&&(l.dataset.repeatBreak=i.repeatBreak),i.polyStartEnd&&(l.dataset.polyStartEnd=i.polyStartEnd),i.macroDef&&(l.dataset.macroDef=i.macroDef,l.textContent=i.macroDef===";"?";":"$="),i.macroArgUse&&(l.dataset.macroArgUse=i.macroArgUse),i.macroUse&&(l.dataset.macroUse=i.macroUse),i.metaData&&(l.dataset.metaData=i.metaData),i.otherAction&&(l.dataset.otherAction=i.otherAction,l.textContent=i.otherAction.length>4?"…":i.otherAction),n.appendChild(l),this.activeTrack.appendChild(n)})}exportMml(e){e.setMmlArr([]);let r=0,o=0;const i=R(this,ke).filter(y=>y.tone.tone!==void 0),n=()=>i.filter(y=>y.trackNo===o),c=()=>new Set(n().map(y=>y.tone.tone));let p=c(),m=0,l=!1,g={noteValue:4,dots:0},f=!1,d=!1;const S=R(this,ke).findIndex(y=>y.elem.classList.contains("play-from-here")),D=S!==-1,_=D?R(this,ke)[S].trackNo:-1;R(this,ke).forEach((y,E)=>{const{tone:C,tonePitch:T}=y.tone,M=!D||d||D&&y.trackNo===_&&E>=S;if(y.trackNo!==o&&(p.size?([...p].forEach((w,U)=>{e.appendToStr(r+U,";")}),r+=p.size):(e.appendToStr(r,";"),r++),o=y.trackNo,p=c(),l=!1,d=!1),C!==void 0)m=[...p].indexOf(C),l||([...p].forEach((w,U)=>{w&&e.beforeInsertToStr(r+U,w+" ")}),l=!0),[...p].forEach((w,U)=>{let $=T||"";U!==m&&($=$.replace(/[a-g]/,f?"*":"r")),M||($=$.replace(/[a-gr*]\+?[0-9]*\.*/i,"")),e.appendToStr(r+U,$)});else if(y.rest||y.tieSlur){let w=y.rest||y.tieSlur;M||(w=w.replace(/[r&]\+?[0-9]*\.*/i,"")),p.size?[...p].forEach((U,$)=>{e.appendToStr(r+$,w)}):e.appendToStr(r,w)}else if(y.noteValue||y.repeatStartEnd||y.repeatBreak||y.polyStartEnd){const w=U=>{if(!U)return g;const $=Number((U.match(/[0-9]+/)||[g.noteValue])[0]),G=(U.match(/\.+/)||[""])[0].length;return{noteValue:$,dots:G}};y.noteValue?g=w(y.noteValue):y.polyStartEnd==="["?f=!0:y.polyStartEnd==="]"&&(f=!1),p.size?[...p].forEach((U,$)=>{if(e.appendToStr(r+$,y.noteValue||y.repeatStartEnd||y.repeatBreak||y.polyStartEnd||""),y.polyStartEnd==="]"){const G=e.getMmlLine(r+$).match(/\[(.+?)\]/);if(G){const de=G[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(de){const se=[...de].map(he=>({type:he[1]==="r"?"rest":he[1]==="*"?"otherNote":"note",num:w(he[0])}));se.filter(A=>A.type==="note").map(A=>A.num),se.filter(A=>A.type==="otherNote").map(A=>A.num),se.filter(A=>A.type==="rest").map(A=>A.num);let ue=G[0].replace(/\*\+?[0-9]*\.*/g,"");const pe=e.getMmlLine(r+$).replace(/\[.+?\]/,ue);e.rewrite(r+$,pe)}}}}):e.appendToStr(r,y.noteValue||y.repeatStartEnd||y.repeatBreak||y.polyStartEnd||"")}else if(y.metaData)y.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,y.metaData.replace(`
`,"")||""),r++;else if(y.macroDef)d=y.macroDef!==";",e.appendToStr(r,y.macroDef||"");else{let w;M?w=T||y.tempo||y.octave||y.velocity||y.noteShift||y.detune||y.tieSlur||y.macroArgUse||y.macroUse||y.otherAction||"":w=(T==null?void 0:T.replace(/[a-g]\+?[0-9]*\.*/i,""))||y.tempo||y.octave||y.velocity||y.noteShift||y.detune||y.tieSlur||y.otherAction||"",e.appendToStr(r,w),/;/.test(w)&&(r+=p.size||1,p=c(),l=!1)}}),[...p].slice(0,-1).forEach((y,E)=>{e.appendToStr(r+E,";")})}importMml(e){const r=e.getMmlArr(),o=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig,i=new Set,n=new Set;let c=0,p="",m=!1,l=!1;const g=d=>(d.match(o)||[]).reduce((D,_)=>(_=_.trim(),_&&(E=>{const C={};if(C.tone={},C.trackNo=c,/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(E)){p=E,n.add(p);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(E)){n.has(p)||n.add(p);const T=[...n].indexOf(p)+1;C.label="無調整",C.className=`material-icons note note-${T}`,C.tone.tone=p,C.tone.tonePitch=E,m&&(l=!0)}else if(E.startsWith("t"))C.className="material-icons tempo",C.tempo=E;else if(E.startsWith("l"))C.className="material-icons note-value",C.noteValue=E;else if(E.startsWith("r"))C.className="material-icons rest",C.rest=E;else if(/^o[0-8]|[><]+$/i.test(E))C.className="material-icons octave",C.octave=E;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(E))C.className="material-icons velocity",C.velocity=E;else if(E.startsWith("@ns")||E.startsWith("ns"))C.className="material-icons note-shift",C.noteShift=E;else if(E.startsWith("@d"))C.className="material-icons detune",C.detune=E;else if(E.startsWith("&"))C.className="tie-slur",C.tieSlur=E;else if(E.startsWith("/*"))C.className="other-action",C.otherAction=E;else if(E.startsWith("/:"))C.className="repeat-start-end",C.repeatStartEnd=E;else if(E.startsWith(":/"))C.className="material-icons repeat-start-end",C.repeatStartEnd=E;else if(E.startsWith("/"))C.className="repeat-break",C.repeatBreak=E;else if(E.startsWith("[")||E.startsWith("]"))C.className="poly-start-end",C.polyStartEnd=E;else if(/^\$.*?=$/.test(E))C.className="macro-def",C.macroDef=E.replaceAll(" ",""),i.add(C.macroDef.slice(0,-1)),m=!0;else if(E.startsWith("%"))C.className="macro-arg-use",C.macroArgUse=E;else if(E.startsWith("$")){C.className="macro-use";const T=[...i].sort((M,w)=>w.length-M.length).find(M=>E.includes(M));if(T){C.macroUse=T,D.push(C);const M=E.replace(T,"");M!==""&&(D=D.concat(g(M)));return}else C.macroUse=E}else if(E.startsWith("#")){const T={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};C.label=(Object.entries(T).find(M=>E.startsWith(M[0]))||[,void 0])[1],C.className="meta-data",C.metaData=E+`
`}else if(E.startsWith(";")){if(c++,m&&!l){const T=[...n].join(" ");T&&(C.className="other-action",C.otherAction=T,D.push(C),n.clear())}m=!1,l=!1;return}else C.className="other-action",C.otherAction=E;D.push(C)})(_),D),[]);this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((d,S)=>{S?d.remove():(d.textContent="",this.activeTrack=d)}),K=null;const f=r.map(d=>g(d)).flat();Ce(this,ke,f),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}playRendering(e=-1){const r=R(this,ke),o=e!==-1,i=r[e],n=o?i.trackNo:-1;let c=120,p=0;[me,Ee,oe].forEach(D=>{D.classList.add("no-op")});const m=document.querySelector(".wrap"),l=document.getElementsByClassName("track"),f=(m.clientHeight-32)/l.length;[...l].forEach(D=>{D.style.setProperty("--max-height",`${f}px`)}),Fe.disabled=!0,ct.disabled=!0;const d=(D,{scoreNoteValue:_=4,ignorePlayFromHere:y=!1}={})=>{var ie;let E=!1,C=-1,T=-1,M=!1,w=!1;const U=[],$=[],G=[],de=performance.now(),se=(ie=D[0])==null?void 0:ie.trackNo,ue=l[se],pe=p++,he=D.findIndex(W=>W===i);let A=null;const x=new Promise(W=>A=W);let F=0,V=0;const Y=W=>{if(!W)return _;const re=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(W),ve=re&&re[1]?Number(re[1]):_,k=re?re[2].length:0;return ve*2**k/(2**(k+1)-1)},X=W=>{const re=k=>{!w&&ue.scrollTo({top:k,behavior:"smooth"}),w=!0,Ho(ue).then(()=>{w=!1})},ve=k=>ue.clientHeight*k;(V===0||W.elem.offsetTop>ue.scrollTop+ve(.8)||W.elem.offsetTop<ue.scrollTop+ve(.2))&&re(W.elem.offsetTop-ve(.2))},Z=W=>{const re=ve=>{const k=ve-de,j=60/c*4/W*1e3;k<F+j?R(this,Je)[pe]=requestAnimationFrame(re):(F+=j,J())};R(this,Je)[pe]=requestAnimationFrame(re)},J=async()=>{var ve,k;const W=D[V];if(!W||V>=D.length){A({scoreNoteValue:_});return}X(W);const re=!o||y||o&&W.trackNo===n&&V>=he;if(M){W.macroDef===";"&&(M=!1),V++,J();return}else if(C!==-1)(ve=W.repeatStartEnd)!=null&&ve.startsWith("/:")?T++:W.repeatStartEnd===":/"&&(T===C&&(re&&Me(W.elem,"pop"),C=-1),T--),V++,J();else if(W.tone.tonePitch)if(re&&Me(W.elem,"bounce"),V++,E||!re)J();else{const j=Y(W.tone.tonePitch);Z(j)}else if(W.rest||W.tieSlur)if(re&&Me(W.elem,"pop"),V++,W.tieSlur==="&"||!re)J();else{const j=Y(W.rest||W.tieSlur);Z(j)}else if(W.polyStartEnd)if(E=W.polyStartEnd==="[",re&&Me(W.elem,"pop"),E||!re)V++,J();else{const j=Y(D[V++-1].tone.tonePitch);Z(j)}else if(W.macroDef&&W.macroDef!==";"){M=!0,V++,J();return}else{if(W.tempo&&(c=Number(W.tempo.replace("t",""))||c),W.noteValue&&(_=Y(W.noteValue)),re&&Me(W.elem,"pop"),(k=W.repeatStartEnd)!=null&&k.startsWith("/:"))U[++T]=V,$[T]||(G[T]=W.repeatStartEnd.replace("/:",""),G[T]=G[T]===""?2:Number(G[T]),G[T]||(C=T));else if(W.repeatBreak){if(G[T]===1){if(!$[T]){let j=T;$[T]=D.findIndex((q,H)=>{if(H>U[T]){if(console.log(j),q.repeatStartEnd.startsWith("/:"))j++;else if(q.repeatStartEnd===":/"){if(j===T)return!0;j--}}})}V=$[T],J(),re&&Me(W.elem,"done");return}}else if(W.repeatStartEnd===":/"){if(G[T]--,G[T]){$[T]=V,V=U[T],T--,J(),re&&Me(W.elem,"done");return}$[T]=null,T--}else if(W.macroUse&&re){const j=H=>{const ne=r[H].trackNo;let ee=H+1;for(;r[ee].macroDef!==";"&&r[ee].trackNo===ne;)ee++;return ee},q={};if(q.start=r.findIndex(H=>{var ne;return(ne=H.macroDef)==null?void 0:ne.startsWith(W.macroUse)}),q.start>-1){q.end=j(q.start),q.blocks=r.slice(q.start+1,q.end);const H=performance.now();_=(await d(q.blocks,{scoreNoteValue:_,ignorePlayFromHere:!0})).scoreNoteValue;const ne=performance.now();F+=ne-H}}V++,J()}re&&Me(W.elem,"done")};return J(),x},S=r.at(-1).trackNo+1;for(let D=0;D<S;D++){const _=r.filter(y=>y.trackNo===D);d(_)}}stopRendering(){[me,Ee,oe].forEach(e=>{e.classList.remove("no-op")}),Fe.disabled=!1,ct.disabled=!1,R(this,ke).forEach(e=>{e.elem.classList.remove("done")}),R(this,Je).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!R(this,ke).length)return;const e=R(this,ke).at(-1).trackNo+1;for(let r=0;r<e;r++)R(this,ke).filter(i=>i.polyStartEnd&&i.trackNo===r).forEach((i,n)=>{n%2===0?(i.elem.dataset.polyStartEnd="[",i.elem.textContent="["):(i.elem.dataset.polyStartEnd="]",i.elem.textContent="]")});this.blocksDataUpdate()}}ke=new WeakMap,Je=new WeakMap,dt=new WeakMap,$e=new WeakMap;var ye,Ot,ft,Qe;class Qo{constructor(){Te(this,ye,[[],[]]);Te(this,Ot,70);Te(this,ft,e=>{});Te(this,Qe,e=>{})}set onPushstate(e){Ce(this,ft,e)}set onPopstate(e){Ce(this,Qe,e)}pushState(e){R(this,ye)[0].push(e),R(this,ft).call(this,e),R(this,ye)[0].length>R(this,Ot)&&R(this,ye)[0].shift(),R(this,ye)[1].length=0,console.log(R(this,ye))}undo(){const e=R(this,ye)[0].pop();return R(this,Qe).call(this,{reason:"undo",data:e}),e&&R(this,ye)[1].unshift(e),console.log(R(this,ye)),{canUndo:!!R(this,ye)[0].length,canRedo:!!R(this,ye)[1].length}}redo(){const e=R(this,ye)[1].shift();return R(this,Qe).call(this,{reason:"redo",data:e}),e&&R(this,ye)[0].push(e),console.log(R(this,ye)),{canUndo:!!R(this,ye)[0].length,canRedo:!!R(this,ye)[1].length}}clear(){R(this,ye)[0].length=0,R(this,ye)[1].length=0,console.log(R(this,ye))}}ye=new WeakMap,Ot=new WeakMap,ft=new WeakMap,Qe=new WeakMap;const _e=[1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,384];let K=me.querySelector("button"),br=!1,De=!1;const Re={timeStamp:-1,tempo:120,scoreNoteValue:"4"};let dn=null,fn=!1,bt=null;const Er=()=>{N.activeTrack.querySelectorAll("button").forEach(t=>{t.classList.remove("done")}),fn=!1},Dt=()=>{if(clearTimeout(dn),K&&K.closest(".track")!==N.activeTrack){K=N.activeTrack.querySelector("button");return}let t=K;const e=()=>{const n=performance.measure("stepElapsed","stepPoint");performance.mark("stepPoint");const c=n.duration,m=(g=>{const f=60/Re.tempo*4/g*1e3,{noteValue:d,dots:S}=_e.reduce((D,_,y)=>{const E=Math.log2(f/(2*f-_));if(E<0||Number.isNaN(E))return D;const C=E-Math.floor(E);return C<D.smallerFractional?{noteValue:_,dots:Math.round(E),smallerFractional:C}:D},{noteValue:null,dots:null,smallerFractional:1});return d+".".repeat(S)})(c);(g=>{const f=bt;if("tonePitch"in f.dataset){const d=g!==Re.scoreNoteValue?g:"";f.dataset.tonePitch=f.dataset.tonePitch+d}else if("rest"in f.dataset){const d=g!==Re.scoreNoteValue?g:"";f.dataset.rest="r"+d}})(m),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q)};if(!t){if(fn){console.log("end1");return}xe.stop(),e(),Re.timeStamp=-1,bt=null,performance.clearMarks("stepPoint"),setTimeout(()=>{K=N.activeTrack.querySelector("button"),Er()},2e3),fn=!0,console.log("end2");return}(()=>{if("tonePitch"in t.dataset){t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,""),Le(t,{noteValue:"1..."}),t.classList.add("bounce");return}"rest"in t.dataset&&(t.dataset.rest="r"),t.classList.add("done")})();const o=()=>{var n;K=t=((n=t.parentElement.nextElementSibling)==null?void 0:n.firstElementChild)||null};if("tonePitch"in t.dataset||xe.stop(),!["tonePitch","rest"].some(n=>n in t.dataset)){if("tempo"in t.dataset){const n=Number(t.dataset.tempo.replace("t",""));Re.tempo=n}else"noteValue"in t.dataset&&(Re.scoreNoteValue=(t.dataset.noteValue.match(/[0-9]+\.*/)||[Re.scoreNoteValue])[0]);o(),Dt(),console.log("end3");return}if((()=>{const n=60/Re.tempo*4*1e3*1.825;dn=setTimeout(Dt,n)})(),!performance.getEntriesByName("stepPoint")[0]){performance.mark("stepPoint"),bt=t,o(),console.log("end4");return}e(),bt=t,o()};var ze,Pt,jt,Bt;class Zo{constructor(e){Te(this,ze,()=>({"":"デフォルト",...Object.fromEntries(_e.map(e=>[e,e===1?"全音符":`${e}分音符`]))}));Te(this,Pt,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name"},{label:"音の定義",type:"text",name:"tone-def",autofocus:!0}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}]},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",select:R(this,ze).call(this),name:"tone-pitch"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}]},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0"}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}]},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",select:R(this,ze).call(this),name:"note-value"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}]},rest:{title:"休符設定",inputs:[{label:"休符の長さ",select:R(this,ze).call(this),name:"rest"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}]},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8"}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}]},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127"}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}]},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift"}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}]},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune"}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}]},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",select:R(this,ze).call(this),name:"tie-slur"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}]},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0"}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}]},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg"}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}]},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use"}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}]},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg"}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}]},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}]},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action"}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}]},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}]},step:{title:"ステップ音価記録",description:`ステップ音価記録は、簡単に音価を指定できる機能です。

各トラックの空白部分をテンポよくクリック、またはスペースキーを押して最初の音符から順に音価を決定します。
途中から指定をやり直したいときは、やり直したい音符をクリックすることでそこからやり直せます。

この画面は、Shiftキーを押しながらステップ音価記録ブロックをクリックすることで再度表示できます。`,buttons:[{className:"primaly",value:"set-step",textContent:"開始"},{value:"cancel-step",textContent:"やめる"}]}});Te(this,jt,e=>{const r=R(this,Pt)[e];Object.keys(r).forEach(o=>{switch(o){case"title":ae._title.textContent=r.title;break;case"description":(()=>{const i=document.createElement("p");i.innerHTML=r.description.replaceAll(`
`,"<br>"),ae.description.appendChild(i)})();break;case"inputs":r.inputs.forEach(i=>{const n=document.createElement("input");let c=n;Object.entries(i).forEach(([p,m])=>{if(p==="label"){const l=document.createElement("label");l.textContent=m,l.appendChild(n),c=l}else if(p==="select"){const l=document.createElement("select");l.name=i.name;const g=m;if(""in g){const f=document.createElement("option");f.value="",f.textContent=g[""],l.appendChild(f)}Object.entries(g).forEach(([f,d])=>{if(f==="")return;const S=document.createElement("option");S.value=f,S.textContent=d,l.appendChild(S)}),n.replaceWith(l)}else n[p]=m}),ae.inputs.appendChild(c)});break;case"buttons":r.buttons.forEach(i=>{const n=document.createElement("button");Object.entries(i).forEach(([c,p])=>{n[c]=p}),ae.buttons.appendChild(n)});break}})});Te(this,Bt,(e,r)=>{ae._title.textContent="",ae.description.textContent="",ae.inputs.textContent="",ae.buttons.textContent="",R(this,jt).call(this,e);for(const[o,i]of Object.entries(r))o==="run"?i():ae.elements[o].value=i;this.type=e});this.type=null,this.submitTarget=null,this.resolve=null,e.addEventListener("submit",r=>{const o=this.submitTarget,i=r.submitter.value,n=JSON.parse(JSON.stringify(o.dataset));switch(i){case"set-tone":const p=o.className;document.querySelectorAll(`[class*="${p}"]`).forEach(d=>{d.ariaLabel=e.elements["tone-name"].value,(!d.classList.contains("material-icons")||e.elements["tone-name"].value!=="無調整")&&(d.classList.remove("material-icons"),d.textContent=e.elements["tone-name"].value),d.dataset.tone=e.elements["tone-def"].value});break;case"set-tone-pitch":o.dataset.tonePitch=o.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]+e.elements["tone-pitch"].value+".".repeat(e.elements.dot.value);break;case"set-tempo":o.dataset.tempo="t"+e.elements.tempo.value;break;case"set-note-value":o.dataset.noteValue="l"+e.elements["note-value"].value+".".repeat(e.elements.dot.value);break;case"set-rest":o.dataset.rest="r"+e.elements.rest.value+".".repeat(e.elements.dot.value);break;case"set-octave":o.dataset.octave="o"+e.elements.octave.value;break;case"set-octave-relative":o.dataset.octave=e.elements.octave.value>0?"<".repeat(e.elements.octave.value):">".repeat(-e.elements.octave.value);break;case"set-velocity":o.dataset.velocity="@v"+e.elements.velocity.value;break;case"set-velocity-relative":o.dataset.velocity=(e.elements.velocity.value>=0?"(":")")+Math.abs(e.elements.velocity.value);break;case"set-note-shift":o.dataset.noteShift="ns"+e.elements["note-shift"].value;break;case"set-note-shift-relative":o.dataset.noteShift="@ns"+e.elements["note-shift"].value;break;case"set-detune":o.dataset.detune="@d"+e.elements.detune.value;break;case"set-tie-slur":o.dataset.tieSlur="&"+e.elements["tie-slur"].value+".".repeat(e.elements.dot.value),o.dataset.tieSlur==="&"?o.ariaLabel="スラー":o.ariaLabel="タイ";break;case"set-repeat":o.dataset.repeatStartEnd="/:"+e.elements.repeat.value;break;case"set-macro-def":const m=o.dataset.macroDef;o.dataset.macroDef="$"+e.elements["macro-def-name"].value+(e.elements["macro-def-arg"].value!==""?`{${e.elements["macro-def-arg"].value}}`:"")+"=",oe.querySelectorAll(`[data-macro-use="${m.replace("=","")}"]`).forEach(d=>{d.dataset.macroUse=o.dataset.macroDef.replace("=","")});break;case"set-macro-arg-use":o.dataset.macroArgUse="%"+e.elements["macro-arg-use"].value;break;case"set-macro-use":o.dataset.macroUse="$"+e.elements["macro-use-name"].value+(e.elements["macro-use-arg"].value!==""?`{${e.elements["macro-use-arg"].value}}`:"");break;case"set-meta-data":o.ariaLabel=e.elements["select-meta-data"].selectedOptions[0].label,o.dataset.metaData=e.elements["select-meta-data"].value.replace("{n}",e.elements.number.value).replace("{desc}",e.elements.text.value);break;case"set-other-action":o.dataset.otherAction=e.elements["other-action"].value,o.textContent=o.dataset.otherAction.length>4?"…":o.dataset.otherAction;break;case"remove-left":case"remove-right":const l=o.parentElement,g=N.activeTrack,f=g.children;for([...f].indexOf(l),K=null;[...f].includes(l);){const d=i==="remove-left",S=d?g.firstElementChild:g.lastElementChild;Se.pushState({operation:"remove",removedElem:S,removedIndex:d?0:f.length-1,parent:g}),S.remove()}N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q);break;case"set-step":br=!0,De=!0;break;case"cancel-step":De=!1;break}const c=JSON.parse(JSON.stringify(o.dataset));JSON.stringify(n)!==JSON.stringify(c)&&Se.pushState({operation:"valueChange",target:o,beforeChange:n,afterChange:c}),this.resolve()})}async prompt(e,r,o){return R(this,Bt).call(this,e,r),this.submitTarget=o,We.showModal(),new Promise(i=>this.resolve=i)}}ze=new WeakMap,Pt=new WeakMap,jt=new WeakMap,Bt=new WeakMap;Qn.FlMML.prepare(".editor");const xe=new Qn.FlMML({workerURL:ua}),Q=new Xo;nn.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const N=new Jo(me,oe),Se=new Qo,Lt=new Zo(ae),es={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},ts=new bn({i18n:es,locale:"ja"});Wo.polyfill({holdToDrag:500});qo();const lt=t=>`<span class="material-icons">${t}</span>`,Sr=lt("play_arrow")+"再生",ns=lt("stop")+"停止",mn=()=>{const t=[...oe.querySelectorAll(".track button")].findIndex(e=>e.classList.contains("play-from-here"));N.playRendering(t)},rs=()=>{Go.innerHTML=xe.getWarnings().replaceAll(`
`,"<br>")};xe.addEventListener("compilecomplete",rs);const as=()=>{Ct.innerHTML=Sr,N.stopRendering(),xe.removeEventListener("compilecomplete",mn),It.disabled=!1};xe.addEventListener("complete",as);Q.onChange=(t,e)=>{Ko.innerHTML=e?`<pre><code>${zo(e).replaceAll(`
`,"<br>")}</code></pre>`:"(なし)";const r=!!t.length;[Ue,Nt].forEach(o=>{o.disabled=!r})};Q.onError=(t,e)=>{alert(t+`
`+e)};N.checkSavedBlocksData();const Le=(t,e={})=>{var y;const r=()=>{let E=t.parentElement;for(;E&&!("noteValue"in E.firstElementChild.dataset);)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null},o=()=>{var C;let E=t.parentElement;for(;E&&!((C=E.firstElementChild.dataset.octave)!=null&&C.startsWith("o"));)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null},i=()=>{var T;let E=t.parentElement.nextElementSibling,C="";for(;E&&((T=E.firstElementChild.dataset.tieSlur)!=null&&T.match(/&[0-9]+\.*/));)C+=E.firstElementChild.dataset.tieSlur,E=E.nextElementSibling;return C},n=((y=r())==null?void 0:y.dataset.noteValue)||"",c=o(),p=c?[...N.activeTrack.children].indexOf(c.parentElement):0,m=(c==null?void 0:c.dataset.octave)||"",l=[...N.activeTrack.children].indexOf(t.parentElement),g=[...N.activeTrack.children].slice(p,l).filter(E=>"tonePitch"in E.firstElementChild.dataset||"octave"in E.firstElementChild.dataset&&!E.firstElementChild.dataset.octave.startsWith("o")).map(E=>((E.firstElementChild.dataset.tonePitch||E.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),f={down:">",up:"<"},d=(E,C)=>(E.match(new RegExp(C,"g"))||[]).length,S=(()=>{const E=-d(g,f.down)+d(g,f.up);return E<0?f.down.repeat(-E):E>0?f.up.repeat(E):""})(),D=i(),_=e.noteValue?t.dataset.tonePitch.replace(/[0-9]+\.*/,"")+e.noteValue:t.dataset.tonePitch;xe.play(t.dataset.tone+n+m+S+_+D)};Se.onPopstate=t=>{const e=t.data,r=o=>!!e.parent.closest("#"+o);switch(t.reason){case"undo":switch(e==null?void 0:e.operation){case"append":Q.delete(e.index);break;case"delete":Q.insert(e.index,e.mmlText);break;case"rewrite":Q.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q));break;case"move":const o=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(o,e.elem),r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q));break;case"valueChange":for(const[i,n]of Object.entries(e.beforeChange))e.target.dataset[i]=n;"tone"in e.target.dataset&&Le(e.target),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q));break;case"clear":e.tonesChildren.forEach(i=>{me.querySelector("ul").appendChild(i)}),e.musicalScoreChildren.forEach(i=>{oe.insertBefore(i,Fe)}),K=e.lastTouchedButton,N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":Q.append(e.mmlText);break;case"delete":Q.delete(e.index);break;case"rewrite":Q.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q)),"tonePitch"in K.dataset&&(Le(K),K.classList.add("bounce"));break;case"move":const o=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(o,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q));break;case"valueChange":for(const[n,c]of Object.entries(e.afterChange))e.target.dataset[n]=c;"tone"in e.target.dataset&&Le(e.target),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q);break;case"remove":const i=e.removedElem.className;e.removedElem.remove(),r("tones")&&oe.querySelectorAll(`[class*="${i}"]`).forEach(n=>{n.parentElement.remove()}),N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q);break;case"clear":me.querySelector("ul").textContent="",oe.querySelectorAll(".track").forEach((n,c)=>{c?n.remove():(n.textContent="",N.activeTrack=n)}),K=null,N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q);break}break}};const wr=()=>{const t=[...me.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!t.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",t=>{var r;const e=t.ctrlKey||Rt.checked;switch((r=t.key)==null?void 0:r.toLowerCase()){case" ":De?(t.preventDefault(),Dt()):document.activeElement.tagName.toLowerCase()!=="input"&&(t.preventDefault(),Ct.click());break;case"s":e&&(t.preventDefault(),!Nt.disabled&&Nt.click());break;case"o":e&&(t.preventDefault(),!un.disabled&&un.click());break;case"z":e&&Se.undo();break;case"y":e&&Se.redo();break}});const ot=async t=>{const{dataset:e}=t,r={tempo:o=>({tempo:o.replace("t","")}),noteValue:o=>({"note-value":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),rest:o=>({rest:(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),octave:o=>({octave:o.startsWith("o")?o.replace("o",""):(o.match(/[><]+/)||[""])[0].length}),velocity:o=>({velocity:o.startsWith("@v")?o.replace("@v",""):Number((o.match(/[0-9]+/)||[""])[0])*(o.startsWith("(")?1:-1)}),noteShift:o=>({"note-shift":(o.match(/[0-9]+/)||[""])[0]}),detune:o=>({detune:o.replace("@d","")}),tieSlur:o=>({"tie-slur":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),repeatStartEnd:o=>({repeat:o.replace("/:","")}),macroDef:o=>({"macro-def-name":(o.match(/\$([^\{\=]*)[\{\=]/)||[,""])[1],"macro-def-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),macroArgUse:o=>({"macro-arg-use":o.replace("%","")}),macroUse:o=>({"macro-use-name":(o.match(/\$([^\{]*)\{?/)||[,""])[1],"macro-use-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),metaData:o=>({run:()=>{const n=o.split(" "),c=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let p=c.findIndex(d=>n[0].startsWith(d));p===-1&&(p=0),ae.elements["select-meta-data"].selectedIndex=p;const m=d=>ae.elements[d].previousSibling,l=()=>ae.elements["select-meta-data"].selectedOptions[0],g=(d,S)=>{m("number").nodeValue=d[0],ae.elements.number.value=d[1],ae.elements.number.parentElement.style.display=d[2]?"none":"",m("text").nodeValue=S[0],ae.elements.text.value=S[1],ae.elements.text.parentElement.style.display=S[2]?"none":""},f=d=>{var _,y,E;const S=d===p,D=c[d];switch(D){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const C=S?n.slice(1).join(" ")??"":"";g(["無効","",!0],[l().label,C,!1]);break;case"#OCTAVE":case"#VELOCITY":g(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const T=D==="#WAV9",M=S?((_=n.slice(1).join(" "))==null?void 0:_.split(","))??[]:[];g(["波形番号",M[0]??0,!1],T?["初期変位,ループフラグ,データ",`${M[1]??0},${M[2]??0},${M[3]??""}`,!1]:["データ",M[1]??"",!1]),ae.elements.number.min=0,ae.elements.number.max=T?15:31;break;case"#OPM":case"#OPN":g(["音色番号",S?((y=n[0])==null?void 0:y.split("@")[1])??0:0,!1],["データ",S?((E=n.slice(1).join(" "))==null?void 0:E.slice(1,-1))??"":"",!1]),ae.elements.number.min=0,ae.elements.number.max=127;break;case"#FMGAIN":g(["音量利得",S?n[1].replace(`
`,"")??91:91,!1],["無効","",!0]),ae.elements.number.min=-127,ae.elements.number.max=127;break;case"#USING":g(["和音重ね数",S?n[2].replace(`
`,"")??2:2,!1],["無効","",!0]),ae.elements.number.min=1,ae.elements.number.max="";break}};f(p),ae.elements["select-meta-data"].addEventListener("change",d=>{f(d.target.selectedIndex)})}}),otherAction:o=>({"other-action":o}),remove:()=>({}),step:()=>({})};for(const o of Object.keys(e)){const i=r[o];if(i){let n=e[o];switch(o){case"repeatStartEnd":if(n===":/"){const m=(()=>{var g;let l=t.parentElement;for(;l&&!((g=l.firstElementChild.dataset.repeatStartEnd)!=null&&g.startsWith("/:"));)l=l.previousElementSibling;return(l==null?void 0:l.firstElementChild)||null})();if(m)t=m;else{const l=N.activeTrack,g=document.createElement("li"),d=Ee.querySelector(".repeat-start-end").cloneNode(!0);g.appendChild(d),l.insertBefore(g,t.parentElement),t=d}n=t.dataset.repeatStartEnd}break;case"macroDef":if(n===";")return;break}const c=i(n);await Lt.prompt(o,c,t);break}}};Ve.addEventListener("click",async t=>{const e=t.ctrlKey||Rt.checked,r=i=>!!t.target.closest("#"+i),o=t.target.tagName.toLowerCase()==="button";if(![me,Ee,oe].some(i=>i.classList.contains("no-op"))){if(r("tones"))if(o)K=t.target,await Lt.prompt("tone",{"tone-name":t.target.ariaLabel,"tone-def":t.target.dataset.tone,run:()=>{const i=ae.elements["tone-name"];i.insertAdjacentElement("afterend",ts);const n=document.querySelector("emoji-picker");i.addEventListener("focus",()=>{n.classList.add("expaned")},{once:!0}),n.addEventListener("emoji-click",c=>i.value=c.detail.unicode)}},t.target),xe.play(t.target.dataset.tone+t.target.dataset.tonePitch),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q);else{const i=me.querySelector("ul"),n=document.createElement("li"),p=`<button class="material-icons note ${wr()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;n.innerHTML=p;const m=n.firstElementChild;i.appendChild(n),K=m,xe.play(m.dataset.tone+m.dataset.tonePitch),Se.pushState({operation:"copy",toIndex:-1,newElem:n,parent:i})}else if(r("action")){if(o){if("otherAction"in t.target.dataset)await ot(t.target);else if("step"in t.target.dataset){br&&!t.shiftKey?De=!De:await ot(t.target),De?(t.target.classList.add("enable"),t.target.ariaLabel="ステップ音価記録(有効)",K=N.activeTrack.querySelector("button")):(t.target.classList.remove("enable"),t.target.ariaLabel="ステップ音価記録(無効)",Er(),xe.stop(),clearTimeout(dn));return}const i=N.activeTrack,n=document.createElement("li"),c=t.target.cloneNode(!0);if(["metaData","macroDef","macroArgUse","macroUse"].some(p=>p in c.dataset)&&await ot(c),"tieSlur"in c.dataset?c.ariaLabel="スラー":"repeatStartEnd"in c.dataset?(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"):"polyStartEnd"in c.dataset?(c.dataset.polyStartEnd="[",c.textContent="["):"macroDef"in c.dataset?c.textContent="$=":"playFromHere"in c.dataset&&oe.querySelectorAll(".track button").forEach(p=>{p.classList.add("inactive")}),n.appendChild(c),i.appendChild(n),K=c,N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q),Se.pushState({operation:"copy",toIndex:-1,newElem:n,parent:i}),["repeatStartEnd","polyStartEnd","macroDef"].some(p=>p in K.dataset)){const p=document.createElement("li"),m=t.target.cloneNode(!0);"repeatStartEnd"in K.dataset?(m.ariaLabel="リピート終了",m.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(m.dataset.polyStartEnd="]",m.textContent="]"):"macroDef"in K.dataset&&(m.dataset.macroDef=";",m.textContent=";"),p.appendChild(m),K.parentElement.insertAdjacentElement("afterend",p),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q),Se.pushState({operation:"copy",toIndex:-1,newElem:p,parent:i})}}}else if(r("musical-score")){if(o&&t.target!==Fe&&t.target!==ct)t.target.closest(".track")&&(N.activeTrack=t.target.closest(".track")),De||("tone"in t.target.dataset?(Le(t.target),Me(t.target,"bounce"),e&&(await Lt.prompt("tonePitch",{"tone-pitch":(t.target.dataset.tonePitch.match(/[0-9]+/)||[""])[0],dot:(t.target.dataset.tonePitch.match(/\.+/)||[""])[0].length},t.target),Le(t.target))):await ot(t.target),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q)),K=t.target;else if(t.target.closest(".track")&&(N.activeTrack=t.target.closest(".track")),De)Dt();else if(K){const i=N.activeTrack,n=document.createElement("li"),c=K.cloneNode(!0);if("repeatStartEnd"in c.dataset&&(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"+(c.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),n.appendChild(c),i.appendChild(n),K=c,N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q),Se.pushState({operation:"copy",toIndex:-1,newElem:n,parent:i}),"tonePitch"in c.dataset)c.dataset.tonePitch=c.dataset.tonePitch.replace(/[><]+/,""),Le(c),c.classList.add("bounce");else if("repeatStartEnd"in K.dataset){const p=document.createElement("li"),m=K.cloneNode(!0);m.classList.add("material-icons"),m.ariaLabel="リピート終了",m.textContent="repeat",m.dataset.repeatStartEnd=":/",p.appendChild(m),K.parentElement.insertAdjacentElement("afterend",p),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q),Se.pushState({operation:"copy",toIndex:-1,newElem:p,parent:i})}}}}});Ve.addEventListener("contextmenu",t=>{var i,n,c,p;if(De)return;const e=m=>m.closest("#tones, #musical-score"),r=m=>!!t.target.closest("#"+m),o=t.target.tagName.toLowerCase()==="button";if(!((i=e(t.target))!=null&&i.classList.contains("no-op"))&&e(t.target)){const m=o&&t.target!==Fe&&t.target!==ct?t.target:K;if(!m||e(m)!==e(t.target))return;t.preventDefault(),N.activeTrack=m.closest(".track")||N.activeTrack;const l=m.parentElement,g=m.className,f=((n=m.closest("#tones"))==null?void 0:n.querySelector("ul"))||N.activeTrack,d=[...f.children].indexOf(l);K=((c=l.previousElementSibling)==null?void 0:c.firstElementChild)||((p=l.nextElementSibling)==null?void 0:p.firstElementChild)||null,Se.pushState({operation:"remove",removedElem:l,removedIndex:d,parent:f}),r("tones")?oe.querySelectorAll(`[class*="${g}"]`).forEach(S=>{S.parentElement.remove()}):"macroDef"in m.dataset?oe.querySelectorAll(`[data-macro-use="${m.dataset.macroDef.replace("=","")}"]`).forEach(S=>{S.parentElement.remove()}):"playFromHere"in m.dataset&&oe.querySelectorAll(".inactive").forEach(S=>{S.classList.remove("inactive")}),l.remove(),N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Q)}});let wt=null,En=!1,Mt=null;Ve.addEventListener("touchstart",t=>{wt=[...t.touches].at(-1).pageY,Mt=setTimeout(()=>{En=!0},500)});const Tr=t=>{if(De)return;const e=t.ctrlKey||Rt.checked,r=c=>!!t.target.closest("#"+c),o=t.target.tagName.toLowerCase()==="button";if(t.type==="touchmove"){const c=[...t.touches].at(-1).pageY;if(En){t.cancelable&&t.preventDefault();return}else if(c-wt<-30)t.deltaY=-1,clearTimeout(Mt);else if(c-wt>30)t.deltaY=1,clearTimeout(Mt);else{t.cancelable&&t.preventDefault();return}wt=c}const i=t.deltaY<0;let n=o?t.target:(K==null?void 0:K.closest("#musical-score"))&&K;if(n){if(r("musical-score")){if(oe.classList.contains("no-op"))return;t.preventDefault();let c=JSON.parse(JSON.stringify(n.dataset));if(!e&&"tone"in n.dataset){const m=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],l={down:">",up:"<"},g=n.dataset.tonePitch,f=m.findIndex(E=>g.match(/[a-g]\+?/)[0]===E),d=(E,C)=>(E.match(new RegExp(C,"g"))||[]).length,S={down:d(g,l.down),up:d(g,l.up)},D=l.down.repeat(S.down)+l.up.repeat(S.up),_=(g.match(/[0-9]+/)||[""])[0],y=(n.dataset.tonePitch.match(/\.+/)||[""])[0];i?f===m.length-1?S.down?n.dataset.tonePitch=D.substring(1)+m.at(0)+_+y:n.dataset.tonePitch=D+l.up+m.at(0)+_+y:n.dataset.tonePitch=D+m[f+1]+_+y:f===0?S.up?n.dataset.tonePitch=D.substring(1)+m.at(-1)+_+y:n.dataset.tonePitch=D+l.down+m.at(-1)+_+y:n.dataset.tonePitch=D+m[f-1]+_+y,Le(n)}else{const m=i?1:-1,l=(g,f=-1/0,d=1/0)=>g+m<f||g+m>d?0:m;if(e&&"tonePitch"in n.dataset){const g=Number((n.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),f=(n.dataset.tonePitch.match(/\.+/)||[""])[0],d=l(g,0,384),S=_e.findIndex(_=>_===g),D=g+d!==0?_e[S+d]:"";n.dataset.tonePitch=n.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+D+f,Le(n)}else if("tempo"in n.dataset){const g=Number(n.dataset.tempo.replace("t","")),f=l(g,0);n.dataset.tempo="t"+(g+f*10)}else if("noteValue"in n.dataset){const g=Number((n.dataset.noteValue.match(/[0-9]+/)||[""])[0]),f=l(g,1,384),d=_e.findIndex(S=>S===g);n.dataset.noteValue=n.dataset.noteValue.replace(/[0-9]+/,_e[d+f])}else if("rest"in n.dataset){const g=Number((n.dataset.rest.match(/[0-9]+/)||[""])[0]),f=(n.dataset.rest.match(/\.+/)||[""])[0],d=l(g,0,384),S=_e.findIndex(_=>_===g),D=g+d!==0?_e[S+d]:"";n.dataset.rest="r"+D+f}else if("octave"in n.dataset)if(n.dataset.octave.startsWith("o")){const f=Number(n.dataset.octave.replace("o","")),d=l(f,0,8);n.dataset.octave="o"+(f+d)}else{const f=(n.dataset.octave.match(/<+/)||[""])[0].length-(n.dataset.octave.match(/>+/)||[""])[0].length,d=l(f,-8,8);n.dataset.octave=f+d>0?"<".repeat(f+d):">".repeat(-(f+d))}else if("velocity"in n.dataset)if(n.dataset.velocity.startsWith("@v")){const f=Number(n.dataset.velocity.replace("@v","")),d=l(f,0,127);n.dataset.velocity="@v"+(f+d)}else{const f=Number((n.dataset.velocity.match(/[0-9]+/)||[""])[0])*(n.dataset.velocity.startsWith("(")?1:-1),d=l(f,-127,127);n.dataset.velocity=(f+d>=0?"(":")")+Math.abs(f+d)}else if("noteShift"in n.dataset){const g=Number((n.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),f=m;n.dataset.noteShift=n.dataset.noteShift.match(/@?ns/)[0]+(g+f)}else if("detune"in n.dataset){const g=Number(n.dataset.detune.replace("@d","")),f=m;n.dataset.detune="@d"+(g+f)}else if("tieSlur"in n.dataset){const g=Number((n.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),f=(n.dataset.tieSlur.match(/\.+/)||[""])[0],d=l(g,0,384),S=_e.findIndex(_=>_===g),D=g+d!==0?_e[S+d]:"";n.dataset.tieSlur="&"+D+f,n.dataset.tieSlur==="&"?n.ariaLabel="スラー":n.ariaLabel="タイ"}else if("repeatStartEnd"in n.dataset){if(n.dataset.repeatStartEnd===":/"){const D=(()=>{var y;let _=n.parentElement;for(;_&&!((y=_.firstElementChild.dataset.repeatStartEnd)!=null&&y.startsWith("/:"));)_=_.previousElementSibling;return(_==null?void 0:_.firstElementChild)||null})();if(D)n=D;else{const _=N.activeTrack,y=document.createElement("li"),C=Ee.querySelector(".repeat-start-end").cloneNode(!0);y.appendChild(C),_.insertBefore(y,n.parentElement),n=C}c=JSON.parse(JSON.stringify(n.dataset))}const g=Number((n.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),f=l(g,-1),d=g+f!==-1?g+f:"";n.dataset.repeatStartEnd="/:"+d}}const p=JSON.parse(JSON.stringify(n.dataset));JSON.stringify(c)!==JSON.stringify(p)&&Se.pushState({operation:"valueChange",target:n,beforeChange:c,afterChange:p}),K=n,N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q)}}else return};Ve.addEventListener("wheel",Tr);Ve.addEventListener("touchmove",Tr);Ve.addEventListener("touchend",()=>{clearTimeout(Mt),En=!1});let st={};Ve.addEventListener("dragstart",t=>{st={from:t.target.nodeType===1&&t.target.closest("#tones, #action, #musical-score"),item:t.target},t.dataTransfer.effectAllowed="copyMove"});let Xn=null;[me,Ee,oe].forEach(t=>{const e=n=>{const c=n.ctrlKey||Rt.checked,{from:p=null}=st,m=n.dataTransfer;switch(p){case me:switch(t){case me:n.preventDefault(),c?m.dropEffect="copy":m.dropEffect="move";break;case Ee:break;case oe:n.preventDefault(),m.dropEffect="copy";break}break;case Ee:switch(t){case me:break;case Ee:break;case oe:n.preventDefault(),m.dropEffect="copy";break}break;case oe:switch(t){case me:break;case Ee:break;case oe:n.preventDefault(),c?m.dropEffect="copy":m.dropEffect="move";break}break}Xn=m.dropEffect};t.addEventListener("dragover",e);const r=n=>{const{from:c=null}=st,p=n.target.tagName.toLowerCase()==="button",m=()=>n.target.classList.add("droppable");switch(c){case me:switch(t){case me:n.preventDefault(),p&&m();break;case Ee:break;case oe:n.preventDefault(),p&&m();break}break;case Ee:switch(t){case me:break;case Ee:break;case oe:n.preventDefault(),p&&m();break}break;case oe:switch(t){case me:break;case Ee:break;case oe:n.preventDefault(),p&&m();break}break}};t.addEventListener("dragenter",r);const o=n=>{const{from:c=null}=st,p=n.target.tagName.toLowerCase()==="button",m=()=>n.target.classList.remove("droppable");switch(c){case me:switch(t){case me:p&&m();break;case Ee:break;case oe:p&&m();break}break;case Ee:switch(t){case me:break;case Ee:break;case oe:p&&m();break}break;case oe:switch(t){case me:break;case Ee:break;case oe:p&&m();break}break}};t.addEventListener("dragleave",o),t.addEventListener("drop",async n=>{var S,D;if(n.preventDefault(),(S=n.dataTransfer.items)!=null&&S.length)return;n.dataTransfer.dropEffect=n.dataTransfer.dropEffect!=="none"?n.dataTransfer.dropEffect:Xn;const{from:c,item:p}=st,m=((D=n.target.closest("#tones"))==null?void 0:D.querySelector("ul"))||n.target.closest(".track")||N.activeTrack,l=[...t.querySelectorAll("button")].indexOf(p),g=[...t.querySelectorAll("button")].indexOf(n.target),f=n.target.tagName.toLowerCase()==="button";let d;switch(n.dataTransfer.dropEffect){case"copy":const _=document.createElement("li"),y=p.cloneNode(!0);if(t===me){const E=[...p.classList].find(C=>C.includes("note-"));y.classList.replace(E,wr())}else c===Ee&&("tieSlur"in y.dataset?y.ariaLabel="スラー":["metaData","macroDef","macroArgUse","macroUse","otherAction"].some(E=>E in y.dataset)&&await ot(y));"repeatStartEnd"in y.dataset?(y.classList.remove("material-icons"),y.ariaLabel="リピート開始",y.textContent="◆",y.dataset.repeatStartEnd="/:"+(y.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in y.dataset?(y.dataset.polyStartEnd="[",y.textContent="["):"macroDef"in y.dataset&&(y.dataset.macroDef===";"&&(y.dataset.macroDef="$="),y.textContent="$="),_.appendChild(y),d=_;break;case"move":d=p.parentElement;break}if(f&&n.target.id!=="add-track"&&n.target.id!=="remove-track"){const _=n.dataTransfer.dropEffect==="copy"||g<l?"beforebegin":"afterend";n.target.parentElement.insertAdjacentElement(_,d)}else m.appendChild(d);switch(K=d.firstElementChild,t===oe&&(N.activeTrack=m,N.blocksDataUpdate(),n.dataTransfer.dropEffect==="move"&&N.calcPoly(),"playFromHere"in K.dataset&&(t.querySelectorAll(".inactive").forEach(_=>{_.classList.remove("inactive")}),[...t.querySelectorAll(".track button")].filter((_,y)=>_===K?!1:N.activeTrack.contains(_)?g<l?y<g:y<=g:!0).forEach(_=>{_.classList.add("inactive")})),N.saveBlocksData(),N.exportMml(Q),"tonePitch"in K.dataset&&(K.dataset.tonePitch=K.dataset.tonePitch.replace(/[><]+/,""),Le(K),K.classList.add("bounce"))),n.dataTransfer.dropEffect){case"copy":Se.pushState({operation:"copy",toIndex:g,newElem:d,parent:m});break;case"move":Se.pushState({operation:"move",fromIndex:l,toIndex:g,elem:d,parent:m});break}if(n.dataTransfer.dropEffect==="copy"&&["repeatStartEnd","polyStartEnd","macroDef"].some(_=>_ in K.dataset)){const _=document.createElement("li"),y=p.cloneNode(!0);"repeatStartEnd"in K.dataset?(y.classList.add("material-icons"),y.ariaLabel="リピート終了",y.textContent="repeat",y.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(y.dataset.polyStartEnd="]",y.textContent="]"):"macroDef"in K.dataset&&(y.dataset.macroDef=";",y.textContent=";"),_.appendChild(y),d.insertAdjacentElement("afterend",_),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q),Se.pushState({operation:"copy",toIndex:g+1,newElem:_,parent:m})}});const i=n=>{[...document.getElementsByClassName("droppable")].forEach(c=>{c.classList.remove("droppable")})};t.addEventListener("dragend",i)});Ve.addEventListener("animationend",t=>{t.target.classList.remove("bounce"),t.target.classList.remove("pop")});Fe.addEventListener("click",t=>{t.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),N.activeTrack=e,oe.insertBefore(e,Fe)});ct.addEventListener("click",t=>{t.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),N.activeTrack=r,N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q)});We.addEventListener("pointerdown",t=>{t.target===We&&We.addEventListener("pointerup",e=>{e.target===We&&We.close()},{once:!0})});We.addEventListener("close",()=>{switch(Lt.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});Ct.addEventListener("click",()=>{const t=xe.isPlaying();t?(xe.stop(),N.stopRendering(),xe.removeEventListener("compilecomplete",mn),It.disabled=!1):(xe.play(Q.getMml()),xe.addEventListener("compilecomplete",mn),It.disabled=!0),Ct.innerHTML=t?Sr:ns});It.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const t=[...oe.children];t.pop(),Se.pushState({operation:"clear",tonesChildren:[...me.querySelector("ul").children],musicalScoreChildren:t,lastTouchedButton:K}),me.querySelector("ul").textContent="";const e=me.querySelector("ul"),r=document.createElement("li"),o='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=o;const i=r.firstElementChild;e.appendChild(r),K=i,oe.querySelectorAll(".track").forEach((n,c)=>{c?n.remove():(n.textContent="",N.activeTrack=n)}),xe.play(""),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Q)}});Ue.addEventListener("click",()=>{const t=Q.getMml(),e=Ue.innerHTML;Ue.disabled=!0,navigator.clipboard.writeText(t).then(()=>{Ue.disabled=!0,Ue.innerHTML=lt("content_copy")+"コピーしました",setTimeout(()=>{Ue.innerHTML=e,Ue.disabled=!1},1500)}).catch(r=>alert(`コピーできませんでした
`+r))});Be.addEventListener("click",()=>{const t=Be.innerHTML;Be.disabled=!0,navigator.clipboard.readText().then(e=>{Be.disabled=!0,e?(Q.setMml(e.replace(/\r/g,"")),N.importMml(Q),Be.innerHTML=lt("content_paste")+"貼り付けました"):Be.innerHTML=lt("content_paste")+"内容がありません",setTimeout(()=>{Be.innerHTML=t,Be.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});Nt.addEventListener("click",()=>{var n;const t=Q.getMml(),r=((n=Q.getMmlArr().find(c=>c.startsWith("#TITLE")))==null?void 0:n.split(" ").slice(1).join(" "))??"無題",o=new Blob([t],{type:"text/plain"}),i=document.createElement("a");i.download=r+".mml",i.href=URL.createObjectURL(o),i.click(),URL.revokeObjectURL(i.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。")});un.addEventListener("click",()=>{const t=document.createElement("input"),e=new FileReader;t.type="file",t.accept=".mml,.flmml,.txt",t.click(),t.onchange=()=>{e.onload=()=>{Q.setMml(e.result),N.importMml(Q)},e.readAsText(t.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");Se.onPushstate=t=>{At.disabled=!1,_t.disabled=!0};At.addEventListener("click",()=>{const{canUndo:t,canRedo:e}=Se.undo();At.disabled=!t,_t.disabled=!e});_t.addEventListener("click",()=>{const{canUndo:t,canRedo:e}=Se.redo();At.disabled=!t,_t.disabled=!e});
