var Qn=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var D=(n,e,r)=>(Qn(n,e,"read from private field"),r?r.call(n):e.get(n)),ce=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},ke=(n,e,r,a)=>(Qn(n,e,"write to private field"),a?a.call(n,r):e.set(n,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const c of t.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function r(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(o){if(o.ep)return;o.ep=!0;const t=r(o);fetch(o.href,t)}})();const wa="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var dt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ta(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var lr={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(r,a){n.exports=a()})(self,function(){return(()=>{var r={587:(t,c,h)=>{var m;(m=(function(d,E){Object.defineProperty(E,"__esModule",{value:!0}),E.MsgTypes=E.SAMPLE_RATE=void 0,E.SAMPLE_RATE=44100,E.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(c,[h,c]))===void 0||(t.exports=m)},581:(t,c,h)=>{var m;(m=(function(d,E){Object.defineProperty(E,"__esModule",{value:!0}),E.FlMMLAudioExportError=void 0;class f extends Error{constructor(...w){super(...w),this.name="FlMMLAudioExportError"}}E.FlMMLAudioExportError=f}).apply(c,[h,c]))===void 0||(t.exports=m)},643:function(t,c,h){var m,d,E=this&&this.__awaiter||function(f,g,w,C){return new(w||(w=Promise))(function(_,l){function y(R){try{M(C.next(R))}catch(S){l(S)}}function L(R){try{M(C.throw(R))}catch(S){l(S)}}function M(R){var S;R.done?_(R.value):(S=R.value,S instanceof w?S:new w(function($){$(S)})).then(y,L)}M((C=C.apply(f,g||[])).next())})};m=[h,c,h(587),h(581),h(158)],(d=(function(f,g,w,C,_){Object.defineProperty(g,"__esModule",{value:!0}),g.FlMMLonHTML5=g.FlMMLAudioExportError=g.FlMML=void 0,Object.defineProperty(g,"FlMMLAudioExportError",{enumerable:!0,get:function(){return C.FlMMLAudioExportError}});const l="flmml-on-html5.worker.js";class y{constructor(M=l){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof M=="string"&&(M={workerURL:M});const R=M.workerURL||l,S=M.infoInterval>=0?M.infoInterval:125;this.bufferSize=M.bufferSize>=128?Math.floor(M.bufferSize-M.bufferSize%128):8192,this.bufferMultiple=M.bufferMultiple>=1?Math.floor(M.bufferMultiple):32,this.lamejsURL=M.lamejsURL,(this.worker=new Worker(M.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${R}")`],{type:"application/javascript"})):R)).addEventListener("message",$=>{this.onMessage($)}),this.setInfoInterval(S)}static initWebAudio(){const M=y.audioCtx=new AudioContext({sampleRate:w.SAMPLE_RATE}),R=M.createBufferSource();R.connect(M.destination),R.start(0),M.resume(),R.stop()}static hookInitWebAudio(M){const R=document.querySelectorAll(M);R.forEach(S=>{S.addEventListener("click",function $(){y.audioCtx||y.initWebAudio(),R.forEach(V=>{V.removeEventListener("click",$,!0)})},!0)})}static prepare(M){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{y.hookInitWebAudio(M)}):y.hookInitWebAudio(M)}onMessage(M){const R=M.data;switch(R.type){case w.MsgTypes.COMPCOMP:this.totalMSec=R.info.totalMSec,this.totalTimeStr=R.info.totalTimeStr,this.warnings=R.info.warnings,this.metaTitle=R.info.metaTitle,this.metaComment=R.info.metaComment,this.metaArtist=R.info.metaArtist,this.metaCoding=R.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case w.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(R),this.trigger("buffering",{progress:R.progress});break;case w.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case w.MsgTypes.SYNCINFO:this._isPlaying=R.info._isPlaying,this._isPaused=R.info._isPaused,this.nowMSec=R.info.nowMSec,this.nowTimeStr=R.info.nowTimeStr,this.voiceCount=R.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case w.MsgTypes.PLAYSOUND:this.playSound();break;case w.MsgTypes.STOPSOUND:this.stopSound();break;case w.MsgTypes.EXPORT:R.data?this.completeAudioExport(R.data):this.errorAudioExport(R.errorMsg)}}boot(){this.worker.postMessage({type:w.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const M=y.audioCtx,R=this.gainNode=M.createGain();R.gain.value=this.volume/127,R.connect(M.destination),E(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise($=>{const V=new FileReader;V.onload=K=>{M.audioWorklet.addModule(K.target.result).then($)},V.readAsDataURL(new Blob([_.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const S=this.workletNode=new AudioWorkletNode(M,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});S.connect(R),this.worker.postMessage({type:w.MsgTypes.PLAYSOUND,workletPort:S.port},[S.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:w.MsgTypes.STOPSOUND})}trigger(M,R){const S=this.events[M];if(!S)return;const $={};for(let V in R)$[V]=R[V];for(let V=0,K=S.length;V<K;V++)S[V]&&S[V].call(this,$)}exportAudio(M,R,S={}){return y.audioCtx||y.initWebAudio(),this.booted||this.boot(),new Promise(($,V)=>{this.audioExportResolve?V(new C.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:w.MsgTypes.EXPORT,mml:M,format:R},S)),this.audioExportResolve=$,this.audioExportReject=V)})}completeAudioExport(M){this.audioExportResolve&&(this.audioExportResolve(M),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(M){this.audioExportReject&&(this.audioExportReject(new C.FlMMLAudioExportError(M)),this.audioExportResolve=null,this.audioExportReject=null)}play(M){y.audioCtx||y.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:w.MsgTypes.PLAY,mml:M})}stop(){this.worker.postMessage({type:w.MsgTypes.STOP})}pause(){this.worker.postMessage({type:w.MsgTypes.PAUSE})}exportWav(M){return this.exportAudio(M,"wav")}exportMp3(M,R){return this.exportAudio(M,"mp3",{bitrate:R})}setMasterVolume(M){this.volume=M,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(M){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:M})}syncInfo(){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:null})}addEventListener(M,R){let S=this.events[M];S||(S=this.events[M]=[]);for(let $=S.length;$--;)if(S[$]===R)return!1;return S.push(R),!0}removeEventListener(M,R){const S=this.events[M];if(!S)return!1;for(let $=S.length;$--;)if(S[$]===R)return S.splice($,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}g.FlMML=y,g.FlMMLonHTML5=y}).apply(c,m))===void 0||(t.exports=d)},158:(t,c,h)=>{h.r(c),h.d(c,{FlMMLWorkletScript:()=>m});const m='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},a={};function o(t){var c=a[t];if(c!==void 0)return c.exports;var h=a[t]={exports:{}};return r[t].call(h.exports,h,h.exports,o),h.exports}return o.d=(t,c)=>{for(var h in c)o.o(c,h)&&!o.o(t,h)&&Object.defineProperty(t,h,{enumerable:!0,get:c[h]})},o.o=(t,c)=>Object.prototype.hasOwnProperty.call(t,c),o.r=t=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o(643)})()})})(lr);var ur=lr.exports;function wt(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var dr={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(r){n.exports=r()})(function(){return function r(a,o,t){function c(d,E){if(!o[d]){if(!a[d]){var f=typeof wt=="function"&&wt;if(!E&&f)return f(d,!0);if(h)return h(d,!0);var g=new Error("Cannot find module '"+d+"'");throw g.code="MODULE_NOT_FOUND",g}var w=o[d]={exports:{}};a[d][0].call(w.exports,function(C){var _=a[d][1][C];return c(_||C)},w,w.exports,r,a,o,t)}return o[d].exports}for(var h=typeof wt=="function"&&wt,m=0;m<t.length;m++)c(t[m]);return c}({1:[function(r,a,o){(function(t){var c=t.MutationObserver||t.WebKitMutationObserver,h;if(c){var m=0,d=new c(C),E=t.document.createTextNode("");d.observe(E,{characterData:!0}),h=function(){E.data=m=++m%2}}else if(!t.setImmediate&&typeof t.MessageChannel<"u"){var f=new t.MessageChannel;f.port1.onmessage=C,h=function(){f.port2.postMessage(0)}}else"document"in t&&"onreadystatechange"in t.document.createElement("script")?h=function(){var l=t.document.createElement("script");l.onreadystatechange=function(){C(),l.onreadystatechange=null,l.parentNode.removeChild(l),l=null},t.document.documentElement.appendChild(l)}:h=function(){setTimeout(C,0)};var g,w=[];function C(){g=!0;for(var l,y,L=w.length;L;){for(y=w,w=[],l=-1;++l<L;)y[l]();L=w.length}g=!1}a.exports=_;function _(l){w.push(l)===1&&!g&&h()}}).call(this,typeof dt<"u"?dt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,a,o){var t=r(1);function c(){}var h={},m=["REJECTED"],d=["FULFILLED"],E=["PENDING"];a.exports=f;function f(S){if(typeof S!="function")throw new TypeError("resolver must be a function");this.state=E,this.queue=[],this.outcome=void 0,S!==c&&_(this,S)}f.prototype.catch=function(S){return this.then(null,S)},f.prototype.then=function(S,$){if(typeof S!="function"&&this.state===d||typeof $!="function"&&this.state===m)return this;var V=new this.constructor(c);if(this.state!==E){var K=this.state===d?S:$;w(V,K,this.outcome)}else this.queue.push(new g(V,S,$));return V};function g(S,$,V){this.promise=S,typeof $=="function"&&(this.onFulfilled=$,this.callFulfilled=this.otherCallFulfilled),typeof V=="function"&&(this.onRejected=V,this.callRejected=this.otherCallRejected)}g.prototype.callFulfilled=function(S){h.resolve(this.promise,S)},g.prototype.otherCallFulfilled=function(S){w(this.promise,this.onFulfilled,S)},g.prototype.callRejected=function(S){h.reject(this.promise,S)},g.prototype.otherCallRejected=function(S){w(this.promise,this.onRejected,S)};function w(S,$,V){t(function(){var K;try{K=$(V)}catch(ie){return h.reject(S,ie)}K===S?h.reject(S,new TypeError("Cannot resolve promise with itself")):h.resolve(S,K)})}h.resolve=function(S,$){var V=l(C,$);if(V.status==="error")return h.reject(S,V.value);var K=V.value;if(K)_(S,K);else{S.state=d,S.outcome=$;for(var ie=-1,ae=S.queue.length;++ie<ae;)S.queue[ie].callFulfilled($)}return S},h.reject=function(S,$){S.state=m,S.outcome=$;for(var V=-1,K=S.queue.length;++V<K;)S.queue[V].callRejected($);return S};function C(S){var $=S&&S.then;if(S&&(typeof S=="object"||typeof S=="function")&&typeof $=="function")return function(){$.apply(S,arguments)}}function _(S,$){var V=!1;function K(ge){V||(V=!0,h.reject(S,ge))}function ie(ge){V||(V=!0,h.resolve(S,ge))}function ae(){$(ie,K)}var he=l(ae);he.status==="error"&&K(he.value)}function l(S,$){var V={};try{V.value=S($),V.status="success"}catch(K){V.status="error",V.value=K}return V}f.resolve=y;function y(S){return S instanceof this?S:h.resolve(new this(c),S)}f.reject=L;function L(S){var $=new this(c);return h.reject($,S)}f.all=M;function M(S){var $=this;if(Object.prototype.toString.call(S)!=="[object Array]")return this.reject(new TypeError("must be an array"));var V=S.length,K=!1;if(!V)return this.resolve([]);for(var ie=new Array(V),ae=0,he=-1,ge=new this(c);++he<V;)fe(S[he],he);return ge;function fe(I,k){$.resolve(I).then(U,function(q){K||(K=!0,h.reject(ge,q))});function U(q){ie[k]=q,++ae===V&&!K&&(K=!0,h.resolve(ge,ie))}}}f.race=R;function R(S){var $=this;if(Object.prototype.toString.call(S)!=="[object Array]")return this.reject(new TypeError("must be an array"));var V=S.length,K=!1;if(!V)return this.resolve([]);for(var ie=-1,ae=new this(c);++ie<V;)he(S[ie]);return ae;function he(ge){$.resolve(ge).then(function(fe){K||(K=!0,h.resolve(ae,fe))},function(fe){K||(K=!0,h.reject(ae,fe))})}}},{1:1}],3:[function(r,a,o){(function(t){typeof t.Promise!="function"&&(t.Promise=r(2))}).call(this,typeof dt<"u"?dt:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,a,o){var t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s};function c(s,u){if(!(s instanceof u))throw new TypeError("Cannot call a class as a function")}function h(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var m=h();function d(){try{if(!m||!m.open)return!1;var s=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),u=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!s||u)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function E(s,u){s=s||[],u=u||{};try{return new Blob(s,u)}catch(p){if(p.name!=="TypeError")throw p;for(var i=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,v=new i,b=0;b<s.length;b+=1)v.append(s[b]);return v.getBlob(u.type)}}typeof Promise>"u"&&r(3);var f=Promise;function g(s,u){u&&s.then(function(i){u(null,i)},function(i){u(i)})}function w(s,u,i){typeof u=="function"&&s.then(u),typeof i=="function"&&s.catch(i)}function C(s){return typeof s!="string"&&(console.warn(s+" used as a key, but it is not a string."),s=String(s)),s}function _(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var l="local-forage-detect-blob-support",y=void 0,L={},M=Object.prototype.toString,R="readonly",S="readwrite";function $(s){for(var u=s.length,i=new ArrayBuffer(u),v=new Uint8Array(i),b=0;b<u;b++)v[b]=s.charCodeAt(b);return i}function V(s){return new f(function(u){var i=s.transaction(l,S),v=E([""]);i.objectStore(l).put(v,"key"),i.onabort=function(b){b.preventDefault(),b.stopPropagation(),u(!1)},i.oncomplete=function(){var b=navigator.userAgent.match(/Chrome\/(\d+)/),p=navigator.userAgent.match(/Edge\//);u(p||!b||parseInt(b[1],10)>=43)}}).catch(function(){return!1})}function K(s){return typeof y=="boolean"?f.resolve(y):V(s).then(function(u){return y=u,y})}function ie(s){var u=L[s.name],i={};i.promise=new f(function(v,b){i.resolve=v,i.reject=b}),u.deferredOperations.push(i),u.dbReady?u.dbReady=u.dbReady.then(function(){return i.promise}):u.dbReady=i.promise}function ae(s){var u=L[s.name],i=u.deferredOperations.pop();if(i)return i.resolve(),i.promise}function he(s,u){var i=L[s.name],v=i.deferredOperations.pop();if(v)return v.reject(u),v.promise}function ge(s,u){return new f(function(i,v){if(L[s.name]=L[s.name]||J(),s.db)if(u)ie(s),s.db.close();else return i(s.db);var b=[s.name];u&&b.push(s.version);var p=m.open.apply(m,b);u&&(p.onupgradeneeded=function(N){var A=p.result;try{A.createObjectStore(s.storeName),N.oldVersion<=1&&A.createObjectStore(l)}catch(O){if(O.name==="ConstraintError")console.warn('The database "'+s.name+'" has been upgraded from version '+N.oldVersion+" to version "+N.newVersion+', but the storage "'+s.storeName+'" already exists.');else throw O}}),p.onerror=function(N){N.preventDefault(),v(p.error)},p.onsuccess=function(){var N=p.result;N.onversionchange=function(A){A.target.close()},i(N),ae(s)}})}function fe(s){return ge(s,!1)}function I(s){return ge(s,!0)}function k(s,u){if(!s.db)return!0;var i=!s.db.objectStoreNames.contains(s.storeName),v=s.version<s.db.version,b=s.version>s.db.version;if(v&&(s.version!==u&&console.warn('The database "'+s.name+`" can't be downgraded from version `+s.db.version+" to version "+s.version+"."),s.version=s.db.version),b||i){if(i){var p=s.db.version+1;p>s.version&&(s.version=p)}return!0}return!1}function U(s){return new f(function(u,i){var v=new FileReader;v.onerror=i,v.onloadend=function(b){var p=btoa(b.target.result||"");u({__local_forage_encoded_blob:!0,data:p,type:s.type})},v.readAsBinaryString(s)})}function q(s){var u=$(atob(s.data));return E([u],{type:s.type})}function W(s){return s&&s.__local_forage_encoded_blob}function X(s){var u=this,i=u._initReady().then(function(){var v=L[u._dbInfo.name];if(v&&v.dbReady)return v.dbReady});return w(i,s,s),i}function j(s){ie(s);for(var u=L[s.name],i=u.forages,v=0;v<i.length;v++){var b=i[v];b._dbInfo.db&&(b._dbInfo.db.close(),b._dbInfo.db=null)}return s.db=null,fe(s).then(function(p){return s.db=p,k(s)?I(s):p}).then(function(p){s.db=u.db=p;for(var N=0;N<i.length;N++)i[N]._dbInfo.db=p}).catch(function(p){throw he(s,p),p})}function Q(s,u,i,v){v===void 0&&(v=1);try{var b=s.db.transaction(s.storeName,u);i(null,b)}catch(p){if(v>0&&(!s.db||p.name==="InvalidStateError"||p.name==="NotFoundError"))return f.resolve().then(function(){if(!s.db||p.name==="NotFoundError"&&!s.db.objectStoreNames.contains(s.storeName)&&s.version<=s.db.version)return s.db&&(s.version=s.db.version+1),I(s)}).then(function(){return j(s).then(function(){Q(s,u,i,v-1)})}).catch(i);i(p)}}function J(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function le(s){var u=this,i={db:null};if(s)for(var v in s)i[v]=s[v];var b=L[i.name];b||(b=J(),L[i.name]=b),b.forages.push(u),u._initReady||(u._initReady=u.ready,u.ready=X);var p=[];function N(){return f.resolve()}for(var A=0;A<b.forages.length;A++){var O=b.forages[A];O!==u&&p.push(O._initReady().catch(N))}var P=b.forages.slice(0);return f.all(p).then(function(){return i.db=b.db,fe(i)}).then(function(F){return i.db=F,k(i,u._defaultConfig.version)?I(i):F}).then(function(F){i.db=b.db=F,u._dbInfo=i;for(var z=0;z<P.length;z++){var te=P[z];te!==u&&(te._dbInfo.db=i.db,te._dbInfo.version=i.version)}})}function Te(s,u){var i=this;s=C(s);var v=new f(function(b,p){i.ready().then(function(){Q(i._dbInfo,R,function(N,A){if(N)return p(N);try{var O=A.objectStore(i._dbInfo.storeName),P=O.get(s);P.onsuccess=function(){var F=P.result;F===void 0&&(F=null),W(F)&&(F=q(F)),b(F)},P.onerror=function(){p(P.error)}}catch(F){p(F)}})}).catch(p)});return g(v,u),v}function Ie(s,u){var i=this,v=new f(function(b,p){i.ready().then(function(){Q(i._dbInfo,R,function(N,A){if(N)return p(N);try{var O=A.objectStore(i._dbInfo.storeName),P=O.openCursor(),F=1;P.onsuccess=function(){var z=P.result;if(z){var te=z.value;W(te)&&(te=q(te));var oe=s(te,z.key,F++);oe!==void 0?b(oe):z.continue()}else b()},P.onerror=function(){p(P.error)}}catch(z){p(z)}})}).catch(p)});return g(v,u),v}function x(s,u,i){var v=this;s=C(s);var b=new f(function(p,N){var A;v.ready().then(function(){return A=v._dbInfo,M.call(u)==="[object Blob]"?K(A.db).then(function(O){return O?u:U(u)}):u}).then(function(O){Q(v._dbInfo,S,function(P,F){if(P)return N(P);try{var z=F.objectStore(v._dbInfo.storeName);O===null&&(O=void 0);var te=z.put(O,s);F.oncomplete=function(){O===void 0&&(O=null),p(O)},F.onabort=F.onerror=function(){var oe=te.error?te.error:te.transaction.error;N(oe)}}catch(oe){N(oe)}})}).catch(N)});return g(b,i),b}function B(s,u){var i=this;s=C(s);var v=new f(function(b,p){i.ready().then(function(){Q(i._dbInfo,S,function(N,A){if(N)return p(N);try{var O=A.objectStore(i._dbInfo.storeName),P=O.delete(s);A.oncomplete=function(){b()},A.onerror=function(){p(P.error)},A.onabort=function(){var F=P.error?P.error:P.transaction.error;p(F)}}catch(F){p(F)}})}).catch(p)});return g(v,u),v}function H(s){var u=this,i=new f(function(v,b){u.ready().then(function(){Q(u._dbInfo,S,function(p,N){if(p)return b(p);try{var A=N.objectStore(u._dbInfo.storeName),O=A.clear();N.oncomplete=function(){v()},N.onabort=N.onerror=function(){var P=O.error?O.error:O.transaction.error;b(P)}}catch(P){b(P)}})}).catch(b)});return g(i,s),i}function Y(s){var u=this,i=new f(function(v,b){u.ready().then(function(){Q(u._dbInfo,R,function(p,N){if(p)return b(p);try{var A=N.objectStore(u._dbInfo.storeName),O=A.count();O.onsuccess=function(){v(O.result)},O.onerror=function(){b(O.error)}}catch(P){b(P)}})}).catch(b)});return g(i,s),i}function ee(s,u){var i=this,v=new f(function(b,p){if(s<0){b(null);return}i.ready().then(function(){Q(i._dbInfo,R,function(N,A){if(N)return p(N);try{var O=A.objectStore(i._dbInfo.storeName),P=!1,F=O.openKeyCursor();F.onsuccess=function(){var z=F.result;if(!z){b(null);return}s===0||P?b(z.key):(P=!0,z.advance(s))},F.onerror=function(){p(F.error)}}catch(z){p(z)}})}).catch(p)});return g(v,u),v}function ne(s){var u=this,i=new f(function(v,b){u.ready().then(function(){Q(u._dbInfo,R,function(p,N){if(p)return b(p);try{var A=N.objectStore(u._dbInfo.storeName),O=A.openKeyCursor(),P=[];O.onsuccess=function(){var F=O.result;if(!F){v(P);return}P.push(F.key),F.continue()},O.onerror=function(){b(O.error)}}catch(F){b(F)}})}).catch(b)});return g(i,s),i}function we(s,u){u=_.apply(this,arguments);var i=this.config();s=typeof s!="function"&&s||{},s.name||(s.name=s.name||i.name,s.storeName=s.storeName||i.storeName);var v=this,b;if(!s.name)b=f.reject("Invalid arguments");else{var p=s.name===i.name&&v._dbInfo.db,N=p?f.resolve(v._dbInfo.db):fe(s).then(function(A){var O=L[s.name],P=O.forages;O.db=A;for(var F=0;F<P.length;F++)P[F]._dbInfo.db=A;return A});s.storeName?b=N.then(function(A){if(A.objectStoreNames.contains(s.storeName)){var O=A.version+1;ie(s);var P=L[s.name],F=P.forages;A.close();for(var z=0;z<F.length;z++){var te=F[z];te._dbInfo.db=null,te._dbInfo.version=O}var oe=new f(function(se,ye){var pe=m.open(s.name,O);pe.onerror=function(Ne){var lt=pe.result;lt.close(),ye(Ne)},pe.onupgradeneeded=function(){var Ne=pe.result;Ne.deleteObjectStore(s.storeName)},pe.onsuccess=function(){var Ne=pe.result;Ne.close(),se(Ne)}});return oe.then(function(se){P.db=se;for(var ye=0;ye<F.length;ye++){var pe=F[ye];pe._dbInfo.db=se,ae(pe._dbInfo)}}).catch(function(se){throw(he(s,se)||f.resolve()).catch(function(){}),se})}}):b=N.then(function(A){ie(s);var O=L[s.name],P=O.forages;A.close();for(var F=0;F<P.length;F++){var z=P[F];z._dbInfo.db=null}var te=new f(function(oe,se){var ye=m.deleteDatabase(s.name);ye.onerror=function(){var pe=ye.result;pe&&pe.close(),se(ye.error)},ye.onblocked=function(){console.warn('dropInstance blocked for database "'+s.name+'" until all open connections are closed')},ye.onsuccess=function(){var pe=ye.result;pe&&pe.close(),oe(pe)}});return te.then(function(oe){O.db=oe;for(var se=0;se<P.length;se++){var ye=P[se];ae(ye._dbInfo)}}).catch(function(oe){throw(he(s,oe)||f.resolve()).catch(function(){}),oe})})}return g(b,u),b}var Qe={_driver:"asyncStorage",_initStorage:le,_support:d(),iterate:Ie,getItem:Te,setItem:x,removeItem:B,clear:H,length:Y,key:ee,keys:ne,dropInstance:we};function jr(){return typeof openDatabase=="function"}var $e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Br="~~local_forage_type~",_n=/^~~local_forage_type~([^~]+)~/,Et="__lfsc__:",Jt=Et.length,Xt="arbf",Qt="blob",On="si08",Pn="ui08",jn="uic8",Bn="si16",Rn="si32",Fn="ur16",$n="ui32",Un="fl32",Vn="fl64",Wn=Jt+Xt.length,zn=Object.prototype.toString;function Hn(s){var u=s.length*.75,i=s.length,v,b=0,p,N,A,O;s[s.length-1]==="="&&(u--,s[s.length-2]==="="&&u--);var P=new ArrayBuffer(u),F=new Uint8Array(P);for(v=0;v<i;v+=4)p=$e.indexOf(s[v]),N=$e.indexOf(s[v+1]),A=$e.indexOf(s[v+2]),O=$e.indexOf(s[v+3]),F[b++]=p<<2|N>>4,F[b++]=(N&15)<<4|A>>2,F[b++]=(A&3)<<6|O&63;return P}function Zt(s){var u=new Uint8Array(s),i="",v;for(v=0;v<u.length;v+=3)i+=$e[u[v]>>2],i+=$e[(u[v]&3)<<4|u[v+1]>>4],i+=$e[(u[v+1]&15)<<2|u[v+2]>>6],i+=$e[u[v+2]&63];return u.length%3===2?i=i.substring(0,i.length-1)+"=":u.length%3===1&&(i=i.substring(0,i.length-2)+"=="),i}function Rr(s,u){var i="";if(s&&(i=zn.call(s)),s&&(i==="[object ArrayBuffer]"||s.buffer&&zn.call(s.buffer)==="[object ArrayBuffer]")){var v,b=Et;s instanceof ArrayBuffer?(v=s,b+=Xt):(v=s.buffer,i==="[object Int8Array]"?b+=On:i==="[object Uint8Array]"?b+=Pn:i==="[object Uint8ClampedArray]"?b+=jn:i==="[object Int16Array]"?b+=Bn:i==="[object Uint16Array]"?b+=Fn:i==="[object Int32Array]"?b+=Rn:i==="[object Uint32Array]"?b+=$n:i==="[object Float32Array]"?b+=Un:i==="[object Float64Array]"?b+=Vn:u(new Error("Failed to get type for BinaryArray"))),u(b+Zt(v))}else if(i==="[object Blob]"){var p=new FileReader;p.onload=function(){var N=Br+s.type+"~"+Zt(this.result);u(Et+Qt+N)},p.readAsArrayBuffer(s)}else try{u(JSON.stringify(s))}catch(N){console.error("Couldn't convert value into a JSON string: ",s),u(null,N)}}function Fr(s){if(s.substring(0,Jt)!==Et)return JSON.parse(s);var u=s.substring(Wn),i=s.substring(Jt,Wn),v;if(i===Qt&&_n.test(u)){var b=u.match(_n);v=b[1],u=u.substring(b[0].length)}var p=Hn(u);switch(i){case Xt:return p;case Qt:return E([p],{type:v});case On:return new Int8Array(p);case Pn:return new Uint8Array(p);case jn:return new Uint8ClampedArray(p);case Bn:return new Int16Array(p);case Fn:return new Uint16Array(p);case Rn:return new Int32Array(p);case $n:return new Uint32Array(p);case Un:return new Float32Array(p);case Vn:return new Float64Array(p);default:throw new Error("Unkown type: "+i)}}var en={serialize:Rr,deserialize:Fr,stringToBuffer:Hn,bufferToString:Zt};function qn(s,u,i,v){s.executeSql("CREATE TABLE IF NOT EXISTS "+u.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],i,v)}function $r(s){var u=this,i={db:null};if(s)for(var v in s)i[v]=typeof s[v]!="string"?s[v].toString():s[v];var b=new f(function(p,N){try{i.db=openDatabase(i.name,String(i.version),i.description,i.size)}catch(A){return N(A)}i.db.transaction(function(A){qn(A,i,function(){u._dbInfo=i,p()},function(O,P){N(P)})},N)});return i.serializer=en,b}function Ue(s,u,i,v,b,p){s.executeSql(i,v,b,function(N,A){A.code===A.SYNTAX_ERR?N.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[u.storeName],function(O,P){P.rows.length?p(O,A):qn(O,u,function(){O.executeSql(i,v,b,p)},p)},p):p(N,A)},p)}function Ur(s,u){var i=this;s=C(s);var v=new f(function(b,p){i.ready().then(function(){var N=i._dbInfo;N.db.transaction(function(A){Ue(A,N,"SELECT * FROM "+N.storeName+" WHERE key = ? LIMIT 1",[s],function(O,P){var F=P.rows.length?P.rows.item(0).value:null;F&&(F=N.serializer.deserialize(F)),b(F)},function(O,P){p(P)})})}).catch(p)});return g(v,u),v}function Vr(s,u){var i=this,v=new f(function(b,p){i.ready().then(function(){var N=i._dbInfo;N.db.transaction(function(A){Ue(A,N,"SELECT * FROM "+N.storeName,[],function(O,P){for(var F=P.rows,z=F.length,te=0;te<z;te++){var oe=F.item(te),se=oe.value;if(se&&(se=N.serializer.deserialize(se)),se=s(se,oe.key,te+1),se!==void 0){b(se);return}}b()},function(O,P){p(P)})})}).catch(p)});return g(v,u),v}function Yn(s,u,i,v){var b=this;s=C(s);var p=new f(function(N,A){b.ready().then(function(){u===void 0&&(u=null);var O=u,P=b._dbInfo;P.serializer.serialize(u,function(F,z){z?A(z):P.db.transaction(function(te){Ue(te,P,"INSERT OR REPLACE INTO "+P.storeName+" (key, value) VALUES (?, ?)",[s,F],function(){N(O)},function(oe,se){A(se)})},function(te){if(te.code===te.QUOTA_ERR){if(v>0){N(Yn.apply(b,[s,O,i,v-1]));return}A(te)}})})}).catch(A)});return g(p,i),p}function Wr(s,u,i){return Yn.apply(this,[s,u,i,1])}function zr(s,u){var i=this;s=C(s);var v=new f(function(b,p){i.ready().then(function(){var N=i._dbInfo;N.db.transaction(function(A){Ue(A,N,"DELETE FROM "+N.storeName+" WHERE key = ?",[s],function(){b()},function(O,P){p(P)})})}).catch(p)});return g(v,u),v}function Hr(s){var u=this,i=new f(function(v,b){u.ready().then(function(){var p=u._dbInfo;p.db.transaction(function(N){Ue(N,p,"DELETE FROM "+p.storeName,[],function(){v()},function(A,O){b(O)})})}).catch(b)});return g(i,s),i}function qr(s){var u=this,i=new f(function(v,b){u.ready().then(function(){var p=u._dbInfo;p.db.transaction(function(N){Ue(N,p,"SELECT COUNT(key) as c FROM "+p.storeName,[],function(A,O){var P=O.rows.item(0).c;v(P)},function(A,O){b(O)})})}).catch(b)});return g(i,s),i}function Yr(s,u){var i=this,v=new f(function(b,p){i.ready().then(function(){var N=i._dbInfo;N.db.transaction(function(A){Ue(A,N,"SELECT key FROM "+N.storeName+" WHERE id = ? LIMIT 1",[s+1],function(O,P){var F=P.rows.length?P.rows.item(0).key:null;b(F)},function(O,P){p(P)})})}).catch(p)});return g(v,u),v}function Gr(s){var u=this,i=new f(function(v,b){u.ready().then(function(){var p=u._dbInfo;p.db.transaction(function(N){Ue(N,p,"SELECT key FROM "+p.storeName,[],function(A,O){for(var P=[],F=0;F<O.rows.length;F++)P.push(O.rows.item(F).key);v(P)},function(A,O){b(O)})})}).catch(b)});return g(i,s),i}function Kr(s){return new f(function(u,i){s.transaction(function(v){v.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(b,p){for(var N=[],A=0;A<p.rows.length;A++)N.push(p.rows.item(A).name);u({db:s,storeNames:N})},function(b,p){i(p)})},function(v){i(v)})})}function Jr(s,u){u=_.apply(this,arguments);var i=this.config();s=typeof s!="function"&&s||{},s.name||(s.name=s.name||i.name,s.storeName=s.storeName||i.storeName);var v=this,b;return s.name?b=new f(function(p){var N;s.name===i.name?N=v._dbInfo.db:N=openDatabase(s.name,"","",0),s.storeName?p({db:N,storeNames:[s.storeName]}):p(Kr(N))}).then(function(p){return new f(function(N,A){p.db.transaction(function(O){function P(oe){return new f(function(se,ye){O.executeSql("DROP TABLE IF EXISTS "+oe,[],function(){se()},function(pe,Ne){ye(Ne)})})}for(var F=[],z=0,te=p.storeNames.length;z<te;z++)F.push(P(p.storeNames[z]));f.all(F).then(function(){N()}).catch(function(oe){A(oe)})},function(O){A(O)})})}):b=f.reject("Invalid arguments"),g(b,u),b}var Xr={_driver:"webSQLStorage",_initStorage:$r,_support:jr(),iterate:Vr,getItem:Ur,setItem:Wr,removeItem:zr,clear:Hr,length:qr,key:Yr,keys:Gr,dropInstance:Jr};function Qr(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function Gn(s,u){var i=s.name+"/";return s.storeName!==u.storeName&&(i+=s.storeName+"/"),i}function Zr(){var s="_localforage_support_test";try{return localStorage.setItem(s,!0),localStorage.removeItem(s),!1}catch{return!0}}function ea(){return!Zr()||localStorage.length>0}function ta(s){var u=this,i={};if(s)for(var v in s)i[v]=s[v];return i.keyPrefix=Gn(s,u._defaultConfig),ea()?(u._dbInfo=i,i.serializer=en,f.resolve()):f.reject()}function na(s){var u=this,i=u.ready().then(function(){for(var v=u._dbInfo.keyPrefix,b=localStorage.length-1;b>=0;b--){var p=localStorage.key(b);p.indexOf(v)===0&&localStorage.removeItem(p)}});return g(i,s),i}function ra(s,u){var i=this;s=C(s);var v=i.ready().then(function(){var b=i._dbInfo,p=localStorage.getItem(b.keyPrefix+s);return p&&(p=b.serializer.deserialize(p)),p});return g(v,u),v}function aa(s,u){var i=this,v=i.ready().then(function(){for(var b=i._dbInfo,p=b.keyPrefix,N=p.length,A=localStorage.length,O=1,P=0;P<A;P++){var F=localStorage.key(P);if(F.indexOf(p)===0){var z=localStorage.getItem(F);if(z&&(z=b.serializer.deserialize(z)),z=s(z,F.substring(N),O++),z!==void 0)return z}}});return g(v,u),v}function oa(s,u){var i=this,v=i.ready().then(function(){var b=i._dbInfo,p;try{p=localStorage.key(s)}catch{p=null}return p&&(p=p.substring(b.keyPrefix.length)),p});return g(v,u),v}function sa(s){var u=this,i=u.ready().then(function(){for(var v=u._dbInfo,b=localStorage.length,p=[],N=0;N<b;N++){var A=localStorage.key(N);A.indexOf(v.keyPrefix)===0&&p.push(A.substring(v.keyPrefix.length))}return p});return g(i,s),i}function ia(s){var u=this,i=u.keys().then(function(v){return v.length});return g(i,s),i}function ca(s,u){var i=this;s=C(s);var v=i.ready().then(function(){var b=i._dbInfo;localStorage.removeItem(b.keyPrefix+s)});return g(v,u),v}function la(s,u,i){var v=this;s=C(s);var b=v.ready().then(function(){u===void 0&&(u=null);var p=u;return new f(function(N,A){var O=v._dbInfo;O.serializer.serialize(u,function(P,F){if(F)A(F);else try{localStorage.setItem(O.keyPrefix+s,P),N(p)}catch(z){(z.name==="QuotaExceededError"||z.name==="NS_ERROR_DOM_QUOTA_REACHED")&&A(z),A(z)}})})});return g(b,i),b}function ua(s,u){if(u=_.apply(this,arguments),s=typeof s!="function"&&s||{},!s.name){var i=this.config();s.name=s.name||i.name,s.storeName=s.storeName||i.storeName}var v=this,b;return s.name?b=new f(function(p){s.storeName?p(Gn(s,v._defaultConfig)):p(s.name+"/")}).then(function(p){for(var N=localStorage.length-1;N>=0;N--){var A=localStorage.key(N);A.indexOf(p)===0&&localStorage.removeItem(A)}}):b=f.reject("Invalid arguments"),g(b,u),b}var da={_driver:"localStorageWrapper",_initStorage:ta,_support:Qr(),iterate:aa,getItem:ra,setItem:la,removeItem:ca,clear:na,length:ia,key:oa,keys:sa,dropInstance:ua},fa=function(u,i){return u===i||typeof u=="number"&&typeof i=="number"&&isNaN(u)&&isNaN(i)},ma=function(u,i){for(var v=u.length,b=0;b<v;){if(fa(u[b],i))return!0;b++}return!1},Kn=Array.isArray||function(s){return Object.prototype.toString.call(s)==="[object Array]"},ct={},Jn={},Ze={INDEXEDDB:Qe,WEBSQL:Xr,LOCALSTORAGE:da},ha=[Ze.INDEXEDDB._driver,Ze.WEBSQL._driver,Ze.LOCALSTORAGE._driver],St=["dropInstance"],tn=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(St),pa={description:"",driver:ha.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function va(s,u){s[u]=function(){var i=arguments;return s.ready().then(function(){return s[u].apply(s,i)})}}function nn(){for(var s=1;s<arguments.length;s++){var u=arguments[s];if(u)for(var i in u)u.hasOwnProperty(i)&&(Kn(u[i])?arguments[0][i]=u[i].slice():arguments[0][i]=u[i])}return arguments[0]}var ga=function(){function s(u){c(this,s);for(var i in Ze)if(Ze.hasOwnProperty(i)){var v=Ze[i],b=v._driver;this[i]=b,ct[b]||this.defineDriver(v)}this._defaultConfig=nn({},pa),this._config=nn({},this._defaultConfig,u),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return s.prototype.config=function(i){if((typeof i>"u"?"undefined":t(i))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var v in i){if(v==="storeName"&&(i[v]=i[v].replace(/\W/g,"_")),v==="version"&&typeof i[v]!="number")return new Error("Database version must be a number.");this._config[v]=i[v]}return"driver"in i&&i.driver?this.setDriver(this._config.driver):!0}else return typeof i=="string"?this._config[i]:this._config},s.prototype.defineDriver=function(i,v,b){var p=new f(function(N,A){try{var O=i._driver,P=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!i._driver){A(P);return}for(var F=tn.concat("_initStorage"),z=0,te=F.length;z<te;z++){var oe=F[z],se=!ma(St,oe);if((se||i[oe])&&typeof i[oe]!="function"){A(P);return}}var ye=function(){for(var lt=function(Ea){return function(){var Sa=new Error("Method "+Ea+" is not implemented by the current driver"),Xn=f.reject(Sa);return g(Xn,arguments[arguments.length-1]),Xn}},rn=0,ba=St.length;rn<ba;rn++){var an=St[rn];i[an]||(i[an]=lt(an))}};ye();var pe=function(lt){ct[O]&&console.info("Redefining LocalForage driver: "+O),ct[O]=i,Jn[O]=lt,N()};"_support"in i?i._support&&typeof i._support=="function"?i._support().then(pe,A):pe(!!i._support):pe(!0)}catch(Ne){A(Ne)}});return w(p,v,b),p},s.prototype.driver=function(){return this._driver||null},s.prototype.getDriver=function(i,v,b){var p=ct[i]?f.resolve(ct[i]):f.reject(new Error("Driver not found."));return w(p,v,b),p},s.prototype.getSerializer=function(i){var v=f.resolve(en);return w(v,i),v},s.prototype.ready=function(i){var v=this,b=v._driverSet.then(function(){return v._ready===null&&(v._ready=v._initDriver()),v._ready});return w(b,i,i),b},s.prototype.setDriver=function(i,v,b){var p=this;Kn(i)||(i=[i]);var N=this._getSupportedDrivers(i);function A(){p._config.driver=p.driver()}function O(z){return p._extend(z),A(),p._ready=p._initStorage(p._config),p._ready}function P(z){return function(){var te=0;function oe(){for(;te<z.length;){var se=z[te];return te++,p._dbInfo=null,p._ready=null,p.getDriver(se).then(O).catch(oe)}A();var ye=new Error("No available storage method found.");return p._driverSet=f.reject(ye),p._driverSet}return oe()}}var F=this._driverSet!==null?this._driverSet.catch(function(){return f.resolve()}):f.resolve();return this._driverSet=F.then(function(){var z=N[0];return p._dbInfo=null,p._ready=null,p.getDriver(z).then(function(te){p._driver=te._driver,A(),p._wrapLibraryMethodsWithReady(),p._initDriver=P(N)})}).catch(function(){A();var z=new Error("No available storage method found.");return p._driverSet=f.reject(z),p._driverSet}),w(this._driverSet,v,b),this._driverSet},s.prototype.supports=function(i){return!!Jn[i]},s.prototype._extend=function(i){nn(this,i)},s.prototype._getSupportedDrivers=function(i){for(var v=[],b=0,p=i.length;b<p;b++){var N=i[b];this.supports(N)&&v.push(N)}return v},s.prototype._wrapLibraryMethodsWithReady=function(){for(var i=0,v=tn.length;i<v;i++)va(this,tn[i])},s.prototype.createInstance=function(i){return new s(i)},s}(),ya=new ga;a.exports=ya},{3:3}]},{},[4])(4)})})(dr);var xa=dr.exports;const hn=Ta(xa);function Tt(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function on(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const ka=1,Ia=1,Xe="emoji",ot="keyvalue",In="favorites",Na="tokens",fr="tokens",Ca="unicode",mr="count",Da="group",Ma="order",hr="group-order",pn="eTag",Mt="url",Zn="skinTone",it="readonly",Nn="readwrite",pr="skinUnicodes",Aa="skinUnicodes",La="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",_a="en";function Oa(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function er(n){return Oa(n,e=>e.unicode)}function Pa(n){function e(r,a,o){const t=a?n.createObjectStore(r,{keyPath:a}):n.createObjectStore(r);if(o)for(const[c,[h,m]]of Object.entries(o))t.createIndex(c,h,{multiEntry:m});return t}e(ot),e(Xe,Ca,{[fr]:[Na,!0],[hr]:[[Da,Ma]],[pr]:[Aa,!0]}),e(In,void 0,{[mr]:[""]})}const vn={},Nt={},At={};function vr(n,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>n(r.result)}async function ja(n){const e=await new Promise((r,a)=>{const o=indexedDB.open(n,ka);vn[n]=o,o.onupgradeneeded=t=>{t.oldVersion<Ia&&Pa(o.result)},vr(r,a,o)});return e.onclose=()=>Cn(n),e}function Ba(n){return Nt[n]||(Nt[n]=ja(n)),Nt[n]}function Fe(n,e,r,a){return new Promise((o,t)=>{const c=n.transaction(e,r,{durability:"relaxed"}),h=typeof e=="string"?c.objectStore(e):e.map(d=>c.objectStore(d));let m;a(h,c,d=>{m=d}),c.oncomplete=()=>o(m),c.onerror=()=>t(c.error)})}function Cn(n){const e=vn[n],r=e&&e.result;if(r){r.close();const a=At[n];if(a)for(const o of a)o()}delete vn[n],delete Nt[n],delete At[n]}function Ra(n){return new Promise((e,r)=>{Cn(n);const a=indexedDB.deleteDatabase(n);vr(e,r,a)})}function Fa(n,e){let r=At[n];r||(r=At[n]=[]),r.push(e)}const $a=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function et(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||$a.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const Ua=2;function gr(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Ua)}function Va(n){return n.map(({annotation:r,emoticon:a,group:o,order:t,shortcodes:c,skins:h,tags:m,emoji:d,version:E})=>{const f=[...new Set(gr([...(c||[]).map(et).flat(),...m.map(et).flat(),...et(r),a]))].sort(),g={annotation:r,group:o,order:t,tags:m,tokens:f,unicode:d,version:E};if(a&&(g.emoticon=a),c&&(g.shortcodes=c),h){g.skinTones=[],g.skinUnicodes=[],g.skinVersions=[];for(const{tone:w,emoji:C,version:_}of h)g.skinTones.push(w),g.skinUnicodes.push(C),g.skinVersions.push(_)}return g})}function yr(n,e,r,a){n[e](r).onsuccess=o=>a&&a(o.target.result)}function Je(n,e,r){yr(n,"get",e,r)}function br(n,e,r){yr(n,"getAll",e,r)}function Dn(n){n.commit&&n.commit()}function Wa(n,e){let r=n[0];for(let a=1;a<n.length;a++){const o=n[a];e(r)>e(o)&&(r=o)}return r}function Er(n,e){const r=Wa(n,o=>o.length),a=[];for(const o of r)n.some(t=>t.findIndex(c=>e(c)===e(o))===-1)||a.push(o);return a}async function za(n){return!await Mn(n,ot,Mt)}async function Ha(n,e,r){const[a,o]=await Promise.all([pn,Mt].map(t=>Mn(n,ot,t)));return a===r&&o===e}async function qa(n,e){return Fe(n,Xe,it,(a,o,t)=>{let c;const h=()=>{a.getAll(c&&IDBKeyRange.lowerBound(c,!0),50).onsuccess=m=>{const d=m.target.result;for(const E of d)if(c=E.unicode,e(E))return t(E);if(d.length<50)return t();h()}};h()})}async function Sr(n,e,r,a){try{const o=Va(e);await Fe(n,[Xe,ot],Nn,([t,c],h)=>{let m,d,E=0;function f(){++E===2&&g()}function g(){if(!(m===a&&d===r)){t.clear();for(const w of o)t.put(w);c.put(a,pn),c.put(r,Mt),Dn(h)}}Je(c,pn,w=>{m=w,f()}),Je(c,Mt,w=>{d=w,f()})})}finally{}}async function Ya(n,e){return Fe(n,Xe,it,(r,a,o)=>{const t=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);br(r.index(hr),t,o)})}async function wr(n,e){const r=gr(et(e));return r.length?Fe(n,Xe,it,(a,o,t)=>{const c=[],h=()=>{c.length===r.length&&m()},m=()=>{const d=Er(c,E=>E.unicode);t(d.sort((E,f)=>E.order<f.order?-1:1))};for(let d=0;d<r.length;d++){const E=r[d],f=d===r.length-1?IDBKeyRange.bound(E,E+"￿",!1,!0):IDBKeyRange.only(E);br(a.index(fr),f,g=>{c.push(g),h()})}}):[]}async function Ga(n,e){const r=await wr(n,e);return r.length?r.filter(a=>(a.shortcodes||[]).map(t=>t.toLowerCase()).includes(e.toLowerCase()))[0]||null:await qa(n,o=>(o.shortcodes||[]).includes(e.toLowerCase()))||null}async function Ka(n,e){return Fe(n,Xe,it,(r,a,o)=>Je(r,e,t=>{if(t)return o(t);Je(r.index(pr),e,c=>o(c||null))}))}function Mn(n,e,r){return Fe(n,e,it,(a,o,t)=>Je(a,r,t))}function Ja(n,e,r,a){return Fe(n,e,Nn,(o,t)=>{o.put(a,r),Dn(t)})}function Xa(n,e){return Fe(n,In,Nn,(r,a)=>Je(r,e,o=>{r.put((o||0)+1,e),Dn(a)}))}function Qa(n,e,r){return r===0?[]:Fe(n,[In,Xe],it,([a,o],t,c)=>{const h=[];a.index(mr).openCursor(void 0,"prev").onsuccess=m=>{const d=m.target.result;if(!d)return c(h);function E(w){if(h.push(w),h.length===r)return c(h);d.continue()}const f=d.primaryKey,g=e.byName(f);if(g)return E(g);Je(o,f,w=>{if(w)return E(w);d.continue()})}})}const xt="";function Za(n,e){const r=new Map;for(const o of n){const t=e(o);for(const c of t){let h=r;for(let d=0;d<c.length;d++){const E=c.charAt(d);let f=h.get(E);f||(f=new Map,h.set(E,f)),h=f}let m=h.get(xt);m||(m=[],h.set(xt,m)),m.push(o)}}return(o,t)=>{let c=r;for(let d=0;d<o.length;d++){const E=o.charAt(d),f=c.get(E);if(f)c=f;else return[]}if(t)return c.get(xt)||[];const h=[],m=[c];for(;m.length;){const E=[...m.shift().entries()].sort((f,g)=>f[0]<g[0]?-1:1);for(const[f,g]of E)f===xt?h.push(...g):m.push(g)}return h}}const eo=["name","url"];function to(n){const e=n&&Array.isArray(n),r=e&&n.length&&(!n[0]||eo.some(a=>!(a in n[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function tr(n){to(n);const e=(g,w)=>g.name.toLowerCase()<w.name.toLowerCase()?-1:1,r=n.sort(e),o=Za(n,g=>[...new Set((g.shortcodes||[]).map(w=>et(w)).flat())]),t=g=>o(g,!0),c=g=>o(g,!1),h=g=>{const w=et(g),C=w.map((_,l)=>(l<w.length-1?t:c)(_));return Er(C,_=>_.name).sort(e)},m=new Map,d=new Map;for(const g of n){d.set(g.name.toLowerCase(),g);for(const w of g.shortcodes||[])m.set(w.toLowerCase(),g)}return{all:r,search:h,byShortcode:g=>m.get(g.toLowerCase()),byName:g=>d.get(g.toLowerCase())}}const no=typeof wrappedJSObject<"u";function ut(n){if(!n)return n;if(no&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let r=0;r<e;r++)n.skins[r]={tone:n.skinTones[r],unicode:n.skinUnicodes[r],version:n.skinVersions[r]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function Tr(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const ro=["annotation","emoji","group","order","tags","version"];function ao(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||ro.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function xr(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function oo(n){const e=await fetch(n,{method:"HEAD"});xr(e,n);const r=e.headers.get("etag");return Tr(r),r}async function gn(n){const e=await fetch(n);xr(e,n);const r=e.headers.get("etag");Tr(r);const a=await e.json();return ao(a),[r,a]}function so(n){for(var e="",r=new Uint8Array(n),a=r.byteLength,o=-1;++o<a;)e+=String.fromCharCode(r[o]);return e}function io(n){for(var e=n.length,r=new ArrayBuffer(e),a=new Uint8Array(r),o=-1;++o<e;)a[o]=n.charCodeAt(o);return r}async function kr(n){const e=JSON.stringify(n);let r=io(e);const a=await crypto.subtle.digest("SHA-1",r),o=so(a);return btoa(o)}async function co(n,e){let r,a=await oo(e);if(!a){const o=await gn(e);a=o[0],r=o[1],a||(a=await kr(r))}await Ha(n,e,a)||(r||(r=(await gn(e))[1]),await Sr(n,r,e,a))}async function lo(n,e){let[r,a]=await gn(e);r||(r=await kr(a)),await Sr(n,a,e,r)}class uo{constructor({dataSource:e=La,locale:r=_a,customEmoji:a=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=tr(a),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await Ba(this._dbName);Fa(this._dbName,this._clear);const r=this.dataSource;await za(e)?await lo(e,r):this._lazyUpdate=co(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return on(e),await this.ready(),er(await Ya(this._db,e)).map(ut)}async getEmojiBySearchQuery(e){Tt(e),await this.ready();const r=this._custom.search(e),a=er(await wr(this._db,e)).map(ut);return[...r,...a]}async getEmojiByShortcode(e){Tt(e),await this.ready();const r=this._custom.byShortcode(e);return r||ut(await Ga(this._db,e))}async getEmojiByUnicodeOrName(e){Tt(e),await this.ready();const r=this._custom.byName(e);return r||ut(await Ka(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await Mn(this._db,ot,Zn)||0}async setPreferredSkinTone(e){return on(e),await this.ready(),Ja(this._db,ot,Zn,e)}async incrementFavoriteEmojiCount(e){return Tt(e),await this.ready(),Xa(this._db,e)}async getTopFavoriteEmoji(e){return on(e),await this.ready(),(await Qa(this._db,this._custom,e)).map(ut)}set customEmoji(e){this._custom=tr(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await Cn(this._dbName)}async delete(){await this._shutdown(),await Ra(this._dbName)}}const yn=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([n,e,r])=>({id:n,emoji:e,name:r})),sn=yn.slice(1),fo=2,nr=6,Ir=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function rr(n){return n.unicode.includes("‍")}const mo={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},ho=1e3,po="🖐️",vo=8,go=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],Nr='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',yo=(n,e)=>n<e?-1:n>e?1:0,ar=(n,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const a=r.getContext("2d");return a.textBaseline="top",a.font=`100px ${Nr}`,a.fillStyle=e,a.scale(.01,.01),a.fillText(n,0,0),a.getImageData(0,0,1,1).data},bo=(n,e)=>{const r=[...n].join(","),a=[...e].join(",");return r===a&&!r.startsWith("0,0,0,")};function Eo(n){const e=ar(n,"#000"),r=ar(n,"#fff");return e&&r&&bo(e,r)}function So(){const n=Object.entries(mo);try{for(const[e,r]of n)if(Eo(e))return r}catch{}finally{}return n[0][1]}let cn;const ln=()=>(cn||(cn=new Promise(n=>Ir(()=>n(So())))),cn),bn=new Map,wo="️",To="\uD83C",xo="‍",ko=127995,Io=57339;function No(n,e){if(e===0)return n;const r=n.indexOf(xo);return r!==-1?n.substring(0,r)+String.fromCodePoint(ko+e-1)+n.substring(r):(n.endsWith(wo)&&(n=n.substring(0,n.length-1)),n+To+String.fromCodePoint(Io+e-1))}function Le(n){n.preventDefault(),n.stopPropagation()}function un(n,e,r){return e+=n?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function Cr(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function Co(n,e){const r=a=>{const o={};for(const t of a)typeof t.tone=="number"&&t.version<=e&&(o[t.tone]=t.unicode);return o};return n.map(({unicode:a,skins:o,shortcodes:t,url:c,name:h,category:m,annotation:d})=>({unicode:a,name:h,shortcodes:t,url:c,category:m,annotation:d,id:a||h,skins:o&&r(o)}))}const Ct=requestAnimationFrame;let Do=typeof ResizeObserver=="function";function Mo(n,e,r){let a;Do?(a=new ResizeObserver(o=>r(o[0].contentRect.width)),a.observe(n)):Ct(()=>r(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{a&&a.disconnect()})}function or(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let dn;function Ao(n,e,r){for(const a of n){const o=r(a),t=or(o);typeof dn>"u"&&(dn=or(e));const c=t/1.8<dn;bn.set(a.unicode,c)}}function Lo(n){return Cr(n,e=>e)}function _o(n){n&&(n.scrollTop=0)}function mt(n,e,r){let a=n.get(e);return a||(a=r(),n.set(e,a)),a}function sr(n){return""+n}function Oo(n){const e=document.createElement("template");return e.innerHTML=n,e}const Po=new WeakMap,jo=new WeakMap,Bo=Symbol("un-keyed"),Ro="replaceChildren"in Element.prototype;function Fo(n,e){Ro?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function $o(n,e){let r=n.firstChild,a=0;for(;r;){if(e[a]!==r)return!0;r=r.nextSibling,a++}return a!==e.length}function Uo(n,e){const{targetNode:r}=e;let{targetParentNode:a}=e,o=!1;a?o=$o(a,n):(o=!0,e.targetNode=void 0,e.targetParentNode=a=r.parentNode),o&&Fo(a,n)}function Vo(n,e){for(const r of e){const{targetNode:a,currentExpression:o,binding:{expressionIndex:t,attributeName:c,attributeValuePre:h,attributeValuePost:m}}=r,d=n[t];if(o!==d)if(r.currentExpression=d,c)a.setAttribute(c,h+sr(d)+m);else{let E;Array.isArray(d)?Uo(d,r):d instanceof Element?(E=d,a.replaceWith(E)):a.nodeValue=sr(d),E&&(r.targetNode=E)}}}function Wo(n){let e="",r=!1,a=!1,o=-1;const t=new Map,c=[];for(let m=0,d=n.length;m<d;m++){const E=n[m];if(e+=E,m===d-1)break;for(let y=0;y<E.length;y++)switch(E.charAt(y)){case"<":{E.charAt(y+1)==="/"?c.pop():(r=!0,c.push(++o));break}case">":{r=!1,a=!1;break}case"=":{a=!0;break}}const f=c[c.length-1],g=mt(t,f,()=>[]);let w,C,_;if(a){const y=/(\S+)="?([^"=]*)$/.exec(E);w=y[1],C=y[2],_=/^[^">]*/.exec(n[m+1])[0]}const l={attributeName:w,attributeValuePre:C,attributeValuePost:_,expressionIndex:m};g.push(l),!r&&!a&&(e+=" ")}return{template:Oo(e),elementsToBindings:t}}function zo(n,e){const r=[],a=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let o=n,t=-1;do{const c=e.get(++t);if(c)for(let h=0;h<c.length;h++){const m=c[h],d=m.attributeName?o:o.firstChild,E={binding:m,targetNode:d,targetParentNode:void 0,currentExpression:void 0};r.push(E)}}while(o=a.nextNode());return r}function Ho(n){const{template:e,elementsToBindings:r}=mt(Po,n,()=>Wo(n)),a=e.cloneNode(!0).content.firstElementChild,o=zo(a,r);return function(c){return Vo(c,o),a}}function qo(n){const e=mt(jo,n,()=>new Map);let r=Bo;function a(t,...c){const h=mt(e,t,()=>new Map);return mt(h,r,()=>Ho(t))(c)}function o(t,c,h){return t.map((m,d)=>{const E=r;r=h(m);try{return c(m,d)}finally{r=E}})}return{map:o,html:a}}function Yo(n,e,r,a,o,t,c,h){const{labelWithSkin:m,titleForEmoji:d,unicodeWithSkin:E}=r,{html:f,map:g}=qo(e);function w(l,y,L){return g(l,(M,R)=>f`<button role="${y?"option":"menuitem"}" aria-selected="${e.searchMode?R===e.activeSearchItem:""}" aria-label="${m(M,e.currentSkinTone)}" title="${d(M)}" class="emoji ${y&&R===e.activeSearchItem?"active":""}" id="${`${L}-${M.id}`}">${M.unicode?E(M,e.currentSkinTone):f`<img class="custom-emoji" src="${M.url}" alt="" loading="lazy">`}</button>`,M=>`${L}-${M.id}`)}const _=f`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${g(e.skinTones,(l,y)=>f`<div id="skintone-${y}" class="emoji ${y===e.activeSkinTone?"active":""}" aria-selected="${y===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[y]}" aria-label="${e.i18n.skinTones[y]}">${l}</div>`,l=>l)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${g(e.groups,l=>f`<button role="tab" class="nav-button" aria-controls="tab-${l.id}" aria-label="${e.i18n.categories[l.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===l.id}" title="${e.i18n.categories[l.name]}" data-group-id="${l.id}"><div class="nav-emoji emoji">${l.emoji}</div></button>`,l=>l.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${g(e.currentEmojisWithCategories,(l,y)=>f`<div><div id="menu-label-${y}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:l.category?l.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${y}" id="${e.searchMode?"search-results":""}">${w(l.emojis,e.searchMode,"emo")}</div></div>`,l=>l.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${w(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(h){n.appendChild(_);const l=(y,L)=>{for(const M of n.querySelectorAll(`[${y}]`))L(M,M.getAttribute(y))};for(const y of["click","focusout","input","keydown","keyup"])l(`data-on-${y}`,(L,M)=>{L.addEventListener(y,a[M])});l("data-ref",(y,L)=>{t[L]=y}),l("data-action",(y,L)=>{o[L](y)}),c.addEventListener("abort",()=>{n.removeChild(_)})}}const Lt=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function Go(n){let e=!1,r;const a=new Map,o=new Set;let t;const c=()=>{if(e)return;const d=[...o];o.clear();try{for(const E of d)E()}finally{t=!1,o.size&&(t=!0,Lt(c))}},h=new Proxy({},{get(d,E){if(r){let f=a.get(E);f||(f=new Set,a.set(E,f)),f.add(r)}return d[E]},set(d,E,f){d[E]=f;const g=a.get(E);if(g){for(const w of g)o.add(w);t||(t=!0,Lt(c))}return!0}}),m=d=>{const E=()=>{const f=r;r=E;try{return d()}finally{r=f}};return E()};return n.addEventListener("abort",()=>{e=!0}),{state:h,createEffect:m}}function fn(n,e,r){if(n.length!==e.length)return!1;for(let a=0;a<n.length;a++)if(!r(n[a],e[a]))return!1;return!0}const mn=[],{assign:kt}=Object;function Ko(n,e){const r={},a=new AbortController,o=a.signal,{state:t,createEffect:c}=Go(o);kt(t,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),kt(t,e),kt(t,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:vo,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:sn,databaseLoaded:!1,activeSearchItemId:void 0}),c(()=>{t.currentGroup!==t.groups[t.currentGroupIndex]&&(t.currentGroup=t.groups[t.currentGroupIndex])});const h=x=>{n.getElementById(x).focus()},m=x=>n.getElementById(`emo-${x.id}`),d=(x,B)=>{r.rootElement.dispatchEvent(new CustomEvent(x,{detail:B,bubbles:!0,composed:!0}))},E=(x,B)=>x.id===B.id,f=(x,B)=>{const{category:H,emojis:Y}=x,{category:ee,emojis:ne}=B;return H!==ee?!1:fn(Y,ne,E)},g=x=>{fn(t.currentEmojis,x,E)||(t.currentEmojis=x)},w=x=>{t.searchMode!==x&&(t.searchMode=x)},C=x=>{fn(t.currentEmojisWithCategories,x,f)||(t.currentEmojisWithCategories=x)},_=(x,B)=>B&&x.skins&&x.skins[B]||x.unicode,L={labelWithSkin:(x,B)=>Lo([x.name||_(x,B),x.annotation,...x.shortcodes||mn].filter(Boolean)).join(", "),titleForEmoji:x=>x.annotation||(x.shortcodes||mn).join(", "),unicodeWithSkin:_},M={onClickSkinToneButton:Q,onEmojiClick:W,onNavClick:k,onNavKeydown:U,onSearchKeydown:I,onSkinToneOptionsClick:j,onSkinToneOptionsFocusOut:Te,onSkinToneOptionsKeydown:J,onSkinToneOptionsKeyup:le,onSearchInput:Ie},R={calculateEmojiGridStyle:V};let S=!0;c(()=>{Yo(n,t,L,M,R,r,o,S),S=!1}),t.emojiVersion||ln().then(x=>{x||(t.message=t.i18n.emojiUnsupportedMessage)}),c(()=>{async function x(){let B=!1;const H=setTimeout(()=>{B=!0,t.message=t.i18n.loadingMessage},ho);try{await t.database.ready(),t.databaseLoaded=!0}catch(Y){console.error(Y),t.message=t.i18n.networkErrorMessage}finally{clearTimeout(H),B&&(B=!1,t.message="")}}t.database&&x()}),c(()=>{t.pickerStyle=`
      --num-groups: ${t.groups.length}; 
      --indicator-opacity: ${t.searchMode?0:1}; 
      --num-skintones: ${nr};`}),c(()=>{t.customEmoji&&t.database&&$()}),c(()=>{t.customEmoji&&t.customEmoji.length?t.groups!==yn&&(t.groups=yn):t.groups!==sn&&(t.currentGroupIndex&&t.currentGroupIndex--,t.groups=sn)}),c(()=>{async function x(){t.databaseLoaded&&(t.currentSkinTone=await t.database.getPreferredSkinTone())}x()}),c(()=>{t.skinTones=Array(nr).fill().map((x,B)=>No(t.skinToneEmoji,B))}),c(()=>{t.skinToneButtonText=t.skinTones[t.currentSkinTone]}),c(()=>{t.skinToneButtonLabel=t.i18n.skinToneLabel.replace("{skinTone}",t.i18n.skinTones[t.currentSkinTone])}),c(()=>{async function x(){const{database:B}=t,H=(await Promise.all(go.map(Y=>B.getEmojiByUnicodeOrName(Y)))).filter(Boolean);t.defaultFavoriteEmojis=H}t.databaseLoaded&&x()});function $(){t.database.customEmoji=t.customEmoji||mn}c(()=>{async function x(){$();const{database:B,defaultFavoriteEmojis:H,numColumns:Y}=t,ee=await B.getTopFavoriteEmoji(Y),ne=await he(Cr([...ee,...H],we=>we.unicode||we.name).slice(0,Y));t.currentFavorites=ne}t.databaseLoaded&&t.defaultFavoriteEmojis&&x()});function V(x){Mo(x,o,B=>{{const H=getComputedStyle(r.rootElement),Y=parseInt(H.getPropertyValue("--num-columns"),10),ee=H.getPropertyValue("direction")==="rtl",we=x.parentElement.getBoundingClientRect().width-B;t.numColumns=Y,t.scrollbarWidth=we,t.isRtl=ee}})}c(()=>{async function x(){const{searchText:B,currentGroup:H,databaseLoaded:Y,customEmoji:ee}=t;if(!Y)t.currentEmojis=[],t.searchMode=!1;else if(B.length>=fo){const ne=await fe(B);t.searchText===B&&(g(ne),w(!0))}else{const{id:ne}=H;if(ne!==-1||ee&&ee.length){const we=await ge(ne);t.currentGroup.id===ne&&(g(we),w(!1))}}}x()}),c(()=>{const{currentEmojis:x,emojiVersion:B}=t,H=x.filter(Y=>Y.unicode).filter(Y=>rr(Y)&&!bn.has(Y.unicode));if(!B&&H.length)g(x),Ct(()=>K(H));else{const Y=B?x:x.filter(ie);g(Y),Ct(()=>_o(r.tabpanelElement))}});function K(x){Ao(x,r.baselineEmoji,m),t.currentEmojis=t.currentEmojis}function ie(x){return!x.unicode||!rr(x)||bn.get(x.unicode)}async function ae(x){const B=t.emojiVersion||await ln();return x.filter(({version:H})=>!H||H<=B)}async function he(x){return Co(x,t.emojiVersion||await ln())}async function ge(x){const B=x===-1?t.customEmoji:await t.database.getEmojiByGroup(x);return he(await ae(B))}async function fe(x){return he(await ae(await t.database.getEmojiBySearchQuery(x)))}c(()=>{}),c(()=>{function x(){const{searchMode:H,currentEmojis:Y}=t;if(H)return[{category:"",emojis:Y}];const ee=new Map;for(const ne of Y){const we=ne.category||"";let Qe=ee.get(we);Qe||(Qe=[],ee.set(we,Qe)),Qe.push(ne)}return[...ee.entries()].map(([ne,we])=>({category:ne,emojis:we})).sort((ne,we)=>t.customCategorySorting(ne.category,we.category))}const B=x();C(B)}),c(()=>{t.activeSearchItemId=t.activeSearchItem!==-1&&t.currentEmojis[t.activeSearchItem].id}),c(()=>{const{rawSearchText:x}=t;Ir(()=>{t.searchText=(x||"").trim(),t.activeSearchItem=-1})});function I(x){if(!t.searchMode||!t.currentEmojis.length)return;const B=H=>{Le(x),t.activeSearchItem=un(H,t.activeSearchItem,t.currentEmojis)};switch(x.key){case"ArrowDown":return B(!1);case"ArrowUp":return B(!0);case"Enter":if(t.activeSearchItem===-1)t.activeSearchItem=0;else return Le(x),q(t.currentEmojis[t.activeSearchItem].id)}}function k(x){const{target:B}=x,H=B.closest(".nav-button");if(!H)return;const Y=parseInt(H.dataset.groupId,10);r.searchElement.value="",t.rawSearchText="",t.searchText="",t.activeSearchItem=-1,t.currentGroupIndex=t.groups.findIndex(ee=>ee.id===Y)}function U(x){const{target:B,key:H}=x,Y=ee=>{ee&&(Le(x),ee.focus())};switch(H){case"ArrowLeft":return Y(B.previousElementSibling);case"ArrowRight":return Y(B.nextElementSibling);case"Home":return Y(B.parentElement.firstElementChild);case"End":return Y(B.parentElement.lastElementChild)}}async function q(x){const B=await t.database.getEmojiByUnicodeOrName(x),H=[...t.currentEmojis,...t.currentFavorites].find(ee=>ee.id===x),Y=H.unicode&&_(H,t.currentSkinTone);await t.database.incrementFavoriteEmojiCount(x),d("emoji-click",{emoji:B,skinTone:t.currentSkinTone,...Y&&{unicode:Y},...H.name&&{name:H.name}})}async function W(x){const{target:B}=x;if(!B.classList.contains("emoji"))return;Le(x);const H=B.id.substring(4);q(H)}function X(x){t.currentSkinTone=x,t.skinTonePickerExpanded=!1,h("skintone-button"),d("skin-tone-change",{skinTone:x}),t.database.setPreferredSkinTone(x)}function j(x){const{target:{id:B}}=x,H=B&&B.match(/^skintone-(\d)/);if(!H)return;Le(x);const Y=parseInt(H[1],10);X(Y)}function Q(x){t.skinTonePickerExpanded=!t.skinTonePickerExpanded,t.activeSkinTone=t.currentSkinTone,t.skinTonePickerExpanded&&(Le(x),Ct(()=>h("skintone-list")))}c(()=>{t.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{t.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):t.skinTonePickerExpandedAfterAnimation=!1});function J(x){if(!t.skinTonePickerExpanded)return;const B=async H=>{Le(x),t.activeSkinTone=H};switch(x.key){case"ArrowUp":return B(un(!0,t.activeSkinTone,t.skinTones));case"ArrowDown":return B(un(!1,t.activeSkinTone,t.skinTones));case"Home":return B(0);case"End":return B(t.skinTones.length-1);case"Enter":return Le(x),X(t.activeSkinTone);case"Escape":return Le(x),t.skinTonePickerExpanded=!1,h("skintone-button")}}function le(x){if(t.skinTonePickerExpanded)switch(x.key){case" ":return Le(x),X(t.activeSkinTone)}}async function Te(x){const{relatedTarget:B}=x;(!B||B.id!=="skintone-list")&&(t.skinTonePickerExpanded=!1)}function Ie(x){t.rawSearchText=x.target.value}return{$set(x){kt(t,x)},$destroy(){a.abort()}}}const Jo="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Xo="en";var Qo={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Zo=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const Dr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],es=`:host{--emoji-font-family:${Nr}}`;class An extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=Zo+es,this.shadowRoot.appendChild(r),this._ctx={locale:Xo,dataSource:Jo,skinToneEmoji:po,customCategorySorting:yo,customEmoji:null,i18n:Qo,emojiVersion:null,...e};for(const a of Dr)a!=="database"&&Object.prototype.hasOwnProperty.call(this,a)&&(this._ctx[a]=this[a],delete this[a]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Ko(this.shadowRoot,this._ctx))}disconnectedCallback(){Lt(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,a){this._set(e.replace(/-([a-z])/g,(o,t)=>t.toUpperCase()),e==="emoji-version"?parseFloat(a):a)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:a}=this._ctx;(!a||a.locale!==e||a.dataSource!==r)&&this._set("database",new uo({locale:e,dataSource:r}))}_dbFlush(){Lt(()=>this._dbCreate())}}const Mr={};for(const n of Dr)Mr[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(An.prototype,Mr);customElements.get("emoji-picker")||customElements.define("emoji-picker",An);var En={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(r,a){a(e)})(dt,function(r){var a="dnd-poly-",o=a+"snapback",t="dnd-poly-",c=t+"dragstart-pending",h=t+"dragstart-cancel",m=["none","copy","copyLink","copyMove","link","linkMove","move","all"],d=["none","copy","move","link"],E=function(){var I=!1;try{var k=Object.defineProperty({},"passive",{get:function(){I=!0}});window.addEventListener("test",null,k)}catch{}return I}();function f(I){return I&&I.tagName}function g(I,k,U){U===void 0&&(U=!0),document.addEventListener(I,k,!!E&&{passive:U})}function w(I,k){document.removeEventListener(I,k)}function C(I,k,U,q){q===void 0&&(q=!1);var W=E?{passive:!0,capture:q}:q;return I.addEventListener(k,U,W),{off:function(){I.removeEventListener(k,U,W)}}}function _(I){return I.length===0?0:I.reduce(function(k,U){return U+k},0)/I.length}function l(I,k){for(var U=0;U<I.changedTouches.length;U++)if(I.changedTouches[U].identifier===k)return!0;return!1}function y(I,k,U){for(var q=[],W=[],X=0;X<k.touches.length;X++){var j=k.touches[X];q.push(j[I+"X"]),W.push(j[I+"Y"])}U.x=_(q),U.y=_(W)}var L=["","-webkit-"];function M(I,k,U,q,W){W===void 0&&(W=!0);var X=k.x,j=k.y;q&&(X+=q.x,j+=q.y),W&&(X-=parseInt(I.offsetWidth,10)/2,j-=parseInt(I.offsetHeight,10)/2);for(var Q="translate3d("+X+"px,"+j+"px, 0)",J=0;J<L.length;J++){var le=L[J]+"transform";I.style[le]=Q+" "+U[J]}}var R=function(){function I(k,U){this.t=k,this.i=U,this.s=d[0]}return Object.defineProperty(I.prototype,"dropEffect",{get:function(){return this.s},set:function(k){this.t.mode!==0&&m.indexOf(k)>-1&&(this.s=k)},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(k){this.t.mode===2&&m.indexOf(k)>-1&&(this.t.effectAllowed=k)},enumerable:!0,configurable:!0}),I.prototype.setData=function(k,U){if(this.t.mode===2){if(k.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[k]=U,this.t.types.indexOf(k)===-1&&this.t.types.push(k)}},I.prototype.getData=function(k){if(this.t.mode===1||this.t.mode===2)return this.t.data[k]||""},I.prototype.clearData=function(k){if(this.t.mode===2){if(k&&this.t.data[k]){delete this.t.data[k];var U=this.t.types.indexOf(k);return void(U>-1&&this.t.types.splice(U,1))}this.t.data={},this.t.types=[]}},I.prototype.setDragImage=function(k,U,q){this.t.mode===2&&this.i(k,U,q)},I}();function S(I,k){return I?I===m[0]?d[0]:I.indexOf(m[1])===0||I===m[7]?d[1]:I.indexOf(m[4])===0?d[3]:I===m[6]?d[2]:d[1]:k.nodeType===3&&k.tagName==="A"?d[3]:d[1]}function $(I,k,U,q,W,X,j){X===void 0&&(X=!0),j===void 0&&(j=null);var Q=function(le,Te,Ie,x,B,H,Y){Y===void 0&&(Y=null);var ee=Te.changedTouches[0],ne=new Event(Ie,{bubbles:!0,cancelable:x});ne.dataTransfer=H,ne.relatedTarget=Y,ne.screenX=ee.screenX,ne.screenY=ee.screenY,ne.clientX=ee.clientX,ne.clientY=ee.clientY,ne.pageX=ee.pageX,ne.pageY=ee.pageY;var we=le.getBoundingClientRect();return ne.offsetX=ne.clientX-we.left,ne.offsetY=ne.clientY-we.top,ne}(k,U,I,X,document.defaultView,W,j),J=!k.dispatchEvent(Q);return q.mode=0,J}function V(I,k){if(!I||I===m[7])return k;if(k===d[1]){if(I.indexOf(d[1])===0)return d[1]}else if(k===d[3]){if(I.indexOf(d[3])===0||I.indexOf("Link")>-1)return d[3]}else if(k===d[2]&&(I.indexOf(d[2])===0||I.indexOf("Move")>-1))return d[2];return d[0]}var K,ie=function(){function I(k,U,q,W){this.h=k,this.o=U,this.u=q,this.l=W,this.v=0,this.p=null,this.g=null,this.m=k,this.I=k.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),g("touchmove",this.j,!1),g("touchend",this.S,!1),g("touchcancel",this.S,!1)}return I.prototype.A=function(){var k=this;this.v=1,this.O=d[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var U=this.u;if(this.N=new R(this.D,function(Q,J,le){U=Q,typeof J!="number"&&typeof le!="number"||(k.P={x:J||0,y:le||0})}),this.D.mode=2,this.N.dropEffect=d[0],$("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;y("page",this.m,this.F);var q,W=this.o.dragImageSetup(U);if(this.L=(q=W,L.map(function(Q){var J=q.style[Q+"transform"];return J&&J!=="none"?J.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),W.style.position="absolute",W.style.left="0px",W.style.top="0px",W.style.zIndex="999999",W.classList.add("dnd-poly-drag-image"),W.classList.add("dnd-poly-icon"),this._=W,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var X=getComputedStyle(U);this.P={x:0-parseInt(X.marginLeft,10),y:0-parseInt(X.marginTop,10)}}else{var j=U.getBoundingClientRect();X=getComputedStyle(U),this.P={x:j.left-this.I.clientX-parseInt(X.marginLeft,10)+j.width/2,y:j.top-this.I.clientY-parseInt(X.marginTop,10)+j.height/2}}return M(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){k.X||(k.X=!0,k.Y(),k.X=!1)},this.o.iterationInterval),!0},I.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),w("touchmove",this.j),w("touchend",this.S),w("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},I.prototype.C=function(k){var U=this;if(l(k,this.I.identifier)!==!1){if(this.m=k,this.v===0){var q=void 0;if(this.o.dragStartConditionOverride)try{q=this.o.dragStartConditionOverride(k)}catch{q=!1}else q=k.touches.length===1;return q?void(this.A()===!0&&(this.h.preventDefault(),k.preventDefault())):void this.T()}if(k.preventDefault(),y("client",k,this.M),y("page",k,this.F),this.o.dragImageTranslateOverride)try{var W=!1;if(this.o.dragImageTranslateOverride(k,{x:this.M.x,y:this.M.y},this.p,function(X,j){U._&&(W=!0,U.M.x+=X,U.M.y+=j,U.F.x+=X,U.F.y+=j,M(U._,U.F,U.L,U.P,U.o.dragImageCenterOnTouch))}),W)return}catch{}M(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},I.prototype.k=function(k){if(l(k,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(k.preventDefault(),this.v=k.type==="touchcancel"?3:2):this.T()}},I.prototype.Y=function(){var k=this,U=this.O;this.D.mode=3,this.N.dropEffect=d[0];var q=$("drag",this.u,this.m,this.D,this.N);if(q&&(this.O=d[0]),q||this.v===2||this.v===3)return this.q(this.v)?void function(Q,J,le,Te){var Ie=getComputedStyle(Q);if(Ie.visibility!=="hidden"&&Ie.display!=="none"){J.classList.add(o);var x=getComputedStyle(J),B=parseFloat(x.transitionDuration);if(isNaN(B)||B===0)Te();else{var H=Q.getBoundingClientRect(),Y={x:H.left,y:H.top};Y.x+=document.body.scrollLeft||document.documentElement.scrollLeft,Y.y+=document.body.scrollTop||document.documentElement.scrollTop,Y.x-=parseInt(Ie.marginLeft,10),Y.y-=parseInt(Ie.marginTop,10);var ee=parseFloat(x.transitionDelay),ne=Math.round(1e3*(B+ee));M(J,Y,le,void 0,!1),setTimeout(Te,ne)}}else Te()}(this.u,this._,this.L,function(){k.B()}):void this.B();var W=this.o.elementFromPoint(this.M.x,this.M.y),X=this.g;W!==this.p&&W!==this.g&&(this.p=W,this.g!==null&&(this.D.mode=3,this.N.dropEffect=d[0],$("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=S(this.D.effectAllowed,this.u),$("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=V(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),X!==this.g&&f(X)&&(this.D.mode=3,this.N.dropEffect=d[0],$("dragleave",X,this.m,this.D,this.N,!1,this.g)),f(this.g)&&(this.D.mode=3,this.N.dropEffect=S(this.D.effectAllowed,this.u),$("dragover",this.g,this.m,this.D,this.N)===!1?this.O=d[0]:this.O=V(this.N.effectAllowed,this.N.dropEffect)),U!==this.O&&this._.classList.remove(a+U);var j=a+this.O;this._.classList.add(j)},I.prototype.q=function(k){var U=this.O===d[0]||this.g===null||k===3;return U?f(this.g)&&(this.D.mode=3,this.N.dropEffect=d[0],$("dragleave",this.g,this.m,this.D,this.N,!1)):f(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,$("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=d[0]),U},I.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,$("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},I}(),ae={iterationInterval:150,tryFindDraggableTarget:function(I){var k=I.target;do if(k.draggable!==!1&&(k.draggable===!0||k.getAttribute&&k.getAttribute("draggable")==="true"))return k;while((k=k.parentNode)&&k!==document.body)},dragImageSetup:function(I){var k=I.cloneNode(!0);return function U(q,W){if(q.nodeType===1){for(var X=getComputedStyle(q),j=0;j<X.length;j++){var Q=X[j];W.style.setProperty(Q,X.getPropertyValue(Q),X.getPropertyPriority(Q))}if(W.style.pointerEvents="none",W.removeAttribute("id"),W.removeAttribute("class"),W.removeAttribute("draggable"),W.nodeName==="CANVAS"){var J=q,le=W,Te=J.getContext("2d").getImageData(0,0,J.width,J.height);le.getContext("2d").putImageData(Te,0,0)}}if(q.hasChildNodes())for(j=0;j<q.childNodes.length;j++)U(q.childNodes[j],W.childNodes[j])}(I,k),k},elementFromPoint:function(I,k){return document.elementFromPoint(I,k)}};function he(I){if(!K){var k=ae.tryFindDraggableTarget(I);if(k)try{K=new ie(I,ae,k,fe)}catch(U){throw fe(ae,I,3),U}}}function ge(I){var k=I.target,U=function(J){W.off(),X.off(),j.off(),Q.off(),k&&k.dispatchEvent(new CustomEvent(h,{bubbles:!0,cancelable:!0})),clearTimeout(q)};k&&k.dispatchEvent(new CustomEvent(c,{bubbles:!0,cancelable:!0}));var q=window.setTimeout(function(){W.off(),X.off(),j.off(),Q.off(),he(I)},ae.holdToDrag),W=C(k,"touchend",U),X=C(k,"touchcancel",U),j=C(k,"touchmove",U),Q=C(window,"scroll",U,!0)}function fe(I,k,U){if(U===0&&I.defaultActionOverride)try{I.defaultActionOverride(k),k.defaultPrevented}catch{}K=null}r.polyfill=function(I){if(I&&Object.keys(I).forEach(function(W){ae[W]=I[W]}),!ae.forceApply){var k=(U={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},q=!!window.chrome||/chrome/i.test(navigator.userAgent),U.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||q&&"ontouchstart"in document.documentElement),U);if(k.userAgentSupportingNativeDnD&&k.draggable&&k.dragEvents)return!1}var U,q;return ae.holdToDrag?g("touchstart",ge,!1):g("touchstart",he,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(En,En.exports);var ts=En.exports;const ns=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),rs=n=>n.replace(/\n/g,"<br>"),Ce=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},as=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let ir;const os=(n=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),a=()=>{clearTimeout(r),clearTimeout(ir),ir=setTimeout(()=>{n.removeEventListener("scroll",a),e()},100)};n.addEventListener("scroll",a)}),Sn=n=>{try{return JSON.parse(n),!0}catch{return!1}},ss="0.6.5 Beta",Ye=document.querySelector(".editor"),de=document.getElementById("tones"),Se=document.getElementById("action"),re=document.getElementById("musical-score"),Re=document.getElementById("add-track"),st=document.getElementById("remove-track"),Ge=document.getElementById("dialog"),be=document.forms["dialog-form"];be._title=be.querySelector(".form-title");be.description=be.querySelector(".description");be.inputs=be.querySelector(".inputs");be.buttons=be.querySelector(".buttons");const _t=document.getElementById("play"),Ot=document.getElementById("clear"),is=document.getElementById("warn-out"),cs=document.getElementById("mml"),Ae=document.getElementById("copy"),Ve=document.getElementById("paste"),qe=document.getElementById("save"),wn=document.getElementById("open"),Kt=document.getElementById("ctrl"),Pt=document.getElementById("undo"),jt=document.getElementById("redo");var pt,ue,De,tt;class ls{constructor(){ce(this,pt,`#COMMENT Generated by FlMML VisualSequencer v${ss}`);ce(this,ue,[]);ce(this,De,(e,r)=>{});ce(this,tt,(e,r)=>{})}set onChange(e){ke(this,De,e)}set onError(e){ke(this,tt,e)}setMmlArr(e){ke(this,ue,e),D(this,De).call(this,this.getMmlArr(),this.getMml())}setMml(e){ke(this,ue,e.split(`
`)),D(this,ue).at(-2)===""&&D(this,ue).at(-1)===D(this,pt)&&D(this,ue).splice(-2,2),D(this,De).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return D(this,ue)}getMml(){return D(this,ue).length?D(this,ue).concat(["",D(this,pt)]).join(`
`):""}getMmlLine(e){return D(this,ue)[e]}insert(e,r){Object.hasOwn(D(this,ue),e)||e===0?(D(this,ue).splice(e,0,r),D(this,De).call(this,this.getMmlArr(),this.getMml())):D(this,tt).call(this,"範囲外の書き換え指定",`範囲${D(this,ue).length-1}までのところ、${e}`)}append(e){D(this,ue).push(e),D(this,De).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(D(this,ue),e)?(D(this,ue)[e]+=r,D(this,De).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(D(this,ue),e)?(D(this,ue)[e]=r+D(this,ue)[e],D(this,De).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(D(this,ue),e)?(D(this,ue)[e]=r,D(this,De).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(D(this,ue),e)&&D(this,ue).splice(e,r).length!==0?D(this,De).call(this,this.getMmlArr(),this.getMml()):D(this,tt).call(this,"無効な指定",`範囲${D(this,ue).length-1}までの中で${e}から${r}削除するのはできません`)}}pt=new WeakMap,ue=new WeakMap,De=new WeakMap,tt=new WeakMap;var me,nt,rt,vt,We;class us{constructor(e,r){ce(this,me,[]);ce(this,nt,new Set);ce(this,rt,[]);ce(this,vt,null);ce(this,We,null);this.tonesElem=e,this.areaElem=r,ke(this,We,this.areaElem.querySelector(".track.active"))}set activeTrack(e){D(this,We).classList.remove("active"),ke(this,We,e),D(this,We).classList.add("active")}get activeTrack(){return D(this,We)}blocksDataUpdate(){ke(this,me,[...this.areaElem.querySelectorAll(".track button")].map(this.extractBlockData))}extractBlockData(e){return{label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),...e.dataset,elem:e}}saveBlocksData(){clearTimeout(D(this,vt)),ke(this,vt,setTimeout(()=>{const e=JSON.parse(JSON.stringify(D(this,me)));hn.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){hn.getItem("BlocksData").then(e=>{e&&(ke(this,me,e.map(r=>{const a=r.tone;return(a==null?void 0:a.tone)!==void 0&&(a==null?void 0:a.tonePitch)!==void 0&&(r.tone=a.tone,r.tonePitch=a.tonePitch),r})),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Z),this.calcPlayFromHere())})}parseBlocks(){const e=D(this,me);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let a=0;e.forEach(o=>{if(o.trackNo!==a){const E=document.createElement("ul");E.classList.add("track"),this.activeTrack=E,this.areaElem.insertBefore(E,Re),a=o.trackNo}const t=document.createElement("li"),c='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',h=(()=>{const E=document.createElement("div");return E.innerHTML=c,E.firstElementChild})(),m=document.querySelector(`[class*="${o.className.replace(/ material-icons| droppable| bounce| pop| done| inactive/g,"")}"]`),d=(m==null?void 0:m.cloneNode(!0))||h;o.label&&(d.ariaLabel=o.label),d.className=o.className,o.tonePitch&&(o.label!=="無調整"&&(d.textContent=o.label),d.dataset.tone=o.tone,m?m.replaceWith(d.cloneNode(!0)):r.appendChild(d.cloneNode(!0)),d.dataset.tonePitch=o.tonePitch),o.tempo&&(d.dataset.tempo=o.tempo),o.noteValue&&(d.dataset.noteValue=o.noteValue),o.rest&&(d.dataset.rest=o.rest),o.octave&&(d.dataset.octave=o.octave),o.velocity&&(d.dataset.velocity=o.velocity),o.noteShift&&(d.dataset.noteShift=o.noteShift),o.detune&&(d.dataset.detune=o.detune),o.tieSlur&&(d.dataset.tieSlur=o.tieSlur,o.tieSlur==="&"?d.ariaLabel="スラー":d.ariaLabel="タイ"),o.repeatStartEnd&&(d.dataset.repeatStartEnd=o.repeatStartEnd,o.repeatStartEnd.startsWith("/:")?(d.classList.remove("material-icons"),d.ariaLabel="リピート開始",d.textContent="◆"):o.repeatStartEnd===":/"&&(d.ariaLabel="リピート終了")),o.repeatBreak&&(d.dataset.repeatBreak=o.repeatBreak),o.polyStartEnd&&(d.dataset.polyStartEnd=o.polyStartEnd),o.macroDef&&(d.dataset.macroDef=o.macroDef,o.macroDef===";"?d.textContent=";":d.textContent="$="),o.macroArgUse&&(d.dataset.macroArgUse=o.macroArgUse),o.macroUse&&(d.dataset.macroUse=o.macroUse),o.metaData&&(d.dataset.metaData=o.metaData),o.otherAction&&(d.dataset.otherAction=o.otherAction,d.textContent=o.otherAction.length>4?"…":o.otherAction),t.appendChild(d),this.activeTrack.appendChild(t)})}exportMml(e){e.setMmlArr([]);let r=0,a=0;const o=D(this,me).filter(l=>l.tone!==void 0),t=()=>o.filter(l=>l.trackNo===a),c=()=>new Set(t().map(l=>l.tone));let h=c(),m=0,d=!1,E={noteValue:4,dots:0},f=!1,g=!1;const w=D(this,me).findIndex(l=>l.elem.classList.contains("play-from-here")),C=w!==-1,_=C?D(this,me)[w].trackNo:-1;D(this,me).forEach((l,y)=>{const{tone:L,tonePitch:M}=l,R=!C||g||C&&l.trackNo===_&&y>=w;if(l.trackNo!==a&&(h.size?([...h].forEach((S,$)=>{e.appendToStr(r+$,";")}),r+=h.size):(e.appendToStr(r,";"),r++),a=l.trackNo,h=c(),d=!1,g=!1),L!==void 0)m=[...h].indexOf(L),d||([...h].forEach((S,$)=>{S&&e.beforeInsertToStr(r+$,S+" ")}),d=!0),[...h].forEach((S,$)=>{let V=M||"";$!==m&&(V=V.replace(/[a-g]/,f?"*":"r")),R||(V=V.replace(/[a-gr*]\+?[0-9]*\.*/i,"")),e.appendToStr(r+$,V)});else if(l.rest||l.tieSlur){let S=l.rest||l.tieSlur;R||(S=S.replace(/[r&]\+?[0-9]*\.*/i,"")),h.size?[...h].forEach(($,V)=>{e.appendToStr(r+V,S)}):e.appendToStr(r,S)}else if(l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd){const S=$=>{if(!$)return E;const V=Number(($.match(/[0-9]+/)||[E.noteValue])[0]),K=($.match(/\.+/)||[""])[0].length;return{noteValue:V,dots:K}};l.noteValue?E=S(l.noteValue):l.polyStartEnd==="["?f=!0:l.polyStartEnd==="]"&&(f=!1),h.size?[...h].forEach(($,V)=>{if(e.appendToStr(r+V,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||""),l.polyStartEnd==="]"){const K=e.getMmlLine(r+V).match(/\[(.+?)\]/);if(K){const ie=K[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(ie){const ae=[...ie].map(fe=>({type:fe[1]==="r"?"rest":fe[1]==="*"?"otherNote":"note",num:S(fe[0])}));ae.filter(I=>I.type==="note").map(I=>I.num),ae.filter(I=>I.type==="otherNote").map(I=>I.num),ae.filter(I=>I.type==="rest").map(I=>I.num);let he=K[0].replace(/\*\+?[0-9]*\.*/g,"");const ge=e.getMmlLine(r+V).replace(/\[.+?\]/,he);e.rewrite(r+V,ge)}}}}):e.appendToStr(r,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||"")}else if(l.metaData)l.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,l.metaData.replace(`
`,"")||""),r++;else if(l.macroDef)g=l.macroDef!==";",e.appendToStr(r,l.macroDef||"");else{let S;R?S=M||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.macroArgUse||l.macroUse||l.otherAction||"":S=(M==null?void 0:M.replace(/[a-g]\+?[0-9]*\.*/i,""))||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.otherAction||"",e.appendToStr(r,S),/;/.test(S)&&(r+=h.size||1,h=c(),d=!1)}}),[...h].slice(0,-1).forEach((l,y)=>{e.appendToStr(r+y,";")})}importMml(e){const r=e.getMmlArr(),a=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_.]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig;D(this,nt).clear();const o=new Set;let t=0,c="",h=!1,m=!1;const d=f=>(f.match(a)||[]).reduce((w,C)=>(C=C.trim(),C&&(l=>{const y={};if(y.tone={},y.trackNo=t,l.startsWith("#")){const L={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};y.label=(Object.entries(L).find(M=>l.startsWith(M[0]))||[,void 0])[1],y.className="meta-data",y.metaData=l+`
`}else if(/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(l)){c=l,o.add(c);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(l)){o.has(c)||o.add(c);const L=[...o].indexOf(c)+1;y.label="無調整",y.className=`material-icons note note-${L}`,y.tone=c,y.tonePitch=l,h&&(m=!0)}else if(l.startsWith("t"))y.className="material-icons tempo",y.tempo=l;else if(l.startsWith("l"))y.className="material-icons note-value",y.noteValue=l;else if(l.startsWith("r"))y.className="material-icons rest",y.rest=l;else if(/^o[0-8]|[><]+$/i.test(l))y.className="material-icons octave",y.octave=l;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(l))y.className="material-icons velocity",y.velocity=l;else if(l.startsWith("@ns")||l.startsWith("ns"))y.className="material-icons note-shift",y.noteShift=l;else if(l.startsWith("@d"))y.className="material-icons detune",y.detune=l;else if(l.startsWith("&"))y.className="tie-slur",y.tieSlur=l;else if(l.startsWith("/*"))y.className="other-action",y.otherAction=l;else if(l.startsWith("/:"))y.className="repeat-start-end",y.repeatStartEnd=l;else if(l.startsWith(":/"))y.className="material-icons repeat-start-end",y.repeatStartEnd=l;else if(l.startsWith("/"))y.className="repeat-break",y.repeatBreak=l;else if(l.startsWith("[")||l.startsWith("]"))y.className="poly-start-end",y.polyStartEnd=l;else if(/^\$.*?=$/.test(l))y.className="macro-def",y.macroDef=l.replaceAll(" ",""),D(this,nt).add(y.macroDef.replace("=","")),h=!0;else if(l.startsWith("%"))y.className="macro-arg-use",y.macroArgUse=l;else if(l.startsWith("$")){y.className="macro-use";const L=l.replace(/\{.*/,""),M=[...D(this,nt)].sort((R,S)=>S.length-R.length).find(R=>L.includes(R));if(M){const R=(l.match(/\{[^\}]*\}/)||[""])[0];y.macroUse=`${M}${R}`,w.push(y);const S=l.replace(M,"");S!==""&&(w=w.concat(d(S)));return}else y.macroUse=l}else if(l.startsWith(";")){if(t++,h&&!m){const L=[...o].join(" ");L&&(y.className="other-action",y.otherAction=L,w.push(y),o.clear())}c="",h=!1,m=!1;return}else y.className="other-action",y.otherAction=l;w.push(y)})(C),w),[]);this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((f,g)=>{g?f.remove():(f.textContent="",this.activeTrack=f)}),G=null;const E=r.map(d).flat();ke(this,me,E),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}get blocksData(){return D(this,me)}set blocksData(e){this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((r,a)=>{a?r.remove():(r.textContent="",this.activeTrack=r)}),G=null,ke(this,me,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData(),this.exportMml(Z),this.calcPlayFromHere()}playRendering(e=-1){const r=D(this,me);if(!r.length)return;const a=e!==-1,o=r[e],t=a?o.trackNo:-1;let c=120,h=0;[de,Se,re].forEach(C=>{C.classList.add("no-op")});const m=document.querySelector(".wrap"),d=document.getElementsByClassName("track"),f=(m.clientHeight-32)/d.length;[...d].forEach(C=>{C.style.setProperty("--max-height",`${f}px`)}),Re.disabled=!0,st.disabled=!0;const g=(C,{scoreNoteValue:_=4,ignorePlayFromHere:l=!1}={})=>{var X;let y=!1,L=-1,M=!1,R=!1;const S=[],$=performance.now(),V=(X=C[0])==null?void 0:X.trackNo,K=d[V],ie=h++,ae=C.findIndex(j=>j===o);let he=null;const ge=new Promise(j=>he=j);let fe=0,I=0;const k=j=>{if(!j)return _;const Q=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(j),J=Q&&Q[1]?Number(Q[1]):_,le=Q?Q[2].length:0;return J*2**le/(2**(le+1)-1)},U=j=>{const Q=le=>{!R&&K.scrollTo({top:le,behavior:"smooth"}),R=!0,os(K).then(()=>{R=!1})},J=le=>K.clientHeight*le;(I===0||j.elem.offsetTop>K.scrollTop+J(.8)||j.elem.offsetTop<K.scrollTop+J(.2))&&Q(j.elem.offsetTop-J(.2))},q=j=>{const Q=J=>{const le=J-$,Te=60/c*4/j*1e3;le<fe+Te?D(this,rt)[ie]=requestAnimationFrame(Q):(fe+=Te,W())};D(this,rt)[ie]=requestAnimationFrame(Q)},W=async()=>{var le,Te,Ie;const j=C[I];if(!j||I>=C.length){he({scoreNoteValue:_});return}U(j);const Q=x=>{let B=0;return C.findIndex((H,Y)=>{var ee;if(Y>x+1){if((ee=H.repeatStartEnd)!=null&&ee.startsWith("/:"))B++;else if(H.repeatStartEnd===":/"){if(B===0)return!0;B--}}return!1})},J=!a||l||a&&j.trackNo===t&&I>=ae;if(M){j.macroDef===";"&&(M=!1),I++,W();return}else if(j.tonePitch)if(J&&Ce(j.elem,"bounce"),I++,y||!J)W();else{const x=k(j.tonePitch);q(x)}else if(j.rest||j.tieSlur)if(J&&Ce(j.elem,"pop"),I++,j.tieSlur==="&"||!J)W();else{const x=k(j.rest||j.tieSlur);q(x)}else if(j.polyStartEnd)if(y=j.polyStartEnd==="[",J&&Ce(j.elem,"pop"),y||!J)I++,W();else{const x=k(C[I++-1].tonePitch);q(x)}else if(j.macroDef&&j.macroDef!==";"){M=!0,I++,W();return}else{if(j.tempo&&(c=Number(j.tempo.replace("t",""))||c),j.noteValue&&(_=k(j.noteValue)),(le=j.repeatStartEnd)!=null&&le.startsWith("/:")){S[Te=++L]??(S[Te]={start:I});let x=j.repeatStartEnd.replace("/:","");if(x=x===""?2:Number(x),x)if(S[L].end){if(!S[L].remaining){j.elem.dataset.repeatStartEnd=`/:${S[L].remaining}`,I=S[L].end,W();return}C.slice(S[L].start+1,S[L].end-1).filter(B=>{var H;return(H=B.repeatStartEnd)==null?void 0:H.startsWith("/:")}).forEach(B=>{B.elem.dataset.repeatStartEnd=B.repeatStartEnd})}else S[L].remaining=x;else{I=Q(I),W(),J&&(Ce(j.elem,"pop"),Ce(j.elem,"done"));return}j.elem.dataset.repeatStartEnd=`/:${S[L].remaining}`}else if(j.repeatBreak){if(S[L].remaining===1){S[L].end||(S[L].end=Q(S[L].start)),I=S[L].end,W(),J&&(Ce(j.elem,"pop"),Ce(j.elem,"done"));return}}else if(j.repeatStartEnd===":/"){if((Ie=S[L]).end??(Ie.end=I),S[L].remaining){S[L].remaining--,I=S[L].start,L--,W(),J&&(Ce(j.elem,"pop"),Ce(j.elem,"done"));return}S.pop(),L--}else if(j.macroUse&&J){const x=H=>{const Y=r[H].trackNo;let ee=H+1;for(;r[ee].macroDef!==";"&&r[ee].trackNo===Y;)ee++;return ee},B={};if(B.start=r.findIndex(H=>{var Y;return(Y=H.macroDef)==null?void 0:Y.startsWith(j.macroUse)}),B.start>-1){B.end=x(B.start),B.blocks=r.slice(B.start+1,B.end);const H=performance.now();_=(await g(B.blocks,{scoreNoteValue:_,ignorePlayFromHere:!0})).scoreNoteValue;const Y=performance.now();fe+=Y-H}}I++,W(),J&&Ce(j.elem,"pop")}J&&Ce(j.elem,"done")};return W(),ge},w=r.at(-1).trackNo+1;for(let C=0;C<w;C++){const _=r.filter(l=>l.trackNo===C);g(_)}}stopRendering(){[de,Se,re].forEach(e=>{e.classList.remove("no-op")}),Re.disabled=!1,st.disabled=!1,D(this,me).forEach(e=>{e.elem.classList.remove("done")}),D(this,me).filter(e=>{var r;return(r=e.repeatStartEnd)==null?void 0:r.startsWith("/:")}).forEach(e=>{e.elem.dataset.repeatStartEnd=e.repeatStartEnd}),D(this,rt).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!D(this,me).length)return;const e=D(this,me).at(-1).trackNo+1;for(let r=0;r<e;r++)D(this,me).filter(o=>o.polyStartEnd&&o.trackNo===r).forEach((o,t)=>{t%2===0?(o.elem.dataset.polyStartEnd="[",o.elem.textContent="["):(o.elem.dataset.polyStartEnd="]",o.elem.textContent="]")});this.blocksDataUpdate()}calcPlayFromHere(){if(!D(this,me).length)return;D(this,me).filter(o=>o.elem.classList.contains("inactive")).forEach(o=>{o.elem.classList.remove("inactive")});const e=D(this,me).find(o=>o.elem.classList.contains("play-from-here"));if(!e){Ae.disabled=qe.disabled=!1;return}const r=D(this,me).indexOf(e);D(this,me).filter((o,t)=>o.playFromHere?!1:o.trackNo!==e.trackNo?!0:t<r).forEach(o=>{o.elem.classList.add("inactive")}),Ae.disabled=qe.disabled=!0}}me=new WeakMap,nt=new WeakMap,rt=new WeakMap,vt=new WeakMap,We=new WeakMap;var ve,Ft,gt,at;class ds{constructor(){ce(this,ve,[[],[]]);ce(this,Ft,70);ce(this,gt,e=>{});ce(this,at,e=>{})}set onPushstate(e){ke(this,gt,e)}set onPopstate(e){ke(this,at,e)}pushState(e){D(this,ve)[0].push(e),D(this,gt).call(this,e),D(this,ve)[0].length>D(this,Ft)&&D(this,ve)[0].shift(),D(this,ve)[1].length=0,console.log(D(this,ve))}undo(){const e=D(this,ve)[0].pop();return D(this,at).call(this,{reason:"undo",data:e}),e&&D(this,ve)[1].unshift(e),console.log(D(this,ve)),{canUndo:!!D(this,ve)[0].length,canRedo:!!D(this,ve)[1].length}}redo(){const e=D(this,ve)[1].shift();return D(this,at).call(this,{reason:"redo",data:e}),e&&D(this,ve)[0].push(e),console.log(D(this,ve)),{canUndo:!!D(this,ve)[0].length,canRedo:!!D(this,ve)[1].length}}clear(){D(this,ve)[0].length=0,D(this,ve)[1].length=0,console.log(D(this,ve))}}ve=new WeakMap,Ft=new WeakMap,gt=new WeakMap,at=new WeakMap;const Me=[1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,384];let G=de.querySelector("button"),Ar=!1,Oe=!1;const je={timeStamp:-1,tempo:120,scoreNoteValue:"4"};let Tn=null,xn=!1,It=null;const Lr=()=>{T.activeTrack.querySelectorAll("button").forEach(n=>{n.classList.remove("done")}),xn=!1},Bt=()=>{if(clearTimeout(Tn),G&&G.closest(".track")!==T.activeTrack){G=T.activeTrack.querySelector("button");return}let n=G;const e=()=>{const t=performance.measure("stepElapsed","stepPoint");performance.mark("stepPoint");const c=t.duration,m=(E=>{const f=60/je.tempo*4/E*1e3,{noteValue:g,dots:w}=Me.reduce((C,_,l)=>{const y=Math.log2(f/(2*f-_));if(y<0||Number.isNaN(y))return C;const L=y-Math.floor(y);return L<C.smallerFractional?{noteValue:_,dots:Math.round(y),smallerFractional:L}:C},{noteValue:null,dots:null,smallerFractional:1});if(g+".".repeat(w)===je.scoreNoteValue)return"";if(String(g)===je.scoreNoteValue){const C=je.scoreNoteValue.match(/\.*/),_=C?C[0].length:0;return".".repeat(w-_)}else return g+".".repeat(w)})(c);(E=>{const f=It;"tonePitch"in f.dataset?f.dataset.tonePitch=f.dataset.tonePitch+E:"rest"in f.dataset&&(f.dataset.rest="r"+E)})(m),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)};if(!n){if(xn){console.log("end1");return}xe.stop(),e(),je.timeStamp=-1,It=null,performance.clearMarks("stepPoint"),setTimeout(()=>{G=T.activeTrack.querySelector("button"),Lr()},2e3),xn=!0,console.log("end2");return}(()=>{if("tonePitch"in n.dataset){n.dataset.tonePitch=n.dataset.tonePitch.match(/[><]*?[a-g]\+?/i)[0],Pe(n,{noteValue:"1..."}),n.classList.add("bounce");return}"rest"in n.dataset&&(n.dataset.rest="r"),n.classList.add("done")})();const a=()=>{var t;G=n=((t=n.parentElement.nextElementSibling)==null?void 0:t.firstElementChild)||null};if("tonePitch"in n.dataset||xe.stop(),!["tonePitch","rest"].some(t=>t in n.dataset)){if("tempo"in n.dataset){const t=Number(n.dataset.tempo.replace("t",""));je.tempo=t}else"noteValue"in n.dataset&&(je.scoreNoteValue=(n.dataset.noteValue.match(/[0-9]+\.*/)||[je.scoreNoteValue])[0]);a(),Bt(),console.log("end3");return}if((()=>{const t=60/je.tempo*4*1e3*1.825;Tn=setTimeout(Bt,t)})(),!performance.getEntriesByName("stepPoint")[0]){performance.mark("stepPoint"),It=n,a(),console.log("end4");return}e(),It=n,a()};let He=!1;var ze,yt;class fs{constructor(){ce(this,ze,30);ce(this,yt,1e3/(D(this,ze)*4));this.outputs=null,this.output=null,this.startMSec=0,this.additionalStartMSec=0,this.startTime=0,this.timer=null,this.initialized=!1}getQuarterFrameMessages(e,r,a,o){return[[241,0|o&15],[241,16|o>>4&1],[241,32|a&15],[241,48|a>>4&3],[241,64|r&15],[241,80|r>>4&3],[241,96|e&15],[241,118|e>>4&1]]}framesToTimecode(e){const r=e%D(this,ze),a=Math.floor(e/D(this,ze)),o=a%60,t=Math.floor(a/60),c=t%60;return{hours:Math.floor(t/60)%24,minutes:c,seconds:o,frames:r}}sendQuarterFrame(){if(!this.output)return;const e=performance.now(),r=(e-this.startTime)/1e3,a=Math.floor((this.startMSec+this.additionalStartMSec)/1e3*D(this,ze)+r*D(this,ze)),{hours:o,minutes:t,seconds:c,frames:h}=this.framesToTimecode(a);this.getQuarterFrameMessages(o,t,c,h).forEach((d,E)=>{var f;(f=this.output)==null||f.send(d,e+E*D(this,yt))}),this.timer=window.setTimeout(()=>this.sendQuarterFrame(),D(this,yt)*8)}async init(){if(!this.initialized)return this.initialized=!0,navigator.requestMIDIAccess().then(e=>this.outputs=Array.from(e.outputs.values()))}configure(e){Object.assign(this,e)}start(){if(!this.output){console.warn("MTC Sync output not available.");return}this.startTime=performance.now(),this.sendQuarterFrame()}stop(){this.timer&&(clearTimeout(this.timer),this.timer=null)}}ze=new WeakMap,yt=new WeakMap;const _e=new fs;var bt,Ke,$t,Ut,Vt,Wt,zt,Ht,qt,Yt,Gt;class ms{constructor(e){ce(this,bt,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name",value:(e,r)=>r.ariaLabel},{label:"音の定義",type:"text",name:"tone-def",autofocus:!0,value:e=>e}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}],run:(e,r)=>{const{"tone-name":a}=r;a.insertAdjacentElement("afterend",ps);const o=document.querySelector("emoji-picker");a.addEventListener("focus",()=>{o.classList.add("expaned")},{once:!0}),o.addEventListener("emoji-click",t=>a.value=t.detail.unicode)},on:{"set-tone":(e,r)=>{const{"tone-name":a,"tone-def":o}=r,t=e.className;document.querySelectorAll(`[class*="${t}"]`).forEach(c=>{c.ariaLabel=a,(!c.classList.contains("material-icons")||a!=="無調整")&&(c.classList.remove("material-icons"),c.textContent=a),c.dataset.tone=o})}}},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}],run:(e,r)=>{const{"tone-pitch":a}=r;D(this,Ke).call(this,a)},on:{"set-tone-pitch":(e,r)=>{const{"tone-pitch":a,dot:o}=r;e.dataset.tonePitch=`${e.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]}${a}${".".repeat(o)}`}}},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0",value:e=>e.replace("t","")}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}],on:{"set-tempo":(e,r)=>{const{tempo:a}=r;e.dataset.tempo=`t${a}`}}},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}],run:(e,r)=>{const{"note-value":a}=r;D(this,Ke).call(this,a)},on:{"set-note-value":(e,r)=>{const{"note-value":a,dot:o}=r;e.dataset.noteValue=`l${a}${".".repeat(o)}`}}},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}],run:(e,r)=>{const{rest:a}=r;D(this,Ke).call(this,a)},on:{"set-rest":(e,r)=>{const{rest:a,dot:o}=r;e.dataset.rest=`r${a}${".".repeat(o)}`}}},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8",value:e=>e.startsWith("o")?e.replace("o",""):(e.match(/[><]+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}],on:{"set-octave":(e,r)=>{const{octave:a}=r;e.dataset.octave=`o${a}`},"set-octave-relative":(e,r)=>{const{octave:a}=r;e.dataset.octave=(a>0?"<":">").repeat(Math.abs(a))}}},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127",value:e=>e.startsWith("@v")?e.replace("@v",""):Number((e.match(/[0-9]+/)||[""])[0])*(e.startsWith("(")?1:-1)}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}],on:{"set-velocity":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=`@v${a}`},"set-velocity-relative":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=(a>0?"(":")").repeat(Math.abs(a))}}},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift",value:e=>(e.match(/[0-9]+/)||[""])[0]}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}],on:{"set-note-shift":(e,r)=>{const{"note-shift":a}=r;e.dataset.noteShift=`ns${a}`},"set-note-shift-relative":(e,r)=>{const{noteShift:a}=r;e.dataset.noteShift=`@ns${a}`}}},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune",value:e=>e.replace("@d","")}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}],on:{"set-detune":(e,r)=>{const{detune:a}=r;e.dataset.detune=`@d${a}`}}},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}],run:(e,r)=>{const{"tie-slur":a}=r;D(this,Ke).call(this,a)},on:{"set-tie-slur":(e,r)=>{const{"tie-slur":a,dot:o}=r;e.dataset.tieSlur=`&${a}${".".repeat(o)}`,e.dataset.tieSlur==="&"?e.ariaLabel="スラー":e.ariaLabel="タイ"}}},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0",value:e=>e.replace("/:","")}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}],on:{"set-repeat":(e,r)=>{const{repeat:a}=r;e.dataset.repeatStartEnd=`/:${a}`}}},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name",value:e=>(e.match(/\$([^\{\=]*)/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}],on:{"set-macro-def":(e,r)=>{const{"macro-def-name":a,"macro-def-arg":o}=r;e.dataset.macroDef=`$${a}${o?`{${o}}`:""}=`;const t=(e.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];re.querySelectorAll(`[data-macro-use^="${t}"]`).forEach(c=>{c.dataset.macroUse=c.dataset.macroUse.replace(t,`$${a}`)})}}},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use",value:e=>e.replace("%","")}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}],run:(e,r)=>{const{"macro-arg-use":a}=r,t=(()=>{let E=this.item.parentElement;for(;E&&!E.firstElementChild.dataset.macroDef;)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null})();if(!t||t.dataset.macroDef===";")return;const m=(t.dataset.macroDef.match(/\{([^\}]*)\}/)||[,""])[1].split(","),d=document.createElement("datalist");d.id="macro-arg-use-list",m.forEach(E=>{const f=document.createElement("option");f.value=E,d.appendChild(f)}),a.after(d),a.setAttribute("list","macro-arg-use-list")},on:{"set-macro-arg-use":(e,r)=>{const{"macro-arg-use":a}=r;e.dataset.macroArgUse=`%${a}`}}},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name",value:e=>(e.match(/\$([^\{]*)\{?/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}],run:(e,r)=>{const{"macro-use-name":a}=r,o=document.createElement("datalist");o.id="macro-use-name-list",T.blocksData.filter(c=>c.macroDef&&c.macroDef!==";").map(c=>c.macroDef.replace("=","")).forEach(c=>{const h=document.createElement("option");h.label=(c.match(/\{[^\}]*\}/)||[""])[0],h.value=(c.match(/\$([^\{]*)\{?/)||[,""])[1],o.appendChild(h)}),a.after(o),a.setAttribute("list","macro-use-name-list")},on:{"set-macro-use":(e,r)=>{const{"macro-use-name":a,"macro-use-arg":o}=r;e.dataset.macroUse=`$${a}${o?`{${o}}`:""}`}}},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}],run:(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r,c=e.split(" "),h=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let m=h.findIndex(w=>c[0].startsWith(w));m===-1&&(m=0),a.selectedIndex=m;const d=w=>w.previousSibling,E=()=>a.selectedOptions[0],f=(w,C)=>{d(o).nodeValue=w[0],o.value=w[1],o.parentElement.style.display=w[2]?"none":"",d(t).nodeValue=C[0],t.value=C[1],t.parentElement.style.display=C[2]?"none":""},g=w=>{var l,y,L;const C=w===m,_=h[w];switch(_){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const M=C?c.slice(1).join(" ")??"":"";f(["無効","",!0],[E().label,M,!1]);break;case"#OCTAVE":case"#VELOCITY":f(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const R=_==="#WAV9",S=C?((l=c.slice(1).join(" "))==null?void 0:l.split(","))??[]:[];f(["波形番号",S[0]??0,!1],R?["初期変位,ループフラグ,データ",`${S[1]??0},${S[2]??0},${S[3]??""}`,!1]:["データ",S[1]??"",!1]),o.min=0,o.max=R?15:31;break;case"#OPM":case"#OPN":f(["音色番号",C?((y=c[0])==null?void 0:y.split("@")[1])??0:0,!1],["データ",C?((L=c.slice(1).join(" "))==null?void 0:L.slice(1,-1))??"":"",!1]),o.min=0,o.max=127;break;case"#FMGAIN":f(["音量利得",C?c[1].replace(`
`,"")??91:91,!1],["無効","",!0]),o.min=-127,o.max=127;break;case"#USING":f(["和音重ね数",C?c[2].replace(`
`,"")??2:2,!1],["無効","",!0]),o.min=1,o.max="";break}};g(m),a.addEventListener("change",w=>{g(w.target.selectedIndex)})},on:{"set-meta-data":(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r;e.ariaLabel=a.label,e.dataset.metaData=`${a.value.replace("{n}",o).replace("{desc}",t)}`}}},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action",value:e=>e}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}],on:{"set-other-action":(e,r)=>{const{"other-action":a}=r;e.dataset.otherAction=a,e.textContent=a.length>4?"…":a}}},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}],on:{"remove-left":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(G=null;[...o].includes(r);){const t=a.firstElementChild;Ee.pushState({operation:"remove",removedElem:t,removedIndex:0,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere()},"remove-right":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(G=null;[...o].includes(r);){const t=a.lastElementChild;Ee.pushState({operation:"remove",removedElem:t,removedIndex:o.length-1,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere()}}},step:{title:"ステップ音価記録",description:`ステップ音価記録は、簡単に音価を指定できる機能です。

各トラックの空白部分をテンポよくクリック、またはスペースキーを押して最初の音符から順に音価を決定します。
途中から指定をやり直したいときは、やり直したい音符をクリックすることでそこからやり直せます。

この画面は、Shiftキーを押しながらステップ音価記録ブロックをクリックすることで再度表示できます。`,buttons:[{className:"primaly",value:"set-step",textContent:"開始"},{value:"cancel-step",textContent:"やめる"}],on:{"set-step":()=>{Ar=!0,Oe=!0},"cancel-step":()=>{Oe=!1}}},mtcSync:{title:"MTC同期設定",description:`他のMIDIシーケンサー等と再生を同期できます。
MTC Senderとして動作します。`,inputs:[{label:"送信先MIDIデバイス",select:{"":"---デバイスがありません---"},name:"select-mtc-sync",disabled:!0},{label:"再生開始オフセットミリ秒",type:"number",name:"start-msec",value:()=>_e.startMSec||0,min:"0",disabled:!0}],buttons:[{className:"primaly",value:"set-sync-mtc",textContent:"開始",disabled:!0},{value:"cancel-sync-mtc",textContent:"やめる"}],run:async(e,r)=>{const{"select-mtc-sync":a,"start-msec":o}=r,t=be.buttons.querySelector('button[value="set-sync-mtc"]'),c=_e.outputs?_e.outputs:await _e.init();if(c.length===0)return;a.textContent="",a.disabled=!1,o.disabled=!1,t.disabled=!1;for(const m of c){const d=document.createElement("option");d.value=m.id,d.textContent=m.name,a.appendChild(d)}let h=c.indexOf(_e.output);h===-1&&(h=0),a.selectedIndex=h},on:{"set-sync-mtc":(e,r)=>{const{"select-mtc-sync":a,"start-msec":o}=r,t=_e.outputs.find(h=>h.id===a.value),c=o;_e.configure({output:t,startMSec:c}),He=!0},"cancel-sync-mtc":()=>{He=!1}}}});ce(this,Ke,e=>{let r=e.valueAsNumber,a=Me.findIndex(o=>o===r);e.addEventListener("input",()=>{const o=e.valueAsNumber;o!==r&&(o===0?(a=-1,e.value=""):o>r||Number.isNaN(r)?e.value=Me[++a]:o<r&&(e.value=Me[--a]),r=e.valueAsNumber)})});ce(this,$t,e=>{const r=D(this,bt)[e];D(this,Ut).call(this,r.title),D(this,Vt).call(this,r.description),D(this,Wt).call(this,r.inputs),D(this,zt).call(this,r.buttons),D(this,Ht).call(this,r.run),D(this,qt).call(this,r.on)});ce(this,Ut,e=>{be._title.textContent=e||""});ce(this,Vt,e=>{if(be.description.textContent="",e){const r=document.createElement("p");r.innerText=e,be.description.appendChild(r)}});ce(this,Wt,e=>{be.inputs.textContent="",e==null||e.forEach(r=>{const a="select"in r,o=document.createElement(a?"select":"input");let t=o;Object.entries(r).forEach(([c,h])=>{if(c==="label"){const m=document.createElement("label");m.textContent=h,m.appendChild(o),t=m}else c==="select"?Object.entries(h).forEach(([m,d])=>{const E=document.createElement("option");E.value=m,E.textContent=d,o.appendChild(E)}):c==="value"&&typeof h=="function"?o.value=h(this.mmlText,this.item):o[c]=h}),be.inputs.appendChild(t)})});ce(this,zt,e=>{be.buttons.textContent="",e==null||e.forEach(r=>{const a=document.createElement("button");Object.entries(r).forEach(([o,t])=>{a[o]=t}),be.buttons.appendChild(a)})});ce(this,Ht,e=>{e&&e(this.mmlText,D(this,Yt).call(this))});ce(this,qt,e=>{be.addEventListener("submit",r=>{const a=this.item,o=r.submitter.value,t=D(this,Gt).call(this),c=JSON.parse(JSON.stringify(a.dataset));console.log(o),e[o](a,t);const h=JSON.parse(JSON.stringify(a.dataset));JSON.stringify(c)!==JSON.stringify(h)&&Ee.pushState({operation:"valueChange",target:a,beforeChange:c,afterChange:h}),this.resolve()},{once:!0})});ce(this,Yt,()=>Object.fromEntries([...be.elements].map(e=>[e.name,e])));ce(this,Gt,()=>Object.fromEntries([...be.elements].map(r=>{var a;return r instanceof HTMLSelectElement?[r.name,{label:(a=r.selectedOptions[0])==null?void 0:a.label,value:r.value}]:[r.name,r.value]})));this.item=null,this.type=null,this.mmlText=null,this.resolve=null}async prompt(e,r){switch(this.item=e,this.type=r||Object.keys(D(this,bt)).find(a=>a in e.dataset),this.mmlText=e.dataset[this.type],this.type){case"repeatStartEnd":if(this.mmlText===":/"){const o=(()=>{var c;let t=e.parentElement;for(;t&&!((c=t.firstElementChild.dataset.repeatStartEnd)!=null&&c.startsWith("/:"));)t=t.previousElementSibling;return(t==null?void 0:t.firstElementChild)||null})();if(o)e=o;else{const t=T.activeTrack,c=document.createElement("li"),m=Se.querySelector(".repeat-start-end").cloneNode(!0);c.appendChild(m),t.insertBefore(c,e.parentElement),e=m}this.mmlText=e.dataset.repeatStartEnd}break;case"macroDef":if(this.mmlText===";")return;break}return D(this,$t).call(this,this.type),Ge.showModal(),new Promise(a=>this.resolve=a)}}bt=new WeakMap,Ke=new WeakMap,$t=new WeakMap,Ut=new WeakMap,Vt=new WeakMap,Wt=new WeakMap,zt=new WeakMap,Ht=new WeakMap,qt=new WeakMap,Yt=new WeakMap,Gt=new WeakMap;ur.FlMML.prepare(".editor");const xe=new ur.FlMML({workerURL:wa}),Z=new ls;hn.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const T=new us(de,re),Ee=new ds,Be=new ms(be),hs={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},ps=new An({i18n:hs,locale:"ja"});ts.polyfill({holdToDrag:500});as();const ht=n=>`<span class="material-icons">${n}</span>`,_r=ht("play_arrow")+"再生",vs=ht("stop")+"停止",kn=()=>{const n=[...re.querySelectorAll(".track button")].findIndex(e=>e.classList.contains("play-from-here"));T.playRendering(n),He&&_e.start()},gs=()=>{is.innerText=xe.getWarnings()};xe.addEventListener("compilecomplete",gs);const ys=()=>{_t.innerHTML=_r,T.stopRendering(),He&&_e.stop(),xe.removeEventListener("compilecomplete",kn),Ot.disabled=!1};xe.addEventListener("complete",ys);Z.onChange=(n,e)=>{cs.innerHTML=e?`<pre><code>${rs(ns(e))}</code></pre>`:"(なし)";const r=!!n.length;Ae.disabled=qe.disabled=!r};Z.onError=(n,e)=>{alert(n+`
`+e)};T.checkSavedBlocksData();const Pe=(n,e={})=>{var l;const r=()=>{let y=n.parentElement;for(;y&&!("noteValue"in y.firstElementChild.dataset);)y=y.previousElementSibling;return(y==null?void 0:y.firstElementChild)||null},a=()=>{var L;let y=n.parentElement;for(;y&&!((L=y.firstElementChild.dataset.octave)!=null&&L.startsWith("o"));)y=y.previousElementSibling;return(y==null?void 0:y.firstElementChild)||null},o=()=>{var M;let y=n.parentElement.nextElementSibling,L="";for(;y&&((M=y.firstElementChild.dataset.tieSlur)!=null&&M.match(/&[0-9]+\.*/));)L+=y.firstElementChild.dataset.tieSlur,y=y.nextElementSibling;return L},t=((l=r())==null?void 0:l.dataset.noteValue)||"",c=a(),h=c?[...T.activeTrack.children].indexOf(c.parentElement):0,m=(c==null?void 0:c.dataset.octave)||"",d=[...T.activeTrack.children].indexOf(n.parentElement),E=[...T.activeTrack.children].slice(h,d).filter(y=>"tonePitch"in y.firstElementChild.dataset||"octave"in y.firstElementChild.dataset&&!y.firstElementChild.dataset.octave.startsWith("o")).map(y=>((y.firstElementChild.dataset.tonePitch||y.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),f={down:">",up:"<"},g=(y,L)=>(y.match(new RegExp(L,"g"))||[]).length,w=(()=>{const y=-g(E,f.down)+g(E,f.up);return y<0?f.down.repeat(-y):y>0?f.up.repeat(y):""})(),C=o(),_=e.noteValue?n.dataset.tonePitch.replace(/[0-9]+\.*/,"")+e.noteValue:n.dataset.tonePitch;xe.play(n.dataset.tone+t+m+w+_+C)};Ee.onPopstate=n=>{const e=n.data,r=a=>!!e.parent.closest("#"+a);switch(n.reason){case"undo":switch(e==null?void 0:e.operation){case"append":Z.delete(e.index);break;case"delete":Z.insert(e.index,e.mmlText);break;case"rewrite":Z.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere());break;case"move":const a=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(a,e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere());break;case"valueChange":for(const[o,t]of Object.entries(e.beforeChange))e.target.dataset[o]=t;"tone"in e.target.dataset&&Pe(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere());break;case"clear":e.tonesChildren.forEach(o=>{de.querySelector("ul").appendChild(o)}),e.musicalScoreChildren.forEach(o=>{re.insertBefore(o,Re)}),G=e.lastTouchedButton,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":Z.append(e.mmlText);break;case"delete":Z.delete(e.index);break;case"rewrite":Z.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere()),"tonePitch"in G.dataset&&(Pe(G),G.classList.add("bounce"));break;case"move":const a=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(a,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere());break;case"valueChange":for(const[t,c]of Object.entries(e.afterChange))e.target.dataset[t]=c;"tone"in e.target.dataset&&Pe(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);break;case"remove":const o=e.removedElem.className;e.removedElem.remove(),r("tones")&&re.querySelectorAll(`[class*="${o}"]`).forEach(t=>{t.parentElement.remove()}),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere();break;case"clear":de.querySelector("ul").textContent="",re.querySelectorAll(".track").forEach((t,c)=>{c?t.remove():(t.textContent="",T.activeTrack=t)}),G=null,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);break}break}};const Or=()=>{const n=[...de.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!n.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",n=>{var r;const e=n.ctrlKey||Kt.checked;switch((r=n.key)==null?void 0:r.toLowerCase()){case" ":Oe?(n.preventDefault(),Bt()):document.activeElement.tagName.toLowerCase()!=="input"&&(n.preventDefault(),_t.click());break;case"s":e&&(n.preventDefault(),!qe.disabled&&qe.click());break;case"o":e&&(n.preventDefault(),!wn.disabled&&wn.click());break;case"z":e&&Ee.undo();break;case"y":e&&Ee.redo();break}});Ye.addEventListener("click",async n=>{const e=n.ctrlKey||Kt.checked,r=o=>!!n.target.closest("#"+o),a=n.target.tagName.toLowerCase()==="button";if(![de,Se,re].some(o=>o.classList.contains("no-op"))){if(r("tones"))if(a)G=n.target,await Be.prompt(n.target,"tone"),xe.play(n.target.dataset.tone+n.target.dataset.tonePitch),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z);else{const o=de.querySelector("ul"),t=document.createElement("li"),h=`<button class="material-icons note ${Or()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;t.innerHTML=h;const m=t.firstElementChild;o.appendChild(t),G=m,xe.play(m.dataset.tone+m.dataset.tonePitch),Ee.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o})}else if(r("action")){if(a){if("otherAction"in n.target.dataset)await Be.prompt(n.target);else if("step"in n.target.dataset){Ar&&!n.shiftKey?Oe=!Oe:await Be.prompt(n.target),Oe?(n.target.classList.add("enable"),n.target.ariaLabel="ステップ音価記録(有効)",G=T.activeTrack.querySelector("button")):(n.target.classList.remove("enable"),n.target.ariaLabel="ステップ音価記録(無効)",Lr(),xe.stop(),clearTimeout(Tn));return}else if("mtcSync"in n.target.dataset){He?He=!1:await Be.prompt(n.target,"mtcSync"),He?(n.target.classList.add("enable"),n.target.ariaLabel="MTC同期(有効)"):(n.target.classList.remove("enable"),n.target.ariaLabel="MTC同期(無効)");return}const o=T.activeTrack,t=document.createElement("li"),c=n.target.cloneNode(!0);if(["metaData","macroDef","macroUse"].some(h=>h in c.dataset)&&await Be.prompt(c),"tieSlur"in c.dataset?c.ariaLabel="スラー":"repeatStartEnd"in c.dataset?(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"):"polyStartEnd"in c.dataset?(c.dataset.polyStartEnd="[",c.textContent="["):"macroDef"in c.dataset?c.textContent="$=":"playFromHere"in c.dataset&&(re.querySelectorAll(".track button").forEach(h=>{h.classList.add("inactive")}),Ae.disabled=qe.disabled=!0),t.appendChild(c),o.appendChild(t),G=c,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere(),Ee.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),["repeatStartEnd","polyStartEnd","macroDef"].some(h=>h in G.dataset)){const h=document.createElement("li"),m=n.target.cloneNode(!0);"repeatStartEnd"in G.dataset?(m.ariaLabel="リピート終了",m.dataset.repeatStartEnd=":/"):"polyStartEnd"in G.dataset?(m.dataset.polyStartEnd="]",m.textContent="]"):"macroDef"in G.dataset&&(m.dataset.macroDef=";",m.textContent=";"),h.appendChild(m),G.parentElement.insertAdjacentElement("afterend",h),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z),Ee.pushState({operation:"copy",toIndex:-1,newElem:h,parent:o})}}}else if(r("musical-score")){if(a&&n.target!==Re&&n.target!==st)n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Oe||("tone"in n.target.dataset?(Pe(n.target),Ce(n.target,"bounce"),e&&(await Be.prompt(n.target,"tonePitch"),Pe(n.target))):await Be.prompt(n.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)),G=n.target;else if(n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Oe)Bt();else if(G){const o=T.activeTrack,t=document.createElement("li"),c=G.cloneNode(!0);if("repeatStartEnd"in c.dataset&&(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"+(c.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),t.appendChild(c),o.appendChild(t),G=c,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere(),Ee.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),"tonePitch"in c.dataset)c.dataset.tonePitch=c.dataset.tonePitch.replace(/[><]+/,""),Pe(c),c.classList.add("bounce");else if("repeatStartEnd"in G.dataset){const h=document.createElement("li"),m=G.cloneNode(!0);m.classList.add("material-icons"),m.ariaLabel="リピート終了",m.textContent="repeat",m.dataset.repeatStartEnd=":/",h.appendChild(m),G.parentElement.insertAdjacentElement("afterend",h),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z),Ee.pushState({operation:"copy",toIndex:-1,newElem:h,parent:o})}}}}});Ye.addEventListener("contextmenu",n=>{var o,t,c,h;if(Oe)return;const e=m=>m.closest("#tones, #musical-score"),r=m=>!!n.target.closest("#"+m),a=n.target.tagName.toLowerCase()==="button";if(!((o=e(n.target))!=null&&o.classList.contains("no-op"))&&e(n.target)){const m=a&&n.target!==Re&&n.target!==st?n.target:G;if(!m||e(m)!==e(n.target))return;n.preventDefault(),T.activeTrack=m.closest(".track")||T.activeTrack;const d=m.parentElement,E=m.className,f=((t=m.closest("#tones"))==null?void 0:t.querySelector("ul"))||T.activeTrack,g=[...f.children].indexOf(d);if(G=((c=d.previousElementSibling)==null?void 0:c.firstElementChild)||((h=d.nextElementSibling)==null?void 0:h.firstElementChild)||null,Ee.pushState({operation:"remove",removedElem:d,removedIndex:g,parent:f}),r("tones"))re.querySelectorAll(`[class*="${E}"]`).forEach(w=>{w.parentElement.remove()});else if("macroDef"in m.dataset){const w=(m.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];re.querySelectorAll(`[data-macro-use^="${w}"]`).forEach(C=>{C.parentElement.remove()})}else"playFromHere"in m.dataset&&(re.querySelectorAll(".inactive").forEach(w=>{w.classList.remove("inactive")}),Ae.disabled=qe.disabled=!1);d.remove(),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere()}});let Dt=null,Ln=!1,Rt=null;Ye.addEventListener("touchstart",n=>{Dt=[...n.touches].at(-1).pageY,Rt=setTimeout(()=>{Ln=!0},500)});const Pr=n=>{if(Oe)return;const e=n.ctrlKey||Kt.checked,r=c=>!!n.target.closest("#"+c),a=n.target.tagName.toLowerCase()==="button";if(n.type==="touchmove"){const c=[...n.touches].at(-1).pageY;if(Ln){n.cancelable&&n.preventDefault();return}else if(c-Dt<-30)n.deltaY=-1,clearTimeout(Rt);else if(c-Dt>30)n.deltaY=1,clearTimeout(Rt);else{n.cancelable&&n.preventDefault();return}Dt=c}const o=n.deltaY<0;let t=a&&n.target!==Re&&n.target!==st?n.target:(G==null?void 0:G.closest("#musical-score"))&&G;if(t){if(r("musical-score")){if(re.classList.contains("no-op"))return;n.preventDefault();let c=JSON.parse(JSON.stringify(t.dataset));if(!e&&"tone"in t.dataset){const m=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],d={down:">",up:"<"},E=t.dataset.tonePitch,f=m.findIndex(y=>E.match(/[a-g]\+?/)[0]===y),g=(y,L)=>(y.match(new RegExp(L,"g"))||[]).length,w={down:g(E,d.down),up:g(E,d.up)},C=d.down.repeat(w.down)+d.up.repeat(w.up),_=(E.match(/[0-9]+/)||[""])[0],l=(t.dataset.tonePitch.match(/\.+/)||[""])[0];o?f===m.length-1?w.down?t.dataset.tonePitch=C.substring(1)+m.at(0)+_+l:t.dataset.tonePitch=C+d.up+m.at(0)+_+l:t.dataset.tonePitch=C+m[f+1]+_+l:f===0?w.up?t.dataset.tonePitch=C.substring(1)+m.at(-1)+_+l:t.dataset.tonePitch=C+d.down+m.at(-1)+_+l:t.dataset.tonePitch=C+m[f-1]+_+l,Pe(t)}else{const m=o?1:-1,d=(E,f=-1/0,g=1/0)=>E+m<f||E+m>g?0:m;if(e&&"tonePitch"in t.dataset){const E=Number((t.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),f=(t.dataset.tonePitch.match(/\.+/)||[""])[0],g=d(E,0,384),w=Me.findIndex(_=>_===E),C=E+g!==0?Me[w+g]:"";t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+C+f,Pe(t)}else if("tempo"in t.dataset){const E=Number(t.dataset.tempo.replace("t","")),f=d(E,0);t.dataset.tempo="t"+(E+f*10)}else if("noteValue"in t.dataset){const E=Number((t.dataset.noteValue.match(/[0-9]+/)||[""])[0]),f=d(E,1,384),g=Me.findIndex(w=>w===E);t.dataset.noteValue=t.dataset.noteValue.replace(/[0-9]+/,Me[g+f])}else if("rest"in t.dataset){const E=Number((t.dataset.rest.match(/[0-9]+/)||[""])[0]),f=(t.dataset.rest.match(/\.+/)||[""])[0],g=d(E,0,384),w=Me.findIndex(_=>_===E),C=E+g!==0?Me[w+g]:"";t.dataset.rest="r"+C+f}else if("octave"in t.dataset)if(t.dataset.octave.startsWith("o")){const f=Number(t.dataset.octave.replace("o","")),g=d(f,0,8);t.dataset.octave="o"+(f+g)}else{const f=(t.dataset.octave.match(/<+/)||[""])[0].length-(t.dataset.octave.match(/>+/)||[""])[0].length,g=d(f,-8,8);t.dataset.octave=f+g>0?"<".repeat(f+g):">".repeat(-(f+g))}else if("velocity"in t.dataset)if(t.dataset.velocity.startsWith("@v")){const f=Number(t.dataset.velocity.replace("@v","")),g=d(f,0,127);t.dataset.velocity="@v"+(f+g)}else{const f=Number((t.dataset.velocity.match(/[0-9]+/)||[""])[0])*(t.dataset.velocity.startsWith("(")?1:-1),g=d(f,-127,127);t.dataset.velocity=(f+g>=0?"(":")")+Math.abs(f+g)}else if("noteShift"in t.dataset){const E=Number((t.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),f=m;t.dataset.noteShift=t.dataset.noteShift.match(/@?ns/)[0]+(E+f)}else if("detune"in t.dataset){const E=Number(t.dataset.detune.replace("@d","")),f=m;t.dataset.detune="@d"+(E+f)}else if("tieSlur"in t.dataset){const E=Number((t.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),f=(t.dataset.tieSlur.match(/\.+/)||[""])[0],g=d(E,0,384),w=Me.findIndex(_=>_===E),C=E+g!==0?Me[w+g]:"";t.dataset.tieSlur="&"+C+f,t.dataset.tieSlur==="&"?t.ariaLabel="スラー":t.ariaLabel="タイ"}else if("repeatStartEnd"in t.dataset){if(t.dataset.repeatStartEnd===":/"){const C=(()=>{var l;let _=t.parentElement;for(;_&&!((l=_.firstElementChild.dataset.repeatStartEnd)!=null&&l.startsWith("/:"));)_=_.previousElementSibling;return(_==null?void 0:_.firstElementChild)||null})();if(C)t=C;else{const _=T.activeTrack,l=document.createElement("li"),L=Se.querySelector(".repeat-start-end").cloneNode(!0);l.appendChild(L),_.insertBefore(l,t.parentElement),t=L}c=JSON.parse(JSON.stringify(t.dataset))}const E=Number((t.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),f=d(E,-1),g=E+f!==-1?E+f:"";t.dataset.repeatStartEnd="/:"+g}}const h=JSON.parse(JSON.stringify(t.dataset));JSON.stringify(c)!==JSON.stringify(h)&&Ee.pushState({operation:"valueChange",target:t,beforeChange:c,afterChange:h}),G=t,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)}}else return};Ye.addEventListener("wheel",Pr);Ye.addEventListener("touchmove",Pr);Ye.addEventListener("touchend",()=>{clearTimeout(Rt),Ln=!1});let ft={};Ye.addEventListener("dragstart",n=>{ft={from:n.target.nodeType===1&&n.target.closest("#tones, #action, #musical-score"),item:n.target},n.dataTransfer.effectAllowed="copyMove"});let cr=null;[de,Se,re].forEach(n=>{const e=t=>{const c=t.ctrlKey||Kt.checked,{from:h=null}=ft,m=t.dataTransfer;switch(h){case de:switch(n){case de:t.preventDefault(),c?m.dropEffect="copy":m.dropEffect="move";break;case Se:break;case re:t.preventDefault(),m.dropEffect="copy";break}break;case Se:switch(n){case de:break;case Se:break;case re:t.preventDefault(),m.dropEffect="copy";break}break;case re:switch(n){case de:break;case Se:break;case re:t.preventDefault(),c?m.dropEffect="copy":m.dropEffect="move";break}break}cr=m.dropEffect};n.addEventListener("dragover",e);const r=t=>{const{from:c=null}=ft,h=t.target.tagName.toLowerCase()==="button",m=()=>t.target.classList.add("droppable");switch(c){case de:switch(n){case de:t.preventDefault(),h&&m();break;case Se:break;case re:t.preventDefault(),h&&m();break}break;case Se:switch(n){case de:break;case Se:break;case re:t.preventDefault(),h&&m();break}break;case re:switch(n){case de:break;case Se:break;case re:t.preventDefault(),h&&m();break}break}};n.addEventListener("dragenter",r);const a=t=>{const{from:c=null}=ft,h=t.target.tagName.toLowerCase()==="button",m=()=>t.target.classList.remove("droppable");switch(c){case de:switch(n){case de:h&&m();break;case Se:break;case re:h&&m();break}break;case Se:switch(n){case de:break;case Se:break;case re:h&&m();break}break;case re:switch(n){case de:break;case Se:break;case re:h&&m();break}break}};n.addEventListener("dragleave",a),n.addEventListener("drop",async t=>{var w,C;if(t.preventDefault(),(w=t.dataTransfer.items)!=null&&w.length)return;t.dataTransfer.dropEffect=t.dataTransfer.dropEffect!=="none"?t.dataTransfer.dropEffect:cr;const{from:c,item:h}=ft,m=((C=t.target.closest("#tones"))==null?void 0:C.querySelector("ul"))||t.target.closest(".track")||T.activeTrack,d=[...n.querySelectorAll("button")].indexOf(h),E=[...n.querySelectorAll("button")].indexOf(t.target),f=t.target.tagName.toLowerCase()==="button";let g;switch(t.dataTransfer.dropEffect){case"copy":const _=document.createElement("li"),l=h.cloneNode(!0);if(n===de){const y=[...h.classList].find(L=>L.includes("note-"));l.classList.replace(y,Or())}else c===Se&&("tieSlur"in l.dataset?l.ariaLabel="スラー":["metaData","macroDef","macroUse","otherAction"].some(y=>y in l.dataset)&&await Be.prompt(l));"repeatStartEnd"in l.dataset?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"+(l.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in l.dataset?(l.dataset.polyStartEnd="[",l.textContent="["):"macroDef"in l.dataset&&(l.dataset.macroDef===";"&&(l.dataset.macroDef="$="),l.textContent="$="),_.appendChild(l),g=_;break;case"move":g=h.parentElement;break}if(f&&t.target.id!=="add-track"&&t.target.id!=="remove-track"){const _=t.dataTransfer.dropEffect==="copy"||E<d?"beforebegin":"afterend";t.target.parentElement.insertAdjacentElement(_,g)}else m.appendChild(g);switch(G=g.firstElementChild,n===re&&(T.activeTrack=m,T.blocksDataUpdate(),t.dataTransfer.dropEffect==="move"&&T.calcPoly(),T.saveBlocksData(),T.exportMml(Z),T.calcPlayFromHere(),"tonePitch"in G.dataset&&(G.dataset.tonePitch=G.dataset.tonePitch.replace(/[><]+/,""),Pe(G),G.classList.add("bounce"))),t.dataTransfer.dropEffect){case"copy":Ee.pushState({operation:"copy",toIndex:E,newElem:g,parent:m});break;case"move":Ee.pushState({operation:"move",fromIndex:d,toIndex:E,elem:g,parent:m});break}if(t.dataTransfer.dropEffect==="copy"&&["repeatStartEnd","polyStartEnd","macroDef"].some(_=>_ in G.dataset)){const _=document.createElement("li"),l=h.cloneNode(!0);"repeatStartEnd"in G.dataset?(l.classList.add("material-icons"),l.ariaLabel="リピート終了",l.textContent="repeat",l.dataset.repeatStartEnd=":/"):"polyStartEnd"in G.dataset?(l.dataset.polyStartEnd="]",l.textContent="]"):"macroDef"in G.dataset&&(l.dataset.macroDef=";",l.textContent=";"),_.appendChild(l),g.insertAdjacentElement("afterend",_),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z),Ee.pushState({operation:"copy",toIndex:E+1,newElem:_,parent:m})}});const o=t=>{[...document.getElementsByClassName("droppable")].forEach(c=>{c.classList.remove("droppable")})};n.addEventListener("dragend",o)});Ye.addEventListener("animationend",n=>{n.target.classList.remove("bounce"),n.target.classList.remove("pop")});Re.addEventListener("click",n=>{n.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),T.activeTrack=e,re.insertBefore(e,Re)});st.addEventListener("click",n=>{n.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),T.activeTrack=r,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)});Ge.addEventListener("pointerdown",n=>{n.target===Ge&&Ge.addEventListener("pointerup",e=>{e.target===Ge&&Ge.close()},{once:!0})});Ge.addEventListener("close",()=>{switch(Be.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});_t.addEventListener("click",()=>{const n=xe.isPlaying();n?(xe.stop(),T.stopRendering(),He&&_e.stop(),xe.removeEventListener("compilecomplete",kn),Ot.disabled=!1):(xe.play(Z.getMml()),xe.addEventListener("compilecomplete",kn),Ot.disabled=!0),_t.innerHTML=n?_r:vs});Ot.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const n=[...re.children];n.pop(),Ee.pushState({operation:"clear",tonesChildren:[...de.querySelector("ul").children],musicalScoreChildren:n,lastTouchedButton:G}),de.querySelector("ul").textContent="";const e=de.querySelector("ul"),r=document.createElement("li"),a='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=a;const o=r.firstElementChild;e.appendChild(r),G=o,re.querySelectorAll(".track").forEach((t,c)=>{c?t.remove():(t.textContent="",T.activeTrack=t)}),xe.play(""),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Z)}});Ae.addEventListener("click",async n=>{const e=n.shiftKey?JSON.stringify(T.blocksData):Z.getMml(),r=Ae.innerHTML;Ae.disabled=!0,navigator.clipboard.writeText(e).then(()=>{Ae.disabled=!0,Ae.innerHTML=ht("content_copy")+"コピーしました",n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータをコピーしました。"),setTimeout(()=>{Ae.innerHTML=r,Ae.disabled=!1},1500)}).catch(a=>alert(`コピーできませんでした
`+a))});Ve.addEventListener("click",()=>{const n=Ve.innerHTML;Ve.disabled=!0,navigator.clipboard.readText().then(e=>{Ve.disabled=!0,e?(Sn(e)?T.blocksData=JSON.parse(e):(Z.setMml(e.replace(/\r/g,"")),T.importMml(Z)),Ve.innerHTML=ht("content_paste")+"貼り付けました",Sn(e)&&alert("JSONブロックデータが貼り付けられました。")):Ve.innerHTML=ht("content_paste")+"内容がありません",setTimeout(()=>{Ve.innerHTML=n,Ve.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});qe.addEventListener("click",n=>{var c;const r=((c=Z.getMmlArr().find(h=>h.startsWith("#TITLE")))==null?void 0:c.split(" ").slice(1).join(" "))??"無題",a=n.shiftKey?JSON.stringify(T.blocksData):Z.getMml(),o=new Blob([a],{type:n.shiftKey?"application/json":"text/plain"}),t=document.createElement("a");t.download=r+(n.shiftKey?".json":".mml"),t.href=URL.createObjectURL(o),t.click(),URL.revokeObjectURL(t.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。"),n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータを保存しました。")});wn.addEventListener("click",()=>{const n=document.createElement("input"),e=new FileReader;n.type="file",n.accept=".mml,.flmml,.txt,.json",n.click(),n.onchange=()=>{e.onload=()=>{const r=e.result;Sn(r)?(T.blocksData=JSON.parse(r),alert("JSONブロックデータが読み込まれました。")):(Z.setMml(r.replace(/\r/g,"")),T.importMml(Z))},e.readAsText(n.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");Ee.onPushstate=n=>{Pt.disabled=!1,jt.disabled=!0};Pt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=Ee.undo();Pt.disabled=!n,jt.disabled=!e});jt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=Ee.redo();Pt.disabled=!n,jt.disabled=!e});
