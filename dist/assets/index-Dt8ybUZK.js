var mn=(n,e,s)=>{if(!e.has(n))throw TypeError("Cannot "+s)};var K=(n,e,s)=>(mn(n,e,"read from private field"),s?s.call(n):e.get(n)),$e=(n,e,s)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,s)},He=(n,e,s,i)=>(mn(n,e,"write to private field"),i?i.call(n,s):e.set(n,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const h of document.querySelectorAll('link[rel="modulepreload"]'))i(h);new MutationObserver(h=>{for(const o of h)if(o.type==="childList")for(const p of o.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&i(p)}).observe(document,{childList:!0,subtree:!0});function s(h){const o={};return h.integrity&&(o.integrity=h.integrity),h.referrerPolicy&&(o.referrerPolicy=h.referrerPolicy),h.crossOrigin==="use-credentials"?o.credentials="include":h.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(h){if(h.ep)return;h.ep=!0;const o=s(h);fetch(h.href,o)}})();const ar="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var kt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function or(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var xn={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(s,i){n.exports=i()})(self,function(){return(()=>{var s={587:(o,p,v)=>{var B;(B=(function(S,F){Object.defineProperty(F,"__esModule",{value:!0}),F.MsgTypes=F.SAMPLE_RATE=void 0,F.SAMPLE_RATE=44100,F.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(p,[v,p]))===void 0||(o.exports=B)},581:(o,p,v)=>{var B;(B=(function(S,F){Object.defineProperty(F,"__esModule",{value:!0}),F.FlMMLAudioExportError=void 0;class k extends Error{constructor(...R){super(...R),this.name="FlMMLAudioExportError"}}F.FlMMLAudioExportError=k}).apply(p,[v,p]))===void 0||(o.exports=B)},643:function(o,p,v){var B,S,F=this&&this.__awaiter||function(k,w,R,ue){return new(R||(R=Promise))(function(ve,te){function Z(Q){try{V(ue.next(Q))}catch(D){te(D)}}function me(Q){try{V(ue.throw(Q))}catch(D){te(D)}}function V(Q){var D;Q.done?ve(Q.value):(D=Q.value,D instanceof R?D:new R(function(ee){ee(D)})).then(Z,me)}V((ue=ue.apply(k,w||[])).next())})};B=[v,p,v(587),v(581),v(158)],(S=(function(k,w,R,ue,ve){Object.defineProperty(w,"__esModule",{value:!0}),w.FlMMLonHTML5=w.FlMMLAudioExportError=w.FlMML=void 0,Object.defineProperty(w,"FlMMLAudioExportError",{enumerable:!0,get:function(){return ue.FlMMLAudioExportError}});const te="flmml-on-html5.worker.js";class Z{constructor(V=te){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof V=="string"&&(V={workerURL:V});const Q=V.workerURL||te,D=V.infoInterval>=0?V.infoInterval:125;this.bufferSize=V.bufferSize>=128?Math.floor(V.bufferSize-V.bufferSize%128):8192,this.bufferMultiple=V.bufferMultiple>=1?Math.floor(V.bufferMultiple):32,this.lamejsURL=V.lamejsURL,(this.worker=new Worker(V.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${Q}")`],{type:"application/javascript"})):Q)).addEventListener("message",ee=>{this.onMessage(ee)}),this.setInfoInterval(D)}static initWebAudio(){const V=Z.audioCtx=new AudioContext({sampleRate:R.SAMPLE_RATE}),Q=V.createBufferSource();Q.connect(V.destination),Q.start(0),V.resume(),Q.stop()}static hookInitWebAudio(V){const Q=document.querySelectorAll(V);Q.forEach(D=>{D.addEventListener("click",function ee(){Z.audioCtx||Z.initWebAudio(),Q.forEach(X=>{X.removeEventListener("click",ee,!0)})},!0)})}static prepare(V){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Z.hookInitWebAudio(V)}):Z.hookInitWebAudio(V)}onMessage(V){const Q=V.data;switch(Q.type){case R.MsgTypes.COMPCOMP:this.totalMSec=Q.info.totalMSec,this.totalTimeStr=Q.info.totalTimeStr,this.warnings=Q.info.warnings,this.metaTitle=Q.info.metaTitle,this.metaComment=Q.info.metaComment,this.metaArtist=Q.info.metaArtist,this.metaCoding=Q.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case R.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(Q),this.trigger("buffering",{progress:Q.progress});break;case R.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case R.MsgTypes.SYNCINFO:this._isPlaying=Q.info._isPlaying,this._isPaused=Q.info._isPaused,this.nowMSec=Q.info.nowMSec,this.nowTimeStr=Q.info.nowTimeStr,this.voiceCount=Q.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case R.MsgTypes.PLAYSOUND:this.playSound();break;case R.MsgTypes.STOPSOUND:this.stopSound();break;case R.MsgTypes.EXPORT:Q.data?this.completeAudioExport(Q.data):this.errorAudioExport(Q.errorMsg)}}boot(){this.worker.postMessage({type:R.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const V=Z.audioCtx,Q=this.gainNode=V.createGain();Q.gain.value=this.volume/127,Q.connect(V.destination),F(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(ee=>{const X=new FileReader;X.onload=Y=>{V.audioWorklet.addModule(Y.target.result).then(ee)},X.readAsDataURL(new Blob([ve.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const D=this.workletNode=new AudioWorkletNode(V,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});D.connect(Q),this.worker.postMessage({type:R.MsgTypes.PLAYSOUND,workletPort:D.port},[D.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:R.MsgTypes.STOPSOUND})}trigger(V,Q){const D=this.events[V];if(!D)return;const ee={};for(let X in Q)ee[X]=Q[X];for(let X=0,Y=D.length;X<Y;X++)D[X]&&D[X].call(this,ee)}exportAudio(V,Q,D={}){return Z.audioCtx||Z.initWebAudio(),this.booted||this.boot(),new Promise((ee,X)=>{this.audioExportResolve?X(new ue.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:R.MsgTypes.EXPORT,mml:V,format:Q},D)),this.audioExportResolve=ee,this.audioExportReject=X)})}completeAudioExport(V){this.audioExportResolve&&(this.audioExportResolve(V),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(V){this.audioExportReject&&(this.audioExportReject(new ue.FlMMLAudioExportError(V)),this.audioExportResolve=null,this.audioExportReject=null)}play(V){Z.audioCtx||Z.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:R.MsgTypes.PLAY,mml:V})}stop(){this.worker.postMessage({type:R.MsgTypes.STOP})}pause(){this.worker.postMessage({type:R.MsgTypes.PAUSE})}exportWav(V){return this.exportAudio(V,"wav")}exportMp3(V,Q){return this.exportAudio(V,"mp3",{bitrate:Q})}setMasterVolume(V){this.volume=V,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(V){this.worker.postMessage({type:R.MsgTypes.SYNCINFO,interval:V})}syncInfo(){this.worker.postMessage({type:R.MsgTypes.SYNCINFO,interval:null})}addEventListener(V,Q){let D=this.events[V];D||(D=this.events[V]=[]);for(let ee=D.length;ee--;)if(D[ee]===Q)return!1;return D.push(Q),!0}removeEventListener(V,Q){const D=this.events[V];if(!D)return!1;for(let ee=D.length;ee--;)if(D[ee]===Q)return D.splice(ee,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}w.FlMML=Z,w.FlMMLonHTML5=Z}).apply(p,B))===void 0||(o.exports=S)},158:(o,p,v)=>{v.r(p),v.d(p,{FlMMLWorkletScript:()=>B});const B='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},i={};function h(o){var p=i[o];if(p!==void 0)return p.exports;var v=i[o]={exports:{}};return s[o].call(v.exports,v,v.exports,h),v.exports}return h.d=(o,p)=>{for(var v in p)h.o(p,v)&&!h.o(o,v)&&Object.defineProperty(o,v,{enumerable:!0,get:p[v]})},h.o=(o,p)=>Object.prototype.hasOwnProperty.call(o,p),h.r=o=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},h(643)})()})})(xn);var pn=xn.exports;function _t(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Cn={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(s){n.exports=s()})(function(){return function s(i,h,o){function p(S,F){if(!h[S]){if(!i[S]){var k=typeof _t=="function"&&_t;if(!F&&k)return k(S,!0);if(v)return v(S,!0);var w=new Error("Cannot find module '"+S+"'");throw w.code="MODULE_NOT_FOUND",w}var R=h[S]={exports:{}};i[S][0].call(R.exports,function(ue){var ve=i[S][1][ue];return p(ve||ue)},R,R.exports,s,i,h,o)}return h[S].exports}for(var v=typeof _t=="function"&&_t,B=0;B<o.length;B++)p(o[B]);return p}({1:[function(s,i,h){(function(o){var p=o.MutationObserver||o.WebKitMutationObserver,v;if(p){var B=0,S=new p(ue),F=o.document.createTextNode("");S.observe(F,{characterData:!0}),v=function(){F.data=B=++B%2}}else if(!o.setImmediate&&typeof o.MessageChannel<"u"){var k=new o.MessageChannel;k.port1.onmessage=ue,v=function(){k.port2.postMessage(0)}}else"document"in o&&"onreadystatechange"in o.document.createElement("script")?v=function(){var te=o.document.createElement("script");te.onreadystatechange=function(){ue(),te.onreadystatechange=null,te.parentNode.removeChild(te),te=null},o.document.documentElement.appendChild(te)}:v=function(){setTimeout(ue,0)};var w,R=[];function ue(){w=!0;for(var te,Z,me=R.length;me;){for(Z=R,R=[],te=-1;++te<me;)Z[te]();me=R.length}w=!1}i.exports=ve;function ve(te){R.push(te)===1&&!w&&v()}}).call(this,typeof kt<"u"?kt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(s,i,h){var o=s(1);function p(){}var v={},B=["REJECTED"],S=["FULFILLED"],F=["PENDING"];i.exports=k;function k(D){if(typeof D!="function")throw new TypeError("resolver must be a function");this.state=F,this.queue=[],this.outcome=void 0,D!==p&&ve(this,D)}k.prototype.catch=function(D){return this.then(null,D)},k.prototype.then=function(D,ee){if(typeof D!="function"&&this.state===S||typeof ee!="function"&&this.state===B)return this;var X=new this.constructor(p);if(this.state!==F){var Y=this.state===S?D:ee;R(X,Y,this.outcome)}else this.queue.push(new w(X,D,ee));return X};function w(D,ee,X){this.promise=D,typeof ee=="function"&&(this.onFulfilled=ee,this.callFulfilled=this.otherCallFulfilled),typeof X=="function"&&(this.onRejected=X,this.callRejected=this.otherCallRejected)}w.prototype.callFulfilled=function(D){v.resolve(this.promise,D)},w.prototype.otherCallFulfilled=function(D){R(this.promise,this.onFulfilled,D)},w.prototype.callRejected=function(D){v.reject(this.promise,D)},w.prototype.otherCallRejected=function(D){R(this.promise,this.onRejected,D)};function R(D,ee,X){o(function(){var Y;try{Y=ee(X)}catch(b){return v.reject(D,b)}Y===D?v.reject(D,new TypeError("Cannot resolve promise with itself")):v.resolve(D,Y)})}v.resolve=function(D,ee){var X=te(ue,ee);if(X.status==="error")return v.reject(D,X.value);var Y=X.value;if(Y)ve(D,Y);else{D.state=S,D.outcome=ee;for(var b=-1,he=D.queue.length;++b<he;)D.queue[b].callFulfilled(ee)}return D},v.reject=function(D,ee){D.state=B,D.outcome=ee;for(var X=-1,Y=D.queue.length;++X<Y;)D.queue[X].callRejected(ee);return D};function ue(D){var ee=D&&D.then;if(D&&(typeof D=="object"||typeof D=="function")&&typeof ee=="function")return function(){ee.apply(D,arguments)}}function ve(D,ee){var X=!1;function Y(Ne){X||(X=!0,v.reject(D,Ne))}function b(Ne){X||(X=!0,v.resolve(D,Ne))}function he(){ee(b,Y)}var Ie=te(he);Ie.status==="error"&&Y(Ie.value)}function te(D,ee){var X={};try{X.value=D(ee),X.status="success"}catch(Y){X.status="error",X.value=Y}return X}k.resolve=Z;function Z(D){return D instanceof this?D:v.resolve(new this(p),D)}k.reject=me;function me(D){var ee=new this(p);return v.reject(ee,D)}k.all=V;function V(D){var ee=this;if(Object.prototype.toString.call(D)!=="[object Array]")return this.reject(new TypeError("must be an array"));var X=D.length,Y=!1;if(!X)return this.resolve([]);for(var b=new Array(X),he=0,Ie=-1,Ne=new this(p);++Ie<X;)Oe(D[Ie],Ie);return Ne;function Oe(P,x){ee.resolve(P).then(H,function(oe){Y||(Y=!0,v.reject(Ne,oe))});function H(oe){b[x]=oe,++he===X&&!Y&&(Y=!0,v.resolve(Ne,b))}}}k.race=Q;function Q(D){var ee=this;if(Object.prototype.toString.call(D)!=="[object Array]")return this.reject(new TypeError("must be an array"));var X=D.length,Y=!1;if(!X)return this.resolve([]);for(var b=-1,he=new this(p);++b<X;)Ie(D[b]);return he;function Ie(Ne){ee.resolve(Ne).then(function(Oe){Y||(Y=!0,v.resolve(he,Oe))},function(Oe){Y||(Y=!0,v.reject(he,Oe))})}}},{1:1}],3:[function(s,i,h){(function(o){typeof o.Promise!="function"&&(o.Promise=s(2))}).call(this,typeof kt<"u"?kt:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(s,i,h){var o=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function p(t,c){if(!(t instanceof c))throw new TypeError("Cannot call a class as a function")}function v(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var B=v();function S(){try{if(!B||!B.open)return!1;var t=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),c=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!t||c)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function F(t,c){t=t||[],c=c||{};try{return new Blob(t,c)}catch(l){if(l.name!=="TypeError")throw l;for(var a=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,d=new a,f=0;f<t.length;f+=1)d.append(t[f]);return d.getBlob(c.type)}}typeof Promise>"u"&&s(3);var k=Promise;function w(t,c){c&&t.then(function(a){c(null,a)},function(a){c(a)})}function R(t,c,a){typeof c=="function"&&t.then(c),typeof a=="function"&&t.catch(a)}function ue(t){return typeof t!="string"&&(console.warn(t+" used as a key, but it is not a string."),t=String(t)),t}function ve(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var te="local-forage-detect-blob-support",Z=void 0,me={},V=Object.prototype.toString,Q="readonly",D="readwrite";function ee(t){for(var c=t.length,a=new ArrayBuffer(c),d=new Uint8Array(a),f=0;f<c;f++)d[f]=t.charCodeAt(f);return a}function X(t){return new k(function(c){var a=t.transaction(te,D),d=F([""]);a.objectStore(te).put(d,"key"),a.onabort=function(f){f.preventDefault(),f.stopPropagation(),c(!1)},a.oncomplete=function(){var f=navigator.userAgent.match(/Chrome\/(\d+)/),l=navigator.userAgent.match(/Edge\//);c(l||!f||parseInt(f[1],10)>=43)}}).catch(function(){return!1})}function Y(t){return typeof Z=="boolean"?k.resolve(Z):X(t).then(function(c){return Z=c,Z})}function b(t){var c=me[t.name],a={};a.promise=new k(function(d,f){a.resolve=d,a.reject=f}),c.deferredOperations.push(a),c.dbReady?c.dbReady=c.dbReady.then(function(){return a.promise}):c.dbReady=a.promise}function he(t){var c=me[t.name],a=c.deferredOperations.pop();if(a)return a.resolve(),a.promise}function Ie(t,c){var a=me[t.name],d=a.deferredOperations.pop();if(d)return d.reject(c),d.promise}function Ne(t,c){return new k(function(a,d){if(me[t.name]=me[t.name]||we(),t.db)if(c)b(t),t.db.close();else return a(t.db);var f=[t.name];c&&f.push(t.version);var l=B.open.apply(B,f);c&&(l.onupgradeneeded=function(I){var O=l.result;try{O.createObjectStore(t.storeName),I.oldVersion<=1&&O.createObjectStore(te)}catch(U){if(U.name==="ConstraintError")console.warn('The database "'+t.name+'" has been upgraded from version '+I.oldVersion+" to version "+I.newVersion+', but the storage "'+t.storeName+'" already exists.');else throw U}}),l.onerror=function(I){I.preventDefault(),d(l.error)},l.onsuccess=function(){var I=l.result;I.onversionchange=function(O){O.target.close()},a(I),he(t)}})}function Oe(t){return Ne(t,!1)}function P(t){return Ne(t,!0)}function x(t,c){if(!t.db)return!0;var a=!t.db.objectStoreNames.contains(t.storeName),d=t.version<t.db.version,f=t.version>t.db.version;if(d&&(t.version!==c&&console.warn('The database "'+t.name+`" can't be downgraded from version `+t.db.version+" to version "+t.version+"."),t.version=t.db.version),f||a){if(a){var l=t.db.version+1;l>t.version&&(t.version=l)}return!0}return!1}function H(t){return new k(function(c,a){var d=new FileReader;d.onerror=a,d.onloadend=function(f){var l=btoa(f.target.result||"");c({__local_forage_encoded_blob:!0,data:l,type:t.type})},d.readAsBinaryString(t)})}function oe(t){var c=ee(atob(t.data));return F([c],{type:t.type})}function ce(t){return t&&t.__local_forage_encoded_blob}function pe(t){var c=this,a=c._initReady().then(function(){var d=me[c._dbInfo.name];if(d&&d.dbReady)return d.dbReady});return R(a,t,t),a}function fe(t){b(t);for(var c=me[t.name],a=c.forages,d=0;d<a.length;d++){var f=a[d];f._dbInfo.db&&(f._dbInfo.db.close(),f._dbInfo.db=null)}return t.db=null,Oe(t).then(function(l){return t.db=l,x(t)?P(t):l}).then(function(l){t.db=c.db=l;for(var I=0;I<a.length;I++)a[I]._dbInfo.db=l}).catch(function(l){throw Ie(t,l),l})}function Se(t,c,a,d){d===void 0&&(d=1);try{var f=t.db.transaction(t.storeName,c);a(null,f)}catch(l){if(d>0&&(!t.db||l.name==="InvalidStateError"||l.name==="NotFoundError"))return k.resolve().then(function(){if(!t.db||l.name==="NotFoundError"&&!t.db.objectStoreNames.contains(t.storeName)&&t.version<=t.db.version)return t.db&&(t.version=t.db.version+1),P(t)}).then(function(){return fe(t).then(function(){Se(t,c,a,d-1)})}).catch(a);a(l)}}function we(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function re(t){var c=this,a={db:null};if(t)for(var d in t)a[d]=t[d];var f=me[a.name];f||(f=we(),me[a.name]=f),f.forages.push(c),c._initReady||(c._initReady=c.ready,c.ready=pe);var l=[];function I(){return k.resolve()}for(var O=0;O<f.forages.length;O++){var U=f.forages[O];U!==c&&l.push(U._initReady().catch(I))}var $=f.forages.slice(0);return k.all(l).then(function(){return a.db=f.db,Oe(a)}).then(function(z){return a.db=z,x(a,c._defaultConfig.version)?P(a):z}).then(function(z){a.db=f.db=z,c._dbInfo=a;for(var ae=0;ae<$.length;ae++){var ge=$[ae];ge!==c&&(ge._dbInfo.db=a.db,ge._dbInfo.version=a.version)}})}function Pe(t,c){var a=this;t=ue(t);var d=new k(function(f,l){a.ready().then(function(){Se(a._dbInfo,Q,function(I,O){if(I)return l(I);try{var U=O.objectStore(a._dbInfo.storeName),$=U.get(t);$.onsuccess=function(){var z=$.result;z===void 0&&(z=null),ce(z)&&(z=oe(z)),f(z)},$.onerror=function(){l($.error)}}catch(z){l(z)}})}).catch(l)});return w(d,c),d}function je(t,c){var a=this,d=new k(function(f,l){a.ready().then(function(){Se(a._dbInfo,Q,function(I,O){if(I)return l(I);try{var U=O.objectStore(a._dbInfo.storeName),$=U.openCursor(),z=1;$.onsuccess=function(){var ae=$.result;if(ae){var ge=ae.value;ce(ge)&&(ge=oe(ge));var ke=t(ge,ae.key,z++);ke!==void 0?f(ke):ae.continue()}else f()},$.onerror=function(){l($.error)}}catch(ae){l(ae)}})}).catch(l)});return w(d,c),d}function C(t,c,a){var d=this;t=ue(t);var f=new k(function(l,I){var O;d.ready().then(function(){return O=d._dbInfo,V.call(c)==="[object Blob]"?Y(O.db).then(function(U){return U?c:H(c)}):c}).then(function(U){Se(d._dbInfo,D,function($,z){if($)return I($);try{var ae=z.objectStore(d._dbInfo.storeName);U===null&&(U=void 0);var ge=ae.put(U,t);z.oncomplete=function(){U===void 0&&(U=null),l(U)},z.onabort=z.onerror=function(){var ke=ge.error?ge.error:ge.transaction.error;I(ke)}}catch(ke){I(ke)}})}).catch(I)});return w(f,a),f}function J(t,c){var a=this;t=ue(t);var d=new k(function(f,l){a.ready().then(function(){Se(a._dbInfo,D,function(I,O){if(I)return l(I);try{var U=O.objectStore(a._dbInfo.storeName),$=U.delete(t);O.oncomplete=function(){f()},O.onerror=function(){l($.error)},O.onabort=function(){var z=$.error?$.error:$.transaction.error;l(z)}}catch(z){l(z)}})}).catch(l)});return w(d,c),d}function ie(t){var c=this,a=new k(function(d,f){c.ready().then(function(){Se(c._dbInfo,D,function(l,I){if(l)return f(l);try{var O=I.objectStore(c._dbInfo.storeName),U=O.clear();I.oncomplete=function(){d()},I.onabort=I.onerror=function(){var $=U.error?U.error:U.transaction.error;f($)}}catch($){f($)}})}).catch(f)});return w(a,t),a}function le(t){var c=this,a=new k(function(d,f){c.ready().then(function(){Se(c._dbInfo,Q,function(l,I){if(l)return f(l);try{var O=I.objectStore(c._dbInfo.storeName),U=O.count();U.onsuccess=function(){d(U.result)},U.onerror=function(){f(U.error)}}catch($){f($)}})}).catch(f)});return w(a,t),a}function be(t,c){var a=this,d=new k(function(f,l){if(t<0){f(null);return}a.ready().then(function(){Se(a._dbInfo,Q,function(I,O){if(I)return l(I);try{var U=O.objectStore(a._dbInfo.storeName),$=!1,z=U.openKeyCursor();z.onsuccess=function(){var ae=z.result;if(!ae){f(null);return}t===0||$?f(ae.key):($=!0,ae.advance(t))},z.onerror=function(){l(z.error)}}catch(ae){l(ae)}})}).catch(l)});return w(d,c),d}function ne(t){var c=this,a=new k(function(d,f){c.ready().then(function(){Se(c._dbInfo,Q,function(l,I){if(l)return f(l);try{var O=I.objectStore(c._dbInfo.storeName),U=O.openKeyCursor(),$=[];U.onsuccess=function(){var z=U.result;if(!z){d($);return}$.push(z.key),z.continue()},U.onerror=function(){f(U.error)}}catch(z){f(z)}})}).catch(f)});return w(a,t),a}function Te(t,c){c=ve.apply(this,arguments);var a=this.config();t=typeof t!="function"&&t||{},t.name||(t.name=t.name||a.name,t.storeName=t.storeName||a.storeName);var d=this,f;if(!t.name)f=k.reject("Invalid arguments");else{var l=t.name===a.name&&d._dbInfo.db,I=l?k.resolve(d._dbInfo.db):Oe(t).then(function(O){var U=me[t.name],$=U.forages;U.db=O;for(var z=0;z<$.length;z++)$[z]._dbInfo.db=O;return O});t.storeName?f=I.then(function(O){if(O.objectStoreNames.contains(t.storeName)){var U=O.version+1;b(t);var $=me[t.name],z=$.forages;O.close();for(var ae=0;ae<z.length;ae++){var ge=z[ae];ge._dbInfo.db=null,ge._dbInfo.version=U}var ke=new k(function(xe,De){var _e=B.open(t.name,U);_e.onerror=function(Ge){var wt=_e.result;wt.close(),De(Ge)},_e.onupgradeneeded=function(){var Ge=_e.result;Ge.deleteObjectStore(t.storeName)},_e.onsuccess=function(){var Ge=_e.result;Ge.close(),xe(Ge)}});return ke.then(function(xe){$.db=xe;for(var De=0;De<z.length;De++){var _e=z[De];_e._dbInfo.db=xe,he(_e._dbInfo)}}).catch(function(xe){throw(Ie(t,xe)||k.resolve()).catch(function(){}),xe})}}):f=I.then(function(O){b(t);var U=me[t.name],$=U.forages;O.close();for(var z=0;z<$.length;z++){var ae=$[z];ae._dbInfo.db=null}var ge=new k(function(ke,xe){var De=B.deleteDatabase(t.name);De.onerror=function(){var _e=De.result;_e&&_e.close(),xe(De.error)},De.onblocked=function(){console.warn('dropInstance blocked for database "'+t.name+'" until all open connections are closed')},De.onsuccess=function(){var _e=De.result;_e&&_e.close(),ke(_e)}});return ge.then(function(ke){U.db=ke;for(var xe=0;xe<$.length;xe++){var De=$[xe];he(De._dbInfo)}}).catch(function(ke){throw(Ie(t,ke)||k.resolve()).catch(function(){}),ke})})}return w(f,c),f}var Ve={_driver:"asyncStorage",_initStorage:re,_support:S(),iterate:je,getItem:Pe,setItem:C,removeItem:J,clear:ie,length:le,key:be,keys:ne,dropInstance:Te};function Be(){return typeof openDatabase=="function"}var Fe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",st="~~local_forage_type~",Ke=/^~~local_forage_type~([^~]+)~/,Ce="__lfsc__:",at=Ce.length,et="arbf",Je="blob",it="si08",ct="ui08",lt="uic8",m="si16",r="si32",_="ur16",y="ui32",g="fl32",u="fl64",L=at+et.length,G=Object.prototype.toString;function A(t){var c=t.length*.75,a=t.length,d,f=0,l,I,O,U;t[t.length-1]==="="&&(c--,t[t.length-2]==="="&&c--);var $=new ArrayBuffer(c),z=new Uint8Array($);for(d=0;d<a;d+=4)l=Fe.indexOf(t[d]),I=Fe.indexOf(t[d+1]),O=Fe.indexOf(t[d+2]),U=Fe.indexOf(t[d+3]),z[f++]=l<<2|I>>4,z[f++]=(I&15)<<4|O>>2,z[f++]=(O&3)<<6|U&63;return $}function j(t){var c=new Uint8Array(t),a="",d;for(d=0;d<c.length;d+=3)a+=Fe[c[d]>>2],a+=Fe[(c[d]&3)<<4|c[d+1]>>4],a+=Fe[(c[d+1]&15)<<2|c[d+2]>>6],a+=Fe[c[d+2]&63];return c.length%3===2?a=a.substring(0,a.length-1)+"=":c.length%3===1&&(a=a.substring(0,a.length-2)+"=="),a}function M(t,c){var a="";if(t&&(a=G.call(t)),t&&(a==="[object ArrayBuffer]"||t.buffer&&G.call(t.buffer)==="[object ArrayBuffer]")){var d,f=Ce;t instanceof ArrayBuffer?(d=t,f+=et):(d=t.buffer,a==="[object Int8Array]"?f+=it:a==="[object Uint8Array]"?f+=ct:a==="[object Uint8ClampedArray]"?f+=lt:a==="[object Int16Array]"?f+=m:a==="[object Uint16Array]"?f+=_:a==="[object Int32Array]"?f+=r:a==="[object Uint32Array]"?f+=y:a==="[object Float32Array]"?f+=g:a==="[object Float64Array]"?f+=u:c(new Error("Failed to get type for BinaryArray"))),c(f+j(d))}else if(a==="[object Blob]"){var l=new FileReader;l.onload=function(){var I=st+t.type+"~"+j(this.result);c(Ce+Je+I)},l.readAsArrayBuffer(t)}else try{c(JSON.stringify(t))}catch(I){console.error("Couldn't convert value into a JSON string: ",t),c(null,I)}}function q(t){if(t.substring(0,at)!==Ce)return JSON.parse(t);var c=t.substring(L),a=t.substring(at,L),d;if(a===Je&&Ke.test(c)){var f=c.match(Ke);d=f[1],c=c.substring(f[0].length)}var l=A(c);switch(a){case et:return l;case Je:return F([l],{type:d});case it:return new Int8Array(l);case ct:return new Uint8Array(l);case lt:return new Uint8ClampedArray(l);case m:return new Int16Array(l);case _:return new Uint16Array(l);case r:return new Int32Array(l);case y:return new Uint32Array(l);case g:return new Float32Array(l);case u:return new Float64Array(l);default:throw new Error("Unkown type: "+a)}}var E={serialize:M,deserialize:q,stringToBuffer:A,bufferToString:j};function se(t,c,a,d){t.executeSql("CREATE TABLE IF NOT EXISTS "+c.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],a,d)}function W(t){var c=this,a={db:null};if(t)for(var d in t)a[d]=typeof t[d]!="string"?t[d].toString():t[d];var f=new k(function(l,I){try{a.db=openDatabase(a.name,String(a.version),a.description,a.size)}catch(O){return I(O)}a.db.transaction(function(O){se(O,a,function(){c._dbInfo=a,l()},function(U,$){I($)})},I)});return a.serializer=E,f}function N(t,c,a,d,f,l){t.executeSql(a,d,f,function(I,O){O.code===O.SYNTAX_ERR?I.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[c.storeName],function(U,$){$.rows.length?l(U,O):se(U,c,function(){U.executeSql(a,d,f,l)},l)},l):l(I,O)},l)}function T(t,c){var a=this;t=ue(t);var d=new k(function(f,l){a.ready().then(function(){var I=a._dbInfo;I.db.transaction(function(O){N(O,I,"SELECT * FROM "+I.storeName+" WHERE key = ? LIMIT 1",[t],function(U,$){var z=$.rows.length?$.rows.item(0).value:null;z&&(z=I.serializer.deserialize(z)),f(z)},function(U,$){l($)})})}).catch(l)});return w(d,c),d}function ye(t,c){var a=this,d=new k(function(f,l){a.ready().then(function(){var I=a._dbInfo;I.db.transaction(function(O){N(O,I,"SELECT * FROM "+I.storeName,[],function(U,$){for(var z=$.rows,ae=z.length,ge=0;ge<ae;ge++){var ke=z.item(ge),xe=ke.value;if(xe&&(xe=I.serializer.deserialize(xe)),xe=t(xe,ke.key,ge+1),xe!==void 0){f(xe);return}}f()},function(U,$){l($)})})}).catch(l)});return w(d,c),d}function Ee(t,c,a,d){var f=this;t=ue(t);var l=new k(function(I,O){f.ready().then(function(){c===void 0&&(c=null);var U=c,$=f._dbInfo;$.serializer.serialize(c,function(z,ae){ae?O(ae):$.db.transaction(function(ge){N(ge,$,"INSERT OR REPLACE INTO "+$.storeName+" (key, value) VALUES (?, ?)",[t,z],function(){I(U)},function(ke,xe){O(xe)})},function(ge){if(ge.code===ge.QUOTA_ERR){if(d>0){I(Ee.apply(f,[t,U,a,d-1]));return}O(ge)}})})}).catch(O)});return w(l,a),l}function Le(t,c,a){return Ee.apply(this,[t,c,a,1])}function ze(t,c){var a=this;t=ue(t);var d=new k(function(f,l){a.ready().then(function(){var I=a._dbInfo;I.db.transaction(function(O){N(O,I,"DELETE FROM "+I.storeName+" WHERE key = ?",[t],function(){f()},function(U,$){l($)})})}).catch(l)});return w(d,c),d}function yt(t){var c=this,a=new k(function(d,f){c.ready().then(function(){var l=c._dbInfo;l.db.transaction(function(I){N(I,l,"DELETE FROM "+l.storeName,[],function(){d()},function(O,U){f(U)})})}).catch(f)});return w(a,t),a}function tt(t){var c=this,a=new k(function(d,f){c.ready().then(function(){var l=c._dbInfo;l.db.transaction(function(I){N(I,l,"SELECT COUNT(key) as c FROM "+l.storeName,[],function(O,U){var $=U.rows.item(0).c;d($)},function(O,U){f(U)})})}).catch(f)});return w(a,t),a}function Xe(t,c){var a=this,d=new k(function(f,l){a.ready().then(function(){var I=a._dbInfo;I.db.transaction(function(O){N(O,I,"SELECT key FROM "+I.storeName+" WHERE id = ? LIMIT 1",[t+1],function(U,$){var z=$.rows.length?$.rows.item(0).key:null;f(z)},function(U,$){l($)})})}).catch(l)});return w(d,c),d}function Re(t){var c=this,a=new k(function(d,f){c.ready().then(function(){var l=c._dbInfo;l.db.transaction(function(I){N(I,l,"SELECT key FROM "+l.storeName,[],function(O,U){for(var $=[],z=0;z<U.rows.length;z++)$.push(U.rows.item(z).key);d($)},function(O,U){f(U)})})}).catch(f)});return w(a,t),a}function Rt(t){return new k(function(c,a){t.transaction(function(d){d.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(f,l){for(var I=[],O=0;O<l.rows.length;O++)I.push(l.rows.item(O).name);c({db:t,storeNames:I})},function(f,l){a(l)})},function(d){a(d)})})}function bt(t,c){c=ve.apply(this,arguments);var a=this.config();t=typeof t!="function"&&t||{},t.name||(t.name=t.name||a.name,t.storeName=t.storeName||a.storeName);var d=this,f;return t.name?f=new k(function(l){var I;t.name===a.name?I=d._dbInfo.db:I=openDatabase(t.name,"","",0),t.storeName?l({db:I,storeNames:[t.storeName]}):l(Rt(I))}).then(function(l){return new k(function(I,O){l.db.transaction(function(U){function $(ke){return new k(function(xe,De){U.executeSql("DROP TABLE IF EXISTS "+ke,[],function(){xe()},function(_e,Ge){De(Ge)})})}for(var z=[],ae=0,ge=l.storeNames.length;ae<ge;ae++)z.push($(l.storeNames[ae]));k.all(z).then(function(){I()}).catch(function(ke){O(ke)})},function(U){O(U)})})}):f=k.reject("Invalid arguments"),w(f,c),f}var Me={_driver:"webSQLStorage",_initStorage:W,_support:Be(),iterate:ye,getItem:T,setItem:Le,removeItem:ze,clear:yt,length:tt,key:Xe,keys:Re,dropInstance:bt};function ft(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function Ct(t,c){var a=t.name+"/";return t.storeName!==c.storeName&&(a+=t.storeName+"/"),a}function Et(){var t="_localforage_support_test";try{return localStorage.setItem(t,!0),localStorage.removeItem(t),!1}catch{return!0}}function Ye(){return!Et()||localStorage.length>0}function It(t){var c=this,a={};if(t)for(var d in t)a[d]=t[d];return a.keyPrefix=Ct(t,c._defaultConfig),Ye()?(c._dbInfo=a,a.serializer=E,k.resolve()):k.reject()}function de(t){var c=this,a=c.ready().then(function(){for(var d=c._dbInfo.keyPrefix,f=localStorage.length-1;f>=0;f--){var l=localStorage.key(f);l.indexOf(d)===0&&localStorage.removeItem(l)}});return w(a,t),a}function We(t,c){var a=this;t=ue(t);var d=a.ready().then(function(){var f=a._dbInfo,l=localStorage.getItem(f.keyPrefix+t);return l&&(l=f.serializer.deserialize(l)),l});return w(d,c),d}function qe(t,c){var a=this,d=a.ready().then(function(){for(var f=a._dbInfo,l=f.keyPrefix,I=l.length,O=localStorage.length,U=1,$=0;$<O;$++){var z=localStorage.key($);if(z.indexOf(l)===0){var ae=localStorage.getItem(z);if(ae&&(ae=f.serializer.deserialize(ae)),ae=t(ae,z.substring(I),U++),ae!==void 0)return ae}}});return w(d,c),d}function Ae(t,c){var a=this,d=a.ready().then(function(){var f=a._dbInfo,l;try{l=localStorage.key(t)}catch{l=null}return l&&(l=l.substring(f.keyPrefix.length)),l});return w(d,c),d}function Ue(t){var c=this,a=c.ready().then(function(){for(var d=c._dbInfo,f=localStorage.length,l=[],I=0;I<f;I++){var O=localStorage.key(I);O.indexOf(d.keyPrefix)===0&&l.push(O.substring(d.keyPrefix.length))}return l});return w(a,t),a}function Qe(t){var c=this,a=c.keys().then(function(d){return d.length});return w(a,t),a}function ot(t,c){var a=this;t=ue(t);var d=a.ready().then(function(){var f=a._dbInfo;localStorage.removeItem(f.keyPrefix+t)});return w(d,c),d}function ht(t,c,a){var d=this;t=ue(t);var f=d.ready().then(function(){c===void 0&&(c=null);var l=c;return new k(function(I,O){var U=d._dbInfo;U.serializer.serialize(c,function($,z){if(z)O(z);else try{localStorage.setItem(U.keyPrefix+t,$),I(l)}catch(ae){(ae.name==="QuotaExceededError"||ae.name==="NS_ERROR_DOM_QUOTA_REACHED")&&O(ae),O(ae)}})})});return w(f,a),f}function Hn(t,c){if(c=ve.apply(this,arguments),t=typeof t!="function"&&t||{},!t.name){var a=this.config();t.name=t.name||a.name,t.storeName=t.storeName||a.storeName}var d=this,f;return t.name?f=new k(function(l){t.storeName?l(Ct(t,d._defaultConfig)):l(t.name+"/")}).then(function(l){for(var I=localStorage.length-1;I>=0;I--){var O=localStorage.key(I);O.indexOf(l)===0&&localStorage.removeItem(O)}}):f=k.reject("Invalid arguments"),w(f,c),f}var qn={_driver:"localStorageWrapper",_initStorage:It,_support:ft(),iterate:qe,getItem:We,setItem:ht,removeItem:ot,clear:de,length:Qe,key:Ae,keys:Ue,dropInstance:Hn},Gn=function(c,a){return c===a||typeof c=="number"&&typeof a=="number"&&isNaN(c)&&isNaN(a)},Kn=function(c,a){for(var d=c.length,f=0;f<d;){if(Gn(c[f],a))return!0;f++}return!1},dn=Array.isArray||function(t){return Object.prototype.toString.call(t)==="[object Array]"},St={},fn={},mt={INDEXEDDB:Ve,WEBSQL:Me,LOCALSTORAGE:qn},Xn=[mt.INDEXEDDB._driver,mt.WEBSQL._driver,mt.LOCALSTORAGE._driver],At=["dropInstance"],Ut=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(At),Jn={description:"",driver:Xn.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Qn(t,c){t[c]=function(){var a=arguments;return t.ready().then(function(){return t[c].apply(t,a)})}}function $t(){for(var t=1;t<arguments.length;t++){var c=arguments[t];if(c)for(var a in c)c.hasOwnProperty(a)&&(dn(c[a])?arguments[0][a]=c[a].slice():arguments[0][a]=c[a])}return arguments[0]}var Zn=function(){function t(c){p(this,t);for(var a in mt)if(mt.hasOwnProperty(a)){var d=mt[a],f=d._driver;this[a]=f,St[f]||this.defineDriver(d)}this._defaultConfig=$t({},Jn),this._config=$t({},this._defaultConfig,c),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return t.prototype.config=function(a){if((typeof a>"u"?"undefined":o(a))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var d in a){if(d==="storeName"&&(a[d]=a[d].replace(/\W/g,"_")),d==="version"&&typeof a[d]!="number")return new Error("Database version must be a number.");this._config[d]=a[d]}return"driver"in a&&a.driver?this.setDriver(this._config.driver):!0}else return typeof a=="string"?this._config[a]:this._config},t.prototype.defineDriver=function(a,d,f){var l=new k(function(I,O){try{var U=a._driver,$=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!a._driver){O($);return}for(var z=Ut.concat("_initStorage"),ae=0,ge=z.length;ae<ge;ae++){var ke=z[ae],xe=!Kn(At,ke);if((xe||a[ke])&&typeof a[ke]!="function"){O($);return}}var De=function(){for(var wt=function(nr){return function(){var rr=new Error("Method "+nr+" is not implemented by the current driver"),hn=k.reject(rr);return w(hn,arguments[arguments.length-1]),hn}},Ft=0,tr=At.length;Ft<tr;Ft++){var Wt=At[Ft];a[Wt]||(a[Wt]=wt(Wt))}};De();var _e=function(wt){St[U]&&console.info("Redefining LocalForage driver: "+U),St[U]=a,fn[U]=wt,I()};"_support"in a?a._support&&typeof a._support=="function"?a._support().then(_e,O):_e(!!a._support):_e(!0)}catch(Ge){O(Ge)}});return R(l,d,f),l},t.prototype.driver=function(){return this._driver||null},t.prototype.getDriver=function(a,d,f){var l=St[a]?k.resolve(St[a]):k.reject(new Error("Driver not found."));return R(l,d,f),l},t.prototype.getSerializer=function(a){var d=k.resolve(E);return R(d,a),d},t.prototype.ready=function(a){var d=this,f=d._driverSet.then(function(){return d._ready===null&&(d._ready=d._initDriver()),d._ready});return R(f,a,a),f},t.prototype.setDriver=function(a,d,f){var l=this;dn(a)||(a=[a]);var I=this._getSupportedDrivers(a);function O(){l._config.driver=l.driver()}function U(ae){return l._extend(ae),O(),l._ready=l._initStorage(l._config),l._ready}function $(ae){return function(){var ge=0;function ke(){for(;ge<ae.length;){var xe=ae[ge];return ge++,l._dbInfo=null,l._ready=null,l.getDriver(xe).then(U).catch(ke)}O();var De=new Error("No available storage method found.");return l._driverSet=k.reject(De),l._driverSet}return ke()}}var z=this._driverSet!==null?this._driverSet.catch(function(){return k.resolve()}):k.resolve();return this._driverSet=z.then(function(){var ae=I[0];return l._dbInfo=null,l._ready=null,l.getDriver(ae).then(function(ge){l._driver=ge._driver,O(),l._wrapLibraryMethodsWithReady(),l._initDriver=$(I)})}).catch(function(){O();var ae=new Error("No available storage method found.");return l._driverSet=k.reject(ae),l._driverSet}),R(this._driverSet,d,f),this._driverSet},t.prototype.supports=function(a){return!!fn[a]},t.prototype._extend=function(a){$t(this,a)},t.prototype._getSupportedDrivers=function(a){for(var d=[],f=0,l=a.length;f<l;f++){var I=a[f];this.supports(I)&&d.push(I)}return d},t.prototype._wrapLibraryMethodsWithReady=function(){for(var a=0,d=Ut.length;a<d;a++)Qn(this,Ut[a])},t.prototype.createInstance=function(a){return new t(a)},t}(),er=new Zn;i.exports=er},{3:3}]},{},[4])(4)})})(Cn);var sr=Cn.exports;const Vt=or(sr);function Dt(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function zt(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const ir=1,cr=1,dt="emoji",vt="keyvalue",an="favorites",lr="tokens",In="tokens",ur="unicode",An="count",dr="group",fr="order",_n="group-order",Qt="eTag",Pt="url",vn="skinTone",gt="readonly",on="readwrite",Dn="skinUnicodes",hr="skinUnicodes",mr="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",pr="en";function vr(n,e){const s=new Set,i=[];for(const h of n){const o=e(h);s.has(o)||(s.add(o),i.push(h))}return i}function gn(n){return vr(n,e=>e.unicode)}function gr(n){function e(s,i,h){const o=i?n.createObjectStore(s,{keyPath:i}):n.createObjectStore(s);if(h)for(const[p,[v,B]]of Object.entries(h))o.createIndex(p,v,{multiEntry:B});return o}e(vt),e(dt,ur,{[In]:[lr,!0],[_n]:[[dr,fr]],[Dn]:[hr,!0]}),e(an,void 0,{[An]:[""]})}const Zt={},Mt={},jt={};function Nn(n,e,s){s.onerror=()=>e(s.error),s.onblocked=()=>e(new Error("IDB blocked")),s.onsuccess=()=>n(s.result)}async function yr(n){const e=await new Promise((s,i)=>{const h=indexedDB.open(n,ir);Zt[n]=h,h.onupgradeneeded=o=>{o.oldVersion<cr&&gr(h.result)},Nn(s,i,h)});return e.onclose=()=>sn(n),e}function br(n){return Mt[n]||(Mt[n]=yr(n)),Mt[n]}function rt(n,e,s,i){return new Promise((h,o)=>{const p=n.transaction(e,s,{durability:"relaxed"}),v=typeof e=="string"?p.objectStore(e):e.map(S=>p.objectStore(S));let B;i(v,p,S=>{B=S}),p.oncomplete=()=>h(B),p.onerror=()=>o(p.error)})}function sn(n){const e=Zt[n],s=e&&e.result;if(s){s.close();const i=jt[n];if(i)for(const h of i)h()}delete Zt[n],delete Mt[n],delete jt[n]}function Er(n){return new Promise((e,s)=>{sn(n);const i=indexedDB.deleteDatabase(n);Nn(e,s,i)})}function Sr(n,e){let s=jt[n];s||(s=jt[n]=[]),s.push(e)}const wr=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function pt(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||wr.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const Tr=2;function Ln(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Tr)}function kr(n){return n.map(({annotation:s,emoticon:i,group:h,order:o,shortcodes:p,skins:v,tags:B,emoji:S,version:F})=>{const k=[...new Set(Ln([...(p||[]).map(pt).flat(),...B.map(pt).flat(),...pt(s),i]))].sort(),w={annotation:s,group:h,order:o,tags:B,tokens:k,unicode:S,version:F};if(i&&(w.emoticon=i),p&&(w.shortcodes=p),v){w.skinTones=[],w.skinUnicodes=[],w.skinVersions=[];for(const{tone:R,emoji:ue,version:ve}of v)w.skinTones.push(R),w.skinUnicodes.push(ue),w.skinVersions.push(ve)}return w})}function Mn(n,e,s,i){n[e](s).onsuccess=h=>i&&i(h.target.result)}function ut(n,e,s){Mn(n,"get",e,s)}function On(n,e,s){Mn(n,"getAll",e,s)}function cn(n){n.commit&&n.commit()}function xr(n,e){let s=n[0];for(let i=1;i<n.length;i++){const h=n[i];e(s)>e(h)&&(s=h)}return s}function Pn(n,e){const s=xr(n,h=>h.length),i=[];for(const h of s)n.some(o=>o.findIndex(p=>e(p)===e(h))===-1)||i.push(h);return i}async function Cr(n){return!await ln(n,vt,Pt)}async function Ir(n,e,s){const[i,h]=await Promise.all([Qt,Pt].map(o=>ln(n,vt,o)));return i===s&&h===e}async function Ar(n,e){return rt(n,dt,gt,(i,h,o)=>{let p;const v=()=>{i.getAll(p&&IDBKeyRange.lowerBound(p,!0),50).onsuccess=B=>{const S=B.target.result;for(const F of S)if(p=F.unicode,e(F))return o(F);if(S.length<50)return o();v()}};v()})}async function jn(n,e,s,i){try{const h=kr(e);await rt(n,[dt,vt],on,([o,p],v)=>{let B,S,F=0;function k(){++F===2&&w()}function w(){if(!(B===i&&S===s)){o.clear();for(const R of h)o.put(R);p.put(i,Qt),p.put(s,Pt),cn(v)}}ut(p,Qt,R=>{B=R,k()}),ut(p,Pt,R=>{S=R,k()})})}finally{}}async function _r(n,e){return rt(n,dt,gt,(s,i,h)=>{const o=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);On(s.index(_n),o,h)})}async function Bn(n,e){const s=Ln(pt(e));return s.length?rt(n,dt,gt,(i,h,o)=>{const p=[],v=()=>{p.length===s.length&&B()},B=()=>{const S=Pn(p,F=>F.unicode);o(S.sort((F,k)=>F.order<k.order?-1:1))};for(let S=0;S<s.length;S++){const F=s[S],k=S===s.length-1?IDBKeyRange.bound(F,F+"￿",!1,!0):IDBKeyRange.only(F);On(i.index(In),k,w=>{p.push(w),v()})}}):[]}async function Dr(n,e){const s=await Bn(n,e);return s.length?s.filter(i=>(i.shortcodes||[]).map(o=>o.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Ar(n,h=>(h.shortcodes||[]).includes(e.toLowerCase()))||null}async function Nr(n,e){return rt(n,dt,gt,(s,i,h)=>ut(s,e,o=>{if(o)return h(o);ut(s.index(Dn),e,p=>h(p||null))}))}function ln(n,e,s){return rt(n,e,gt,(i,h,o)=>ut(i,s,o))}function Lr(n,e,s,i){return rt(n,e,on,(h,o)=>{h.put(i,s),cn(o)})}function Mr(n,e){return rt(n,an,on,(s,i)=>ut(s,e,h=>{s.put((h||0)+1,e),cn(i)}))}function Or(n,e,s){return s===0?[]:rt(n,[an,dt],gt,([i,h],o,p)=>{const v=[];i.index(An).openCursor(void 0,"prev").onsuccess=B=>{const S=B.target.result;if(!S)return p(v);function F(R){if(v.push(R),v.length===s)return p(v);S.continue()}const k=S.primaryKey,w=e.byName(k);if(w)return F(w);ut(h,k,R=>{if(R)return F(R);S.continue()})}})}const Nt="";function Pr(n,e){const s=new Map;for(const h of n){const o=e(h);for(const p of o){let v=s;for(let S=0;S<p.length;S++){const F=p.charAt(S);let k=v.get(F);k||(k=new Map,v.set(F,k)),v=k}let B=v.get(Nt);B||(B=[],v.set(Nt,B)),B.push(h)}}return(h,o)=>{let p=s;for(let S=0;S<h.length;S++){const F=h.charAt(S),k=p.get(F);if(k)p=k;else return[]}if(o)return p.get(Nt)||[];const v=[],B=[p];for(;B.length;){const F=[...B.shift().entries()].sort((k,w)=>k[0]<w[0]?-1:1);for(const[k,w]of F)k===Nt?v.push(...w):B.push(w)}return v}}const jr=["name","url"];function Br(n){const e=n&&Array.isArray(n),s=e&&n.length&&(!n[0]||jr.some(i=>!(i in n[0])));if(!e||s)throw new Error("Custom emojis are in the wrong format")}function yn(n){Br(n);const e=(w,R)=>w.name.toLowerCase()<R.name.toLowerCase()?-1:1,s=n.sort(e),h=Pr(n,w=>[...new Set((w.shortcodes||[]).map(R=>pt(R)).flat())]),o=w=>h(w,!0),p=w=>h(w,!1),v=w=>{const R=pt(w),ue=R.map((ve,te)=>(te<R.length-1?o:p)(ve));return Pn(ue,ve=>ve.name).sort(e)},B=new Map,S=new Map;for(const w of n){S.set(w.name.toLowerCase(),w);for(const R of w.shortcodes||[])B.set(R.toLowerCase(),w)}return{all:s,search:v,byShortcode:w=>B.get(w.toLowerCase()),byName:w=>S.get(w.toLowerCase())}}const Rr=typeof wrappedJSObject<"u";function Tt(n){if(!n)return n;if(Rr&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let s=0;s<e;s++)n.skins[s]={tone:n.skinTones[s],unicode:n.skinUnicodes[s],version:n.skinVersions[s]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function Rn(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const Ur=["annotation","emoji","group","order","tags","version"];function $r(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||Ur.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function Un(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function Fr(n){const e=await fetch(n,{method:"HEAD"});Un(e,n);const s=e.headers.get("etag");return Rn(s),s}async function en(n){const e=await fetch(n);Un(e,n);const s=e.headers.get("etag");Rn(s);const i=await e.json();return $r(i),[s,i]}function Wr(n){for(var e="",s=new Uint8Array(n),i=s.byteLength,h=-1;++h<i;)e+=String.fromCharCode(s[h]);return e}function Vr(n){for(var e=n.length,s=new ArrayBuffer(e),i=new Uint8Array(s),h=-1;++h<e;)i[h]=n.charCodeAt(h);return s}async function $n(n){const e=JSON.stringify(n);let s=Vr(e);const i=await crypto.subtle.digest("SHA-1",s),h=Wr(i);return btoa(h)}async function zr(n,e){let s,i=await Fr(e);if(!i){const h=await en(e);i=h[0],s=h[1],i||(i=await $n(s))}await Ir(n,e,i)||(s||(s=(await en(e))[1]),await jn(n,s,e,i))}async function Yr(n,e){let[s,i]=await en(e);s||(s=await $n(i)),await jn(n,i,e,s)}class Hr{constructor({dataSource:e=mr,locale:s=pr,customEmoji:i=[]}={}){this.dataSource=e,this.locale=s,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=yn(i),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await br(this._dbName);Sr(this._dbName,this._clear);const s=this.dataSource;await Cr(e)?await Yr(e,s):this._lazyUpdate=zr(e,s)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return zt(e),await this.ready(),gn(await _r(this._db,e)).map(Tt)}async getEmojiBySearchQuery(e){Dt(e),await this.ready();const s=this._custom.search(e),i=gn(await Bn(this._db,e)).map(Tt);return[...s,...i]}async getEmojiByShortcode(e){Dt(e),await this.ready();const s=this._custom.byShortcode(e);return s||Tt(await Dr(this._db,e))}async getEmojiByUnicodeOrName(e){Dt(e),await this.ready();const s=this._custom.byName(e);return s||Tt(await Nr(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await ln(this._db,vt,vn)||0}async setPreferredSkinTone(e){return zt(e),await this.ready(),Lr(this._db,vt,vn,e)}async incrementFavoriteEmojiCount(e){return Dt(e),await this.ready(),Mr(this._db,e)}async getTopFavoriteEmoji(e){return zt(e),await this.ready(),(await Or(this._db,this._custom,e)).map(Tt)}set customEmoji(e){this._custom=yn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await sn(this._dbName)}async delete(){await this._shutdown(),await Er(this._dbName)}}const tn=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([n,e,s])=>({id:n,emoji:e,name:s})),Yt=tn.slice(1),qr=2,bn=6,Fn=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function En(n){return n.unicode.includes("‍")}const Gr={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},Kr=1e3,Xr="🖐️",Jr=8,Qr=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],Wn='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',Zr=(n,e)=>n<e?-1:n>e?1:0,Sn=(n,e)=>{const s=document.createElement("canvas");s.width=s.height=1;const i=s.getContext("2d");return i.textBaseline="top",i.font=`100px ${Wn}`,i.fillStyle=e,i.scale(.01,.01),i.fillText(n,0,0),i.getImageData(0,0,1,1).data},ea=(n,e)=>{const s=[...n].join(","),i=[...e].join(",");return s===i&&!s.startsWith("0,0,0,")};function ta(n){const e=Sn(n,"#000"),s=Sn(n,"#fff");return e&&s&&ea(e,s)}function na(){const n=Object.entries(Gr);try{for(const[e,s]of n)if(ta(e))return s}catch{}finally{}return n[0][1]}let Ht;const qt=()=>(Ht||(Ht=new Promise(n=>Fn(()=>n(na())))),Ht),nn=new Map,ra="️",aa="\uD83C",oa="‍",sa=127995,ia=57339;function ca(n,e){if(e===0)return n;const s=n.indexOf(oa);return s!==-1?n.substring(0,s)+String.fromCodePoint(sa+e-1)+n.substring(s):(n.endsWith(ra)&&(n=n.substring(0,n.length-1)),n+aa+String.fromCodePoint(ia+e-1))}function Ze(n){n.preventDefault(),n.stopPropagation()}function Gt(n,e,s){return e+=n?-1:1,e<0?e=s.length-1:e>=s.length&&(e=0),e}function Vn(n,e){const s=new Set,i=[];for(const h of n){const o=e(h);s.has(o)||(s.add(o),i.push(h))}return i}function la(n,e){const s=i=>{const h={};for(const o of i)typeof o.tone=="number"&&o.version<=e&&(h[o.tone]=o.unicode);return h};return n.map(({unicode:i,skins:h,shortcodes:o,url:p,name:v,category:B,annotation:S})=>({unicode:i,name:v,shortcodes:o,url:p,category:B,annotation:S,id:i||v,skins:h&&s(h)}))}const Ot=requestAnimationFrame;let ua=typeof ResizeObserver=="function";function da(n,e,s){let i;ua?(i=new ResizeObserver(h=>s(h[0].contentRect.width)),i.observe(n)):Ot(()=>s(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{i&&i.disconnect()})}function wn(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let Kt;function fa(n,e,s){for(const i of n){const h=s(i),o=wn(h);typeof Kt>"u"&&(Kt=wn(e));const p=o/1.8<Kt;nn.set(i.unicode,p)}}function ha(n){return Vn(n,e=>e)}function ma(n){n&&(n.scrollTop=0)}function xt(n,e,s){let i=n.get(e);return i||(i=s(),n.set(e,i)),i}function Tn(n){return""+n}function pa(n){const e=document.createElement("template");return e.innerHTML=n,e}const va=new WeakMap,ga=new WeakMap,ya=Symbol("un-keyed"),ba="replaceChildren"in Element.prototype;function Ea(n,e){ba?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function Sa(n,e){let s=n.firstChild,i=0;for(;s;){if(e[i]!==s)return!0;s=s.nextSibling,i++}return i!==e.length}function wa(n,e){const{targetNode:s}=e;let{targetParentNode:i}=e,h=!1;i?h=Sa(i,n):(h=!0,e.targetNode=void 0,e.targetParentNode=i=s.parentNode),h&&Ea(i,n)}function Ta(n,e){for(const s of e){const{targetNode:i,currentExpression:h,binding:{expressionIndex:o,attributeName:p,attributeValuePre:v,attributeValuePost:B}}=s,S=n[o];if(h!==S)if(s.currentExpression=S,p)i.setAttribute(p,v+Tn(S)+B);else{let F;Array.isArray(S)?wa(S,s):S instanceof Element?(F=S,i.replaceWith(F)):i.nodeValue=Tn(S),F&&(s.targetNode=F)}}}function ka(n){let e="",s=!1,i=!1,h=-1;const o=new Map,p=[];for(let B=0,S=n.length;B<S;B++){const F=n[B];if(e+=F,B===S-1)break;for(let Z=0;Z<F.length;Z++)switch(F.charAt(Z)){case"<":{F.charAt(Z+1)==="/"?p.pop():(s=!0,p.push(++h));break}case">":{s=!1,i=!1;break}case"=":{i=!0;break}}const k=p[p.length-1],w=xt(o,k,()=>[]);let R,ue,ve;if(i){const Z=/(\S+)="?([^"=]*)$/.exec(F);R=Z[1],ue=Z[2],ve=/^[^">]*/.exec(n[B+1])[0]}const te={attributeName:R,attributeValuePre:ue,attributeValuePost:ve,expressionIndex:B};w.push(te),!s&&!i&&(e+=" ")}return{template:pa(e),elementsToBindings:o}}function xa(n,e){const s=[],i=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let h=n,o=-1;do{const p=e.get(++o);if(p)for(let v=0;v<p.length;v++){const B=p[v],S=B.attributeName?h:h.firstChild,F={binding:B,targetNode:S,targetParentNode:void 0,currentExpression:void 0};s.push(F)}}while(h=i.nextNode());return s}function Ca(n){const{template:e,elementsToBindings:s}=xt(va,n,()=>ka(n)),i=e.cloneNode(!0).content.firstElementChild,h=xa(i,s);return function(p){return Ta(p,h),i}}function Ia(n){const e=xt(ga,n,()=>new Map);let s=ya;function i(o,...p){const v=xt(e,o,()=>new Map);return xt(v,s,()=>Ca(o))(p)}function h(o,p,v){return o.map((B,S)=>{const F=s;s=v(B);try{return p(B,S)}finally{s=F}})}return{map:h,html:i}}function Aa(n,e,s,i,h,o,p,v){const{labelWithSkin:B,titleForEmoji:S,unicodeWithSkin:F}=s,{html:k,map:w}=Ia(e);function R(te,Z,me){return w(te,(V,Q)=>k`<button role="${Z?"option":"menuitem"}" aria-selected="${e.searchMode?Q===e.activeSearchItem:""}" aria-label="${B(V,e.currentSkinTone)}" title="${S(V)}" class="emoji ${Z&&Q===e.activeSearchItem?"active":""}" id="${`${me}-${V.id}`}">${V.unicode?F(V,e.currentSkinTone):k`<img class="custom-emoji" src="${V.url}" alt="" loading="lazy">`}</button>`,V=>`${me}-${V.id}`)}const ve=k`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${w(e.skinTones,(te,Z)=>k`<div id="skintone-${Z}" class="emoji ${Z===e.activeSkinTone?"active":""}" aria-selected="${Z===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[Z]}" aria-label="${e.i18n.skinTones[Z]}">${te}</div>`,te=>te)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${w(e.groups,te=>k`<button role="tab" class="nav-button" aria-controls="tab-${te.id}" aria-label="${e.i18n.categories[te.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===te.id}" title="${e.i18n.categories[te.name]}" data-group-id="${te.id}"><div class="nav-emoji emoji">${te.emoji}</div></button>`,te=>te.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${w(e.currentEmojisWithCategories,(te,Z)=>k`<div><div id="menu-label-${Z}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:te.category?te.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${Z}" id="${e.searchMode?"search-results":""}">${R(te.emojis,e.searchMode,"emo")}</div></div>`,te=>te.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${R(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(v){n.appendChild(ve);const te=(Z,me)=>{for(const V of n.querySelectorAll(`[${Z}]`))me(V,V.getAttribute(Z))};for(const Z of["click","focusout","input","keydown","keyup"])te(`data-on-${Z}`,(me,V)=>{me.addEventListener(Z,i[V])});te("data-ref",(Z,me)=>{o[me]=Z}),te("data-action",(Z,me)=>{h[me](Z)}),p.addEventListener("abort",()=>{n.removeChild(ve)})}}const Bt=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function _a(n){let e=!1,s;const i=new Map,h=new Set;let o;const p=()=>{if(e)return;const S=[...h];h.clear();try{for(const F of S)F()}finally{o=!1,h.size&&(o=!0,Bt(p))}},v=new Proxy({},{get(S,F){if(s){let k=i.get(F);k||(k=new Set,i.set(F,k)),k.add(s)}return S[F]},set(S,F,k){S[F]=k;const w=i.get(F);if(w){for(const R of w)h.add(R);o||(o=!0,Bt(p))}return!0}}),B=S=>{const F=()=>{const k=s;s=F;try{return S()}finally{s=k}};return F()};return n.addEventListener("abort",()=>{e=!0}),{state:v,createEffect:B}}function Xt(n,e,s){if(n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(!s(n[i],e[i]))return!1;return!0}const Jt=[],{assign:Lt}=Object;function Da(n,e){const s={},i=new AbortController,h=i.signal,{state:o,createEffect:p}=_a(h);Lt(o,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),Lt(o,e),Lt(o,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:Jr,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:Yt,databaseLoaded:!1,activeSearchItemId:void 0}),p(()=>{o.currentGroup!==o.groups[o.currentGroupIndex]&&(o.currentGroup=o.groups[o.currentGroupIndex])});const v=C=>{n.getElementById(C).focus()},B=C=>n.getElementById(`emo-${C.id}`),S=(C,J)=>{s.rootElement.dispatchEvent(new CustomEvent(C,{detail:J,bubbles:!0,composed:!0}))},F=(C,J)=>C.id===J.id,k=(C,J)=>{const{category:ie,emojis:le}=C,{category:be,emojis:ne}=J;return ie!==be?!1:Xt(le,ne,F)},w=C=>{Xt(o.currentEmojis,C,F)||(o.currentEmojis=C)},R=C=>{o.searchMode!==C&&(o.searchMode=C)},ue=C=>{Xt(o.currentEmojisWithCategories,C,k)||(o.currentEmojisWithCategories=C)},ve=(C,J)=>J&&C.skins&&C.skins[J]||C.unicode,me={labelWithSkin:(C,J)=>ha([C.name||ve(C,J),C.annotation,...C.shortcodes||Jt].filter(Boolean)).join(", "),titleForEmoji:C=>C.annotation||(C.shortcodes||Jt).join(", "),unicodeWithSkin:ve},V={onClickSkinToneButton:Se,onEmojiClick:ce,onNavClick:x,onNavKeydown:H,onSearchKeydown:P,onSkinToneOptionsClick:fe,onSkinToneOptionsFocusOut:Pe,onSkinToneOptionsKeydown:we,onSkinToneOptionsKeyup:re,onSearchInput:je},Q={calculateEmojiGridStyle:X};let D=!0;p(()=>{Aa(n,o,me,V,Q,s,h,D),D=!1}),o.emojiVersion||qt().then(C=>{C||(o.message=o.i18n.emojiUnsupportedMessage)}),p(()=>{async function C(){let J=!1;const ie=setTimeout(()=>{J=!0,o.message=o.i18n.loadingMessage},Kr);try{await o.database.ready(),o.databaseLoaded=!0}catch(le){console.error(le),o.message=o.i18n.networkErrorMessage}finally{clearTimeout(ie),J&&(J=!1,o.message="")}}o.database&&C()}),p(()=>{o.pickerStyle=`
      --num-groups: ${o.groups.length}; 
      --indicator-opacity: ${o.searchMode?0:1}; 
      --num-skintones: ${bn};`}),p(()=>{o.customEmoji&&o.database&&ee()}),p(()=>{o.customEmoji&&o.customEmoji.length?o.groups!==tn&&(o.groups=tn):o.groups!==Yt&&(o.currentGroupIndex&&o.currentGroupIndex--,o.groups=Yt)}),p(()=>{async function C(){o.databaseLoaded&&(o.currentSkinTone=await o.database.getPreferredSkinTone())}C()}),p(()=>{o.skinTones=Array(bn).fill().map((C,J)=>ca(o.skinToneEmoji,J))}),p(()=>{o.skinToneButtonText=o.skinTones[o.currentSkinTone]}),p(()=>{o.skinToneButtonLabel=o.i18n.skinToneLabel.replace("{skinTone}",o.i18n.skinTones[o.currentSkinTone])}),p(()=>{async function C(){const{database:J}=o,ie=(await Promise.all(Qr.map(le=>J.getEmojiByUnicodeOrName(le)))).filter(Boolean);o.defaultFavoriteEmojis=ie}o.databaseLoaded&&C()});function ee(){o.database.customEmoji=o.customEmoji||Jt}p(()=>{async function C(){ee();const{database:J,defaultFavoriteEmojis:ie,numColumns:le}=o,be=await J.getTopFavoriteEmoji(le),ne=await Ie(Vn([...be,...ie],Te=>Te.unicode||Te.name).slice(0,le));o.currentFavorites=ne}o.databaseLoaded&&o.defaultFavoriteEmojis&&C()});function X(C){da(C,h,J=>{{const ie=getComputedStyle(s.rootElement),le=parseInt(ie.getPropertyValue("--num-columns"),10),be=ie.getPropertyValue("direction")==="rtl",Te=C.parentElement.getBoundingClientRect().width-J;o.numColumns=le,o.scrollbarWidth=Te,o.isRtl=be}})}p(()=>{async function C(){const{searchText:J,currentGroup:ie,databaseLoaded:le,customEmoji:be}=o;if(!le)o.currentEmojis=[],o.searchMode=!1;else if(J.length>=qr){const ne=await Oe(J);o.searchText===J&&(w(ne),R(!0))}else{const{id:ne}=ie;if(ne!==-1||be&&be.length){const Te=await Ne(ne);o.currentGroup.id===ne&&(w(Te),R(!1))}}}C()}),p(()=>{const{currentEmojis:C,emojiVersion:J}=o,ie=C.filter(le=>le.unicode).filter(le=>En(le)&&!nn.has(le.unicode));if(!J&&ie.length)w(C),Ot(()=>Y(ie));else{const le=J?C:C.filter(b);w(le),Ot(()=>ma(s.tabpanelElement))}});function Y(C){fa(C,s.baselineEmoji,B),o.currentEmojis=o.currentEmojis}function b(C){return!C.unicode||!En(C)||nn.get(C.unicode)}async function he(C){const J=o.emojiVersion||await qt();return C.filter(({version:ie})=>!ie||ie<=J)}async function Ie(C){return la(C,o.emojiVersion||await qt())}async function Ne(C){const J=C===-1?o.customEmoji:await o.database.getEmojiByGroup(C);return Ie(await he(J))}async function Oe(C){return Ie(await he(await o.database.getEmojiBySearchQuery(C)))}p(()=>{}),p(()=>{function C(){const{searchMode:ie,currentEmojis:le}=o;if(ie)return[{category:"",emojis:le}];const be=new Map;for(const ne of le){const Te=ne.category||"";let Ve=be.get(Te);Ve||(Ve=[],be.set(Te,Ve)),Ve.push(ne)}return[...be.entries()].map(([ne,Te])=>({category:ne,emojis:Te})).sort((ne,Te)=>o.customCategorySorting(ne.category,Te.category))}const J=C();ue(J)}),p(()=>{o.activeSearchItemId=o.activeSearchItem!==-1&&o.currentEmojis[o.activeSearchItem].id}),p(()=>{const{rawSearchText:C}=o;Fn(()=>{o.searchText=(C||"").trim(),o.activeSearchItem=-1})});function P(C){if(!o.searchMode||!o.currentEmojis.length)return;const J=ie=>{Ze(C),o.activeSearchItem=Gt(ie,o.activeSearchItem,o.currentEmojis)};switch(C.key){case"ArrowDown":return J(!1);case"ArrowUp":return J(!0);case"Enter":if(o.activeSearchItem===-1)o.activeSearchItem=0;else return Ze(C),oe(o.currentEmojis[o.activeSearchItem].id)}}function x(C){const{target:J}=C,ie=J.closest(".nav-button");if(!ie)return;const le=parseInt(ie.dataset.groupId,10);s.searchElement.value="",o.rawSearchText="",o.searchText="",o.activeSearchItem=-1,o.currentGroupIndex=o.groups.findIndex(be=>be.id===le)}function H(C){const{target:J,key:ie}=C,le=be=>{be&&(Ze(C),be.focus())};switch(ie){case"ArrowLeft":return le(J.previousElementSibling);case"ArrowRight":return le(J.nextElementSibling);case"Home":return le(J.parentElement.firstElementChild);case"End":return le(J.parentElement.lastElementChild)}}async function oe(C){const J=await o.database.getEmojiByUnicodeOrName(C),ie=[...o.currentEmojis,...o.currentFavorites].find(be=>be.id===C),le=ie.unicode&&ve(ie,o.currentSkinTone);await o.database.incrementFavoriteEmojiCount(C),S("emoji-click",{emoji:J,skinTone:o.currentSkinTone,...le&&{unicode:le},...ie.name&&{name:ie.name}})}async function ce(C){const{target:J}=C;if(!J.classList.contains("emoji"))return;Ze(C);const ie=J.id.substring(4);oe(ie)}function pe(C){o.currentSkinTone=C,o.skinTonePickerExpanded=!1,v("skintone-button"),S("skin-tone-change",{skinTone:C}),o.database.setPreferredSkinTone(C)}function fe(C){const{target:{id:J}}=C,ie=J&&J.match(/^skintone-(\d)/);if(!ie)return;Ze(C);const le=parseInt(ie[1],10);pe(le)}function Se(C){o.skinTonePickerExpanded=!o.skinTonePickerExpanded,o.activeSkinTone=o.currentSkinTone,o.skinTonePickerExpanded&&(Ze(C),Ot(()=>v("skintone-list")))}p(()=>{o.skinTonePickerExpanded?s.skinToneDropdown.addEventListener("transitionend",()=>{o.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):o.skinTonePickerExpandedAfterAnimation=!1});function we(C){if(!o.skinTonePickerExpanded)return;const J=async ie=>{Ze(C),o.activeSkinTone=ie};switch(C.key){case"ArrowUp":return J(Gt(!0,o.activeSkinTone,o.skinTones));case"ArrowDown":return J(Gt(!1,o.activeSkinTone,o.skinTones));case"Home":return J(0);case"End":return J(o.skinTones.length-1);case"Enter":return Ze(C),pe(o.activeSkinTone);case"Escape":return Ze(C),o.skinTonePickerExpanded=!1,v("skintone-button")}}function re(C){if(o.skinTonePickerExpanded)switch(C.key){case" ":return Ze(C),pe(o.activeSkinTone)}}async function Pe(C){const{relatedTarget:J}=C;(!J||J.id!=="skintone-list")&&(o.skinTonePickerExpanded=!1)}function je(C){o.rawSearchText=C.target.value}return{$set(C){Lt(o,C)},$destroy(){i.abort()}}}const Na="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",La="en";var Ma={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Oa=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const zn=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],Pa=`:host{--emoji-font-family:${Wn}}`;class un extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const s=document.createElement("style");s.textContent=Oa+Pa,this.shadowRoot.appendChild(s),this._ctx={locale:La,dataSource:Na,skinToneEmoji:Xr,customCategorySorting:Zr,customEmoji:null,i18n:Ma,emojiVersion:null,...e};for(const i of zn)i!=="database"&&Object.prototype.hasOwnProperty.call(this,i)&&(this._ctx[i]=this[i],delete this[i]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Da(this.shadowRoot,this._ctx))}disconnectedCallback(){Bt(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(s=>console.error(s))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,s,i){this._set(e.replace(/-([a-z])/g,(h,o)=>o.toUpperCase()),e==="emoji-version"?parseFloat(i):i)}_set(e,s){this._ctx[e]=s,this._cmp&&this._cmp.$set({[e]:s}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:s,database:i}=this._ctx;(!i||i.locale!==e||i.dataSource!==s)&&this._set("database",new Hr({locale:e,dataSource:s}))}_dbFlush(){Bt(()=>this._dbCreate())}}const Yn={};for(const n of zn)Yn[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(un.prototype,Yn);customElements.get("emoji-picker")||customElements.define("emoji-picker",un);var rn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(s,i){i(e)})(kt,function(s){var i="dnd-poly-",h=i+"snapback",o="dnd-poly-",p=o+"dragstart-pending",v=o+"dragstart-cancel",B=["none","copy","copyLink","copyMove","link","linkMove","move","all"],S=["none","copy","move","link"],F=function(){var P=!1;try{var x=Object.defineProperty({},"passive",{get:function(){P=!0}});window.addEventListener("test",null,x)}catch{}return P}();function k(P){return P&&P.tagName}function w(P,x,H){H===void 0&&(H=!0),document.addEventListener(P,x,!!F&&{passive:H})}function R(P,x){document.removeEventListener(P,x)}function ue(P,x,H,oe){oe===void 0&&(oe=!1);var ce=F?{passive:!0,capture:oe}:oe;return P.addEventListener(x,H,ce),{off:function(){P.removeEventListener(x,H,ce)}}}function ve(P){return P.length===0?0:P.reduce(function(x,H){return H+x},0)/P.length}function te(P,x){for(var H=0;H<P.changedTouches.length;H++)if(P.changedTouches[H].identifier===x)return!0;return!1}function Z(P,x,H){for(var oe=[],ce=[],pe=0;pe<x.touches.length;pe++){var fe=x.touches[pe];oe.push(fe[P+"X"]),ce.push(fe[P+"Y"])}H.x=ve(oe),H.y=ve(ce)}var me=["","-webkit-"];function V(P,x,H,oe,ce){ce===void 0&&(ce=!0);var pe=x.x,fe=x.y;oe&&(pe+=oe.x,fe+=oe.y),ce&&(pe-=parseInt(P.offsetWidth,10)/2,fe-=parseInt(P.offsetHeight,10)/2);for(var Se="translate3d("+pe+"px,"+fe+"px, 0)",we=0;we<me.length;we++){var re=me[we]+"transform";P.style[re]=Se+" "+H[we]}}var Q=function(){function P(x,H){this.t=x,this.i=H,this.s=S[0]}return Object.defineProperty(P.prototype,"dropEffect",{get:function(){return this.s},set:function(x){this.t.mode!==0&&B.indexOf(x)>-1&&(this.s=x)},enumerable:!0,configurable:!0}),Object.defineProperty(P.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(P.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(x){this.t.mode===2&&B.indexOf(x)>-1&&(this.t.effectAllowed=x)},enumerable:!0,configurable:!0}),P.prototype.setData=function(x,H){if(this.t.mode===2){if(x.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[x]=H,this.t.types.indexOf(x)===-1&&this.t.types.push(x)}},P.prototype.getData=function(x){if(this.t.mode===1||this.t.mode===2)return this.t.data[x]||""},P.prototype.clearData=function(x){if(this.t.mode===2){if(x&&this.t.data[x]){delete this.t.data[x];var H=this.t.types.indexOf(x);return void(H>-1&&this.t.types.splice(H,1))}this.t.data={},this.t.types=[]}},P.prototype.setDragImage=function(x,H,oe){this.t.mode===2&&this.i(x,H,oe)},P}();function D(P,x){return P?P===B[0]?S[0]:P.indexOf(B[1])===0||P===B[7]?S[1]:P.indexOf(B[4])===0?S[3]:P===B[6]?S[2]:S[1]:x.nodeType===3&&x.tagName==="A"?S[3]:S[1]}function ee(P,x,H,oe,ce,pe,fe){pe===void 0&&(pe=!0),fe===void 0&&(fe=null);var Se=function(re,Pe,je,C,J,ie,le){le===void 0&&(le=null);var be=Pe.changedTouches[0],ne=new Event(je,{bubbles:!0,cancelable:C});ne.dataTransfer=ie,ne.relatedTarget=le,ne.screenX=be.screenX,ne.screenY=be.screenY,ne.clientX=be.clientX,ne.clientY=be.clientY,ne.pageX=be.pageX,ne.pageY=be.pageY;var Te=re.getBoundingClientRect();return ne.offsetX=ne.clientX-Te.left,ne.offsetY=ne.clientY-Te.top,ne}(x,H,P,pe,document.defaultView,ce,fe),we=!x.dispatchEvent(Se);return oe.mode=0,we}function X(P,x){if(!P||P===B[7])return x;if(x===S[1]){if(P.indexOf(S[1])===0)return S[1]}else if(x===S[3]){if(P.indexOf(S[3])===0||P.indexOf("Link")>-1)return S[3]}else if(x===S[2]&&(P.indexOf(S[2])===0||P.indexOf("Move")>-1))return S[2];return S[0]}var Y,b=function(){function P(x,H,oe,ce){this.h=x,this.o=H,this.u=oe,this.l=ce,this.v=0,this.p=null,this.g=null,this.m=x,this.I=x.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),w("touchmove",this.j,!1),w("touchend",this.S,!1),w("touchcancel",this.S,!1)}return P.prototype.A=function(){var x=this;this.v=1,this.O=S[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var H=this.u;if(this.N=new Q(this.D,function(Se,we,re){H=Se,typeof we!="number"&&typeof re!="number"||(x.P={x:we||0,y:re||0})}),this.D.mode=2,this.N.dropEffect=S[0],ee("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;Z("page",this.m,this.F);var oe,ce=this.o.dragImageSetup(H);if(this.L=(oe=ce,me.map(function(Se){var we=oe.style[Se+"transform"];return we&&we!=="none"?we.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),ce.style.position="absolute",ce.style.left="0px",ce.style.top="0px",ce.style.zIndex="999999",ce.classList.add("dnd-poly-drag-image"),ce.classList.add("dnd-poly-icon"),this._=ce,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var pe=getComputedStyle(H);this.P={x:0-parseInt(pe.marginLeft,10),y:0-parseInt(pe.marginTop,10)}}else{var fe=H.getBoundingClientRect();pe=getComputedStyle(H),this.P={x:fe.left-this.I.clientX-parseInt(pe.marginLeft,10)+fe.width/2,y:fe.top-this.I.clientY-parseInt(pe.marginTop,10)+fe.height/2}}return V(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){x.X||(x.X=!0,x.Y(),x.X=!1)},this.o.iterationInterval),!0},P.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),R("touchmove",this.j),R("touchend",this.S),R("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},P.prototype.C=function(x){var H=this;if(te(x,this.I.identifier)!==!1){if(this.m=x,this.v===0){var oe=void 0;if(this.o.dragStartConditionOverride)try{oe=this.o.dragStartConditionOverride(x)}catch{oe=!1}else oe=x.touches.length===1;return oe?void(this.A()===!0&&(this.h.preventDefault(),x.preventDefault())):void this.T()}if(x.preventDefault(),Z("client",x,this.M),Z("page",x,this.F),this.o.dragImageTranslateOverride)try{var ce=!1;if(this.o.dragImageTranslateOverride(x,{x:this.M.x,y:this.M.y},this.p,function(pe,fe){H._&&(ce=!0,H.M.x+=pe,H.M.y+=fe,H.F.x+=pe,H.F.y+=fe,V(H._,H.F,H.L,H.P,H.o.dragImageCenterOnTouch))}),ce)return}catch{}V(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},P.prototype.k=function(x){if(te(x,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(x.preventDefault(),this.v=x.type==="touchcancel"?3:2):this.T()}},P.prototype.Y=function(){var x=this,H=this.O;this.D.mode=3,this.N.dropEffect=S[0];var oe=ee("drag",this.u,this.m,this.D,this.N);if(oe&&(this.O=S[0]),oe||this.v===2||this.v===3)return this.q(this.v)?void function(Se,we,re,Pe){var je=getComputedStyle(Se);if(je.visibility!=="hidden"&&je.display!=="none"){we.classList.add(h);var C=getComputedStyle(we),J=parseFloat(C.transitionDuration);if(isNaN(J)||J===0)Pe();else{var ie=Se.getBoundingClientRect(),le={x:ie.left,y:ie.top};le.x+=document.body.scrollLeft||document.documentElement.scrollLeft,le.y+=document.body.scrollTop||document.documentElement.scrollTop,le.x-=parseInt(je.marginLeft,10),le.y-=parseInt(je.marginTop,10);var be=parseFloat(C.transitionDelay),ne=Math.round(1e3*(J+be));V(we,le,re,void 0,!1),setTimeout(Pe,ne)}}else Pe()}(this.u,this._,this.L,function(){x.B()}):void this.B();var ce=this.o.elementFromPoint(this.M.x,this.M.y),pe=this.g;ce!==this.p&&ce!==this.g&&(this.p=ce,this.g!==null&&(this.D.mode=3,this.N.dropEffect=S[0],ee("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=D(this.D.effectAllowed,this.u),ee("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=X(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),pe!==this.g&&k(pe)&&(this.D.mode=3,this.N.dropEffect=S[0],ee("dragleave",pe,this.m,this.D,this.N,!1,this.g)),k(this.g)&&(this.D.mode=3,this.N.dropEffect=D(this.D.effectAllowed,this.u),ee("dragover",this.g,this.m,this.D,this.N)===!1?this.O=S[0]:this.O=X(this.N.effectAllowed,this.N.dropEffect)),H!==this.O&&this._.classList.remove(i+H);var fe=i+this.O;this._.classList.add(fe)},P.prototype.q=function(x){var H=this.O===S[0]||this.g===null||x===3;return H?k(this.g)&&(this.D.mode=3,this.N.dropEffect=S[0],ee("dragleave",this.g,this.m,this.D,this.N,!1)):k(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,ee("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=S[0]),H},P.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,ee("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},P}(),he={iterationInterval:150,tryFindDraggableTarget:function(P){var x=P.target;do if(x.draggable!==!1&&(x.draggable===!0||x.getAttribute&&x.getAttribute("draggable")==="true"))return x;while((x=x.parentNode)&&x!==document.body)},dragImageSetup:function(P){var x=P.cloneNode(!0);return function H(oe,ce){if(oe.nodeType===1){for(var pe=getComputedStyle(oe),fe=0;fe<pe.length;fe++){var Se=pe[fe];ce.style.setProperty(Se,pe.getPropertyValue(Se),pe.getPropertyPriority(Se))}if(ce.style.pointerEvents="none",ce.removeAttribute("id"),ce.removeAttribute("class"),ce.removeAttribute("draggable"),ce.nodeName==="CANVAS"){var we=oe,re=ce,Pe=we.getContext("2d").getImageData(0,0,we.width,we.height);re.getContext("2d").putImageData(Pe,0,0)}}if(oe.hasChildNodes())for(fe=0;fe<oe.childNodes.length;fe++)H(oe.childNodes[fe],ce.childNodes[fe])}(P,x),x},elementFromPoint:function(P,x){return document.elementFromPoint(P,x)}};function Ie(P){if(!Y){var x=he.tryFindDraggableTarget(P);if(x)try{Y=new b(P,he,x,Oe)}catch(H){throw Oe(he,P,3),H}}}function Ne(P){var x=P.target,H=function(we){ce.off(),pe.off(),fe.off(),Se.off(),x&&x.dispatchEvent(new CustomEvent(v,{bubbles:!0,cancelable:!0})),clearTimeout(oe)};x&&x.dispatchEvent(new CustomEvent(p,{bubbles:!0,cancelable:!0}));var oe=window.setTimeout(function(){ce.off(),pe.off(),fe.off(),Se.off(),Ie(P)},he.holdToDrag),ce=ue(x,"touchend",H),pe=ue(x,"touchcancel",H),fe=ue(x,"touchmove",H),Se=ue(window,"scroll",H,!0)}function Oe(P,x,H){if(H===0&&P.defaultActionOverride)try{P.defaultActionOverride(x),x.defaultPrevented}catch{}Y=null}s.polyfill=function(P){if(P&&Object.keys(P).forEach(function(ce){he[ce]=P[ce]}),!he.forceApply){var x=(H={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},oe=!!window.chrome||/chrome/i.test(navigator.userAgent),H.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||oe&&"ontouchstart"in document.documentElement),H);if(x.userAgentSupportingNativeDnD&&x.draggable&&x.dragEvents)return!1}var H,oe;return he.holdToDrag?w("touchstart",Ne,!1):w("touchstart",Ie,!1),!0},Object.defineProperty(s,"__esModule",{value:!0})})})(rn,rn.exports);var ja=rn.exports;const Ba=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),nt=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},Ra=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let kn;const Ua=(n=window)=>new Promise(e=>{const s=setTimeout(()=>{e()},100),i=()=>{clearTimeout(s),clearTimeout(kn),kn=setTimeout(()=>{n.removeEventListener("scroll",i),e()},100)};n.addEventListener("scroll",i)}),$a="v0.6.2 Beta";document.addEventListener("DOMContentLoaded",()=>{var be,ne,Te,Ve,Be,Fe,st,Ke,Ce,at,et,Je,it,ct,lt;const n=document.querySelector(".editor"),e=document.getElementById("tones"),s=document.getElementById("action"),i=document.getElementById("musical-score"),h=document.getElementById("add-track"),o=document.getElementById("remove-track"),p=document.getElementById("dialog"),v=document.forms["dialog-form"];v._title=v.querySelector(".form-title"),v.inputs=v.querySelector(".inputs"),v.buttons=v.querySelector(".buttons");const B=document.getElementById("play"),S=document.getElementById("clear"),F=document.getElementById("warn-out"),k=document.getElementById("mml"),w=document.getElementById("copy"),R=document.getElementById("paste"),ue=document.getElementById("save"),ve=document.getElementById("open"),te=document.getElementById("ctrl"),Z=document.getElementById("undo"),me=document.getElementById("redo");class V{constructor(){$e(this,be,`#COMMENT Generated by FlMML VisualSequencer ${$a}`);$e(this,ne,[]);$e(this,Te,(r,_)=>{});$e(this,Ve,(r,_)=>{})}set onChange(r){He(this,Te,r)}set onError(r){He(this,Ve,r)}setMmlArr(r){He(this,ne,r),K(this,Te).call(this,this.getMmlArr(),this.getMml())}setMml(r){He(this,ne,r.split(`
`)),K(this,ne).at(-2)===""&&K(this,ne).at(-1)===K(this,be)&&K(this,ne).splice(-2,2),K(this,Te).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return K(this,ne)}getMml(){return K(this,ne).length?K(this,ne).concat(["",K(this,be)]).join(`
`):""}getMmlLine(r){return K(this,ne)[r]}insert(r,_){Object.hasOwn(K(this,ne),r)||r===0?(K(this,ne).splice(r,0,_),K(this,Te).call(this,this.getMmlArr(),this.getMml())):K(this,Ve).call(this,"範囲外の書き換え指定",`範囲${K(this,ne).length-1}までのところ、${r}`)}append(r){K(this,ne).push(r),K(this,Te).call(this,this.getMmlArr(),this.getMml())}appendToStr(r,_){Object.hasOwn(K(this,ne),r)?(K(this,ne)[r]+=_,K(this,Te).call(this,this.getMmlArr(),this.getMml())):this.append(_)}beforeInsertToStr(r,_){Object.hasOwn(K(this,ne),r)?(K(this,ne)[r]=_+K(this,ne)[r],K(this,Te).call(this,this.getMmlArr(),this.getMml())):this.append(_)}rewrite(r,_){Object.hasOwn(K(this,ne),r)?(K(this,ne)[r]=_,K(this,Te).call(this,this.getMmlArr(),this.getMml())):this.append(_)}delete(r,_=1){Object.hasOwn(K(this,ne),r)&&K(this,ne).splice(r,_).length!==0?K(this,Te).call(this,this.getMmlArr(),this.getMml()):K(this,Ve).call(this,"無効な指定",`範囲${K(this,ne).length-1}までの中で${r}から${_}削除するのはできません`)}}be=new WeakMap,ne=new WeakMap,Te=new WeakMap,Ve=new WeakMap;class Q{constructor(r,_){$e(this,Be,[]);$e(this,Fe,[]);$e(this,st,null);$e(this,Ke,null);this.tonesElem=r,this.areaElem=_,He(this,Ke,this.areaElem.querySelector(".track.active"))}set activeTrack(r){K(this,Ke).classList.remove("active"),He(this,Ke,r),K(this,Ke).classList.add("active")}get activeTrack(){return K(this,Ke)}blocksDataUpdate(){He(this,Be,[...this.areaElem.querySelectorAll(".track button")].map(r=>({label:r.ariaLabel,className:r.className,trackNo:[...document.getElementsByClassName("track")].findIndex(_=>_.contains(r)),tone:{tone:r.dataset.tone,tonePitch:r.dataset.tonePitch},tempo:r.dataset.tempo,noteValue:r.dataset.noteValue,rest:r.dataset.rest,octave:r.dataset.octave,velocity:r.dataset.velocity,noteShift:r.dataset.noteShift,detune:r.dataset.detune,tieSlur:r.dataset.tieSlur,repeatStartEnd:r.dataset.repeatStartEnd,repeatBreak:r.dataset.repeatBreak,polyStartEnd:r.dataset.polyStartEnd,macroDef:r.dataset.macroDef,macroArgUse:r.dataset.macroArgUse,macroUse:r.dataset.macroUse,metaData:r.dataset.metaData,otherAction:r.dataset.otherAction,elem:r})))}saveBlocksData(){clearTimeout(K(this,st)),He(this,st,setTimeout(()=>{const r=JSON.parse(JSON.stringify(K(this,Be)));Vt.setItem("BlocksData",r).catch(_=>{alert("セーブができませんでした。"+_)})},1e3))}checkSavedBlocksData(){Vt.getItem("BlocksData").then(r=>{r&&(He(this,Be,r),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Y))})}parseBlocks(){const r=K(this,Be);this.activeTrack=this.areaElem.querySelector(".track");const _=this.tonesElem.querySelector("ul");let y=0;r.forEach(g=>{if(g.trackNo!==y){const M=document.createElement("ul");M.classList.add("track"),this.activeTrack=M,this.areaElem.insertBefore(M,h),y=g.trackNo}const u=document.createElement("li"),L='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',G=(()=>{const M=document.createElement("div");return M.innerHTML=L,M.firstElementChild})(),A=document.querySelector(`[class*="${g.className.replace(/ material-icons| droppable| bounce| pop| done/g,"")}"]`),j=(A==null?void 0:A.cloneNode(!0))||G;g.label&&(j.ariaLabel=g.label),g.tone.tonePitch&&(j.className=g.className,g.label!=="無調整"&&(j.textContent=g.label),j.dataset.tone=g.tone.tone,A?A.replaceWith(j.cloneNode(!0)):_.appendChild(j.cloneNode(!0)),j.dataset.tonePitch=g.tone.tonePitch),g.tempo&&(j.dataset.tempo=g.tempo),g.noteValue&&(j.dataset.noteValue=g.noteValue),g.rest&&(j.dataset.rest=g.rest),g.octave&&(j.dataset.octave=g.octave),g.velocity&&(j.dataset.velocity=g.velocity),g.noteShift&&(j.dataset.noteShift=g.noteShift),g.detune&&(j.dataset.detune=g.detune),g.tieSlur&&(j.dataset.tieSlur=g.tieSlur,g.tieSlur==="&"?j.ariaLabel="スラー":j.ariaLabel="タイ"),g.repeatStartEnd&&(j.dataset.repeatStartEnd=g.repeatStartEnd,g.repeatStartEnd.startsWith("/:")?(j.classList.remove("material-icons"),j.ariaLabel="リピート開始",j.textContent="◆"):g.repeatStartEnd===":/"&&(j.ariaLabel="リピート終了")),g.repeatBreak&&(j.dataset.repeatBreak=g.repeatBreak),g.polyStartEnd&&(j.dataset.polyStartEnd=g.polyStartEnd),g.macroDef&&(j.dataset.macroDef=g.macroDef,j.textContent=g.macroDef===";"?";":"$="),g.macroArgUse&&(j.dataset.macroArgUse=g.macroArgUse),g.macroUse&&(j.dataset.macroUse=g.macroUse),g.metaData&&(j.dataset.metaData=g.metaData),g.otherAction&&(j.dataset.otherAction=g.otherAction,j.textContent=g.otherAction.length>4?"…":g.otherAction),u.appendChild(j),this.activeTrack.appendChild(u)})}exportMml(r){r.setMmlArr([]);let _=0,y=0;const g=K(this,Be).filter(E=>E.tone.tone!==void 0),u=()=>g.filter(E=>E.trackNo===y),L=()=>new Set(u().map(E=>E.tone.tone));let G=L(),A=0,j=!1,M=[4,0],q=!1;K(this,Be).forEach(E=>{const{tone:se,tonePitch:W}=E.tone;if(E.trackNo!==y&&(G.size?([...G].forEach((N,T)=>{r.appendToStr(_+T,";")}),_+=G.size):(r.appendToStr(_,";"),_++),y=E.trackNo,G=L(),j=!1),se!==void 0)A=[...G].indexOf(se),j||([...G].forEach((N,T)=>{N&&r.beforeInsertToStr(_+T,N+" ")}),j=!0),[...G].forEach((N,T)=>{let ye=W||"";T!==A&&(ye=ye.replace(/[a-g]/,q?"*":"r")),r.appendToStr(_+T,ye)});else if(E.rest||E.tieSlur)G.size?[...G].forEach((N,T)=>{r.appendToStr(_+T,E.rest||E.tieSlur)}):r.appendToStr(_,E.rest||E.tieSlur);else if(E.noteValue||E.repeatStartEnd||E.repeatBreak||E.polyStartEnd){const N=T=>{if(!T)return M;const ye=Number((T.match(/[0-9]+/)||[M[0]])[0]),Ee=(T.match(/\.+/)||[""])[0].length;return[ye,Ee]};E.noteValue?M=N(E.noteValue):E.polyStartEnd==="["?q=!0:E.polyStartEnd==="]"&&(q=!1),G.size?[...G].forEach((T,ye)=>{if(r.appendToStr(_+ye,E.noteValue||E.repeatStartEnd||E.repeatBreak||E.polyStartEnd||""),E.polyStartEnd==="]"){const Ee=r.getMmlLine(_+ye).match(/\[(.+?)\]/);if(Ee){const Le=Ee[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(Le){const ze=[...Le].map(Xe=>({type:Xe[1]==="r"?"rest":Xe[1]==="*"?"otherNote":"note",num:N(Xe[0])}));ze.filter(Re=>Re.type==="note").map(Re=>Re.num),ze.filter(Re=>Re.type==="otherNote").map(Re=>Re.num),ze.filter(Re=>Re.type==="rest").map(Re=>Re.num);let yt=Ee[0].replace(/\*\+?[0-9]*\.*/g,"");const tt=r.getMmlLine(_+ye).replace(/\[.+?\]/,yt);r.rewrite(_+ye,tt)}}}}):r.appendToStr(_,E.noteValue||E.repeatStartEnd||E.repeatBreak||E.polyStartEnd||"")}else if(E.metaData)E.metaData&&r.getMmlLine(_)&&_++,r.appendToStr(_,E.metaData.replace(`
`,"")||""),_++;else{const N=W||E.tempo||E.octave||E.velocity||E.noteShift||E.detune||E.tieSlur||E.macroDef||E.macroArgUse||E.macroUse||E.otherAction||"";r.appendToStr(_,N),/;/.test(N)&&(_+=G.size||1,G=L(),j=!1)}}),[...G].slice(0,-1).forEach((E,se)=>{r.appendToStr(_+se,";")})}importMml(r){const _=r.getMmlArr(),y=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig,g=[],u=new Set,L=new Set;let G=0,A="",j=!1,M=!1;_.forEach(q=>{(q.match(y)||[]).forEach(se=>{if(se=se.trim(),!se)return;const W=N=>{const T={};if(T.tone={},T.trackNo=G,/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(N)){A=N,L.add(A);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(N)){L.has(A)||L.add(A);const ye=[...L].indexOf(A)+1;T.label="無調整",T.className=`material-icons note note-${ye}`,T.tone.tone=A,T.tone.tonePitch=N,j&&(M=!0)}else if(N.startsWith("t"))T.className="material-icons tempo",T.tempo=N;else if(N.startsWith("l"))T.className="material-icons note-value",T.noteValue=N;else if(N.startsWith("r"))T.className="material-icons rest",T.rest=N;else if(/^o[0-8]|[><]+$/i.test(N))T.className="material-icons octave",T.octave=N;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(N))T.className="material-icons velocity",T.velocity=N;else if(N.startsWith("@ns")||N.startsWith("ns"))T.className="material-icons note-shift",T.noteShift=N;else if(N.startsWith("@d"))T.className="material-icons detune",T.detune=N;else if(N.startsWith("&"))T.className="tie-slur",T.tieSlur=N;else if(N.startsWith("/*"))T.className="other-action",T.otherAction=N;else if(N.startsWith("/:"))T.className="repeat-start-end",T.repeatStartEnd=N;else if(N.startsWith(":/"))T.className="material-icons repeat-start-end",T.repeatStartEnd=N;else if(N.startsWith("/"))T.className="repeat-break",T.repeatBreak=N;else if(N.startsWith("[")||N.startsWith("]"))T.className="poly-start-end",T.polyStartEnd=N;else if(/^\$.*?=$/.test(N))T.className="macro-def",T.macroDef=N.replaceAll(" ",""),u.add(T.macroDef.slice(0,-1)),j=!0;else if(N.startsWith("%"))T.className="macro-arg-use",T.macroArgUse=N;else if(N.startsWith("$")){T.className="macro-use";const ye=[...u].sort((Ee,Le)=>Le.length-Ee.length).find(Ee=>N.includes(Ee));if(ye){T.macroUse=ye,g.push(T);const Ee=N.replace(ye,"");Ee!==""&&W(Ee);return}else T.macroUse=N}else if(N.startsWith("#")){const ye={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};T.label=(Object.entries(ye).find(Ee=>N.startsWith(Ee[0]))||[,void 0])[1],T.className="meta-data",T.metaData=N+`
`}else if(N.startsWith(";")){if(G++,j&&!M){const ye=[...L].join(" ");ye&&(T.className="other-action",T.otherAction=ye,g.push(T),L.clear())}j=!1,M=!1;return}else T.className="other-action",T.otherAction=N;g.push(T)};W(se)})}),this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((q,E)=>{E?q.remove():(q.textContent="",this.activeTrack=q)}),re=null,He(this,Be,g),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}playRendering(){const r=K(this,Be);let _=120,y=0;[e,s,i].forEach(M=>{M.classList.add("no-op")});const g=document.querySelector(".wrap"),u=document.getElementsByClassName("track"),G=(g.clientHeight-32)/u.length;[...u].forEach(M=>{M.style.setProperty("--max-height",`${G}px`)}),h.disabled=!0,o.disabled=!0;const A=(M,{scoreNoteValue:q=4}={})=>{var It;let E=!1,se=-1,W=-1,N=!1,T=!1;const ye=[],Ee=[],Le=[],ze=performance.now(),yt=(It=M[0])==null?void 0:It.trackNo,tt=u[yt],Xe=y++;let Re=null;const Rt=new Promise(de=>Re=de);let bt=0,Me=0;const ft=de=>{if(!de)return q;const We=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(de),qe=We&&We[1]?Number(We[1]):q,Ae=We?We[2].length:0;return qe*2**Ae/(2**(Ae+1)-1)},Ct=de=>{const We=Ae=>{!T&&tt.scrollTo({top:Ae,behavior:"smooth"}),T=!0,Ua(tt).then(()=>{T=!1})},qe=Ae=>tt.clientHeight*Ae;(Me===0||de.elem.offsetTop>tt.scrollTop+qe(.8)||de.elem.offsetTop<tt.scrollTop+qe(.2))&&We(de.elem.offsetTop-qe(.2))},Et=de=>{const We=qe=>{const Ae=qe-ze,Ue=60/_*4/de*1e3;Ae<bt+Ue?K(this,Fe)[Xe]=requestAnimationFrame(We):(bt+=Ue,Ye())};K(this,Fe)[Xe]=requestAnimationFrame(We)},Ye=async()=>{var We,qe;const de=M[Me];if(!de||Me>=M.length){Re({scoreNoteValue:q});return}if(Ct(de),N){de.macroDef===";"&&(N=!1),Me++,Ye();return}else if(se!==-1)(We=de.repeatStartEnd)!=null&&We.startsWith("/:")?W++:de.repeatStartEnd===":/"&&(W===se&&(nt(de.elem,"pop"),se=-1),W--),Me++,Ye();else if(de.tone.tonePitch){const Ae=ft(de.tone.tonePitch);nt(de.elem,"bounce"),Me++,E?Ye():Et(Ae)}else if(de.rest||de.tieSlur)if(nt(de.elem,"pop"),Me++,de.tieSlur==="&")Ye();else{const Ae=ft(de.rest||de.tieSlur);Et(Ae)}else if(de.polyStartEnd)if(E=de.polyStartEnd==="[",nt(de.elem,"pop"),E)Me++,Ye();else{const Ae=ft(M[Me++-1].tone.tonePitch);Et(Ae)}else if(de.macroDef&&de.macroDef!==";"){N=!0,Me++,Ye();return}else{if(de.tempo&&(_=Number(de.tempo.replace("t",""))||_),de.noteValue&&(q=ft(de.noteValue)),nt(de.elem,"pop"),(qe=de.repeatStartEnd)!=null&&qe.startsWith("/:"))ye[++W]=Me,Ee[W]||(Le[W]=de.repeatStartEnd.replace("/:",""),Le[W]=Le[W]===""?2:Number(Le[W]),Le[W]||(se=W));else if(de.repeatBreak){if(Le[W]===1){if(!Ee[W]){let Ae=W;Ee[W]=M.findIndex((Ue,Qe)=>{if(Qe>ye[W]){if(console.log(Ae),Ue.repeatStartEnd.startsWith("/:"))Ae++;else if(Ue.repeatStartEnd===":/"){if(Ae===W)return!0;Ae--}}})}Me=Ee[W],Ye(),nt(de.elem,"done");return}}else if(de.repeatStartEnd===":/"){if(Le[W]--,Le[W]){Ee[W]=Me,Me=ye[W],W--,Ye(),nt(de.elem,"done");return}Ee[W]=null,W--}else if(de.macroUse){const Ae=Qe=>{const ot=r[Qe].trackNo;let ht=Qe+1;for(;r[ht].macroDef!==";"&&r[ht].trackNo===ot;)ht++;return ht},Ue={};if(Ue.start=r.findIndex(Qe=>{var ot;return(ot=Qe.macroDef)==null?void 0:ot.startsWith(de.macroUse)}),Ue.start>-1){Ue.end=Ae(Ue.start),Ue.blocks=r.slice(Ue.start+1,Ue.end);const Qe=performance.now();q=(await A(Ue.blocks,{scoreNoteValue:q})).scoreNoteValue;const ot=performance.now();bt+=ot-Qe}}Me++,Ye()}nt(de.elem,"done")};return Ye(),Rt},j=Math.max(...r.map(M=>M.trackNo))+1;for(let M=0;M<j;M++)A(r.filter(q=>q.trackNo===M))}stopRendering(){[e,s,i].forEach(r=>{r.classList.remove("no-op")}),h.disabled=!1,o.disabled=!1,K(this,Be).forEach(r=>{r.elem.classList.remove("done")}),K(this,Fe).forEach(r=>{cancelAnimationFrame(r)})}calcPoly(){const r=Math.max(...K(this,Be).map(_=>_.trackNo))+1;for(let _=0;_<r;_++)K(this,Be).filter(g=>g.polyStartEnd&&g.trackNo===_).forEach((g,u)=>{u%2===0?(g.elem.dataset.polyStartEnd="[",g.elem.textContent="["):(g.elem.dataset.polyStartEnd="]",g.elem.textContent="]")});this.blocksDataUpdate()}}Be=new WeakMap,Fe=new WeakMap,st=new WeakMap,Ke=new WeakMap;class D{constructor(){$e(this,Ce,[[],[]]);$e(this,at,70);$e(this,et,r=>{});$e(this,Je,r=>{})}set onPushstate(r){He(this,et,r)}set onPopstate(r){He(this,Je,r)}pushState(r){K(this,Ce)[0].push(r),K(this,et).call(this,r),K(this,Ce)[0].length>K(this,at)&&K(this,Ce)[0].shift(),K(this,Ce)[1].length=0,console.log(K(this,Ce))}undo(){const r=K(this,Ce)[0].pop();return K(this,Je).call(this,{reason:"undo",data:r}),r&&K(this,Ce)[1].unshift(r),console.log(K(this,Ce)),{canUndo:!!K(this,Ce)[0].length,canRedo:!!K(this,Ce)[1].length}}redo(){const r=K(this,Ce)[1].shift();return K(this,Je).call(this,{reason:"redo",data:r}),r&&K(this,Ce)[0].push(r),console.log(K(this,Ce)),{canUndo:!!K(this,Ce)[0].length,canRedo:!!K(this,Ce)[1].length}}clear(){K(this,Ce)[0].length=0,K(this,Ce)[1].length=0,console.log(K(this,Ce))}}Ce=new WeakMap,at=new WeakMap,et=new WeakMap,Je=new WeakMap;class ee{constructor(r){$e(this,it,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name"},{label:"音の定義",type:"text",name:"tone-def",autofocus:""}],buttons:[{class:"primaly",value:"set-tone",textContent:"確定"}]},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-tone-pitch",textContent:"確定"}]},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0"}],buttons:[{class:"primaly",value:"set-tempo",textContent:"確定"}]},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-note-value",textContent:"確定"}]},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-rest",textContent:"確定"}]},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8"}],buttons:[{class:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}]},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127"}],buttons:[{class:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}]},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift"}],buttons:[{class:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}]},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune"}],buttons:[{class:"primaly",value:"set-detune",textContent:"確定"}]},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-tie-slur",textContent:"確定"}]},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0"}],buttons:[{class:"primaly",value:"set-repeat",textContent:"確定"}]},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg"}],buttons:[{class:"primaly",value:"set-macro-def",textContent:"確定"}]},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use"}],buttons:[{class:"primaly",value:"set-macro-arg-use",textContent:"確定"}]},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg"}],buttons:[{class:"primaly",value:"set-macro-use",textContent:"確定"}]},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{class:"primaly",value:"set-meta-data",textContent:"確定"}]},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action"}],buttons:[{class:"primaly",value:"set-other-action",textContent:"確定"}]},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}]}});$e(this,ct,r=>{const _=K(this,it)[r];Object.keys(_).forEach(y=>{switch(y){case"title":v._title.textContent=_.title;break;case"inputs":_.inputs.forEach(g=>{const u=document.createElement("input");let L=u;Object.entries(g).forEach(G=>{if(G[0]==="label"){const A=document.createElement("label");A.innerHTML=G[1],A.appendChild(u),L=A}else if(G[0]==="select"){const A=document.createElement("select");A.name=g.name;const j=G[1];Object.entries(j).forEach(M=>{const q=document.createElement("option");q.value=M[0],q.textContent=M[1],A.appendChild(q)}),u.replaceWith(A)}else u.setAttribute(G[0],G[1])}),v.inputs.appendChild(L)});break;case"buttons":_.buttons.forEach(g=>{const u=document.createElement("button");Object.entries(g).forEach(L=>{L[0]==="textContent"?u.textContent=L[1]:u.setAttribute(L[0],L[1])}),v.buttons.appendChild(u)});break}})});$e(this,lt,(r,_)=>{v._title.textContent="",v.inputs.textContent="",v.buttons.textContent="",K(this,ct).call(this,r);for(const[y,g]of Object.entries(_))y==="run"?g():v.elements[y].value=g;this.type=r});this.type=null,this.submitTarget=null,this.resolve=null,r.addEventListener("submit",_=>{const y=this.submitTarget,g=_.submitter.value,u=JSON.parse(JSON.stringify(y.dataset));switch(g){case"set-tone":const G=y.className;document.querySelectorAll(`[class*="${G}"]`).forEach(E=>{E.ariaLabel=r.elements["tone-name"].value,(!E.classList.contains("material-icons")||r.elements["tone-name"].value!=="無調整")&&(E.classList.remove("material-icons"),E.textContent=r.elements["tone-name"].value),E.dataset.tone=r.elements["tone-def"].value});break;case"set-tone-pitch":y.dataset.tonePitch=y.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]+r.elements["tone-pitch"].value+".".repeat(r.elements.dot.value);break;case"set-tempo":y.dataset.tempo="t"+r.elements.tempo.value;break;case"set-note-value":y.dataset.noteValue="l"+r.elements["note-value"].value+".".repeat(r.elements.dot.value);break;case"set-rest":y.dataset.rest="r"+r.elements.rest.value+".".repeat(r.elements.dot.value);break;case"set-octave":y.dataset.octave="o"+r.elements.octave.value;break;case"set-octave-relative":y.dataset.octave=r.elements.octave.value>0?"<".repeat(r.elements.octave.value):">".repeat(-r.elements.octave.value);break;case"set-velocity":y.dataset.velocity="@v"+r.elements.velocity.value;break;case"set-velocity-relative":y.dataset.velocity=(r.elements.velocity.value>=0?"(":")")+Math.abs(r.elements.velocity.value);break;case"set-note-shift":y.dataset.noteShift="ns"+r.elements["note-shift"].value;break;case"set-note-shift-relative":y.dataset.noteShift="@ns"+r.elements["note-shift"].value;break;case"set-detune":y.dataset.detune="@d"+r.elements.detune.value;break;case"set-tie-slur":y.dataset.tieSlur="&"+r.elements["tie-slur"].value+".".repeat(r.elements.dot.value),y.dataset.tieSlur==="&"?y.ariaLabel="スラー":y.ariaLabel="タイ";break;case"set-repeat":y.dataset.repeatStartEnd="/:"+r.elements.repeat.value;break;case"set-macro-def":const A=y.dataset.macroDef;y.dataset.macroDef="$"+r.elements["macro-def-name"].value+(r.elements["macro-def-arg"].value!==""?`{${r.elements["macro-def-arg"].value}}`:"")+"=",i.querySelectorAll(`[data-macro-use="${A.replace("=","")}"]`).forEach(E=>{E.dataset.macroUse=y.dataset.macroDef.replace("=","")});break;case"set-macro-arg-use":y.dataset.macroArgUse="%"+r.elements["macro-arg-use"].value;break;case"set-macro-use":y.dataset.macroUse="$"+r.elements["macro-use-name"].value+(r.elements["macro-use-arg"].value!==""?`{${r.elements["macro-use-arg"].value}}`:"");break;case"set-meta-data":y.ariaLabel=r.elements["select-meta-data"].selectedOptions[0].label,y.dataset.metaData=r.elements["select-meta-data"].value.replace("{n}",r.elements.number.value).replace("{desc}",r.elements.text.value);break;case"set-other-action":y.dataset.otherAction=r.elements["other-action"].value,y.textContent=y.dataset.otherAction.length>4?"…":y.dataset.otherAction;break;case"remove-left":case"remove-right":const j=y.parentElement,M=b.activeTrack,q=M.children;for([...q].indexOf(j),re=null;[...q].includes(j);){const E=g==="remove-left",se=E?M.firstElementChild:M.lastElementChild;he.pushState({operation:"remove",removedElem:se,removedIndex:E?0:q.length-1,parent:M}),se.remove()}b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y);break}const L=JSON.parse(JSON.stringify(y.dataset));JSON.stringify(u)!==JSON.stringify(L)&&he.pushState({operation:"valueChange",target:y,beforeChange:u,afterChange:L}),this.resolve()})}async prompt(r,_,y){return K(this,lt).call(this,r,_),this.submitTarget=y,p.showModal(),new Promise(g=>this.resolve=g)}}it=new WeakMap,ct=new WeakMap,lt=new WeakMap,pn.FlMML.prepare(".editor");const X=new pn.FlMML({workerURL:ar}),Y=new V;Vt.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const b=new Q(e,i),he=new D,Ie=new ee(v),Ne={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},Oe=new un({i18n:Ne,locale:"ja"});ja.polyfill({holdToDrag:500}),Ra();const P=m=>`<span class="material-icons">${m}</span>`,x=P("play_arrow")+"再生",H=P("stop")+"停止",oe=()=>{b.playRendering()},ce=()=>{F.innerHTML=X.getWarnings().replaceAll(`
`,"<br>")};X.addEventListener("compilecomplete",ce);const pe=()=>{B.innerHTML=x,b.stopRendering(),X.removeEventListener("compilecomplete",oe),S.disabled=!1};X.addEventListener("complete",pe),Y.onChange=(m,r)=>{k.innerHTML=r?`<pre><code>${Ba(r).replaceAll(`
`,"<br>")}</code></pre>`:"(なし)";const _=!!m.length;[w,ue].forEach(y=>{y.disabled=!_})},Y.onError=(m,r)=>{alert(m+`
`+r)},b.checkSavedBlocksData();const fe=m=>{var E,se;const r=()=>{let W=m.parentElement;for(;W&&!("noteValue"in W.firstElementChild.dataset);)W=W.previousElementSibling;return(W==null?void 0:W.firstElementChild)||null},_=()=>{var N;let W=m.parentElement;for(;W&&!((N=W.firstElementChild.dataset.octave)!=null&&N.startsWith("o"));)W=W.previousElementSibling;return(W==null?void 0:W.firstElementChild)||null},y=()=>{var T;let W=m.parentElement.nextElementSibling,N="";for(;W&&((T=W.firstElementChild.dataset.tieSlur)!=null&&T.match(/&[0-9]+\.*/));)N+=W.firstElementChild.dataset.tieSlur,W=W.nextElementSibling;return N},g=((E=r())==null?void 0:E.dataset.noteValue)||"",u=((se=_())==null?void 0:se.dataset.octave)||"",L=[...b.activeTrack.children].indexOf(m.parentElement),G=[...b.activeTrack.children].slice(0,L).filter(W=>"tonePitch"in W.firstElementChild.dataset||"octave"in W.firstElementChild.dataset&&!W.firstElementChild.dataset.octave.startsWith("o")).map(W=>((W.firstElementChild.dataset.tonePitch||W.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),A=[">","<"],j=(W,N)=>(W.match(new RegExp(N,"g"))||[]).length,M=(()=>{const W=-j(G,A[0])+j(G,A[1]);return W<0?A[0].repeat(-W):W>0?A[1].repeat(W):""})(),q=y();X.play(m.dataset.tone+g+u+M+m.dataset.tonePitch+q)};he.onPopstate=m=>{const r=m.data,_=y=>!!r.parent.closest("#"+y);switch(m.reason){case"undo":switch(r==null?void 0:r.operation){case"append":Y.delete(r.index);break;case"delete":Y.insert(r.index,r.mmlText);break;case"rewrite":Y.rewrite(r.index,r.beforeMmlText);break;case"copy":r.newElem.remove(),_("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y));break;case"move":const y=r.fromIndex<=r.toIndex?"beforebegin":"afterend";r.parent.children[r.fromIndex].insertAdjacentElement(y,r.elem),_("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y));break;case"valueChange":for(const[g,u]of Object.entries(r.beforeChange))r.target.dataset[g]=u;"tone"in r.target.dataset&&fe(r.target),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y);break;case"remove":r.parent.insertBefore(r.removedElem,r.parent.children[r.removedIndex]),_("tones")||_("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y));break;case"clear":r.tonesChildren.forEach(g=>{e.querySelector("ul").appendChild(g)}),r.musicalScoreChildren.forEach(g=>{i.insertBefore(g,h)}),re=r.lastTouchedButton,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y);break}break;case"redo":switch(r==null?void 0:r.operation){case"append":Y.append(r.mmlText);break;case"delete":Y.delete(r.index);break;case"rewrite":Y.rewrite(r.index,r.afterMmlText);break;case"copy":r.toIndex!==-1?r.parent.insertBefore(r.newElem,r.parent.children[r.toIndex]):r.parent.appendChild(r.newElem),_("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y)),"tonePitch"in re.dataset&&(fe(re),re.classList.add("bounce"));break;case"move":const y=r.toIndex>r.fromIndex?"beforebegin":"afterend";r.toIndex!==-1?r.parent.children[r.toIndex].insertAdjacentElement(y,r.elem):r.parent.appendChild(r.elem),_("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y));break;case"valueChange":for(const[u,L]of Object.entries(r.afterChange))r.target.dataset[u]=L;"tone"in r.target.dataset&&fe(r.target),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y);break;case"remove":const g=r.removedElem.className;r.removedElem.remove(),_("tones")&&i.querySelectorAll(`[class*="${g}"]`).forEach(u=>{u.parentElement.remove()}),b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y);break;case"clear":e.querySelector("ul").textContent="",i.querySelectorAll(".track").forEach((u,L)=>{L?u.remove():(u.textContent="",b.activeTrack=u)}),re=null,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y);break}break}};const Se=()=>{const m=[...e.getElementsByTagName("button")].map(r=>[...r.classList].find(_=>_.includes("note-")));for(let r=1;;r++)if(!m.includes("note-"+r))return"note-"+r};document.addEventListener("keydown",m=>{var _;const r=m.ctrlKey||te.checked;switch((_=m.key)==null?void 0:_.toLowerCase()){case" ":document.activeElement.tagName.toLowerCase()!=="input"&&(m.preventDefault(),B.click());break;case"s":r&&(m.preventDefault(),!ue.disabled&&ue.click());break;case"o":r&&(m.preventDefault(),!ve.disabled&&ve.click());break;case"z":r&&he.undo();break;case"y":r&&he.redo();break}});const we=async m=>{const{dataset:r}=m,_={tempo:y=>({tempo:y.replace("t","")}),noteValue:y=>({"note-value":(y.match(/[0-9]+/)||[""])[0],dot:(y.match(/\.+/)||[""])[0].length}),rest:y=>({rest:(y.match(/[0-9]+/)||[""])[0],dot:(y.match(/\.+/)||[""])[0].length}),octave:y=>({octave:y.startsWith("o")?y.replace("o",""):(y.match(/[><]+/)||[""])[0].length}),velocity:y=>({velocity:y.startsWith("@v")?y.replace("@v",""):Number((y.match(/[0-9]+/)||[""])[0])*(y.startsWith("(")?1:-1)}),noteShift:y=>({"note-shift":(y.match(/[0-9]+/)||[""])[0]}),detune:y=>({detune:y.replace("@d","")}),tieSlur:y=>({"tie-slur":(y.match(/[0-9]+/)||[""])[0],dot:(y.match(/\.+/)||[""])[0].length}),repeatStartEnd:y=>({repeat:y.replace("/:","")}),macroDef:y=>({"macro-def-name":(y.match(/\$([^\{\=]*)[\{\=]/)||[,""])[1],"macro-def-arg":(y.match(/\{([^\}]*)\}/)||[,""])[1]}),macroArgUse:y=>({"macro-arg-use":y.replace("%","")}),macroUse:y=>({"macro-use-name":(y.match(/\$([^\{]*)\{?/)||[,""])[1],"macro-use-arg":(y.match(/\{([^\}]*)\}/)||[,""])[1]}),metaData:y=>({run:()=>{const u=y.split(" "),L=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let G=L.findIndex(E=>u[0].startsWith(E));G===-1&&(G=0),v.elements["select-meta-data"].selectedIndex=G;const A=E=>v.elements[E].previousSibling,j=()=>v.elements["select-meta-data"].selectedOptions[0],M=(E,se)=>{A("number").nodeValue=E[0],v.elements.number.value=E[1],v.elements.number.parentElement.style.display=E[2]?"none":"",A("text").nodeValue=se[0],v.elements.text.value=se[1],v.elements.text.parentElement.style.display=se[2]?"none":""},q=E=>{var N,T,ye;const se=E===G,W=L[E];switch(W){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const Ee=se?u.slice(1).join(" ")??"":"";M(["無効","",!0],[j().label,Ee,!1]);break;case"#OCTAVE":case"#VELOCITY":M(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const Le=W==="#WAV9",ze=se?((N=u.slice(1).join(" "))==null?void 0:N.split(","))??[]:[];M(["波形番号",ze[0]??0,!1],Le?["初期変位,ループフラグ,データ",`${ze[1]??0},${ze[2]??0},${ze[3]??""}`,!1]:["データ",ze[1]??"",!1]),v.elements.number.min=0,v.elements.number.max=Le?15:31;break;case"#OPM":case"#OPN":M(["音色番号",se?((T=u[0])==null?void 0:T.split("@")[1])??0:0,!1],["データ",se?((ye=u.slice(1).join(" "))==null?void 0:ye.slice(1,-1))??"":"",!1]),v.elements.number.min=0,v.elements.number.max=127;break;case"#FMGAIN":M(["音量利得",se?u[1].replace(`
`,"")??91:91,!1],["無効","",!0]),v.elements.number.min=-127,v.elements.number.max=127;break;case"#USING":M(["和音重ね数",se?u[2].replace(`
`,"")??2:2,!1],["無効","",!0]),v.elements.number.min=1,v.elements.number.max="";break}};q(G),v.elements["select-meta-data"].addEventListener("change",E=>{q(E.target.selectedIndex)})}}),otherAction:y=>({"other-action":y}),remove:()=>({})};for(const y of Object.keys(r)){const g=_[y];if(g){let u=r[y];switch(y){case"repeatStartEnd":if(u===":/"){const A=(()=>{var M;let j=m.parentElement;for(;j&&!((M=j.firstElementChild.dataset.repeatStartEnd)!=null&&M.startsWith("/:"));)j=j.previousElementSibling;return(j==null?void 0:j.firstElementChild)||null})();if(A)m=A;else{const j=b.activeTrack,M=document.createElement("li"),E=s.querySelector(".repeat-start-end").cloneNode(!0);M.appendChild(E),j.insertBefore(M,m.parentElement),m=E}u=m.dataset.repeatStartEnd}break;case"macroDef":if(u===";")return;break}const L=g(u);await Ie.prompt(y,L,m);break}}};let re=e.querySelector("button");n.addEventListener("click",async m=>{const r=m.ctrlKey||te.checked,_=g=>!!m.target.closest("#"+g),y=m.target.tagName.toLowerCase()==="button";if(![e,s,i].some(g=>g.classList.contains("no-op"))){if(_("tones"))if(y)re=m.target,await Ie.prompt("tone",{"tone-name":m.target.ariaLabel,"tone-def":m.target.dataset.tone,run:()=>{const g=v.elements["tone-name"];g.insertAdjacentElement("afterend",Oe);const u=document.querySelector("emoji-picker");g.addEventListener("focus",()=>{u.classList.add("expaned")},{once:!0}),u.addEventListener("emoji-click",L=>g.value=L.detail.unicode)}},m.target),X.play(m.target.dataset.tone+m.target.dataset.tonePitch),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y);else{const g=e.querySelector("ul"),u=document.createElement("li"),G=`<button class="material-icons note ${Se()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;u.innerHTML=G;const A=u.firstElementChild;g.appendChild(u),re=A,X.play(A.dataset.tone+A.dataset.tonePitch),he.pushState({operation:"copy",toIndex:-1,newElem:u,parent:g})}else if(_("action")){if(y){"otherAction"in m.target.dataset&&await we(m.target);const g=b.activeTrack,u=document.createElement("li"),L=m.target.cloneNode(!0);if(("metaData"in L.dataset||"macroDef"in L.dataset||"macroArgUse"in L.dataset||"macroUse"in L.dataset)&&await we(L),"tieSlur"in L.dataset?L.ariaLabel="スラー":"repeatStartEnd"in L.dataset?(L.classList.remove("material-icons"),L.ariaLabel="リピート開始",L.textContent="◆",L.dataset.repeatStartEnd="/:"):"polyStartEnd"in L.dataset?(L.dataset.polyStartEnd="[",L.textContent="["):"macroDef"in L.dataset&&(L.textContent="$="),u.appendChild(L),g.appendChild(u),re=L,b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y),he.pushState({operation:"copy",toIndex:-1,newElem:u,parent:g}),"repeatStartEnd"in re.dataset||"polyStartEnd"in re.dataset||"macroDef"in re.dataset){const G=document.createElement("li"),A=m.target.cloneNode(!0);"repeatStartEnd"in re.dataset?(A.ariaLabel="リピート終了",A.dataset.repeatStartEnd=":/"):"polyStartEnd"in re.dataset?(A.dataset.polyStartEnd="]",A.textContent="]"):"macroDef"in re.dataset&&(A.dataset.macroDef=";",A.textContent=";"),G.appendChild(A),re.parentElement.insertAdjacentElement("afterend",G),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y),he.pushState({operation:"copy",toIndex:-1,newElem:G,parent:g})}}}else if(_("musical-score")){if(y&&m.target!==h&&m.target!==o)m.target.closest(".track")&&(b.activeTrack=m.target.closest(".track")),"tone"in m.target.dataset?(fe(m.target),nt(m.target,"bounce"),r&&(await Ie.prompt("tonePitch",{"tone-pitch":(m.target.dataset.tonePitch.match(/[0-9]+/)||[""])[0],dot:(m.target.dataset.tonePitch.match(/\.+/)||[""])[0].length},m.target),fe(m.target))):await we(m.target),re=m.target,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y);else if(re){m.target.closest(".track")&&(b.activeTrack=m.target.closest(".track"));const g=b.activeTrack,u=document.createElement("li"),L=re.cloneNode(!0);if("repeatStartEnd"in L.dataset&&(L.classList.remove("material-icons"),L.ariaLabel="リピート開始",L.textContent="◆",L.dataset.repeatStartEnd="/:"+(L.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),u.appendChild(L),g.appendChild(u),re=L,b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y),he.pushState({operation:"copy",toIndex:-1,newElem:u,parent:g}),"tonePitch"in L.dataset)L.dataset.tonePitch=L.dataset.tonePitch.replace(/[><]+/,""),fe(L),L.classList.add("bounce");else if("repeatStartEnd"in re.dataset){const G=document.createElement("li"),A=re.cloneNode(!0);A.classList.add("material-icons"),A.ariaLabel="リピート終了",A.textContent="repeat",A.dataset.repeatStartEnd=":/",G.appendChild(A),re.parentElement.insertAdjacentElement("afterend",G),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y),he.pushState({operation:"copy",toIndex:-1,newElem:G,parent:g})}}}}}),n.addEventListener("contextmenu",m=>{var g,u,L,G;const r=A=>A.closest("#tones, #musical-score"),_=A=>!!m.target.closest("#"+A),y=m.target.tagName.toLowerCase()==="button";if(!((g=r(m.target))!=null&&g.classList.contains("no-op"))&&r(m.target)){const A=y&&m.target!==h&&m.target!==o?m.target:re;if(!A||r(A)!==r(m.target))return;m.preventDefault(),b.activeTrack=A.closest(".track")||b.activeTrack;const j=A.parentElement,M=A.className,q=((u=A.closest("#tones"))==null?void 0:u.querySelector("ul"))||b.activeTrack,E=[...q.children].indexOf(j);re=((L=j.previousElementSibling)==null?void 0:L.firstElementChild)||((G=j.nextElementSibling)==null?void 0:G.firstElementChild)||null,he.pushState({operation:"remove",removedElem:j,removedIndex:E,parent:q}),_("tones")?i.querySelectorAll(`[class*="${M}"]`).forEach(se=>{se.parentElement.remove()}):"macroDef"in A.dataset&&i.querySelectorAll(`[data-macro-use="${A.dataset.macroDef.replace("=","")}"]`).forEach(se=>{se.parentElement.remove()}),j.remove(),b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(Y)}});let Pe=null,je=!1,C=null;n.addEventListener("touchstart",m=>{Pe=[...m.touches].at(-1).pageY,C=setTimeout(()=>{je=!0},500)});const J=m=>{const r=m.ctrlKey||te.checked,_=L=>!!m.target.closest("#"+L),y=m.target.tagName.toLowerCase()==="button";if(m.type==="touchmove"){const L=[...m.touches].at(-1).pageY;if(je){m.cancelable&&m.preventDefault();return}else if(L-Pe<-20)m.deltaY=-1,clearTimeout(C);else if(L-Pe>20)m.deltaY=1,clearTimeout(C);else{m.cancelable&&m.preventDefault();return}Pe=L,je=!0,setTimeout(()=>je=!1,50)}const g=m.deltaY<0;let u=y?m.target:(re==null?void 0:re.closest("#musical-score"))&&re;if(u){if(_("musical-score")){if(i.classList.contains("no-op"))return;m.preventDefault();let L=JSON.parse(JSON.stringify(u.dataset));if(!r&&"tone"in u.dataset){const A=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],j=[">","<"],M=u.dataset.tonePitch,q=A.findIndex(ye=>M.match(/[a-g]\+?/)[0]===ye),E=(ye,Ee)=>(ye.match(new RegExp(Ee,"g"))||[]).length,se=[E(M,j[0]),E(M,j[1])],W=j[0].repeat(se[0])+j[1].repeat(se[1]),N=(M.match(/[0-9]+/)||[""])[0],T=".".repeat((u.dataset.tonePitch.match(/\.+/)||[""])[0].length);g?q===A.length-1?se[0]?u.dataset.tonePitch=W.substring(1)+A.at(0)+N+T:u.dataset.tonePitch=W+j[1]+A.at(0)+N+T:u.dataset.tonePitch=W+A[q+1]+N+T:q===0?se[1]?u.dataset.tonePitch=W.substring(1)+A.at(-1)+N+T:u.dataset.tonePitch=W+j[0]+A.at(-1)+N+T:u.dataset.tonePitch=W+A[q-1]+N+T,fe(u)}else{const A=g?1:-1,j=(M,q=-1/0,E=1/0)=>M+A<q||M+A>E?0:A;if(r&&"tonePitch"in u.dataset){const M=Number((u.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),q=".".repeat((u.dataset.tonePitch.match(/\.+/)||[""])[0].length),E=j(M,0,384),se=M+E!==0?M+E:"";u.dataset.tonePitch=u.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+se+q,fe(u)}else if("tempo"in u.dataset){const M=Number(u.dataset.tempo.replace("t","")),q=j(M,0);u.dataset.tempo="t"+(M+q*10)}else if("noteValue"in u.dataset){const M=Number((u.dataset.noteValue.match(/[0-9]+/)||[""])[0]),q=j(M,1,384);u.dataset.noteValue=u.dataset.noteValue.replace(/[0-9]+/,M+q)}else if("rest"in u.dataset){const M=Number((u.dataset.rest.match(/[0-9]+/)||[""])[0]),q=".".repeat((u.dataset.rest.match(/\.+/)||[""])[0].length),E=j(M,0,384),se=M+E!==0?M+E:"";u.dataset.rest="r"+se+q}else if("octave"in u.dataset)if(u.dataset.octave.startsWith("o")){const q=Number(u.dataset.octave.replace("o","")),E=j(q,0,8);u.dataset.octave="o"+(q+E)}else{const q=(u.dataset.octave.match(/<+/)||[""])[0].length-(u.dataset.octave.match(/>+/)||[""])[0].length,E=j(q,-8,8);u.dataset.octave=q+E>0?"<".repeat(q+E):">".repeat(-(q+E))}else if("velocity"in u.dataset)if(u.dataset.velocity.startsWith("@v")){const q=Number(u.dataset.velocity.replace("@v","")),E=j(q,0,127);u.dataset.velocity="@v"+(q+E)}else{const q=Number((u.dataset.velocity.match(/[0-9]+/)||[""])[0])*(u.dataset.velocity.startsWith("(")?1:-1),E=j(q,-127,127);u.dataset.velocity=(q+E>=0?"(":")")+Math.abs(q+E)}else if("noteShift"in u.dataset){const M=Number((u.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),q=A;u.dataset.noteShift=u.dataset.noteShift.match(/@?ns/)[0]+(M+q)}else if("detune"in u.dataset){const M=Number(u.dataset.detune.replace("@d","")),q=A;u.dataset.detune="@d"+(M+q)}else if("tieSlur"in u.dataset){const M=Number((u.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),q=".".repeat((u.dataset.tieSlur.match(/\.+/)||[""])[0].length),E=j(M,0,384),se=M+E!==0?M+E:"";u.dataset.tieSlur="&"+se+q,u.dataset.tieSlur==="&"?u.ariaLabel="スラー":u.ariaLabel="タイ"}else if("repeatStartEnd"in u.dataset){if(u.dataset.repeatStartEnd===":/"){const W=(()=>{var T;let N=u.parentElement;for(;N&&!((T=N.firstElementChild.dataset.repeatStartEnd)!=null&&T.startsWith("/:"));)N=N.previousElementSibling;return(N==null?void 0:N.firstElementChild)||null})();if(W)u=W;else{const N=b.activeTrack,T=document.createElement("li"),Ee=s.querySelector(".repeat-start-end").cloneNode(!0);T.appendChild(Ee),N.insertBefore(T,u.parentElement),u=Ee}L=JSON.parse(JSON.stringify(u.dataset))}const M=Number((u.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),q=j(M,-1),E=M+q!==-1?M+q:"";u.dataset.repeatStartEnd="/:"+E}}const G=JSON.parse(JSON.stringify(u.dataset));JSON.stringify(L)!==JSON.stringify(G)&&he.pushState({operation:"valueChange",target:u,beforeChange:L,afterChange:G}),re=u,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y)}}else return};n.addEventListener("wheel",J),n.addEventListener("touchmove",J),n.addEventListener("touchend",()=>{je=!1});let ie={};n.addEventListener("dragstart",m=>{ie={from:m.target.nodeType===1&&m.target.closest("#tones, #action, #musical-score"),item:m.target},m.dataTransfer.effectAllowed="copyMove"});let le=null;[e,s,i].forEach(m=>{const r=u=>{const L=u.ctrlKey||te.checked,{from:G=null}=ie,A=u.dataTransfer;switch(G){case e:switch(m){case e:u.preventDefault(),L?A.dropEffect="copy":A.dropEffect="move";break;case s:break;case i:u.preventDefault(),A.dropEffect="copy";break}break;case s:switch(m){case e:break;case s:break;case i:u.preventDefault(),A.dropEffect="copy";break}break;case i:switch(m){case e:break;case s:break;case i:u.preventDefault(),L?A.dropEffect="copy":A.dropEffect="move";break}break}le=A.dropEffect};m.addEventListener("dragover",r);const _=u=>{const{from:L=null}=ie,G=u.target.tagName.toLowerCase()==="button",A=()=>u.target.classList.add("droppable");switch(L){case e:switch(m){case e:u.preventDefault(),G&&A();break;case s:break;case i:u.preventDefault(),G&&A();break}break;case s:switch(m){case e:break;case s:break;case i:u.preventDefault(),G&&A();break}break;case i:switch(m){case e:break;case s:break;case i:u.preventDefault(),G&&A();break}break}};m.addEventListener("dragenter",_);const y=u=>{const{from:L=null}=ie,G=u.target.tagName.toLowerCase()==="button",A=()=>u.target.classList.remove("droppable");switch(L){case e:switch(m){case e:G&&A();break;case s:break;case i:G&&A();break}break;case s:switch(m){case e:break;case s:break;case i:G&&A();break}break;case i:switch(m){case e:break;case s:break;case i:G&&A();break}break}};m.addEventListener("dragleave",y),m.addEventListener("drop",async u=>{var se,W;if(u.preventDefault(),(se=u.dataTransfer.items)!=null&&se.length)return;u.dataTransfer.dropEffect=u.dataTransfer.dropEffect!=="none"?u.dataTransfer.dropEffect:le;const{from:L,item:G}=ie,A=((W=u.target.closest("#tones"))==null?void 0:W.querySelector("ul"))||u.target.closest(".track")||b.activeTrack,j=[...A.children].indexOf(G.parentElement),M=[...A.children].indexOf(u.target.parentElement),q=u.target.tagName.toLowerCase()==="button";let E;switch(u.dataTransfer.dropEffect){case"copy":const N=document.createElement("li"),T=G.cloneNode(!0);if(m===e){const ye=[...G.classList].find(Ee=>Ee.includes("note-"));T.classList.replace(ye,Se())}else L===s&&("tieSlur"in T.dataset?T.ariaLabel="スラー":("metaData"in T.dataset||"macroDef"in T.dataset||"macroArgUse"in T.dataset||"macroUse"in T.dataset||"otherAction"in T.dataset)&&await we(T));"repeatStartEnd"in T.dataset?(T.classList.remove("material-icons"),T.ariaLabel="リピート開始",T.textContent="◆",T.dataset.repeatStartEnd="/:"+(T.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in T.dataset?(T.dataset.polyStartEnd="[",T.textContent="["):"macroDef"in T.dataset&&(T.dataset.macroDef===";"&&(T.dataset.macroDef="$="),T.textContent="$="),N.appendChild(T),E=N;break;case"move":E=G.parentElement;break}if(q&&u.target.id!=="add-track"&&u.target.id!=="remove-track"){const N=u.dataTransfer.dropEffect==="copy"||M<j?"beforebegin":"afterend";u.target.parentElement.insertAdjacentElement(N,E)}else A.appendChild(E);switch(re=E.firstElementChild,m===i&&(b.activeTrack=A,b.blocksDataUpdate(),u.dataTransfer.dropEffect==="move"&&b.calcPoly(),b.saveBlocksData(),b.exportMml(Y),"tonePitch"in re.dataset&&(re.dataset.tonePitch=re.dataset.tonePitch.replace(/[><]+/,""),fe(re),re.classList.add("bounce"))),u.dataTransfer.dropEffect){case"copy":he.pushState({operation:"copy",toIndex:M,newElem:E,parent:A});break;case"move":he.pushState({operation:"move",fromIndex:j,toIndex:M,elem:E,parent:A});break}if(u.dataTransfer.dropEffect==="copy"&&("repeatStartEnd"in re.dataset||"polyStartEnd"in re.dataset||"macroDef"in re.dataset)){const N=document.createElement("li"),T=G.cloneNode(!0);"repeatStartEnd"in re.dataset?(T.classList.add("material-icons"),T.ariaLabel="リピート終了",T.textContent="repeat",T.dataset.repeatStartEnd=":/"):"polyStartEnd"in re.dataset?(T.dataset.polyStartEnd="]",T.textContent="]"):"macroDef"in re.dataset&&(T.dataset.macroDef=";",T.textContent=";"),N.appendChild(T),E.insertAdjacentElement("afterend",N),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y),he.pushState({operation:"copy",toIndex:M+1,newElem:N,parent:A})}});const g=u=>{[...document.getElementsByClassName("droppable")].forEach(L=>{L.classList.remove("droppable")})};m.addEventListener("dragend",g)}),n.addEventListener("animationend",m=>{m.target.classList.remove("bounce"),m.target.classList.remove("pop")}),h.addEventListener("click",m=>{m.stopPropagation();const r=document.createElement("ul");r.classList.add("track"),b.activeTrack=r,i.insertBefore(r,h)}),o.addEventListener("click",m=>{m.stopPropagation();const r=[...document.getElementsByClassName("track")].at(-1),_=r.previousElementSibling;r.remove(),b.activeTrack=_,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y)}),p.addEventListener("pointerdown",m=>{m.target===p&&p.addEventListener("pointerup",r=>{r.target===p&&p.close()},{once:!0})}),p.addEventListener("close",()=>{switch(Ie.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}}),B.addEventListener("click",()=>{const m=X.isPlaying();m?(X.stop(),b.stopRendering(),X.removeEventListener("compilecomplete",oe),S.disabled=!1):(X.play(Y.getMml()),X.addEventListener("compilecomplete",oe),S.disabled=!0),B.innerHTML=m?x:H}),S.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const m=[...i.children];m.pop(),he.pushState({operation:"clear",tonesChildren:[...e.querySelector("ul").children],musicalScoreChildren:m,lastTouchedButton:re}),e.querySelector("ul").textContent="";const r=e.querySelector("ul"),_=document.createElement("li"),y='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';_.innerHTML=y;const g=_.firstElementChild;r.appendChild(_),re=g,i.querySelectorAll(".track").forEach((u,L)=>{L?u.remove():(u.textContent="",b.activeTrack=u)}),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(Y)}}),w.addEventListener("click",()=>{const m=Y.getMml(),r=w.innerHTML;w.disabled=!0,navigator.clipboard.writeText(m).then(()=>{w.disabled=!0,w.innerHTML=P("content_copy")+"コピーしました",setTimeout(()=>{w.innerHTML=r,w.disabled=!1},1500)}).catch(_=>alert(`コピーできませんでした
`+_))}),R.addEventListener("click",()=>{const m=R.innerHTML;R.disabled=!0,navigator.clipboard.readText().then(r=>{R.disabled=!0,r?(Y.setMml(r.replace(/\r/g,"")),b.importMml(Y),R.innerHTML=P("content_paste")+"貼り付けました"):R.innerHTML=P("content_paste")+"内容がありません",setTimeout(()=>{R.innerHTML=m,R.disabled=!1},1500)}).catch(r=>alert(`貼り付けできませんでした
`+r))}),ue.addEventListener("click",()=>{var u;const m=Y.getMml(),_=((u=Y.getMmlArr().find(L=>L.startsWith("#TITLE")))==null?void 0:u.split(" ").slice(1).join(" "))??"無題",y=new Blob([m],{type:"text/plain"}),g=document.createElement("a");g.download=_+".mml",g.href=URL.createObjectURL(y),g.click(),URL.revokeObjectURL(g.href),_==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。")}),ve.addEventListener("click",()=>{const m=document.createElement("input"),r=new FileReader;m.type="file",m.accept=".mml,.flmml,.txt",m.click(),m.onchange=()=>{r.onload=()=>{Y.setMml(r.result),b.importMml(Y)},r.readAsText(m.files[0])}}),("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile"),he.onPushstate=m=>{Z.disabled=!1,me.disabled=!0},Z.addEventListener("click",()=>{const{canUndo:m,canRedo:r}=he.undo();Z.disabled=!m,me.disabled=!r}),me.addEventListener("click",()=>{const{canUndo:m,canRedo:r}=he.redo();Z.disabled=!m,me.disabled=!r})});
