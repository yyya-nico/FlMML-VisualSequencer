var hn=(n,e,i)=>{if(!e.has(n))throw TypeError("Cannot "+i)};var Q=(n,e,i)=>(hn(n,e,"read from private field"),i?i.call(n):e.get(n)),We=(n,e,i)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,i)},Ge=(n,e,i,s)=>(hn(n,e,"write to private field"),s?s.call(n,i):e.set(n,i),i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const h of document.querySelectorAll('link[rel="modulepreload"]'))s(h);new MutationObserver(h=>{for(const o of h)if(o.type==="childList")for(const p of o.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&s(p)}).observe(document,{childList:!0,subtree:!0});function i(h){const o={};return h.integrity&&(o.integrity=h.integrity),h.referrerPolicy&&(o.referrerPolicy=h.referrerPolicy),h.crossOrigin==="use-credentials"?o.credentials="include":h.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(h){if(h.ep)return;h.ep=!0;const o=i(h);fetch(h.href,o)}})();const ar="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var Tt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function or(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var kn={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(i,s){n.exports=s()})(self,function(){return(()=>{var i={587:(o,p,v)=>{var P;(P=(function(S,F){Object.defineProperty(F,"__esModule",{value:!0}),F.MsgTypes=F.SAMPLE_RATE=void 0,F.SAMPLE_RATE=44100,F.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(p,[v,p]))===void 0||(o.exports=P)},581:(o,p,v)=>{var P;(P=(function(S,F){Object.defineProperty(F,"__esModule",{value:!0}),F.FlMMLAudioExportError=void 0;class k extends Error{constructor(...R){super(...R),this.name="FlMMLAudioExportError"}}F.FlMMLAudioExportError=k}).apply(p,[v,p]))===void 0||(o.exports=P)},643:function(o,p,v){var P,S,F=this&&this.__awaiter||function(k,w,R,ue){return new(R||(R=Promise))(function(ve,ee){function te(J){try{V(ue.next(J))}catch(_){ee(_)}}function pe(J){try{V(ue.throw(J))}catch(_){ee(_)}}function V(J){var _;J.done?ve(J.value):(_=J.value,_ instanceof R?_:new R(function(Z){Z(_)})).then(te,pe)}V((ue=ue.apply(k,w||[])).next())})};P=[v,p,v(587),v(581),v(158)],(S=(function(k,w,R,ue,ve){Object.defineProperty(w,"__esModule",{value:!0}),w.FlMMLonHTML5=w.FlMMLAudioExportError=w.FlMML=void 0,Object.defineProperty(w,"FlMMLAudioExportError",{enumerable:!0,get:function(){return ue.FlMMLAudioExportError}});const ee="flmml-on-html5.worker.js";class te{constructor(V=ee){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof V=="string"&&(V={workerURL:V});const J=V.workerURL||ee,_=V.infoInterval>=0?V.infoInterval:125;this.bufferSize=V.bufferSize>=128?Math.floor(V.bufferSize-V.bufferSize%128):8192,this.bufferMultiple=V.bufferMultiple>=1?Math.floor(V.bufferMultiple):32,this.lamejsURL=V.lamejsURL,(this.worker=new Worker(V.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${J}")`],{type:"application/javascript"})):J)).addEventListener("message",Z=>{this.onMessage(Z)}),this.setInfoInterval(_)}static initWebAudio(){const V=te.audioCtx=new AudioContext({sampleRate:R.SAMPLE_RATE}),J=V.createBufferSource();J.connect(V.destination),J.start(0),V.resume(),J.stop()}static hookInitWebAudio(V){const J=document.querySelectorAll(V);J.forEach(_=>{_.addEventListener("click",function Z(){te.audioCtx||te.initWebAudio(),J.forEach(K=>{K.removeEventListener("click",Z,!0)})},!0)})}static prepare(V){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{te.hookInitWebAudio(V)}):te.hookInitWebAudio(V)}onMessage(V){const J=V.data;switch(J.type){case R.MsgTypes.COMPCOMP:this.totalMSec=J.info.totalMSec,this.totalTimeStr=J.info.totalTimeStr,this.warnings=J.info.warnings,this.metaTitle=J.info.metaTitle,this.metaComment=J.info.metaComment,this.metaArtist=J.info.metaArtist,this.metaCoding=J.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case R.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(J),this.trigger("buffering",{progress:J.progress});break;case R.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case R.MsgTypes.SYNCINFO:this._isPlaying=J.info._isPlaying,this._isPaused=J.info._isPaused,this.nowMSec=J.info.nowMSec,this.nowTimeStr=J.info.nowTimeStr,this.voiceCount=J.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case R.MsgTypes.PLAYSOUND:this.playSound();break;case R.MsgTypes.STOPSOUND:this.stopSound();break;case R.MsgTypes.EXPORT:J.data?this.completeAudioExport(J.data):this.errorAudioExport(J.errorMsg)}}boot(){this.worker.postMessage({type:R.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const V=te.audioCtx,J=this.gainNode=V.createGain();J.gain.value=this.volume/127,J.connect(V.destination),F(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(Z=>{const K=new FileReader;K.onload=Y=>{V.audioWorklet.addModule(Y.target.result).then(Z)},K.readAsDataURL(new Blob([ve.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const _=this.workletNode=new AudioWorkletNode(V,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});_.connect(J),this.worker.postMessage({type:R.MsgTypes.PLAYSOUND,workletPort:_.port},[_.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:R.MsgTypes.STOPSOUND})}trigger(V,J){const _=this.events[V];if(!_)return;const Z={};for(let K in J)Z[K]=J[K];for(let K=0,Y=_.length;K<Y;K++)_[K]&&_[K].call(this,Z)}exportAudio(V,J,_={}){return te.audioCtx||te.initWebAudio(),this.booted||this.boot(),new Promise((Z,K)=>{this.audioExportResolve?K(new ue.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:R.MsgTypes.EXPORT,mml:V,format:J},_)),this.audioExportResolve=Z,this.audioExportReject=K)})}completeAudioExport(V){this.audioExportResolve&&(this.audioExportResolve(V),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(V){this.audioExportReject&&(this.audioExportReject(new ue.FlMMLAudioExportError(V)),this.audioExportResolve=null,this.audioExportReject=null)}play(V){te.audioCtx||te.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:R.MsgTypes.PLAY,mml:V})}stop(){this.worker.postMessage({type:R.MsgTypes.STOP})}pause(){this.worker.postMessage({type:R.MsgTypes.PAUSE})}exportWav(V){return this.exportAudio(V,"wav")}exportMp3(V,J){return this.exportAudio(V,"mp3",{bitrate:J})}setMasterVolume(V){this.volume=V,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(V){this.worker.postMessage({type:R.MsgTypes.SYNCINFO,interval:V})}syncInfo(){this.worker.postMessage({type:R.MsgTypes.SYNCINFO,interval:null})}addEventListener(V,J){let _=this.events[V];_||(_=this.events[V]=[]);for(let Z=_.length;Z--;)if(_[Z]===J)return!1;return _.push(J),!0}removeEventListener(V,J){const _=this.events[V];if(!_)return!1;for(let Z=_.length;Z--;)if(_[Z]===J)return _.splice(Z,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}w.FlMML=te,w.FlMMLonHTML5=te}).apply(p,P))===void 0||(o.exports=S)},158:(o,p,v)=>{v.r(p),v.d(p,{FlMMLWorkletScript:()=>P});const P='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},s={};function h(o){var p=s[o];if(p!==void 0)return p.exports;var v=s[o]={exports:{}};return i[o].call(v.exports,v,v.exports,h),v.exports}return h.d=(o,p)=>{for(var v in p)h.o(p,v)&&!h.o(o,v)&&Object.defineProperty(o,v,{enumerable:!0,get:p[v]})},h.o=(o,p)=>Object.prototype.hasOwnProperty.call(o,p),h.r=o=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},h(643)})()})})(kn);var mn=kn.exports;function It(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var xn={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(i){n.exports=i()})(function(){return function i(s,h,o){function p(S,F){if(!h[S]){if(!s[S]){var k=typeof It=="function"&&It;if(!F&&k)return k(S,!0);if(v)return v(S,!0);var w=new Error("Cannot find module '"+S+"'");throw w.code="MODULE_NOT_FOUND",w}var R=h[S]={exports:{}};s[S][0].call(R.exports,function(ue){var ve=s[S][1][ue];return p(ve||ue)},R,R.exports,i,s,h,o)}return h[S].exports}for(var v=typeof It=="function"&&It,P=0;P<o.length;P++)p(o[P]);return p}({1:[function(i,s,h){(function(o){var p=o.MutationObserver||o.WebKitMutationObserver,v;if(p){var P=0,S=new p(ue),F=o.document.createTextNode("");S.observe(F,{characterData:!0}),v=function(){F.data=P=++P%2}}else if(!o.setImmediate&&typeof o.MessageChannel<"u"){var k=new o.MessageChannel;k.port1.onmessage=ue,v=function(){k.port2.postMessage(0)}}else"document"in o&&"onreadystatechange"in o.document.createElement("script")?v=function(){var ee=o.document.createElement("script");ee.onreadystatechange=function(){ue(),ee.onreadystatechange=null,ee.parentNode.removeChild(ee),ee=null},o.document.documentElement.appendChild(ee)}:v=function(){setTimeout(ue,0)};var w,R=[];function ue(){w=!0;for(var ee,te,pe=R.length;pe;){for(te=R,R=[],ee=-1;++ee<pe;)te[ee]();pe=R.length}w=!1}s.exports=ve;function ve(ee){R.push(ee)===1&&!w&&v()}}).call(this,typeof Tt<"u"?Tt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(i,s,h){var o=i(1);function p(){}var v={},P=["REJECTED"],S=["FULFILLED"],F=["PENDING"];s.exports=k;function k(_){if(typeof _!="function")throw new TypeError("resolver must be a function");this.state=F,this.queue=[],this.outcome=void 0,_!==p&&ve(this,_)}k.prototype.catch=function(_){return this.then(null,_)},k.prototype.then=function(_,Z){if(typeof _!="function"&&this.state===S||typeof Z!="function"&&this.state===P)return this;var K=new this.constructor(p);if(this.state!==F){var Y=this.state===S?_:Z;R(K,Y,this.outcome)}else this.queue.push(new w(K,_,Z));return K};function w(_,Z,K){this.promise=_,typeof Z=="function"&&(this.onFulfilled=Z,this.callFulfilled=this.otherCallFulfilled),typeof K=="function"&&(this.onRejected=K,this.callRejected=this.otherCallRejected)}w.prototype.callFulfilled=function(_){v.resolve(this.promise,_)},w.prototype.otherCallFulfilled=function(_){R(this.promise,this.onFulfilled,_)},w.prototype.callRejected=function(_){v.reject(this.promise,_)},w.prototype.otherCallRejected=function(_){R(this.promise,this.onRejected,_)};function R(_,Z,K){o(function(){var Y;try{Y=Z(K)}catch(E){return v.reject(_,E)}Y===_?v.reject(_,new TypeError("Cannot resolve promise with itself")):v.resolve(_,Y)})}v.resolve=function(_,Z){var K=ee(ue,Z);if(K.status==="error")return v.reject(_,K.value);var Y=K.value;if(Y)ve(_,Y);else{_.state=S,_.outcome=Z;for(var E=-1,he=_.queue.length;++E<he;)_.queue[E].callFulfilled(Z)}return _},v.reject=function(_,Z){_.state=P,_.outcome=Z;for(var K=-1,Y=_.queue.length;++K<Y;)_.queue[K].callRejected(Z);return _};function ue(_){var Z=_&&_.then;if(_&&(typeof _=="object"||typeof _=="function")&&typeof Z=="function")return function(){Z.apply(_,arguments)}}function ve(_,Z){var K=!1;function Y(Le){K||(K=!0,v.reject(_,Le))}function E(Le){K||(K=!0,v.resolve(_,Le))}function he(){Z(E,Y)}var Ce=ee(he);Ce.status==="error"&&Y(Ce.value)}function ee(_,Z){var K={};try{K.value=_(Z),K.status="success"}catch(Y){K.status="error",K.value=Y}return K}k.resolve=te;function te(_){return _ instanceof this?_:v.resolve(new this(p),_)}k.reject=pe;function pe(_){var Z=new this(p);return v.reject(Z,_)}k.all=V;function V(_){var Z=this;if(Object.prototype.toString.call(_)!=="[object Array]")return this.reject(new TypeError("must be an array"));var K=_.length,Y=!1;if(!K)return this.resolve([]);for(var E=new Array(K),he=0,Ce=-1,Le=new this(p);++Ce<K;)Oe(_[Ce],Ce);return Le;function Oe(j,x){Z.resolve(j).then(q,function(oe){Y||(Y=!0,v.reject(Le,oe))});function q(oe){E[x]=oe,++he===K&&!Y&&(Y=!0,v.resolve(Le,E))}}}k.race=J;function J(_){var Z=this;if(Object.prototype.toString.call(_)!=="[object Array]")return this.reject(new TypeError("must be an array"));var K=_.length,Y=!1;if(!K)return this.resolve([]);for(var E=-1,he=new this(p);++E<K;)Ce(_[E]);return he;function Ce(Le){Z.resolve(Le).then(function(Oe){Y||(Y=!0,v.resolve(he,Oe))},function(Oe){Y||(Y=!0,v.reject(he,Oe))})}}},{1:1}],3:[function(i,s,h){(function(o){typeof o.Promise!="function"&&(o.Promise=i(2))}).call(this,typeof Tt<"u"?Tt:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(i,s,h){var o=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function p(t,c){if(!(t instanceof c))throw new TypeError("Cannot call a class as a function")}function v(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var P=v();function S(){try{if(!P||!P.open)return!1;var t=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),c=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!t||c)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function F(t,c){t=t||[],c=c||{};try{return new Blob(t,c)}catch(l){if(l.name!=="TypeError")throw l;for(var r=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,d=new r,f=0;f<t.length;f+=1)d.append(t[f]);return d.getBlob(c.type)}}typeof Promise>"u"&&i(3);var k=Promise;function w(t,c){c&&t.then(function(r){c(null,r)},function(r){c(r)})}function R(t,c,r){typeof c=="function"&&t.then(c),typeof r=="function"&&t.catch(r)}function ue(t){return typeof t!="string"&&(console.warn(t+" used as a key, but it is not a string."),t=String(t)),t}function ve(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var ee="local-forage-detect-blob-support",te=void 0,pe={},V=Object.prototype.toString,J="readonly",_="readwrite";function Z(t){for(var c=t.length,r=new ArrayBuffer(c),d=new Uint8Array(r),f=0;f<c;f++)d[f]=t.charCodeAt(f);return r}function K(t){return new k(function(c){var r=t.transaction(ee,_),d=F([""]);r.objectStore(ee).put(d,"key"),r.onabort=function(f){f.preventDefault(),f.stopPropagation(),c(!1)},r.oncomplete=function(){var f=navigator.userAgent.match(/Chrome\/(\d+)/),l=navigator.userAgent.match(/Edge\//);c(l||!f||parseInt(f[1],10)>=43)}}).catch(function(){return!1})}function Y(t){return typeof te=="boolean"?k.resolve(te):K(t).then(function(c){return te=c,te})}function E(t){var c=pe[t.name],r={};r.promise=new k(function(d,f){r.resolve=d,r.reject=f}),c.deferredOperations.push(r),c.dbReady?c.dbReady=c.dbReady.then(function(){return r.promise}):c.dbReady=r.promise}function he(t){var c=pe[t.name],r=c.deferredOperations.pop();if(r)return r.resolve(),r.promise}function Ce(t,c){var r=pe[t.name],d=r.deferredOperations.pop();if(d)return d.reject(c),d.promise}function Le(t,c){return new k(function(r,d){if(pe[t.name]=pe[t.name]||Se(),t.db)if(c)E(t),t.db.close();else return r(t.db);var f=[t.name];c&&f.push(t.version);var l=P.open.apply(P,f);c&&(l.onupgradeneeded=function(I){var O=l.result;try{O.createObjectStore(t.storeName),I.oldVersion<=1&&O.createObjectStore(ee)}catch(U){if(U.name==="ConstraintError")console.warn('The database "'+t.name+'" has been upgraded from version '+I.oldVersion+" to version "+I.newVersion+', but the storage "'+t.storeName+'" already exists.');else throw U}}),l.onerror=function(I){I.preventDefault(),d(l.error)},l.onsuccess=function(){var I=l.result;I.onversionchange=function(O){O.target.close()},r(I),he(t)}})}function Oe(t){return Le(t,!1)}function j(t){return Le(t,!0)}function x(t,c){if(!t.db)return!0;var r=!t.db.objectStoreNames.contains(t.storeName),d=t.version<t.db.version,f=t.version>t.db.version;if(d&&(t.version!==c&&console.warn('The database "'+t.name+`" can't be downgraded from version `+t.db.version+" to version "+t.version+"."),t.version=t.db.version),f||r){if(r){var l=t.db.version+1;l>t.version&&(t.version=l)}return!0}return!1}function q(t){return new k(function(c,r){var d=new FileReader;d.onerror=r,d.onloadend=function(f){var l=btoa(f.target.result||"");c({__local_forage_encoded_blob:!0,data:l,type:t.type})},d.readAsBinaryString(t)})}function oe(t){var c=Z(atob(t.data));return F([c],{type:t.type})}function ce(t){return t&&t.__local_forage_encoded_blob}function me(t){var c=this,r=c._initReady().then(function(){var d=pe[c._dbInfo.name];if(d&&d.dbReady)return d.dbReady});return R(r,t,t),r}function fe(t){E(t);for(var c=pe[t.name],r=c.forages,d=0;d<r.length;d++){var f=r[d];f._dbInfo.db&&(f._dbInfo.db.close(),f._dbInfo.db=null)}return t.db=null,Oe(t).then(function(l){return t.db=l,x(t)?j(t):l}).then(function(l){t.db=c.db=l;for(var I=0;I<r.length;I++)r[I]._dbInfo.db=l}).catch(function(l){throw Ce(t,l),l})}function Ee(t,c,r,d){d===void 0&&(d=1);try{var f=t.db.transaction(t.storeName,c);r(null,f)}catch(l){if(d>0&&(!t.db||l.name==="InvalidStateError"||l.name==="NotFoundError"))return k.resolve().then(function(){if(!t.db||l.name==="NotFoundError"&&!t.db.objectStoreNames.contains(t.storeName)&&t.version<=t.db.version)return t.db&&(t.version=t.db.version+1),j(t)}).then(function(){return fe(t).then(function(){Ee(t,c,r,d-1)})}).catch(r);r(l)}}function Se(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function re(t){var c=this,r={db:null};if(t)for(var d in t)r[d]=t[d];var f=pe[r.name];f||(f=Se(),pe[r.name]=f),f.forages.push(c),c._initReady||(c._initReady=c.ready,c.ready=me);var l=[];function I(){return k.resolve()}for(var O=0;O<f.forages.length;O++){var U=f.forages[O];U!==c&&l.push(U._initReady().catch(I))}var $=f.forages.slice(0);return k.all(l).then(function(){return r.db=f.db,Oe(r)}).then(function(z){return r.db=z,x(r,c._defaultConfig.version)?j(r):z}).then(function(z){r.db=f.db=z,c._dbInfo=r;for(var ae=0;ae<$.length;ae++){var ge=$[ae];ge!==c&&(ge._dbInfo.db=r.db,ge._dbInfo.version=r.version)}})}function je(t,c){var r=this;t=ue(t);var d=new k(function(f,l){r.ready().then(function(){Ee(r._dbInfo,J,function(I,O){if(I)return l(I);try{var U=O.objectStore(r._dbInfo.storeName),$=U.get(t);$.onsuccess=function(){var z=$.result;z===void 0&&(z=null),ce(z)&&(z=oe(z)),f(z)},$.onerror=function(){l($.error)}}catch(z){l(z)}})}).catch(l)});return w(d,c),d}function Pe(t,c){var r=this,d=new k(function(f,l){r.ready().then(function(){Ee(r._dbInfo,J,function(I,O){if(I)return l(I);try{var U=O.objectStore(r._dbInfo.storeName),$=U.openCursor(),z=1;$.onsuccess=function(){var ae=$.result;if(ae){var ge=ae.value;ce(ge)&&(ge=oe(ge));var ke=t(ge,ae.key,z++);ke!==void 0?f(ke):ae.continue()}else f()},$.onerror=function(){l($.error)}}catch(ae){l(ae)}})}).catch(l)});return w(d,c),d}function C(t,c,r){var d=this;t=ue(t);var f=new k(function(l,I){var O;d.ready().then(function(){return O=d._dbInfo,V.call(c)==="[object Blob]"?Y(O.db).then(function(U){return U?c:q(c)}):c}).then(function(U){Ee(d._dbInfo,_,function($,z){if($)return I($);try{var ae=z.objectStore(d._dbInfo.storeName);U===null&&(U=void 0);var ge=ae.put(U,t);z.oncomplete=function(){U===void 0&&(U=null),l(U)},z.onabort=z.onerror=function(){var ke=ge.error?ge.error:ge.transaction.error;I(ke)}}catch(ke){I(ke)}})}).catch(I)});return w(f,r),f}function X(t,c){var r=this;t=ue(t);var d=new k(function(f,l){r.ready().then(function(){Ee(r._dbInfo,_,function(I,O){if(I)return l(I);try{var U=O.objectStore(r._dbInfo.storeName),$=U.delete(t);O.oncomplete=function(){f()},O.onerror=function(){l($.error)},O.onabort=function(){var z=$.error?$.error:$.transaction.error;l(z)}}catch(z){l(z)}})}).catch(l)});return w(d,c),d}function se(t){var c=this,r=new k(function(d,f){c.ready().then(function(){Ee(c._dbInfo,_,function(l,I){if(l)return f(l);try{var O=I.objectStore(c._dbInfo.storeName),U=O.clear();I.oncomplete=function(){d()},I.onabort=I.onerror=function(){var $=U.error?U.error:U.transaction.error;f($)}}catch($){f($)}})}).catch(f)});return w(r,t),r}function le(t){var c=this,r=new k(function(d,f){c.ready().then(function(){Ee(c._dbInfo,J,function(l,I){if(l)return f(l);try{var O=I.objectStore(c._dbInfo.storeName),U=O.count();U.onsuccess=function(){d(U.result)},U.onerror=function(){f(U.error)}}catch($){f($)}})}).catch(f)});return w(r,t),r}function be(t,c){var r=this,d=new k(function(f,l){if(t<0){f(null);return}r.ready().then(function(){Ee(r._dbInfo,J,function(I,O){if(I)return l(I);try{var U=O.objectStore(r._dbInfo.storeName),$=!1,z=U.openKeyCursor();z.onsuccess=function(){var ae=z.result;if(!ae){f(null);return}t===0||$?f(ae.key):($=!0,ae.advance(t))},z.onerror=function(){l(z.error)}}catch(ae){l(ae)}})}).catch(l)});return w(d,c),d}function ne(t){var c=this,r=new k(function(d,f){c.ready().then(function(){Ee(c._dbInfo,J,function(l,I){if(l)return f(l);try{var O=I.objectStore(c._dbInfo.storeName),U=O.openKeyCursor(),$=[];U.onsuccess=function(){var z=U.result;if(!z){d($);return}$.push(z.key),z.continue()},U.onerror=function(){f(U.error)}}catch(z){f(z)}})}).catch(f)});return w(r,t),r}function Te(t,c){c=ve.apply(this,arguments);var r=this.config();t=typeof t!="function"&&t||{},t.name||(t.name=t.name||r.name,t.storeName=t.storeName||r.storeName);var d=this,f;if(!t.name)f=k.reject("Invalid arguments");else{var l=t.name===r.name&&d._dbInfo.db,I=l?k.resolve(d._dbInfo.db):Oe(t).then(function(O){var U=pe[t.name],$=U.forages;U.db=O;for(var z=0;z<$.length;z++)$[z]._dbInfo.db=O;return O});t.storeName?f=I.then(function(O){if(O.objectStoreNames.contains(t.storeName)){var U=O.version+1;E(t);var $=pe[t.name],z=$.forages;O.close();for(var ae=0;ae<z.length;ae++){var ge=z[ae];ge._dbInfo.db=null,ge._dbInfo.version=U}var ke=new k(function(xe,De){var _e=P.open(t.name,U);_e.onerror=function(He){var St=_e.result;St.close(),De(He)},_e.onupgradeneeded=function(){var He=_e.result;He.deleteObjectStore(t.storeName)},_e.onsuccess=function(){var He=_e.result;He.close(),xe(He)}});return ke.then(function(xe){$.db=xe;for(var De=0;De<z.length;De++){var _e=z[De];_e._dbInfo.db=xe,he(_e._dbInfo)}}).catch(function(xe){throw(Ce(t,xe)||k.resolve()).catch(function(){}),xe})}}):f=I.then(function(O){E(t);var U=pe[t.name],$=U.forages;O.close();for(var z=0;z<$.length;z++){var ae=$[z];ae._dbInfo.db=null}var ge=new k(function(ke,xe){var De=P.deleteDatabase(t.name);De.onerror=function(){var _e=De.result;_e&&_e.close(),xe(De.error)},De.onblocked=function(){console.warn('dropInstance blocked for database "'+t.name+'" until all open connections are closed')},De.onsuccess=function(){var _e=De.result;_e&&_e.close(),ke(_e)}});return ge.then(function(ke){U.db=ke;for(var xe=0;xe<$.length;xe++){var De=$[xe];he(De._dbInfo)}}).catch(function(ke){throw(Ce(t,ke)||k.resolve()).catch(function(){}),ke})})}return w(f,c),f}var Ve={_driver:"asyncStorage",_initStorage:re,_support:S(),iterate:Pe,getItem:je,setItem:C,removeItem:X,clear:se,length:le,key:be,keys:ne,dropInstance:Te};function Be(){return typeof openDatabase=="function"}var $e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",it="~~local_forage_type~",Ke=/^~~local_forage_type~([^~]+)~/,Ae="__lfsc__:",rt=Ae.length,Je="arbf",at="blob",st="si08",ct="ui08",m="uic8",a="si16",D="si32",b="ur16",g="ui32",u="fl32",N="fl64",G=rt+Je.length,A=Object.prototype.toString;function B(t){var c=t.length*.75,r=t.length,d,f=0,l,I,O,U;t[t.length-1]==="="&&(c--,t[t.length-2]==="="&&c--);var $=new ArrayBuffer(c),z=new Uint8Array($);for(d=0;d<r;d+=4)l=$e.indexOf(t[d]),I=$e.indexOf(t[d+1]),O=$e.indexOf(t[d+2]),U=$e.indexOf(t[d+3]),z[f++]=l<<2|I>>4,z[f++]=(I&15)<<4|O>>2,z[f++]=(O&3)<<6|U&63;return $}function M(t){var c=new Uint8Array(t),r="",d;for(d=0;d<c.length;d+=3)r+=$e[c[d]>>2],r+=$e[(c[d]&3)<<4|c[d+1]>>4],r+=$e[(c[d+1]&15)<<2|c[d+2]>>6],r+=$e[c[d+2]&63];return c.length%3===2?r=r.substring(0,r.length-1)+"=":c.length%3===1&&(r=r.substring(0,r.length-2)+"=="),r}function H(t,c){var r="";if(t&&(r=A.call(t)),t&&(r==="[object ArrayBuffer]"||t.buffer&&A.call(t.buffer)==="[object ArrayBuffer]")){var d,f=Ae;t instanceof ArrayBuffer?(d=t,f+=Je):(d=t.buffer,r==="[object Int8Array]"?f+=st:r==="[object Uint8Array]"?f+=ct:r==="[object Uint8ClampedArray]"?f+=m:r==="[object Int16Array]"?f+=a:r==="[object Uint16Array]"?f+=b:r==="[object Int32Array]"?f+=D:r==="[object Uint32Array]"?f+=g:r==="[object Float32Array]"?f+=u:r==="[object Float64Array]"?f+=N:c(new Error("Failed to get type for BinaryArray"))),c(f+M(d))}else if(r==="[object Blob]"){var l=new FileReader;l.onload=function(){var I=it+t.type+"~"+M(this.result);c(Ae+at+I)},l.readAsArrayBuffer(t)}else try{c(JSON.stringify(t))}catch(I){console.error("Couldn't convert value into a JSON string: ",t),c(null,I)}}function T(t){if(t.substring(0,rt)!==Ae)return JSON.parse(t);var c=t.substring(G),r=t.substring(rt,G),d;if(r===at&&Ke.test(c)){var f=c.match(Ke);d=f[1],c=c.substring(f[0].length)}var l=B(c);switch(r){case Je:return l;case at:return F([l],{type:d});case st:return new Int8Array(l);case ct:return new Uint8Array(l);case m:return new Uint8ClampedArray(l);case a:return new Int16Array(l);case b:return new Uint16Array(l);case D:return new Int32Array(l);case g:return new Uint32Array(l);case u:return new Float32Array(l);case N:return new Float64Array(l);default:throw new Error("Unkown type: "+r)}}var ie={serialize:H,deserialize:T,stringToBuffer:B,bufferToString:M};function W(t,c,r,d){t.executeSql("CREATE TABLE IF NOT EXISTS "+c.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],r,d)}function L(t){var c=this,r={db:null};if(t)for(var d in t)r[d]=typeof t[d]!="string"?t[d].toString():t[d];var f=new k(function(l,I){try{r.db=openDatabase(r.name,String(r.version),r.description,r.size)}catch(O){return I(O)}r.db.transaction(function(O){W(O,r,function(){c._dbInfo=r,l()},function(U,$){I($)})},I)});return r.serializer=ie,f}function y(t,c,r,d,f,l){t.executeSql(r,d,f,function(I,O){O.code===O.SYNTAX_ERR?I.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[c.storeName],function(U,$){$.rows.length?l(U,O):W(U,c,function(){U.executeSql(r,d,f,l)},l)},l):l(I,O)},l)}function ye(t,c){var r=this;t=ue(t);var d=new k(function(f,l){r.ready().then(function(){var I=r._dbInfo;I.db.transaction(function(O){y(O,I,"SELECT * FROM "+I.storeName+" WHERE key = ? LIMIT 1",[t],function(U,$){var z=$.rows.length?$.rows.item(0).value:null;z&&(z=I.serializer.deserialize(z)),f(z)},function(U,$){l($)})})}).catch(l)});return w(d,c),d}function we(t,c){var r=this,d=new k(function(f,l){r.ready().then(function(){var I=r._dbInfo;I.db.transaction(function(O){y(O,I,"SELECT * FROM "+I.storeName,[],function(U,$){for(var z=$.rows,ae=z.length,ge=0;ge<ae;ge++){var ke=z.item(ge),xe=ke.value;if(xe&&(xe=I.serializer.deserialize(xe)),xe=t(xe,ke.key,ge+1),xe!==void 0){f(xe);return}}f()},function(U,$){l($)})})}).catch(l)});return w(d,c),d}function Ne(t,c,r,d){var f=this;t=ue(t);var l=new k(function(I,O){f.ready().then(function(){c===void 0&&(c=null);var U=c,$=f._dbInfo;$.serializer.serialize(c,function(z,ae){ae?O(ae):$.db.transaction(function(ge){y(ge,$,"INSERT OR REPLACE INTO "+$.storeName+" (key, value) VALUES (?, ?)",[t,z],function(){I(U)},function(ke,xe){O(xe)})},function(ge){if(ge.code===ge.QUOTA_ERR){if(d>0){I(Ne.apply(f,[t,U,r,d-1]));return}O(ge)}})})}).catch(O)});return w(l,r),l}function ze(t,c,r){return Ne.apply(this,[t,c,r,1])}function yt(t,c){var r=this;t=ue(t);var d=new k(function(f,l){r.ready().then(function(){var I=r._dbInfo;I.db.transaction(function(O){y(O,I,"DELETE FROM "+I.storeName+" WHERE key = ?",[t],function(){f()},function(U,$){l($)})})}).catch(l)});return w(d,c),d}function et(t){var c=this,r=new k(function(d,f){c.ready().then(function(){var l=c._dbInfo;l.db.transaction(function(I){y(I,l,"DELETE FROM "+l.storeName,[],function(){d()},function(O,U){f(U)})})}).catch(f)});return w(r,t),r}function Xe(t){var c=this,r=new k(function(d,f){c.ready().then(function(){var l=c._dbInfo;l.db.transaction(function(I){y(I,l,"SELECT COUNT(key) as c FROM "+l.storeName,[],function(O,U){var $=U.rows.item(0).c;d($)},function(O,U){f(U)})})}).catch(f)});return w(r,t),r}function Re(t,c){var r=this,d=new k(function(f,l){r.ready().then(function(){var I=r._dbInfo;I.db.transaction(function(O){y(O,I,"SELECT key FROM "+I.storeName+" WHERE id = ? LIMIT 1",[t+1],function(U,$){var z=$.rows.length?$.rows.item(0).key:null;f(z)},function(U,$){l($)})})}).catch(l)});return w(d,c),d}function Pt(t){var c=this,r=new k(function(d,f){c.ready().then(function(){var l=c._dbInfo;l.db.transaction(function(I){y(I,l,"SELECT key FROM "+l.storeName,[],function(O,U){for(var $=[],z=0;z<U.rows.length;z++)$.push(U.rows.item(z).key);d($)},function(O,U){f(U)})})}).catch(f)});return w(r,t),r}function bt(t){return new k(function(c,r){t.transaction(function(d){d.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(f,l){for(var I=[],O=0;O<l.rows.length;O++)I.push(l.rows.item(O).name);c({db:t,storeNames:I})},function(f,l){r(l)})},function(d){r(d)})})}function Me(t,c){c=ve.apply(this,arguments);var r=this.config();t=typeof t!="function"&&t||{},t.name||(t.name=t.name||r.name,t.storeName=t.storeName||r.storeName);var d=this,f;return t.name?f=new k(function(l){var I;t.name===r.name?I=d._dbInfo.db:I=openDatabase(t.name,"","",0),t.storeName?l({db:I,storeNames:[t.storeName]}):l(bt(I))}).then(function(l){return new k(function(I,O){l.db.transaction(function(U){function $(ke){return new k(function(xe,De){U.executeSql("DROP TABLE IF EXISTS "+ke,[],function(){xe()},function(_e,He){De(He)})})}for(var z=[],ae=0,ge=l.storeNames.length;ae<ge;ae++)z.push($(l.storeNames[ae]));k.all(z).then(function(){I()}).catch(function(ke){O(ke)})},function(U){O(U)})})}):f=k.reject("Invalid arguments"),w(f,c),f}var dt={_driver:"webSQLStorage",_initStorage:L,_support:Be(),iterate:we,getItem:ye,setItem:ze,removeItem:yt,clear:et,length:Xe,key:Re,keys:Pt,dropInstance:Me};function Bt(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function ft(t,c){var r=t.name+"/";return t.storeName!==c.storeName&&(r+=t.storeName+"/"),r}function Ye(){var t="_localforage_support_test";try{return localStorage.setItem(t,!0),localStorage.removeItem(t),!1}catch{return!0}}function xt(){return!Ye()||localStorage.length>0}function de(t){var c=this,r={};if(t)for(var d in t)r[d]=t[d];return r.keyPrefix=ft(t,c._defaultConfig),xt()?(c._dbInfo=r,r.serializer=ie,k.resolve()):k.reject()}function Fe(t){var c=this,r=c.ready().then(function(){for(var d=c._dbInfo.keyPrefix,f=localStorage.length-1;f>=0;f--){var l=localStorage.key(f);l.indexOf(d)===0&&localStorage.removeItem(l)}});return w(r,t),r}function qe(t,c){var r=this;t=ue(t);var d=r.ready().then(function(){var f=r._dbInfo,l=localStorage.getItem(f.keyPrefix+t);return l&&(l=f.serializer.deserialize(l)),l});return w(d,c),d}function Ie(t,c){var r=this,d=r.ready().then(function(){for(var f=r._dbInfo,l=f.keyPrefix,I=l.length,O=localStorage.length,U=1,$=0;$<O;$++){var z=localStorage.key($);if(z.indexOf(l)===0){var ae=localStorage.getItem(z);if(ae&&(ae=f.serializer.deserialize(ae)),ae=t(ae,z.substring(I),U++),ae!==void 0)return ae}}});return w(d,c),d}function Ue(t,c){var r=this,d=r.ready().then(function(){var f=r._dbInfo,l;try{l=localStorage.key(t)}catch{l=null}return l&&(l=l.substring(f.keyPrefix.length)),l});return w(d,c),d}function Qe(t){var c=this,r=c.ready().then(function(){for(var d=c._dbInfo,f=localStorage.length,l=[],I=0;I<f;I++){var O=localStorage.key(I);O.indexOf(d.keyPrefix)===0&&l.push(O.substring(d.keyPrefix.length))}return l});return w(r,t),r}function ot(t){var c=this,r=c.keys().then(function(d){return d.length});return w(r,t),r}function ht(t,c){var r=this;t=ue(t);var d=r.ready().then(function(){var f=r._dbInfo;localStorage.removeItem(f.keyPrefix+t)});return w(d,c),d}function Yn(t,c,r){var d=this;t=ue(t);var f=d.ready().then(function(){c===void 0&&(c=null);var l=c;return new k(function(I,O){var U=d._dbInfo;U.serializer.serialize(c,function($,z){if(z)O(z);else try{localStorage.setItem(U.keyPrefix+t,$),I(l)}catch(ae){(ae.name==="QuotaExceededError"||ae.name==="NS_ERROR_DOM_QUOTA_REACHED")&&O(ae),O(ae)}})})});return w(f,r),f}function qn(t,c){if(c=ve.apply(this,arguments),t=typeof t!="function"&&t||{},!t.name){var r=this.config();t.name=t.name||r.name,t.storeName=t.storeName||r.storeName}var d=this,f;return t.name?f=new k(function(l){t.storeName?l(ft(t,d._defaultConfig)):l(t.name+"/")}).then(function(l){for(var I=localStorage.length-1;I>=0;I--){var O=localStorage.key(I);O.indexOf(l)===0&&localStorage.removeItem(O)}}):f=k.reject("Invalid arguments"),w(f,c),f}var Hn={_driver:"localStorageWrapper",_initStorage:de,_support:Bt(),iterate:Ie,getItem:qe,setItem:Yn,removeItem:ht,clear:Fe,length:ot,key:Ue,keys:Qe,dropInstance:qn},Gn=function(c,r){return c===r||typeof c=="number"&&typeof r=="number"&&isNaN(c)&&isNaN(r)},Kn=function(c,r){for(var d=c.length,f=0;f<d;){if(Gn(c[f],r))return!0;f++}return!1},un=Array.isArray||function(t){return Object.prototype.toString.call(t)==="[object Array]"},Et={},dn={},mt={INDEXEDDB:Ve,WEBSQL:dt,LOCALSTORAGE:Hn},Xn=[mt.INDEXEDDB._driver,mt.WEBSQL._driver,mt.LOCALSTORAGE._driver],Ct=["dropInstance"],Rt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(Ct),Jn={description:"",driver:Xn.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Qn(t,c){t[c]=function(){var r=arguments;return t.ready().then(function(){return t[c].apply(t,r)})}}function Ut(){for(var t=1;t<arguments.length;t++){var c=arguments[t];if(c)for(var r in c)c.hasOwnProperty(r)&&(un(c[r])?arguments[0][r]=c[r].slice():arguments[0][r]=c[r])}return arguments[0]}var Zn=function(){function t(c){p(this,t);for(var r in mt)if(mt.hasOwnProperty(r)){var d=mt[r],f=d._driver;this[r]=f,Et[f]||this.defineDriver(d)}this._defaultConfig=Ut({},Jn),this._config=Ut({},this._defaultConfig,c),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return t.prototype.config=function(r){if((typeof r>"u"?"undefined":o(r))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var d in r){if(d==="storeName"&&(r[d]=r[d].replace(/\W/g,"_")),d==="version"&&typeof r[d]!="number")return new Error("Database version must be a number.");this._config[d]=r[d]}return"driver"in r&&r.driver?this.setDriver(this._config.driver):!0}else return typeof r=="string"?this._config[r]:this._config},t.prototype.defineDriver=function(r,d,f){var l=new k(function(I,O){try{var U=r._driver,$=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!r._driver){O($);return}for(var z=Rt.concat("_initStorage"),ae=0,ge=z.length;ae<ge;ae++){var ke=z[ae],xe=!Kn(Ct,ke);if((xe||r[ke])&&typeof r[ke]!="function"){O($);return}}var De=function(){for(var St=function(nr){return function(){var rr=new Error("Method "+nr+" is not implemented by the current driver"),fn=k.reject(rr);return w(fn,arguments[arguments.length-1]),fn}},$t=0,tr=Ct.length;$t<tr;$t++){var Ft=Ct[$t];r[Ft]||(r[Ft]=St(Ft))}};De();var _e=function(St){Et[U]&&console.info("Redefining LocalForage driver: "+U),Et[U]=r,dn[U]=St,I()};"_support"in r?r._support&&typeof r._support=="function"?r._support().then(_e,O):_e(!!r._support):_e(!0)}catch(He){O(He)}});return R(l,d,f),l},t.prototype.driver=function(){return this._driver||null},t.prototype.getDriver=function(r,d,f){var l=Et[r]?k.resolve(Et[r]):k.reject(new Error("Driver not found."));return R(l,d,f),l},t.prototype.getSerializer=function(r){var d=k.resolve(ie);return R(d,r),d},t.prototype.ready=function(r){var d=this,f=d._driverSet.then(function(){return d._ready===null&&(d._ready=d._initDriver()),d._ready});return R(f,r,r),f},t.prototype.setDriver=function(r,d,f){var l=this;un(r)||(r=[r]);var I=this._getSupportedDrivers(r);function O(){l._config.driver=l.driver()}function U(ae){return l._extend(ae),O(),l._ready=l._initStorage(l._config),l._ready}function $(ae){return function(){var ge=0;function ke(){for(;ge<ae.length;){var xe=ae[ge];return ge++,l._dbInfo=null,l._ready=null,l.getDriver(xe).then(U).catch(ke)}O();var De=new Error("No available storage method found.");return l._driverSet=k.reject(De),l._driverSet}return ke()}}var z=this._driverSet!==null?this._driverSet.catch(function(){return k.resolve()}):k.resolve();return this._driverSet=z.then(function(){var ae=I[0];return l._dbInfo=null,l._ready=null,l.getDriver(ae).then(function(ge){l._driver=ge._driver,O(),l._wrapLibraryMethodsWithReady(),l._initDriver=$(I)})}).catch(function(){O();var ae=new Error("No available storage method found.");return l._driverSet=k.reject(ae),l._driverSet}),R(this._driverSet,d,f),this._driverSet},t.prototype.supports=function(r){return!!dn[r]},t.prototype._extend=function(r){Ut(this,r)},t.prototype._getSupportedDrivers=function(r){for(var d=[],f=0,l=r.length;f<l;f++){var I=r[f];this.supports(I)&&d.push(I)}return d},t.prototype._wrapLibraryMethodsWithReady=function(){for(var r=0,d=Rt.length;r<d;r++)Qn(this,Rt[r])},t.prototype.createInstance=function(r){return new t(r)},t}(),er=new Zn;s.exports=er},{3:3}]},{},[4])(4)})})(xn);var ir=xn.exports;const Wt=or(ir);function At(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function Vt(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const sr=1,cr=1,ut="emoji",vt="keyvalue",rn="favorites",lr="tokens",Cn="tokens",ur="unicode",In="count",dr="group",fr="order",An="group-order",Jt="eTag",Mt="url",pn="skinTone",gt="readonly",an="readwrite",_n="skinUnicodes",hr="skinUnicodes",mr="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",pr="en";function vr(n,e){const i=new Set,s=[];for(const h of n){const o=e(h);i.has(o)||(i.add(o),s.push(h))}return s}function vn(n){return vr(n,e=>e.unicode)}function gr(n){function e(i,s,h){const o=s?n.createObjectStore(i,{keyPath:s}):n.createObjectStore(i);if(h)for(const[p,[v,P]]of Object.entries(h))o.createIndex(p,v,{multiEntry:P});return o}e(vt),e(ut,ur,{[Cn]:[lr,!0],[An]:[[dr,fr]],[_n]:[hr,!0]}),e(rn,void 0,{[In]:[""]})}const Qt={},Nt={},Ot={};function Dn(n,e,i){i.onerror=()=>e(i.error),i.onblocked=()=>e(new Error("IDB blocked")),i.onsuccess=()=>n(i.result)}async function yr(n){const e=await new Promise((i,s)=>{const h=indexedDB.open(n,sr);Qt[n]=h,h.onupgradeneeded=o=>{o.oldVersion<cr&&gr(h.result)},Dn(i,s,h)});return e.onclose=()=>on(n),e}function br(n){return Nt[n]||(Nt[n]=yr(n)),Nt[n]}function nt(n,e,i,s){return new Promise((h,o)=>{const p=n.transaction(e,i,{durability:"relaxed"}),v=typeof e=="string"?p.objectStore(e):e.map(S=>p.objectStore(S));let P;s(v,p,S=>{P=S}),p.oncomplete=()=>h(P),p.onerror=()=>o(p.error)})}function on(n){const e=Qt[n],i=e&&e.result;if(i){i.close();const s=Ot[n];if(s)for(const h of s)h()}delete Qt[n],delete Nt[n],delete Ot[n]}function Er(n){return new Promise((e,i)=>{on(n);const s=indexedDB.deleteDatabase(n);Dn(e,i,s)})}function Sr(n,e){let i=Ot[n];i||(i=Ot[n]=[]),i.push(e)}const wr=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function pt(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||wr.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const Tr=2;function Nn(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Tr)}function kr(n){return n.map(({annotation:i,emoticon:s,group:h,order:o,shortcodes:p,skins:v,tags:P,emoji:S,version:F})=>{const k=[...new Set(Nn([...(p||[]).map(pt).flat(),...P.map(pt).flat(),...pt(i),s]))].sort(),w={annotation:i,group:h,order:o,tags:P,tokens:k,unicode:S,version:F};if(s&&(w.emoticon=s),p&&(w.shortcodes=p),v){w.skinTones=[],w.skinUnicodes=[],w.skinVersions=[];for(const{tone:R,emoji:ue,version:ve}of v)w.skinTones.push(R),w.skinUnicodes.push(ue),w.skinVersions.push(ve)}return w})}function Ln(n,e,i,s){n[e](i).onsuccess=h=>s&&s(h.target.result)}function lt(n,e,i){Ln(n,"get",e,i)}function Mn(n,e,i){Ln(n,"getAll",e,i)}function sn(n){n.commit&&n.commit()}function xr(n,e){let i=n[0];for(let s=1;s<n.length;s++){const h=n[s];e(i)>e(h)&&(i=h)}return i}function On(n,e){const i=xr(n,h=>h.length),s=[];for(const h of i)n.some(o=>o.findIndex(p=>e(p)===e(h))===-1)||s.push(h);return s}async function Cr(n){return!await cn(n,vt,Mt)}async function Ir(n,e,i){const[s,h]=await Promise.all([Jt,Mt].map(o=>cn(n,vt,o)));return s===i&&h===e}async function Ar(n,e){return nt(n,ut,gt,(s,h,o)=>{let p;const v=()=>{s.getAll(p&&IDBKeyRange.lowerBound(p,!0),50).onsuccess=P=>{const S=P.target.result;for(const F of S)if(p=F.unicode,e(F))return o(F);if(S.length<50)return o();v()}};v()})}async function jn(n,e,i,s){try{const h=kr(e);await nt(n,[ut,vt],an,([o,p],v)=>{let P,S,F=0;function k(){++F===2&&w()}function w(){if(!(P===s&&S===i)){o.clear();for(const R of h)o.put(R);p.put(s,Jt),p.put(i,Mt),sn(v)}}lt(p,Jt,R=>{P=R,k()}),lt(p,Mt,R=>{S=R,k()})})}finally{}}async function _r(n,e){return nt(n,ut,gt,(i,s,h)=>{const o=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);Mn(i.index(An),o,h)})}async function Pn(n,e){const i=Nn(pt(e));return i.length?nt(n,ut,gt,(s,h,o)=>{const p=[],v=()=>{p.length===i.length&&P()},P=()=>{const S=On(p,F=>F.unicode);o(S.sort((F,k)=>F.order<k.order?-1:1))};for(let S=0;S<i.length;S++){const F=i[S],k=S===i.length-1?IDBKeyRange.bound(F,F+"￿",!1,!0):IDBKeyRange.only(F);Mn(s.index(Cn),k,w=>{p.push(w),v()})}}):[]}async function Dr(n,e){const i=await Pn(n,e);return i.length?i.filter(s=>(s.shortcodes||[]).map(o=>o.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Ar(n,h=>(h.shortcodes||[]).includes(e.toLowerCase()))||null}async function Nr(n,e){return nt(n,ut,gt,(i,s,h)=>lt(i,e,o=>{if(o)return h(o);lt(i.index(_n),e,p=>h(p||null))}))}function cn(n,e,i){return nt(n,e,gt,(s,h,o)=>lt(s,i,o))}function Lr(n,e,i,s){return nt(n,e,an,(h,o)=>{h.put(s,i),sn(o)})}function Mr(n,e){return nt(n,rn,an,(i,s)=>lt(i,e,h=>{i.put((h||0)+1,e),sn(s)}))}function Or(n,e,i){return i===0?[]:nt(n,[rn,ut],gt,([s,h],o,p)=>{const v=[];s.index(In).openCursor(void 0,"prev").onsuccess=P=>{const S=P.target.result;if(!S)return p(v);function F(R){if(v.push(R),v.length===i)return p(v);S.continue()}const k=S.primaryKey,w=e.byName(k);if(w)return F(w);lt(h,k,R=>{if(R)return F(R);S.continue()})}})}const _t="";function jr(n,e){const i=new Map;for(const h of n){const o=e(h);for(const p of o){let v=i;for(let S=0;S<p.length;S++){const F=p.charAt(S);let k=v.get(F);k||(k=new Map,v.set(F,k)),v=k}let P=v.get(_t);P||(P=[],v.set(_t,P)),P.push(h)}}return(h,o)=>{let p=i;for(let S=0;S<h.length;S++){const F=h.charAt(S),k=p.get(F);if(k)p=k;else return[]}if(o)return p.get(_t)||[];const v=[],P=[p];for(;P.length;){const F=[...P.shift().entries()].sort((k,w)=>k[0]<w[0]?-1:1);for(const[k,w]of F)k===_t?v.push(...w):P.push(w)}return v}}const Pr=["name","url"];function Br(n){const e=n&&Array.isArray(n),i=e&&n.length&&(!n[0]||Pr.some(s=>!(s in n[0])));if(!e||i)throw new Error("Custom emojis are in the wrong format")}function gn(n){Br(n);const e=(w,R)=>w.name.toLowerCase()<R.name.toLowerCase()?-1:1,i=n.sort(e),h=jr(n,w=>[...new Set((w.shortcodes||[]).map(R=>pt(R)).flat())]),o=w=>h(w,!0),p=w=>h(w,!1),v=w=>{const R=pt(w),ue=R.map((ve,ee)=>(ee<R.length-1?o:p)(ve));return On(ue,ve=>ve.name).sort(e)},P=new Map,S=new Map;for(const w of n){S.set(w.name.toLowerCase(),w);for(const R of w.shortcodes||[])P.set(R.toLowerCase(),w)}return{all:i,search:v,byShortcode:w=>P.get(w.toLowerCase()),byName:w=>S.get(w.toLowerCase())}}const Rr=typeof wrappedJSObject<"u";function wt(n){if(!n)return n;if(Rr&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let i=0;i<e;i++)n.skins[i]={tone:n.skinTones[i],unicode:n.skinUnicodes[i],version:n.skinVersions[i]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function Bn(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const Ur=["annotation","emoji","group","order","tags","version"];function $r(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||Ur.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function Rn(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function Fr(n){const e=await fetch(n,{method:"HEAD"});Rn(e,n);const i=e.headers.get("etag");return Bn(i),i}async function Zt(n){const e=await fetch(n);Rn(e,n);const i=e.headers.get("etag");Bn(i);const s=await e.json();return $r(s),[i,s]}function Wr(n){for(var e="",i=new Uint8Array(n),s=i.byteLength,h=-1;++h<s;)e+=String.fromCharCode(i[h]);return e}function Vr(n){for(var e=n.length,i=new ArrayBuffer(e),s=new Uint8Array(i),h=-1;++h<e;)s[h]=n.charCodeAt(h);return i}async function Un(n){const e=JSON.stringify(n);let i=Vr(e);const s=await crypto.subtle.digest("SHA-1",i),h=Wr(s);return btoa(h)}async function zr(n,e){let i,s=await Fr(e);if(!s){const h=await Zt(e);s=h[0],i=h[1],s||(s=await Un(i))}await Ir(n,e,s)||(i||(i=(await Zt(e))[1]),await jn(n,i,e,s))}async function Yr(n,e){let[i,s]=await Zt(e);i||(i=await Un(s)),await jn(n,s,e,i)}class qr{constructor({dataSource:e=mr,locale:i=pr,customEmoji:s=[]}={}){this.dataSource=e,this.locale=i,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=gn(s),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await br(this._dbName);Sr(this._dbName,this._clear);const i=this.dataSource;await Cr(e)?await Yr(e,i):this._lazyUpdate=zr(e,i)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return Vt(e),await this.ready(),vn(await _r(this._db,e)).map(wt)}async getEmojiBySearchQuery(e){At(e),await this.ready();const i=this._custom.search(e),s=vn(await Pn(this._db,e)).map(wt);return[...i,...s]}async getEmojiByShortcode(e){At(e),await this.ready();const i=this._custom.byShortcode(e);return i||wt(await Dr(this._db,e))}async getEmojiByUnicodeOrName(e){At(e),await this.ready();const i=this._custom.byName(e);return i||wt(await Nr(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await cn(this._db,vt,pn)||0}async setPreferredSkinTone(e){return Vt(e),await this.ready(),Lr(this._db,vt,pn,e)}async incrementFavoriteEmojiCount(e){return At(e),await this.ready(),Mr(this._db,e)}async getTopFavoriteEmoji(e){return Vt(e),await this.ready(),(await Or(this._db,this._custom,e)).map(wt)}set customEmoji(e){this._custom=gn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await on(this._dbName)}async delete(){await this._shutdown(),await Er(this._dbName)}}const en=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([n,e,i])=>({id:n,emoji:e,name:i})),zt=en.slice(1),Hr=2,yn=6,$n=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function bn(n){return n.unicode.includes("‍")}const Gr={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},Kr=1e3,Xr="🖐️",Jr=8,Qr=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],Fn='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',Zr=(n,e)=>n<e?-1:n>e?1:0,En=(n,e)=>{const i=document.createElement("canvas");i.width=i.height=1;const s=i.getContext("2d");return s.textBaseline="top",s.font=`100px ${Fn}`,s.fillStyle=e,s.scale(.01,.01),s.fillText(n,0,0),s.getImageData(0,0,1,1).data},ea=(n,e)=>{const i=[...n].join(","),s=[...e].join(",");return i===s&&!i.startsWith("0,0,0,")};function ta(n){const e=En(n,"#000"),i=En(n,"#fff");return e&&i&&ea(e,i)}function na(){const n=Object.entries(Gr);try{for(const[e,i]of n)if(ta(e))return i}catch{}finally{}return n[0][1]}let Yt;const qt=()=>(Yt||(Yt=new Promise(n=>$n(()=>n(na())))),Yt),tn=new Map,ra="️",aa="\uD83C",oa="‍",ia=127995,sa=57339;function ca(n,e){if(e===0)return n;const i=n.indexOf(oa);return i!==-1?n.substring(0,i)+String.fromCodePoint(ia+e-1)+n.substring(i):(n.endsWith(ra)&&(n=n.substring(0,n.length-1)),n+aa+String.fromCodePoint(sa+e-1))}function Ze(n){n.preventDefault(),n.stopPropagation()}function Ht(n,e,i){return e+=n?-1:1,e<0?e=i.length-1:e>=i.length&&(e=0),e}function Wn(n,e){const i=new Set,s=[];for(const h of n){const o=e(h);i.has(o)||(i.add(o),s.push(h))}return s}function la(n,e){const i=s=>{const h={};for(const o of s)typeof o.tone=="number"&&o.version<=e&&(h[o.tone]=o.unicode);return h};return n.map(({unicode:s,skins:h,shortcodes:o,url:p,name:v,category:P,annotation:S})=>({unicode:s,name:v,shortcodes:o,url:p,category:P,annotation:S,id:s||v,skins:h&&i(h)}))}const Lt=requestAnimationFrame;let ua=typeof ResizeObserver=="function";function da(n,e,i){let s;ua?(s=new ResizeObserver(h=>i(h[0].contentRect.width)),s.observe(n)):Lt(()=>i(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{s&&s.disconnect()})}function Sn(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let Gt;function fa(n,e,i){for(const s of n){const h=i(s),o=Sn(h);typeof Gt>"u"&&(Gt=Sn(e));const p=o/1.8<Gt;tn.set(s.unicode,p)}}function ha(n){return Wn(n,e=>e)}function ma(n){n&&(n.scrollTop=0)}function kt(n,e,i){let s=n.get(e);return s||(s=i(),n.set(e,s)),s}function wn(n){return""+n}function pa(n){const e=document.createElement("template");return e.innerHTML=n,e}const va=new WeakMap,ga=new WeakMap,ya=Symbol("un-keyed"),ba="replaceChildren"in Element.prototype;function Ea(n,e){ba?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function Sa(n,e){let i=n.firstChild,s=0;for(;i;){if(e[s]!==i)return!0;i=i.nextSibling,s++}return s!==e.length}function wa(n,e){const{targetNode:i}=e;let{targetParentNode:s}=e,h=!1;s?h=Sa(s,n):(h=!0,e.targetNode=void 0,e.targetParentNode=s=i.parentNode),h&&Ea(s,n)}function Ta(n,e){for(const i of e){const{targetNode:s,currentExpression:h,binding:{expressionIndex:o,attributeName:p,attributeValuePre:v,attributeValuePost:P}}=i,S=n[o];if(h!==S)if(i.currentExpression=S,p)s.setAttribute(p,v+wn(S)+P);else{let F;Array.isArray(S)?wa(S,i):S instanceof Element?(F=S,s.replaceWith(F)):s.nodeValue=wn(S),F&&(i.targetNode=F)}}}function ka(n){let e="",i=!1,s=!1,h=-1;const o=new Map,p=[];for(let P=0,S=n.length;P<S;P++){const F=n[P];if(e+=F,P===S-1)break;for(let te=0;te<F.length;te++)switch(F.charAt(te)){case"<":{F.charAt(te+1)==="/"?p.pop():(i=!0,p.push(++h));break}case">":{i=!1,s=!1;break}case"=":{s=!0;break}}const k=p[p.length-1],w=kt(o,k,()=>[]);let R,ue,ve;if(s){const te=/(\S+)="?([^"=]*)$/.exec(F);R=te[1],ue=te[2],ve=/^[^">]*/.exec(n[P+1])[0]}const ee={attributeName:R,attributeValuePre:ue,attributeValuePost:ve,expressionIndex:P};w.push(ee),!i&&!s&&(e+=" ")}return{template:pa(e),elementsToBindings:o}}function xa(n,e){const i=[],s=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let h=n,o=-1;do{const p=e.get(++o);if(p)for(let v=0;v<p.length;v++){const P=p[v],S=P.attributeName?h:h.firstChild,F={binding:P,targetNode:S,targetParentNode:void 0,currentExpression:void 0};i.push(F)}}while(h=s.nextNode());return i}function Ca(n){const{template:e,elementsToBindings:i}=kt(va,n,()=>ka(n)),s=e.cloneNode(!0).content.firstElementChild,h=xa(s,i);return function(p){return Ta(p,h),s}}function Ia(n){const e=kt(ga,n,()=>new Map);let i=ya;function s(o,...p){const v=kt(e,o,()=>new Map);return kt(v,i,()=>Ca(o))(p)}function h(o,p,v){return o.map((P,S)=>{const F=i;i=v(P);try{return p(P,S)}finally{i=F}})}return{map:h,html:s}}function Aa(n,e,i,s,h,o,p,v){const{labelWithSkin:P,titleForEmoji:S,unicodeWithSkin:F}=i,{html:k,map:w}=Ia(e);function R(ee,te,pe){return w(ee,(V,J)=>k`<button role="${te?"option":"menuitem"}" aria-selected="${e.searchMode?J===e.activeSearchItem:""}" aria-label="${P(V,e.currentSkinTone)}" title="${S(V)}" class="emoji ${te&&J===e.activeSearchItem?"active":""}" id="${`${pe}-${V.id}`}">${V.unicode?F(V,e.currentSkinTone):k`<img class="custom-emoji" src="${V.url}" alt="" loading="lazy">`}</button>`,V=>`${pe}-${V.id}`)}const ve=k`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${w(e.skinTones,(ee,te)=>k`<div id="skintone-${te}" class="emoji ${te===e.activeSkinTone?"active":""}" aria-selected="${te===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[te]}" aria-label="${e.i18n.skinTones[te]}">${ee}</div>`,ee=>ee)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${w(e.groups,ee=>k`<button role="tab" class="nav-button" aria-controls="tab-${ee.id}" aria-label="${e.i18n.categories[ee.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===ee.id}" title="${e.i18n.categories[ee.name]}" data-group-id="${ee.id}"><div class="nav-emoji emoji">${ee.emoji}</div></button>`,ee=>ee.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${w(e.currentEmojisWithCategories,(ee,te)=>k`<div><div id="menu-label-${te}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:ee.category?ee.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${te}" id="${e.searchMode?"search-results":""}">${R(ee.emojis,e.searchMode,"emo")}</div></div>`,ee=>ee.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${R(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(v){n.appendChild(ve);const ee=(te,pe)=>{for(const V of n.querySelectorAll(`[${te}]`))pe(V,V.getAttribute(te))};for(const te of["click","focusout","input","keydown","keyup"])ee(`data-on-${te}`,(pe,V)=>{pe.addEventListener(te,s[V])});ee("data-ref",(te,pe)=>{o[pe]=te}),ee("data-action",(te,pe)=>{h[pe](te)}),p.addEventListener("abort",()=>{n.removeChild(ve)})}}const jt=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function _a(n){let e=!1,i;const s=new Map,h=new Set;let o;const p=()=>{if(e)return;const S=[...h];h.clear();try{for(const F of S)F()}finally{o=!1,h.size&&(o=!0,jt(p))}},v=new Proxy({},{get(S,F){if(i){let k=s.get(F);k||(k=new Set,s.set(F,k)),k.add(i)}return S[F]},set(S,F,k){S[F]=k;const w=s.get(F);if(w){for(const R of w)h.add(R);o||(o=!0,jt(p))}return!0}}),P=S=>{const F=()=>{const k=i;i=F;try{return S()}finally{i=k}};return F()};return n.addEventListener("abort",()=>{e=!0}),{state:v,createEffect:P}}function Kt(n,e,i){if(n.length!==e.length)return!1;for(let s=0;s<n.length;s++)if(!i(n[s],e[s]))return!1;return!0}const Xt=[],{assign:Dt}=Object;function Da(n,e){const i={},s=new AbortController,h=s.signal,{state:o,createEffect:p}=_a(h);Dt(o,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),Dt(o,e),Dt(o,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:Jr,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:zt,databaseLoaded:!1,activeSearchItemId:void 0}),p(()=>{o.currentGroup!==o.groups[o.currentGroupIndex]&&(o.currentGroup=o.groups[o.currentGroupIndex])});const v=C=>{n.getElementById(C).focus()},P=C=>n.getElementById(`emo-${C.id}`),S=(C,X)=>{i.rootElement.dispatchEvent(new CustomEvent(C,{detail:X,bubbles:!0,composed:!0}))},F=(C,X)=>C.id===X.id,k=(C,X)=>{const{category:se,emojis:le}=C,{category:be,emojis:ne}=X;return se!==be?!1:Kt(le,ne,F)},w=C=>{Kt(o.currentEmojis,C,F)||(o.currentEmojis=C)},R=C=>{o.searchMode!==C&&(o.searchMode=C)},ue=C=>{Kt(o.currentEmojisWithCategories,C,k)||(o.currentEmojisWithCategories=C)},ve=(C,X)=>X&&C.skins&&C.skins[X]||C.unicode,pe={labelWithSkin:(C,X)=>ha([C.name||ve(C,X),C.annotation,...C.shortcodes||Xt].filter(Boolean)).join(", "),titleForEmoji:C=>C.annotation||(C.shortcodes||Xt).join(", "),unicodeWithSkin:ve},V={onClickSkinToneButton:Ee,onEmojiClick:ce,onNavClick:x,onNavKeydown:q,onSearchKeydown:j,onSkinToneOptionsClick:fe,onSkinToneOptionsFocusOut:je,onSkinToneOptionsKeydown:Se,onSkinToneOptionsKeyup:re,onSearchInput:Pe},J={calculateEmojiGridStyle:K};let _=!0;p(()=>{Aa(n,o,pe,V,J,i,h,_),_=!1}),o.emojiVersion||qt().then(C=>{C||(o.message=o.i18n.emojiUnsupportedMessage)}),p(()=>{async function C(){let X=!1;const se=setTimeout(()=>{X=!0,o.message=o.i18n.loadingMessage},Kr);try{await o.database.ready(),o.databaseLoaded=!0}catch(le){console.error(le),o.message=o.i18n.networkErrorMessage}finally{clearTimeout(se),X&&(X=!1,o.message="")}}o.database&&C()}),p(()=>{o.pickerStyle=`
      --num-groups: ${o.groups.length}; 
      --indicator-opacity: ${o.searchMode?0:1}; 
      --num-skintones: ${yn};`}),p(()=>{o.customEmoji&&o.database&&Z()}),p(()=>{o.customEmoji&&o.customEmoji.length?o.groups!==en&&(o.groups=en):o.groups!==zt&&(o.currentGroupIndex&&o.currentGroupIndex--,o.groups=zt)}),p(()=>{async function C(){o.databaseLoaded&&(o.currentSkinTone=await o.database.getPreferredSkinTone())}C()}),p(()=>{o.skinTones=Array(yn).fill().map((C,X)=>ca(o.skinToneEmoji,X))}),p(()=>{o.skinToneButtonText=o.skinTones[o.currentSkinTone]}),p(()=>{o.skinToneButtonLabel=o.i18n.skinToneLabel.replace("{skinTone}",o.i18n.skinTones[o.currentSkinTone])}),p(()=>{async function C(){const{database:X}=o,se=(await Promise.all(Qr.map(le=>X.getEmojiByUnicodeOrName(le)))).filter(Boolean);o.defaultFavoriteEmojis=se}o.databaseLoaded&&C()});function Z(){o.database.customEmoji=o.customEmoji||Xt}p(()=>{async function C(){Z();const{database:X,defaultFavoriteEmojis:se,numColumns:le}=o,be=await X.getTopFavoriteEmoji(le),ne=await Ce(Wn([...be,...se],Te=>Te.unicode||Te.name).slice(0,le));o.currentFavorites=ne}o.databaseLoaded&&o.defaultFavoriteEmojis&&C()});function K(C){da(C,h,X=>{{const se=getComputedStyle(i.rootElement),le=parseInt(se.getPropertyValue("--num-columns"),10),be=se.getPropertyValue("direction")==="rtl",Te=C.parentElement.getBoundingClientRect().width-X;o.numColumns=le,o.scrollbarWidth=Te,o.isRtl=be}})}p(()=>{async function C(){const{searchText:X,currentGroup:se,databaseLoaded:le,customEmoji:be}=o;if(!le)o.currentEmojis=[],o.searchMode=!1;else if(X.length>=Hr){const ne=await Oe(X);o.searchText===X&&(w(ne),R(!0))}else{const{id:ne}=se;if(ne!==-1||be&&be.length){const Te=await Le(ne);o.currentGroup.id===ne&&(w(Te),R(!1))}}}C()}),p(()=>{const{currentEmojis:C,emojiVersion:X}=o,se=C.filter(le=>le.unicode).filter(le=>bn(le)&&!tn.has(le.unicode));if(!X&&se.length)w(C),Lt(()=>Y(se));else{const le=X?C:C.filter(E);w(le),Lt(()=>ma(i.tabpanelElement))}});function Y(C){fa(C,i.baselineEmoji,P),o.currentEmojis=o.currentEmojis}function E(C){return!C.unicode||!bn(C)||tn.get(C.unicode)}async function he(C){const X=o.emojiVersion||await qt();return C.filter(({version:se})=>!se||se<=X)}async function Ce(C){return la(C,o.emojiVersion||await qt())}async function Le(C){const X=C===-1?o.customEmoji:await o.database.getEmojiByGroup(C);return Ce(await he(X))}async function Oe(C){return Ce(await he(await o.database.getEmojiBySearchQuery(C)))}p(()=>{}),p(()=>{function C(){const{searchMode:se,currentEmojis:le}=o;if(se)return[{category:"",emojis:le}];const be=new Map;for(const ne of le){const Te=ne.category||"";let Ve=be.get(Te);Ve||(Ve=[],be.set(Te,Ve)),Ve.push(ne)}return[...be.entries()].map(([ne,Te])=>({category:ne,emojis:Te})).sort((ne,Te)=>o.customCategorySorting(ne.category,Te.category))}const X=C();ue(X)}),p(()=>{o.activeSearchItemId=o.activeSearchItem!==-1&&o.currentEmojis[o.activeSearchItem].id}),p(()=>{const{rawSearchText:C}=o;$n(()=>{o.searchText=(C||"").trim(),o.activeSearchItem=-1})});function j(C){if(!o.searchMode||!o.currentEmojis.length)return;const X=se=>{Ze(C),o.activeSearchItem=Ht(se,o.activeSearchItem,o.currentEmojis)};switch(C.key){case"ArrowDown":return X(!1);case"ArrowUp":return X(!0);case"Enter":if(o.activeSearchItem===-1)o.activeSearchItem=0;else return Ze(C),oe(o.currentEmojis[o.activeSearchItem].id)}}function x(C){const{target:X}=C,se=X.closest(".nav-button");if(!se)return;const le=parseInt(se.dataset.groupId,10);i.searchElement.value="",o.rawSearchText="",o.searchText="",o.activeSearchItem=-1,o.currentGroupIndex=o.groups.findIndex(be=>be.id===le)}function q(C){const{target:X,key:se}=C,le=be=>{be&&(Ze(C),be.focus())};switch(se){case"ArrowLeft":return le(X.previousElementSibling);case"ArrowRight":return le(X.nextElementSibling);case"Home":return le(X.parentElement.firstElementChild);case"End":return le(X.parentElement.lastElementChild)}}async function oe(C){const X=await o.database.getEmojiByUnicodeOrName(C),se=[...o.currentEmojis,...o.currentFavorites].find(be=>be.id===C),le=se.unicode&&ve(se,o.currentSkinTone);await o.database.incrementFavoriteEmojiCount(C),S("emoji-click",{emoji:X,skinTone:o.currentSkinTone,...le&&{unicode:le},...se.name&&{name:se.name}})}async function ce(C){const{target:X}=C;if(!X.classList.contains("emoji"))return;Ze(C);const se=X.id.substring(4);oe(se)}function me(C){o.currentSkinTone=C,o.skinTonePickerExpanded=!1,v("skintone-button"),S("skin-tone-change",{skinTone:C}),o.database.setPreferredSkinTone(C)}function fe(C){const{target:{id:X}}=C,se=X&&X.match(/^skintone-(\d)/);if(!se)return;Ze(C);const le=parseInt(se[1],10);me(le)}function Ee(C){o.skinTonePickerExpanded=!o.skinTonePickerExpanded,o.activeSkinTone=o.currentSkinTone,o.skinTonePickerExpanded&&(Ze(C),Lt(()=>v("skintone-list")))}p(()=>{o.skinTonePickerExpanded?i.skinToneDropdown.addEventListener("transitionend",()=>{o.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):o.skinTonePickerExpandedAfterAnimation=!1});function Se(C){if(!o.skinTonePickerExpanded)return;const X=async se=>{Ze(C),o.activeSkinTone=se};switch(C.key){case"ArrowUp":return X(Ht(!0,o.activeSkinTone,o.skinTones));case"ArrowDown":return X(Ht(!1,o.activeSkinTone,o.skinTones));case"Home":return X(0);case"End":return X(o.skinTones.length-1);case"Enter":return Ze(C),me(o.activeSkinTone);case"Escape":return Ze(C),o.skinTonePickerExpanded=!1,v("skintone-button")}}function re(C){if(o.skinTonePickerExpanded)switch(C.key){case" ":return Ze(C),me(o.activeSkinTone)}}async function je(C){const{relatedTarget:X}=C;(!X||X.id!=="skintone-list")&&(o.skinTonePickerExpanded=!1)}function Pe(C){o.rawSearchText=C.target.value}return{$set(C){Dt(o,C)},$destroy(){s.abort()}}}const Na="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",La="en";var Ma={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Oa=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const Vn=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],ja=`:host{--emoji-font-family:${Fn}}`;class ln extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const i=document.createElement("style");i.textContent=Oa+ja,this.shadowRoot.appendChild(i),this._ctx={locale:La,dataSource:Na,skinToneEmoji:Xr,customCategorySorting:Zr,customEmoji:null,i18n:Ma,emojiVersion:null,...e};for(const s of Vn)s!=="database"&&Object.prototype.hasOwnProperty.call(this,s)&&(this._ctx[s]=this[s],delete this[s]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Da(this.shadowRoot,this._ctx))}disconnectedCallback(){jt(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(i=>console.error(i))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,i,s){this._set(e.replace(/-([a-z])/g,(h,o)=>o.toUpperCase()),e==="emoji-version"?parseFloat(s):s)}_set(e,i){this._ctx[e]=i,this._cmp&&this._cmp.$set({[e]:i}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:i,database:s}=this._ctx;(!s||s.locale!==e||s.dataSource!==i)&&this._set("database",new qr({locale:e,dataSource:i}))}_dbFlush(){jt(()=>this._dbCreate())}}const zn={};for(const n of Vn)zn[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(ln.prototype,zn);customElements.get("emoji-picker")||customElements.define("emoji-picker",ln);var nn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(i,s){s(e)})(Tt,function(i){var s="dnd-poly-",h=s+"snapback",o="dnd-poly-",p=o+"dragstart-pending",v=o+"dragstart-cancel",P=["none","copy","copyLink","copyMove","link","linkMove","move","all"],S=["none","copy","move","link"],F=function(){var j=!1;try{var x=Object.defineProperty({},"passive",{get:function(){j=!0}});window.addEventListener("test",null,x)}catch{}return j}();function k(j){return j&&j.tagName}function w(j,x,q){q===void 0&&(q=!0),document.addEventListener(j,x,!!F&&{passive:q})}function R(j,x){document.removeEventListener(j,x)}function ue(j,x,q,oe){oe===void 0&&(oe=!1);var ce=F?{passive:!0,capture:oe}:oe;return j.addEventListener(x,q,ce),{off:function(){j.removeEventListener(x,q,ce)}}}function ve(j){return j.length===0?0:j.reduce(function(x,q){return q+x},0)/j.length}function ee(j,x){for(var q=0;q<j.changedTouches.length;q++)if(j.changedTouches[q].identifier===x)return!0;return!1}function te(j,x,q){for(var oe=[],ce=[],me=0;me<x.touches.length;me++){var fe=x.touches[me];oe.push(fe[j+"X"]),ce.push(fe[j+"Y"])}q.x=ve(oe),q.y=ve(ce)}var pe=["","-webkit-"];function V(j,x,q,oe,ce){ce===void 0&&(ce=!0);var me=x.x,fe=x.y;oe&&(me+=oe.x,fe+=oe.y),ce&&(me-=parseInt(j.offsetWidth,10)/2,fe-=parseInt(j.offsetHeight,10)/2);for(var Ee="translate3d("+me+"px,"+fe+"px, 0)",Se=0;Se<pe.length;Se++){var re=pe[Se]+"transform";j.style[re]=Ee+" "+q[Se]}}var J=function(){function j(x,q){this.t=x,this.i=q,this.s=S[0]}return Object.defineProperty(j.prototype,"dropEffect",{get:function(){return this.s},set:function(x){this.t.mode!==0&&P.indexOf(x)>-1&&(this.s=x)},enumerable:!0,configurable:!0}),Object.defineProperty(j.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(j.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(x){this.t.mode===2&&P.indexOf(x)>-1&&(this.t.effectAllowed=x)},enumerable:!0,configurable:!0}),j.prototype.setData=function(x,q){if(this.t.mode===2){if(x.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[x]=q,this.t.types.indexOf(x)===-1&&this.t.types.push(x)}},j.prototype.getData=function(x){if(this.t.mode===1||this.t.mode===2)return this.t.data[x]||""},j.prototype.clearData=function(x){if(this.t.mode===2){if(x&&this.t.data[x]){delete this.t.data[x];var q=this.t.types.indexOf(x);return void(q>-1&&this.t.types.splice(q,1))}this.t.data={},this.t.types=[]}},j.prototype.setDragImage=function(x,q,oe){this.t.mode===2&&this.i(x,q,oe)},j}();function _(j,x){return j?j===P[0]?S[0]:j.indexOf(P[1])===0||j===P[7]?S[1]:j.indexOf(P[4])===0?S[3]:j===P[6]?S[2]:S[1]:x.nodeType===3&&x.tagName==="A"?S[3]:S[1]}function Z(j,x,q,oe,ce,me,fe){me===void 0&&(me=!0),fe===void 0&&(fe=null);var Ee=function(re,je,Pe,C,X,se,le){le===void 0&&(le=null);var be=je.changedTouches[0],ne=new Event(Pe,{bubbles:!0,cancelable:C});ne.dataTransfer=se,ne.relatedTarget=le,ne.screenX=be.screenX,ne.screenY=be.screenY,ne.clientX=be.clientX,ne.clientY=be.clientY,ne.pageX=be.pageX,ne.pageY=be.pageY;var Te=re.getBoundingClientRect();return ne.offsetX=ne.clientX-Te.left,ne.offsetY=ne.clientY-Te.top,ne}(x,q,j,me,document.defaultView,ce,fe),Se=!x.dispatchEvent(Ee);return oe.mode=0,Se}function K(j,x){if(!j||j===P[7])return x;if(x===S[1]){if(j.indexOf(S[1])===0)return S[1]}else if(x===S[3]){if(j.indexOf(S[3])===0||j.indexOf("Link")>-1)return S[3]}else if(x===S[2]&&(j.indexOf(S[2])===0||j.indexOf("Move")>-1))return S[2];return S[0]}var Y,E=function(){function j(x,q,oe,ce){this.h=x,this.o=q,this.u=oe,this.l=ce,this.v=0,this.p=null,this.g=null,this.m=x,this.I=x.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),w("touchmove",this.j,!1),w("touchend",this.S,!1),w("touchcancel",this.S,!1)}return j.prototype.A=function(){var x=this;this.v=1,this.O=S[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var q=this.u;if(this.N=new J(this.D,function(Ee,Se,re){q=Ee,typeof Se!="number"&&typeof re!="number"||(x.P={x:Se||0,y:re||0})}),this.D.mode=2,this.N.dropEffect=S[0],Z("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;te("page",this.m,this.F);var oe,ce=this.o.dragImageSetup(q);if(this.L=(oe=ce,pe.map(function(Ee){var Se=oe.style[Ee+"transform"];return Se&&Se!=="none"?Se.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),ce.style.position="absolute",ce.style.left="0px",ce.style.top="0px",ce.style.zIndex="999999",ce.classList.add("dnd-poly-drag-image"),ce.classList.add("dnd-poly-icon"),this._=ce,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var me=getComputedStyle(q);this.P={x:0-parseInt(me.marginLeft,10),y:0-parseInt(me.marginTop,10)}}else{var fe=q.getBoundingClientRect();me=getComputedStyle(q),this.P={x:fe.left-this.I.clientX-parseInt(me.marginLeft,10)+fe.width/2,y:fe.top-this.I.clientY-parseInt(me.marginTop,10)+fe.height/2}}return V(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){x.X||(x.X=!0,x.Y(),x.X=!1)},this.o.iterationInterval),!0},j.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),R("touchmove",this.j),R("touchend",this.S),R("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},j.prototype.C=function(x){var q=this;if(ee(x,this.I.identifier)!==!1){if(this.m=x,this.v===0){var oe=void 0;if(this.o.dragStartConditionOverride)try{oe=this.o.dragStartConditionOverride(x)}catch{oe=!1}else oe=x.touches.length===1;return oe?void(this.A()===!0&&(this.h.preventDefault(),x.preventDefault())):void this.T()}if(x.preventDefault(),te("client",x,this.M),te("page",x,this.F),this.o.dragImageTranslateOverride)try{var ce=!1;if(this.o.dragImageTranslateOverride(x,{x:this.M.x,y:this.M.y},this.p,function(me,fe){q._&&(ce=!0,q.M.x+=me,q.M.y+=fe,q.F.x+=me,q.F.y+=fe,V(q._,q.F,q.L,q.P,q.o.dragImageCenterOnTouch))}),ce)return}catch{}V(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},j.prototype.k=function(x){if(ee(x,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(x.preventDefault(),this.v=x.type==="touchcancel"?3:2):this.T()}},j.prototype.Y=function(){var x=this,q=this.O;this.D.mode=3,this.N.dropEffect=S[0];var oe=Z("drag",this.u,this.m,this.D,this.N);if(oe&&(this.O=S[0]),oe||this.v===2||this.v===3)return this.q(this.v)?void function(Ee,Se,re,je){var Pe=getComputedStyle(Ee);if(Pe.visibility!=="hidden"&&Pe.display!=="none"){Se.classList.add(h);var C=getComputedStyle(Se),X=parseFloat(C.transitionDuration);if(isNaN(X)||X===0)je();else{var se=Ee.getBoundingClientRect(),le={x:se.left,y:se.top};le.x+=document.body.scrollLeft||document.documentElement.scrollLeft,le.y+=document.body.scrollTop||document.documentElement.scrollTop,le.x-=parseInt(Pe.marginLeft,10),le.y-=parseInt(Pe.marginTop,10);var be=parseFloat(C.transitionDelay),ne=Math.round(1e3*(X+be));V(Se,le,re,void 0,!1),setTimeout(je,ne)}}else je()}(this.u,this._,this.L,function(){x.B()}):void this.B();var ce=this.o.elementFromPoint(this.M.x,this.M.y),me=this.g;ce!==this.p&&ce!==this.g&&(this.p=ce,this.g!==null&&(this.D.mode=3,this.N.dropEffect=S[0],Z("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=_(this.D.effectAllowed,this.u),Z("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=K(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),me!==this.g&&k(me)&&(this.D.mode=3,this.N.dropEffect=S[0],Z("dragleave",me,this.m,this.D,this.N,!1,this.g)),k(this.g)&&(this.D.mode=3,this.N.dropEffect=_(this.D.effectAllowed,this.u),Z("dragover",this.g,this.m,this.D,this.N)===!1?this.O=S[0]:this.O=K(this.N.effectAllowed,this.N.dropEffect)),q!==this.O&&this._.classList.remove(s+q);var fe=s+this.O;this._.classList.add(fe)},j.prototype.q=function(x){var q=this.O===S[0]||this.g===null||x===3;return q?k(this.g)&&(this.D.mode=3,this.N.dropEffect=S[0],Z("dragleave",this.g,this.m,this.D,this.N,!1)):k(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,Z("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=S[0]),q},j.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,Z("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},j}(),he={iterationInterval:150,tryFindDraggableTarget:function(j){var x=j.target;do if(x.draggable!==!1&&(x.draggable===!0||x.getAttribute&&x.getAttribute("draggable")==="true"))return x;while((x=x.parentNode)&&x!==document.body)},dragImageSetup:function(j){var x=j.cloneNode(!0);return function q(oe,ce){if(oe.nodeType===1){for(var me=getComputedStyle(oe),fe=0;fe<me.length;fe++){var Ee=me[fe];ce.style.setProperty(Ee,me.getPropertyValue(Ee),me.getPropertyPriority(Ee))}if(ce.style.pointerEvents="none",ce.removeAttribute("id"),ce.removeAttribute("class"),ce.removeAttribute("draggable"),ce.nodeName==="CANVAS"){var Se=oe,re=ce,je=Se.getContext("2d").getImageData(0,0,Se.width,Se.height);re.getContext("2d").putImageData(je,0,0)}}if(oe.hasChildNodes())for(fe=0;fe<oe.childNodes.length;fe++)q(oe.childNodes[fe],ce.childNodes[fe])}(j,x),x},elementFromPoint:function(j,x){return document.elementFromPoint(j,x)}};function Ce(j){if(!Y){var x=he.tryFindDraggableTarget(j);if(x)try{Y=new E(j,he,x,Oe)}catch(q){throw Oe(he,j,3),q}}}function Le(j){var x=j.target,q=function(Se){ce.off(),me.off(),fe.off(),Ee.off(),x&&x.dispatchEvent(new CustomEvent(v,{bubbles:!0,cancelable:!0})),clearTimeout(oe)};x&&x.dispatchEvent(new CustomEvent(p,{bubbles:!0,cancelable:!0}));var oe=window.setTimeout(function(){ce.off(),me.off(),fe.off(),Ee.off(),Ce(j)},he.holdToDrag),ce=ue(x,"touchend",q),me=ue(x,"touchcancel",q),fe=ue(x,"touchmove",q),Ee=ue(window,"scroll",q,!0)}function Oe(j,x,q){if(q===0&&j.defaultActionOverride)try{j.defaultActionOverride(x),x.defaultPrevented}catch{}Y=null}i.polyfill=function(j){if(j&&Object.keys(j).forEach(function(ce){he[ce]=j[ce]}),!he.forceApply){var x=(q={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},oe=!!window.chrome||/chrome/i.test(navigator.userAgent),q.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||oe&&"ontouchstart"in document.documentElement),q);if(x.userAgentSupportingNativeDnD&&x.draggable&&x.dragEvents)return!1}var q,oe;return he.holdToDrag?w("touchstart",Le,!1):w("touchstart",Ce,!1),!0},Object.defineProperty(i,"__esModule",{value:!0})})})(nn,nn.exports);var Pa=nn.exports;const Ba=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),tt=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},Ra=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let Tn;const Ua=(n=window)=>new Promise(e=>{const i=setTimeout(()=>{e()},100),s=()=>{clearTimeout(i),clearTimeout(Tn),Tn=setTimeout(()=>{n.removeEventListener("scroll",s),e()},100)};n.addEventListener("scroll",s)}),$a="v0.6.2 Beta";document.addEventListener("DOMContentLoaded",()=>{var be,ne,Te,Ve,Be,$e,it,Ke,Ae,rt,Je,at,st,ct;const n=document.querySelector(".editor"),e=document.getElementById("tones"),i=document.getElementById("action"),s=document.getElementById("musical-score"),h=document.getElementById("add-track"),o=document.getElementById("remove-track"),p=document.getElementById("dialog"),v=document.forms["dialog-form"];v._title=v.querySelector(".form-title"),v.inputs=v.querySelector(".inputs"),v.buttons=v.querySelector(".buttons");const P=document.getElementById("play"),S=document.getElementById("clear"),F=document.getElementById("warn-out"),k=document.getElementById("mml"),w=document.getElementById("copy"),R=document.getElementById("paste"),ue=document.getElementById("save"),ve=document.getElementById("open"),ee=document.getElementById("ctrl"),te=document.getElementById("undo"),pe=document.getElementById("redo");class V{constructor(){We(this,be,`#COMMENT Generated by FlMML VisualSequencer ${$a}`);We(this,ne,[]);We(this,Te,(a,D)=>{});We(this,Ve,(a,D)=>{})}set onChange(a){Ge(this,Te,a)}set onError(a){Ge(this,Ve,a)}setMmlArr(a){Ge(this,ne,a),Q(this,Te).call(this,this.getMmlArr(),this.getMml())}setMml(a){Ge(this,ne,a.split(`
`)),Q(this,ne).at(-2)===""&&Q(this,ne).at(-1)===Q(this,be)&&Q(this,ne).splice(-2,2),Q(this,Te).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return Q(this,ne)}getMml(){return Q(this,ne).length?Q(this,ne).concat(["",Q(this,be)]).join(`
`):""}getMmlLine(a){return Q(this,ne)[a]}insert(a,D){Object.hasOwn(Q(this,ne),a)||a===0?(Q(this,ne).splice(a,0,D),Q(this,Te).call(this,this.getMmlArr(),this.getMml())):Q(this,Ve).call(this,"範囲外の書き換え指定",`範囲${Q(this,ne).length-1}までのところ、${a}`)}append(a){Q(this,ne).push(a),Q(this,Te).call(this,this.getMmlArr(),this.getMml())}appendToStr(a,D){Object.hasOwn(Q(this,ne),a)?(Q(this,ne)[a]+=D,Q(this,Te).call(this,this.getMmlArr(),this.getMml())):this.append(D)}beforeInsertToStr(a,D){Object.hasOwn(Q(this,ne),a)?(Q(this,ne)[a]=D+Q(this,ne)[a],Q(this,Te).call(this,this.getMmlArr(),this.getMml())):this.append(D)}rewrite(a,D){Object.hasOwn(Q(this,ne),a)?(Q(this,ne)[a]=D,Q(this,Te).call(this,this.getMmlArr(),this.getMml())):this.append(D)}delete(a,D=1){Object.hasOwn(Q(this,ne),a)&&Q(this,ne).splice(a,D).length!==0?Q(this,Te).call(this,this.getMmlArr(),this.getMml()):Q(this,Ve).call(this,"無効な指定",`範囲${Q(this,ne).length-1}までの中で${a}から${D}削除するのはできません`)}}be=new WeakMap,ne=new WeakMap,Te=new WeakMap,Ve=new WeakMap;class J{constructor(a,D){We(this,Be,[]);We(this,$e,[]);We(this,it,null);We(this,Ke,null);this.tonesElem=a,this.areaElem=D,Ge(this,Ke,this.areaElem.querySelector(".track.active"))}set activeTrack(a){Q(this,Ke).classList.remove("active"),Ge(this,Ke,a),Q(this,Ke).classList.add("active")}get activeTrack(){return Q(this,Ke)}blocksDataUpdate(){Ge(this,Be,[...this.areaElem.querySelectorAll(".track button")].map(a=>({label:a.ariaLabel,className:a.className,trackNo:[...document.getElementsByClassName("track")].findIndex(D=>D.contains(a)),tone:{tone:a.dataset.tone,tonePitch:a.dataset.tonePitch},tempo:a.dataset.tempo,noteValue:a.dataset.noteValue,rest:a.dataset.rest,octave:a.dataset.octave,velocity:a.dataset.velocity,noteShift:a.dataset.noteShift,detune:a.dataset.detune,tieSlur:a.dataset.tieSlur,repeatStartEnd:a.dataset.repeatStartEnd,repeatBreak:a.dataset.repeatBreak,polyStartEnd:a.dataset.polyStartEnd,macroDef:a.dataset.macroDef,macroArgUse:a.dataset.macroArgUse,macroUse:a.dataset.macroUse,metaData:a.dataset.metaData,otherAction:a.dataset.otherAction,elem:a})))}saveBlocksData(){clearTimeout(Q(this,it)),Ge(this,it,setTimeout(()=>{const a=JSON.parse(JSON.stringify(Q(this,Be)));Wt.setItem("BlocksData",a).catch(D=>{alert("セーブができませんでした。"+D)})},1e3))}checkSavedBlocksData(){Wt.getItem("BlocksData").then(a=>{a&&(Ge(this,Be,a),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Y))})}parseBlocks(){const a=Q(this,Be);this.activeTrack=this.areaElem.querySelector(".track");const D=this.tonesElem.querySelector("ul");let b=0;a.forEach(g=>{if(g.trackNo!==b){const M=document.createElement("ul");M.classList.add("track"),this.activeTrack=M,this.areaElem.insertBefore(M,h),b=g.trackNo}const u=document.createElement("li"),N='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',G=(()=>{const M=document.createElement("div");return M.innerHTML=N,M.firstElementChild})(),A=document.querySelector(`[class*="${g.className.replace(/ material-icons| droppable| bounce| pop| done/g,"")}"]`),B=(A==null?void 0:A.cloneNode(!0))||G;g.label&&(B.ariaLabel=g.label),g.tone.tonePitch&&(B.className=g.className,g.label!=="無調整"&&(B.textContent=g.label),B.dataset.tone=g.tone.tone,A?A.replaceWith(B.cloneNode(!0)):D.appendChild(B.cloneNode(!0)),B.dataset.tonePitch=g.tone.tonePitch),g.tempo&&(B.dataset.tempo=g.tempo),g.noteValue&&(B.dataset.noteValue=g.noteValue),g.rest&&(B.dataset.rest=g.rest),g.octave&&(B.dataset.octave=g.octave),g.velocity&&(B.dataset.velocity=g.velocity),g.noteShift&&(B.dataset.noteShift=g.noteShift),g.detune&&(B.dataset.detune=g.detune),g.tieSlur&&(B.dataset.tieSlur=g.tieSlur,g.tieSlur==="&"?B.ariaLabel="スラー":B.ariaLabel="タイ"),g.repeatStartEnd&&(B.dataset.repeatStartEnd=g.repeatStartEnd,g.repeatStartEnd.startsWith("/:")?(B.classList.remove("material-icons"),B.ariaLabel="リピート開始",B.textContent="◆"):g.repeatStartEnd===":/"&&(B.ariaLabel="リピート終了")),g.repeatBreak&&(B.dataset.repeatBreak=g.repeatBreak),g.polyStartEnd&&(B.dataset.polyStartEnd=g.polyStartEnd),g.macroDef&&(B.dataset.macroDef=g.macroDef,B.textContent=g.macroDef===";"?";":"$="),g.macroArgUse&&(B.dataset.macroArgUse=g.macroArgUse),g.macroUse&&(B.dataset.macroUse=g.macroUse),g.metaData&&(B.dataset.metaData=g.metaData),g.otherAction&&(B.dataset.otherAction=g.otherAction,B.textContent=g.otherAction.length>4?"…":g.otherAction),u.appendChild(B),this.activeTrack.appendChild(u)})}exportMml(a){a.setMmlArr([]);let D=0,b=0;const g=Q(this,Be).filter(T=>T.tone.tone!==void 0),u=()=>g.filter(T=>T.trackNo===b),N=()=>new Set(u().map(T=>T.tone.tone));let G=N(),A=0,B=!1,M=[4,0],H=!1;Q(this,Be).forEach(T=>{const{tone:ie,tonePitch:W}=T.tone;if(T.trackNo!==b&&(G.size?([...G].forEach((L,y)=>{a.appendToStr(D+y,";")}),D+=G.size):(a.appendToStr(D,";"),D++),b=T.trackNo,G=N(),B=!1),ie!==void 0)A=[...G].indexOf(ie),B||([...G].forEach((L,y)=>{L&&a.beforeInsertToStr(D+y,L+" ")}),B=!0),[...G].forEach((L,y)=>{let ye=W||"";y!==A&&(ye=ye.replace(/[a-g]/,H?"*":"r")),a.appendToStr(D+y,ye)});else if(T.rest||T.tieSlur)G.size?[...G].forEach((L,y)=>{a.appendToStr(D+y,T.rest||T.tieSlur)}):a.appendToStr(D,T.rest||T.tieSlur);else if(T.noteValue||T.repeatStartEnd||T.repeatBreak||T.polyStartEnd){const L=y=>{if(!y)return M;const ye=Number((y.match(/[0-9]+/)||[M[0]])[0]),we=(y.match(/\.+/)||[""])[0].length;return[ye,we]};T.noteValue?M=L(T.noteValue):T.polyStartEnd==="["?H=!0:T.polyStartEnd==="]"&&(H=!1),G.size?[...G].forEach((y,ye)=>{if(a.appendToStr(D+ye,T.noteValue||T.repeatStartEnd||T.repeatBreak||T.polyStartEnd||""),T.polyStartEnd==="]"){const we=a.getMmlLine(D+ye).match(/\[(.+?)\]/);if(we){const Ne=we[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(Ne){const ze=[...Ne].map(Xe=>({type:Xe[1]==="r"?"rest":Xe[1]==="*"?"otherNote":"note",num:L(Xe[0])}));ze.filter(Re=>Re.type==="note").map(Re=>Re.num),ze.filter(Re=>Re.type==="otherNote").map(Re=>Re.num),ze.filter(Re=>Re.type==="rest").map(Re=>Re.num);let yt=we[0].replace(/\*\+?[0-9]*\.*/g,"");const et=a.getMmlLine(D+ye).replace(/\[.+?\]/,yt);a.rewrite(D+ye,et)}}}}):a.appendToStr(D,T.noteValue||T.repeatStartEnd||T.repeatBreak||T.polyStartEnd||"")}else if(T.metaData)T.metaData&&a.getMmlLine(D)&&D++,a.appendToStr(D,T.metaData.replace(`
`,"")||""),D++;else{const L=W||T.tempo||T.octave||T.velocity||T.noteShift||T.detune||T.tieSlur||T.macroDef||T.macroArgUse||T.macroUse||T.otherAction||"";a.appendToStr(D,L),/;/.test(L)&&(D+=G.size||1,G=N(),B=!1)}}),[...G].slice(0,-1).forEach((T,ie)=>{a.appendToStr(D+ie,";")})}importMml(a){const D=a.getMmlArr(),b=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig,g=[],u=new Set,N=new Set;let G=0,A="",B=!1,M=!1;D.forEach(H=>{(H.match(b)||[]).forEach(ie=>{if(ie=ie.trim(),!ie)return;const W=L=>{const y={};if(y.tone={},y.trackNo=G,/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(L)){A=L,N.add(A);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(L)){N.has(A)||N.add(A);const ye=[...N].indexOf(A)+1;y.label="無調整",y.className=`material-icons note note-${ye}`,y.tone.tone=A,y.tone.tonePitch=L,B&&(M=!0)}else if(L.startsWith("t"))y.className="material-icons tempo",y.tempo=L;else if(L.startsWith("l"))y.className="material-icons note-value",y.noteValue=L;else if(L.startsWith("r"))y.className="material-icons rest",y.rest=L;else if(/^o[0-8]|[><]+$/i.test(L))y.className="material-icons octave",y.octave=L;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(L))y.className="material-icons velocity",y.velocity=L;else if(L.startsWith("@ns")||L.startsWith("ns"))y.className="material-icons note-shift",y.noteShift=L;else if(L.startsWith("@d"))y.className="material-icons detune",y.detune=L;else if(L.startsWith("&"))y.className="tie-slur",y.tieSlur=L;else if(L.startsWith("/*"))y.className="other-action",y.otherAction=L;else if(L.startsWith("/:"))y.className="repeat-start-end",y.repeatStartEnd=L;else if(L.startsWith(":/"))y.className="material-icons repeat-start-end",y.repeatStartEnd=L;else if(L.startsWith("/"))y.className="repeat-break",y.repeatBreak=L;else if(L.startsWith("[")||L.startsWith("]"))y.className="poly-start-end",y.polyStartEnd=L;else if(/^\$.*?=$/.test(L))y.className="macro-def",y.macroDef=L.replaceAll(" ",""),u.add(y.macroDef.slice(0,-1)),B=!0;else if(L.startsWith("%"))y.className="macro-arg-use",y.macroArgUse=L;else if(L.startsWith("$")){y.className="macro-use";const ye=[...u].sort((we,Ne)=>Ne.length-we.length).find(we=>L.includes(we));if(ye){y.macroUse=ye,g.push(y);const we=L.replace(ye,"");we!==""&&W(we);return}else y.macroUse=L}else if(L.startsWith("#")){const ye={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};y.label=(Object.entries(ye).find(we=>L.startsWith(we[0]))||[,void 0])[1],y.className="meta-data",y.metaData=L+`
`}else if(L.startsWith(";")){if(G++,B&&!M){const ye=[...N].join(" ");ye&&(y.className="other-action",y.otherAction=ye,g.push(y),N.clear())}B=!1,M=!1;return}else y.className="other-action",y.otherAction=L;g.push(y)};W(ie)})}),this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((H,T)=>{T?H.remove():(H.textContent="",this.activeTrack=H)}),re=null,Ge(this,Be,g),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}playRendering(){const a=Q(this,Be);let D=120,b=0;[e,i,s].forEach(M=>{M.classList.add("no-op")});const g=document.querySelector(".wrap"),u=document.getElementsByClassName("track"),G=(g.clientHeight-32)/u.length;[...u].forEach(M=>{M.style.setProperty("--max-height",`${G}px`)}),h.disabled=!0,o.disabled=!0;const A=(M,{scoreNoteValue:H=4}={})=>{var xt;let T=!1,ie=-1,W=-1,L=!1,y=!1;const ye=[],we=[],Ne=[],ze=performance.now(),yt=(xt=M[0])==null?void 0:xt.trackNo,et=u[yt],Xe=b++;let Re=null;const Pt=new Promise(de=>Re=de);let bt=0,Me=0;const dt=de=>{if(!de)return H;const Fe=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(de),qe=Fe&&Fe[1]?Number(Fe[1]):H,Ie=Fe?Fe[2].length:0;return qe*2**Ie/(2**(Ie+1)-1)},Bt=de=>{const Fe=Ie=>{!y&&et.scrollTo({top:Ie,behavior:"smooth"}),y=!0,Ua(et).then(()=>{y=!1})},qe=Ie=>et.clientHeight*Ie;(Me===0||de.elem.offsetTop>et.scrollTop+qe(.8)||de.elem.offsetTop<et.scrollTop+qe(.2))&&Fe(de.elem.offsetTop-qe(.2))},ft=de=>{const Fe=qe=>{const Ie=qe-ze,Ue=60/D*4/de*1e3;Ie<bt+Ue?Q(this,$e)[Xe]=requestAnimationFrame(Fe):(bt+=Ue,Ye())};Q(this,$e)[Xe]=requestAnimationFrame(Fe)},Ye=async()=>{var Fe,qe;const de=M[Me];if(!de||Me>=M.length){Re({scoreNoteValue:H});return}if(Bt(de),L){de.macroDef===";"&&(L=!1),Me++,Ye();return}else if(ie!==-1)(Fe=de.repeatStartEnd)!=null&&Fe.startsWith("/:")?W++:de.repeatStartEnd===":/"&&(W===ie&&(tt(de.elem,"pop"),ie=-1),W--),Me++,Ye();else if(de.tone.tonePitch){const Ie=dt(de.tone.tonePitch);tt(de.elem,"bounce"),Me++,T?Ye():ft(Ie)}else if(de.rest||de.tieSlur)if(tt(de.elem,"pop"),Me++,de.tieSlur==="&")Ye();else{const Ie=dt(de.rest||de.tieSlur);ft(Ie)}else if(de.polyStartEnd)if(T=de.polyStartEnd==="[",tt(de.elem,"pop"),T)Me++,Ye();else{const Ie=dt(M[Me++-1].tone.tonePitch);ft(Ie)}else if(de.macroDef&&de.macroDef!==";"){L=!0,Me++,Ye();return}else{if(de.tempo&&(D=Number(de.tempo.replace("t",""))||D),de.noteValue&&(H=dt(de.noteValue)),tt(de.elem,"pop"),(qe=de.repeatStartEnd)!=null&&qe.startsWith("/:"))ye[++W]=Me,we[W]||(Ne[W]=de.repeatStartEnd.replace("/:",""),Ne[W]=Ne[W]===""?2:Number(Ne[W]),Ne[W]||(ie=W));else if(de.repeatBreak){if(Ne[W]===1){if(!we[W]){let Ie=W;we[W]=M.findIndex((Ue,Qe)=>{if(Qe>ye[W]){if(console.log(Ie),Ue.repeatStartEnd.startsWith("/:"))Ie++;else if(Ue.repeatStartEnd===":/"){if(Ie===W)return!0;Ie--}}})}Me=we[W],Ye(),tt(de.elem,"done");return}}else if(de.repeatStartEnd===":/"){if(Ne[W]--,Ne[W]){we[W]=Me,Me=ye[W],W--,Ye(),tt(de.elem,"done");return}we[W]=null,W--}else if(de.macroUse){const Ie=Qe=>{const ot=a[Qe].trackNo;let ht=Qe+1;for(;a[ht].macroDef!==";"&&a[ht].trackNo===ot;)ht++;return ht},Ue={};if(Ue.start=a.findIndex(Qe=>{var ot;return(ot=Qe.macroDef)==null?void 0:ot.startsWith(de.macroUse)}),Ue.start>-1){Ue.end=Ie(Ue.start),Ue.blocks=a.slice(Ue.start+1,Ue.end);const Qe=performance.now();H=(await A(Ue.blocks,{scoreNoteValue:H})).scoreNoteValue;const ot=performance.now();bt+=ot-Qe}}Me++,Ye()}tt(de.elem,"done")};return Ye(),Pt},B=Math.max(...a.map(M=>M.trackNo))+1;for(let M=0;M<B;M++)A(a.filter(H=>H.trackNo===M))}stopRendering(){[e,i,s].forEach(a=>{a.classList.remove("no-op")}),h.disabled=!1,o.disabled=!1,Q(this,Be).forEach(a=>{a.elem.classList.remove("done")}),Q(this,$e).forEach(a=>{cancelAnimationFrame(a)})}calcPoly(){const a=Math.max(...Q(this,Be).map(D=>D.trackNo))+1;for(let D=0;D<a;D++)Q(this,Be).filter(g=>g.polyStartEnd&&g.trackNo===D).forEach((g,u)=>{u%2===0?(g.elem.dataset.polyStartEnd="[",g.elem.textContent="["):(g.elem.dataset.polyStartEnd="]",g.elem.textContent="]")});this.blocksDataUpdate()}}Be=new WeakMap,$e=new WeakMap,it=new WeakMap,Ke=new WeakMap;class _{constructor(){We(this,Ae,[[],[]]);We(this,rt,70);We(this,Je,a=>{})}set onPopstate(a){Ge(this,Je,a)}pushState(a){Q(this,Ae)[0].push(a),Q(this,Ae)[0].length>Q(this,rt)&&Q(this,Ae)[0].shift(),Q(this,Ae)[1].length=0,console.log(Q(this,Ae))}undo(){const a=Q(this,Ae)[0].pop();Q(this,Je).call(this,{reason:"undo",data:a}),a&&Q(this,Ae)[1].unshift(a),console.log(Q(this,Ae))}redo(){const a=Q(this,Ae)[1].shift();Q(this,Je).call(this,{reason:"redo",data:a}),a&&Q(this,Ae)[0].push(a),console.log(Q(this,Ae))}clear(){Q(this,Ae)[0].length=0,Q(this,Ae)[1].length=0,console.log(Q(this,Ae))}}Ae=new WeakMap,rt=new WeakMap,Je=new WeakMap;class Z{constructor(a){We(this,at,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name"},{label:"音の定義",type:"text",name:"tone-def",autofocus:""}],buttons:[{class:"primaly",value:"set-tone",textContent:"確定"}]},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-tone-pitch",textContent:"確定"}]},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0"}],buttons:[{class:"primaly",value:"set-tempo",textContent:"確定"}]},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-note-value",textContent:"確定"}]},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-rest",textContent:"確定"}]},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8"}],buttons:[{class:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}]},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127"}],buttons:[{class:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}]},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift"}],buttons:[{class:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}]},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune"}],buttons:[{class:"primaly",value:"set-detune",textContent:"確定"}]},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-tie-slur",textContent:"確定"}]},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0"}],buttons:[{class:"primaly",value:"set-repeat",textContent:"確定"}]},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg"}],buttons:[{class:"primaly",value:"set-macro-def",textContent:"確定"}]},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use"}],buttons:[{class:"primaly",value:"set-macro-arg-use",textContent:"確定"}]},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg"}],buttons:[{class:"primaly",value:"set-macro-use",textContent:"確定"}]},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{class:"primaly",value:"set-meta-data",textContent:"確定"}]},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action"}],buttons:[{class:"primaly",value:"set-other-action",textContent:"確定"}]},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}]}});We(this,st,a=>{const D=Q(this,at)[a];Object.keys(D).forEach(b=>{switch(b){case"title":v._title.textContent=D.title;break;case"inputs":D.inputs.forEach(g=>{const u=document.createElement("input");let N=u;Object.entries(g).forEach(G=>{if(G[0]==="label"){const A=document.createElement("label");A.innerHTML=G[1],A.appendChild(u),N=A}else if(G[0]==="select"){const A=document.createElement("select");A.name=g.name;const B=G[1];Object.entries(B).forEach(M=>{const H=document.createElement("option");H.value=M[0],H.textContent=M[1],A.appendChild(H)}),u.replaceWith(A)}else u.setAttribute(G[0],G[1])}),v.inputs.appendChild(N)});break;case"buttons":D.buttons.forEach(g=>{const u=document.createElement("button");Object.entries(g).forEach(N=>{N[0]==="textContent"?u.textContent=N[1]:u.setAttribute(N[0],N[1])}),v.buttons.appendChild(u)});break}})});We(this,ct,(a,D)=>{v._title.textContent="",v.inputs.textContent="",v.buttons.textContent="",Q(this,st).call(this,a);for(const[b,g]of Object.entries(D))b==="run"?g():v.elements[b].value=g;this.type=a});this.type=null,this.submitTarget=null,this.resolve=null,a.addEventListener("submit",D=>{const b=this.submitTarget,g=D.submitter.value,u=JSON.parse(JSON.stringify(b.dataset));switch(g){case"set-tone":const G=b.className;document.querySelectorAll(`[class*="${G}"]`).forEach(T=>{T.ariaLabel=a.elements["tone-name"].value,(!T.classList.contains("material-icons")||a.elements["tone-name"].value!=="無調整")&&(T.classList.remove("material-icons"),T.textContent=a.elements["tone-name"].value),T.dataset.tone=a.elements["tone-def"].value});break;case"set-tone-pitch":b.dataset.tonePitch=b.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]+a.elements["tone-pitch"].value+".".repeat(a.elements.dot.value);break;case"set-tempo":b.dataset.tempo="t"+a.elements.tempo.value;break;case"set-note-value":b.dataset.noteValue="l"+a.elements["note-value"].value+".".repeat(a.elements.dot.value);break;case"set-rest":b.dataset.rest="r"+a.elements.rest.value+".".repeat(a.elements.dot.value);break;case"set-octave":b.dataset.octave="o"+a.elements.octave.value;break;case"set-octave-relative":b.dataset.octave=a.elements.octave.value>0?"<".repeat(a.elements.octave.value):">".repeat(-a.elements.octave.value);break;case"set-velocity":b.dataset.velocity="@v"+a.elements.velocity.value;break;case"set-velocity-relative":b.dataset.velocity=(a.elements.velocity.value>=0?"(":")")+Math.abs(a.elements.velocity.value);break;case"set-note-shift":b.dataset.noteShift="ns"+a.elements["note-shift"].value;break;case"set-note-shift-relative":b.dataset.noteShift="@ns"+a.elements["note-shift"].value;break;case"set-detune":b.dataset.detune="@d"+a.elements.detune.value;break;case"set-tie-slur":b.dataset.tieSlur="&"+a.elements["tie-slur"].value+".".repeat(a.elements.dot.value),b.dataset.tieSlur==="&"?b.ariaLabel="スラー":b.ariaLabel="タイ";break;case"set-repeat":b.dataset.repeatStartEnd="/:"+a.elements.repeat.value;break;case"set-macro-def":const A=b.dataset.macroDef;b.dataset.macroDef="$"+a.elements["macro-def-name"].value+(a.elements["macro-def-arg"].value!==""?`{${a.elements["macro-def-arg"].value}}`:"")+"=",s.querySelectorAll(`[data-macro-use="${A.replace("=","")}"]`).forEach(T=>{T.dataset.macroUse=b.dataset.macroDef.replace("=","")});break;case"set-macro-arg-use":b.dataset.macroArgUse="%"+a.elements["macro-arg-use"].value;break;case"set-macro-use":b.dataset.macroUse="$"+a.elements["macro-use-name"].value+(a.elements["macro-use-arg"].value!==""?`{${a.elements["macro-use-arg"].value}}`:"");break;case"set-meta-data":b.ariaLabel=a.elements["select-meta-data"].selectedOptions[0].label,b.dataset.metaData=a.elements["select-meta-data"].value.replace("{n}",a.elements.number.value).replace("{desc}",a.elements.text.value);break;case"set-other-action":b.dataset.otherAction=a.elements["other-action"].value,b.textContent=b.dataset.otherAction.length>4?"…":b.dataset.otherAction;break;case"remove-left":case"remove-right":const B=b.parentElement,M=E.activeTrack,H=M.children;for([...H].indexOf(B),re=null;[...H].includes(B);){const T=g==="remove-left",ie=T?M.firstElementChild:M.lastElementChild;he.pushState({operation:"remove",removedElem:ie,removedIndex:T?0:H.length-1,parent:M}),ie.remove()}E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y);break}const N=JSON.parse(JSON.stringify(b.dataset));JSON.stringify(u)!==JSON.stringify(N)&&he.pushState({operation:"valueChange",target:b,beforeChange:u,afterChange:N}),this.resolve()})}async prompt(a,D,b){return Q(this,ct).call(this,a,D),this.submitTarget=b,p.showModal(),new Promise(g=>this.resolve=g)}}at=new WeakMap,st=new WeakMap,ct=new WeakMap,mn.FlMML.prepare(".editor");const K=new mn.FlMML({workerURL:ar}),Y=new V;Wt.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const E=new J(e,s),he=new _,Ce=new Z(v),Le={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},Oe=new ln({i18n:Le,locale:"ja"});Pa.polyfill({holdToDrag:500}),Ra();const j=m=>`<span class="material-icons">${m}</span>`,x=j("play_arrow")+"再生",q=j("stop")+"停止",oe=()=>{E.playRendering()},ce=()=>{F.innerHTML=K.getWarnings().replaceAll(`
`,"<br>")};K.addEventListener("compilecomplete",ce);const me=()=>{P.innerHTML=x,E.stopRendering(),K.removeEventListener("compilecomplete",oe),S.disabled=!1};K.addEventListener("complete",me),Y.onChange=(m,a)=>{k.innerHTML=a?`<pre><code>${Ba(a).replaceAll(`
`,"<br>")}</code></pre>`:"(なし)";const D=!!m.length;[w,ue].forEach(b=>{b.disabled=!D})},Y.onError=(m,a)=>{alert(m+`
`+a)},E.checkSavedBlocksData();const fe=m=>{var T,ie;const a=()=>{let W=m.parentElement;for(;W&&!("noteValue"in W.firstElementChild.dataset);)W=W.previousElementSibling;return(W==null?void 0:W.firstElementChild)||null},D=()=>{var L;let W=m.parentElement;for(;W&&!((L=W.firstElementChild.dataset.octave)!=null&&L.startsWith("o"));)W=W.previousElementSibling;return(W==null?void 0:W.firstElementChild)||null},b=()=>{var y;let W=m.parentElement.nextElementSibling,L="";for(;W&&((y=W.firstElementChild.dataset.tieSlur)!=null&&y.match(/&[0-9]+\.*/));)L+=W.firstElementChild.dataset.tieSlur,W=W.nextElementSibling;return L},g=((T=a())==null?void 0:T.dataset.noteValue)||"",u=((ie=D())==null?void 0:ie.dataset.octave)||"",N=[...E.activeTrack.children].indexOf(m.parentElement),G=[...E.activeTrack.children].slice(0,N).filter(W=>"tonePitch"in W.firstElementChild.dataset||"octave"in W.firstElementChild.dataset&&!W.firstElementChild.dataset.octave.startsWith("o")).map(W=>((W.firstElementChild.dataset.tonePitch||W.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),A=[">","<"],B=(W,L)=>(W.match(new RegExp(L,"g"))||[]).length,M=(()=>{const W=-B(G,A[0])+B(G,A[1]);return W<0?A[0].repeat(-W):W>0?A[1].repeat(W):""})(),H=b();K.play(m.dataset.tone+g+u+M+m.dataset.tonePitch+H)};he.onPopstate=m=>{const a=m.data,D=b=>!!a.parent.closest("#"+b);switch(m.reason){case"undo":switch(a==null?void 0:a.operation){case"append":Y.delete(a.index);break;case"delete":Y.insert(a.index,a.mmlText);break;case"rewrite":Y.rewrite(a.index,a.beforeMmlText);break;case"copy":a.newElem.remove(),D("musical-score")&&(E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y));break;case"move":const b=a.fromIndex<=a.toIndex?"beforebegin":"afterend";a.parent.children[a.fromIndex].insertAdjacentElement(b,a.elem),D("musical-score")&&(E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y));break;case"valueChange":for(const[g,u]of Object.entries(a.beforeChange))a.target.dataset[g]=u;"tone"in a.target.dataset&&fe(a.target),E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y);break;case"remove":a.parent.insertBefore(a.removedElem,a.parent.children[a.removedIndex]),D("tones")||D("musical-score")&&(E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y));break;case"clear":a.tonesChildren.forEach(g=>{e.querySelector("ul").appendChild(g)}),a.musicalScoreChildren.forEach(g=>{s.insertBefore(g,h)}),re=a.lastTouchedButton,E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y);break}break;case"redo":switch(a==null?void 0:a.operation){case"append":Y.append(a.mmlText);break;case"delete":Y.delete(a.index);break;case"rewrite":Y.rewrite(a.index,a.afterMmlText);break;case"copy":a.toIndex!==-1?a.parent.insertBefore(a.newElem,a.parent.children[a.toIndex]):a.parent.appendChild(a.newElem),D("musical-score")&&(E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y)),"tonePitch"in re.dataset&&(fe(re),re.classList.add("bounce"));break;case"move":const b=a.toIndex>a.fromIndex?"beforebegin":"afterend";a.toIndex!==-1?a.parent.children[a.toIndex].insertAdjacentElement(b,a.elem):a.parent.appendChild(a.elem),D("musical-score")&&(E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y));break;case"valueChange":for(const[u,N]of Object.entries(a.afterChange))a.target.dataset[u]=N;"tone"in a.target.dataset&&fe(a.target),E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y);break;case"remove":const g=a.removedElem.className;a.removedElem.remove(),D("tones")&&s.querySelectorAll(`[class*="${g}"]`).forEach(u=>{u.parentElement.remove()}),E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y);break;case"clear":e.querySelector("ul").textContent="",s.querySelectorAll(".track").forEach((u,N)=>{N?u.remove():(u.textContent="",E.activeTrack=u)}),re=null,E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y);break}break}};const Ee=()=>{const m=[...e.getElementsByTagName("button")].map(a=>[...a.classList].find(D=>D.includes("note-")));for(let a=1;;a++)if(!m.includes("note-"+a))return"note-"+a};document.addEventListener("keydown",m=>{var D;const a=m.ctrlKey||ee.checked;switch((D=m.key)==null?void 0:D.toLowerCase()){case" ":document.activeElement.tagName.toLowerCase()!=="input"&&(m.preventDefault(),P.click());break;case"s":a&&(m.preventDefault(),!ue.disabled&&ue.click());break;case"o":a&&(m.preventDefault(),!ve.disabled&&ve.click());break;case"z":a&&he.undo();break;case"y":a&&he.redo();break}});const Se=async m=>{const{dataset:a}=m,D={tempo:b=>({tempo:b.replace("t","")}),noteValue:b=>({"note-value":(b.match(/[0-9]+/)||[""])[0],dot:(b.match(/\.+/)||[""])[0].length}),rest:b=>({rest:(b.match(/[0-9]+/)||[""])[0],dot:(b.match(/\.+/)||[""])[0].length}),octave:b=>({octave:b.startsWith("o")?b.replace("o",""):(b.match(/[><]+/)||[""])[0].length}),velocity:b=>({velocity:b.startsWith("@v")?b.replace("@v",""):Number((b.match(/[0-9]+/)||[""])[0])*(b.startsWith("(")?1:-1)}),noteShift:b=>({"note-shift":(b.match(/[0-9]+/)||[""])[0]}),detune:b=>({detune:b.replace("@d","")}),tieSlur:b=>({"tie-slur":(b.match(/[0-9]+/)||[""])[0],dot:(b.match(/\.+/)||[""])[0].length}),repeatStartEnd:b=>({repeat:b.replace("/:","")}),macroDef:b=>({"macro-def-name":(b.match(/\$([^\{\=]*)[\{\=]/)||[,""])[1],"macro-def-arg":(b.match(/\{([^\}]*)\}/)||[,""])[1]}),macroArgUse:b=>({"macro-arg-use":b.replace("%","")}),macroUse:b=>({"macro-use-name":(b.match(/\$([^\{]*)\{?/)||[,""])[1],"macro-use-arg":(b.match(/\{([^\}]*)\}/)||[,""])[1]}),metaData:b=>({run:()=>{const u=b.split(" "),N=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let G=N.findIndex(T=>u[0].startsWith(T));G===-1&&(G=0),v.elements["select-meta-data"].selectedIndex=G;const A=T=>v.elements[T].previousSibling,B=()=>v.elements["select-meta-data"].selectedOptions[0],M=(T,ie)=>{A("number").nodeValue=T[0],v.elements.number.value=T[1],v.elements.number.parentElement.style.display=T[2]?"none":"",A("text").nodeValue=ie[0],v.elements.text.value=ie[1],v.elements.text.parentElement.style.display=ie[2]?"none":""},H=T=>{var L,y,ye;const ie=T===G,W=N[T];switch(W){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const we=ie?u.slice(1).join(" ")??"":"";M(["無効","",!0],[B().label,we,!1]);break;case"#OCTAVE":case"#VELOCITY":M(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const Ne=W==="#WAV9",ze=ie?((L=u.slice(1).join(" "))==null?void 0:L.split(","))??[]:[];M(["波形番号",ze[0]??0,!1],Ne?["初期変位,ループフラグ,データ",`${ze[1]??0},${ze[2]??0},${ze[3]??""}`,!1]:["データ",ze[1]??"",!1]),v.elements.number.min=0,v.elements.number.max=Ne?15:31;break;case"#OPM":case"#OPN":M(["音色番号",ie?((y=u[0])==null?void 0:y.split("@")[1])??0:0,!1],["データ",ie?((ye=u.slice(1).join(" "))==null?void 0:ye.slice(1,-1))??"":"",!1]),v.elements.number.min=0,v.elements.number.max=127;break;case"#FMGAIN":M(["音量利得",ie?u[1].replace(`
`,"")??91:91,!1],["無効","",!0]),v.elements.number.min=-127,v.elements.number.max=127;break;case"#USING":M(["和音重ね数",ie?u[2].replace(`
`,"")??2:2,!1],["無効","",!0]),v.elements.number.min=1,v.elements.number.max="";break}};H(G),v.elements["select-meta-data"].addEventListener("change",T=>{H(T.target.selectedIndex)})}}),otherAction:b=>({"other-action":b}),remove:()=>({})};for(const b of Object.keys(a)){const g=D[b];if(g){let u=a[b];switch(b){case"repeatStartEnd":if(u===":/"){const A=(()=>{var M;let B=m.parentElement;for(;B&&!((M=B.firstElementChild.dataset.repeatStartEnd)!=null&&M.startsWith("/:"));)B=B.previousElementSibling;return(B==null?void 0:B.firstElementChild)||null})();if(A)m=A;else{const B=E.activeTrack,M=document.createElement("li"),T=i.querySelector(".repeat-start-end").cloneNode(!0);M.appendChild(T),B.insertBefore(M,m.parentElement),m=T}u=m.dataset.repeatStartEnd}break;case"macroDef":if(u===";")return;break}const N=g(u);await Ce.prompt(b,N,m);break}}};let re=e.querySelector("button");n.addEventListener("click",async m=>{const a=m.ctrlKey||ee.checked,D=g=>!!m.target.closest("#"+g),b=m.target.tagName.toLowerCase()==="button";if(![e,i,s].some(g=>g.classList.contains("no-op"))){if(D("tones"))if(b)re=m.target,await Ce.prompt("tone",{"tone-name":m.target.ariaLabel,"tone-def":m.target.dataset.tone,run:()=>{const g=v.elements["tone-name"];g.insertAdjacentElement("afterend",Oe);const u=document.querySelector("emoji-picker");g.addEventListener("focus",()=>{u.classList.add("expaned")},{once:!0}),u.addEventListener("emoji-click",N=>g.value=N.detail.unicode)}},m.target),K.play(m.target.dataset.tone+m.target.dataset.tonePitch),E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y);else{const g=e.querySelector("ul"),u=document.createElement("li"),G=`<button class="material-icons note ${Ee()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;u.innerHTML=G;const A=u.firstElementChild;g.appendChild(u),re=A,K.play(A.dataset.tone+A.dataset.tonePitch),he.pushState({operation:"copy",toIndex:-1,newElem:u,parent:g})}else if(D("action")){if(b){"otherAction"in m.target.dataset&&await Se(m.target);const g=E.activeTrack,u=document.createElement("li"),N=m.target.cloneNode(!0);if(("metaData"in N.dataset||"macroDef"in N.dataset||"macroArgUse"in N.dataset||"macroUse"in N.dataset)&&await Se(N),"tieSlur"in N.dataset?N.ariaLabel="スラー":"repeatStartEnd"in N.dataset?(N.classList.remove("material-icons"),N.ariaLabel="リピート開始",N.textContent="◆",N.dataset.repeatStartEnd="/:"):"polyStartEnd"in N.dataset?(N.dataset.polyStartEnd="[",N.textContent="["):"macroDef"in N.dataset&&(N.textContent="$="),u.appendChild(N),g.appendChild(u),re=N,E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y),he.pushState({operation:"copy",toIndex:-1,newElem:u,parent:g}),"repeatStartEnd"in re.dataset||"polyStartEnd"in re.dataset||"macroDef"in re.dataset){const G=document.createElement("li"),A=m.target.cloneNode(!0);"repeatStartEnd"in re.dataset?(A.ariaLabel="リピート終了",A.dataset.repeatStartEnd=":/"):"polyStartEnd"in re.dataset?(A.dataset.polyStartEnd="]",A.textContent="]"):"macroDef"in re.dataset&&(A.dataset.macroDef=";",A.textContent=";"),G.appendChild(A),re.parentElement.insertAdjacentElement("afterend",G),E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y),he.pushState({operation:"copy",toIndex:-1,newElem:G,parent:g})}}}else if(D("musical-score")){if(b&&m.target!==h&&m.target!==o)m.target.closest(".track")&&(E.activeTrack=m.target.closest(".track")),"tone"in m.target.dataset?(fe(m.target),tt(m.target,"bounce"),a&&(await Ce.prompt("tonePitch",{"tone-pitch":(m.target.dataset.tonePitch.match(/[0-9]+/)||[""])[0],dot:(m.target.dataset.tonePitch.match(/\.+/)||[""])[0].length},m.target),fe(m.target))):await Se(m.target),re=m.target,E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y);else if(re){m.target.closest(".track")&&(E.activeTrack=m.target.closest(".track"));const g=E.activeTrack,u=document.createElement("li"),N=re.cloneNode(!0);if("repeatStartEnd"in N.dataset&&(N.classList.remove("material-icons"),N.ariaLabel="リピート開始",N.textContent="◆",N.dataset.repeatStartEnd="/:"+(N.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),u.appendChild(N),g.appendChild(u),re=N,E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y),he.pushState({operation:"copy",toIndex:-1,newElem:u,parent:g}),"tonePitch"in N.dataset)N.dataset.tonePitch=N.dataset.tonePitch.replace(/[><]+/,""),fe(N),N.classList.add("bounce");else if("repeatStartEnd"in re.dataset){const G=document.createElement("li"),A=re.cloneNode(!0);A.classList.add("material-icons"),A.ariaLabel="リピート終了",A.textContent="repeat",A.dataset.repeatStartEnd=":/",G.appendChild(A),re.parentElement.insertAdjacentElement("afterend",G),E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y),he.pushState({operation:"copy",toIndex:-1,newElem:G,parent:g})}}}}}),n.addEventListener("contextmenu",m=>{var g,u,N,G;const a=A=>A.closest("#tones, #musical-score"),D=A=>!!m.target.closest("#"+A),b=m.target.tagName.toLowerCase()==="button";if(!((g=a(m.target))!=null&&g.classList.contains("no-op"))&&a(m.target)){const A=b&&m.target!==h&&m.target!==o?m.target:re;if(!A||a(A)!==a(m.target))return;m.preventDefault(),E.activeTrack=A.closest(".track")||E.activeTrack;const B=A.parentElement,M=A.className,H=((u=A.closest("#tones"))==null?void 0:u.querySelector("ul"))||E.activeTrack,T=[...H.children].indexOf(B);re=((N=B.previousElementSibling)==null?void 0:N.firstElementChild)||((G=B.nextElementSibling)==null?void 0:G.firstElementChild)||null,he.pushState({operation:"remove",removedElem:B,removedIndex:T,parent:H}),D("tones")?s.querySelectorAll(`[class*="${M}"]`).forEach(ie=>{ie.parentElement.remove()}):"macroDef"in A.dataset&&s.querySelectorAll(`[data-macro-use="${A.dataset.macroDef.replace("=","")}"]`).forEach(ie=>{ie.parentElement.remove()}),B.remove(),E.blocksDataUpdate(),E.calcPoly(),E.saveBlocksData(),E.exportMml(Y)}});let je=null,Pe=!1,C=null;n.addEventListener("touchstart",m=>{je=[...m.touches].at(-1).pageY,C=setTimeout(()=>{Pe=!0},500)});const X=m=>{const a=m.ctrlKey||ee.checked,D=N=>!!m.target.closest("#"+N),b=m.target.tagName.toLowerCase()==="button";if(m.type==="touchmove"){const N=[...m.touches].at(-1).pageY;if(Pe){m.cancelable&&m.preventDefault();return}else if(N-je<-20)m.deltaY=-1,clearTimeout(C);else if(N-je>20)m.deltaY=1,clearTimeout(C);else{m.cancelable&&m.preventDefault();return}je=N,Pe=!0,setTimeout(()=>Pe=!1,50)}const g=m.deltaY<0;let u=b?m.target:(re==null?void 0:re.closest("#musical-score"))&&re;if(u){if(D("musical-score")){if(s.classList.contains("no-op"))return;m.preventDefault();let N=JSON.parse(JSON.stringify(u.dataset));if(!a&&"tone"in u.dataset){const A=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],B=[">","<"],M=u.dataset.tonePitch,H=A.findIndex(ye=>M.match(/[a-g]\+?/)[0]===ye),T=(ye,we)=>(ye.match(new RegExp(we,"g"))||[]).length,ie=[T(M,B[0]),T(M,B[1])],W=B[0].repeat(ie[0])+B[1].repeat(ie[1]),L=(M.match(/[0-9]+/)||[""])[0],y=".".repeat((u.dataset.tonePitch.match(/\.+/)||[""])[0].length);g?H===A.length-1?ie[0]?u.dataset.tonePitch=W.substring(1)+A.at(0)+L+y:u.dataset.tonePitch=W+B[1]+A.at(0)+L+y:u.dataset.tonePitch=W+A[H+1]+L+y:H===0?ie[1]?u.dataset.tonePitch=W.substring(1)+A.at(-1)+L+y:u.dataset.tonePitch=W+B[0]+A.at(-1)+L+y:u.dataset.tonePitch=W+A[H-1]+L+y,fe(u)}else{const A=g?1:-1,B=(M,H=-1/0,T=1/0)=>M+A<H||M+A>T?0:A;if(a&&"tonePitch"in u.dataset){const M=Number((u.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),H=".".repeat((u.dataset.tonePitch.match(/\.+/)||[""])[0].length),T=B(M,0,384),ie=M+T!==0?M+T:"";u.dataset.tonePitch=u.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+ie+H,fe(u)}else if("tempo"in u.dataset){const M=Number(u.dataset.tempo.replace("t","")),H=B(M,0);u.dataset.tempo="t"+(M+H*10)}else if("noteValue"in u.dataset){const M=Number((u.dataset.noteValue.match(/[0-9]+/)||[""])[0]),H=B(M,1,384);u.dataset.noteValue=u.dataset.noteValue.replace(/[0-9]+/,M+H)}else if("rest"in u.dataset){const M=Number((u.dataset.rest.match(/[0-9]+/)||[""])[0]),H=".".repeat((u.dataset.rest.match(/\.+/)||[""])[0].length),T=B(M,0,384),ie=M+T!==0?M+T:"";u.dataset.rest="r"+ie+H}else if("octave"in u.dataset)if(u.dataset.octave.startsWith("o")){const H=Number(u.dataset.octave.replace("o","")),T=B(H,0,8);u.dataset.octave="o"+(H+T)}else{const H=(u.dataset.octave.match(/<+/)||[""])[0].length-(u.dataset.octave.match(/>+/)||[""])[0].length,T=B(H,-8,8);u.dataset.octave=H+T>0?"<".repeat(H+T):">".repeat(-(H+T))}else if("velocity"in u.dataset)if(u.dataset.velocity.startsWith("@v")){const H=Number(u.dataset.velocity.replace("@v","")),T=B(H,0,127);u.dataset.velocity="@v"+(H+T)}else{const H=Number((u.dataset.velocity.match(/[0-9]+/)||[""])[0])*(u.dataset.velocity.startsWith("(")?1:-1),T=B(H,-127,127);u.dataset.velocity=(H+T>=0?"(":")")+Math.abs(H+T)}else if("noteShift"in u.dataset){const M=Number((u.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),H=A;u.dataset.noteShift=u.dataset.noteShift.match(/@?ns/)[0]+(M+H)}else if("detune"in u.dataset){const M=Number(u.dataset.detune.replace("@d","")),H=A;u.dataset.detune="@d"+(M+H)}else if("tieSlur"in u.dataset){const M=Number((u.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),H=".".repeat((u.dataset.tieSlur.match(/\.+/)||[""])[0].length),T=B(M,0,384),ie=M+T!==0?M+T:"";u.dataset.tieSlur="&"+ie+H,u.dataset.tieSlur==="&"?u.ariaLabel="スラー":u.ariaLabel="タイ"}else if("repeatStartEnd"in u.dataset){if(u.dataset.repeatStartEnd===":/"){const W=(()=>{var y;let L=u.parentElement;for(;L&&!((y=L.firstElementChild.dataset.repeatStartEnd)!=null&&y.startsWith("/:"));)L=L.previousElementSibling;return(L==null?void 0:L.firstElementChild)||null})();if(W)u=W;else{const L=E.activeTrack,y=document.createElement("li"),we=i.querySelector(".repeat-start-end").cloneNode(!0);y.appendChild(we),L.insertBefore(y,u.parentElement),u=we}N=JSON.parse(JSON.stringify(u.dataset))}const M=Number((u.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),H=B(M,-1),T=M+H!==-1?M+H:"";u.dataset.repeatStartEnd="/:"+T}}const G=JSON.parse(JSON.stringify(u.dataset));JSON.stringify(N)!==JSON.stringify(G)&&he.pushState({operation:"valueChange",target:u,beforeChange:N,afterChange:G}),re=u,E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y)}}else return};n.addEventListener("wheel",X),n.addEventListener("touchmove",X),n.addEventListener("touchend",()=>{Pe=!1});let se={};n.addEventListener("dragstart",m=>{se={from:m.target.nodeType===1&&m.target.closest("#tones, #action, #musical-score"),item:m.target},m.dataTransfer.effectAllowed="copyMove"});let le=null;[e,i,s].forEach(m=>{const a=u=>{const N=u.ctrlKey||ee.checked,{from:G=null}=se,A=u.dataTransfer;switch(G){case e:switch(m){case e:u.preventDefault(),N?A.dropEffect="copy":A.dropEffect="move";break;case i:break;case s:u.preventDefault(),A.dropEffect="copy";break}break;case i:switch(m){case e:break;case i:break;case s:u.preventDefault(),A.dropEffect="copy";break}break;case s:switch(m){case e:break;case i:break;case s:u.preventDefault(),N?A.dropEffect="copy":A.dropEffect="move";break}break}le=A.dropEffect};m.addEventListener("dragover",a);const D=u=>{const{from:N=null}=se,G=u.target.tagName.toLowerCase()==="button",A=()=>u.target.classList.add("droppable");switch(N){case e:switch(m){case e:u.preventDefault(),G&&A();break;case i:break;case s:u.preventDefault(),G&&A();break}break;case i:switch(m){case e:break;case i:break;case s:u.preventDefault(),G&&A();break}break;case s:switch(m){case e:break;case i:break;case s:u.preventDefault(),G&&A();break}break}};m.addEventListener("dragenter",D);const b=u=>{const{from:N=null}=se,G=u.target.tagName.toLowerCase()==="button",A=()=>u.target.classList.remove("droppable");switch(N){case e:switch(m){case e:G&&A();break;case i:break;case s:G&&A();break}break;case i:switch(m){case e:break;case i:break;case s:G&&A();break}break;case s:switch(m){case e:break;case i:break;case s:G&&A();break}break}};m.addEventListener("dragleave",b),m.addEventListener("drop",async u=>{var ie,W;if(u.preventDefault(),(ie=u.dataTransfer.items)!=null&&ie.length)return;u.dataTransfer.dropEffect=u.dataTransfer.dropEffect!=="none"?u.dataTransfer.dropEffect:le;const{from:N,item:G}=se,A=((W=u.target.closest("#tones"))==null?void 0:W.querySelector("ul"))||u.target.closest(".track")||E.activeTrack,B=[...A.children].indexOf(G.parentElement),M=[...A.children].indexOf(u.target.parentElement),H=u.target.tagName.toLowerCase()==="button";let T;switch(u.dataTransfer.dropEffect){case"copy":const L=document.createElement("li"),y=G.cloneNode(!0);if(m===e){const ye=[...G.classList].find(we=>we.includes("note-"));y.classList.replace(ye,Ee())}else N===i&&("tieSlur"in y.dataset?y.ariaLabel="スラー":("metaData"in y.dataset||"macroDef"in y.dataset||"macroArgUse"in y.dataset||"macroUse"in y.dataset||"otherAction"in y.dataset)&&await Se(y));"repeatStartEnd"in y.dataset?(y.classList.remove("material-icons"),y.ariaLabel="リピート開始",y.textContent="◆",y.dataset.repeatStartEnd="/:"+(y.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in y.dataset?(y.dataset.polyStartEnd="[",y.textContent="["):"macroDef"in y.dataset&&(y.dataset.macroDef===";"&&(y.dataset.macroDef="$="),y.textContent="$="),L.appendChild(y),T=L;break;case"move":T=G.parentElement;break}if(H&&u.target.id!=="add-track"&&u.target.id!=="remove-track"){const L=u.dataTransfer.dropEffect==="copy"||M<B?"beforebegin":"afterend";u.target.parentElement.insertAdjacentElement(L,T)}else A.appendChild(T);switch(re=T.firstElementChild,m===s&&(E.activeTrack=A,E.blocksDataUpdate(),u.dataTransfer.dropEffect==="move"&&E.calcPoly(),E.saveBlocksData(),E.exportMml(Y),"tonePitch"in re.dataset&&(re.dataset.tonePitch=re.dataset.tonePitch.replace(/[><]+/,""),fe(re),re.classList.add("bounce"))),u.dataTransfer.dropEffect){case"copy":he.pushState({operation:"copy",toIndex:M,newElem:T,parent:A});break;case"move":he.pushState({operation:"move",fromIndex:B,toIndex:M,elem:T,parent:A});break}if(u.dataTransfer.dropEffect==="copy"&&("repeatStartEnd"in re.dataset||"polyStartEnd"in re.dataset||"macroDef"in re.dataset)){const L=document.createElement("li"),y=G.cloneNode(!0);"repeatStartEnd"in re.dataset?(y.classList.add("material-icons"),y.ariaLabel="リピート終了",y.textContent="repeat",y.dataset.repeatStartEnd=":/"):"polyStartEnd"in re.dataset?(y.dataset.polyStartEnd="]",y.textContent="]"):"macroDef"in re.dataset&&(y.dataset.macroDef=";",y.textContent=";"),L.appendChild(y),T.insertAdjacentElement("afterend",L),E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y),he.pushState({operation:"copy",toIndex:M+1,newElem:L,parent:A})}});const g=u=>{[...document.getElementsByClassName("droppable")].forEach(N=>{N.classList.remove("droppable")})};m.addEventListener("dragend",g)}),n.addEventListener("animationend",m=>{m.target.classList.remove("bounce"),m.target.classList.remove("pop")}),h.addEventListener("click",m=>{m.stopPropagation();const a=document.createElement("ul");a.classList.add("track"),E.activeTrack=a,s.insertBefore(a,h)}),o.addEventListener("click",m=>{m.stopPropagation();const a=[...document.getElementsByClassName("track")].at(-1),D=a.previousElementSibling;a.remove(),E.activeTrack=D,E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y)}),p.addEventListener("pointerdown",m=>{m.target===p&&p.addEventListener("pointerup",a=>{a.target===p&&p.close()},{once:!0})}),p.addEventListener("close",()=>{switch(Ce.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}}),P.addEventListener("click",()=>{const m=K.isPlaying();m?(K.stop(),E.stopRendering(),K.removeEventListener("compilecomplete",oe),S.disabled=!1):(K.play(Y.getMml()),K.addEventListener("compilecomplete",oe),S.disabled=!0),P.innerHTML=m?x:q}),S.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const m=[...s.children];m.pop(),he.pushState({operation:"clear",tonesChildren:[...e.querySelector("ul").children],musicalScoreChildren:m,lastTouchedButton:re}),e.querySelector("ul").textContent="";const a=e.querySelector("ul"),D=document.createElement("li"),b='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';D.innerHTML=b;const g=D.firstElementChild;a.appendChild(D),re=g,s.querySelectorAll(".track").forEach((u,N)=>{N?u.remove():(u.textContent="",E.activeTrack=u)}),E.blocksDataUpdate(),E.saveBlocksData(),E.exportMml(Y)}}),w.addEventListener("click",()=>{const m=Y.getMml(),a=w.innerHTML;w.disabled=!0,navigator.clipboard.writeText(m).then(()=>{w.disabled=!0,w.innerHTML=j("content_copy")+"コピーしました",setTimeout(()=>{w.innerHTML=a,w.disabled=!1},1500)}).catch(D=>alert(`コピーできませんでした
`+D))}),R.addEventListener("click",()=>{const m=R.innerHTML;R.disabled=!0,navigator.clipboard.readText().then(a=>{R.disabled=!0,a?(Y.setMml(a.replace(/\r/g,"")),E.importMml(Y),R.innerHTML=j("content_paste")+"貼り付けました"):R.innerHTML=j("content_paste")+"内容がありません",setTimeout(()=>{R.innerHTML=m,R.disabled=!1},1500)}).catch(a=>alert(`貼り付けできませんでした
`+a))}),ue.addEventListener("click",()=>{var u;const m=Y.getMml(),D=((u=Y.getMmlArr().find(N=>N.startsWith("#TITLE")))==null?void 0:u.split(" ").slice(1).join(" "))??"無題",b=new Blob([m],{type:"text/plain"}),g=document.createElement("a");g.download=D+".mml",g.href=URL.createObjectURL(b),g.click(),URL.revokeObjectURL(g.href),D==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。")}),ve.addEventListener("click",()=>{const m=document.createElement("input"),a=new FileReader;m.type="file",m.accept=".mml,.flmml,.txt",m.click(),m.onchange=()=>{a.onload=()=>{Y.setMml(a.result),E.importMml(Y)},a.readAsText(m.files[0])}}),("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile"),te.addEventListener("click",()=>he.undo()),pe.addEventListener("click",()=>he.redo())});
