var un=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var C=(n,e,r)=>(un(n,e,"read from private field"),r?r.call(n):e.get(n)),ue=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},Ne=(n,e,r,a)=>(un(n,e,"write to private field"),a?a.call(n,r):e.set(n,r),r);var dn=(n,e,r)=>(un(n,e,"access private method"),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const i of t.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function r(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(o){if(o.ep)return;o.ep=!0;const t=r(o);fetch(o.href,t)}})();const Ca="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var ft=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Da(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var hr={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(r,a){n.exports=a()})(self,function(){return(()=>{var r={587:(t,i,p)=>{var h;(h=(function(f,b){Object.defineProperty(b,"__esModule",{value:!0}),b.MsgTypes=b.SAMPLE_RATE=void 0,b.SAMPLE_RATE=44100,b.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(i,[p,i]))===void 0||(t.exports=h)},581:(t,i,p)=>{var h;(h=(function(f,b){Object.defineProperty(b,"__esModule",{value:!0}),b.FlMMLAudioExportError=void 0;class m extends Error{constructor(...w){super(...w),this.name="FlMMLAudioExportError"}}b.FlMMLAudioExportError=m}).apply(i,[p,i]))===void 0||(t.exports=h)},643:function(t,i,p){var h,f,b=this&&this.__awaiter||function(m,y,w,I){return new(w||(w=Promise))(function(R,l){function d(A){try{D(I.next(A))}catch(S){l(S)}}function F(A){try{D(I.throw(A))}catch(S){l(S)}}function D(A){var S;A.done?R(A.value):(S=A.value,S instanceof w?S:new w(function(_){_(S)})).then(d,F)}D((I=I.apply(m,y||[])).next())})};h=[p,i,p(587),p(581),p(158)],(f=(function(m,y,w,I,R){Object.defineProperty(y,"__esModule",{value:!0}),y.FlMMLonHTML5=y.FlMMLAudioExportError=y.FlMML=void 0,Object.defineProperty(y,"FlMMLAudioExportError",{enumerable:!0,get:function(){return I.FlMMLAudioExportError}});const l="flmml-on-html5.worker.js";class d{constructor(D=l){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof D=="string"&&(D={workerURL:D});const A=D.workerURL||l,S=D.infoInterval>=0?D.infoInterval:125;this.bufferSize=D.bufferSize>=128?Math.floor(D.bufferSize-D.bufferSize%128):8192,this.bufferMultiple=D.bufferMultiple>=1?Math.floor(D.bufferMultiple):32,this.lamejsURL=D.lamejsURL,(this.worker=new Worker(D.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${A}")`],{type:"application/javascript"})):A)).addEventListener("message",_=>{this.onMessage(_)}),this.setInfoInterval(S)}static initWebAudio(){const D=d.audioCtx=new AudioContext({sampleRate:w.SAMPLE_RATE}),A=D.createBufferSource();A.connect(D.destination),A.start(0),D.resume(),A.stop()}static hookInitWebAudio(D){const A=document.querySelectorAll(D);A.forEach(S=>{S.addEventListener("click",function _(){d.audioCtx||d.initWebAudio(),A.forEach(B=>{B.removeEventListener("click",_,!0)})},!0)})}static prepare(D){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{d.hookInitWebAudio(D)}):d.hookInitWebAudio(D)}onMessage(D){const A=D.data;switch(A.type){case w.MsgTypes.COMPCOMP:this.totalMSec=A.info.totalMSec,this.totalTimeStr=A.info.totalTimeStr,this.warnings=A.info.warnings,this.metaTitle=A.info.metaTitle,this.metaComment=A.info.metaComment,this.metaArtist=A.info.metaArtist,this.metaCoding=A.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case w.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(A),this.trigger("buffering",{progress:A.progress});break;case w.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case w.MsgTypes.SYNCINFO:this._isPlaying=A.info._isPlaying,this._isPaused=A.info._isPaused,this.nowMSec=A.info.nowMSec,this.nowTimeStr=A.info.nowTimeStr,this.voiceCount=A.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case w.MsgTypes.PLAYSOUND:this.playSound();break;case w.MsgTypes.STOPSOUND:this.stopSound();break;case w.MsgTypes.EXPORT:A.data?this.completeAudioExport(A.data):this.errorAudioExport(A.errorMsg)}}boot(){this.worker.postMessage({type:w.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const D=d.audioCtx,A=this.gainNode=D.createGain();A.gain.value=this.volume/127,A.connect(D.destination),b(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(_=>{const B=new FileReader;B.onload=Y=>{D.audioWorklet.addModule(Y.target.result).then(_)},B.readAsDataURL(new Blob([R.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const S=this.workletNode=new AudioWorkletNode(D,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});S.connect(A),this.worker.postMessage({type:w.MsgTypes.PLAYSOUND,workletPort:S.port},[S.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:w.MsgTypes.STOPSOUND})}trigger(D,A){const S=this.events[D];if(!S)return;const _={};for(let B in A)_[B]=A[B];for(let B=0,Y=S.length;B<Y;B++)S[B]&&S[B].call(this,_)}exportAudio(D,A,S={}){return d.audioCtx||d.initWebAudio(),this.booted||this.boot(),new Promise((_,B)=>{this.audioExportResolve?B(new I.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:w.MsgTypes.EXPORT,mml:D,format:A},S)),this.audioExportResolve=_,this.audioExportReject=B)})}completeAudioExport(D){this.audioExportResolve&&(this.audioExportResolve(D),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(D){this.audioExportReject&&(this.audioExportReject(new I.FlMMLAudioExportError(D)),this.audioExportResolve=null,this.audioExportReject=null)}play(D){d.audioCtx||d.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:w.MsgTypes.PLAY,mml:D})}stop(){this.worker.postMessage({type:w.MsgTypes.STOP})}pause(){this.worker.postMessage({type:w.MsgTypes.PAUSE})}exportWav(D){return this.exportAudio(D,"wav")}exportMp3(D,A){return this.exportAudio(D,"mp3",{bitrate:A})}setMasterVolume(D){this.volume=D,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(D){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:D})}syncInfo(){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:null})}addEventListener(D,A){let S=this.events[D];S||(S=this.events[D]=[]);for(let _=S.length;_--;)if(S[_]===A)return!1;return S.push(A),!0}removeEventListener(D,A){const S=this.events[D];if(!S)return!1;for(let _=S.length;_--;)if(S[_]===A)return S.splice(_,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}y.FlMML=d,y.FlMMLonHTML5=d}).apply(i,h))===void 0||(t.exports=f)},158:(t,i,p)=>{p.r(i),p.d(i,{FlMMLWorkletScript:()=>h});const h='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},a={};function o(t){var i=a[t];if(i!==void 0)return i.exports;var p=a[t]={exports:{}};return r[t].call(p.exports,p,p.exports,o),p.exports}return o.d=(t,i)=>{for(var p in i)o.o(i,p)&&!o.o(t,p)&&Object.defineProperty(t,p,{enumerable:!0,get:i[p]})},o.o=(t,i)=>Object.prototype.hasOwnProperty.call(t,i),o.r=t=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o(643)})()})})(hr);var pr=hr.exports;function xt(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var vr={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(r){n.exports=r()})(function(){return function r(a,o,t){function i(f,b){if(!o[f]){if(!a[f]){var m=typeof xt=="function"&&xt;if(!b&&m)return m(f,!0);if(p)return p(f,!0);var y=new Error("Cannot find module '"+f+"'");throw y.code="MODULE_NOT_FOUND",y}var w=o[f]={exports:{}};a[f][0].call(w.exports,function(I){var R=a[f][1][I];return i(R||I)},w,w.exports,r,a,o,t)}return o[f].exports}for(var p=typeof xt=="function"&&xt,h=0;h<t.length;h++)i(t[h]);return i}({1:[function(r,a,o){(function(t){var i=t.MutationObserver||t.WebKitMutationObserver,p;if(i){var h=0,f=new i(I),b=t.document.createTextNode("");f.observe(b,{characterData:!0}),p=function(){b.data=h=++h%2}}else if(!t.setImmediate&&typeof t.MessageChannel<"u"){var m=new t.MessageChannel;m.port1.onmessage=I,p=function(){m.port2.postMessage(0)}}else"document"in t&&"onreadystatechange"in t.document.createElement("script")?p=function(){var l=t.document.createElement("script");l.onreadystatechange=function(){I(),l.onreadystatechange=null,l.parentNode.removeChild(l),l=null},t.document.documentElement.appendChild(l)}:p=function(){setTimeout(I,0)};var y,w=[];function I(){y=!0;for(var l,d,F=w.length;F;){for(d=w,w=[],l=-1;++l<F;)d[l]();F=w.length}y=!1}a.exports=R;function R(l){w.push(l)===1&&!y&&p()}}).call(this,typeof ft<"u"?ft:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,a,o){var t=r(1);function i(){}var p={},h=["REJECTED"],f=["FULFILLED"],b=["PENDING"];a.exports=m;function m(S){if(typeof S!="function")throw new TypeError("resolver must be a function");this.state=b,this.queue=[],this.outcome=void 0,S!==i&&R(this,S)}m.prototype.catch=function(S){return this.then(null,S)},m.prototype.then=function(S,_){if(typeof S!="function"&&this.state===f||typeof _!="function"&&this.state===h)return this;var B=new this.constructor(i);if(this.state!==b){var Y=this.state===f?S:_;w(B,Y,this.outcome)}else this.queue.push(new y(B,S,_));return B};function y(S,_,B){this.promise=S,typeof _=="function"&&(this.onFulfilled=_,this.callFulfilled=this.otherCallFulfilled),typeof B=="function"&&(this.onRejected=B,this.callRejected=this.otherCallRejected)}y.prototype.callFulfilled=function(S){p.resolve(this.promise,S)},y.prototype.otherCallFulfilled=function(S){w(this.promise,this.onFulfilled,S)},y.prototype.callRejected=function(S){p.reject(this.promise,S)},y.prototype.otherCallRejected=function(S){w(this.promise,this.onRejected,S)};function w(S,_,B){t(function(){var Y;try{Y=_(B)}catch(ce){return p.reject(S,ce)}Y===S?p.reject(S,new TypeError("Cannot resolve promise with itself")):p.resolve(S,Y)})}p.resolve=function(S,_){var B=l(I,_);if(B.status==="error")return p.reject(S,B.value);var Y=B.value;if(Y)R(S,Y);else{S.state=f,S.outcome=_;for(var ce=-1,ae=S.queue.length;++ce<ae;)S.queue[ce].callFulfilled(_)}return S},p.reject=function(S,_){S.state=h,S.outcome=_;for(var B=-1,Y=S.queue.length;++B<Y;)S.queue[B].callRejected(_);return S};function I(S){var _=S&&S.then;if(S&&(typeof S=="object"||typeof S=="function")&&typeof _=="function")return function(){_.apply(S,arguments)}}function R(S,_){var B=!1;function Y(pe){B||(B=!0,p.reject(S,pe))}function ce(pe){B||(B=!0,p.resolve(S,pe))}function ae(){_(ce,Y)}var he=l(ae);he.status==="error"&&Y(he.value)}function l(S,_){var B={};try{B.value=S(_),B.status="success"}catch(Y){B.status="error",B.value=Y}return B}m.resolve=d;function d(S){return S instanceof this?S:p.resolve(new this(i),S)}m.reject=F;function F(S){var _=new this(i);return p.reject(_,S)}m.all=D;function D(S){var _=this;if(Object.prototype.toString.call(S)!=="[object Array]")return this.reject(new TypeError("must be an array"));var B=S.length,Y=!1;if(!B)return this.resolve([]);for(var ce=new Array(B),ae=0,he=-1,pe=new this(i);++he<B;)Z(S[he],he);return pe;function Z(M,k){_.resolve(M).then(V,function(W){Y||(Y=!0,p.reject(pe,W))});function V(W){ce[k]=W,++ae===B&&!Y&&(Y=!0,p.resolve(pe,ce))}}}m.race=A;function A(S){var _=this;if(Object.prototype.toString.call(S)!=="[object Array]")return this.reject(new TypeError("must be an array"));var B=S.length,Y=!1;if(!B)return this.resolve([]);for(var ce=-1,ae=new this(i);++ce<B;)he(S[ce]);return ae;function he(pe){_.resolve(pe).then(function(Z){Y||(Y=!0,p.resolve(ae,Z))},function(Z){Y||(Y=!0,p.reject(ae,Z))})}}},{1:1}],3:[function(r,a,o){(function(t){typeof t.Promise!="function"&&(t.Promise=r(2))}).call(this,typeof ft<"u"?ft:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,a,o){var t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s};function i(s,u){if(!(s instanceof u))throw new TypeError("Cannot call a class as a function")}function p(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var h=p();function f(){try{if(!h||!h.open)return!1;var s=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),u=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!s||u)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function b(s,u){s=s||[],u=u||{};try{return new Blob(s,u)}catch(v){if(v.name!=="TypeError")throw v;for(var c=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,g=new c,E=0;E<s.length;E+=1)g.append(s[E]);return g.getBlob(u.type)}}typeof Promise>"u"&&r(3);var m=Promise;function y(s,u){u&&s.then(function(c){u(null,c)},function(c){u(c)})}function w(s,u,c){typeof u=="function"&&s.then(u),typeof c=="function"&&s.catch(c)}function I(s){return typeof s!="string"&&(console.warn(s+" used as a key, but it is not a string."),s=String(s)),s}function R(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var l="local-forage-detect-blob-support",d=void 0,F={},D=Object.prototype.toString,A="readonly",S="readwrite";function _(s){for(var u=s.length,c=new ArrayBuffer(u),g=new Uint8Array(c),E=0;E<u;E++)g[E]=s.charCodeAt(E);return c}function B(s){return new m(function(u){var c=s.transaction(l,S),g=b([""]);c.objectStore(l).put(g,"key"),c.onabort=function(E){E.preventDefault(),E.stopPropagation(),u(!1)},c.oncomplete=function(){var E=navigator.userAgent.match(/Chrome\/(\d+)/),v=navigator.userAgent.match(/Edge\//);u(v||!E||parseInt(E[1],10)>=43)}}).catch(function(){return!1})}function Y(s){return typeof d=="boolean"?m.resolve(d):B(s).then(function(u){return d=u,d})}function ce(s){var u=F[s.name],c={};c.promise=new m(function(g,E){c.resolve=g,c.reject=E}),u.deferredOperations.push(c),u.dbReady?u.dbReady=u.dbReady.then(function(){return c.promise}):u.dbReady=c.promise}function ae(s){var u=F[s.name],c=u.deferredOperations.pop();if(c)return c.resolve(),c.promise}function he(s,u){var c=F[s.name],g=c.deferredOperations.pop();if(g)return g.reject(u),g.promise}function pe(s,u){return new m(function(c,g){if(F[s.name]=F[s.name]||te(),s.db)if(u)ce(s),s.db.close();else return c(s.db);var E=[s.name];u&&E.push(s.version);var v=h.open.apply(h,E);u&&(v.onupgradeneeded=function(N){var L=v.result;try{L.createObjectStore(s.storeName),N.oldVersion<=1&&L.createObjectStore(l)}catch(P){if(P.name==="ConstraintError")console.warn('The database "'+s.name+'" has been upgraded from version '+N.oldVersion+" to version "+N.newVersion+', but the storage "'+s.storeName+'" already exists.');else throw P}}),v.onerror=function(N){N.preventDefault(),g(v.error)},v.onsuccess=function(){var N=v.result;N.onversionchange=function(L){L.target.close()},c(N),ae(s)}})}function Z(s){return pe(s,!1)}function M(s){return pe(s,!0)}function k(s,u){if(!s.db)return!0;var c=!s.db.objectStoreNames.contains(s.storeName),g=s.version<s.db.version,E=s.version>s.db.version;if(g&&(s.version!==u&&console.warn('The database "'+s.name+`" can't be downgraded from version `+s.db.version+" to version "+s.version+"."),s.version=s.db.version),E||c){if(c){var v=s.db.version+1;v>s.version&&(s.version=v)}return!0}return!1}function V(s){return new m(function(u,c){var g=new FileReader;g.onerror=c,g.onloadend=function(E){var v=btoa(E.target.result||"");u({__local_forage_encoded_blob:!0,data:v,type:s.type})},g.readAsBinaryString(s)})}function W(s){var u=_(atob(s.data));return b([u],{type:s.type})}function G(s){return s&&s.__local_forage_encoded_blob}function O(s){var u=this,c=u._initReady().then(function(){var g=F[u._dbInfo.name];if(g&&g.dbReady)return g.dbReady});return w(c,s,s),c}function Q(s){ce(s);for(var u=F[s.name],c=u.forages,g=0;g<c.length;g++){var E=c[g];E._dbInfo.db&&(E._dbInfo.db.close(),E._dbInfo.db=null)}return s.db=null,Z(s).then(function(v){return s.db=v,k(s)?M(s):v}).then(function(v){s.db=u.db=v;for(var N=0;N<c.length;N++)c[N]._dbInfo.db=v}).catch(function(v){throw he(s,v),v})}function J(s,u,c,g){g===void 0&&(g=1);try{var E=s.db.transaction(s.storeName,u);c(null,E)}catch(v){if(g>0&&(!s.db||v.name==="InvalidStateError"||v.name==="NotFoundError"))return m.resolve().then(function(){if(!s.db||v.name==="NotFoundError"&&!s.db.objectStoreNames.contains(s.storeName)&&s.version<=s.db.version)return s.db&&(s.version=s.db.version+1),M(s)}).then(function(){return Q(s).then(function(){J(s,u,c,g-1)})}).catch(c);c(v)}}function te(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function ye(s){var u=this,c={db:null};if(s)for(var g in s)c[g]=s[g];var E=F[c.name];E||(E=te(),F[c.name]=E),E.forages.push(u),u._initReady||(u._initReady=u.ready,u.ready=O);var v=[];function N(){return m.resolve()}for(var L=0;L<E.forages.length;L++){var P=E.forages[L];P!==u&&v.push(P._initReady().catch(N))}var j=E.forages.slice(0);return m.all(v).then(function(){return c.db=E.db,Z(c)}).then(function($){return c.db=$,k(c,u._defaultConfig.version)?M(c):$}).then(function($){c.db=E.db=$,u._dbInfo=c;for(var z=0;z<j.length;z++){var ee=j[z];ee!==u&&(ee._dbInfo.db=c.db,ee._dbInfo.version=c.version)}})}function ke(s,u){var c=this;s=I(s);var g=new m(function(E,v){c.ready().then(function(){J(c._dbInfo,A,function(N,L){if(N)return v(N);try{var P=L.objectStore(c._dbInfo.storeName),j=P.get(s);j.onsuccess=function(){var $=j.result;$===void 0&&($=null),G($)&&($=W($)),E($)},j.onerror=function(){v(j.error)}}catch($){v($)}})}).catch(v)});return y(g,u),g}function de(s,u){var c=this,g=new m(function(E,v){c.ready().then(function(){J(c._dbInfo,A,function(N,L){if(N)return v(N);try{var P=L.objectStore(c._dbInfo.storeName),j=P.openCursor(),$=1;j.onsuccess=function(){var z=j.result;if(z){var ee=z.value;G(ee)&&(ee=W(ee));var ie=s(ee,z.key,$++);ie!==void 0?E(ie):z.continue()}else E()},j.onerror=function(){v(j.error)}}catch(z){v(z)}})}).catch(v)});return y(g,u),g}function x(s,u,c){var g=this;s=I(s);var E=new m(function(v,N){var L;g.ready().then(function(){return L=g._dbInfo,D.call(u)==="[object Blob]"?Y(L.db).then(function(P){return P?u:V(u)}):u}).then(function(P){J(g._dbInfo,S,function(j,$){if(j)return N(j);try{var z=$.objectStore(g._dbInfo.storeName);P===null&&(P=void 0);var ee=z.put(P,s);$.oncomplete=function(){P===void 0&&(P=null),v(P)},$.onabort=$.onerror=function(){var ie=ee.error?ee.error:ee.transaction.error;N(ie)}}catch(ie){N(ie)}})}).catch(N)});return y(E,c),E}function U(s,u){var c=this;s=I(s);var g=new m(function(E,v){c.ready().then(function(){J(c._dbInfo,S,function(N,L){if(N)return v(N);try{var P=L.objectStore(c._dbInfo.storeName),j=P.delete(s);L.oncomplete=function(){E()},L.onerror=function(){v(j.error)},L.onabort=function(){var $=j.error?j.error:j.transaction.error;v($)}}catch($){v($)}})}).catch(v)});return y(g,u),g}function H(s){var u=this,c=new m(function(g,E){u.ready().then(function(){J(u._dbInfo,S,function(v,N){if(v)return E(v);try{var L=N.objectStore(u._dbInfo.storeName),P=L.clear();N.oncomplete=function(){g()},N.onabort=N.onerror=function(){var j=P.error?P.error:P.transaction.error;E(j)}}catch(j){E(j)}})}).catch(E)});return y(c,s),c}function q(s){var u=this,c=new m(function(g,E){u.ready().then(function(){J(u._dbInfo,A,function(v,N){if(v)return E(v);try{var L=N.objectStore(u._dbInfo.storeName),P=L.count();P.onsuccess=function(){g(P.result)},P.onerror=function(){E(P.error)}}catch(j){E(j)}})}).catch(E)});return y(c,s),c}function se(s,u){var c=this,g=new m(function(E,v){if(s<0){E(null);return}c.ready().then(function(){J(c._dbInfo,A,function(N,L){if(N)return v(N);try{var P=L.objectStore(c._dbInfo.storeName),j=!1,$=P.openKeyCursor();$.onsuccess=function(){var z=$.result;if(!z){E(null);return}s===0||j?E(z.key):(j=!0,z.advance(s))},$.onerror=function(){v($.error)}}catch(z){v(z)}})}).catch(v)});return y(g,u),g}function ne(s){var u=this,c=new m(function(g,E){u.ready().then(function(){J(u._dbInfo,A,function(v,N){if(v)return E(v);try{var L=N.objectStore(u._dbInfo.storeName),P=L.openKeyCursor(),j=[];P.onsuccess=function(){var $=P.result;if(!$){g(j);return}j.push($.key),$.continue()},P.onerror=function(){E(P.error)}}catch($){E($)}})}).catch(E)});return y(c,s),c}function Te(s,u){u=R.apply(this,arguments);var c=this.config();s=typeof s!="function"&&s||{},s.name||(s.name=s.name||c.name,s.storeName=s.storeName||c.storeName);var g=this,E;if(!s.name)E=m.reject("Invalid arguments");else{var v=s.name===c.name&&g._dbInfo.db,N=v?m.resolve(g._dbInfo.db):Z(s).then(function(L){var P=F[s.name],j=P.forages;P.db=L;for(var $=0;$<j.length;$++)j[$]._dbInfo.db=L;return L});s.storeName?E=N.then(function(L){if(L.objectStoreNames.contains(s.storeName)){var P=L.version+1;ce(s);var j=F[s.name],$=j.forages;L.close();for(var z=0;z<$.length;z++){var ee=$[z];ee._dbInfo.db=null,ee._dbInfo.version=P}var ie=new m(function(le,be){var ve=h.open(s.name,P);ve.onerror=function(Ce){var ut=ve.result;ut.close(),be(Ce)},ve.onupgradeneeded=function(){var Ce=ve.result;Ce.deleteObjectStore(s.storeName)},ve.onsuccess=function(){var Ce=ve.result;Ce.close(),le(Ce)}});return ie.then(function(le){j.db=le;for(var be=0;be<$.length;be++){var ve=$[be];ve._dbInfo.db=le,ae(ve._dbInfo)}}).catch(function(le){throw(he(s,le)||m.resolve()).catch(function(){}),le})}}):E=N.then(function(L){ce(s);var P=F[s.name],j=P.forages;L.close();for(var $=0;$<j.length;$++){var z=j[$];z._dbInfo.db=null}var ee=new m(function(ie,le){var be=h.deleteDatabase(s.name);be.onerror=function(){var ve=be.result;ve&&ve.close(),le(be.error)},be.onblocked=function(){console.warn('dropInstance blocked for database "'+s.name+'" until all open connections are closed')},be.onsuccess=function(){var ve=be.result;ve&&ve.close(),ie(ve)}});return ee.then(function(ie){P.db=ie;for(var le=0;le<j.length;le++){var be=j[le];ae(be._dbInfo)}}).catch(function(ie){throw(he(s,ie)||m.resolve()).catch(function(){}),ie})})}return y(E,u),E}var Qe={_driver:"asyncStorage",_initStorage:ye,_support:f(),iterate:de,getItem:ke,setItem:x,removeItem:U,clear:H,length:q,key:se,keys:ne,dropInstance:Te};function Vr(){return typeof openDatabase=="function"}var Ue="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Wr="~~local_forage_type~",Fn=/^~~local_forage_type~([^~]+)~/,wt="__lfsc__:",en=wt.length,tn="arbf",nn="blob",$n="si08",Un="ui08",Vn="uic8",Wn="si16",zn="si32",Hn="ur16",qn="ui32",Yn="fl32",Gn="fl64",Kn=en+tn.length,Jn=Object.prototype.toString;function Xn(s){var u=s.length*.75,c=s.length,g,E=0,v,N,L,P;s[s.length-1]==="="&&(u--,s[s.length-2]==="="&&u--);var j=new ArrayBuffer(u),$=new Uint8Array(j);for(g=0;g<c;g+=4)v=Ue.indexOf(s[g]),N=Ue.indexOf(s[g+1]),L=Ue.indexOf(s[g+2]),P=Ue.indexOf(s[g+3]),$[E++]=v<<2|N>>4,$[E++]=(N&15)<<4|L>>2,$[E++]=(L&3)<<6|P&63;return j}function rn(s){var u=new Uint8Array(s),c="",g;for(g=0;g<u.length;g+=3)c+=Ue[u[g]>>2],c+=Ue[(u[g]&3)<<4|u[g+1]>>4],c+=Ue[(u[g+1]&15)<<2|u[g+2]>>6],c+=Ue[u[g+2]&63];return u.length%3===2?c=c.substring(0,c.length-1)+"=":u.length%3===1&&(c=c.substring(0,c.length-2)+"=="),c}function zr(s,u){var c="";if(s&&(c=Jn.call(s)),s&&(c==="[object ArrayBuffer]"||s.buffer&&Jn.call(s.buffer)==="[object ArrayBuffer]")){var g,E=wt;s instanceof ArrayBuffer?(g=s,E+=tn):(g=s.buffer,c==="[object Int8Array]"?E+=$n:c==="[object Uint8Array]"?E+=Un:c==="[object Uint8ClampedArray]"?E+=Vn:c==="[object Int16Array]"?E+=Wn:c==="[object Uint16Array]"?E+=Hn:c==="[object Int32Array]"?E+=zn:c==="[object Uint32Array]"?E+=qn:c==="[object Float32Array]"?E+=Yn:c==="[object Float64Array]"?E+=Gn:u(new Error("Failed to get type for BinaryArray"))),u(E+rn(g))}else if(c==="[object Blob]"){var v=new FileReader;v.onload=function(){var N=Wr+s.type+"~"+rn(this.result);u(wt+nn+N)},v.readAsArrayBuffer(s)}else try{u(JSON.stringify(s))}catch(N){console.error("Couldn't convert value into a JSON string: ",s),u(null,N)}}function Hr(s){if(s.substring(0,en)!==wt)return JSON.parse(s);var u=s.substring(Kn),c=s.substring(en,Kn),g;if(c===nn&&Fn.test(u)){var E=u.match(Fn);g=E[1],u=u.substring(E[0].length)}var v=Xn(u);switch(c){case tn:return v;case nn:return b([v],{type:g});case $n:return new Int8Array(v);case Un:return new Uint8Array(v);case Vn:return new Uint8ClampedArray(v);case Wn:return new Int16Array(v);case Hn:return new Uint16Array(v);case zn:return new Int32Array(v);case qn:return new Uint32Array(v);case Yn:return new Float32Array(v);case Gn:return new Float64Array(v);default:throw new Error("Unkown type: "+c)}}var an={serialize:zr,deserialize:Hr,stringToBuffer:Xn,bufferToString:rn};function Qn(s,u,c,g){s.executeSql("CREATE TABLE IF NOT EXISTS "+u.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],c,g)}function qr(s){var u=this,c={db:null};if(s)for(var g in s)c[g]=typeof s[g]!="string"?s[g].toString():s[g];var E=new m(function(v,N){try{c.db=openDatabase(c.name,String(c.version),c.description,c.size)}catch(L){return N(L)}c.db.transaction(function(L){Qn(L,c,function(){u._dbInfo=c,v()},function(P,j){N(j)})},N)});return c.serializer=an,E}function Ve(s,u,c,g,E,v){s.executeSql(c,g,E,function(N,L){L.code===L.SYNTAX_ERR?N.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[u.storeName],function(P,j){j.rows.length?v(P,L):Qn(P,u,function(){P.executeSql(c,g,E,v)},v)},v):v(N,L)},v)}function Yr(s,u){var c=this;s=I(s);var g=new m(function(E,v){c.ready().then(function(){var N=c._dbInfo;N.db.transaction(function(L){Ve(L,N,"SELECT * FROM "+N.storeName+" WHERE key = ? LIMIT 1",[s],function(P,j){var $=j.rows.length?j.rows.item(0).value:null;$&&($=N.serializer.deserialize($)),E($)},function(P,j){v(j)})})}).catch(v)});return y(g,u),g}function Gr(s,u){var c=this,g=new m(function(E,v){c.ready().then(function(){var N=c._dbInfo;N.db.transaction(function(L){Ve(L,N,"SELECT * FROM "+N.storeName,[],function(P,j){for(var $=j.rows,z=$.length,ee=0;ee<z;ee++){var ie=$.item(ee),le=ie.value;if(le&&(le=N.serializer.deserialize(le)),le=s(le,ie.key,ee+1),le!==void 0){E(le);return}}E()},function(P,j){v(j)})})}).catch(v)});return y(g,u),g}function Zn(s,u,c,g){var E=this;s=I(s);var v=new m(function(N,L){E.ready().then(function(){u===void 0&&(u=null);var P=u,j=E._dbInfo;j.serializer.serialize(u,function($,z){z?L(z):j.db.transaction(function(ee){Ve(ee,j,"INSERT OR REPLACE INTO "+j.storeName+" (key, value) VALUES (?, ?)",[s,$],function(){N(P)},function(ie,le){L(le)})},function(ee){if(ee.code===ee.QUOTA_ERR){if(g>0){N(Zn.apply(E,[s,P,c,g-1]));return}L(ee)}})})}).catch(L)});return y(v,c),v}function Kr(s,u,c){return Zn.apply(this,[s,u,c,1])}function Jr(s,u){var c=this;s=I(s);var g=new m(function(E,v){c.ready().then(function(){var N=c._dbInfo;N.db.transaction(function(L){Ve(L,N,"DELETE FROM "+N.storeName+" WHERE key = ?",[s],function(){E()},function(P,j){v(j)})})}).catch(v)});return y(g,u),g}function Xr(s){var u=this,c=new m(function(g,E){u.ready().then(function(){var v=u._dbInfo;v.db.transaction(function(N){Ve(N,v,"DELETE FROM "+v.storeName,[],function(){g()},function(L,P){E(P)})})}).catch(E)});return y(c,s),c}function Qr(s){var u=this,c=new m(function(g,E){u.ready().then(function(){var v=u._dbInfo;v.db.transaction(function(N){Ve(N,v,"SELECT COUNT(key) as c FROM "+v.storeName,[],function(L,P){var j=P.rows.item(0).c;g(j)},function(L,P){E(P)})})}).catch(E)});return y(c,s),c}function Zr(s,u){var c=this,g=new m(function(E,v){c.ready().then(function(){var N=c._dbInfo;N.db.transaction(function(L){Ve(L,N,"SELECT key FROM "+N.storeName+" WHERE id = ? LIMIT 1",[s+1],function(P,j){var $=j.rows.length?j.rows.item(0).key:null;E($)},function(P,j){v(j)})})}).catch(v)});return y(g,u),g}function ea(s){var u=this,c=new m(function(g,E){u.ready().then(function(){var v=u._dbInfo;v.db.transaction(function(N){Ve(N,v,"SELECT key FROM "+v.storeName,[],function(L,P){for(var j=[],$=0;$<P.rows.length;$++)j.push(P.rows.item($).key);g(j)},function(L,P){E(P)})})}).catch(E)});return y(c,s),c}function ta(s){return new m(function(u,c){s.transaction(function(g){g.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(E,v){for(var N=[],L=0;L<v.rows.length;L++)N.push(v.rows.item(L).name);u({db:s,storeNames:N})},function(E,v){c(v)})},function(g){c(g)})})}function na(s,u){u=R.apply(this,arguments);var c=this.config();s=typeof s!="function"&&s||{},s.name||(s.name=s.name||c.name,s.storeName=s.storeName||c.storeName);var g=this,E;return s.name?E=new m(function(v){var N;s.name===c.name?N=g._dbInfo.db:N=openDatabase(s.name,"","",0),s.storeName?v({db:N,storeNames:[s.storeName]}):v(ta(N))}).then(function(v){return new m(function(N,L){v.db.transaction(function(P){function j(ie){return new m(function(le,be){P.executeSql("DROP TABLE IF EXISTS "+ie,[],function(){le()},function(ve,Ce){be(Ce)})})}for(var $=[],z=0,ee=v.storeNames.length;z<ee;z++)$.push(j(v.storeNames[z]));m.all($).then(function(){N()}).catch(function(ie){L(ie)})},function(P){L(P)})})}):E=m.reject("Invalid arguments"),y(E,u),E}var ra={_driver:"webSQLStorage",_initStorage:qr,_support:Vr(),iterate:Gr,getItem:Yr,setItem:Kr,removeItem:Jr,clear:Xr,length:Qr,key:Zr,keys:ea,dropInstance:na};function aa(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function er(s,u){var c=s.name+"/";return s.storeName!==u.storeName&&(c+=s.storeName+"/"),c}function oa(){var s="_localforage_support_test";try{return localStorage.setItem(s,!0),localStorage.removeItem(s),!1}catch{return!0}}function sa(){return!oa()||localStorage.length>0}function ia(s){var u=this,c={};if(s)for(var g in s)c[g]=s[g];return c.keyPrefix=er(s,u._defaultConfig),sa()?(u._dbInfo=c,c.serializer=an,m.resolve()):m.reject()}function ca(s){var u=this,c=u.ready().then(function(){for(var g=u._dbInfo.keyPrefix,E=localStorage.length-1;E>=0;E--){var v=localStorage.key(E);v.indexOf(g)===0&&localStorage.removeItem(v)}});return y(c,s),c}function la(s,u){var c=this;s=I(s);var g=c.ready().then(function(){var E=c._dbInfo,v=localStorage.getItem(E.keyPrefix+s);return v&&(v=E.serializer.deserialize(v)),v});return y(g,u),g}function ua(s,u){var c=this,g=c.ready().then(function(){for(var E=c._dbInfo,v=E.keyPrefix,N=v.length,L=localStorage.length,P=1,j=0;j<L;j++){var $=localStorage.key(j);if($.indexOf(v)===0){var z=localStorage.getItem($);if(z&&(z=E.serializer.deserialize(z)),z=s(z,$.substring(N),P++),z!==void 0)return z}}});return y(g,u),g}function da(s,u){var c=this,g=c.ready().then(function(){var E=c._dbInfo,v;try{v=localStorage.key(s)}catch{v=null}return v&&(v=v.substring(E.keyPrefix.length)),v});return y(g,u),g}function fa(s){var u=this,c=u.ready().then(function(){for(var g=u._dbInfo,E=localStorage.length,v=[],N=0;N<E;N++){var L=localStorage.key(N);L.indexOf(g.keyPrefix)===0&&v.push(L.substring(g.keyPrefix.length))}return v});return y(c,s),c}function ma(s){var u=this,c=u.keys().then(function(g){return g.length});return y(c,s),c}function ha(s,u){var c=this;s=I(s);var g=c.ready().then(function(){var E=c._dbInfo;localStorage.removeItem(E.keyPrefix+s)});return y(g,u),g}function pa(s,u,c){var g=this;s=I(s);var E=g.ready().then(function(){u===void 0&&(u=null);var v=u;return new m(function(N,L){var P=g._dbInfo;P.serializer.serialize(u,function(j,$){if($)L($);else try{localStorage.setItem(P.keyPrefix+s,j),N(v)}catch(z){(z.name==="QuotaExceededError"||z.name==="NS_ERROR_DOM_QUOTA_REACHED")&&L(z),L(z)}})})});return y(E,c),E}function va(s,u){if(u=R.apply(this,arguments),s=typeof s!="function"&&s||{},!s.name){var c=this.config();s.name=s.name||c.name,s.storeName=s.storeName||c.storeName}var g=this,E;return s.name?E=new m(function(v){s.storeName?v(er(s,g._defaultConfig)):v(s.name+"/")}).then(function(v){for(var N=localStorage.length-1;N>=0;N--){var L=localStorage.key(N);L.indexOf(v)===0&&localStorage.removeItem(L)}}):E=m.reject("Invalid arguments"),y(E,u),E}var ga={_driver:"localStorageWrapper",_initStorage:ia,_support:aa(),iterate:ua,getItem:la,setItem:pa,removeItem:ha,clear:ca,length:ma,key:da,keys:fa,dropInstance:va},ya=function(u,c){return u===c||typeof u=="number"&&typeof c=="number"&&isNaN(u)&&isNaN(c)},ba=function(u,c){for(var g=u.length,E=0;E<g;){if(ya(u[E],c))return!0;E++}return!1},tr=Array.isArray||function(s){return Object.prototype.toString.call(s)==="[object Array]"},lt={},nr={},Ze={INDEXEDDB:Qe,WEBSQL:ra,LOCALSTORAGE:ga},Ea=[Ze.INDEXEDDB._driver,Ze.WEBSQL._driver,Ze.LOCALSTORAGE._driver],Tt=["dropInstance"],on=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(Tt),Sa={description:"",driver:Ea.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function wa(s,u){s[u]=function(){var c=arguments;return s.ready().then(function(){return s[u].apply(s,c)})}}function sn(){for(var s=1;s<arguments.length;s++){var u=arguments[s];if(u)for(var c in u)u.hasOwnProperty(c)&&(tr(u[c])?arguments[0][c]=u[c].slice():arguments[0][c]=u[c])}return arguments[0]}var Ta=function(){function s(u){i(this,s);for(var c in Ze)if(Ze.hasOwnProperty(c)){var g=Ze[c],E=g._driver;this[c]=E,lt[E]||this.defineDriver(g)}this._defaultConfig=sn({},Sa),this._config=sn({},this._defaultConfig,u),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return s.prototype.config=function(c){if((typeof c>"u"?"undefined":t(c))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var g in c){if(g==="storeName"&&(c[g]=c[g].replace(/\W/g,"_")),g==="version"&&typeof c[g]!="number")return new Error("Database version must be a number.");this._config[g]=c[g]}return"driver"in c&&c.driver?this.setDriver(this._config.driver):!0}else return typeof c=="string"?this._config[c]:this._config},s.prototype.defineDriver=function(c,g,E){var v=new m(function(N,L){try{var P=c._driver,j=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!c._driver){L(j);return}for(var $=on.concat("_initStorage"),z=0,ee=$.length;z<ee;z++){var ie=$[z],le=!ba(Tt,ie);if((le||c[ie])&&typeof c[ie]!="function"){L(j);return}}var be=function(){for(var ut=function(Na){return function(){var Ia=new Error("Method "+Na+" is not implemented by the current driver"),rr=m.reject(Ia);return y(rr,arguments[arguments.length-1]),rr}},cn=0,ka=Tt.length;cn<ka;cn++){var ln=Tt[cn];c[ln]||(c[ln]=ut(ln))}};be();var ve=function(ut){lt[P]&&console.info("Redefining LocalForage driver: "+P),lt[P]=c,nr[P]=ut,N()};"_support"in c?c._support&&typeof c._support=="function"?c._support().then(ve,L):ve(!!c._support):ve(!0)}catch(Ce){L(Ce)}});return w(v,g,E),v},s.prototype.driver=function(){return this._driver||null},s.prototype.getDriver=function(c,g,E){var v=lt[c]?m.resolve(lt[c]):m.reject(new Error("Driver not found."));return w(v,g,E),v},s.prototype.getSerializer=function(c){var g=m.resolve(an);return w(g,c),g},s.prototype.ready=function(c){var g=this,E=g._driverSet.then(function(){return g._ready===null&&(g._ready=g._initDriver()),g._ready});return w(E,c,c),E},s.prototype.setDriver=function(c,g,E){var v=this;tr(c)||(c=[c]);var N=this._getSupportedDrivers(c);function L(){v._config.driver=v.driver()}function P(z){return v._extend(z),L(),v._ready=v._initStorage(v._config),v._ready}function j(z){return function(){var ee=0;function ie(){for(;ee<z.length;){var le=z[ee];return ee++,v._dbInfo=null,v._ready=null,v.getDriver(le).then(P).catch(ie)}L();var be=new Error("No available storage method found.");return v._driverSet=m.reject(be),v._driverSet}return ie()}}var $=this._driverSet!==null?this._driverSet.catch(function(){return m.resolve()}):m.resolve();return this._driverSet=$.then(function(){var z=N[0];return v._dbInfo=null,v._ready=null,v.getDriver(z).then(function(ee){v._driver=ee._driver,L(),v._wrapLibraryMethodsWithReady(),v._initDriver=j(N)})}).catch(function(){L();var z=new Error("No available storage method found.");return v._driverSet=m.reject(z),v._driverSet}),w(this._driverSet,g,E),this._driverSet},s.prototype.supports=function(c){return!!nr[c]},s.prototype._extend=function(c){sn(this,c)},s.prototype._getSupportedDrivers=function(c){for(var g=[],E=0,v=c.length;E<v;E++){var N=c[E];this.supports(N)&&g.push(N)}return g},s.prototype._wrapLibraryMethodsWithReady=function(){for(var c=0,g=on.length;c<g;c++)wa(this,on[c])},s.prototype.createInstance=function(c){return new s(c)},s}(),xa=new Ta;a.exports=xa},{3:3}]},{},[4])(4)})})(vr);var Ma=vr.exports;const En=Da(Ma);function kt(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function fn(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const Aa=1,La=1,Xe="emoji",st="keyvalue",Ln="favorites",_a="tokens",gr="tokens",Oa="unicode",yr="count",Pa="group",ja="order",br="group-order",Sn="eTag",Lt="url",ar="skinTone",ct="readonly",_n="readwrite",Er="skinUnicodes",Ba="skinUnicodes",Ra="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Fa="en";function $a(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function or(n){return $a(n,e=>e.unicode)}function Ua(n){function e(r,a,o){const t=a?n.createObjectStore(r,{keyPath:a}):n.createObjectStore(r);if(o)for(const[i,[p,h]]of Object.entries(o))t.createIndex(i,p,{multiEntry:h});return t}e(st),e(Xe,Oa,{[gr]:[_a,!0],[br]:[[Pa,ja]],[Er]:[Ba,!0]}),e(Ln,void 0,{[yr]:[""]})}const wn={},Dt={},_t={};function Sr(n,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>n(r.result)}async function Va(n){const e=await new Promise((r,a)=>{const o=indexedDB.open(n,Aa);wn[n]=o,o.onupgradeneeded=t=>{t.oldVersion<La&&Ua(o.result)},Sr(r,a,o)});return e.onclose=()=>On(n),e}function Wa(n){return Dt[n]||(Dt[n]=Va(n)),Dt[n]}function $e(n,e,r,a){return new Promise((o,t)=>{const i=n.transaction(e,r,{durability:"relaxed"}),p=typeof e=="string"?i.objectStore(e):e.map(f=>i.objectStore(f));let h;a(p,i,f=>{h=f}),i.oncomplete=()=>o(h),i.onerror=()=>t(i.error)})}function On(n){const e=wn[n],r=e&&e.result;if(r){r.close();const a=_t[n];if(a)for(const o of a)o()}delete wn[n],delete Dt[n],delete _t[n]}function za(n){return new Promise((e,r)=>{On(n);const a=indexedDB.deleteDatabase(n);Sr(e,r,a)})}function Ha(n,e){let r=_t[n];r||(r=_t[n]=[]),r.push(e)}const qa=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function et(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||qa.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const Ya=2;function wr(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Ya)}function Ga(n){return n.map(({annotation:r,emoticon:a,group:o,order:t,shortcodes:i,skins:p,tags:h,emoji:f,version:b})=>{const m=[...new Set(wr([...(i||[]).map(et).flat(),...h.map(et).flat(),...et(r),a]))].sort(),y={annotation:r,group:o,order:t,tags:h,tokens:m,unicode:f,version:b};if(a&&(y.emoticon=a),i&&(y.shortcodes=i),p){y.skinTones=[],y.skinUnicodes=[],y.skinVersions=[];for(const{tone:w,emoji:I,version:R}of p)y.skinTones.push(w),y.skinUnicodes.push(I),y.skinVersions.push(R)}return y})}function Tr(n,e,r,a){n[e](r).onsuccess=o=>a&&a(o.target.result)}function Je(n,e,r){Tr(n,"get",e,r)}function xr(n,e,r){Tr(n,"getAll",e,r)}function Pn(n){n.commit&&n.commit()}function Ka(n,e){let r=n[0];for(let a=1;a<n.length;a++){const o=n[a];e(r)>e(o)&&(r=o)}return r}function kr(n,e){const r=Ka(n,o=>o.length),a=[];for(const o of r)n.some(t=>t.findIndex(i=>e(i)===e(o))===-1)||a.push(o);return a}async function Ja(n){return!await jn(n,st,Lt)}async function Xa(n,e,r){const[a,o]=await Promise.all([Sn,Lt].map(t=>jn(n,st,t)));return a===r&&o===e}async function Qa(n,e){return $e(n,Xe,ct,(a,o,t)=>{let i;const p=()=>{a.getAll(i&&IDBKeyRange.lowerBound(i,!0),50).onsuccess=h=>{const f=h.target.result;for(const b of f)if(i=b.unicode,e(b))return t(b);if(f.length<50)return t();p()}};p()})}async function Nr(n,e,r,a){try{const o=Ga(e);await $e(n,[Xe,st],_n,([t,i],p)=>{let h,f,b=0;function m(){++b===2&&y()}function y(){if(!(h===a&&f===r)){t.clear();for(const w of o)t.put(w);i.put(a,Sn),i.put(r,Lt),Pn(p)}}Je(i,Sn,w=>{h=w,m()}),Je(i,Lt,w=>{f=w,m()})})}finally{}}async function Za(n,e){return $e(n,Xe,ct,(r,a,o)=>{const t=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);xr(r.index(br),t,o)})}async function Ir(n,e){const r=wr(et(e));return r.length?$e(n,Xe,ct,(a,o,t)=>{const i=[],p=()=>{i.length===r.length&&h()},h=()=>{const f=kr(i,b=>b.unicode);t(f.sort((b,m)=>b.order<m.order?-1:1))};for(let f=0;f<r.length;f++){const b=r[f],m=f===r.length-1?IDBKeyRange.bound(b,b+"￿",!1,!0):IDBKeyRange.only(b);xr(a.index(gr),m,y=>{i.push(y),p()})}}):[]}async function eo(n,e){const r=await Ir(n,e);return r.length?r.filter(a=>(a.shortcodes||[]).map(t=>t.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Qa(n,o=>(o.shortcodes||[]).includes(e.toLowerCase()))||null}async function to(n,e){return $e(n,Xe,ct,(r,a,o)=>Je(r,e,t=>{if(t)return o(t);Je(r.index(Er),e,i=>o(i||null))}))}function jn(n,e,r){return $e(n,e,ct,(a,o,t)=>Je(a,r,t))}function no(n,e,r,a){return $e(n,e,_n,(o,t)=>{o.put(a,r),Pn(t)})}function ro(n,e){return $e(n,Ln,_n,(r,a)=>Je(r,e,o=>{r.put((o||0)+1,e),Pn(a)}))}function ao(n,e,r){return r===0?[]:$e(n,[Ln,Xe],ct,([a,o],t,i)=>{const p=[];a.index(yr).openCursor(void 0,"prev").onsuccess=h=>{const f=h.target.result;if(!f)return i(p);function b(w){if(p.push(w),p.length===r)return i(p);f.continue()}const m=f.primaryKey,y=e.byName(m);if(y)return b(y);Je(o,m,w=>{if(w)return b(w);f.continue()})}})}const Nt="";function oo(n,e){const r=new Map;for(const o of n){const t=e(o);for(const i of t){let p=r;for(let f=0;f<i.length;f++){const b=i.charAt(f);let m=p.get(b);m||(m=new Map,p.set(b,m)),p=m}let h=p.get(Nt);h||(h=[],p.set(Nt,h)),h.push(o)}}return(o,t)=>{let i=r;for(let f=0;f<o.length;f++){const b=o.charAt(f),m=i.get(b);if(m)i=m;else return[]}if(t)return i.get(Nt)||[];const p=[],h=[i];for(;h.length;){const b=[...h.shift().entries()].sort((m,y)=>m[0]<y[0]?-1:1);for(const[m,y]of b)m===Nt?p.push(...y):h.push(y)}return p}}const so=["name","url"];function io(n){const e=n&&Array.isArray(n),r=e&&n.length&&(!n[0]||so.some(a=>!(a in n[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function sr(n){io(n);const e=(y,w)=>y.name.toLowerCase()<w.name.toLowerCase()?-1:1,r=n.sort(e),o=oo(n,y=>[...new Set((y.shortcodes||[]).map(w=>et(w)).flat())]),t=y=>o(y,!0),i=y=>o(y,!1),p=y=>{const w=et(y),I=w.map((R,l)=>(l<w.length-1?t:i)(R));return kr(I,R=>R.name).sort(e)},h=new Map,f=new Map;for(const y of n){f.set(y.name.toLowerCase(),y);for(const w of y.shortcodes||[])h.set(w.toLowerCase(),y)}return{all:r,search:p,byShortcode:y=>h.get(y.toLowerCase()),byName:y=>f.get(y.toLowerCase())}}const co=typeof wrappedJSObject<"u";function dt(n){if(!n)return n;if(co&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let r=0;r<e;r++)n.skins[r]={tone:n.skinTones[r],unicode:n.skinUnicodes[r],version:n.skinVersions[r]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function Cr(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const lo=["annotation","emoji","group","order","tags","version"];function uo(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||lo.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function Dr(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function fo(n){const e=await fetch(n,{method:"HEAD"});Dr(e,n);const r=e.headers.get("etag");return Cr(r),r}async function Tn(n){const e=await fetch(n);Dr(e,n);const r=e.headers.get("etag");Cr(r);const a=await e.json();return uo(a),[r,a]}function mo(n){for(var e="",r=new Uint8Array(n),a=r.byteLength,o=-1;++o<a;)e+=String.fromCharCode(r[o]);return e}function ho(n){for(var e=n.length,r=new ArrayBuffer(e),a=new Uint8Array(r),o=-1;++o<e;)a[o]=n.charCodeAt(o);return r}async function Mr(n){const e=JSON.stringify(n);let r=ho(e);const a=await crypto.subtle.digest("SHA-1",r),o=mo(a);return btoa(o)}async function po(n,e){let r,a=await fo(e);if(!a){const o=await Tn(e);a=o[0],r=o[1],a||(a=await Mr(r))}await Xa(n,e,a)||(r||(r=(await Tn(e))[1]),await Nr(n,r,e,a))}async function vo(n,e){let[r,a]=await Tn(e);r||(r=await Mr(a)),await Nr(n,a,e,r)}class go{constructor({dataSource:e=Ra,locale:r=Fa,customEmoji:a=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=sr(a),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await Wa(this._dbName);Ha(this._dbName,this._clear);const r=this.dataSource;await Ja(e)?await vo(e,r):this._lazyUpdate=po(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return fn(e),await this.ready(),or(await Za(this._db,e)).map(dt)}async getEmojiBySearchQuery(e){kt(e),await this.ready();const r=this._custom.search(e),a=or(await Ir(this._db,e)).map(dt);return[...r,...a]}async getEmojiByShortcode(e){kt(e),await this.ready();const r=this._custom.byShortcode(e);return r||dt(await eo(this._db,e))}async getEmojiByUnicodeOrName(e){kt(e),await this.ready();const r=this._custom.byName(e);return r||dt(await to(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await jn(this._db,st,ar)||0}async setPreferredSkinTone(e){return fn(e),await this.ready(),no(this._db,st,ar,e)}async incrementFavoriteEmojiCount(e){return kt(e),await this.ready(),ro(this._db,e)}async getTopFavoriteEmoji(e){return fn(e),await this.ready(),(await ao(this._db,this._custom,e)).map(dt)}set customEmoji(e){this._custom=sr(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await On(this._dbName)}async delete(){await this._shutdown(),await za(this._dbName)}}const xn=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([n,e,r])=>({id:n,emoji:e,name:r})),mn=xn.slice(1),yo=2,ir=6,Ar=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function cr(n){return n.unicode.includes("‍")}const bo={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},Eo=1e3,So="🖐️",wo=8,To=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],Lr='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',xo=(n,e)=>n<e?-1:n>e?1:0,lr=(n,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const a=r.getContext("2d");return a.textBaseline="top",a.font=`100px ${Lr}`,a.fillStyle=e,a.scale(.01,.01),a.fillText(n,0,0),a.getImageData(0,0,1,1).data},ko=(n,e)=>{const r=[...n].join(","),a=[...e].join(",");return r===a&&!r.startsWith("0,0,0,")};function No(n){const e=lr(n,"#000"),r=lr(n,"#fff");return e&&r&&ko(e,r)}function Io(){const n=Object.entries(bo);try{for(const[e,r]of n)if(No(e))return r}catch{}finally{}return n[0][1]}let hn;const pn=()=>(hn||(hn=new Promise(n=>Ar(()=>n(Io())))),hn),kn=new Map,Co="️",Do="\uD83C",Mo="‍",Ao=127995,Lo=57339;function _o(n,e){if(e===0)return n;const r=n.indexOf(Mo);return r!==-1?n.substring(0,r)+String.fromCodePoint(Ao+e-1)+n.substring(r):(n.endsWith(Co)&&(n=n.substring(0,n.length-1)),n+Do+String.fromCodePoint(Lo+e-1))}function _e(n){n.preventDefault(),n.stopPropagation()}function vn(n,e,r){return e+=n?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function _r(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function Oo(n,e){const r=a=>{const o={};for(const t of a)typeof t.tone=="number"&&t.version<=e&&(o[t.tone]=t.unicode);return o};return n.map(({unicode:a,skins:o,shortcodes:t,url:i,name:p,category:h,annotation:f})=>({unicode:a,name:p,shortcodes:t,url:i,category:h,annotation:f,id:a||p,skins:o&&r(o)}))}const Mt=requestAnimationFrame;let Po=typeof ResizeObserver=="function";function jo(n,e,r){let a;Po?(a=new ResizeObserver(o=>r(o[0].contentRect.width)),a.observe(n)):Mt(()=>r(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{a&&a.disconnect()})}function ur(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let gn;function Bo(n,e,r){for(const a of n){const o=r(a),t=ur(o);typeof gn>"u"&&(gn=ur(e));const i=t/1.8<gn;kn.set(a.unicode,i)}}function Ro(n){return _r(n,e=>e)}function Fo(n){n&&(n.scrollTop=0)}function ht(n,e,r){let a=n.get(e);return a||(a=r(),n.set(e,a)),a}function dr(n){return""+n}function $o(n){const e=document.createElement("template");return e.innerHTML=n,e}const Uo=new WeakMap,Vo=new WeakMap,Wo=Symbol("un-keyed"),zo="replaceChildren"in Element.prototype;function Ho(n,e){zo?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function qo(n,e){let r=n.firstChild,a=0;for(;r;){if(e[a]!==r)return!0;r=r.nextSibling,a++}return a!==e.length}function Yo(n,e){const{targetNode:r}=e;let{targetParentNode:a}=e,o=!1;a?o=qo(a,n):(o=!0,e.targetNode=void 0,e.targetParentNode=a=r.parentNode),o&&Ho(a,n)}function Go(n,e){for(const r of e){const{targetNode:a,currentExpression:o,binding:{expressionIndex:t,attributeName:i,attributeValuePre:p,attributeValuePost:h}}=r,f=n[t];if(o!==f)if(r.currentExpression=f,i)a.setAttribute(i,p+dr(f)+h);else{let b;Array.isArray(f)?Yo(f,r):f instanceof Element?(b=f,a.replaceWith(b)):a.nodeValue=dr(f),b&&(r.targetNode=b)}}}function Ko(n){let e="",r=!1,a=!1,o=-1;const t=new Map,i=[];for(let h=0,f=n.length;h<f;h++){const b=n[h];if(e+=b,h===f-1)break;for(let d=0;d<b.length;d++)switch(b.charAt(d)){case"<":{b.charAt(d+1)==="/"?i.pop():(r=!0,i.push(++o));break}case">":{r=!1,a=!1;break}case"=":{a=!0;break}}const m=i[i.length-1],y=ht(t,m,()=>[]);let w,I,R;if(a){const d=/(\S+)="?([^"=]*)$/.exec(b);w=d[1],I=d[2],R=/^[^">]*/.exec(n[h+1])[0]}const l={attributeName:w,attributeValuePre:I,attributeValuePost:R,expressionIndex:h};y.push(l),!r&&!a&&(e+=" ")}return{template:$o(e),elementsToBindings:t}}function Jo(n,e){const r=[],a=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let o=n,t=-1;do{const i=e.get(++t);if(i)for(let p=0;p<i.length;p++){const h=i[p],f=h.attributeName?o:o.firstChild,b={binding:h,targetNode:f,targetParentNode:void 0,currentExpression:void 0};r.push(b)}}while(o=a.nextNode());return r}function Xo(n){const{template:e,elementsToBindings:r}=ht(Uo,n,()=>Ko(n)),a=e.cloneNode(!0).content.firstElementChild,o=Jo(a,r);return function(i){return Go(i,o),a}}function Qo(n){const e=ht(Vo,n,()=>new Map);let r=Wo;function a(t,...i){const p=ht(e,t,()=>new Map);return ht(p,r,()=>Xo(t))(i)}function o(t,i,p){return t.map((h,f)=>{const b=r;r=p(h);try{return i(h,f)}finally{r=b}})}return{map:o,html:a}}function Zo(n,e,r,a,o,t,i,p){const{labelWithSkin:h,titleForEmoji:f,unicodeWithSkin:b}=r,{html:m,map:y}=Qo(e);function w(l,d,F){return y(l,(D,A)=>m`<button role="${d?"option":"menuitem"}" aria-selected="${e.searchMode?A===e.activeSearchItem:""}" aria-label="${h(D,e.currentSkinTone)}" title="${f(D)}" class="emoji ${d&&A===e.activeSearchItem?"active":""}" id="${`${F}-${D.id}`}">${D.unicode?b(D,e.currentSkinTone):m`<img class="custom-emoji" src="${D.url}" alt="" loading="lazy">`}</button>`,D=>`${F}-${D.id}`)}const R=m`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${y(e.skinTones,(l,d)=>m`<div id="skintone-${d}" class="emoji ${d===e.activeSkinTone?"active":""}" aria-selected="${d===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[d]}" aria-label="${e.i18n.skinTones[d]}">${l}</div>`,l=>l)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${y(e.groups,l=>m`<button role="tab" class="nav-button" aria-controls="tab-${l.id}" aria-label="${e.i18n.categories[l.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===l.id}" title="${e.i18n.categories[l.name]}" data-group-id="${l.id}"><div class="nav-emoji emoji">${l.emoji}</div></button>`,l=>l.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${y(e.currentEmojisWithCategories,(l,d)=>m`<div><div id="menu-label-${d}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:l.category?l.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${d}" id="${e.searchMode?"search-results":""}">${w(l.emojis,e.searchMode,"emo")}</div></div>`,l=>l.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${w(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(p){n.appendChild(R);const l=(d,F)=>{for(const D of n.querySelectorAll(`[${d}]`))F(D,D.getAttribute(d))};for(const d of["click","focusout","input","keydown","keyup"])l(`data-on-${d}`,(F,D)=>{F.addEventListener(d,a[D])});l("data-ref",(d,F)=>{t[F]=d}),l("data-action",(d,F)=>{o[F](d)}),i.addEventListener("abort",()=>{n.removeChild(R)})}}const Ot=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function es(n){let e=!1,r;const a=new Map,o=new Set;let t;const i=()=>{if(e)return;const f=[...o];o.clear();try{for(const b of f)b()}finally{t=!1,o.size&&(t=!0,Ot(i))}},p=new Proxy({},{get(f,b){if(r){let m=a.get(b);m||(m=new Set,a.set(b,m)),m.add(r)}return f[b]},set(f,b,m){f[b]=m;const y=a.get(b);if(y){for(const w of y)o.add(w);t||(t=!0,Ot(i))}return!0}}),h=f=>{const b=()=>{const m=r;r=b;try{return f()}finally{r=m}};return b()};return n.addEventListener("abort",()=>{e=!0}),{state:p,createEffect:h}}function yn(n,e,r){if(n.length!==e.length)return!1;for(let a=0;a<n.length;a++)if(!r(n[a],e[a]))return!1;return!0}const bn=[],{assign:It}=Object;function ts(n,e){const r={},a=new AbortController,o=a.signal,{state:t,createEffect:i}=es(o);It(t,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),It(t,e),It(t,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:wo,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:mn,databaseLoaded:!1,activeSearchItemId:void 0}),i(()=>{t.currentGroup!==t.groups[t.currentGroupIndex]&&(t.currentGroup=t.groups[t.currentGroupIndex])});const p=x=>{n.getElementById(x).focus()},h=x=>n.getElementById(`emo-${x.id}`),f=(x,U)=>{r.rootElement.dispatchEvent(new CustomEvent(x,{detail:U,bubbles:!0,composed:!0}))},b=(x,U)=>x.id===U.id,m=(x,U)=>{const{category:H,emojis:q}=x,{category:se,emojis:ne}=U;return H!==se?!1:yn(q,ne,b)},y=x=>{yn(t.currentEmojis,x,b)||(t.currentEmojis=x)},w=x=>{t.searchMode!==x&&(t.searchMode=x)},I=x=>{yn(t.currentEmojisWithCategories,x,m)||(t.currentEmojisWithCategories=x)},R=(x,U)=>U&&x.skins&&x.skins[U]||x.unicode,F={labelWithSkin:(x,U)=>Ro([x.name||R(x,U),x.annotation,...x.shortcodes||bn].filter(Boolean)).join(", "),titleForEmoji:x=>x.annotation||(x.shortcodes||bn).join(", "),unicodeWithSkin:R},D={onClickSkinToneButton:J,onEmojiClick:G,onNavClick:k,onNavKeydown:V,onSearchKeydown:M,onSkinToneOptionsClick:Q,onSkinToneOptionsFocusOut:ke,onSkinToneOptionsKeydown:te,onSkinToneOptionsKeyup:ye,onSearchInput:de},A={calculateEmojiGridStyle:B};let S=!0;i(()=>{Zo(n,t,F,D,A,r,o,S),S=!1}),t.emojiVersion||pn().then(x=>{x||(t.message=t.i18n.emojiUnsupportedMessage)}),i(()=>{async function x(){let U=!1;const H=setTimeout(()=>{U=!0,t.message=t.i18n.loadingMessage},Eo);try{await t.database.ready(),t.databaseLoaded=!0}catch(q){console.error(q),t.message=t.i18n.networkErrorMessage}finally{clearTimeout(H),U&&(U=!1,t.message="")}}t.database&&x()}),i(()=>{t.pickerStyle=`
      --num-groups: ${t.groups.length}; 
      --indicator-opacity: ${t.searchMode?0:1}; 
      --num-skintones: ${ir};`}),i(()=>{t.customEmoji&&t.database&&_()}),i(()=>{t.customEmoji&&t.customEmoji.length?t.groups!==xn&&(t.groups=xn):t.groups!==mn&&(t.currentGroupIndex&&t.currentGroupIndex--,t.groups=mn)}),i(()=>{async function x(){t.databaseLoaded&&(t.currentSkinTone=await t.database.getPreferredSkinTone())}x()}),i(()=>{t.skinTones=Array(ir).fill().map((x,U)=>_o(t.skinToneEmoji,U))}),i(()=>{t.skinToneButtonText=t.skinTones[t.currentSkinTone]}),i(()=>{t.skinToneButtonLabel=t.i18n.skinToneLabel.replace("{skinTone}",t.i18n.skinTones[t.currentSkinTone])}),i(()=>{async function x(){const{database:U}=t,H=(await Promise.all(To.map(q=>U.getEmojiByUnicodeOrName(q)))).filter(Boolean);t.defaultFavoriteEmojis=H}t.databaseLoaded&&x()});function _(){t.database.customEmoji=t.customEmoji||bn}i(()=>{async function x(){_();const{database:U,defaultFavoriteEmojis:H,numColumns:q}=t,se=await U.getTopFavoriteEmoji(q),ne=await he(_r([...se,...H],Te=>Te.unicode||Te.name).slice(0,q));t.currentFavorites=ne}t.databaseLoaded&&t.defaultFavoriteEmojis&&x()});function B(x){jo(x,o,U=>{{const H=getComputedStyle(r.rootElement),q=parseInt(H.getPropertyValue("--num-columns"),10),se=H.getPropertyValue("direction")==="rtl",Te=x.parentElement.getBoundingClientRect().width-U;t.numColumns=q,t.scrollbarWidth=Te,t.isRtl=se}})}i(()=>{async function x(){const{searchText:U,currentGroup:H,databaseLoaded:q,customEmoji:se}=t;if(!q)t.currentEmojis=[],t.searchMode=!1;else if(U.length>=yo){const ne=await Z(U);t.searchText===U&&(y(ne),w(!0))}else{const{id:ne}=H;if(ne!==-1||se&&se.length){const Te=await pe(ne);t.currentGroup.id===ne&&(y(Te),w(!1))}}}x()}),i(()=>{const{currentEmojis:x,emojiVersion:U}=t,H=x.filter(q=>q.unicode).filter(q=>cr(q)&&!kn.has(q.unicode));if(!U&&H.length)y(x),Mt(()=>Y(H));else{const q=U?x:x.filter(ce);y(q),Mt(()=>Fo(r.tabpanelElement))}});function Y(x){Bo(x,r.baselineEmoji,h),t.currentEmojis=t.currentEmojis}function ce(x){return!x.unicode||!cr(x)||kn.get(x.unicode)}async function ae(x){const U=t.emojiVersion||await pn();return x.filter(({version:H})=>!H||H<=U)}async function he(x){return Oo(x,t.emojiVersion||await pn())}async function pe(x){const U=x===-1?t.customEmoji:await t.database.getEmojiByGroup(x);return he(await ae(U))}async function Z(x){return he(await ae(await t.database.getEmojiBySearchQuery(x)))}i(()=>{}),i(()=>{function x(){const{searchMode:H,currentEmojis:q}=t;if(H)return[{category:"",emojis:q}];const se=new Map;for(const ne of q){const Te=ne.category||"";let Qe=se.get(Te);Qe||(Qe=[],se.set(Te,Qe)),Qe.push(ne)}return[...se.entries()].map(([ne,Te])=>({category:ne,emojis:Te})).sort((ne,Te)=>t.customCategorySorting(ne.category,Te.category))}const U=x();I(U)}),i(()=>{t.activeSearchItemId=t.activeSearchItem!==-1&&t.currentEmojis[t.activeSearchItem].id}),i(()=>{const{rawSearchText:x}=t;Ar(()=>{t.searchText=(x||"").trim(),t.activeSearchItem=-1})});function M(x){if(!t.searchMode||!t.currentEmojis.length)return;const U=H=>{_e(x),t.activeSearchItem=vn(H,t.activeSearchItem,t.currentEmojis)};switch(x.key){case"ArrowDown":return U(!1);case"ArrowUp":return U(!0);case"Enter":if(t.activeSearchItem===-1)t.activeSearchItem=0;else return _e(x),W(t.currentEmojis[t.activeSearchItem].id)}}function k(x){const{target:U}=x,H=U.closest(".nav-button");if(!H)return;const q=parseInt(H.dataset.groupId,10);r.searchElement.value="",t.rawSearchText="",t.searchText="",t.activeSearchItem=-1,t.currentGroupIndex=t.groups.findIndex(se=>se.id===q)}function V(x){const{target:U,key:H}=x,q=se=>{se&&(_e(x),se.focus())};switch(H){case"ArrowLeft":return q(U.previousElementSibling);case"ArrowRight":return q(U.nextElementSibling);case"Home":return q(U.parentElement.firstElementChild);case"End":return q(U.parentElement.lastElementChild)}}async function W(x){const U=await t.database.getEmojiByUnicodeOrName(x),H=[...t.currentEmojis,...t.currentFavorites].find(se=>se.id===x),q=H.unicode&&R(H,t.currentSkinTone);await t.database.incrementFavoriteEmojiCount(x),f("emoji-click",{emoji:U,skinTone:t.currentSkinTone,...q&&{unicode:q},...H.name&&{name:H.name}})}async function G(x){const{target:U}=x;if(!U.classList.contains("emoji"))return;_e(x);const H=U.id.substring(4);W(H)}function O(x){t.currentSkinTone=x,t.skinTonePickerExpanded=!1,p("skintone-button"),f("skin-tone-change",{skinTone:x}),t.database.setPreferredSkinTone(x)}function Q(x){const{target:{id:U}}=x,H=U&&U.match(/^skintone-(\d)/);if(!H)return;_e(x);const q=parseInt(H[1],10);O(q)}function J(x){t.skinTonePickerExpanded=!t.skinTonePickerExpanded,t.activeSkinTone=t.currentSkinTone,t.skinTonePickerExpanded&&(_e(x),Mt(()=>p("skintone-list")))}i(()=>{t.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{t.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):t.skinTonePickerExpandedAfterAnimation=!1});function te(x){if(!t.skinTonePickerExpanded)return;const U=async H=>{_e(x),t.activeSkinTone=H};switch(x.key){case"ArrowUp":return U(vn(!0,t.activeSkinTone,t.skinTones));case"ArrowDown":return U(vn(!1,t.activeSkinTone,t.skinTones));case"Home":return U(0);case"End":return U(t.skinTones.length-1);case"Enter":return _e(x),O(t.activeSkinTone);case"Escape":return _e(x),t.skinTonePickerExpanded=!1,p("skintone-button")}}function ye(x){if(t.skinTonePickerExpanded)switch(x.key){case" ":return _e(x),O(t.activeSkinTone)}}async function ke(x){const{relatedTarget:U}=x;(!U||U.id!=="skintone-list")&&(t.skinTonePickerExpanded=!1)}function de(x){t.rawSearchText=x.target.value}return{$set(x){It(t,x)},$destroy(){a.abort()}}}const ns="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",rs="en";var as={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},os=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const Or=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],ss=`:host{--emoji-font-family:${Lr}}`;class Bn extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=os+ss,this.shadowRoot.appendChild(r),this._ctx={locale:rs,dataSource:ns,skinToneEmoji:So,customCategorySorting:xo,customEmoji:null,i18n:as,emojiVersion:null,...e};for(const a of Or)a!=="database"&&Object.prototype.hasOwnProperty.call(this,a)&&(this._ctx[a]=this[a],delete this[a]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=ts(this.shadowRoot,this._ctx))}disconnectedCallback(){Ot(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,a){this._set(e.replace(/-([a-z])/g,(o,t)=>t.toUpperCase()),e==="emoji-version"?parseFloat(a):a)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:a}=this._ctx;(!a||a.locale!==e||a.dataSource!==r)&&this._set("database",new go({locale:e,dataSource:r}))}_dbFlush(){Ot(()=>this._dbCreate())}}const Pr={};for(const n of Or)Pr[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(Bn.prototype,Pr);customElements.get("emoji-picker")||customElements.define("emoji-picker",Bn);var Nn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(r,a){a(e)})(ft,function(r){var a="dnd-poly-",o=a+"snapback",t="dnd-poly-",i=t+"dragstart-pending",p=t+"dragstart-cancel",h=["none","copy","copyLink","copyMove","link","linkMove","move","all"],f=["none","copy","move","link"],b=function(){var M=!1;try{var k=Object.defineProperty({},"passive",{get:function(){M=!0}});window.addEventListener("test",null,k)}catch{}return M}();function m(M){return M&&M.tagName}function y(M,k,V){V===void 0&&(V=!0),document.addEventListener(M,k,!!b&&{passive:V})}function w(M,k){document.removeEventListener(M,k)}function I(M,k,V,W){W===void 0&&(W=!1);var G=b?{passive:!0,capture:W}:W;return M.addEventListener(k,V,G),{off:function(){M.removeEventListener(k,V,G)}}}function R(M){return M.length===0?0:M.reduce(function(k,V){return V+k},0)/M.length}function l(M,k){for(var V=0;V<M.changedTouches.length;V++)if(M.changedTouches[V].identifier===k)return!0;return!1}function d(M,k,V){for(var W=[],G=[],O=0;O<k.touches.length;O++){var Q=k.touches[O];W.push(Q[M+"X"]),G.push(Q[M+"Y"])}V.x=R(W),V.y=R(G)}var F=["","-webkit-"];function D(M,k,V,W,G){G===void 0&&(G=!0);var O=k.x,Q=k.y;W&&(O+=W.x,Q+=W.y),G&&(O-=parseInt(M.offsetWidth,10)/2,Q-=parseInt(M.offsetHeight,10)/2);for(var J="translate3d("+O+"px,"+Q+"px, 0)",te=0;te<F.length;te++){var ye=F[te]+"transform";M.style[ye]=J+" "+V[te]}}var A=function(){function M(k,V){this.t=k,this.i=V,this.s=f[0]}return Object.defineProperty(M.prototype,"dropEffect",{get:function(){return this.s},set:function(k){this.t.mode!==0&&h.indexOf(k)>-1&&(this.s=k)},enumerable:!0,configurable:!0}),Object.defineProperty(M.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(M.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(k){this.t.mode===2&&h.indexOf(k)>-1&&(this.t.effectAllowed=k)},enumerable:!0,configurable:!0}),M.prototype.setData=function(k,V){if(this.t.mode===2){if(k.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[k]=V,this.t.types.indexOf(k)===-1&&this.t.types.push(k)}},M.prototype.getData=function(k){if(this.t.mode===1||this.t.mode===2)return this.t.data[k]||""},M.prototype.clearData=function(k){if(this.t.mode===2){if(k&&this.t.data[k]){delete this.t.data[k];var V=this.t.types.indexOf(k);return void(V>-1&&this.t.types.splice(V,1))}this.t.data={},this.t.types=[]}},M.prototype.setDragImage=function(k,V,W){this.t.mode===2&&this.i(k,V,W)},M}();function S(M,k){return M?M===h[0]?f[0]:M.indexOf(h[1])===0||M===h[7]?f[1]:M.indexOf(h[4])===0?f[3]:M===h[6]?f[2]:f[1]:k.nodeType===3&&k.tagName==="A"?f[3]:f[1]}function _(M,k,V,W,G,O,Q){O===void 0&&(O=!0),Q===void 0&&(Q=null);var J=function(ye,ke,de,x,U,H,q){q===void 0&&(q=null);var se=ke.changedTouches[0],ne=new Event(de,{bubbles:!0,cancelable:x});ne.dataTransfer=H,ne.relatedTarget=q,ne.screenX=se.screenX,ne.screenY=se.screenY,ne.clientX=se.clientX,ne.clientY=se.clientY,ne.pageX=se.pageX,ne.pageY=se.pageY;var Te=ye.getBoundingClientRect();return ne.offsetX=ne.clientX-Te.left,ne.offsetY=ne.clientY-Te.top,ne}(k,V,M,O,document.defaultView,G,Q),te=!k.dispatchEvent(J);return W.mode=0,te}function B(M,k){if(!M||M===h[7])return k;if(k===f[1]){if(M.indexOf(f[1])===0)return f[1]}else if(k===f[3]){if(M.indexOf(f[3])===0||M.indexOf("Link")>-1)return f[3]}else if(k===f[2]&&(M.indexOf(f[2])===0||M.indexOf("Move")>-1))return f[2];return f[0]}var Y,ce=function(){function M(k,V,W,G){this.h=k,this.o=V,this.u=W,this.l=G,this.v=0,this.p=null,this.g=null,this.m=k,this.I=k.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),y("touchmove",this.j,!1),y("touchend",this.S,!1),y("touchcancel",this.S,!1)}return M.prototype.A=function(){var k=this;this.v=1,this.O=f[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var V=this.u;if(this.N=new A(this.D,function(J,te,ye){V=J,typeof te!="number"&&typeof ye!="number"||(k.P={x:te||0,y:ye||0})}),this.D.mode=2,this.N.dropEffect=f[0],_("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;d("page",this.m,this.F);var W,G=this.o.dragImageSetup(V);if(this.L=(W=G,F.map(function(J){var te=W.style[J+"transform"];return te&&te!=="none"?te.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),G.style.position="absolute",G.style.left="0px",G.style.top="0px",G.style.zIndex="999999",G.classList.add("dnd-poly-drag-image"),G.classList.add("dnd-poly-icon"),this._=G,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var O=getComputedStyle(V);this.P={x:0-parseInt(O.marginLeft,10),y:0-parseInt(O.marginTop,10)}}else{var Q=V.getBoundingClientRect();O=getComputedStyle(V),this.P={x:Q.left-this.I.clientX-parseInt(O.marginLeft,10)+Q.width/2,y:Q.top-this.I.clientY-parseInt(O.marginTop,10)+Q.height/2}}return D(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){k.X||(k.X=!0,k.Y(),k.X=!1)},this.o.iterationInterval),!0},M.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),w("touchmove",this.j),w("touchend",this.S),w("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},M.prototype.C=function(k){var V=this;if(l(k,this.I.identifier)!==!1){if(this.m=k,this.v===0){var W=void 0;if(this.o.dragStartConditionOverride)try{W=this.o.dragStartConditionOverride(k)}catch{W=!1}else W=k.touches.length===1;return W?void(this.A()===!0&&(this.h.preventDefault(),k.preventDefault())):void this.T()}if(k.preventDefault(),d("client",k,this.M),d("page",k,this.F),this.o.dragImageTranslateOverride)try{var G=!1;if(this.o.dragImageTranslateOverride(k,{x:this.M.x,y:this.M.y},this.p,function(O,Q){V._&&(G=!0,V.M.x+=O,V.M.y+=Q,V.F.x+=O,V.F.y+=Q,D(V._,V.F,V.L,V.P,V.o.dragImageCenterOnTouch))}),G)return}catch{}D(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},M.prototype.k=function(k){if(l(k,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(k.preventDefault(),this.v=k.type==="touchcancel"?3:2):this.T()}},M.prototype.Y=function(){var k=this,V=this.O;this.D.mode=3,this.N.dropEffect=f[0];var W=_("drag",this.u,this.m,this.D,this.N);if(W&&(this.O=f[0]),W||this.v===2||this.v===3)return this.q(this.v)?void function(J,te,ye,ke){var de=getComputedStyle(J);if(de.visibility!=="hidden"&&de.display!=="none"){te.classList.add(o);var x=getComputedStyle(te),U=parseFloat(x.transitionDuration);if(isNaN(U)||U===0)ke();else{var H=J.getBoundingClientRect(),q={x:H.left,y:H.top};q.x+=document.body.scrollLeft||document.documentElement.scrollLeft,q.y+=document.body.scrollTop||document.documentElement.scrollTop,q.x-=parseInt(de.marginLeft,10),q.y-=parseInt(de.marginTop,10);var se=parseFloat(x.transitionDelay),ne=Math.round(1e3*(U+se));D(te,q,ye,void 0,!1),setTimeout(ke,ne)}}else ke()}(this.u,this._,this.L,function(){k.B()}):void this.B();var G=this.o.elementFromPoint(this.M.x,this.M.y),O=this.g;G!==this.p&&G!==this.g&&(this.p=G,this.g!==null&&(this.D.mode=3,this.N.dropEffect=f[0],_("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=S(this.D.effectAllowed,this.u),_("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=B(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),O!==this.g&&m(O)&&(this.D.mode=3,this.N.dropEffect=f[0],_("dragleave",O,this.m,this.D,this.N,!1,this.g)),m(this.g)&&(this.D.mode=3,this.N.dropEffect=S(this.D.effectAllowed,this.u),_("dragover",this.g,this.m,this.D,this.N)===!1?this.O=f[0]:this.O=B(this.N.effectAllowed,this.N.dropEffect)),V!==this.O&&this._.classList.remove(a+V);var Q=a+this.O;this._.classList.add(Q)},M.prototype.q=function(k){var V=this.O===f[0]||this.g===null||k===3;return V?m(this.g)&&(this.D.mode=3,this.N.dropEffect=f[0],_("dragleave",this.g,this.m,this.D,this.N,!1)):m(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,_("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=f[0]),V},M.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,_("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},M}(),ae={iterationInterval:150,tryFindDraggableTarget:function(M){var k=M.target;do if(k.draggable!==!1&&(k.draggable===!0||k.getAttribute&&k.getAttribute("draggable")==="true"))return k;while((k=k.parentNode)&&k!==document.body)},dragImageSetup:function(M){var k=M.cloneNode(!0);return function V(W,G){if(W.nodeType===1){for(var O=getComputedStyle(W),Q=0;Q<O.length;Q++){var J=O[Q];G.style.setProperty(J,O.getPropertyValue(J),O.getPropertyPriority(J))}if(G.style.pointerEvents="none",G.removeAttribute("id"),G.removeAttribute("class"),G.removeAttribute("draggable"),G.nodeName==="CANVAS"){var te=W,ye=G,ke=te.getContext("2d").getImageData(0,0,te.width,te.height);ye.getContext("2d").putImageData(ke,0,0)}}if(W.hasChildNodes())for(Q=0;Q<W.childNodes.length;Q++)V(W.childNodes[Q],G.childNodes[Q])}(M,k),k},elementFromPoint:function(M,k){return document.elementFromPoint(M,k)}};function he(M){if(!Y){var k=ae.tryFindDraggableTarget(M);if(k)try{Y=new ce(M,ae,k,Z)}catch(V){throw Z(ae,M,3),V}}}function pe(M){var k=M.target,V=function(te){G.off(),O.off(),Q.off(),J.off(),k&&k.dispatchEvent(new CustomEvent(p,{bubbles:!0,cancelable:!0})),clearTimeout(W)};k&&k.dispatchEvent(new CustomEvent(i,{bubbles:!0,cancelable:!0}));var W=window.setTimeout(function(){G.off(),O.off(),Q.off(),J.off(),he(M)},ae.holdToDrag),G=I(k,"touchend",V),O=I(k,"touchcancel",V),Q=I(k,"touchmove",V),J=I(window,"scroll",V,!0)}function Z(M,k,V){if(V===0&&M.defaultActionOverride)try{M.defaultActionOverride(k),k.defaultPrevented}catch{}Y=null}r.polyfill=function(M){if(M&&Object.keys(M).forEach(function(G){ae[G]=M[G]}),!ae.forceApply){var k=(V={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},W=!!window.chrome||/chrome/i.test(navigator.userAgent),V.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||W&&"ontouchstart"in document.documentElement),V);if(k.userAgentSupportingNativeDnD&&k.draggable&&k.dragEvents)return!1}var V,W;return ae.holdToDrag?y("touchstart",pe,!1):y("touchstart",he,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(Nn,Nn.exports);var is=Nn.exports;const cs=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),ls=n=>n.replace(/\n/g,"<br>"),De=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},us=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let fr;const ds=(n=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),a=()=>{clearTimeout(r),clearTimeout(fr),fr=setTimeout(()=>{n.removeEventListener("scroll",a),e()},100)};n.addEventListener("scroll",a)}),Pt=n=>{try{return JSON.parse(n),!0}catch{return!1}},fs="0.6.5 Beta",Qt=document.querySelector(".wrap"),Ye=document.querySelector(".editor"),me=document.getElementById("tones"),we=document.getElementById("action"),oe=document.getElementById("musical-score"),Fe=document.getElementById("add-track"),it=document.getElementById("remove-track"),Ge=document.getElementById("dialog"),Ee=document.forms["dialog-form"];Ee._title=Ee.querySelector(".form-title");Ee.description=Ee.querySelector(".description");Ee.inputs=Ee.querySelector(".inputs");Ee.buttons=Ee.querySelector(".buttons");const jt=document.getElementById("play"),Bt=document.getElementById("clear"),ms=document.getElementById("warn-out"),hs=document.getElementById("mml"),Le=document.getElementById("copy"),We=document.getElementById("paste"),qe=document.getElementById("save"),In=document.getElementById("open"),Zt=document.getElementById("ctrl"),Rt=document.getElementById("undo"),Ft=document.getElementById("redo");var vt,fe,Me,nt;class ps{constructor(){ue(this,vt,`#COMMENT Generated by FlMML VisualSequencer v${fs}`);ue(this,fe,[]);ue(this,Me,(e,r)=>{});ue(this,nt,(e,r)=>{})}set onChange(e){Ne(this,Me,e)}set onError(e){Ne(this,nt,e)}setMmlArr(e){Ne(this,fe,e),C(this,Me).call(this,this.getMmlArr(),this.getMml())}setMml(e){Ne(this,fe,e.split(`
`)),C(this,fe).at(-2)===""&&C(this,fe).at(-1)===C(this,vt)&&C(this,fe).splice(-2,2),C(this,Me).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return C(this,fe)}getMml(){return C(this,fe).length?C(this,fe).concat(["",C(this,vt)]).join(`
`):""}getMmlLine(e){return C(this,fe)[e]}insert(e,r){Object.hasOwn(C(this,fe),e)||e===0?(C(this,fe).splice(e,0,r),C(this,Me).call(this,this.getMmlArr(),this.getMml())):C(this,nt).call(this,"範囲外の書き換え指定",`範囲${C(this,fe).length-1}までのところ、${e}`)}append(e){C(this,fe).push(e),C(this,Me).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(C(this,fe),e)?(C(this,fe)[e]+=r,C(this,Me).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(C(this,fe),e)?(C(this,fe)[e]=r+C(this,fe)[e],C(this,Me).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(C(this,fe),e)?(C(this,fe)[e]=r,C(this,Me).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(C(this,fe),e)&&C(this,fe).splice(e,r).length!==0?C(this,Me).call(this,this.getMmlArr(),this.getMml()):C(this,nt).call(this,"無効な指定",`範囲${C(this,fe).length-1}までの中で${e}から${r}削除するのはできません`)}}vt=new WeakMap,fe=new WeakMap,Me=new WeakMap,nt=new WeakMap;var re,rt,at,gt,ze,yt,Cn;class vs{constructor(e,r){ue(this,yt);ue(this,re,[]);ue(this,rt,new Set);ue(this,at,[]);ue(this,gt,null);ue(this,ze,null);this.tonesElem=e,this.areaElem=r,Ne(this,ze,this.areaElem.querySelector(".track.active"))}set activeTrack(e){C(this,ze).classList.remove("active"),Ne(this,ze,e),C(this,ze).classList.add("active")}get activeTrack(){return C(this,ze)}blocksDataUpdate(){Ne(this,re,[...this.areaElem.querySelectorAll(".track button")].map(this.extractBlockData))}extractBlockData(e){return{label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),...e.dataset,elem:e}}saveBlocksData(){clearTimeout(C(this,gt)),Ne(this,gt,setTimeout(()=>{const e=JSON.parse(JSON.stringify(C(this,re)));En.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){En.getItem("BlocksData").then(e=>{e&&(Ne(this,re,e.map(r=>{const a=r.tone;return(a==null?void 0:a.tone)!==void 0&&(a==null?void 0:a.tonePitch)!==void 0&&(r.tone=a.tone,r.tonePitch=a.tonePitch),r})),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(X),this.calcPlayFromHere())})}parseBlocks(){const e=C(this,re);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let a=0;e.forEach(o=>{if(o.trackNo!==a){const b=document.createElement("ul");b.classList.add("track"),this.activeTrack=b,this.areaElem.insertBefore(b,Fe),a=o.trackNo}const t=document.createElement("li"),i='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',p=(()=>{const b=document.createElement("div");return b.innerHTML=i,b.firstElementChild})(),h=document.querySelector(`[class*="${o.className.replace(/ material-icons| droppable| bounce| pop| done| inactive/g,"")}"]`),f=(h==null?void 0:h.cloneNode(!0))||p;o.label&&(f.ariaLabel=o.label),f.className=o.className,o.tonePitch&&(o.label!=="無調整"&&(f.textContent=o.label),f.dataset.tone=o.tone,h?h.replaceWith(f.cloneNode(!0)):r.appendChild(f.cloneNode(!0)),f.dataset.tonePitch=o.tonePitch),o.tempo&&(f.dataset.tempo=o.tempo),o.noteValue&&(f.dataset.noteValue=o.noteValue),o.rest&&(f.dataset.rest=o.rest),o.octave&&(f.dataset.octave=o.octave),o.velocity&&(f.dataset.velocity=o.velocity),o.noteShift&&(f.dataset.noteShift=o.noteShift),o.detune&&(f.dataset.detune=o.detune),o.tieSlur&&(f.dataset.tieSlur=o.tieSlur,o.tieSlur==="&"?f.ariaLabel="スラー":f.ariaLabel="タイ"),o.repeatStartEnd&&(f.dataset.repeatStartEnd=o.repeatStartEnd,o.repeatStartEnd.startsWith("/:")?(f.classList.remove("material-icons"),f.ariaLabel="リピート開始",f.textContent="◆"):o.repeatStartEnd===":/"&&(f.ariaLabel="リピート終了")),o.repeatBreak&&(f.dataset.repeatBreak=o.repeatBreak),o.polyStartEnd&&(f.dataset.polyStartEnd=o.polyStartEnd),o.macroDef&&(f.dataset.macroDef=o.macroDef,o.macroDef===";"?f.textContent=";":f.textContent="$="),o.macroArgUse&&(f.dataset.macroArgUse=o.macroArgUse),o.macroUse&&(f.dataset.macroUse=o.macroUse),o.metaData&&(f.dataset.metaData=o.metaData),o.otherAction&&(f.dataset.otherAction=o.otherAction,f.textContent=o.otherAction.length>4?"…":o.otherAction),t.appendChild(f),this.activeTrack.appendChild(t)})}exportMml(e){e.setMmlArr([]);let r=0,a=0;const o=C(this,re).filter(l=>l.tone!==void 0),t=()=>o.filter(l=>l.trackNo===a),i=()=>new Set(t().map(l=>l.tone));let p=i(),h=0,f=!1,b={noteValue:4,dots:0},m=!1,y=!1;const w=C(this,re).findIndex(l=>l.elem.classList.contains("play-from-here")),I=w!==-1,R=I?C(this,re)[w].trackNo:-1;C(this,re).forEach((l,d)=>{const{tone:F,tonePitch:D}=l;l.trackNo!==a&&(p.size?([...p].forEach((S,_)=>{e.appendToStr(r+_,";")}),r+=p.size):(e.appendToStr(r,";"),r++),a=l.trackNo,p=i(),f=!1,y=!1);const A=!I||y||I&&l.trackNo===R&&d>=w;if(F!==void 0)h=[...p].indexOf(F),f||([...p].forEach((S,_)=>{S&&e.beforeInsertToStr(r+_,S+" ")}),f=!0),[...p].forEach((S,_)=>{let B=D||"";_!==h&&(B=B.replace(/[a-g]/,m?"*":"r")),A||(B=B.replace(/[a-gr*]\+?[0-9]*\.*/i,"")),e.appendToStr(r+_,B)});else if(l.rest||l.tieSlur){let S=l.rest||l.tieSlur;A||(S=S.replace(/[r&]\+?[0-9]*\.*/i,"")),p.size?[...p].forEach((_,B)=>{e.appendToStr(r+B,S)}):e.appendToStr(r,S)}else if(l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd){const S=_=>{if(!_)return b;const B=Number((_.match(/[0-9]+/)||[b.noteValue])[0]),Y=(_.match(/\.+/)||[""])[0].length;return{noteValue:B,dots:Y}};l.noteValue?b=S(l.noteValue):l.polyStartEnd==="["?m=!0:l.polyStartEnd==="]"&&(m=!1),p.size?[...p].forEach((_,B)=>{if(e.appendToStr(r+B,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||""),l.polyStartEnd==="]"){const Y=e.getMmlLine(r+B).match(/\[(.+?)\]/);if(Y){const ce=Y[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(ce){const ae=[...ce].map(Z=>({type:Z[1]==="r"?"rest":Z[1]==="*"?"otherNote":"note",num:S(Z[0])}));ae.filter(M=>M.type==="note").map(M=>M.num),ae.filter(M=>M.type==="otherNote").map(M=>M.num),ae.filter(M=>M.type==="rest").map(M=>M.num);let he=Y[0].replace(/\*\+?[0-9]*\.*/g,"");const pe=e.getMmlLine(r+B).replace(/\[.+?\]/,he);e.rewrite(r+B,pe)}}}}):e.appendToStr(r,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||"")}else if(l.metaData)l.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,l.metaData.replace(`
`,"")||""),r++;else if(l.macroDef)y=l.macroDef!==";",e.appendToStr(r,l.macroDef||"");else{let S;A?S=D||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.macroArgUse||l.macroUse||l.otherAction||"":S=(D==null?void 0:D.replace(/[a-g]\+?[0-9]*\.*/i,""))||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.otherAction||"",e.appendToStr(r,S),/;/.test(S)&&(r+=p.size||1,p=i(),f=!1)}}),[...p].slice(0,-1).forEach((l,d)=>{e.appendToStr(r+d,";")})}importMml(e){const r=e.getMmlArr(),a=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_.]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig;C(this,rt).clear();const o=new Set;let t=0,i="",p=!1,h=!1;const f=m=>(m.match(a)||[]).reduce((w,I)=>(I=I.trim(),I&&(l=>{const d={};if(d.tone={},d.trackNo=t,l.startsWith("#")){const F={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};d.label=(Object.entries(F).find(D=>l.startsWith(D[0]))||[,void 0])[1],d.className="meta-data",d.metaData=l+`
`}else if(/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(l)){i=l,o.add(i);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(l)){o.has(i)||o.add(i);const F=[...o].indexOf(i)+1;d.label="無調整",d.className=`material-icons note note-${F}`,d.tone=i,d.tonePitch=l,p&&(h=!0)}else if(l.startsWith("t"))d.className="material-icons tempo",d.tempo=l;else if(l.startsWith("l"))d.className="material-icons note-value",d.noteValue=l;else if(l.startsWith("r"))d.className="material-icons rest",d.rest=l;else if(/^o[0-8]|[><]+$/i.test(l))d.className="material-icons octave",d.octave=l;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(l))d.className="material-icons velocity",d.velocity=l;else if(l.startsWith("@ns")||l.startsWith("ns"))d.className="material-icons note-shift",d.noteShift=l;else if(l.startsWith("@d"))d.className="material-icons detune",d.detune=l;else if(l.startsWith("&"))d.className="tie-slur",d.tieSlur=l;else if(l.startsWith("/*"))d.className="other-action",d.otherAction=l;else if(l.startsWith("/:"))d.className="repeat-start-end",d.repeatStartEnd=l;else if(l.startsWith(":/"))d.className="material-icons repeat-start-end",d.repeatStartEnd=l;else if(l.startsWith("/"))d.className="repeat-break",d.repeatBreak=l;else if(l.startsWith("[")||l.startsWith("]"))d.className="poly-start-end",d.polyStartEnd=l;else if(/^\$.*?=$/.test(l))d.className="macro-def",d.macroDef=l.replaceAll(" ",""),C(this,rt).add(d.macroDef.replace("=","")),p=!0;else if(l.startsWith("%"))d.className="macro-arg-use",d.macroArgUse=l;else if(l.startsWith("$")){d.className="macro-use";const F=l.replace(/\{.*/,""),D=[...C(this,rt)].sort((A,S)=>S.length-A.length).find(A=>F.includes(A));if(D){const A=(l.match(/\{[^\}]*\}/)||[""])[0];d.macroUse=`${D}${A}`,w.push(d);const S=l.replace(D,"");S!==""&&(w=w.concat(f(S)));return}else d.macroUse=l}else if(l.startsWith(";")){if(t++,p&&!h){const F=[...o].join(" ");F&&(d.className="other-action",d.otherAction=F,w.push(d),o.clear())}i="",p=!1,h=!1;return}else d.className="other-action",d.otherAction=l;w.push(d)})(I),w),[]);this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((m,y)=>{y?m.remove():(m.textContent="",this.activeTrack=m)}),K=null;const b=r.map(f).flat();Ne(this,re,b),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}get blocksData(){return C(this,re)}set blocksData(e){this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((r,a)=>{a?r.remove():(r.textContent="",this.activeTrack=r)}),K=null,Ne(this,re,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData(),this.exportMml(X),this.calcPlayFromHere()}playRendering(e=-1){const r=C(this,re);if(!r.length)return;const a=e!==-1,o=r[e],t=a?o.trackNo:-1;let i=120,p=0;[me,we,oe].forEach(w=>{w.classList.add("no-op")});const h=document.getElementsByClassName("track"),b=(Qt.clientHeight-32)/h.length;[...h].forEach(w=>{w.style.setProperty("--max-height",`${b}px`)}),Fe.disabled=!0,it.disabled=!0;const m=(w,{scoreNoteValue:I=4,ignorePlayFromHere:R=!1}={})=>{var G;let l=!1,d=-1,F=!1,D=!1;const A=[],S=performance.now(),_=(G=w[0])==null?void 0:G.trackNo,B=h[_],Y=p++,ce=w.findIndex(O=>O===o);let ae=null;const he=new Promise(O=>ae=O);let pe=0,Z=0;const M=O=>dn(this,yt,Cn).call(this,{str:O,scoreNoteValue:I}),k=O=>{const Q=te=>{!D&&B.scrollTo({top:te,behavior:"smooth"}),D=!0,ds(B).then(()=>{D=!1})},J=te=>B.clientHeight*te;(Z===0||O.elem.offsetTop>B.scrollTop+J(.8)||O.elem.offsetTop<B.scrollTop+J(.2))&&Q(O.elem.offsetTop-J(.2))},V=O=>{const Q=J=>{const te=J-S,ye=60/i*4/O*1e3;te<pe+ye?C(this,at)[Y]=requestAnimationFrame(Q):(pe+=ye,W())};C(this,at)[Y]=requestAnimationFrame(Q)},W=async()=>{var te,ye,ke;const O=w[Z];if(!O||Z>=w.length){ae({scoreNoteValue:I});return}k(O);const Q=de=>{let x=0;return w.findIndex((U,H)=>{var q;if(H>de+1){if((q=U.repeatStartEnd)!=null&&q.startsWith("/:"))x++;else if(U.repeatStartEnd===":/"){if(x===0)return!0;x--}}return!1})},J=!a||R||a&&O.trackNo===t&&Z>=ce;if(F){O.macroDef===";"&&(F=!1),Z++,W();return}else if(O.tonePitch)if(J&&De(O.elem,"bounce"),Z++,l||!J)W();else{const de=M(O.tonePitch);V(de)}else if(O.rest||O.tieSlur)if(J&&De(O.elem,"pop"),Z++,O.tieSlur==="&"||!J)W();else{const de=M(O.rest||O.tieSlur);V(de)}else if(O.polyStartEnd)if(l=O.polyStartEnd==="[",J&&De(O.elem,"pop"),l||!J)Z++,W();else{const de=M(w[Z++-1].tonePitch);V(de)}else if(O.macroDef&&O.macroDef!==";"){F=!0,Z++,W();return}else{if(O.tempo&&(i=Number(O.tempo.replace("t",""))||i),O.noteValue&&(I=M(O.noteValue)),(te=O.repeatStartEnd)!=null&&te.startsWith("/:")){A[ye=++d]??(A[ye]={start:Z});let de=O.repeatStartEnd.replace("/:","");if(de=de===""?2:Number(de),de)if(A[d].end){if(!A[d].remaining){O.elem.dataset.repeatStartEnd=`/:${A[d].remaining}`,Z=A[d].end,W();return}w.slice(A[d].start+1,A[d].end-1).filter(x=>{var U;return(U=x.repeatStartEnd)==null?void 0:U.startsWith("/:")}).forEach(x=>{x.elem.dataset.repeatStartEnd=x.repeatStartEnd})}else A[d].remaining=de;else{Z=Q(Z),W(),J&&(De(O.elem,"pop"),De(O.elem,"done"));return}O.elem.dataset.repeatStartEnd=`/:${A[d].remaining}`}else if(O.repeatBreak){if(A[d].remaining===1){A[d].end||(A[d].end=Q(A[d].start)),Z=A[d].end,W(),J&&(De(O.elem,"pop"),De(O.elem,"done"));return}}else if(O.repeatStartEnd===":/"){if((ke=A[d]).end??(ke.end=Z),A[d].remaining){A[d].remaining--,Z=A[d].start,d--,W(),J&&(De(O.elem,"pop"),De(O.elem,"done"));return}A.pop(),d--}else if(O.macroUse&&J){const de=U=>{const H=r[U].trackNo;let q=U+1;for(;r[q].macroDef!==";"&&r[q].trackNo===H;)q++;return q},x={};if(x.start=r.findIndex(U=>{var H;return(H=U.macroDef)==null?void 0:H.startsWith(O.macroUse)}),x.start>-1){x.end=de(x.start),x.blocks=r.slice(x.start+1,x.end);const U=performance.now();I=(await m(x.blocks,{scoreNoteValue:I,ignorePlayFromHere:!0})).scoreNoteValue;const H=performance.now();pe+=H-U}}Z++,W(),J&&De(O.elem,"pop")}J&&De(O.elem,"done")};return W(),he},y=r.at(-1).trackNo+1;for(let w=0;w<y;w++){const I=r.filter(R=>R.trackNo===w);m(I)}}stopRendering(){[me,we,oe].forEach(e=>{e.classList.remove("no-op")}),Fe.disabled=!1,it.disabled=!1,C(this,re).forEach(e=>{e.elem.classList.remove("done")}),C(this,re).filter(e=>{var r;return(r=e.repeatStartEnd)==null?void 0:r.startsWith("/:")}).forEach(e=>{e.elem.dataset.repeatStartEnd=e.repeatStartEnd}),C(this,at).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!C(this,re).length)return;const e=C(this,re).at(-1).trackNo+1;for(let r=0;r<e;r++)C(this,re).filter(o=>o.polyStartEnd&&o.trackNo===r).forEach((o,t)=>{t%2===0?(o.elem.dataset.polyStartEnd="[",o.elem.textContent="["):(o.elem.dataset.polyStartEnd="]",o.elem.textContent="]")});this.blocksDataUpdate()}calcPlayFromHere(){if(!C(this,re).length)return;C(this,re).filter(o=>o.elem.classList.contains("inactive")).forEach(o=>{o.elem.classList.remove("inactive")});const e=C(this,re).find(o=>o.elem.classList.contains("play-from-here"));if(!e){Pe&&(Ie.additionalStartMSec=0),Le.disabled=qe.disabled=!1;return}const r=C(this,re).indexOf(e);if(C(this,re).filter((o,t)=>o.trackNo!==e.trackNo||t<r).forEach(o=>{o.elem.classList.add("inactive")}),Pe){const o=C(this,re).filter((t,i)=>t.trackNo===e.trackNo&&i<r);Ie.additionalStartMSec=(t=>{var i;if(t.length){let p=Number((i=C(this,re).find(I=>I.tempo))==null?void 0:i.tempo.replace("t",""))||120,h=4,f=!1,b=!1;const m=I=>dn(this,yt,Cn).call(this,{str:I,scoreNoteValue:h}),y=(I,R)=>I.reduce((l,d,F)=>{var A;const D=S=>{let _=0;return I.findIndex((B,Y)=>{var ce;if(Y>S+1){if((ce=B.repeatStartEnd)!=null&&ce.startsWith("/:"))_++;else if(B.repeatStartEnd===":/"){if(_===0)return!0;_--}}return!1})};if(b)d.macroDef===";"&&(b=!1);else if(d.tonePitch||d.rest||d.tieSlur){if(f||d.tieSlur==="&")return l;const S=m(d.tonePitch||d.rest||d.tieSlur);return l+60/p*4/S*1e3}else if(d.polyStartEnd){if(f=d.polyStartEnd==="[",f)return l;const S=m(I[F-1].tonePitch);return l+60/p*4/S*1e3}else if(d.macroDef&&d.macroDef!==";")b=!0;else if(d.tempo)p=Number(d.tempo.replace("t",""))||p;else if(d.noteValue)h=m(d.noteValue);else if((A=d.repeatStartEnd)!=null&&A.startsWith("/:")){let S=d.repeatStartEnd.replace("/:","");S=S===""?2:Number(S);let _=D(F);return _===-1&&(_=I.length+1),S?l+y(I.slice(F+1,_-1),!0)*(S-1):l-y(I.slice(F+1,_-1))}else if(d.repeatBreak&&!R){let S=D(F);return S===-1&&(S=I.length+1),l-y(I.slice(F+1,S-1))}else if(d.macroUse){const S={};if(S.start=C(this,re).findIndex(_=>{var B;return(B=_.macroDef)==null?void 0:B.startsWith(d.macroUse)}),S.start>-1){const _=B=>{let Y=B+1;for(;C(this,re)[Y].macroDef!==";"&&C(this,re)[Y].trackNo===C(this,re)[B].trackNo;)Y++;return Y};return S.end=_(S.start),S.blocks=C(this,re).slice(S.start+1,S.end),l+y(S.blocks)}}return l},0);return y(t)}else return 0})(o),console.log(`Skipped playback time: ${Ie.additionalStartMSec} ms`)}Le.disabled=qe.disabled=!0}}re=new WeakMap,rt=new WeakMap,at=new WeakMap,gt=new WeakMap,ze=new WeakMap,yt=new WeakSet,Cn=function({str:e,scoreNoteValue:r=4}={}){if(!e)return r;const a=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(e),o=a&&a[1]?Number(a[1]):r,t=a?a[2].length:0;return o*2**t/(2**(t+1)-1)};var ge,Vt,bt,ot;class gs{constructor(){ue(this,ge,[[],[]]);ue(this,Vt,70);ue(this,bt,e=>{});ue(this,ot,e=>{})}set onPushstate(e){Ne(this,bt,e)}set onPopstate(e){Ne(this,ot,e)}pushState(e){C(this,ge)[0].push(e),C(this,bt).call(this,e),C(this,ge)[0].length>C(this,Vt)&&C(this,ge)[0].shift(),C(this,ge)[1].length=0,console.log(C(this,ge))}undo(){const e=C(this,ge)[0].pop();return C(this,ot).call(this,{reason:"undo",data:e}),e&&C(this,ge)[1].unshift(e),console.log(C(this,ge)),{canUndo:!!C(this,ge)[0].length,canRedo:!!C(this,ge)[1].length}}redo(){const e=C(this,ge)[1].shift();return C(this,ot).call(this,{reason:"redo",data:e}),e&&C(this,ge)[0].push(e),console.log(C(this,ge)),{canUndo:!!C(this,ge)[0].length,canRedo:!!C(this,ge)[1].length}}clear(){C(this,ge)[0].length=0,C(this,ge)[1].length=0,console.log(C(this,ge))}}ge=new WeakMap,Vt=new WeakMap,bt=new WeakMap,ot=new WeakMap;const Ae=[1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,384];let K=me.querySelector("button"),jr=!1,Oe=!1;const Be={timeStamp:-1,tempo:120,scoreNoteValue:"4"};let Dn=null,Mn=!1,Ct=null;const Br=()=>{T.activeTrack.querySelectorAll("button").forEach(n=>{n.classList.remove("done")}),Mn=!1},$t=()=>{if(clearTimeout(Dn),K&&K.closest(".track")!==T.activeTrack){K=T.activeTrack.querySelector("button");return}let n=K;const e=()=>{const t=performance.measure("stepElapsed","stepPoint");performance.mark("stepPoint");const i=t.duration,h=(b=>{const m=60/Be.tempo*4/b*1e3,{noteValue:y,dots:w}=Ae.reduce((I,R,l)=>{const d=Math.log2(m/(2*m-R));if(d<0||Number.isNaN(d))return I;const F=d-Math.floor(d);return F<I.smallerFractional?{noteValue:R,dots:Math.round(d),smallerFractional:F}:I},{noteValue:null,dots:null,smallerFractional:1});if(y+".".repeat(w)===Be.scoreNoteValue)return"";if(String(y)===Be.scoreNoteValue){const I=Be.scoreNoteValue.match(/\.*/),R=I?I[0].length:0;return".".repeat(w-R)}else return y+".".repeat(w)})(i);(b=>{const m=Ct;"tonePitch"in m.dataset?m.dataset.tonePitch=m.dataset.tonePitch+b:"rest"in m.dataset&&(m.dataset.rest="r"+b)})(h),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X)};if(!n){if(Mn){console.log("end1");return}xe.stop(),e(),Be.timeStamp=-1,Ct=null,performance.clearMarks("stepPoint"),setTimeout(()=>{K=T.activeTrack.querySelector("button"),Br()},2e3),Mn=!0,console.log("end2");return}(()=>{if("tonePitch"in n.dataset){n.dataset.tonePitch=n.dataset.tonePitch.match(/[><]*?[a-g]\+?/i)[0],je(n,{noteValue:"1..."}),n.classList.add("bounce");return}"rest"in n.dataset&&(n.dataset.rest="r"),n.classList.add("done")})();const a=()=>{var t;K=n=((t=n.parentElement.nextElementSibling)==null?void 0:t.firstElementChild)||null};if("tonePitch"in n.dataset||xe.stop(),!["tonePitch","rest"].some(t=>t in n.dataset)){if("tempo"in n.dataset){const t=Number(n.dataset.tempo.replace("t",""));Be.tempo=t}else"noteValue"in n.dataset&&(Be.scoreNoteValue=(n.dataset.noteValue.match(/[0-9]+\.*/)||[Be.scoreNoteValue])[0]);a(),$t(),console.log("end3");return}if((()=>{const t=60/Be.tempo*4*1e3*1.825;Dn=setTimeout($t,t)})(),!performance.getEntriesByName("stepPoint")[0]){performance.mark("stepPoint"),Ct=n,a(),console.log("end4");return}e(),Ct=n,a()};let Pe=!1;var He,Et;class ys{constructor(){ue(this,He,30);ue(this,Et,1e3/(C(this,He)*4));this.outputs=null,this.output=null,this.startMSec=0,this.additionalStartMSec=0,this.startTime=0,this.timer=null,this.initialized=!1}getQuarterFrameMessages(e,r,a,o){return[[241,0|o&15],[241,16|o>>4&1],[241,32|a&15],[241,48|a>>4&3],[241,64|r&15],[241,80|r>>4&3],[241,96|e&15],[241,118|e>>4&1]]}framesToTimecode(e){const r=e%C(this,He),a=Math.floor(e/C(this,He)),o=a%60,t=Math.floor(a/60),i=t%60;return{hours:Math.floor(t/60)%24,minutes:i,seconds:o,frames:r}}sendQuarterFrame(){if(!this.output)return;const e=performance.now(),r=(e-this.startTime)/1e3,a=Math.floor((this.startMSec+this.additionalStartMSec)/1e3*C(this,He)+r*C(this,He)),{hours:o,minutes:t,seconds:i,frames:p}=this.framesToTimecode(a);this.getQuarterFrameMessages(o,t,i,p).forEach((f,b)=>{var m;(m=this.output)==null||m.send(f,e+b*C(this,Et))}),this.timer=window.setTimeout(()=>this.sendQuarterFrame(),C(this,Et)*8)}async init(){if(!this.initialized)return this.initialized=!0,navigator.requestMIDIAccess().then(e=>this.outputs=Array.from(e.outputs.values()))}configure(e){Object.assign(this,e)}start(){if(!this.output){console.warn("MTC Sync output not available.");return}this.startTime=performance.now(),this.sendQuarterFrame()}stop(){this.timer&&(clearTimeout(this.timer),this.timer=null)}}He=new WeakMap,Et=new WeakMap;const Ie=new ys;var St,Ke,Wt,zt,Ht,qt,Yt,Gt,Kt,Jt,Xt;class bs{constructor(e){ue(this,St,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name",value:(e,r)=>r.ariaLabel},{label:"音の定義",type:"text",name:"tone-def",autofocus:!0,value:e=>e}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}],run:(e,r)=>{const{"tone-name":a}=r;a.insertAdjacentElement("afterend",Ss);const o=document.querySelector("emoji-picker");a.addEventListener("focus",()=>{o.classList.add("expaned")},{once:!0}),o.addEventListener("emoji-click",t=>a.value=t.detail.unicode)},on:{"set-tone":(e,r)=>{const{"tone-name":a,"tone-def":o}=r,t=e.className;document.querySelectorAll(`[class*="${t}"]`).forEach(i=>{i.ariaLabel=a,(!i.classList.contains("material-icons")||a!=="無調整")&&(i.classList.remove("material-icons"),i.textContent=a),i.dataset.tone=o})}}},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}],run:(e,r)=>{const{"tone-pitch":a}=r;C(this,Ke).call(this,a)},on:{"set-tone-pitch":(e,r)=>{const{"tone-pitch":a,dot:o}=r;e.dataset.tonePitch=`${e.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]}${a}${".".repeat(o)}`}}},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0",value:e=>e.replace("t","")}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}],on:{"set-tempo":(e,r)=>{const{tempo:a}=r;e.dataset.tempo=`t${a}`}}},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}],run:(e,r)=>{const{"note-value":a}=r;C(this,Ke).call(this,a)},on:{"set-note-value":(e,r)=>{const{"note-value":a,dot:o}=r;e.dataset.noteValue=`l${a}${".".repeat(o)}`}}},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}],run:(e,r)=>{const{rest:a}=r;C(this,Ke).call(this,a)},on:{"set-rest":(e,r)=>{const{rest:a,dot:o}=r;e.dataset.rest=`r${a}${".".repeat(o)}`}}},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8",value:e=>e.startsWith("o")?e.replace("o",""):(e.match(/[><]+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}],on:{"set-octave":(e,r)=>{const{octave:a}=r;e.dataset.octave=`o${a}`},"set-octave-relative":(e,r)=>{const{octave:a}=r;e.dataset.octave=(a>0?"<":">").repeat(Math.abs(a))}}},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127",value:e=>e.startsWith("@v")?e.replace("@v",""):Number((e.match(/[0-9]+/)||[""])[0])*(e.startsWith("(")?1:-1)}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}],on:{"set-velocity":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=`@v${a}`},"set-velocity-relative":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=(a>0?"(":")").repeat(Math.abs(a))}}},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift",value:e=>(e.match(/[0-9]+/)||[""])[0]}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}],on:{"set-note-shift":(e,r)=>{const{"note-shift":a}=r;e.dataset.noteShift=`ns${a}`},"set-note-shift-relative":(e,r)=>{const{noteShift:a}=r;e.dataset.noteShift=`@ns${a}`}}},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune",value:e=>e.replace("@d","")}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}],on:{"set-detune":(e,r)=>{const{detune:a}=r;e.dataset.detune=`@d${a}`}}},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}],run:(e,r)=>{const{"tie-slur":a}=r;C(this,Ke).call(this,a)},on:{"set-tie-slur":(e,r)=>{const{"tie-slur":a,dot:o}=r;e.dataset.tieSlur=`&${a}${".".repeat(o)}`,e.dataset.tieSlur==="&"?e.ariaLabel="スラー":e.ariaLabel="タイ"}}},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0",value:e=>e.replace("/:","")}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}],on:{"set-repeat":(e,r)=>{const{repeat:a}=r;e.dataset.repeatStartEnd=`/:${a}`}}},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name",value:e=>(e.match(/\$([^\{\=]*)/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}],on:{"set-macro-def":(e,r)=>{const{"macro-def-name":a,"macro-def-arg":o}=r;e.dataset.macroDef=`$${a}${o?`{${o}}`:""}=`;const t=(e.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];oe.querySelectorAll(`[data-macro-use^="${t}"]`).forEach(i=>{i.dataset.macroUse=i.dataset.macroUse.replace(t,`$${a}`)})}}},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use",value:e=>e.replace("%","")}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}],run:(e,r)=>{const{"macro-arg-use":a}=r,t=(()=>{let b=this.item.parentElement;for(;b&&!b.firstElementChild.dataset.macroDef;)b=b.previousElementSibling;return(b==null?void 0:b.firstElementChild)||null})();if(!t||t.dataset.macroDef===";")return;const h=(t.dataset.macroDef.match(/\{([^\}]*)\}/)||[,""])[1].split(","),f=document.createElement("datalist");f.id="macro-arg-use-list",h.forEach(b=>{const m=document.createElement("option");m.value=b,f.appendChild(m)}),a.after(f),a.setAttribute("list","macro-arg-use-list")},on:{"set-macro-arg-use":(e,r)=>{const{"macro-arg-use":a}=r;e.dataset.macroArgUse=`%${a}`}}},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name",value:e=>(e.match(/\$([^\{]*)\{?/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}],run:(e,r)=>{const{"macro-use-name":a}=r,o=document.createElement("datalist");o.id="macro-use-name-list",T.blocksData.filter(i=>i.macroDef&&i.macroDef!==";").map(i=>i.macroDef.replace("=","")).forEach(i=>{const p=document.createElement("option");p.label=(i.match(/\{[^\}]*\}/)||[""])[0],p.value=(i.match(/\$([^\{]*)\{?/)||[,""])[1],o.appendChild(p)}),a.after(o),a.setAttribute("list","macro-use-name-list")},on:{"set-macro-use":(e,r)=>{const{"macro-use-name":a,"macro-use-arg":o}=r;e.dataset.macroUse=`$${a}${o?`{${o}}`:""}`}}},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}],run:(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r,i=e.split(" "),p=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let h=p.findIndex(w=>i[0].startsWith(w));h===-1&&(h=0),a.selectedIndex=h;const f=w=>w.previousSibling,b=()=>a.selectedOptions[0],m=(w,I)=>{f(o).nodeValue=w[0],o.value=w[1],o.parentElement.style.display=w[2]?"none":"",f(t).nodeValue=I[0],t.value=I[1],t.parentElement.style.display=I[2]?"none":""},y=w=>{var l,d,F;const I=w===h,R=p[w];switch(R){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const D=I?i.slice(1).join(" ")??"":"";m(["無効","",!0],[b().label,D,!1]);break;case"#OCTAVE":case"#VELOCITY":m(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const A=R==="#WAV9",S=I?((l=i.slice(1).join(" "))==null?void 0:l.split(","))??[]:[];m(["波形番号",S[0]??0,!1],A?["初期変位,ループフラグ,データ",`${S[1]??0},${S[2]??0},${S[3]??""}`,!1]:["データ",S[1]??"",!1]),o.min=0,o.max=A?15:31;break;case"#OPM":case"#OPN":m(["音色番号",I?((d=i[0])==null?void 0:d.split("@")[1])??0:0,!1],["データ",I?((F=i.slice(1).join(" "))==null?void 0:F.slice(1,-1))??"":"",!1]),o.min=0,o.max=127;break;case"#FMGAIN":m(["音量利得",I?i[1].replace(`
`,"")??91:91,!1],["無効","",!0]),o.min=-127,o.max=127;break;case"#USING":m(["和音重ね数",I?i[2].replace(`
`,"")??2:2,!1],["無効","",!0]),o.min=1,o.max="";break}};y(h),a.addEventListener("change",w=>{y(w.target.selectedIndex)})},on:{"set-meta-data":(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r;e.ariaLabel=a.label,e.dataset.metaData=`${a.value.replace("{n}",o).replace("{desc}",t)}`}}},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action",value:e=>e}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}],on:{"set-other-action":(e,r)=>{const{"other-action":a}=r;e.dataset.otherAction=a,e.textContent=a.length>4?"…":a}}},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}],on:{"remove-left":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(K=null;[...o].includes(r);){const t=a.firstElementChild;Se.pushState({operation:"remove",removedElem:t,removedIndex:0,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere()},"remove-right":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(K=null;[...o].includes(r);){const t=a.lastElementChild;Se.pushState({operation:"remove",removedElem:t,removedIndex:o.length-1,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere()}}},step:{title:"ステップ音価記録",description:`ステップ音価記録は、簡単に音価を指定できる機能です。

各トラックの空白部分をテンポよくクリック、またはスペースキーを押して最初の音符から順に音価を決定します。
途中から指定をやり直したいときは、やり直したい音符をクリックすることでそこからやり直せます。

この画面は、Shiftキーを押しながらステップ音価記録ブロックをクリックすることで再度表示できます。`,buttons:[{className:"primaly",value:"set-step",textContent:"開始"},{value:"cancel-step",textContent:"やめる"}],on:{"set-step":()=>{jr=!0,Oe=!0},"cancel-step":()=>{Oe=!1}}},mtcSync:{title:"MTC同期設定",description:`他のMIDIシーケンサー等と再生を同期できます。
MTC Senderとして動作します。`,inputs:[{label:"送信先MIDIデバイス",select:{"":"---デバイスがありません---"},name:"select-mtc-sync",disabled:!0},{label:"再生開始オフセットミリ秒",type:"number",name:"start-msec",value:()=>Ie.startMSec||0,min:"0",disabled:!0}],buttons:[{className:"primaly",value:"set-sync-mtc",textContent:"開始",disabled:!0},{value:"cancel-sync-mtc",textContent:"やめる"}],run:async(e,r)=>{const{"select-mtc-sync":a,"start-msec":o}=r,t=Ee.buttons.querySelector('button[value="set-sync-mtc"]'),i=Ie.outputs?Ie.outputs:await Ie.init();if(i.length===0)return;a.textContent="",a.disabled=!1,o.disabled=!1,t.disabled=!1;for(const h of i){const f=document.createElement("option");f.value=h.id,f.textContent=h.name,a.appendChild(f)}let p=i.indexOf(Ie.output);p===-1&&(p=0),a.selectedIndex=p},on:{"set-sync-mtc":(e,r)=>{const{"select-mtc-sync":a,"start-msec":o}=r,t=Ie.outputs.find(p=>p.id===a.value),i=o;Ie.configure({output:t,startMSec:i}),Pe=!0,T.calcPlayFromHere()},"cancel-sync-mtc":()=>{Pe=!1}}}});ue(this,Ke,e=>{let r=e.valueAsNumber,a=Ae.findIndex(o=>o===r);e.addEventListener("input",()=>{const o=e.valueAsNumber;o!==r&&(o===0?(a=-1,e.value=""):o>r||Number.isNaN(r)?e.value=Ae[++a]:o<r&&(e.value=Ae[--a]),r=e.valueAsNumber)})});ue(this,Wt,e=>{const r=C(this,St)[e];C(this,zt).call(this,r.title),C(this,Ht).call(this,r.description),C(this,qt).call(this,r.inputs),C(this,Yt).call(this,r.buttons),C(this,Gt).call(this,r.run),C(this,Kt).call(this,r.on)});ue(this,zt,e=>{Ee._title.textContent=e||""});ue(this,Ht,e=>{if(Ee.description.textContent="",e){const r=document.createElement("p");r.innerText=e,Ee.description.appendChild(r)}});ue(this,qt,e=>{Ee.inputs.textContent="",e==null||e.forEach(r=>{const a="select"in r,o=document.createElement(a?"select":"input");let t=o;Object.entries(r).forEach(([i,p])=>{if(i==="label"){const h=document.createElement("label");h.textContent=p,h.appendChild(o),t=h}else i==="select"?Object.entries(p).forEach(([h,f])=>{const b=document.createElement("option");b.value=h,b.textContent=f,o.appendChild(b)}):i==="value"&&typeof p=="function"?o.value=p(this.mmlText,this.item):o[i]=p}),Ee.inputs.appendChild(t)})});ue(this,Yt,e=>{Ee.buttons.textContent="",e==null||e.forEach(r=>{const a=document.createElement("button");Object.entries(r).forEach(([o,t])=>{a[o]=t}),Ee.buttons.appendChild(a)})});ue(this,Gt,e=>{e&&e(this.mmlText,C(this,Jt).call(this))});ue(this,Kt,e=>{Ee.addEventListener("submit",r=>{const a=this.item,o=r.submitter.value,t=C(this,Xt).call(this),i=JSON.parse(JSON.stringify(a.dataset));console.log(o),e[o](a,t);const p=JSON.parse(JSON.stringify(a.dataset));JSON.stringify(i)!==JSON.stringify(p)&&Se.pushState({operation:"valueChange",target:a,beforeChange:i,afterChange:p}),this.resolve()},{once:!0})});ue(this,Jt,()=>Object.fromEntries([...Ee.elements].map(e=>[e.name,e])));ue(this,Xt,()=>Object.fromEntries([...Ee.elements].map(r=>{var a;return r instanceof HTMLSelectElement?[r.name,{label:(a=r.selectedOptions[0])==null?void 0:a.label,value:r.value}]:[r.name,r.valueAsNumber||r.value]})));this.item=null,this.type=null,this.mmlText=null,this.resolve=null}async prompt(e,r){if(this.item=e,this.type=r||Object.keys(C(this,St)).find(a=>a in e.dataset),!this.type){console.warn("No dialog type found for the item:",e);return}switch(this.mmlText=e.dataset[this.type],this.type){case"repeatStartEnd":if(this.mmlText===":/"){const o=(()=>{var i;let t=e.parentElement;for(;t&&!((i=t.firstElementChild.dataset.repeatStartEnd)!=null&&i.startsWith("/:"));)t=t.previousElementSibling;return(t==null?void 0:t.firstElementChild)||null})();if(o)e=o;else{const t=T.activeTrack,i=document.createElement("li"),h=we.querySelector(".repeat-start-end").cloneNode(!0);i.appendChild(h),t.insertBefore(i,e.parentElement),e=h}this.mmlText=e.dataset.repeatStartEnd}break;case"macroDef":if(this.mmlText===";")return;break}return C(this,Wt).call(this,this.type),Ge.showModal(),new Promise(a=>this.resolve=a)}}St=new WeakMap,Ke=new WeakMap,Wt=new WeakMap,zt=new WeakMap,Ht=new WeakMap,qt=new WeakMap,Yt=new WeakMap,Gt=new WeakMap,Kt=new WeakMap,Jt=new WeakMap,Xt=new WeakMap;pr.FlMML.prepare(".editor");const xe=new pr.FlMML({workerURL:Ca}),X=new ps;En.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const T=new vs(me,oe),Se=new gs,Re=new bs(Ee),Es={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},Ss=new Bn({i18n:Es,locale:"ja"});is.polyfill({holdToDrag:500});us();const pt=n=>`<span class="material-icons">${n}</span>`,Rr=pt("play_arrow")+"再生",ws=pt("stop")+"停止",An=()=>{const n=[...oe.querySelectorAll(".track button")].findIndex(e=>e.classList.contains("play-from-here"));T.playRendering(n),Pe&&Ie.start()},Ts=()=>{ms.innerText=xe.getWarnings()};xe.addEventListener("compilecomplete",Ts);const xs=()=>{jt.innerHTML=Rr,T.stopRendering(),Pe&&Ie.stop(),xe.removeEventListener("compilecomplete",An),Bt.disabled=!1};xe.addEventListener("complete",xs);X.onChange=(n,e)=>{hs.innerHTML=e?`<pre><code>${ls(cs(e))}</code></pre>`:"(なし)";const r=!!n.length;Le.disabled=qe.disabled=!r};X.onError=(n,e)=>{alert(n+`
`+e)};T.checkSavedBlocksData();const je=(n,e={})=>{var l;const r=()=>{let d=n.parentElement;for(;d&&!("noteValue"in d.firstElementChild.dataset);)d=d.previousElementSibling;return(d==null?void 0:d.firstElementChild)||null},a=()=>{var F;let d=n.parentElement;for(;d&&!((F=d.firstElementChild.dataset.octave)!=null&&F.startsWith("o"));)d=d.previousElementSibling;return(d==null?void 0:d.firstElementChild)||null},o=()=>{var D;let d=n.parentElement.nextElementSibling,F="";for(;d&&((D=d.firstElementChild.dataset.tieSlur)!=null&&D.match(/&[0-9]+\.*/));)F+=d.firstElementChild.dataset.tieSlur,d=d.nextElementSibling;return F},t=((l=r())==null?void 0:l.dataset.noteValue)||"",i=a(),p=i?[...T.activeTrack.children].indexOf(i.parentElement):0,h=(i==null?void 0:i.dataset.octave)||"",f=[...T.activeTrack.children].indexOf(n.parentElement),b=[...T.activeTrack.children].slice(p,f).filter(d=>"tonePitch"in d.firstElementChild.dataset||"octave"in d.firstElementChild.dataset&&!d.firstElementChild.dataset.octave.startsWith("o")).map(d=>((d.firstElementChild.dataset.tonePitch||d.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),m={down:">",up:"<"},y=(d,F)=>(d.match(new RegExp(F,"g"))||[]).length,w=(()=>{const d=-y(b,m.down)+y(b,m.up);return d<0?m.down.repeat(-d):d>0?m.up.repeat(d):""})(),I=o(),R=e.noteValue?n.dataset.tonePitch.replace(/[0-9]+\.*/,"")+e.noteValue:n.dataset.tonePitch;xe.play(n.dataset.tone+t+h+w+R+I)};Se.onPopstate=n=>{const e=n.data,r=a=>!!e.parent.closest("#"+a);switch(n.reason){case"undo":switch(e==null?void 0:e.operation){case"append":X.delete(e.index);break;case"delete":X.insert(e.index,e.mmlText);break;case"rewrite":X.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere());break;case"move":const a=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(a,e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere());break;case"valueChange":for(const[o,t]of Object.entries(e.beforeChange))e.target.dataset[o]=t;"tone"in e.target.dataset&&je(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere());break;case"clear":e.tonesChildren.forEach(o=>{me.querySelector("ul").appendChild(o)}),e.musicalScoreChildren.forEach(o=>{oe.insertBefore(o,Fe)}),K=e.lastTouchedButton,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":X.append(e.mmlText);break;case"delete":X.delete(e.index);break;case"rewrite":X.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere()),"tonePitch"in K.dataset&&(je(K),K.classList.add("bounce"));break;case"move":const a=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(a,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere());break;case"valueChange":for(const[t,i]of Object.entries(e.afterChange))e.target.dataset[t]=i;"tone"in e.target.dataset&&je(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X);break;case"remove":const o=e.removedElem.className;e.removedElem.remove(),r("tones")&&oe.querySelectorAll(`[class*="${o}"]`).forEach(t=>{t.parentElement.remove()}),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere();break;case"clear":me.querySelector("ul").textContent="",oe.querySelectorAll(".track").forEach((t,i)=>{i?t.remove():(t.textContent="",T.activeTrack=t)}),K=null,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X);break}break}};const Fr=()=>{const n=[...me.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!n.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",n=>{var r;const e=n.ctrlKey||Zt.checked;switch((r=n.key)==null?void 0:r.toLowerCase()){case" ":Oe?(n.preventDefault(),$t()):document.activeElement.tagName.toLowerCase()!=="input"&&(n.preventDefault(),jt.click());break;case"s":e&&(n.preventDefault(),!qe.disabled&&qe.click());break;case"o":e&&(n.preventDefault(),!In.disabled&&In.click());break;case"z":e&&Se.undo();break;case"y":e&&Se.redo();break}});Ye.addEventListener("click",async n=>{const e=n.ctrlKey||Zt.checked,r=o=>!!n.target.closest("#"+o),a=n.target.tagName.toLowerCase()==="button";if(![me,we,oe].some(o=>o.classList.contains("no-op"))){if(r("tones"))if(a)K=n.target,await Re.prompt(n.target,"tone"),xe.play(n.target.dataset.tone+n.target.dataset.tonePitch),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X);else{const o=me.querySelector("ul"),t=document.createElement("li"),p=`<button class="material-icons note ${Fr()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;t.innerHTML=p;const h=t.firstElementChild;o.appendChild(t),K=h,xe.play(h.dataset.tone+h.dataset.tonePitch),Se.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o})}else if(r("action")){if(a){if("otherAction"in n.target.dataset)await Re.prompt(n.target);else if("step"in n.target.dataset){jr&&!n.shiftKey?Oe=!Oe:await Re.prompt(n.target),Oe?(n.target.classList.add("enable"),n.target.ariaLabel="ステップ音価記録(有効)",K=T.activeTrack.querySelector("button")):(n.target.classList.remove("enable"),n.target.ariaLabel="ステップ音価記録(無効)",Br(),xe.stop(),clearTimeout(Dn));return}else if("mtcSync"in n.target.dataset){Pe?(Ie.stop(),Pe=!1):await Re.prompt(n.target,"mtcSync"),Pe?(n.target.classList.add("enable"),n.target.ariaLabel="MTC同期(有効)"):(n.target.classList.remove("enable"),n.target.ariaLabel="MTC同期(無効)");return}const o=T.activeTrack,t=document.createElement("li"),i=n.target.cloneNode(!0);if(["metaData","macroDef","macroUse"].some(p=>p in i.dataset)&&await Re.prompt(i),"tieSlur"in i.dataset?i.ariaLabel="スラー":"repeatStartEnd"in i.dataset?(i.classList.remove("material-icons"),i.ariaLabel="リピート開始",i.textContent="◆",i.dataset.repeatStartEnd="/:"):"polyStartEnd"in i.dataset?(i.dataset.polyStartEnd="[",i.textContent="["):"macroDef"in i.dataset?i.textContent="$=":"playFromHere"in i.dataset&&(oe.querySelectorAll(".track button").forEach(p=>{p.classList.add("inactive")}),Le.disabled=qe.disabled=!0),t.appendChild(i),o.appendChild(t),K=i,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere(),Se.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),["repeatStartEnd","polyStartEnd","macroDef"].some(p=>p in K.dataset)){const p=document.createElement("li"),h=n.target.cloneNode(!0);"repeatStartEnd"in K.dataset?(h.ariaLabel="リピート終了",h.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(h.dataset.polyStartEnd="]",h.textContent="]"):"macroDef"in K.dataset&&(h.dataset.macroDef=";",h.textContent=";"),p.appendChild(h),K.parentElement.insertAdjacentElement("afterend",p),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X),Se.pushState({operation:"copy",toIndex:-1,newElem:p,parent:o})}}}else if(r("musical-score")){if(a&&n.target!==Fe&&n.target!==it)n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Oe||("tone"in n.target.dataset?(je(n.target),De(n.target,"bounce"),e&&(await Re.prompt(n.target,"tonePitch"),je(n.target))):await Re.prompt(n.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X)),K=n.target;else if(n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Oe)$t();else if(K){const o=T.activeTrack,t=document.createElement("li"),i=K.cloneNode(!0);if("repeatStartEnd"in i.dataset&&(i.classList.remove("material-icons"),i.ariaLabel="リピート開始",i.textContent="◆",i.dataset.repeatStartEnd="/:"+(i.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),t.appendChild(i),o.appendChild(t),K=i,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere(),Se.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),"tonePitch"in i.dataset)i.dataset.tonePitch=i.dataset.tonePitch.replace(/[><]+/,""),je(i),i.classList.add("bounce");else if("repeatStartEnd"in K.dataset){const p=document.createElement("li"),h=K.cloneNode(!0);h.classList.add("material-icons"),h.ariaLabel="リピート終了",h.textContent="repeat",h.dataset.repeatStartEnd=":/",p.appendChild(h),K.parentElement.insertAdjacentElement("afterend",p),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X),Se.pushState({operation:"copy",toIndex:-1,newElem:p,parent:o})}}}}});Ye.addEventListener("contextmenu",n=>{var o,t,i,p;if(Oe)return;const e=h=>h.closest("#tones, #musical-score"),r=h=>!!n.target.closest("#"+h),a=n.target.tagName.toLowerCase()==="button";if(!((o=e(n.target))!=null&&o.classList.contains("no-op"))&&e(n.target)){const h=a&&n.target!==Fe&&n.target!==it?n.target:K;if(!h||e(h)!==e(n.target))return;n.preventDefault(),T.activeTrack=h.closest(".track")||T.activeTrack;const f=h.parentElement,b=h.className,m=((t=h.closest("#tones"))==null?void 0:t.querySelector("ul"))||T.activeTrack,y=[...m.children].indexOf(f);if(K=((i=f.previousElementSibling)==null?void 0:i.firstElementChild)||((p=f.nextElementSibling)==null?void 0:p.firstElementChild)||null,Se.pushState({operation:"remove",removedElem:f,removedIndex:y,parent:m}),r("tones"))oe.querySelectorAll(`[class*="${b}"]`).forEach(w=>{w.parentElement.remove()});else if("macroDef"in h.dataset){const w=(h.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];oe.querySelectorAll(`[data-macro-use^="${w}"]`).forEach(I=>{I.parentElement.remove()})}else"playFromHere"in h.dataset&&(oe.querySelectorAll(".inactive").forEach(w=>{w.classList.remove("inactive")}),Le.disabled=qe.disabled=!1);f.remove(),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere()}});let At=null,Rn=!1,Ut=null;Ye.addEventListener("touchstart",n=>{At=[...n.touches].at(-1).pageY,Ut=setTimeout(()=>{Rn=!0},500)});const $r=n=>{if(Oe)return;const e=n.ctrlKey||Zt.checked,r=i=>!!n.target.closest("#"+i),a=n.target.tagName.toLowerCase()==="button";if(n.type==="touchmove"){const i=[...n.touches].at(-1).pageY;if(Rn){n.cancelable&&n.preventDefault();return}else if(i-At<-30)n.deltaY=-1,clearTimeout(Ut);else if(i-At>30)n.deltaY=1,clearTimeout(Ut);else{n.cancelable&&n.preventDefault();return}At=i}const o=n.deltaY<0;let t=a&&n.target!==Fe&&n.target!==it?n.target:(K==null?void 0:K.closest("#musical-score"))&&K;if(t){if(r("musical-score")){if(oe.classList.contains("no-op"))return;n.preventDefault();let i=JSON.parse(JSON.stringify(t.dataset));if(!e&&"tone"in t.dataset){const h=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],f={down:">",up:"<"},b=t.dataset.tonePitch,m=h.findIndex(d=>b.match(/[a-g]\+?/)[0]===d),y=(d,F)=>(d.match(new RegExp(F,"g"))||[]).length,w={down:y(b,f.down),up:y(b,f.up)},I=f.down.repeat(w.down)+f.up.repeat(w.up),R=(b.match(/[0-9]+/)||[""])[0],l=(t.dataset.tonePitch.match(/\.+/)||[""])[0];o?m===h.length-1?w.down?t.dataset.tonePitch=I.substring(1)+h.at(0)+R+l:t.dataset.tonePitch=I+f.up+h.at(0)+R+l:t.dataset.tonePitch=I+h[m+1]+R+l:m===0?w.up?t.dataset.tonePitch=I.substring(1)+h.at(-1)+R+l:t.dataset.tonePitch=I+f.down+h.at(-1)+R+l:t.dataset.tonePitch=I+h[m-1]+R+l,je(t)}else{const h=o?1:-1,f=(b,m=-1/0,y=1/0)=>b+h<m||b+h>y?0:h;if(e&&"tonePitch"in t.dataset){const b=Number((t.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),m=(t.dataset.tonePitch.match(/\.+/)||[""])[0],y=f(b,0,384),w=Ae.findIndex(R=>R===b),I=b+y!==0?Ae[w+y]:"";t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+I+m,je(t)}else if("tempo"in t.dataset){const b=Number(t.dataset.tempo.replace("t","")),m=f(b,0);t.dataset.tempo="t"+(b+m*10)}else if("noteValue"in t.dataset){const b=Number((t.dataset.noteValue.match(/[0-9]+/)||[""])[0]),m=f(b,1,384),y=Ae.findIndex(w=>w===b);t.dataset.noteValue=t.dataset.noteValue.replace(/[0-9]+/,Ae[y+m])}else if("rest"in t.dataset){const b=Number((t.dataset.rest.match(/[0-9]+/)||[""])[0]),m=(t.dataset.rest.match(/\.+/)||[""])[0],y=f(b,0,384),w=Ae.findIndex(R=>R===b),I=b+y!==0?Ae[w+y]:"";t.dataset.rest="r"+I+m}else if("octave"in t.dataset)if(t.dataset.octave.startsWith("o")){const m=Number(t.dataset.octave.replace("o","")),y=f(m,0,8);t.dataset.octave="o"+(m+y)}else{const m=(t.dataset.octave.match(/<+/)||[""])[0].length-(t.dataset.octave.match(/>+/)||[""])[0].length,y=f(m,-8,8);t.dataset.octave=m+y>0?"<".repeat(m+y):">".repeat(-(m+y))}else if("velocity"in t.dataset)if(t.dataset.velocity.startsWith("@v")){const m=Number(t.dataset.velocity.replace("@v","")),y=f(m,0,127);t.dataset.velocity="@v"+(m+y)}else{const m=Number((t.dataset.velocity.match(/[0-9]+/)||[""])[0])*(t.dataset.velocity.startsWith("(")?1:-1),y=f(m,-127,127);t.dataset.velocity=(m+y>=0?"(":")")+Math.abs(m+y)}else if("noteShift"in t.dataset){const b=Number((t.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),m=h;t.dataset.noteShift=t.dataset.noteShift.match(/@?ns/)[0]+(b+m)}else if("detune"in t.dataset){const b=Number(t.dataset.detune.replace("@d","")),m=h;t.dataset.detune="@d"+(b+m)}else if("tieSlur"in t.dataset){const b=Number((t.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),m=(t.dataset.tieSlur.match(/\.+/)||[""])[0],y=f(b,0,384),w=Ae.findIndex(R=>R===b),I=b+y!==0?Ae[w+y]:"";t.dataset.tieSlur="&"+I+m,t.dataset.tieSlur==="&"?t.ariaLabel="スラー":t.ariaLabel="タイ"}else if("repeatStartEnd"in t.dataset){if(t.dataset.repeatStartEnd===":/"){const I=(()=>{var l;let R=t.parentElement;for(;R&&!((l=R.firstElementChild.dataset.repeatStartEnd)!=null&&l.startsWith("/:"));)R=R.previousElementSibling;return(R==null?void 0:R.firstElementChild)||null})();if(I)t=I;else{const R=T.activeTrack,l=document.createElement("li"),F=we.querySelector(".repeat-start-end").cloneNode(!0);l.appendChild(F),R.insertBefore(l,t.parentElement),t=F}i=JSON.parse(JSON.stringify(t.dataset))}const b=Number((t.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),m=f(b,-1),y=b+m!==-1?b+m:"";t.dataset.repeatStartEnd="/:"+y}}const p=JSON.parse(JSON.stringify(t.dataset));JSON.stringify(i)!==JSON.stringify(p)&&Se.pushState({operation:"valueChange",target:t,beforeChange:i,afterChange:p}),K=t,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X)}}else return};Ye.addEventListener("wheel",$r);Ye.addEventListener("touchmove",$r);Ye.addEventListener("touchend",()=>{clearTimeout(Ut),Rn=!1});let mt={};Ye.addEventListener("dragstart",n=>{mt={from:n.target.nodeType===1&&n.target.closest("#tones, #action, #musical-score"),item:n.target},n.dataTransfer.effectAllowed="copyMove"});let mr=null;[me,we,oe].forEach(n=>{const e=t=>{const i=t.ctrlKey||Zt.checked,{from:p=null}=mt,h=t.dataTransfer;switch(p){case me:switch(n){case me:t.preventDefault(),i?h.dropEffect="copy":h.dropEffect="move";break;case we:break;case oe:t.preventDefault(),h.dropEffect="copy";break}break;case we:switch(n){case me:break;case we:break;case oe:t.preventDefault(),h.dropEffect="copy";break}break;case oe:switch(n){case me:break;case we:break;case oe:t.preventDefault(),i?h.dropEffect="copy":h.dropEffect="move";break}break}mr=h.dropEffect};n.addEventListener("dragover",e);const r=t=>{const{from:i=null}=mt,p=t.target.tagName.toLowerCase()==="button",h=()=>t.target.classList.add("droppable");switch(i){case me:switch(n){case me:t.preventDefault(),p&&h();break;case we:break;case oe:t.preventDefault(),p&&h();break}break;case we:switch(n){case me:break;case we:break;case oe:t.preventDefault(),p&&h();break}break;case oe:switch(n){case me:break;case we:break;case oe:t.preventDefault(),p&&h();break}break}};n.addEventListener("dragenter",r);const a=t=>{const{from:i=null}=mt,p=t.target.tagName.toLowerCase()==="button",h=()=>t.target.classList.remove("droppable");switch(i){case me:switch(n){case me:p&&h();break;case we:break;case oe:p&&h();break}break;case we:switch(n){case me:break;case we:break;case oe:p&&h();break}break;case oe:switch(n){case me:break;case we:break;case oe:p&&h();break}break}};n.addEventListener("dragleave",a),n.addEventListener("drop",async t=>{var w,I;if(t.preventDefault(),(w=t.dataTransfer.items)!=null&&w.length)return;t.dataTransfer.dropEffect=t.dataTransfer.dropEffect!=="none"?t.dataTransfer.dropEffect:mr;const{from:i,item:p}=mt,h=((I=t.target.closest("#tones"))==null?void 0:I.querySelector("ul"))||t.target.closest(".track")||T.activeTrack,f=[...n.querySelectorAll("button")].indexOf(p),b=[...n.querySelectorAll("button")].indexOf(t.target),m=t.target.tagName.toLowerCase()==="button";let y;switch(t.dataTransfer.dropEffect){case"copy":const R=document.createElement("li"),l=p.cloneNode(!0);if(n===me){const d=[...p.classList].find(F=>F.includes("note-"));l.classList.replace(d,Fr())}else i===we&&("tieSlur"in l.dataset?l.ariaLabel="スラー":["metaData","macroDef","macroUse","otherAction"].some(d=>d in l.dataset)&&await Re.prompt(l));"repeatStartEnd"in l.dataset?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"+(l.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in l.dataset?(l.dataset.polyStartEnd="[",l.textContent="["):"macroDef"in l.dataset&&(l.dataset.macroDef===";"&&(l.dataset.macroDef="$="),l.textContent="$="),R.appendChild(l),y=R;break;case"move":y=p.parentElement;break}if(m&&t.target.id!=="add-track"&&t.target.id!=="remove-track"){const R=t.dataTransfer.dropEffect==="copy"||b<f?"beforebegin":"afterend";t.target.parentElement.insertAdjacentElement(R,y)}else h.appendChild(y);switch(K=y.firstElementChild,n===oe&&(T.activeTrack=h,T.blocksDataUpdate(),t.dataTransfer.dropEffect==="move"&&T.calcPoly(),T.saveBlocksData(),T.exportMml(X),T.calcPlayFromHere(),"tonePitch"in K.dataset&&(K.dataset.tonePitch=K.dataset.tonePitch.replace(/[><]+/,""),je(K),K.classList.add("bounce"))),t.dataTransfer.dropEffect){case"copy":Se.pushState({operation:"copy",toIndex:b,newElem:y,parent:h});break;case"move":Se.pushState({operation:"move",fromIndex:f,toIndex:b,elem:y,parent:h});break}if(t.dataTransfer.dropEffect==="copy"&&["repeatStartEnd","polyStartEnd","macroDef"].some(R=>R in K.dataset)){const R=document.createElement("li"),l=p.cloneNode(!0);"repeatStartEnd"in K.dataset?(l.classList.add("material-icons"),l.ariaLabel="リピート終了",l.textContent="repeat",l.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(l.dataset.polyStartEnd="]",l.textContent="]"):"macroDef"in K.dataset&&(l.dataset.macroDef=";",l.textContent=";"),R.appendChild(l),y.insertAdjacentElement("afterend",R),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X),Se.pushState({operation:"copy",toIndex:b+1,newElem:R,parent:h})}});const o=t=>{[...document.getElementsByClassName("droppable")].forEach(i=>{i.classList.remove("droppable")})};n.addEventListener("dragend",o)});Ye.addEventListener("animationend",n=>{n.target.classList.remove("bounce"),n.target.classList.remove("pop")});Fe.addEventListener("click",n=>{n.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),T.activeTrack=e,oe.insertBefore(e,Fe)});it.addEventListener("click",n=>{n.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),T.activeTrack=r,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X)});Ge.addEventListener("pointerdown",n=>{n.target===Ge&&Ge.addEventListener("pointerup",e=>{e.target===Ge&&Ge.close()},{once:!0})});Ge.addEventListener("close",()=>{switch(Re.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});jt.addEventListener("click",()=>{const n=xe.isPlaying();n?(xe.stop(),T.stopRendering(),Pe&&Ie.stop(),xe.removeEventListener("compilecomplete",An),Bt.disabled=!1):(xe.play(X.getMml()),xe.addEventListener("compilecomplete",An),Bt.disabled=!0),jt.innerHTML=n?Rr:ws});Bt.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const n=[...oe.children];n.pop(),Se.pushState({operation:"clear",tonesChildren:[...me.querySelector("ul").children],musicalScoreChildren:n,lastTouchedButton:K}),me.querySelector("ul").textContent="";const e=me.querySelector("ul"),r=document.createElement("li"),a='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=a;const o=r.firstElementChild;e.appendChild(r),K=o,oe.querySelectorAll(".track").forEach((t,i)=>{i?t.remove():(t.textContent="",T.activeTrack=t)}),xe.play(""),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(X)}});Le.addEventListener("click",async n=>{const e=n.shiftKey?JSON.stringify(T.blocksData):X.getMml(),r=Le.innerHTML;Le.disabled=!0,navigator.clipboard.writeText(e).then(()=>{Le.disabled=!0,Le.innerHTML=pt("content_copy")+"コピーしました",n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータをコピーしました。"),setTimeout(()=>{Le.innerHTML=r,Le.disabled=!1},1500)}).catch(a=>alert(`コピーできませんでした
`+a))});We.addEventListener("click",()=>{const n=We.innerHTML;We.disabled=!0,navigator.clipboard.readText().then(e=>{We.disabled=!0,e?(Pt(e)?T.blocksData=JSON.parse(e):(X.setMml(e.replace(/\r/g,"")),T.importMml(X)),We.innerHTML=pt("content_paste")+"貼り付けました",Pt(e)&&alert("JSONブロックデータが貼り付けられました。")):We.innerHTML=pt("content_paste")+"内容がありません",setTimeout(()=>{We.innerHTML=n,We.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});qe.addEventListener("click",n=>{var i;const r=((i=X.getMmlArr().find(p=>p.startsWith("#TITLE")))==null?void 0:i.split(" ").slice(1).join(" "))??"無題",a=n.shiftKey?JSON.stringify(T.blocksData):X.getMml(),o=new Blob([a],{type:n.shiftKey?"application/json":"text/plain"}),t=document.createElement("a");t.download=r+(n.shiftKey?".json":".mml"),t.href=URL.createObjectURL(o),t.click(),URL.revokeObjectURL(t.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。"),n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータを保存しました。")});const Ur=[".mml",".flmml",".txt",".json"];In.addEventListener("click",()=>{const n=document.createElement("input");n.type="file",n.accept=Ur.join(","),n.click(),n.onchange=async()=>{const r=await n.files[0].text();Pt(r)?(T.blocksData=JSON.parse(r),alert("JSONブロックデータが読み込まれました。")):(X.setMml(r.replace(/\r/g,"")),T.importMml(X))}});document.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer.types.includes("Files")&&(n.dataTransfer.dropEffect="copy")});let tt=0;document.addEventListener("dragenter",n=>{n.preventDefault(),n.dataTransfer.types.includes("Files")&&(tt++,tt===1&&Qt.classList.add("file-dragover"))});document.addEventListener("dragleave",n=>{n.preventDefault(),n.dataTransfer.types.includes("Files")&&(tt--,tt<=0&&(tt=0,Qt.classList.remove("file-dragover")))});document.addEventListener("drop",async n=>{n.preventDefault(),tt=0,Qt.classList.remove("file-dragover");const e=n.dataTransfer.files;if(e.length===0)return;const r=e[0],a=r.name.toLowerCase().substring(r.name.lastIndexOf("."));if(!Ur.includes(a)){alert("対応していないファイル形式です。.mml, .flmml, .txt, .json ファイルのみ対応しています。");return}const o=await r.text();Pt(o)?(T.blocksData=JSON.parse(o),alert("JSONブロックデータが読み込まれました。")):(X.setMml(o.replace(/\r/g,"")),T.importMml(X))});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");Se.onPushstate=n=>{Rt.disabled=!1,Ft.disabled=!0};Rt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=Se.undo();Rt.disabled=!n,Ft.disabled=!e});Ft.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=Se.redo();Rt.disabled=!n,Ft.disabled=!e});
