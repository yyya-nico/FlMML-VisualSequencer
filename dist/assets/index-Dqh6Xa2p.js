var sn=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var C=(n,e,r)=>(sn(n,e,"read from private field"),r?r.call(n):e.get(n)),ce=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},ke=(n,e,r,a)=>(sn(n,e,"write to private field"),a?a.call(n,r):e.set(n,r),r);var cn=(n,e,r)=>(sn(n,e,"access private method"),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const i of t.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function r(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(o){if(o.ep)return;o.ep=!0;const t=r(o);fetch(o.href,t)}})();const ka="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var dt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Na(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var fr={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(r,a){n.exports=a()})(self,function(){return(()=>{var r={587:(t,i,m)=>{var h;(h=(function(u,E){Object.defineProperty(E,"__esModule",{value:!0}),E.MsgTypes=E.SAMPLE_RATE=void 0,E.SAMPLE_RATE=44100,E.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(i,[m,i]))===void 0||(t.exports=h)},581:(t,i,m)=>{var h;(h=(function(u,E){Object.defineProperty(E,"__esModule",{value:!0}),E.FlMMLAudioExportError=void 0;class f extends Error{constructor(...w){super(...w),this.name="FlMMLAudioExportError"}}E.FlMMLAudioExportError=f}).apply(i,[m,i]))===void 0||(t.exports=h)},643:function(t,i,m){var h,u,E=this&&this.__awaiter||function(f,y,w,D){return new(w||(w=Promise))(function(L,l){function g(M){try{A(D.next(M))}catch(b){l(b)}}function O(M){try{A(D.throw(M))}catch(b){l(b)}}function A(M){var b;M.done?L(M.value):(b=M.value,b instanceof w?b:new w(function(R){R(b)})).then(g,O)}A((D=D.apply(f,y||[])).next())})};h=[m,i,m(587),m(581),m(158)],(u=(function(f,y,w,D,L){Object.defineProperty(y,"__esModule",{value:!0}),y.FlMMLonHTML5=y.FlMMLAudioExportError=y.FlMML=void 0,Object.defineProperty(y,"FlMMLAudioExportError",{enumerable:!0,get:function(){return D.FlMMLAudioExportError}});const l="flmml-on-html5.worker.js";class g{constructor(A=l){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof A=="string"&&(A={workerURL:A});const M=A.workerURL||l,b=A.infoInterval>=0?A.infoInterval:125;this.bufferSize=A.bufferSize>=128?Math.floor(A.bufferSize-A.bufferSize%128):8192,this.bufferMultiple=A.bufferMultiple>=1?Math.floor(A.bufferMultiple):32,this.lamejsURL=A.lamejsURL,(this.worker=new Worker(A.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${M}")`],{type:"application/javascript"})):M)).addEventListener("message",R=>{this.onMessage(R)}),this.setInfoInterval(b)}static initWebAudio(){const A=g.audioCtx=new AudioContext({sampleRate:w.SAMPLE_RATE}),M=A.createBufferSource();M.connect(A.destination),M.start(0),A.resume(),M.stop()}static hookInitWebAudio(A){const M=document.querySelectorAll(A);M.forEach(b=>{b.addEventListener("click",function R(){g.audioCtx||g.initWebAudio(),M.forEach(U=>{U.removeEventListener("click",R,!0)})},!0)})}static prepare(A){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{g.hookInitWebAudio(A)}):g.hookInitWebAudio(A)}onMessage(A){const M=A.data;switch(M.type){case w.MsgTypes.COMPCOMP:this.totalMSec=M.info.totalMSec,this.totalTimeStr=M.info.totalTimeStr,this.warnings=M.info.warnings,this.metaTitle=M.info.metaTitle,this.metaComment=M.info.metaComment,this.metaArtist=M.info.metaArtist,this.metaCoding=M.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case w.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(M),this.trigger("buffering",{progress:M.progress});break;case w.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case w.MsgTypes.SYNCINFO:this._isPlaying=M.info._isPlaying,this._isPaused=M.info._isPaused,this.nowMSec=M.info.nowMSec,this.nowTimeStr=M.info.nowTimeStr,this.voiceCount=M.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case w.MsgTypes.PLAYSOUND:this.playSound();break;case w.MsgTypes.STOPSOUND:this.stopSound();break;case w.MsgTypes.EXPORT:M.data?this.completeAudioExport(M.data):this.errorAudioExport(M.errorMsg)}}boot(){this.worker.postMessage({type:w.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const A=g.audioCtx,M=this.gainNode=A.createGain();M.gain.value=this.volume/127,M.connect(A.destination),E(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(R=>{const U=new FileReader;U.onload=G=>{A.audioWorklet.addModule(G.target.result).then(R)},U.readAsDataURL(new Blob([L.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const b=this.workletNode=new AudioWorkletNode(A,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});b.connect(M),this.worker.postMessage({type:w.MsgTypes.PLAYSOUND,workletPort:b.port},[b.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:w.MsgTypes.STOPSOUND})}trigger(A,M){const b=this.events[A];if(!b)return;const R={};for(let U in M)R[U]=M[U];for(let U=0,G=b.length;U<G;U++)b[U]&&b[U].call(this,R)}exportAudio(A,M,b={}){return g.audioCtx||g.initWebAudio(),this.booted||this.boot(),new Promise((R,U)=>{this.audioExportResolve?U(new D.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:w.MsgTypes.EXPORT,mml:A,format:M},b)),this.audioExportResolve=R,this.audioExportReject=U)})}completeAudioExport(A){this.audioExportResolve&&(this.audioExportResolve(A),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(A){this.audioExportReject&&(this.audioExportReject(new D.FlMMLAudioExportError(A)),this.audioExportResolve=null,this.audioExportReject=null)}play(A){g.audioCtx||g.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:w.MsgTypes.PLAY,mml:A})}stop(){this.worker.postMessage({type:w.MsgTypes.STOP})}pause(){this.worker.postMessage({type:w.MsgTypes.PAUSE})}exportWav(A){return this.exportAudio(A,"wav")}exportMp3(A,M){return this.exportAudio(A,"mp3",{bitrate:M})}setMasterVolume(A){this.volume=A,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(A){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:A})}syncInfo(){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:null})}addEventListener(A,M){let b=this.events[A];b||(b=this.events[A]=[]);for(let R=b.length;R--;)if(b[R]===M)return!1;return b.push(M),!0}removeEventListener(A,M){const b=this.events[A];if(!b)return!1;for(let R=b.length;R--;)if(b[R]===M)return b.splice(R,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}y.FlMML=g,y.FlMMLonHTML5=g}).apply(i,h))===void 0||(t.exports=u)},158:(t,i,m)=>{m.r(i),m.d(i,{FlMMLWorkletScript:()=>h});const h='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},a={};function o(t){var i=a[t];if(i!==void 0)return i.exports;var m=a[t]={exports:{}};return r[t].call(m.exports,m,m.exports,o),m.exports}return o.d=(t,i)=>{for(var m in i)o.o(i,m)&&!o.o(t,m)&&Object.defineProperty(t,m,{enumerable:!0,get:i[m]})},o.o=(t,i)=>Object.prototype.hasOwnProperty.call(t,i),o.r=t=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o(643)})()})})(fr);var mr=fr.exports;function Tt(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var hr={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(r){n.exports=r()})(function(){return function r(a,o,t){function i(u,E){if(!o[u]){if(!a[u]){var f=typeof Tt=="function"&&Tt;if(!E&&f)return f(u,!0);if(m)return m(u,!0);var y=new Error("Cannot find module '"+u+"'");throw y.code="MODULE_NOT_FOUND",y}var w=o[u]={exports:{}};a[u][0].call(w.exports,function(D){var L=a[u][1][D];return i(L||D)},w,w.exports,r,a,o,t)}return o[u].exports}for(var m=typeof Tt=="function"&&Tt,h=0;h<t.length;h++)i(t[h]);return i}({1:[function(r,a,o){(function(t){var i=t.MutationObserver||t.WebKitMutationObserver,m;if(i){var h=0,u=new i(D),E=t.document.createTextNode("");u.observe(E,{characterData:!0}),m=function(){E.data=h=++h%2}}else if(!t.setImmediate&&typeof t.MessageChannel<"u"){var f=new t.MessageChannel;f.port1.onmessage=D,m=function(){f.port2.postMessage(0)}}else"document"in t&&"onreadystatechange"in t.document.createElement("script")?m=function(){var l=t.document.createElement("script");l.onreadystatechange=function(){D(),l.onreadystatechange=null,l.parentNode.removeChild(l),l=null},t.document.documentElement.appendChild(l)}:m=function(){setTimeout(D,0)};var y,w=[];function D(){y=!0;for(var l,g,O=w.length;O;){for(g=w,w=[],l=-1;++l<O;)g[l]();O=w.length}y=!1}a.exports=L;function L(l){w.push(l)===1&&!y&&m()}}).call(this,typeof dt<"u"?dt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,a,o){var t=r(1);function i(){}var m={},h=["REJECTED"],u=["FULFILLED"],E=["PENDING"];a.exports=f;function f(b){if(typeof b!="function")throw new TypeError("resolver must be a function");this.state=E,this.queue=[],this.outcome=void 0,b!==i&&L(this,b)}f.prototype.catch=function(b){return this.then(null,b)},f.prototype.then=function(b,R){if(typeof b!="function"&&this.state===u||typeof R!="function"&&this.state===h)return this;var U=new this.constructor(i);if(this.state!==E){var G=this.state===u?b:R;w(U,G,this.outcome)}else this.queue.push(new y(U,b,R));return U};function y(b,R,U){this.promise=b,typeof R=="function"&&(this.onFulfilled=R,this.callFulfilled=this.otherCallFulfilled),typeof U=="function"&&(this.onRejected=U,this.callRejected=this.otherCallRejected)}y.prototype.callFulfilled=function(b){m.resolve(this.promise,b)},y.prototype.otherCallFulfilled=function(b){w(this.promise,this.onFulfilled,b)},y.prototype.callRejected=function(b){m.reject(this.promise,b)},y.prototype.otherCallRejected=function(b){w(this.promise,this.onRejected,b)};function w(b,R,U){t(function(){var G;try{G=R(U)}catch(le){return m.reject(b,le)}G===b?m.reject(b,new TypeError("Cannot resolve promise with itself")):m.resolve(b,G)})}m.resolve=function(b,R){var U=l(D,R);if(U.status==="error")return m.reject(b,U.value);var G=U.value;if(G)L(b,G);else{b.state=u,b.outcome=R;for(var le=-1,oe=b.queue.length;++le<oe;)b.queue[le].callFulfilled(R)}return b},m.reject=function(b,R){b.state=h,b.outcome=R;for(var U=-1,G=b.queue.length;++U<G;)b.queue[U].callRejected(R);return b};function D(b){var R=b&&b.then;if(b&&(typeof b=="object"||typeof b=="function")&&typeof R=="function")return function(){R.apply(b,arguments)}}function L(b,R){var U=!1;function G(ge){U||(U=!0,m.reject(b,ge))}function le(ge){U||(U=!0,m.resolve(b,ge))}function oe(){R(le,G)}var me=l(oe);me.status==="error"&&G(me.value)}function l(b,R){var U={};try{U.value=b(R),U.status="success"}catch(G){U.status="error",U.value=G}return U}f.resolve=g;function g(b){return b instanceof this?b:m.resolve(new this(i),b)}f.reject=O;function O(b){var R=new this(i);return m.reject(R,b)}f.all=A;function A(b){var R=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var U=b.length,G=!1;if(!U)return this.resolve([]);for(var le=new Array(U),oe=0,me=-1,ge=new this(i);++me<U;)fe(b[me],me);return ge;function fe(N,k){R.resolve(N).then(V,function(q){G||(G=!0,m.reject(ge,q))});function V(q){le[k]=q,++oe===U&&!G&&(G=!0,m.resolve(ge,le))}}}f.race=M;function M(b){var R=this;if(Object.prototype.toString.call(b)!=="[object Array]")return this.reject(new TypeError("must be an array"));var U=b.length,G=!1;if(!U)return this.resolve([]);for(var le=-1,oe=new this(i);++le<U;)me(b[le]);return oe;function me(ge){R.resolve(ge).then(function(fe){G||(G=!0,m.resolve(oe,fe))},function(fe){G||(G=!0,m.reject(oe,fe))})}}},{1:1}],3:[function(r,a,o){(function(t){typeof t.Promise!="function"&&(t.Promise=r(2))}).call(this,typeof dt<"u"?dt:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,a,o){var t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s};function i(s,d){if(!(s instanceof d))throw new TypeError("Cannot call a class as a function")}function m(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var h=m();function u(){try{if(!h||!h.open)return!1;var s=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),d=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!s||d)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function E(s,d){s=s||[],d=d||{};try{return new Blob(s,d)}catch(p){if(p.name!=="TypeError")throw p;for(var c=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,v=new c,S=0;S<s.length;S+=1)v.append(s[S]);return v.getBlob(d.type)}}typeof Promise>"u"&&r(3);var f=Promise;function y(s,d){d&&s.then(function(c){d(null,c)},function(c){d(c)})}function w(s,d,c){typeof d=="function"&&s.then(d),typeof c=="function"&&s.catch(c)}function D(s){return typeof s!="string"&&(console.warn(s+" used as a key, but it is not a string."),s=String(s)),s}function L(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var l="local-forage-detect-blob-support",g=void 0,O={},A=Object.prototype.toString,M="readonly",b="readwrite";function R(s){for(var d=s.length,c=new ArrayBuffer(d),v=new Uint8Array(c),S=0;S<d;S++)v[S]=s.charCodeAt(S);return c}function U(s){return new f(function(d){var c=s.transaction(l,b),v=E([""]);c.objectStore(l).put(v,"key"),c.onabort=function(S){S.preventDefault(),S.stopPropagation(),d(!1)},c.oncomplete=function(){var S=navigator.userAgent.match(/Chrome\/(\d+)/),p=navigator.userAgent.match(/Edge\//);d(p||!S||parseInt(S[1],10)>=43)}}).catch(function(){return!1})}function G(s){return typeof g=="boolean"?f.resolve(g):U(s).then(function(d){return g=d,g})}function le(s){var d=O[s.name],c={};c.promise=new f(function(v,S){c.resolve=v,c.reject=S}),d.deferredOperations.push(c),d.dbReady?d.dbReady=d.dbReady.then(function(){return c.promise}):d.dbReady=c.promise}function oe(s){var d=O[s.name],c=d.deferredOperations.pop();if(c)return c.resolve(),c.promise}function me(s,d){var c=O[s.name],v=c.deferredOperations.pop();if(v)return v.reject(d),v.promise}function ge(s,d){return new f(function(c,v){if(O[s.name]=O[s.name]||J(),s.db)if(d)le(s),s.db.close();else return c(s.db);var S=[s.name];d&&S.push(s.version);var p=h.open.apply(h,S);d&&(p.onupgradeneeded=function(I){var _=p.result;try{_.createObjectStore(s.storeName),I.oldVersion<=1&&_.createObjectStore(l)}catch(P){if(P.name==="ConstraintError")console.warn('The database "'+s.name+'" has been upgraded from version '+I.oldVersion+" to version "+I.newVersion+', but the storage "'+s.storeName+'" already exists.');else throw P}}),p.onerror=function(I){I.preventDefault(),v(p.error)},p.onsuccess=function(){var I=p.result;I.onversionchange=function(_){_.target.close()},c(I),oe(s)}})}function fe(s){return ge(s,!1)}function N(s){return ge(s,!0)}function k(s,d){if(!s.db)return!0;var c=!s.db.objectStoreNames.contains(s.storeName),v=s.version<s.db.version,S=s.version>s.db.version;if(v&&(s.version!==d&&console.warn('The database "'+s.name+`" can't be downgraded from version `+s.db.version+" to version "+s.version+"."),s.version=s.db.version),S||c){if(c){var p=s.db.version+1;p>s.version&&(s.version=p)}return!0}return!1}function V(s){return new f(function(d,c){var v=new FileReader;v.onerror=c,v.onloadend=function(S){var p=btoa(S.target.result||"");d({__local_forage_encoded_blob:!0,data:p,type:s.type})},v.readAsBinaryString(s)})}function q(s){var d=R(atob(s.data));return E([d],{type:s.type})}function W(s){return s&&s.__local_forage_encoded_blob}function X(s){var d=this,c=d._initReady().then(function(){var v=O[d._dbInfo.name];if(v&&v.dbReady)return v.dbReady});return w(c,s,s),c}function B(s){le(s);for(var d=O[s.name],c=d.forages,v=0;v<c.length;v++){var S=c[v];S._dbInfo.db&&(S._dbInfo.db.close(),S._dbInfo.db=null)}return s.db=null,fe(s).then(function(p){return s.db=p,k(s)?N(s):p}).then(function(p){s.db=d.db=p;for(var I=0;I<c.length;I++)c[I]._dbInfo.db=p}).catch(function(p){throw me(s,p),p})}function te(s,d,c,v){v===void 0&&(v=1);try{var S=s.db.transaction(s.storeName,d);c(null,S)}catch(p){if(v>0&&(!s.db||p.name==="InvalidStateError"||p.name==="NotFoundError"))return f.resolve().then(function(){if(!s.db||p.name==="NotFoundError"&&!s.db.objectStoreNames.contains(s.storeName)&&s.version<=s.db.version)return s.db&&(s.version=s.db.version+1),N(s)}).then(function(){return B(s).then(function(){te(s,d,c,v-1)})}).catch(c);c(p)}}function J(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function he(s){var d=this,c={db:null};if(s)for(var v in s)c[v]=s[v];var S=O[c.name];S||(S=J(),O[c.name]=S),S.forages.push(d),d._initReady||(d._initReady=d.ready,d.ready=X);var p=[];function I(){return f.resolve()}for(var _=0;_<S.forages.length;_++){var P=S.forages[_];P!==d&&p.push(P._initReady().catch(I))}var j=S.forages.slice(0);return f.all(p).then(function(){return c.db=S.db,fe(c)}).then(function($){return c.db=$,k(c,d._defaultConfig.version)?N(c):$}).then(function($){c.db=S.db=$,d._dbInfo=c;for(var z=0;z<j.length;z++){var ee=j[z];ee!==d&&(ee._dbInfo.db=c.db,ee._dbInfo.version=c.version)}})}function Te(s,d){var c=this;s=D(s);var v=new f(function(S,p){c.ready().then(function(){te(c._dbInfo,M,function(I,_){if(I)return p(I);try{var P=_.objectStore(c._dbInfo.storeName),j=P.get(s);j.onsuccess=function(){var $=j.result;$===void 0&&($=null),W($)&&($=q($)),S($)},j.onerror=function(){p(j.error)}}catch($){p($)}})}).catch(p)});return y(v,d),v}function Ne(s,d){var c=this,v=new f(function(S,p){c.ready().then(function(){te(c._dbInfo,M,function(I,_){if(I)return p(I);try{var P=_.objectStore(c._dbInfo.storeName),j=P.openCursor(),$=1;j.onsuccess=function(){var z=j.result;if(z){var ee=z.value;W(ee)&&(ee=q(ee));var se=s(ee,z.key,$++);se!==void 0?S(se):z.continue()}else S()},j.onerror=function(){p(j.error)}}catch(z){p(z)}})}).catch(p)});return y(v,d),v}function x(s,d,c){var v=this;s=D(s);var S=new f(function(p,I){var _;v.ready().then(function(){return _=v._dbInfo,A.call(d)==="[object Blob]"?G(_.db).then(function(P){return P?d:V(d)}):d}).then(function(P){te(v._dbInfo,b,function(j,$){if(j)return I(j);try{var z=$.objectStore(v._dbInfo.storeName);P===null&&(P=void 0);var ee=z.put(P,s);$.oncomplete=function(){P===void 0&&(P=null),p(P)},$.onabort=$.onerror=function(){var se=ee.error?ee.error:ee.transaction.error;I(se)}}catch(se){I(se)}})}).catch(I)});return y(S,c),S}function F(s,d){var c=this;s=D(s);var v=new f(function(S,p){c.ready().then(function(){te(c._dbInfo,b,function(I,_){if(I)return p(I);try{var P=_.objectStore(c._dbInfo.storeName),j=P.delete(s);_.oncomplete=function(){S()},_.onerror=function(){p(j.error)},_.onabort=function(){var $=j.error?j.error:j.transaction.error;p($)}}catch($){p($)}})}).catch(p)});return y(v,d),v}function H(s){var d=this,c=new f(function(v,S){d.ready().then(function(){te(d._dbInfo,b,function(p,I){if(p)return S(p);try{var _=I.objectStore(d._dbInfo.storeName),P=_.clear();I.oncomplete=function(){v()},I.onabort=I.onerror=function(){var j=P.error?P.error:P.transaction.error;S(j)}}catch(j){S(j)}})}).catch(S)});return y(c,s),c}function Y(s){var d=this,c=new f(function(v,S){d.ready().then(function(){te(d._dbInfo,M,function(p,I){if(p)return S(p);try{var _=I.objectStore(d._dbInfo.storeName),P=_.count();P.onsuccess=function(){v(P.result)},P.onerror=function(){S(P.error)}}catch(j){S(j)}})}).catch(S)});return y(c,s),c}function Z(s,d){var c=this,v=new f(function(S,p){if(s<0){S(null);return}c.ready().then(function(){te(c._dbInfo,M,function(I,_){if(I)return p(I);try{var P=_.objectStore(c._dbInfo.storeName),j=!1,$=P.openKeyCursor();$.onsuccess=function(){var z=$.result;if(!z){S(null);return}s===0||j?S(z.key):(j=!0,z.advance(s))},$.onerror=function(){p($.error)}}catch(z){p(z)}})}).catch(p)});return y(v,d),v}function ne(s){var d=this,c=new f(function(v,S){d.ready().then(function(){te(d._dbInfo,M,function(p,I){if(p)return S(p);try{var _=I.objectStore(d._dbInfo.storeName),P=_.openKeyCursor(),j=[];P.onsuccess=function(){var $=P.result;if(!$){v(j);return}j.push($.key),$.continue()},P.onerror=function(){S(P.error)}}catch($){S($)}})}).catch(S)});return y(c,s),c}function we(s,d){d=L.apply(this,arguments);var c=this.config();s=typeof s!="function"&&s||{},s.name||(s.name=s.name||c.name,s.storeName=s.storeName||c.storeName);var v=this,S;if(!s.name)S=f.reject("Invalid arguments");else{var p=s.name===c.name&&v._dbInfo.db,I=p?f.resolve(v._dbInfo.db):fe(s).then(function(_){var P=O[s.name],j=P.forages;P.db=_;for(var $=0;$<j.length;$++)j[$]._dbInfo.db=_;return _});s.storeName?S=I.then(function(_){if(_.objectStoreNames.contains(s.storeName)){var P=_.version+1;le(s);var j=O[s.name],$=j.forages;_.close();for(var z=0;z<$.length;z++){var ee=$[z];ee._dbInfo.db=null,ee._dbInfo.version=P}var se=new f(function(ie,ye){var pe=h.open(s.name,P);pe.onerror=function(Ie){var lt=pe.result;lt.close(),ye(Ie)},pe.onupgradeneeded=function(){var Ie=pe.result;Ie.deleteObjectStore(s.storeName)},pe.onsuccess=function(){var Ie=pe.result;Ie.close(),ie(Ie)}});return se.then(function(ie){j.db=ie;for(var ye=0;ye<$.length;ye++){var pe=$[ye];pe._dbInfo.db=ie,oe(pe._dbInfo)}}).catch(function(ie){throw(me(s,ie)||f.resolve()).catch(function(){}),ie})}}):S=I.then(function(_){le(s);var P=O[s.name],j=P.forages;_.close();for(var $=0;$<j.length;$++){var z=j[$];z._dbInfo.db=null}var ee=new f(function(se,ie){var ye=h.deleteDatabase(s.name);ye.onerror=function(){var pe=ye.result;pe&&pe.close(),ie(ye.error)},ye.onblocked=function(){console.warn('dropInstance blocked for database "'+s.name+'" until all open connections are closed')},ye.onsuccess=function(){var pe=ye.result;pe&&pe.close(),se(pe)}});return ee.then(function(se){P.db=se;for(var ie=0;ie<j.length;ie++){var ye=j[ie];oe(ye._dbInfo)}}).catch(function(se){throw(me(s,se)||f.resolve()).catch(function(){}),se})})}return y(S,d),S}var Qe={_driver:"asyncStorage",_initStorage:he,_support:u(),iterate:Ne,getItem:Te,setItem:x,removeItem:F,clear:H,length:Y,key:Z,keys:ne,dropInstance:we};function Fr(){return typeof openDatabase=="function"}var $e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",$r="~~local_forage_type~",Bn=/^~~local_forage_type~([^~]+)~/,St="__lfsc__:",Xt=St.length,Qt="arbf",Zt="blob",Rn="si08",Fn="ui08",$n="uic8",Un="si16",Vn="si32",Wn="ur16",zn="ui32",Hn="fl32",qn="fl64",Yn=Xt+Qt.length,Gn=Object.prototype.toString;function Kn(s){var d=s.length*.75,c=s.length,v,S=0,p,I,_,P;s[s.length-1]==="="&&(d--,s[s.length-2]==="="&&d--);var j=new ArrayBuffer(d),$=new Uint8Array(j);for(v=0;v<c;v+=4)p=$e.indexOf(s[v]),I=$e.indexOf(s[v+1]),_=$e.indexOf(s[v+2]),P=$e.indexOf(s[v+3]),$[S++]=p<<2|I>>4,$[S++]=(I&15)<<4|_>>2,$[S++]=(_&3)<<6|P&63;return j}function en(s){var d=new Uint8Array(s),c="",v;for(v=0;v<d.length;v+=3)c+=$e[d[v]>>2],c+=$e[(d[v]&3)<<4|d[v+1]>>4],c+=$e[(d[v+1]&15)<<2|d[v+2]>>6],c+=$e[d[v+2]&63];return d.length%3===2?c=c.substring(0,c.length-1)+"=":d.length%3===1&&(c=c.substring(0,c.length-2)+"=="),c}function Ur(s,d){var c="";if(s&&(c=Gn.call(s)),s&&(c==="[object ArrayBuffer]"||s.buffer&&Gn.call(s.buffer)==="[object ArrayBuffer]")){var v,S=St;s instanceof ArrayBuffer?(v=s,S+=Qt):(v=s.buffer,c==="[object Int8Array]"?S+=Rn:c==="[object Uint8Array]"?S+=Fn:c==="[object Uint8ClampedArray]"?S+=$n:c==="[object Int16Array]"?S+=Un:c==="[object Uint16Array]"?S+=Wn:c==="[object Int32Array]"?S+=Vn:c==="[object Uint32Array]"?S+=zn:c==="[object Float32Array]"?S+=Hn:c==="[object Float64Array]"?S+=qn:d(new Error("Failed to get type for BinaryArray"))),d(S+en(v))}else if(c==="[object Blob]"){var p=new FileReader;p.onload=function(){var I=$r+s.type+"~"+en(this.result);d(St+Zt+I)},p.readAsArrayBuffer(s)}else try{d(JSON.stringify(s))}catch(I){console.error("Couldn't convert value into a JSON string: ",s),d(null,I)}}function Vr(s){if(s.substring(0,Xt)!==St)return JSON.parse(s);var d=s.substring(Yn),c=s.substring(Xt,Yn),v;if(c===Zt&&Bn.test(d)){var S=d.match(Bn);v=S[1],d=d.substring(S[0].length)}var p=Kn(d);switch(c){case Qt:return p;case Zt:return E([p],{type:v});case Rn:return new Int8Array(p);case Fn:return new Uint8Array(p);case $n:return new Uint8ClampedArray(p);case Un:return new Int16Array(p);case Wn:return new Uint16Array(p);case Vn:return new Int32Array(p);case zn:return new Uint32Array(p);case Hn:return new Float32Array(p);case qn:return new Float64Array(p);default:throw new Error("Unkown type: "+c)}}var tn={serialize:Ur,deserialize:Vr,stringToBuffer:Kn,bufferToString:en};function Jn(s,d,c,v){s.executeSql("CREATE TABLE IF NOT EXISTS "+d.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],c,v)}function Wr(s){var d=this,c={db:null};if(s)for(var v in s)c[v]=typeof s[v]!="string"?s[v].toString():s[v];var S=new f(function(p,I){try{c.db=openDatabase(c.name,String(c.version),c.description,c.size)}catch(_){return I(_)}c.db.transaction(function(_){Jn(_,c,function(){d._dbInfo=c,p()},function(P,j){I(j)})},I)});return c.serializer=tn,S}function Ue(s,d,c,v,S,p){s.executeSql(c,v,S,function(I,_){_.code===_.SYNTAX_ERR?I.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[d.storeName],function(P,j){j.rows.length?p(P,_):Jn(P,d,function(){P.executeSql(c,v,S,p)},p)},p):p(I,_)},p)}function zr(s,d){var c=this;s=D(s);var v=new f(function(S,p){c.ready().then(function(){var I=c._dbInfo;I.db.transaction(function(_){Ue(_,I,"SELECT * FROM "+I.storeName+" WHERE key = ? LIMIT 1",[s],function(P,j){var $=j.rows.length?j.rows.item(0).value:null;$&&($=I.serializer.deserialize($)),S($)},function(P,j){p(j)})})}).catch(p)});return y(v,d),v}function Hr(s,d){var c=this,v=new f(function(S,p){c.ready().then(function(){var I=c._dbInfo;I.db.transaction(function(_){Ue(_,I,"SELECT * FROM "+I.storeName,[],function(P,j){for(var $=j.rows,z=$.length,ee=0;ee<z;ee++){var se=$.item(ee),ie=se.value;if(ie&&(ie=I.serializer.deserialize(ie)),ie=s(ie,se.key,ee+1),ie!==void 0){S(ie);return}}S()},function(P,j){p(j)})})}).catch(p)});return y(v,d),v}function Xn(s,d,c,v){var S=this;s=D(s);var p=new f(function(I,_){S.ready().then(function(){d===void 0&&(d=null);var P=d,j=S._dbInfo;j.serializer.serialize(d,function($,z){z?_(z):j.db.transaction(function(ee){Ue(ee,j,"INSERT OR REPLACE INTO "+j.storeName+" (key, value) VALUES (?, ?)",[s,$],function(){I(P)},function(se,ie){_(ie)})},function(ee){if(ee.code===ee.QUOTA_ERR){if(v>0){I(Xn.apply(S,[s,P,c,v-1]));return}_(ee)}})})}).catch(_)});return y(p,c),p}function qr(s,d,c){return Xn.apply(this,[s,d,c,1])}function Yr(s,d){var c=this;s=D(s);var v=new f(function(S,p){c.ready().then(function(){var I=c._dbInfo;I.db.transaction(function(_){Ue(_,I,"DELETE FROM "+I.storeName+" WHERE key = ?",[s],function(){S()},function(P,j){p(j)})})}).catch(p)});return y(v,d),v}function Gr(s){var d=this,c=new f(function(v,S){d.ready().then(function(){var p=d._dbInfo;p.db.transaction(function(I){Ue(I,p,"DELETE FROM "+p.storeName,[],function(){v()},function(_,P){S(P)})})}).catch(S)});return y(c,s),c}function Kr(s){var d=this,c=new f(function(v,S){d.ready().then(function(){var p=d._dbInfo;p.db.transaction(function(I){Ue(I,p,"SELECT COUNT(key) as c FROM "+p.storeName,[],function(_,P){var j=P.rows.item(0).c;v(j)},function(_,P){S(P)})})}).catch(S)});return y(c,s),c}function Jr(s,d){var c=this,v=new f(function(S,p){c.ready().then(function(){var I=c._dbInfo;I.db.transaction(function(_){Ue(_,I,"SELECT key FROM "+I.storeName+" WHERE id = ? LIMIT 1",[s+1],function(P,j){var $=j.rows.length?j.rows.item(0).key:null;S($)},function(P,j){p(j)})})}).catch(p)});return y(v,d),v}function Xr(s){var d=this,c=new f(function(v,S){d.ready().then(function(){var p=d._dbInfo;p.db.transaction(function(I){Ue(I,p,"SELECT key FROM "+p.storeName,[],function(_,P){for(var j=[],$=0;$<P.rows.length;$++)j.push(P.rows.item($).key);v(j)},function(_,P){S(P)})})}).catch(S)});return y(c,s),c}function Qr(s){return new f(function(d,c){s.transaction(function(v){v.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(S,p){for(var I=[],_=0;_<p.rows.length;_++)I.push(p.rows.item(_).name);d({db:s,storeNames:I})},function(S,p){c(p)})},function(v){c(v)})})}function Zr(s,d){d=L.apply(this,arguments);var c=this.config();s=typeof s!="function"&&s||{},s.name||(s.name=s.name||c.name,s.storeName=s.storeName||c.storeName);var v=this,S;return s.name?S=new f(function(p){var I;s.name===c.name?I=v._dbInfo.db:I=openDatabase(s.name,"","",0),s.storeName?p({db:I,storeNames:[s.storeName]}):p(Qr(I))}).then(function(p){return new f(function(I,_){p.db.transaction(function(P){function j(se){return new f(function(ie,ye){P.executeSql("DROP TABLE IF EXISTS "+se,[],function(){ie()},function(pe,Ie){ye(Ie)})})}for(var $=[],z=0,ee=p.storeNames.length;z<ee;z++)$.push(j(p.storeNames[z]));f.all($).then(function(){I()}).catch(function(se){_(se)})},function(P){_(P)})})}):S=f.reject("Invalid arguments"),y(S,d),S}var ea={_driver:"webSQLStorage",_initStorage:Wr,_support:Fr(),iterate:Hr,getItem:zr,setItem:qr,removeItem:Yr,clear:Gr,length:Kr,key:Jr,keys:Xr,dropInstance:Zr};function ta(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function Qn(s,d){var c=s.name+"/";return s.storeName!==d.storeName&&(c+=s.storeName+"/"),c}function na(){var s="_localforage_support_test";try{return localStorage.setItem(s,!0),localStorage.removeItem(s),!1}catch{return!0}}function ra(){return!na()||localStorage.length>0}function aa(s){var d=this,c={};if(s)for(var v in s)c[v]=s[v];return c.keyPrefix=Qn(s,d._defaultConfig),ra()?(d._dbInfo=c,c.serializer=tn,f.resolve()):f.reject()}function oa(s){var d=this,c=d.ready().then(function(){for(var v=d._dbInfo.keyPrefix,S=localStorage.length-1;S>=0;S--){var p=localStorage.key(S);p.indexOf(v)===0&&localStorage.removeItem(p)}});return y(c,s),c}function sa(s,d){var c=this;s=D(s);var v=c.ready().then(function(){var S=c._dbInfo,p=localStorage.getItem(S.keyPrefix+s);return p&&(p=S.serializer.deserialize(p)),p});return y(v,d),v}function ia(s,d){var c=this,v=c.ready().then(function(){for(var S=c._dbInfo,p=S.keyPrefix,I=p.length,_=localStorage.length,P=1,j=0;j<_;j++){var $=localStorage.key(j);if($.indexOf(p)===0){var z=localStorage.getItem($);if(z&&(z=S.serializer.deserialize(z)),z=s(z,$.substring(I),P++),z!==void 0)return z}}});return y(v,d),v}function ca(s,d){var c=this,v=c.ready().then(function(){var S=c._dbInfo,p;try{p=localStorage.key(s)}catch{p=null}return p&&(p=p.substring(S.keyPrefix.length)),p});return y(v,d),v}function la(s){var d=this,c=d.ready().then(function(){for(var v=d._dbInfo,S=localStorage.length,p=[],I=0;I<S;I++){var _=localStorage.key(I);_.indexOf(v.keyPrefix)===0&&p.push(_.substring(v.keyPrefix.length))}return p});return y(c,s),c}function ua(s){var d=this,c=d.keys().then(function(v){return v.length});return y(c,s),c}function da(s,d){var c=this;s=D(s);var v=c.ready().then(function(){var S=c._dbInfo;localStorage.removeItem(S.keyPrefix+s)});return y(v,d),v}function fa(s,d,c){var v=this;s=D(s);var S=v.ready().then(function(){d===void 0&&(d=null);var p=d;return new f(function(I,_){var P=v._dbInfo;P.serializer.serialize(d,function(j,$){if($)_($);else try{localStorage.setItem(P.keyPrefix+s,j),I(p)}catch(z){(z.name==="QuotaExceededError"||z.name==="NS_ERROR_DOM_QUOTA_REACHED")&&_(z),_(z)}})})});return y(S,c),S}function ma(s,d){if(d=L.apply(this,arguments),s=typeof s!="function"&&s||{},!s.name){var c=this.config();s.name=s.name||c.name,s.storeName=s.storeName||c.storeName}var v=this,S;return s.name?S=new f(function(p){s.storeName?p(Qn(s,v._defaultConfig)):p(s.name+"/")}).then(function(p){for(var I=localStorage.length-1;I>=0;I--){var _=localStorage.key(I);_.indexOf(p)===0&&localStorage.removeItem(_)}}):S=f.reject("Invalid arguments"),y(S,d),S}var ha={_driver:"localStorageWrapper",_initStorage:aa,_support:ta(),iterate:ia,getItem:sa,setItem:fa,removeItem:da,clear:oa,length:ua,key:ca,keys:la,dropInstance:ma},pa=function(d,c){return d===c||typeof d=="number"&&typeof c=="number"&&isNaN(d)&&isNaN(c)},va=function(d,c){for(var v=d.length,S=0;S<v;){if(pa(d[S],c))return!0;S++}return!1},Zn=Array.isArray||function(s){return Object.prototype.toString.call(s)==="[object Array]"},ct={},er={},Ze={INDEXEDDB:Qe,WEBSQL:ea,LOCALSTORAGE:ha},ga=[Ze.INDEXEDDB._driver,Ze.WEBSQL._driver,Ze.LOCALSTORAGE._driver],wt=["dropInstance"],nn=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(wt),ya={description:"",driver:ga.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function ba(s,d){s[d]=function(){var c=arguments;return s.ready().then(function(){return s[d].apply(s,c)})}}function rn(){for(var s=1;s<arguments.length;s++){var d=arguments[s];if(d)for(var c in d)d.hasOwnProperty(c)&&(Zn(d[c])?arguments[0][c]=d[c].slice():arguments[0][c]=d[c])}return arguments[0]}var Ea=function(){function s(d){i(this,s);for(var c in Ze)if(Ze.hasOwnProperty(c)){var v=Ze[c],S=v._driver;this[c]=S,ct[S]||this.defineDriver(v)}this._defaultConfig=rn({},ya),this._config=rn({},this._defaultConfig,d),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return s.prototype.config=function(c){if((typeof c>"u"?"undefined":t(c))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var v in c){if(v==="storeName"&&(c[v]=c[v].replace(/\W/g,"_")),v==="version"&&typeof c[v]!="number")return new Error("Database version must be a number.");this._config[v]=c[v]}return"driver"in c&&c.driver?this.setDriver(this._config.driver):!0}else return typeof c=="string"?this._config[c]:this._config},s.prototype.defineDriver=function(c,v,S){var p=new f(function(I,_){try{var P=c._driver,j=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!c._driver){_(j);return}for(var $=nn.concat("_initStorage"),z=0,ee=$.length;z<ee;z++){var se=$[z],ie=!va(wt,se);if((ie||c[se])&&typeof c[se]!="function"){_(j);return}}var ye=function(){for(var lt=function(Ta){return function(){var xa=new Error("Method "+Ta+" is not implemented by the current driver"),tr=f.reject(xa);return y(tr,arguments[arguments.length-1]),tr}},an=0,wa=wt.length;an<wa;an++){var on=wt[an];c[on]||(c[on]=lt(on))}};ye();var pe=function(lt){ct[P]&&console.info("Redefining LocalForage driver: "+P),ct[P]=c,er[P]=lt,I()};"_support"in c?c._support&&typeof c._support=="function"?c._support().then(pe,_):pe(!!c._support):pe(!0)}catch(Ie){_(Ie)}});return w(p,v,S),p},s.prototype.driver=function(){return this._driver||null},s.prototype.getDriver=function(c,v,S){var p=ct[c]?f.resolve(ct[c]):f.reject(new Error("Driver not found."));return w(p,v,S),p},s.prototype.getSerializer=function(c){var v=f.resolve(tn);return w(v,c),v},s.prototype.ready=function(c){var v=this,S=v._driverSet.then(function(){return v._ready===null&&(v._ready=v._initDriver()),v._ready});return w(S,c,c),S},s.prototype.setDriver=function(c,v,S){var p=this;Zn(c)||(c=[c]);var I=this._getSupportedDrivers(c);function _(){p._config.driver=p.driver()}function P(z){return p._extend(z),_(),p._ready=p._initStorage(p._config),p._ready}function j(z){return function(){var ee=0;function se(){for(;ee<z.length;){var ie=z[ee];return ee++,p._dbInfo=null,p._ready=null,p.getDriver(ie).then(P).catch(se)}_();var ye=new Error("No available storage method found.");return p._driverSet=f.reject(ye),p._driverSet}return se()}}var $=this._driverSet!==null?this._driverSet.catch(function(){return f.resolve()}):f.resolve();return this._driverSet=$.then(function(){var z=I[0];return p._dbInfo=null,p._ready=null,p.getDriver(z).then(function(ee){p._driver=ee._driver,_(),p._wrapLibraryMethodsWithReady(),p._initDriver=j(I)})}).catch(function(){_();var z=new Error("No available storage method found.");return p._driverSet=f.reject(z),p._driverSet}),w(this._driverSet,v,S),this._driverSet},s.prototype.supports=function(c){return!!er[c]},s.prototype._extend=function(c){rn(this,c)},s.prototype._getSupportedDrivers=function(c){for(var v=[],S=0,p=c.length;S<p;S++){var I=c[S];this.supports(I)&&v.push(I)}return v},s.prototype._wrapLibraryMethodsWithReady=function(){for(var c=0,v=nn.length;c<v;c++)ba(this,nn[c])},s.prototype.createInstance=function(c){return new s(c)},s}(),Sa=new Ea;a.exports=Sa},{3:3}]},{},[4])(4)})})(hr);var Ia=hr.exports;const gn=Na(Ia);function xt(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function ln(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const Ca=1,Da=1,Xe="emoji",ot="keyvalue",Mn="favorites",Ma="tokens",pr="tokens",Aa="unicode",vr="count",La="group",_a="order",gr="group-order",yn="eTag",At="url",nr="skinTone",it="readonly",An="readwrite",yr="skinUnicodes",Oa="skinUnicodes",Pa="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",ja="en";function Ba(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function rr(n){return Ba(n,e=>e.unicode)}function Ra(n){function e(r,a,o){const t=a?n.createObjectStore(r,{keyPath:a}):n.createObjectStore(r);if(o)for(const[i,[m,h]]of Object.entries(o))t.createIndex(i,m,{multiEntry:h});return t}e(ot),e(Xe,Aa,{[pr]:[Ma,!0],[gr]:[[La,_a]],[yr]:[Oa,!0]}),e(Mn,void 0,{[vr]:[""]})}const bn={},Ct={},Lt={};function br(n,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>n(r.result)}async function Fa(n){const e=await new Promise((r,a)=>{const o=indexedDB.open(n,Ca);bn[n]=o,o.onupgradeneeded=t=>{t.oldVersion<Da&&Ra(o.result)},br(r,a,o)});return e.onclose=()=>Ln(n),e}function $a(n){return Ct[n]||(Ct[n]=Fa(n)),Ct[n]}function Fe(n,e,r,a){return new Promise((o,t)=>{const i=n.transaction(e,r,{durability:"relaxed"}),m=typeof e=="string"?i.objectStore(e):e.map(u=>i.objectStore(u));let h;a(m,i,u=>{h=u}),i.oncomplete=()=>o(h),i.onerror=()=>t(i.error)})}function Ln(n){const e=bn[n],r=e&&e.result;if(r){r.close();const a=Lt[n];if(a)for(const o of a)o()}delete bn[n],delete Ct[n],delete Lt[n]}function Ua(n){return new Promise((e,r)=>{Ln(n);const a=indexedDB.deleteDatabase(n);br(e,r,a)})}function Va(n,e){let r=Lt[n];r||(r=Lt[n]=[]),r.push(e)}const Wa=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function et(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||Wa.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const za=2;function Er(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=za)}function Ha(n){return n.map(({annotation:r,emoticon:a,group:o,order:t,shortcodes:i,skins:m,tags:h,emoji:u,version:E})=>{const f=[...new Set(Er([...(i||[]).map(et).flat(),...h.map(et).flat(),...et(r),a]))].sort(),y={annotation:r,group:o,order:t,tags:h,tokens:f,unicode:u,version:E};if(a&&(y.emoticon=a),i&&(y.shortcodes=i),m){y.skinTones=[],y.skinUnicodes=[],y.skinVersions=[];for(const{tone:w,emoji:D,version:L}of m)y.skinTones.push(w),y.skinUnicodes.push(D),y.skinVersions.push(L)}return y})}function Sr(n,e,r,a){n[e](r).onsuccess=o=>a&&a(o.target.result)}function Je(n,e,r){Sr(n,"get",e,r)}function wr(n,e,r){Sr(n,"getAll",e,r)}function _n(n){n.commit&&n.commit()}function qa(n,e){let r=n[0];for(let a=1;a<n.length;a++){const o=n[a];e(r)>e(o)&&(r=o)}return r}function Tr(n,e){const r=qa(n,o=>o.length),a=[];for(const o of r)n.some(t=>t.findIndex(i=>e(i)===e(o))===-1)||a.push(o);return a}async function Ya(n){return!await On(n,ot,At)}async function Ga(n,e,r){const[a,o]=await Promise.all([yn,At].map(t=>On(n,ot,t)));return a===r&&o===e}async function Ka(n,e){return Fe(n,Xe,it,(a,o,t)=>{let i;const m=()=>{a.getAll(i&&IDBKeyRange.lowerBound(i,!0),50).onsuccess=h=>{const u=h.target.result;for(const E of u)if(i=E.unicode,e(E))return t(E);if(u.length<50)return t();m()}};m()})}async function xr(n,e,r,a){try{const o=Ha(e);await Fe(n,[Xe,ot],An,([t,i],m)=>{let h,u,E=0;function f(){++E===2&&y()}function y(){if(!(h===a&&u===r)){t.clear();for(const w of o)t.put(w);i.put(a,yn),i.put(r,At),_n(m)}}Je(i,yn,w=>{h=w,f()}),Je(i,At,w=>{u=w,f()})})}finally{}}async function Ja(n,e){return Fe(n,Xe,it,(r,a,o)=>{const t=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);wr(r.index(gr),t,o)})}async function kr(n,e){const r=Er(et(e));return r.length?Fe(n,Xe,it,(a,o,t)=>{const i=[],m=()=>{i.length===r.length&&h()},h=()=>{const u=Tr(i,E=>E.unicode);t(u.sort((E,f)=>E.order<f.order?-1:1))};for(let u=0;u<r.length;u++){const E=r[u],f=u===r.length-1?IDBKeyRange.bound(E,E+"￿",!1,!0):IDBKeyRange.only(E);wr(a.index(pr),f,y=>{i.push(y),m()})}}):[]}async function Xa(n,e){const r=await kr(n,e);return r.length?r.filter(a=>(a.shortcodes||[]).map(t=>t.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Ka(n,o=>(o.shortcodes||[]).includes(e.toLowerCase()))||null}async function Qa(n,e){return Fe(n,Xe,it,(r,a,o)=>Je(r,e,t=>{if(t)return o(t);Je(r.index(yr),e,i=>o(i||null))}))}function On(n,e,r){return Fe(n,e,it,(a,o,t)=>Je(a,r,t))}function Za(n,e,r,a){return Fe(n,e,An,(o,t)=>{o.put(a,r),_n(t)})}function eo(n,e){return Fe(n,Mn,An,(r,a)=>Je(r,e,o=>{r.put((o||0)+1,e),_n(a)}))}function to(n,e,r){return r===0?[]:Fe(n,[Mn,Xe],it,([a,o],t,i)=>{const m=[];a.index(vr).openCursor(void 0,"prev").onsuccess=h=>{const u=h.target.result;if(!u)return i(m);function E(w){if(m.push(w),m.length===r)return i(m);u.continue()}const f=u.primaryKey,y=e.byName(f);if(y)return E(y);Je(o,f,w=>{if(w)return E(w);u.continue()})}})}const kt="";function no(n,e){const r=new Map;for(const o of n){const t=e(o);for(const i of t){let m=r;for(let u=0;u<i.length;u++){const E=i.charAt(u);let f=m.get(E);f||(f=new Map,m.set(E,f)),m=f}let h=m.get(kt);h||(h=[],m.set(kt,h)),h.push(o)}}return(o,t)=>{let i=r;for(let u=0;u<o.length;u++){const E=o.charAt(u),f=i.get(E);if(f)i=f;else return[]}if(t)return i.get(kt)||[];const m=[],h=[i];for(;h.length;){const E=[...h.shift().entries()].sort((f,y)=>f[0]<y[0]?-1:1);for(const[f,y]of E)f===kt?m.push(...y):h.push(y)}return m}}const ro=["name","url"];function ao(n){const e=n&&Array.isArray(n),r=e&&n.length&&(!n[0]||ro.some(a=>!(a in n[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function ar(n){ao(n);const e=(y,w)=>y.name.toLowerCase()<w.name.toLowerCase()?-1:1,r=n.sort(e),o=no(n,y=>[...new Set((y.shortcodes||[]).map(w=>et(w)).flat())]),t=y=>o(y,!0),i=y=>o(y,!1),m=y=>{const w=et(y),D=w.map((L,l)=>(l<w.length-1?t:i)(L));return Tr(D,L=>L.name).sort(e)},h=new Map,u=new Map;for(const y of n){u.set(y.name.toLowerCase(),y);for(const w of y.shortcodes||[])h.set(w.toLowerCase(),y)}return{all:r,search:m,byShortcode:y=>h.get(y.toLowerCase()),byName:y=>u.get(y.toLowerCase())}}const oo=typeof wrappedJSObject<"u";function ut(n){if(!n)return n;if(oo&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let r=0;r<e;r++)n.skins[r]={tone:n.skinTones[r],unicode:n.skinUnicodes[r],version:n.skinVersions[r]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function Nr(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const so=["annotation","emoji","group","order","tags","version"];function io(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||so.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function Ir(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function co(n){const e=await fetch(n,{method:"HEAD"});Ir(e,n);const r=e.headers.get("etag");return Nr(r),r}async function En(n){const e=await fetch(n);Ir(e,n);const r=e.headers.get("etag");Nr(r);const a=await e.json();return io(a),[r,a]}function lo(n){for(var e="",r=new Uint8Array(n),a=r.byteLength,o=-1;++o<a;)e+=String.fromCharCode(r[o]);return e}function uo(n){for(var e=n.length,r=new ArrayBuffer(e),a=new Uint8Array(r),o=-1;++o<e;)a[o]=n.charCodeAt(o);return r}async function Cr(n){const e=JSON.stringify(n);let r=uo(e);const a=await crypto.subtle.digest("SHA-1",r),o=lo(a);return btoa(o)}async function fo(n,e){let r,a=await co(e);if(!a){const o=await En(e);a=o[0],r=o[1],a||(a=await Cr(r))}await Ga(n,e,a)||(r||(r=(await En(e))[1]),await xr(n,r,e,a))}async function mo(n,e){let[r,a]=await En(e);r||(r=await Cr(a)),await xr(n,a,e,r)}class ho{constructor({dataSource:e=Pa,locale:r=ja,customEmoji:a=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=ar(a),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await $a(this._dbName);Va(this._dbName,this._clear);const r=this.dataSource;await Ya(e)?await mo(e,r):this._lazyUpdate=fo(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return ln(e),await this.ready(),rr(await Ja(this._db,e)).map(ut)}async getEmojiBySearchQuery(e){xt(e),await this.ready();const r=this._custom.search(e),a=rr(await kr(this._db,e)).map(ut);return[...r,...a]}async getEmojiByShortcode(e){xt(e),await this.ready();const r=this._custom.byShortcode(e);return r||ut(await Xa(this._db,e))}async getEmojiByUnicodeOrName(e){xt(e),await this.ready();const r=this._custom.byName(e);return r||ut(await Qa(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await On(this._db,ot,nr)||0}async setPreferredSkinTone(e){return ln(e),await this.ready(),Za(this._db,ot,nr,e)}async incrementFavoriteEmojiCount(e){return xt(e),await this.ready(),eo(this._db,e)}async getTopFavoriteEmoji(e){return ln(e),await this.ready(),(await to(this._db,this._custom,e)).map(ut)}set customEmoji(e){this._custom=ar(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await Ln(this._dbName)}async delete(){await this._shutdown(),await Ua(this._dbName)}}const Sn=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([n,e,r])=>({id:n,emoji:e,name:r})),un=Sn.slice(1),po=2,or=6,Dr=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function sr(n){return n.unicode.includes("‍")}const vo={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},go=1e3,yo="🖐️",bo=8,Eo=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],Mr='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',So=(n,e)=>n<e?-1:n>e?1:0,ir=(n,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const a=r.getContext("2d");return a.textBaseline="top",a.font=`100px ${Mr}`,a.fillStyle=e,a.scale(.01,.01),a.fillText(n,0,0),a.getImageData(0,0,1,1).data},wo=(n,e)=>{const r=[...n].join(","),a=[...e].join(",");return r===a&&!r.startsWith("0,0,0,")};function To(n){const e=ir(n,"#000"),r=ir(n,"#fff");return e&&r&&wo(e,r)}function xo(){const n=Object.entries(vo);try{for(const[e,r]of n)if(To(e))return r}catch{}finally{}return n[0][1]}let dn;const fn=()=>(dn||(dn=new Promise(n=>Dr(()=>n(xo())))),dn),wn=new Map,ko="️",No="\uD83C",Io="‍",Co=127995,Do=57339;function Mo(n,e){if(e===0)return n;const r=n.indexOf(Io);return r!==-1?n.substring(0,r)+String.fromCodePoint(Co+e-1)+n.substring(r):(n.endsWith(ko)&&(n=n.substring(0,n.length-1)),n+No+String.fromCodePoint(Do+e-1))}function _e(n){n.preventDefault(),n.stopPropagation()}function mn(n,e,r){return e+=n?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function Ar(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function Ao(n,e){const r=a=>{const o={};for(const t of a)typeof t.tone=="number"&&t.version<=e&&(o[t.tone]=t.unicode);return o};return n.map(({unicode:a,skins:o,shortcodes:t,url:i,name:m,category:h,annotation:u})=>({unicode:a,name:m,shortcodes:t,url:i,category:h,annotation:u,id:a||m,skins:o&&r(o)}))}const Dt=requestAnimationFrame;let Lo=typeof ResizeObserver=="function";function _o(n,e,r){let a;Lo?(a=new ResizeObserver(o=>r(o[0].contentRect.width)),a.observe(n)):Dt(()=>r(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{a&&a.disconnect()})}function cr(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let hn;function Oo(n,e,r){for(const a of n){const o=r(a),t=cr(o);typeof hn>"u"&&(hn=cr(e));const i=t/1.8<hn;wn.set(a.unicode,i)}}function Po(n){return Ar(n,e=>e)}function jo(n){n&&(n.scrollTop=0)}function mt(n,e,r){let a=n.get(e);return a||(a=r(),n.set(e,a)),a}function lr(n){return""+n}function Bo(n){const e=document.createElement("template");return e.innerHTML=n,e}const Ro=new WeakMap,Fo=new WeakMap,$o=Symbol("un-keyed"),Uo="replaceChildren"in Element.prototype;function Vo(n,e){Uo?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function Wo(n,e){let r=n.firstChild,a=0;for(;r;){if(e[a]!==r)return!0;r=r.nextSibling,a++}return a!==e.length}function zo(n,e){const{targetNode:r}=e;let{targetParentNode:a}=e,o=!1;a?o=Wo(a,n):(o=!0,e.targetNode=void 0,e.targetParentNode=a=r.parentNode),o&&Vo(a,n)}function Ho(n,e){for(const r of e){const{targetNode:a,currentExpression:o,binding:{expressionIndex:t,attributeName:i,attributeValuePre:m,attributeValuePost:h}}=r,u=n[t];if(o!==u)if(r.currentExpression=u,i)a.setAttribute(i,m+lr(u)+h);else{let E;Array.isArray(u)?zo(u,r):u instanceof Element?(E=u,a.replaceWith(E)):a.nodeValue=lr(u),E&&(r.targetNode=E)}}}function qo(n){let e="",r=!1,a=!1,o=-1;const t=new Map,i=[];for(let h=0,u=n.length;h<u;h++){const E=n[h];if(e+=E,h===u-1)break;for(let g=0;g<E.length;g++)switch(E.charAt(g)){case"<":{E.charAt(g+1)==="/"?i.pop():(r=!0,i.push(++o));break}case">":{r=!1,a=!1;break}case"=":{a=!0;break}}const f=i[i.length-1],y=mt(t,f,()=>[]);let w,D,L;if(a){const g=/(\S+)="?([^"=]*)$/.exec(E);w=g[1],D=g[2],L=/^[^">]*/.exec(n[h+1])[0]}const l={attributeName:w,attributeValuePre:D,attributeValuePost:L,expressionIndex:h};y.push(l),!r&&!a&&(e+=" ")}return{template:Bo(e),elementsToBindings:t}}function Yo(n,e){const r=[],a=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let o=n,t=-1;do{const i=e.get(++t);if(i)for(let m=0;m<i.length;m++){const h=i[m],u=h.attributeName?o:o.firstChild,E={binding:h,targetNode:u,targetParentNode:void 0,currentExpression:void 0};r.push(E)}}while(o=a.nextNode());return r}function Go(n){const{template:e,elementsToBindings:r}=mt(Ro,n,()=>qo(n)),a=e.cloneNode(!0).content.firstElementChild,o=Yo(a,r);return function(i){return Ho(i,o),a}}function Ko(n){const e=mt(Fo,n,()=>new Map);let r=$o;function a(t,...i){const m=mt(e,t,()=>new Map);return mt(m,r,()=>Go(t))(i)}function o(t,i,m){return t.map((h,u)=>{const E=r;r=m(h);try{return i(h,u)}finally{r=E}})}return{map:o,html:a}}function Jo(n,e,r,a,o,t,i,m){const{labelWithSkin:h,titleForEmoji:u,unicodeWithSkin:E}=r,{html:f,map:y}=Ko(e);function w(l,g,O){return y(l,(A,M)=>f`<button role="${g?"option":"menuitem"}" aria-selected="${e.searchMode?M===e.activeSearchItem:""}" aria-label="${h(A,e.currentSkinTone)}" title="${u(A)}" class="emoji ${g&&M===e.activeSearchItem?"active":""}" id="${`${O}-${A.id}`}">${A.unicode?E(A,e.currentSkinTone):f`<img class="custom-emoji" src="${A.url}" alt="" loading="lazy">`}</button>`,A=>`${O}-${A.id}`)}const L=f`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${y(e.skinTones,(l,g)=>f`<div id="skintone-${g}" class="emoji ${g===e.activeSkinTone?"active":""}" aria-selected="${g===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[g]}" aria-label="${e.i18n.skinTones[g]}">${l}</div>`,l=>l)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${y(e.groups,l=>f`<button role="tab" class="nav-button" aria-controls="tab-${l.id}" aria-label="${e.i18n.categories[l.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===l.id}" title="${e.i18n.categories[l.name]}" data-group-id="${l.id}"><div class="nav-emoji emoji">${l.emoji}</div></button>`,l=>l.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${y(e.currentEmojisWithCategories,(l,g)=>f`<div><div id="menu-label-${g}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:l.category?l.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${g}" id="${e.searchMode?"search-results":""}">${w(l.emojis,e.searchMode,"emo")}</div></div>`,l=>l.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${w(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(m){n.appendChild(L);const l=(g,O)=>{for(const A of n.querySelectorAll(`[${g}]`))O(A,A.getAttribute(g))};for(const g of["click","focusout","input","keydown","keyup"])l(`data-on-${g}`,(O,A)=>{O.addEventListener(g,a[A])});l("data-ref",(g,O)=>{t[O]=g}),l("data-action",(g,O)=>{o[O](g)}),i.addEventListener("abort",()=>{n.removeChild(L)})}}const _t=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function Xo(n){let e=!1,r;const a=new Map,o=new Set;let t;const i=()=>{if(e)return;const u=[...o];o.clear();try{for(const E of u)E()}finally{t=!1,o.size&&(t=!0,_t(i))}},m=new Proxy({},{get(u,E){if(r){let f=a.get(E);f||(f=new Set,a.set(E,f)),f.add(r)}return u[E]},set(u,E,f){u[E]=f;const y=a.get(E);if(y){for(const w of y)o.add(w);t||(t=!0,_t(i))}return!0}}),h=u=>{const E=()=>{const f=r;r=E;try{return u()}finally{r=f}};return E()};return n.addEventListener("abort",()=>{e=!0}),{state:m,createEffect:h}}function pn(n,e,r){if(n.length!==e.length)return!1;for(let a=0;a<n.length;a++)if(!r(n[a],e[a]))return!1;return!0}const vn=[],{assign:Nt}=Object;function Qo(n,e){const r={},a=new AbortController,o=a.signal,{state:t,createEffect:i}=Xo(o);Nt(t,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),Nt(t,e),Nt(t,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:bo,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:un,databaseLoaded:!1,activeSearchItemId:void 0}),i(()=>{t.currentGroup!==t.groups[t.currentGroupIndex]&&(t.currentGroup=t.groups[t.currentGroupIndex])});const m=x=>{n.getElementById(x).focus()},h=x=>n.getElementById(`emo-${x.id}`),u=(x,F)=>{r.rootElement.dispatchEvent(new CustomEvent(x,{detail:F,bubbles:!0,composed:!0}))},E=(x,F)=>x.id===F.id,f=(x,F)=>{const{category:H,emojis:Y}=x,{category:Z,emojis:ne}=F;return H!==Z?!1:pn(Y,ne,E)},y=x=>{pn(t.currentEmojis,x,E)||(t.currentEmojis=x)},w=x=>{t.searchMode!==x&&(t.searchMode=x)},D=x=>{pn(t.currentEmojisWithCategories,x,f)||(t.currentEmojisWithCategories=x)},L=(x,F)=>F&&x.skins&&x.skins[F]||x.unicode,O={labelWithSkin:(x,F)=>Po([x.name||L(x,F),x.annotation,...x.shortcodes||vn].filter(Boolean)).join(", "),titleForEmoji:x=>x.annotation||(x.shortcodes||vn).join(", "),unicodeWithSkin:L},A={onClickSkinToneButton:te,onEmojiClick:W,onNavClick:k,onNavKeydown:V,onSearchKeydown:N,onSkinToneOptionsClick:B,onSkinToneOptionsFocusOut:Te,onSkinToneOptionsKeydown:J,onSkinToneOptionsKeyup:he,onSearchInput:Ne},M={calculateEmojiGridStyle:U};let b=!0;i(()=>{Jo(n,t,O,A,M,r,o,b),b=!1}),t.emojiVersion||fn().then(x=>{x||(t.message=t.i18n.emojiUnsupportedMessage)}),i(()=>{async function x(){let F=!1;const H=setTimeout(()=>{F=!0,t.message=t.i18n.loadingMessage},go);try{await t.database.ready(),t.databaseLoaded=!0}catch(Y){console.error(Y),t.message=t.i18n.networkErrorMessage}finally{clearTimeout(H),F&&(F=!1,t.message="")}}t.database&&x()}),i(()=>{t.pickerStyle=`
      --num-groups: ${t.groups.length}; 
      --indicator-opacity: ${t.searchMode?0:1}; 
      --num-skintones: ${or};`}),i(()=>{t.customEmoji&&t.database&&R()}),i(()=>{t.customEmoji&&t.customEmoji.length?t.groups!==Sn&&(t.groups=Sn):t.groups!==un&&(t.currentGroupIndex&&t.currentGroupIndex--,t.groups=un)}),i(()=>{async function x(){t.databaseLoaded&&(t.currentSkinTone=await t.database.getPreferredSkinTone())}x()}),i(()=>{t.skinTones=Array(or).fill().map((x,F)=>Mo(t.skinToneEmoji,F))}),i(()=>{t.skinToneButtonText=t.skinTones[t.currentSkinTone]}),i(()=>{t.skinToneButtonLabel=t.i18n.skinToneLabel.replace("{skinTone}",t.i18n.skinTones[t.currentSkinTone])}),i(()=>{async function x(){const{database:F}=t,H=(await Promise.all(Eo.map(Y=>F.getEmojiByUnicodeOrName(Y)))).filter(Boolean);t.defaultFavoriteEmojis=H}t.databaseLoaded&&x()});function R(){t.database.customEmoji=t.customEmoji||vn}i(()=>{async function x(){R();const{database:F,defaultFavoriteEmojis:H,numColumns:Y}=t,Z=await F.getTopFavoriteEmoji(Y),ne=await me(Ar([...Z,...H],we=>we.unicode||we.name).slice(0,Y));t.currentFavorites=ne}t.databaseLoaded&&t.defaultFavoriteEmojis&&x()});function U(x){_o(x,o,F=>{{const H=getComputedStyle(r.rootElement),Y=parseInt(H.getPropertyValue("--num-columns"),10),Z=H.getPropertyValue("direction")==="rtl",we=x.parentElement.getBoundingClientRect().width-F;t.numColumns=Y,t.scrollbarWidth=we,t.isRtl=Z}})}i(()=>{async function x(){const{searchText:F,currentGroup:H,databaseLoaded:Y,customEmoji:Z}=t;if(!Y)t.currentEmojis=[],t.searchMode=!1;else if(F.length>=po){const ne=await fe(F);t.searchText===F&&(y(ne),w(!0))}else{const{id:ne}=H;if(ne!==-1||Z&&Z.length){const we=await ge(ne);t.currentGroup.id===ne&&(y(we),w(!1))}}}x()}),i(()=>{const{currentEmojis:x,emojiVersion:F}=t,H=x.filter(Y=>Y.unicode).filter(Y=>sr(Y)&&!wn.has(Y.unicode));if(!F&&H.length)y(x),Dt(()=>G(H));else{const Y=F?x:x.filter(le);y(Y),Dt(()=>jo(r.tabpanelElement))}});function G(x){Oo(x,r.baselineEmoji,h),t.currentEmojis=t.currentEmojis}function le(x){return!x.unicode||!sr(x)||wn.get(x.unicode)}async function oe(x){const F=t.emojiVersion||await fn();return x.filter(({version:H})=>!H||H<=F)}async function me(x){return Ao(x,t.emojiVersion||await fn())}async function ge(x){const F=x===-1?t.customEmoji:await t.database.getEmojiByGroup(x);return me(await oe(F))}async function fe(x){return me(await oe(await t.database.getEmojiBySearchQuery(x)))}i(()=>{}),i(()=>{function x(){const{searchMode:H,currentEmojis:Y}=t;if(H)return[{category:"",emojis:Y}];const Z=new Map;for(const ne of Y){const we=ne.category||"";let Qe=Z.get(we);Qe||(Qe=[],Z.set(we,Qe)),Qe.push(ne)}return[...Z.entries()].map(([ne,we])=>({category:ne,emojis:we})).sort((ne,we)=>t.customCategorySorting(ne.category,we.category))}const F=x();D(F)}),i(()=>{t.activeSearchItemId=t.activeSearchItem!==-1&&t.currentEmojis[t.activeSearchItem].id}),i(()=>{const{rawSearchText:x}=t;Dr(()=>{t.searchText=(x||"").trim(),t.activeSearchItem=-1})});function N(x){if(!t.searchMode||!t.currentEmojis.length)return;const F=H=>{_e(x),t.activeSearchItem=mn(H,t.activeSearchItem,t.currentEmojis)};switch(x.key){case"ArrowDown":return F(!1);case"ArrowUp":return F(!0);case"Enter":if(t.activeSearchItem===-1)t.activeSearchItem=0;else return _e(x),q(t.currentEmojis[t.activeSearchItem].id)}}function k(x){const{target:F}=x,H=F.closest(".nav-button");if(!H)return;const Y=parseInt(H.dataset.groupId,10);r.searchElement.value="",t.rawSearchText="",t.searchText="",t.activeSearchItem=-1,t.currentGroupIndex=t.groups.findIndex(Z=>Z.id===Y)}function V(x){const{target:F,key:H}=x,Y=Z=>{Z&&(_e(x),Z.focus())};switch(H){case"ArrowLeft":return Y(F.previousElementSibling);case"ArrowRight":return Y(F.nextElementSibling);case"Home":return Y(F.parentElement.firstElementChild);case"End":return Y(F.parentElement.lastElementChild)}}async function q(x){const F=await t.database.getEmojiByUnicodeOrName(x),H=[...t.currentEmojis,...t.currentFavorites].find(Z=>Z.id===x),Y=H.unicode&&L(H,t.currentSkinTone);await t.database.incrementFavoriteEmojiCount(x),u("emoji-click",{emoji:F,skinTone:t.currentSkinTone,...Y&&{unicode:Y},...H.name&&{name:H.name}})}async function W(x){const{target:F}=x;if(!F.classList.contains("emoji"))return;_e(x);const H=F.id.substring(4);q(H)}function X(x){t.currentSkinTone=x,t.skinTonePickerExpanded=!1,m("skintone-button"),u("skin-tone-change",{skinTone:x}),t.database.setPreferredSkinTone(x)}function B(x){const{target:{id:F}}=x,H=F&&F.match(/^skintone-(\d)/);if(!H)return;_e(x);const Y=parseInt(H[1],10);X(Y)}function te(x){t.skinTonePickerExpanded=!t.skinTonePickerExpanded,t.activeSkinTone=t.currentSkinTone,t.skinTonePickerExpanded&&(_e(x),Dt(()=>m("skintone-list")))}i(()=>{t.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{t.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):t.skinTonePickerExpandedAfterAnimation=!1});function J(x){if(!t.skinTonePickerExpanded)return;const F=async H=>{_e(x),t.activeSkinTone=H};switch(x.key){case"ArrowUp":return F(mn(!0,t.activeSkinTone,t.skinTones));case"ArrowDown":return F(mn(!1,t.activeSkinTone,t.skinTones));case"Home":return F(0);case"End":return F(t.skinTones.length-1);case"Enter":return _e(x),X(t.activeSkinTone);case"Escape":return _e(x),t.skinTonePickerExpanded=!1,m("skintone-button")}}function he(x){if(t.skinTonePickerExpanded)switch(x.key){case" ":return _e(x),X(t.activeSkinTone)}}async function Te(x){const{relatedTarget:F}=x;(!F||F.id!=="skintone-list")&&(t.skinTonePickerExpanded=!1)}function Ne(x){t.rawSearchText=x.target.value}return{$set(x){Nt(t,x)},$destroy(){a.abort()}}}const Zo="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",es="en";var ts={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},ns=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const Lr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],rs=`:host{--emoji-font-family:${Mr}}`;class Pn extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=ns+rs,this.shadowRoot.appendChild(r),this._ctx={locale:es,dataSource:Zo,skinToneEmoji:yo,customCategorySorting:So,customEmoji:null,i18n:ts,emojiVersion:null,...e};for(const a of Lr)a!=="database"&&Object.prototype.hasOwnProperty.call(this,a)&&(this._ctx[a]=this[a],delete this[a]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Qo(this.shadowRoot,this._ctx))}disconnectedCallback(){_t(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,a){this._set(e.replace(/-([a-z])/g,(o,t)=>t.toUpperCase()),e==="emoji-version"?parseFloat(a):a)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:a}=this._ctx;(!a||a.locale!==e||a.dataSource!==r)&&this._set("database",new ho({locale:e,dataSource:r}))}_dbFlush(){_t(()=>this._dbCreate())}}const _r={};for(const n of Lr)_r[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(Pn.prototype,_r);customElements.get("emoji-picker")||customElements.define("emoji-picker",Pn);var Tn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(r,a){a(e)})(dt,function(r){var a="dnd-poly-",o=a+"snapback",t="dnd-poly-",i=t+"dragstart-pending",m=t+"dragstart-cancel",h=["none","copy","copyLink","copyMove","link","linkMove","move","all"],u=["none","copy","move","link"],E=function(){var N=!1;try{var k=Object.defineProperty({},"passive",{get:function(){N=!0}});window.addEventListener("test",null,k)}catch{}return N}();function f(N){return N&&N.tagName}function y(N,k,V){V===void 0&&(V=!0),document.addEventListener(N,k,!!E&&{passive:V})}function w(N,k){document.removeEventListener(N,k)}function D(N,k,V,q){q===void 0&&(q=!1);var W=E?{passive:!0,capture:q}:q;return N.addEventListener(k,V,W),{off:function(){N.removeEventListener(k,V,W)}}}function L(N){return N.length===0?0:N.reduce(function(k,V){return V+k},0)/N.length}function l(N,k){for(var V=0;V<N.changedTouches.length;V++)if(N.changedTouches[V].identifier===k)return!0;return!1}function g(N,k,V){for(var q=[],W=[],X=0;X<k.touches.length;X++){var B=k.touches[X];q.push(B[N+"X"]),W.push(B[N+"Y"])}V.x=L(q),V.y=L(W)}var O=["","-webkit-"];function A(N,k,V,q,W){W===void 0&&(W=!0);var X=k.x,B=k.y;q&&(X+=q.x,B+=q.y),W&&(X-=parseInt(N.offsetWidth,10)/2,B-=parseInt(N.offsetHeight,10)/2);for(var te="translate3d("+X+"px,"+B+"px, 0)",J=0;J<O.length;J++){var he=O[J]+"transform";N.style[he]=te+" "+V[J]}}var M=function(){function N(k,V){this.t=k,this.i=V,this.s=u[0]}return Object.defineProperty(N.prototype,"dropEffect",{get:function(){return this.s},set:function(k){this.t.mode!==0&&h.indexOf(k)>-1&&(this.s=k)},enumerable:!0,configurable:!0}),Object.defineProperty(N.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(N.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(k){this.t.mode===2&&h.indexOf(k)>-1&&(this.t.effectAllowed=k)},enumerable:!0,configurable:!0}),N.prototype.setData=function(k,V){if(this.t.mode===2){if(k.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[k]=V,this.t.types.indexOf(k)===-1&&this.t.types.push(k)}},N.prototype.getData=function(k){if(this.t.mode===1||this.t.mode===2)return this.t.data[k]||""},N.prototype.clearData=function(k){if(this.t.mode===2){if(k&&this.t.data[k]){delete this.t.data[k];var V=this.t.types.indexOf(k);return void(V>-1&&this.t.types.splice(V,1))}this.t.data={},this.t.types=[]}},N.prototype.setDragImage=function(k,V,q){this.t.mode===2&&this.i(k,V,q)},N}();function b(N,k){return N?N===h[0]?u[0]:N.indexOf(h[1])===0||N===h[7]?u[1]:N.indexOf(h[4])===0?u[3]:N===h[6]?u[2]:u[1]:k.nodeType===3&&k.tagName==="A"?u[3]:u[1]}function R(N,k,V,q,W,X,B){X===void 0&&(X=!0),B===void 0&&(B=null);var te=function(he,Te,Ne,x,F,H,Y){Y===void 0&&(Y=null);var Z=Te.changedTouches[0],ne=new Event(Ne,{bubbles:!0,cancelable:x});ne.dataTransfer=H,ne.relatedTarget=Y,ne.screenX=Z.screenX,ne.screenY=Z.screenY,ne.clientX=Z.clientX,ne.clientY=Z.clientY,ne.pageX=Z.pageX,ne.pageY=Z.pageY;var we=he.getBoundingClientRect();return ne.offsetX=ne.clientX-we.left,ne.offsetY=ne.clientY-we.top,ne}(k,V,N,X,document.defaultView,W,B),J=!k.dispatchEvent(te);return q.mode=0,J}function U(N,k){if(!N||N===h[7])return k;if(k===u[1]){if(N.indexOf(u[1])===0)return u[1]}else if(k===u[3]){if(N.indexOf(u[3])===0||N.indexOf("Link")>-1)return u[3]}else if(k===u[2]&&(N.indexOf(u[2])===0||N.indexOf("Move")>-1))return u[2];return u[0]}var G,le=function(){function N(k,V,q,W){this.h=k,this.o=V,this.u=q,this.l=W,this.v=0,this.p=null,this.g=null,this.m=k,this.I=k.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),y("touchmove",this.j,!1),y("touchend",this.S,!1),y("touchcancel",this.S,!1)}return N.prototype.A=function(){var k=this;this.v=1,this.O=u[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var V=this.u;if(this.N=new M(this.D,function(te,J,he){V=te,typeof J!="number"&&typeof he!="number"||(k.P={x:J||0,y:he||0})}),this.D.mode=2,this.N.dropEffect=u[0],R("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;g("page",this.m,this.F);var q,W=this.o.dragImageSetup(V);if(this.L=(q=W,O.map(function(te){var J=q.style[te+"transform"];return J&&J!=="none"?J.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),W.style.position="absolute",W.style.left="0px",W.style.top="0px",W.style.zIndex="999999",W.classList.add("dnd-poly-drag-image"),W.classList.add("dnd-poly-icon"),this._=W,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var X=getComputedStyle(V);this.P={x:0-parseInt(X.marginLeft,10),y:0-parseInt(X.marginTop,10)}}else{var B=V.getBoundingClientRect();X=getComputedStyle(V),this.P={x:B.left-this.I.clientX-parseInt(X.marginLeft,10)+B.width/2,y:B.top-this.I.clientY-parseInt(X.marginTop,10)+B.height/2}}return A(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){k.X||(k.X=!0,k.Y(),k.X=!1)},this.o.iterationInterval),!0},N.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),w("touchmove",this.j),w("touchend",this.S),w("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},N.prototype.C=function(k){var V=this;if(l(k,this.I.identifier)!==!1){if(this.m=k,this.v===0){var q=void 0;if(this.o.dragStartConditionOverride)try{q=this.o.dragStartConditionOverride(k)}catch{q=!1}else q=k.touches.length===1;return q?void(this.A()===!0&&(this.h.preventDefault(),k.preventDefault())):void this.T()}if(k.preventDefault(),g("client",k,this.M),g("page",k,this.F),this.o.dragImageTranslateOverride)try{var W=!1;if(this.o.dragImageTranslateOverride(k,{x:this.M.x,y:this.M.y},this.p,function(X,B){V._&&(W=!0,V.M.x+=X,V.M.y+=B,V.F.x+=X,V.F.y+=B,A(V._,V.F,V.L,V.P,V.o.dragImageCenterOnTouch))}),W)return}catch{}A(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},N.prototype.k=function(k){if(l(k,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(k.preventDefault(),this.v=k.type==="touchcancel"?3:2):this.T()}},N.prototype.Y=function(){var k=this,V=this.O;this.D.mode=3,this.N.dropEffect=u[0];var q=R("drag",this.u,this.m,this.D,this.N);if(q&&(this.O=u[0]),q||this.v===2||this.v===3)return this.q(this.v)?void function(te,J,he,Te){var Ne=getComputedStyle(te);if(Ne.visibility!=="hidden"&&Ne.display!=="none"){J.classList.add(o);var x=getComputedStyle(J),F=parseFloat(x.transitionDuration);if(isNaN(F)||F===0)Te();else{var H=te.getBoundingClientRect(),Y={x:H.left,y:H.top};Y.x+=document.body.scrollLeft||document.documentElement.scrollLeft,Y.y+=document.body.scrollTop||document.documentElement.scrollTop,Y.x-=parseInt(Ne.marginLeft,10),Y.y-=parseInt(Ne.marginTop,10);var Z=parseFloat(x.transitionDelay),ne=Math.round(1e3*(F+Z));A(J,Y,he,void 0,!1),setTimeout(Te,ne)}}else Te()}(this.u,this._,this.L,function(){k.B()}):void this.B();var W=this.o.elementFromPoint(this.M.x,this.M.y),X=this.g;W!==this.p&&W!==this.g&&(this.p=W,this.g!==null&&(this.D.mode=3,this.N.dropEffect=u[0],R("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=b(this.D.effectAllowed,this.u),R("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=U(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),X!==this.g&&f(X)&&(this.D.mode=3,this.N.dropEffect=u[0],R("dragleave",X,this.m,this.D,this.N,!1,this.g)),f(this.g)&&(this.D.mode=3,this.N.dropEffect=b(this.D.effectAllowed,this.u),R("dragover",this.g,this.m,this.D,this.N)===!1?this.O=u[0]:this.O=U(this.N.effectAllowed,this.N.dropEffect)),V!==this.O&&this._.classList.remove(a+V);var B=a+this.O;this._.classList.add(B)},N.prototype.q=function(k){var V=this.O===u[0]||this.g===null||k===3;return V?f(this.g)&&(this.D.mode=3,this.N.dropEffect=u[0],R("dragleave",this.g,this.m,this.D,this.N,!1)):f(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,R("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=u[0]),V},N.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,R("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},N}(),oe={iterationInterval:150,tryFindDraggableTarget:function(N){var k=N.target;do if(k.draggable!==!1&&(k.draggable===!0||k.getAttribute&&k.getAttribute("draggable")==="true"))return k;while((k=k.parentNode)&&k!==document.body)},dragImageSetup:function(N){var k=N.cloneNode(!0);return function V(q,W){if(q.nodeType===1){for(var X=getComputedStyle(q),B=0;B<X.length;B++){var te=X[B];W.style.setProperty(te,X.getPropertyValue(te),X.getPropertyPriority(te))}if(W.style.pointerEvents="none",W.removeAttribute("id"),W.removeAttribute("class"),W.removeAttribute("draggable"),W.nodeName==="CANVAS"){var J=q,he=W,Te=J.getContext("2d").getImageData(0,0,J.width,J.height);he.getContext("2d").putImageData(Te,0,0)}}if(q.hasChildNodes())for(B=0;B<q.childNodes.length;B++)V(q.childNodes[B],W.childNodes[B])}(N,k),k},elementFromPoint:function(N,k){return document.elementFromPoint(N,k)}};function me(N){if(!G){var k=oe.tryFindDraggableTarget(N);if(k)try{G=new le(N,oe,k,fe)}catch(V){throw fe(oe,N,3),V}}}function ge(N){var k=N.target,V=function(J){W.off(),X.off(),B.off(),te.off(),k&&k.dispatchEvent(new CustomEvent(m,{bubbles:!0,cancelable:!0})),clearTimeout(q)};k&&k.dispatchEvent(new CustomEvent(i,{bubbles:!0,cancelable:!0}));var q=window.setTimeout(function(){W.off(),X.off(),B.off(),te.off(),me(N)},oe.holdToDrag),W=D(k,"touchend",V),X=D(k,"touchcancel",V),B=D(k,"touchmove",V),te=D(window,"scroll",V,!0)}function fe(N,k,V){if(V===0&&N.defaultActionOverride)try{N.defaultActionOverride(k),k.defaultPrevented}catch{}G=null}r.polyfill=function(N){if(N&&Object.keys(N).forEach(function(W){oe[W]=N[W]}),!oe.forceApply){var k=(V={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},q=!!window.chrome||/chrome/i.test(navigator.userAgent),V.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||q&&"ontouchstart"in document.documentElement),V);if(k.userAgentSupportingNativeDnD&&k.draggable&&k.dragEvents)return!1}var V,q;return oe.holdToDrag?y("touchstart",ge,!1):y("touchstart",me,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(Tn,Tn.exports);var as=Tn.exports;const os=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),ss=n=>n.replace(/\n/g,"<br>"),Ce=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},is=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let ur;const cs=(n=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),a=()=>{clearTimeout(r),clearTimeout(ur),ur=setTimeout(()=>{n.removeEventListener("scroll",a),e()},100)};n.addEventListener("scroll",a)}),xn=n=>{try{return JSON.parse(n),!0}catch{return!1}},ls="0.6.5 Beta",Ye=document.querySelector(".editor"),de=document.getElementById("tones"),Se=document.getElementById("action"),ae=document.getElementById("musical-score"),Re=document.getElementById("add-track"),st=document.getElementById("remove-track"),Ge=document.getElementById("dialog"),be=document.forms["dialog-form"];be._title=be.querySelector(".form-title");be.description=be.querySelector(".description");be.inputs=be.querySelector(".inputs");be.buttons=be.querySelector(".buttons");const Ot=document.getElementById("play"),Pt=document.getElementById("clear"),us=document.getElementById("warn-out"),ds=document.getElementById("mml"),Ae=document.getElementById("copy"),Ve=document.getElementById("paste"),qe=document.getElementById("save"),kn=document.getElementById("open"),Jt=document.getElementById("ctrl"),jt=document.getElementById("undo"),Bt=document.getElementById("redo");var pt,ue,De,tt;class fs{constructor(){ce(this,pt,`#COMMENT Generated by FlMML VisualSequencer v${ls}`);ce(this,ue,[]);ce(this,De,(e,r)=>{});ce(this,tt,(e,r)=>{})}set onChange(e){ke(this,De,e)}set onError(e){ke(this,tt,e)}setMmlArr(e){ke(this,ue,e),C(this,De).call(this,this.getMmlArr(),this.getMml())}setMml(e){ke(this,ue,e.split(`
`)),C(this,ue).at(-2)===""&&C(this,ue).at(-1)===C(this,pt)&&C(this,ue).splice(-2,2),C(this,De).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return C(this,ue)}getMml(){return C(this,ue).length?C(this,ue).concat(["",C(this,pt)]).join(`
`):""}getMmlLine(e){return C(this,ue)[e]}insert(e,r){Object.hasOwn(C(this,ue),e)||e===0?(C(this,ue).splice(e,0,r),C(this,De).call(this,this.getMmlArr(),this.getMml())):C(this,tt).call(this,"範囲外の書き換え指定",`範囲${C(this,ue).length-1}までのところ、${e}`)}append(e){C(this,ue).push(e),C(this,De).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(C(this,ue),e)?(C(this,ue)[e]+=r,C(this,De).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(C(this,ue),e)?(C(this,ue)[e]=r+C(this,ue)[e],C(this,De).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(C(this,ue),e)?(C(this,ue)[e]=r,C(this,De).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(C(this,ue),e)&&C(this,ue).splice(e,r).length!==0?C(this,De).call(this,this.getMmlArr(),this.getMml()):C(this,tt).call(this,"無効な指定",`範囲${C(this,ue).length-1}までの中で${e}から${r}削除するのはできません`)}}pt=new WeakMap,ue=new WeakMap,De=new WeakMap,tt=new WeakMap;var re,nt,rt,vt,We,gt,Nn;class ms{constructor(e,r){ce(this,gt);ce(this,re,[]);ce(this,nt,new Set);ce(this,rt,[]);ce(this,vt,null);ce(this,We,null);this.tonesElem=e,this.areaElem=r,ke(this,We,this.areaElem.querySelector(".track.active"))}set activeTrack(e){C(this,We).classList.remove("active"),ke(this,We,e),C(this,We).classList.add("active")}get activeTrack(){return C(this,We)}blocksDataUpdate(){ke(this,re,[...this.areaElem.querySelectorAll(".track button")].map(this.extractBlockData))}extractBlockData(e){return{label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),...e.dataset,elem:e}}saveBlocksData(){clearTimeout(C(this,vt)),ke(this,vt,setTimeout(()=>{const e=JSON.parse(JSON.stringify(C(this,re)));gn.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){gn.getItem("BlocksData").then(e=>{e&&(ke(this,re,e.map(r=>{const a=r.tone;return(a==null?void 0:a.tone)!==void 0&&(a==null?void 0:a.tonePitch)!==void 0&&(r.tone=a.tone,r.tonePitch=a.tonePitch),r})),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Q),this.calcPlayFromHere())})}parseBlocks(){const e=C(this,re);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let a=0;e.forEach(o=>{if(o.trackNo!==a){const E=document.createElement("ul");E.classList.add("track"),this.activeTrack=E,this.areaElem.insertBefore(E,Re),a=o.trackNo}const t=document.createElement("li"),i='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',m=(()=>{const E=document.createElement("div");return E.innerHTML=i,E.firstElementChild})(),h=document.querySelector(`[class*="${o.className.replace(/ material-icons| droppable| bounce| pop| done| inactive/g,"")}"]`),u=(h==null?void 0:h.cloneNode(!0))||m;o.label&&(u.ariaLabel=o.label),u.className=o.className,o.tonePitch&&(o.label!=="無調整"&&(u.textContent=o.label),u.dataset.tone=o.tone,h?h.replaceWith(u.cloneNode(!0)):r.appendChild(u.cloneNode(!0)),u.dataset.tonePitch=o.tonePitch),o.tempo&&(u.dataset.tempo=o.tempo),o.noteValue&&(u.dataset.noteValue=o.noteValue),o.rest&&(u.dataset.rest=o.rest),o.octave&&(u.dataset.octave=o.octave),o.velocity&&(u.dataset.velocity=o.velocity),o.noteShift&&(u.dataset.noteShift=o.noteShift),o.detune&&(u.dataset.detune=o.detune),o.tieSlur&&(u.dataset.tieSlur=o.tieSlur,o.tieSlur==="&"?u.ariaLabel="スラー":u.ariaLabel="タイ"),o.repeatStartEnd&&(u.dataset.repeatStartEnd=o.repeatStartEnd,o.repeatStartEnd.startsWith("/:")?(u.classList.remove("material-icons"),u.ariaLabel="リピート開始",u.textContent="◆"):o.repeatStartEnd===":/"&&(u.ariaLabel="リピート終了")),o.repeatBreak&&(u.dataset.repeatBreak=o.repeatBreak),o.polyStartEnd&&(u.dataset.polyStartEnd=o.polyStartEnd),o.macroDef&&(u.dataset.macroDef=o.macroDef,o.macroDef===";"?u.textContent=";":u.textContent="$="),o.macroArgUse&&(u.dataset.macroArgUse=o.macroArgUse),o.macroUse&&(u.dataset.macroUse=o.macroUse),o.metaData&&(u.dataset.metaData=o.metaData),o.otherAction&&(u.dataset.otherAction=o.otherAction,u.textContent=o.otherAction.length>4?"…":o.otherAction),t.appendChild(u),this.activeTrack.appendChild(t)})}exportMml(e){e.setMmlArr([]);let r=0,a=0;const o=C(this,re).filter(l=>l.tone!==void 0),t=()=>o.filter(l=>l.trackNo===a),i=()=>new Set(t().map(l=>l.tone));let m=i(),h=0,u=!1,E={noteValue:4,dots:0},f=!1,y=!1;const w=C(this,re).findIndex(l=>l.elem.classList.contains("play-from-here")),D=w!==-1,L=D?C(this,re)[w].trackNo:-1;C(this,re).forEach((l,g)=>{const{tone:O,tonePitch:A}=l,M=!D||y||D&&l.trackNo===L&&g>=w;if(l.trackNo!==a&&(m.size?([...m].forEach((b,R)=>{e.appendToStr(r+R,";")}),r+=m.size):(e.appendToStr(r,";"),r++),a=l.trackNo,m=i(),u=!1,y=!1),O!==void 0)h=[...m].indexOf(O),u||([...m].forEach((b,R)=>{b&&e.beforeInsertToStr(r+R,b+" ")}),u=!0),[...m].forEach((b,R)=>{let U=A||"";R!==h&&(U=U.replace(/[a-g]/,f?"*":"r")),M||(U=U.replace(/[a-gr*]\+?[0-9]*\.*/i,"")),e.appendToStr(r+R,U)});else if(l.rest||l.tieSlur){let b=l.rest||l.tieSlur;M||(b=b.replace(/[r&]\+?[0-9]*\.*/i,"")),m.size?[...m].forEach((R,U)=>{e.appendToStr(r+U,b)}):e.appendToStr(r,b)}else if(l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd){const b=R=>{if(!R)return E;const U=Number((R.match(/[0-9]+/)||[E.noteValue])[0]),G=(R.match(/\.+/)||[""])[0].length;return{noteValue:U,dots:G}};l.noteValue?E=b(l.noteValue):l.polyStartEnd==="["?f=!0:l.polyStartEnd==="]"&&(f=!1),m.size?[...m].forEach((R,U)=>{if(e.appendToStr(r+U,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||""),l.polyStartEnd==="]"){const G=e.getMmlLine(r+U).match(/\[(.+?)\]/);if(G){const le=G[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(le){const oe=[...le].map(fe=>({type:fe[1]==="r"?"rest":fe[1]==="*"?"otherNote":"note",num:b(fe[0])}));oe.filter(N=>N.type==="note").map(N=>N.num),oe.filter(N=>N.type==="otherNote").map(N=>N.num),oe.filter(N=>N.type==="rest").map(N=>N.num);let me=G[0].replace(/\*\+?[0-9]*\.*/g,"");const ge=e.getMmlLine(r+U).replace(/\[.+?\]/,me);e.rewrite(r+U,ge)}}}}):e.appendToStr(r,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||"")}else if(l.metaData)l.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,l.metaData.replace(`
`,"")||""),r++;else if(l.macroDef)y=l.macroDef!==";",e.appendToStr(r,l.macroDef||"");else{let b;M?b=A||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.macroArgUse||l.macroUse||l.otherAction||"":b=(A==null?void 0:A.replace(/[a-g]\+?[0-9]*\.*/i,""))||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.otherAction||"",e.appendToStr(r,b),/;/.test(b)&&(r+=m.size||1,m=i(),u=!1)}}),[...m].slice(0,-1).forEach((l,g)=>{e.appendToStr(r+g,";")})}importMml(e){const r=e.getMmlArr(),a=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_.]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig;C(this,nt).clear();const o=new Set;let t=0,i="",m=!1,h=!1;const u=f=>(f.match(a)||[]).reduce((w,D)=>(D=D.trim(),D&&(l=>{const g={};if(g.tone={},g.trackNo=t,l.startsWith("#")){const O={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};g.label=(Object.entries(O).find(A=>l.startsWith(A[0]))||[,void 0])[1],g.className="meta-data",g.metaData=l+`
`}else if(/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(l)){i=l,o.add(i);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(l)){o.has(i)||o.add(i);const O=[...o].indexOf(i)+1;g.label="無調整",g.className=`material-icons note note-${O}`,g.tone=i,g.tonePitch=l,m&&(h=!0)}else if(l.startsWith("t"))g.className="material-icons tempo",g.tempo=l;else if(l.startsWith("l"))g.className="material-icons note-value",g.noteValue=l;else if(l.startsWith("r"))g.className="material-icons rest",g.rest=l;else if(/^o[0-8]|[><]+$/i.test(l))g.className="material-icons octave",g.octave=l;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(l))g.className="material-icons velocity",g.velocity=l;else if(l.startsWith("@ns")||l.startsWith("ns"))g.className="material-icons note-shift",g.noteShift=l;else if(l.startsWith("@d"))g.className="material-icons detune",g.detune=l;else if(l.startsWith("&"))g.className="tie-slur",g.tieSlur=l;else if(l.startsWith("/*"))g.className="other-action",g.otherAction=l;else if(l.startsWith("/:"))g.className="repeat-start-end",g.repeatStartEnd=l;else if(l.startsWith(":/"))g.className="material-icons repeat-start-end",g.repeatStartEnd=l;else if(l.startsWith("/"))g.className="repeat-break",g.repeatBreak=l;else if(l.startsWith("[")||l.startsWith("]"))g.className="poly-start-end",g.polyStartEnd=l;else if(/^\$.*?=$/.test(l))g.className="macro-def",g.macroDef=l.replaceAll(" ",""),C(this,nt).add(g.macroDef.replace("=","")),m=!0;else if(l.startsWith("%"))g.className="macro-arg-use",g.macroArgUse=l;else if(l.startsWith("$")){g.className="macro-use";const O=l.replace(/\{.*/,""),A=[...C(this,nt)].sort((M,b)=>b.length-M.length).find(M=>O.includes(M));if(A){const M=(l.match(/\{[^\}]*\}/)||[""])[0];g.macroUse=`${A}${M}`,w.push(g);const b=l.replace(A,"");b!==""&&(w=w.concat(u(b)));return}else g.macroUse=l}else if(l.startsWith(";")){if(t++,m&&!h){const O=[...o].join(" ");O&&(g.className="other-action",g.otherAction=O,w.push(g),o.clear())}i="",m=!1,h=!1;return}else g.className="other-action",g.otherAction=l;w.push(g)})(D),w),[]);this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((f,y)=>{y?f.remove():(f.textContent="",this.activeTrack=f)}),K=null;const E=r.map(u).flat();ke(this,re,E),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}get blocksData(){return C(this,re)}set blocksData(e){this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((r,a)=>{a?r.remove():(r.textContent="",this.activeTrack=r)}),K=null,ke(this,re,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData(),this.exportMml(Q),this.calcPlayFromHere()}playRendering(e=-1){const r=C(this,re);if(!r.length)return;const a=e!==-1,o=r[e],t=a?o.trackNo:-1;let i=120,m=0;[de,Se,ae].forEach(D=>{D.classList.add("no-op")});const h=document.querySelector(".wrap"),u=document.getElementsByClassName("track"),f=(h.clientHeight-32)/u.length;[...u].forEach(D=>{D.style.setProperty("--max-height",`${f}px`)}),Re.disabled=!0,st.disabled=!0;const y=(D,{scoreNoteValue:L=4,ignorePlayFromHere:l=!1}={})=>{var X;let g=!1,O=-1,A=!1,M=!1;const b=[],R=performance.now(),U=(X=D[0])==null?void 0:X.trackNo,G=u[U],le=m++,oe=D.findIndex(B=>B===o);let me=null;const ge=new Promise(B=>me=B);let fe=0,N=0;const k=B=>cn(this,gt,Nn).call(this,{str:B,scoreNoteValue:L}),V=B=>{const te=he=>{!M&&G.scrollTo({top:he,behavior:"smooth"}),M=!0,cs(G).then(()=>{M=!1})},J=he=>G.clientHeight*he;(N===0||B.elem.offsetTop>G.scrollTop+J(.8)||B.elem.offsetTop<G.scrollTop+J(.2))&&te(B.elem.offsetTop-J(.2))},q=B=>{const te=J=>{const he=J-R,Te=60/i*4/B*1e3;he<fe+Te?C(this,rt)[le]=requestAnimationFrame(te):(fe+=Te,W())};C(this,rt)[le]=requestAnimationFrame(te)},W=async()=>{var he,Te,Ne;const B=D[N];if(!B||N>=D.length){me({scoreNoteValue:L});return}V(B);const te=x=>{let F=0;return D.findIndex((H,Y)=>{var Z;if(Y>x+1){if((Z=H.repeatStartEnd)!=null&&Z.startsWith("/:"))F++;else if(H.repeatStartEnd===":/"){if(F===0)return!0;F--}}return!1})},J=!a||l||a&&B.trackNo===t&&N>=oe;if(A){B.macroDef===";"&&(A=!1),N++,W();return}else if(B.tonePitch)if(J&&Ce(B.elem,"bounce"),N++,g||!J)W();else{const x=k(B.tonePitch);q(x)}else if(B.rest||B.tieSlur)if(J&&Ce(B.elem,"pop"),N++,B.tieSlur==="&"||!J)W();else{const x=k(B.rest||B.tieSlur);q(x)}else if(B.polyStartEnd)if(g=B.polyStartEnd==="[",J&&Ce(B.elem,"pop"),g||!J)N++,W();else{const x=k(D[N++-1].tonePitch);q(x)}else if(B.macroDef&&B.macroDef!==";"){A=!0,N++,W();return}else{if(B.tempo&&(i=Number(B.tempo.replace("t",""))||i),B.noteValue&&(L=k(B.noteValue)),(he=B.repeatStartEnd)!=null&&he.startsWith("/:")){b[Te=++O]??(b[Te]={start:N});let x=B.repeatStartEnd.replace("/:","");if(x=x===""?2:Number(x),x)if(b[O].end){if(!b[O].remaining){B.elem.dataset.repeatStartEnd=`/:${b[O].remaining}`,N=b[O].end,W();return}D.slice(b[O].start+1,b[O].end-1).filter(F=>{var H;return(H=F.repeatStartEnd)==null?void 0:H.startsWith("/:")}).forEach(F=>{F.elem.dataset.repeatStartEnd=F.repeatStartEnd})}else b[O].remaining=x;else{N=te(N),W(),J&&(Ce(B.elem,"pop"),Ce(B.elem,"done"));return}B.elem.dataset.repeatStartEnd=`/:${b[O].remaining}`}else if(B.repeatBreak){if(b[O].remaining===1){b[O].end||(b[O].end=te(b[O].start)),N=b[O].end,W(),J&&(Ce(B.elem,"pop"),Ce(B.elem,"done"));return}}else if(B.repeatStartEnd===":/"){if((Ne=b[O]).end??(Ne.end=N),b[O].remaining){b[O].remaining--,N=b[O].start,O--,W(),J&&(Ce(B.elem,"pop"),Ce(B.elem,"done"));return}b.pop(),O--}else if(B.macroUse&&J){const x=H=>{const Y=r[H].trackNo;let Z=H+1;for(;r[Z].macroDef!==";"&&r[Z].trackNo===Y;)Z++;return Z},F={};if(F.start=r.findIndex(H=>{var Y;return(Y=H.macroDef)==null?void 0:Y.startsWith(B.macroUse)}),F.start>-1){F.end=x(F.start),F.blocks=r.slice(F.start+1,F.end);const H=performance.now();L=(await y(F.blocks,{scoreNoteValue:L,ignorePlayFromHere:!0})).scoreNoteValue;const Y=performance.now();fe+=Y-H}}N++,W(),J&&Ce(B.elem,"pop")}J&&Ce(B.elem,"done")};return W(),ge},w=r.at(-1).trackNo+1;for(let D=0;D<w;D++){const L=r.filter(l=>l.trackNo===D);y(L)}}stopRendering(){[de,Se,ae].forEach(e=>{e.classList.remove("no-op")}),Re.disabled=!1,st.disabled=!1,C(this,re).forEach(e=>{e.elem.classList.remove("done")}),C(this,re).filter(e=>{var r;return(r=e.repeatStartEnd)==null?void 0:r.startsWith("/:")}).forEach(e=>{e.elem.dataset.repeatStartEnd=e.repeatStartEnd}),C(this,rt).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!C(this,re).length)return;const e=C(this,re).at(-1).trackNo+1;for(let r=0;r<e;r++)C(this,re).filter(o=>o.polyStartEnd&&o.trackNo===r).forEach((o,t)=>{t%2===0?(o.elem.dataset.polyStartEnd="[",o.elem.textContent="["):(o.elem.dataset.polyStartEnd="]",o.elem.textContent="]")});this.blocksDataUpdate()}calcPlayFromHere(){var t;if(!C(this,re).length)return;C(this,re).filter(i=>i.elem.classList.contains("inactive")).forEach(i=>{i.elem.classList.remove("inactive")});const e=C(this,re).find(i=>i.elem.classList.contains("play-from-here"));if(!e){Ae.disabled=qe.disabled=!1;return}const r=C(this,re).indexOf(e);C(this,re).filter((i,m)=>i.trackNo!==e.trackNo||m<r).forEach(i=>{i.elem.classList.add("inactive")});const o=C(this,re).filter((i,m)=>i.trackNo===e.trackNo&&m<r);if(o.length){let i=Number((t=C(this,re).find(w=>w.tempo))==null?void 0:t.tempo.replace("t",""))||120,m=4,h=!1,u=!1;const E=w=>cn(this,gt,Nn).call(this,{str:w,scoreNoteValue:m}),f=(w,D)=>w.reduce((L,l,g)=>{var A;const O=M=>{let b=0;return w.findIndex((R,U)=>{var G;if(U>M+1){if((G=R.repeatStartEnd)!=null&&G.startsWith("/:"))b++;else if(R.repeatStartEnd===":/"){if(b===0)return!0;b--}}return!1})};if(u)l.macroDef===";"&&(u=!1);else if(l.tonePitch||l.rest||l.tieSlur){if(h||l.tieSlur==="&")return L;const M=E(l.tonePitch||l.rest||l.tieSlur);return L+60/i*4/M*1e3}else if(l.polyStartEnd){if(h=l.polyStartEnd==="[",h)return L;const M=E(w[g-1].tonePitch);return L+60/i*4/M*1e3}else if(l.macroDef&&l.macroDef!==";")u=!0;else if(l.tempo)i=Number(l.tempo.replace("t",""))||i;else if(l.noteValue)m=E(l.noteValue);else if((A=l.repeatStartEnd)!=null&&A.startsWith("/:")){let M=l.repeatStartEnd.replace("/:","");M=M===""?2:Number(M);let b=O(g);return b===-1&&(b=w.length+1),M?L+f(w.slice(g+1,b-1),!0)*(M-1):L-f(w.slice(g+1,b-1))}else if(l.repeatBreak&&!D){let M=O(g);return M===-1&&(M=w.length+1),L-f(w.slice(g+1,M-1))}else if(l.macroUse){const M={};if(M.start=C(this,re).findIndex(b=>{var R;return(R=b.macroDef)==null?void 0:R.startsWith(l.macroUse)}),M.start>-1){const b=R=>{let U=R+1;for(;C(this,re)[U].macroDef!==";"&&C(this,re)[U].trackNo===l.trackNo;)U++;return U};return M.end=b(M.start),M.blocks=C(this,re).slice(M.start+1,M.end),L+f(M.blocks)}}return L},0),y=f(o);console.log(`Skipped playback time: ${y} ms`),Le.additionalStartMSec=y}Ae.disabled=qe.disabled=!0}}re=new WeakMap,nt=new WeakMap,rt=new WeakMap,vt=new WeakMap,We=new WeakMap,gt=new WeakSet,Nn=function({str:e,scoreNoteValue:r=4}={}){if(!e)return r;const a=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(e),o=a&&a[1]?Number(a[1]):r,t=a?a[2].length:0;return o*2**t/(2**(t+1)-1)};var ve,$t,yt,at;class hs{constructor(){ce(this,ve,[[],[]]);ce(this,$t,70);ce(this,yt,e=>{});ce(this,at,e=>{})}set onPushstate(e){ke(this,yt,e)}set onPopstate(e){ke(this,at,e)}pushState(e){C(this,ve)[0].push(e),C(this,yt).call(this,e),C(this,ve)[0].length>C(this,$t)&&C(this,ve)[0].shift(),C(this,ve)[1].length=0,console.log(C(this,ve))}undo(){const e=C(this,ve)[0].pop();return C(this,at).call(this,{reason:"undo",data:e}),e&&C(this,ve)[1].unshift(e),console.log(C(this,ve)),{canUndo:!!C(this,ve)[0].length,canRedo:!!C(this,ve)[1].length}}redo(){const e=C(this,ve)[1].shift();return C(this,at).call(this,{reason:"redo",data:e}),e&&C(this,ve)[0].push(e),console.log(C(this,ve)),{canUndo:!!C(this,ve)[0].length,canRedo:!!C(this,ve)[1].length}}clear(){C(this,ve)[0].length=0,C(this,ve)[1].length=0,console.log(C(this,ve))}}ve=new WeakMap,$t=new WeakMap,yt=new WeakMap,at=new WeakMap;const Me=[1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,384];let K=de.querySelector("button"),Or=!1,Oe=!1;const je={timeStamp:-1,tempo:120,scoreNoteValue:"4"};let In=null,Cn=!1,It=null;const Pr=()=>{T.activeTrack.querySelectorAll("button").forEach(n=>{n.classList.remove("done")}),Cn=!1},Rt=()=>{if(clearTimeout(In),K&&K.closest(".track")!==T.activeTrack){K=T.activeTrack.querySelector("button");return}let n=K;const e=()=>{const t=performance.measure("stepElapsed","stepPoint");performance.mark("stepPoint");const i=t.duration,h=(E=>{const f=60/je.tempo*4/E*1e3,{noteValue:y,dots:w}=Me.reduce((D,L,l)=>{const g=Math.log2(f/(2*f-L));if(g<0||Number.isNaN(g))return D;const O=g-Math.floor(g);return O<D.smallerFractional?{noteValue:L,dots:Math.round(g),smallerFractional:O}:D},{noteValue:null,dots:null,smallerFractional:1});if(y+".".repeat(w)===je.scoreNoteValue)return"";if(String(y)===je.scoreNoteValue){const D=je.scoreNoteValue.match(/\.*/),L=D?D[0].length:0;return".".repeat(w-L)}else return y+".".repeat(w)})(i);(E=>{const f=It;"tonePitch"in f.dataset?f.dataset.tonePitch=f.dataset.tonePitch+E:"rest"in f.dataset&&(f.dataset.rest="r"+E)})(h),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)};if(!n){if(Cn){console.log("end1");return}xe.stop(),e(),je.timeStamp=-1,It=null,performance.clearMarks("stepPoint"),setTimeout(()=>{K=T.activeTrack.querySelector("button"),Pr()},2e3),Cn=!0,console.log("end2");return}(()=>{if("tonePitch"in n.dataset){n.dataset.tonePitch=n.dataset.tonePitch.match(/[><]*?[a-g]\+?/i)[0],Pe(n,{noteValue:"1..."}),n.classList.add("bounce");return}"rest"in n.dataset&&(n.dataset.rest="r"),n.classList.add("done")})();const a=()=>{var t;K=n=((t=n.parentElement.nextElementSibling)==null?void 0:t.firstElementChild)||null};if("tonePitch"in n.dataset||xe.stop(),!["tonePitch","rest"].some(t=>t in n.dataset)){if("tempo"in n.dataset){const t=Number(n.dataset.tempo.replace("t",""));je.tempo=t}else"noteValue"in n.dataset&&(je.scoreNoteValue=(n.dataset.noteValue.match(/[0-9]+\.*/)||[je.scoreNoteValue])[0]);a(),Rt(),console.log("end3");return}if((()=>{const t=60/je.tempo*4*1e3*1.825;In=setTimeout(Rt,t)})(),!performance.getEntriesByName("stepPoint")[0]){performance.mark("stepPoint"),It=n,a(),console.log("end4");return}e(),It=n,a()};let He=!1;var ze,bt;class ps{constructor(){ce(this,ze,30);ce(this,bt,1e3/(C(this,ze)*4));this.outputs=null,this.output=null,this.startMSec=0,this.additionalStartMSec=0,this.startTime=0,this.timer=null,this.initialized=!1}getQuarterFrameMessages(e,r,a,o){return[[241,0|o&15],[241,16|o>>4&1],[241,32|a&15],[241,48|a>>4&3],[241,64|r&15],[241,80|r>>4&3],[241,96|e&15],[241,118|e>>4&1]]}framesToTimecode(e){const r=e%C(this,ze),a=Math.floor(e/C(this,ze)),o=a%60,t=Math.floor(a/60),i=t%60;return{hours:Math.floor(t/60)%24,minutes:i,seconds:o,frames:r}}sendQuarterFrame(){if(!this.output)return;const e=performance.now(),r=(e-this.startTime)/1e3,a=Math.floor((this.startMSec+this.additionalStartMSec)/1e3*C(this,ze)+r*C(this,ze)),{hours:o,minutes:t,seconds:i,frames:m}=this.framesToTimecode(a);this.getQuarterFrameMessages(o,t,i,m).forEach((u,E)=>{var f;(f=this.output)==null||f.send(u,e+E*C(this,bt))}),this.timer=window.setTimeout(()=>this.sendQuarterFrame(),C(this,bt)*8)}async init(){if(!this.initialized)return this.initialized=!0,navigator.requestMIDIAccess().then(e=>this.outputs=Array.from(e.outputs.values()))}configure(e){Object.assign(this,e)}start(){if(!this.output){console.warn("MTC Sync output not available.");return}this.startTime=performance.now(),this.sendQuarterFrame()}stop(){this.timer&&(clearTimeout(this.timer),this.timer=null)}}ze=new WeakMap,bt=new WeakMap;const Le=new ps;var Et,Ke,Ut,Vt,Wt,zt,Ht,qt,Yt,Gt,Kt;class vs{constructor(e){ce(this,Et,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name",value:(e,r)=>r.ariaLabel},{label:"音の定義",type:"text",name:"tone-def",autofocus:!0,value:e=>e}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}],run:(e,r)=>{const{"tone-name":a}=r;a.insertAdjacentElement("afterend",ys);const o=document.querySelector("emoji-picker");a.addEventListener("focus",()=>{o.classList.add("expaned")},{once:!0}),o.addEventListener("emoji-click",t=>a.value=t.detail.unicode)},on:{"set-tone":(e,r)=>{const{"tone-name":a,"tone-def":o}=r,t=e.className;document.querySelectorAll(`[class*="${t}"]`).forEach(i=>{i.ariaLabel=a,(!i.classList.contains("material-icons")||a!=="無調整")&&(i.classList.remove("material-icons"),i.textContent=a),i.dataset.tone=o})}}},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}],run:(e,r)=>{const{"tone-pitch":a}=r;C(this,Ke).call(this,a)},on:{"set-tone-pitch":(e,r)=>{const{"tone-pitch":a,dot:o}=r;e.dataset.tonePitch=`${e.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]}${a}${".".repeat(o)}`}}},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0",value:e=>e.replace("t","")}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}],on:{"set-tempo":(e,r)=>{const{tempo:a}=r;e.dataset.tempo=`t${a}`}}},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}],run:(e,r)=>{const{"note-value":a}=r;C(this,Ke).call(this,a)},on:{"set-note-value":(e,r)=>{const{"note-value":a,dot:o}=r;e.dataset.noteValue=`l${a}${".".repeat(o)}`}}},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}],run:(e,r)=>{const{rest:a}=r;C(this,Ke).call(this,a)},on:{"set-rest":(e,r)=>{const{rest:a,dot:o}=r;e.dataset.rest=`r${a}${".".repeat(o)}`}}},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8",value:e=>e.startsWith("o")?e.replace("o",""):(e.match(/[><]+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}],on:{"set-octave":(e,r)=>{const{octave:a}=r;e.dataset.octave=`o${a}`},"set-octave-relative":(e,r)=>{const{octave:a}=r;e.dataset.octave=(a>0?"<":">").repeat(Math.abs(a))}}},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127",value:e=>e.startsWith("@v")?e.replace("@v",""):Number((e.match(/[0-9]+/)||[""])[0])*(e.startsWith("(")?1:-1)}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}],on:{"set-velocity":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=`@v${a}`},"set-velocity-relative":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=(a>0?"(":")").repeat(Math.abs(a))}}},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift",value:e=>(e.match(/[0-9]+/)||[""])[0]}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}],on:{"set-note-shift":(e,r)=>{const{"note-shift":a}=r;e.dataset.noteShift=`ns${a}`},"set-note-shift-relative":(e,r)=>{const{noteShift:a}=r;e.dataset.noteShift=`@ns${a}`}}},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune",value:e=>e.replace("@d","")}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}],on:{"set-detune":(e,r)=>{const{detune:a}=r;e.dataset.detune=`@d${a}`}}},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}],run:(e,r)=>{const{"tie-slur":a}=r;C(this,Ke).call(this,a)},on:{"set-tie-slur":(e,r)=>{const{"tie-slur":a,dot:o}=r;e.dataset.tieSlur=`&${a}${".".repeat(o)}`,e.dataset.tieSlur==="&"?e.ariaLabel="スラー":e.ariaLabel="タイ"}}},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0",value:e=>e.replace("/:","")}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}],on:{"set-repeat":(e,r)=>{const{repeat:a}=r;e.dataset.repeatStartEnd=`/:${a}`}}},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name",value:e=>(e.match(/\$([^\{\=]*)/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}],on:{"set-macro-def":(e,r)=>{const{"macro-def-name":a,"macro-def-arg":o}=r;e.dataset.macroDef=`$${a}${o?`{${o}}`:""}=`;const t=(e.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];ae.querySelectorAll(`[data-macro-use^="${t}"]`).forEach(i=>{i.dataset.macroUse=i.dataset.macroUse.replace(t,`$${a}`)})}}},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use",value:e=>e.replace("%","")}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}],run:(e,r)=>{const{"macro-arg-use":a}=r,t=(()=>{let E=this.item.parentElement;for(;E&&!E.firstElementChild.dataset.macroDef;)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null})();if(!t||t.dataset.macroDef===";")return;const h=(t.dataset.macroDef.match(/\{([^\}]*)\}/)||[,""])[1].split(","),u=document.createElement("datalist");u.id="macro-arg-use-list",h.forEach(E=>{const f=document.createElement("option");f.value=E,u.appendChild(f)}),a.after(u),a.setAttribute("list","macro-arg-use-list")},on:{"set-macro-arg-use":(e,r)=>{const{"macro-arg-use":a}=r;e.dataset.macroArgUse=`%${a}`}}},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name",value:e=>(e.match(/\$([^\{]*)\{?/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}],run:(e,r)=>{const{"macro-use-name":a}=r,o=document.createElement("datalist");o.id="macro-use-name-list",T.blocksData.filter(i=>i.macroDef&&i.macroDef!==";").map(i=>i.macroDef.replace("=","")).forEach(i=>{const m=document.createElement("option");m.label=(i.match(/\{[^\}]*\}/)||[""])[0],m.value=(i.match(/\$([^\{]*)\{?/)||[,""])[1],o.appendChild(m)}),a.after(o),a.setAttribute("list","macro-use-name-list")},on:{"set-macro-use":(e,r)=>{const{"macro-use-name":a,"macro-use-arg":o}=r;e.dataset.macroUse=`$${a}${o?`{${o}}`:""}`}}},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}],run:(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r,i=e.split(" "),m=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let h=m.findIndex(w=>i[0].startsWith(w));h===-1&&(h=0),a.selectedIndex=h;const u=w=>w.previousSibling,E=()=>a.selectedOptions[0],f=(w,D)=>{u(o).nodeValue=w[0],o.value=w[1],o.parentElement.style.display=w[2]?"none":"",u(t).nodeValue=D[0],t.value=D[1],t.parentElement.style.display=D[2]?"none":""},y=w=>{var l,g,O;const D=w===h,L=m[w];switch(L){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const A=D?i.slice(1).join(" ")??"":"";f(["無効","",!0],[E().label,A,!1]);break;case"#OCTAVE":case"#VELOCITY":f(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const M=L==="#WAV9",b=D?((l=i.slice(1).join(" "))==null?void 0:l.split(","))??[]:[];f(["波形番号",b[0]??0,!1],M?["初期変位,ループフラグ,データ",`${b[1]??0},${b[2]??0},${b[3]??""}`,!1]:["データ",b[1]??"",!1]),o.min=0,o.max=M?15:31;break;case"#OPM":case"#OPN":f(["音色番号",D?((g=i[0])==null?void 0:g.split("@")[1])??0:0,!1],["データ",D?((O=i.slice(1).join(" "))==null?void 0:O.slice(1,-1))??"":"",!1]),o.min=0,o.max=127;break;case"#FMGAIN":f(["音量利得",D?i[1].replace(`
`,"")??91:91,!1],["無効","",!0]),o.min=-127,o.max=127;break;case"#USING":f(["和音重ね数",D?i[2].replace(`
`,"")??2:2,!1],["無効","",!0]),o.min=1,o.max="";break}};y(h),a.addEventListener("change",w=>{y(w.target.selectedIndex)})},on:{"set-meta-data":(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r;e.ariaLabel=a.label,e.dataset.metaData=`${a.value.replace("{n}",o).replace("{desc}",t)}`}}},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action",value:e=>e}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}],on:{"set-other-action":(e,r)=>{const{"other-action":a}=r;e.dataset.otherAction=a,e.textContent=a.length>4?"…":a}}},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}],on:{"remove-left":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(K=null;[...o].includes(r);){const t=a.firstElementChild;Ee.pushState({operation:"remove",removedElem:t,removedIndex:0,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere()},"remove-right":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(K=null;[...o].includes(r);){const t=a.lastElementChild;Ee.pushState({operation:"remove",removedElem:t,removedIndex:o.length-1,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere()}}},step:{title:"ステップ音価記録",description:`ステップ音価記録は、簡単に音価を指定できる機能です。

各トラックの空白部分をテンポよくクリック、またはスペースキーを押して最初の音符から順に音価を決定します。
途中から指定をやり直したいときは、やり直したい音符をクリックすることでそこからやり直せます。

この画面は、Shiftキーを押しながらステップ音価記録ブロックをクリックすることで再度表示できます。`,buttons:[{className:"primaly",value:"set-step",textContent:"開始"},{value:"cancel-step",textContent:"やめる"}],on:{"set-step":()=>{Or=!0,Oe=!0},"cancel-step":()=>{Oe=!1}}},mtcSync:{title:"MTC同期設定",description:`他のMIDIシーケンサー等と再生を同期できます。
MTC Senderとして動作します。`,inputs:[{label:"送信先MIDIデバイス",select:{"":"---デバイスがありません---"},name:"select-mtc-sync",disabled:!0},{label:"再生開始オフセットミリ秒",type:"number",name:"start-msec",value:()=>Le.startMSec||0,min:"0",disabled:!0}],buttons:[{className:"primaly",value:"set-sync-mtc",textContent:"開始",disabled:!0},{value:"cancel-sync-mtc",textContent:"やめる"}],run:async(e,r)=>{const{"select-mtc-sync":a,"start-msec":o}=r,t=be.buttons.querySelector('button[value="set-sync-mtc"]'),i=Le.outputs?Le.outputs:await Le.init();if(i.length===0)return;a.textContent="",a.disabled=!1,o.disabled=!1,t.disabled=!1;for(const h of i){const u=document.createElement("option");u.value=h.id,u.textContent=h.name,a.appendChild(u)}let m=i.indexOf(Le.output);m===-1&&(m=0),a.selectedIndex=m},on:{"set-sync-mtc":(e,r)=>{const{"select-mtc-sync":a,"start-msec":o}=r,t=Le.outputs.find(m=>m.id===a.value),i=o;Le.configure({output:t,startMSec:i}),He=!0},"cancel-sync-mtc":()=>{He=!1}}}});ce(this,Ke,e=>{let r=e.valueAsNumber,a=Me.findIndex(o=>o===r);e.addEventListener("input",()=>{const o=e.valueAsNumber;o!==r&&(o===0?(a=-1,e.value=""):o>r||Number.isNaN(r)?e.value=Me[++a]:o<r&&(e.value=Me[--a]),r=e.valueAsNumber)})});ce(this,Ut,e=>{const r=C(this,Et)[e];C(this,Vt).call(this,r.title),C(this,Wt).call(this,r.description),C(this,zt).call(this,r.inputs),C(this,Ht).call(this,r.buttons),C(this,qt).call(this,r.run),C(this,Yt).call(this,r.on)});ce(this,Vt,e=>{be._title.textContent=e||""});ce(this,Wt,e=>{if(be.description.textContent="",e){const r=document.createElement("p");r.innerText=e,be.description.appendChild(r)}});ce(this,zt,e=>{be.inputs.textContent="",e==null||e.forEach(r=>{const a="select"in r,o=document.createElement(a?"select":"input");let t=o;Object.entries(r).forEach(([i,m])=>{if(i==="label"){const h=document.createElement("label");h.textContent=m,h.appendChild(o),t=h}else i==="select"?Object.entries(m).forEach(([h,u])=>{const E=document.createElement("option");E.value=h,E.textContent=u,o.appendChild(E)}):i==="value"&&typeof m=="function"?o.value=m(this.mmlText,this.item):o[i]=m}),be.inputs.appendChild(t)})});ce(this,Ht,e=>{be.buttons.textContent="",e==null||e.forEach(r=>{const a=document.createElement("button");Object.entries(r).forEach(([o,t])=>{a[o]=t}),be.buttons.appendChild(a)})});ce(this,qt,e=>{e&&e(this.mmlText,C(this,Gt).call(this))});ce(this,Yt,e=>{be.addEventListener("submit",r=>{const a=this.item,o=r.submitter.value,t=C(this,Kt).call(this),i=JSON.parse(JSON.stringify(a.dataset));console.log(o),e[o](a,t);const m=JSON.parse(JSON.stringify(a.dataset));JSON.stringify(i)!==JSON.stringify(m)&&Ee.pushState({operation:"valueChange",target:a,beforeChange:i,afterChange:m}),this.resolve()},{once:!0})});ce(this,Gt,()=>Object.fromEntries([...be.elements].map(e=>[e.name,e])));ce(this,Kt,()=>Object.fromEntries([...be.elements].map(r=>{var a;return r instanceof HTMLSelectElement?[r.name,{label:(a=r.selectedOptions[0])==null?void 0:a.label,value:r.value}]:[r.name,r.value]})));this.item=null,this.type=null,this.mmlText=null,this.resolve=null}async prompt(e,r){if(this.item=e,this.type=r||Object.keys(C(this,Et)).find(a=>a in e.dataset),!this.type){console.warn("No dialog type found for the item:",e);return}switch(this.mmlText=e.dataset[this.type],this.type){case"repeatStartEnd":if(this.mmlText===":/"){const o=(()=>{var i;let t=e.parentElement;for(;t&&!((i=t.firstElementChild.dataset.repeatStartEnd)!=null&&i.startsWith("/:"));)t=t.previousElementSibling;return(t==null?void 0:t.firstElementChild)||null})();if(o)e=o;else{const t=T.activeTrack,i=document.createElement("li"),h=Se.querySelector(".repeat-start-end").cloneNode(!0);i.appendChild(h),t.insertBefore(i,e.parentElement),e=h}this.mmlText=e.dataset.repeatStartEnd}break;case"macroDef":if(this.mmlText===";")return;break}return C(this,Ut).call(this,this.type),Ge.showModal(),new Promise(a=>this.resolve=a)}}Et=new WeakMap,Ke=new WeakMap,Ut=new WeakMap,Vt=new WeakMap,Wt=new WeakMap,zt=new WeakMap,Ht=new WeakMap,qt=new WeakMap,Yt=new WeakMap,Gt=new WeakMap,Kt=new WeakMap;mr.FlMML.prepare(".editor");const xe=new mr.FlMML({workerURL:ka}),Q=new fs;gn.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const T=new ms(de,ae),Ee=new hs,Be=new vs(be),gs={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},ys=new Pn({i18n:gs,locale:"ja"});as.polyfill({holdToDrag:500});is();const ht=n=>`<span class="material-icons">${n}</span>`,jr=ht("play_arrow")+"再生",bs=ht("stop")+"停止",Dn=()=>{const n=[...ae.querySelectorAll(".track button")].findIndex(e=>e.classList.contains("play-from-here"));T.playRendering(n),He&&Le.start()},Es=()=>{us.innerText=xe.getWarnings()};xe.addEventListener("compilecomplete",Es);const Ss=()=>{Ot.innerHTML=jr,T.stopRendering(),He&&Le.stop(),xe.removeEventListener("compilecomplete",Dn),Pt.disabled=!1};xe.addEventListener("complete",Ss);Q.onChange=(n,e)=>{ds.innerHTML=e?`<pre><code>${ss(os(e))}</code></pre>`:"(なし)";const r=!!n.length;Ae.disabled=qe.disabled=!r};Q.onError=(n,e)=>{alert(n+`
`+e)};T.checkSavedBlocksData();const Pe=(n,e={})=>{var l;const r=()=>{let g=n.parentElement;for(;g&&!("noteValue"in g.firstElementChild.dataset);)g=g.previousElementSibling;return(g==null?void 0:g.firstElementChild)||null},a=()=>{var O;let g=n.parentElement;for(;g&&!((O=g.firstElementChild.dataset.octave)!=null&&O.startsWith("o"));)g=g.previousElementSibling;return(g==null?void 0:g.firstElementChild)||null},o=()=>{var A;let g=n.parentElement.nextElementSibling,O="";for(;g&&((A=g.firstElementChild.dataset.tieSlur)!=null&&A.match(/&[0-9]+\.*/));)O+=g.firstElementChild.dataset.tieSlur,g=g.nextElementSibling;return O},t=((l=r())==null?void 0:l.dataset.noteValue)||"",i=a(),m=i?[...T.activeTrack.children].indexOf(i.parentElement):0,h=(i==null?void 0:i.dataset.octave)||"",u=[...T.activeTrack.children].indexOf(n.parentElement),E=[...T.activeTrack.children].slice(m,u).filter(g=>"tonePitch"in g.firstElementChild.dataset||"octave"in g.firstElementChild.dataset&&!g.firstElementChild.dataset.octave.startsWith("o")).map(g=>((g.firstElementChild.dataset.tonePitch||g.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),f={down:">",up:"<"},y=(g,O)=>(g.match(new RegExp(O,"g"))||[]).length,w=(()=>{const g=-y(E,f.down)+y(E,f.up);return g<0?f.down.repeat(-g):g>0?f.up.repeat(g):""})(),D=o(),L=e.noteValue?n.dataset.tonePitch.replace(/[0-9]+\.*/,"")+e.noteValue:n.dataset.tonePitch;xe.play(n.dataset.tone+t+h+w+L+D)};Ee.onPopstate=n=>{const e=n.data,r=a=>!!e.parent.closest("#"+a);switch(n.reason){case"undo":switch(e==null?void 0:e.operation){case"append":Q.delete(e.index);break;case"delete":Q.insert(e.index,e.mmlText);break;case"rewrite":Q.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere());break;case"move":const a=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(a,e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere());break;case"valueChange":for(const[o,t]of Object.entries(e.beforeChange))e.target.dataset[o]=t;"tone"in e.target.dataset&&Pe(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere());break;case"clear":e.tonesChildren.forEach(o=>{de.querySelector("ul").appendChild(o)}),e.musicalScoreChildren.forEach(o=>{ae.insertBefore(o,Re)}),K=e.lastTouchedButton,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":Q.append(e.mmlText);break;case"delete":Q.delete(e.index);break;case"rewrite":Q.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere()),"tonePitch"in K.dataset&&(Pe(K),K.classList.add("bounce"));break;case"move":const a=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(a,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere());break;case"valueChange":for(const[t,i]of Object.entries(e.afterChange))e.target.dataset[t]=i;"tone"in e.target.dataset&&Pe(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);break;case"remove":const o=e.removedElem.className;e.removedElem.remove(),r("tones")&&ae.querySelectorAll(`[class*="${o}"]`).forEach(t=>{t.parentElement.remove()}),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere();break;case"clear":de.querySelector("ul").textContent="",ae.querySelectorAll(".track").forEach((t,i)=>{i?t.remove():(t.textContent="",T.activeTrack=t)}),K=null,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);break}break}};const Br=()=>{const n=[...de.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!n.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",n=>{var r;const e=n.ctrlKey||Jt.checked;switch((r=n.key)==null?void 0:r.toLowerCase()){case" ":Oe?(n.preventDefault(),Rt()):document.activeElement.tagName.toLowerCase()!=="input"&&(n.preventDefault(),Ot.click());break;case"s":e&&(n.preventDefault(),!qe.disabled&&qe.click());break;case"o":e&&(n.preventDefault(),!kn.disabled&&kn.click());break;case"z":e&&Ee.undo();break;case"y":e&&Ee.redo();break}});Ye.addEventListener("click",async n=>{const e=n.ctrlKey||Jt.checked,r=o=>!!n.target.closest("#"+o),a=n.target.tagName.toLowerCase()==="button";if(![de,Se,ae].some(o=>o.classList.contains("no-op"))){if(r("tones"))if(a)K=n.target,await Be.prompt(n.target,"tone"),xe.play(n.target.dataset.tone+n.target.dataset.tonePitch),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);else{const o=de.querySelector("ul"),t=document.createElement("li"),m=`<button class="material-icons note ${Br()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;t.innerHTML=m;const h=t.firstElementChild;o.appendChild(t),K=h,xe.play(h.dataset.tone+h.dataset.tonePitch),Ee.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o})}else if(r("action")){if(a){if("otherAction"in n.target.dataset)await Be.prompt(n.target);else if("step"in n.target.dataset){Or&&!n.shiftKey?Oe=!Oe:await Be.prompt(n.target),Oe?(n.target.classList.add("enable"),n.target.ariaLabel="ステップ音価記録(有効)",K=T.activeTrack.querySelector("button")):(n.target.classList.remove("enable"),n.target.ariaLabel="ステップ音価記録(無効)",Pr(),xe.stop(),clearTimeout(In));return}else if("mtcSync"in n.target.dataset){He?(Le.stop(),He=!1):await Be.prompt(n.target,"mtcSync"),He?(n.target.classList.add("enable"),n.target.ariaLabel="MTC同期(有効)"):(n.target.classList.remove("enable"),n.target.ariaLabel="MTC同期(無効)");return}const o=T.activeTrack,t=document.createElement("li"),i=n.target.cloneNode(!0);if(["metaData","macroDef","macroUse"].some(m=>m in i.dataset)&&await Be.prompt(i),"tieSlur"in i.dataset?i.ariaLabel="スラー":"repeatStartEnd"in i.dataset?(i.classList.remove("material-icons"),i.ariaLabel="リピート開始",i.textContent="◆",i.dataset.repeatStartEnd="/:"):"polyStartEnd"in i.dataset?(i.dataset.polyStartEnd="[",i.textContent="["):"macroDef"in i.dataset?i.textContent="$=":"playFromHere"in i.dataset&&(ae.querySelectorAll(".track button").forEach(m=>{m.classList.add("inactive")}),Ae.disabled=qe.disabled=!0),t.appendChild(i),o.appendChild(t),K=i,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere(),Ee.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),["repeatStartEnd","polyStartEnd","macroDef"].some(m=>m in K.dataset)){const m=document.createElement("li"),h=n.target.cloneNode(!0);"repeatStartEnd"in K.dataset?(h.ariaLabel="リピート終了",h.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(h.dataset.polyStartEnd="]",h.textContent="]"):"macroDef"in K.dataset&&(h.dataset.macroDef=";",h.textContent=";"),m.appendChild(h),K.parentElement.insertAdjacentElement("afterend",m),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q),Ee.pushState({operation:"copy",toIndex:-1,newElem:m,parent:o})}}}else if(r("musical-score")){if(a&&n.target!==Re&&n.target!==st)n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Oe||("tone"in n.target.dataset?(Pe(n.target),Ce(n.target,"bounce"),e&&(await Be.prompt(n.target,"tonePitch"),Pe(n.target))):await Be.prompt(n.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)),K=n.target;else if(n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Oe)Rt();else if(K){const o=T.activeTrack,t=document.createElement("li"),i=K.cloneNode(!0);if("repeatStartEnd"in i.dataset&&(i.classList.remove("material-icons"),i.ariaLabel="リピート開始",i.textContent="◆",i.dataset.repeatStartEnd="/:"+(i.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),t.appendChild(i),o.appendChild(t),K=i,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere(),Ee.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),"tonePitch"in i.dataset)i.dataset.tonePitch=i.dataset.tonePitch.replace(/[><]+/,""),Pe(i),i.classList.add("bounce");else if("repeatStartEnd"in K.dataset){const m=document.createElement("li"),h=K.cloneNode(!0);h.classList.add("material-icons"),h.ariaLabel="リピート終了",h.textContent="repeat",h.dataset.repeatStartEnd=":/",m.appendChild(h),K.parentElement.insertAdjacentElement("afterend",m),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q),Ee.pushState({operation:"copy",toIndex:-1,newElem:m,parent:o})}}}}});Ye.addEventListener("contextmenu",n=>{var o,t,i,m;if(Oe)return;const e=h=>h.closest("#tones, #musical-score"),r=h=>!!n.target.closest("#"+h),a=n.target.tagName.toLowerCase()==="button";if(!((o=e(n.target))!=null&&o.classList.contains("no-op"))&&e(n.target)){const h=a&&n.target!==Re&&n.target!==st?n.target:K;if(!h||e(h)!==e(n.target))return;n.preventDefault(),T.activeTrack=h.closest(".track")||T.activeTrack;const u=h.parentElement,E=h.className,f=((t=h.closest("#tones"))==null?void 0:t.querySelector("ul"))||T.activeTrack,y=[...f.children].indexOf(u);if(K=((i=u.previousElementSibling)==null?void 0:i.firstElementChild)||((m=u.nextElementSibling)==null?void 0:m.firstElementChild)||null,Ee.pushState({operation:"remove",removedElem:u,removedIndex:y,parent:f}),r("tones"))ae.querySelectorAll(`[class*="${E}"]`).forEach(w=>{w.parentElement.remove()});else if("macroDef"in h.dataset){const w=(h.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];ae.querySelectorAll(`[data-macro-use^="${w}"]`).forEach(D=>{D.parentElement.remove()})}else"playFromHere"in h.dataset&&(ae.querySelectorAll(".inactive").forEach(w=>{w.classList.remove("inactive")}),Ae.disabled=qe.disabled=!1);u.remove(),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere()}});let Mt=null,jn=!1,Ft=null;Ye.addEventListener("touchstart",n=>{Mt=[...n.touches].at(-1).pageY,Ft=setTimeout(()=>{jn=!0},500)});const Rr=n=>{if(Oe)return;const e=n.ctrlKey||Jt.checked,r=i=>!!n.target.closest("#"+i),a=n.target.tagName.toLowerCase()==="button";if(n.type==="touchmove"){const i=[...n.touches].at(-1).pageY;if(jn){n.cancelable&&n.preventDefault();return}else if(i-Mt<-30)n.deltaY=-1,clearTimeout(Ft);else if(i-Mt>30)n.deltaY=1,clearTimeout(Ft);else{n.cancelable&&n.preventDefault();return}Mt=i}const o=n.deltaY<0;let t=a&&n.target!==Re&&n.target!==st?n.target:(K==null?void 0:K.closest("#musical-score"))&&K;if(t){if(r("musical-score")){if(ae.classList.contains("no-op"))return;n.preventDefault();let i=JSON.parse(JSON.stringify(t.dataset));if(!e&&"tone"in t.dataset){const h=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],u={down:">",up:"<"},E=t.dataset.tonePitch,f=h.findIndex(g=>E.match(/[a-g]\+?/)[0]===g),y=(g,O)=>(g.match(new RegExp(O,"g"))||[]).length,w={down:y(E,u.down),up:y(E,u.up)},D=u.down.repeat(w.down)+u.up.repeat(w.up),L=(E.match(/[0-9]+/)||[""])[0],l=(t.dataset.tonePitch.match(/\.+/)||[""])[0];o?f===h.length-1?w.down?t.dataset.tonePitch=D.substring(1)+h.at(0)+L+l:t.dataset.tonePitch=D+u.up+h.at(0)+L+l:t.dataset.tonePitch=D+h[f+1]+L+l:f===0?w.up?t.dataset.tonePitch=D.substring(1)+h.at(-1)+L+l:t.dataset.tonePitch=D+u.down+h.at(-1)+L+l:t.dataset.tonePitch=D+h[f-1]+L+l,Pe(t)}else{const h=o?1:-1,u=(E,f=-1/0,y=1/0)=>E+h<f||E+h>y?0:h;if(e&&"tonePitch"in t.dataset){const E=Number((t.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),f=(t.dataset.tonePitch.match(/\.+/)||[""])[0],y=u(E,0,384),w=Me.findIndex(L=>L===E),D=E+y!==0?Me[w+y]:"";t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+D+f,Pe(t)}else if("tempo"in t.dataset){const E=Number(t.dataset.tempo.replace("t","")),f=u(E,0);t.dataset.tempo="t"+(E+f*10)}else if("noteValue"in t.dataset){const E=Number((t.dataset.noteValue.match(/[0-9]+/)||[""])[0]),f=u(E,1,384),y=Me.findIndex(w=>w===E);t.dataset.noteValue=t.dataset.noteValue.replace(/[0-9]+/,Me[y+f])}else if("rest"in t.dataset){const E=Number((t.dataset.rest.match(/[0-9]+/)||[""])[0]),f=(t.dataset.rest.match(/\.+/)||[""])[0],y=u(E,0,384),w=Me.findIndex(L=>L===E),D=E+y!==0?Me[w+y]:"";t.dataset.rest="r"+D+f}else if("octave"in t.dataset)if(t.dataset.octave.startsWith("o")){const f=Number(t.dataset.octave.replace("o","")),y=u(f,0,8);t.dataset.octave="o"+(f+y)}else{const f=(t.dataset.octave.match(/<+/)||[""])[0].length-(t.dataset.octave.match(/>+/)||[""])[0].length,y=u(f,-8,8);t.dataset.octave=f+y>0?"<".repeat(f+y):">".repeat(-(f+y))}else if("velocity"in t.dataset)if(t.dataset.velocity.startsWith("@v")){const f=Number(t.dataset.velocity.replace("@v","")),y=u(f,0,127);t.dataset.velocity="@v"+(f+y)}else{const f=Number((t.dataset.velocity.match(/[0-9]+/)||[""])[0])*(t.dataset.velocity.startsWith("(")?1:-1),y=u(f,-127,127);t.dataset.velocity=(f+y>=0?"(":")")+Math.abs(f+y)}else if("noteShift"in t.dataset){const E=Number((t.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),f=h;t.dataset.noteShift=t.dataset.noteShift.match(/@?ns/)[0]+(E+f)}else if("detune"in t.dataset){const E=Number(t.dataset.detune.replace("@d","")),f=h;t.dataset.detune="@d"+(E+f)}else if("tieSlur"in t.dataset){const E=Number((t.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),f=(t.dataset.tieSlur.match(/\.+/)||[""])[0],y=u(E,0,384),w=Me.findIndex(L=>L===E),D=E+y!==0?Me[w+y]:"";t.dataset.tieSlur="&"+D+f,t.dataset.tieSlur==="&"?t.ariaLabel="スラー":t.ariaLabel="タイ"}else if("repeatStartEnd"in t.dataset){if(t.dataset.repeatStartEnd===":/"){const D=(()=>{var l;let L=t.parentElement;for(;L&&!((l=L.firstElementChild.dataset.repeatStartEnd)!=null&&l.startsWith("/:"));)L=L.previousElementSibling;return(L==null?void 0:L.firstElementChild)||null})();if(D)t=D;else{const L=T.activeTrack,l=document.createElement("li"),O=Se.querySelector(".repeat-start-end").cloneNode(!0);l.appendChild(O),L.insertBefore(l,t.parentElement),t=O}i=JSON.parse(JSON.stringify(t.dataset))}const E=Number((t.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),f=u(E,-1),y=E+f!==-1?E+f:"";t.dataset.repeatStartEnd="/:"+y}}const m=JSON.parse(JSON.stringify(t.dataset));JSON.stringify(i)!==JSON.stringify(m)&&Ee.pushState({operation:"valueChange",target:t,beforeChange:i,afterChange:m}),K=t,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)}}else return};Ye.addEventListener("wheel",Rr);Ye.addEventListener("touchmove",Rr);Ye.addEventListener("touchend",()=>{clearTimeout(Ft),jn=!1});let ft={};Ye.addEventListener("dragstart",n=>{ft={from:n.target.nodeType===1&&n.target.closest("#tones, #action, #musical-score"),item:n.target},n.dataTransfer.effectAllowed="copyMove"});let dr=null;[de,Se,ae].forEach(n=>{const e=t=>{const i=t.ctrlKey||Jt.checked,{from:m=null}=ft,h=t.dataTransfer;switch(m){case de:switch(n){case de:t.preventDefault(),i?h.dropEffect="copy":h.dropEffect="move";break;case Se:break;case ae:t.preventDefault(),h.dropEffect="copy";break}break;case Se:switch(n){case de:break;case Se:break;case ae:t.preventDefault(),h.dropEffect="copy";break}break;case ae:switch(n){case de:break;case Se:break;case ae:t.preventDefault(),i?h.dropEffect="copy":h.dropEffect="move";break}break}dr=h.dropEffect};n.addEventListener("dragover",e);const r=t=>{const{from:i=null}=ft,m=t.target.tagName.toLowerCase()==="button",h=()=>t.target.classList.add("droppable");switch(i){case de:switch(n){case de:t.preventDefault(),m&&h();break;case Se:break;case ae:t.preventDefault(),m&&h();break}break;case Se:switch(n){case de:break;case Se:break;case ae:t.preventDefault(),m&&h();break}break;case ae:switch(n){case de:break;case Se:break;case ae:t.preventDefault(),m&&h();break}break}};n.addEventListener("dragenter",r);const a=t=>{const{from:i=null}=ft,m=t.target.tagName.toLowerCase()==="button",h=()=>t.target.classList.remove("droppable");switch(i){case de:switch(n){case de:m&&h();break;case Se:break;case ae:m&&h();break}break;case Se:switch(n){case de:break;case Se:break;case ae:m&&h();break}break;case ae:switch(n){case de:break;case Se:break;case ae:m&&h();break}break}};n.addEventListener("dragleave",a),n.addEventListener("drop",async t=>{var w,D;if(t.preventDefault(),(w=t.dataTransfer.items)!=null&&w.length)return;t.dataTransfer.dropEffect=t.dataTransfer.dropEffect!=="none"?t.dataTransfer.dropEffect:dr;const{from:i,item:m}=ft,h=((D=t.target.closest("#tones"))==null?void 0:D.querySelector("ul"))||t.target.closest(".track")||T.activeTrack,u=[...n.querySelectorAll("button")].indexOf(m),E=[...n.querySelectorAll("button")].indexOf(t.target),f=t.target.tagName.toLowerCase()==="button";let y;switch(t.dataTransfer.dropEffect){case"copy":const L=document.createElement("li"),l=m.cloneNode(!0);if(n===de){const g=[...m.classList].find(O=>O.includes("note-"));l.classList.replace(g,Br())}else i===Se&&("tieSlur"in l.dataset?l.ariaLabel="スラー":["metaData","macroDef","macroUse","otherAction"].some(g=>g in l.dataset)&&await Be.prompt(l));"repeatStartEnd"in l.dataset?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"+(l.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in l.dataset?(l.dataset.polyStartEnd="[",l.textContent="["):"macroDef"in l.dataset&&(l.dataset.macroDef===";"&&(l.dataset.macroDef="$="),l.textContent="$="),L.appendChild(l),y=L;break;case"move":y=m.parentElement;break}if(f&&t.target.id!=="add-track"&&t.target.id!=="remove-track"){const L=t.dataTransfer.dropEffect==="copy"||E<u?"beforebegin":"afterend";t.target.parentElement.insertAdjacentElement(L,y)}else h.appendChild(y);switch(K=y.firstElementChild,n===ae&&(T.activeTrack=h,T.blocksDataUpdate(),t.dataTransfer.dropEffect==="move"&&T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere(),"tonePitch"in K.dataset&&(K.dataset.tonePitch=K.dataset.tonePitch.replace(/[><]+/,""),Pe(K),K.classList.add("bounce"))),t.dataTransfer.dropEffect){case"copy":Ee.pushState({operation:"copy",toIndex:E,newElem:y,parent:h});break;case"move":Ee.pushState({operation:"move",fromIndex:u,toIndex:E,elem:y,parent:h});break}if(t.dataTransfer.dropEffect==="copy"&&["repeatStartEnd","polyStartEnd","macroDef"].some(L=>L in K.dataset)){const L=document.createElement("li"),l=m.cloneNode(!0);"repeatStartEnd"in K.dataset?(l.classList.add("material-icons"),l.ariaLabel="リピート終了",l.textContent="repeat",l.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(l.dataset.polyStartEnd="]",l.textContent="]"):"macroDef"in K.dataset&&(l.dataset.macroDef=";",l.textContent=";"),L.appendChild(l),y.insertAdjacentElement("afterend",L),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q),Ee.pushState({operation:"copy",toIndex:E+1,newElem:L,parent:h})}});const o=t=>{[...document.getElementsByClassName("droppable")].forEach(i=>{i.classList.remove("droppable")})};n.addEventListener("dragend",o)});Ye.addEventListener("animationend",n=>{n.target.classList.remove("bounce"),n.target.classList.remove("pop")});Re.addEventListener("click",n=>{n.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),T.activeTrack=e,ae.insertBefore(e,Re)});st.addEventListener("click",n=>{n.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),T.activeTrack=r,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)});Ge.addEventListener("pointerdown",n=>{n.target===Ge&&Ge.addEventListener("pointerup",e=>{e.target===Ge&&Ge.close()},{once:!0})});Ge.addEventListener("close",()=>{switch(Be.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});Ot.addEventListener("click",()=>{const n=xe.isPlaying();n?(xe.stop(),T.stopRendering(),He&&Le.stop(),xe.removeEventListener("compilecomplete",Dn),Pt.disabled=!1):(xe.play(Q.getMml()),xe.addEventListener("compilecomplete",Dn),Pt.disabled=!0),Ot.innerHTML=n?jr:bs});Pt.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const n=[...ae.children];n.pop(),Ee.pushState({operation:"clear",tonesChildren:[...de.querySelector("ul").children],musicalScoreChildren:n,lastTouchedButton:K}),de.querySelector("ul").textContent="";const e=de.querySelector("ul"),r=document.createElement("li"),a='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=a;const o=r.firstElementChild;e.appendChild(r),K=o,ae.querySelectorAll(".track").forEach((t,i)=>{i?t.remove():(t.textContent="",T.activeTrack=t)}),xe.play(""),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)}});Ae.addEventListener("click",async n=>{const e=n.shiftKey?JSON.stringify(T.blocksData):Q.getMml(),r=Ae.innerHTML;Ae.disabled=!0,navigator.clipboard.writeText(e).then(()=>{Ae.disabled=!0,Ae.innerHTML=ht("content_copy")+"コピーしました",n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータをコピーしました。"),setTimeout(()=>{Ae.innerHTML=r,Ae.disabled=!1},1500)}).catch(a=>alert(`コピーできませんでした
`+a))});Ve.addEventListener("click",()=>{const n=Ve.innerHTML;Ve.disabled=!0,navigator.clipboard.readText().then(e=>{Ve.disabled=!0,e?(xn(e)?T.blocksData=JSON.parse(e):(Q.setMml(e.replace(/\r/g,"")),T.importMml(Q)),Ve.innerHTML=ht("content_paste")+"貼り付けました",xn(e)&&alert("JSONブロックデータが貼り付けられました。")):Ve.innerHTML=ht("content_paste")+"内容がありません",setTimeout(()=>{Ve.innerHTML=n,Ve.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});qe.addEventListener("click",n=>{var i;const r=((i=Q.getMmlArr().find(m=>m.startsWith("#TITLE")))==null?void 0:i.split(" ").slice(1).join(" "))??"無題",a=n.shiftKey?JSON.stringify(T.blocksData):Q.getMml(),o=new Blob([a],{type:n.shiftKey?"application/json":"text/plain"}),t=document.createElement("a");t.download=r+(n.shiftKey?".json":".mml"),t.href=URL.createObjectURL(o),t.click(),URL.revokeObjectURL(t.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。"),n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータを保存しました。")});kn.addEventListener("click",()=>{const n=document.createElement("input"),e=new FileReader;n.type="file",n.accept=".mml,.flmml,.txt,.json",n.click(),n.onchange=()=>{e.onload=()=>{const r=e.result;xn(r)?(T.blocksData=JSON.parse(r),alert("JSONブロックデータが読み込まれました。")):(Q.setMml(r.replace(/\r/g,"")),T.importMml(Q))},e.readAsText(n.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");Ee.onPushstate=n=>{jt.disabled=!1,Bt.disabled=!0};jt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=Ee.undo();jt.disabled=!n,Bt.disabled=!e});Bt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=Ee.redo();jt.disabled=!n,Bt.disabled=!e});
