var Rn=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var U=(t,e,r)=>(Rn(t,e,"read from private field"),r?r.call(t):e.get(t)),we=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},xe=(t,e,r,o)=>(Rn(t,e,"write to private field"),o?o.call(t,r):e.set(t,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function r(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(s){if(s.ep)return;s.ep=!0;const n=r(s);fetch(s.href,n)}})();const ca="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var nt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function la(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Kn={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(t,e){(function(r,o){t.exports=o()})(self,function(){return(()=>{var r={587:(n,l,y)=>{var h;(h=(function(u,v){Object.defineProperty(v,"__esModule",{value:!0}),v.MsgTypes=v.SAMPLE_RATE=void 0,v.SAMPLE_RATE=44100,v.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(l,[y,l]))===void 0||(n.exports=h)},581:(n,l,y)=>{var h;(h=(function(u,v){Object.defineProperty(v,"__esModule",{value:!0}),v.FlMMLAudioExportError=void 0;class m extends Error{constructor(...E){super(...E),this.name="FlMMLAudioExportError"}}v.FlMMLAudioExportError=m}).apply(l,[y,l]))===void 0||(n.exports=h)},643:function(n,l,y){var h,u,v=this&&this.__awaiter||function(m,c,E,D){return new(E||(E=Promise))(function(S,d){function I(j){try{N(D.next(j))}catch(x){d(x)}}function R(j){try{N(D.throw(j))}catch(x){d(x)}}function N(j){var x;j.done?S(j.value):(x=j.value,x instanceof E?x:new E(function($){$(x)})).then(I,R)}N((D=D.apply(m,c||[])).next())})};h=[y,l,y(587),y(581),y(158)],(u=(function(m,c,E,D,S){Object.defineProperty(c,"__esModule",{value:!0}),c.FlMMLonHTML5=c.FlMMLAudioExportError=c.FlMML=void 0,Object.defineProperty(c,"FlMMLAudioExportError",{enumerable:!0,get:function(){return D.FlMMLAudioExportError}});const d="flmml-on-html5.worker.js";class I{constructor(N=d){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof N=="string"&&(N={workerURL:N});const j=N.workerURL||d,x=N.infoInterval>=0?N.infoInterval:125;this.bufferSize=N.bufferSize>=128?Math.floor(N.bufferSize-N.bufferSize%128):8192,this.bufferMultiple=N.bufferMultiple>=1?Math.floor(N.bufferMultiple):32,this.lamejsURL=N.lamejsURL,(this.worker=new Worker(N.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${j}")`],{type:"application/javascript"})):j)).addEventListener("message",$=>{this.onMessage($)}),this.setInfoInterval(x)}static initWebAudio(){const N=I.audioCtx=new AudioContext({sampleRate:E.SAMPLE_RATE}),j=N.createBufferSource();j.connect(N.destination),j.start(0),N.resume(),j.stop()}static hookInitWebAudio(N){const j=document.querySelectorAll(N);j.forEach(x=>{x.addEventListener("click",function $(){I.audioCtx||I.initWebAudio(),j.forEach(F=>{F.removeEventListener("click",$,!0)})},!0)})}static prepare(N){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{I.hookInitWebAudio(N)}):I.hookInitWebAudio(N)}onMessage(N){const j=N.data;switch(j.type){case E.MsgTypes.COMPCOMP:this.totalMSec=j.info.totalMSec,this.totalTimeStr=j.info.totalTimeStr,this.warnings=j.info.warnings,this.metaTitle=j.info.metaTitle,this.metaComment=j.info.metaComment,this.metaArtist=j.info.metaArtist,this.metaCoding=j.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case E.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(j),this.trigger("buffering",{progress:j.progress});break;case E.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case E.MsgTypes.SYNCINFO:this._isPlaying=j.info._isPlaying,this._isPaused=j.info._isPaused,this.nowMSec=j.info.nowMSec,this.nowTimeStr=j.info.nowTimeStr,this.voiceCount=j.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case E.MsgTypes.PLAYSOUND:this.playSound();break;case E.MsgTypes.STOPSOUND:this.stopSound();break;case E.MsgTypes.EXPORT:j.data?this.completeAudioExport(j.data):this.errorAudioExport(j.errorMsg)}}boot(){this.worker.postMessage({type:E.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const N=I.audioCtx,j=this.gainNode=N.createGain();j.gain.value=this.volume/127,j.connect(N.destination),v(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise($=>{const F=new FileReader;F.onload=Y=>{N.audioWorklet.addModule(Y.target.result).then($)},F.readAsDataURL(new Blob([S.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const x=this.workletNode=new AudioWorkletNode(N,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});x.connect(j),this.worker.postMessage({type:E.MsgTypes.PLAYSOUND,workletPort:x.port},[x.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:E.MsgTypes.STOPSOUND})}trigger(N,j){const x=this.events[N];if(!x)return;const $={};for(let F in j)$[F]=j[F];for(let F=0,Y=x.length;F<Y;F++)x[F]&&x[F].call(this,$)}exportAudio(N,j,x={}){return I.audioCtx||I.initWebAudio(),this.booted||this.boot(),new Promise(($,F)=>{this.audioExportResolve?F(new D.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:E.MsgTypes.EXPORT,mml:N,format:j},x)),this.audioExportResolve=$,this.audioExportReject=F)})}completeAudioExport(N){this.audioExportResolve&&(this.audioExportResolve(N),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(N){this.audioExportReject&&(this.audioExportReject(new D.FlMMLAudioExportError(N)),this.audioExportResolve=null,this.audioExportReject=null)}play(N){I.audioCtx||I.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:E.MsgTypes.PLAY,mml:N})}stop(){this.worker.postMessage({type:E.MsgTypes.STOP})}pause(){this.worker.postMessage({type:E.MsgTypes.PAUSE})}exportWav(N){return this.exportAudio(N,"wav")}exportMp3(N,j){return this.exportAudio(N,"mp3",{bitrate:j})}setMasterVolume(N){this.volume=N,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(N){this.worker.postMessage({type:E.MsgTypes.SYNCINFO,interval:N})}syncInfo(){this.worker.postMessage({type:E.MsgTypes.SYNCINFO,interval:null})}addEventListener(N,j){let x=this.events[N];x||(x=this.events[N]=[]);for(let $=x.length;$--;)if(x[$]===j)return!1;return x.push(j),!0}removeEventListener(N,j){const x=this.events[N];if(!x)return!1;for(let $=x.length;$--;)if(x[$]===j)return x.splice($,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}c.FlMML=I,c.FlMMLonHTML5=I}).apply(l,h))===void 0||(n.exports=u)},158:(n,l,y)=>{y.r(l),y.d(l,{FlMMLWorkletScript:()=>h});const h='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},o={};function s(n){var l=o[n];if(l!==void 0)return l.exports;var y=o[n]={exports:{}};return r[n].call(y.exports,y,y.exports,s),y.exports}return s.d=(n,l)=>{for(var y in l)s.o(l,y)&&!s.o(n,y)&&Object.defineProperty(n,y,{enumerable:!0,get:l[y]})},s.o=(n,l)=>Object.prototype.hasOwnProperty.call(n,l),s.r=n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},s(643)})()})})(Kn);var Xn=Kn.exports;function ht(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Jn={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(t,e){(function(r){t.exports=r()})(function(){return function r(o,s,n){function l(u,v){if(!s[u]){if(!o[u]){var m=typeof ht=="function"&&ht;if(!v&&m)return m(u,!0);if(y)return y(u,!0);var c=new Error("Cannot find module '"+u+"'");throw c.code="MODULE_NOT_FOUND",c}var E=s[u]={exports:{}};o[u][0].call(E.exports,function(D){var S=o[u][1][D];return l(S||D)},E,E.exports,r,o,s,n)}return s[u].exports}for(var y=typeof ht=="function"&&ht,h=0;h<n.length;h++)l(n[h]);return l}({1:[function(r,o,s){(function(n){var l=n.MutationObserver||n.WebKitMutationObserver,y;if(l){var h=0,u=new l(D),v=n.document.createTextNode("");u.observe(v,{characterData:!0}),y=function(){v.data=h=++h%2}}else if(!n.setImmediate&&typeof n.MessageChannel<"u"){var m=new n.MessageChannel;m.port1.onmessage=D,y=function(){m.port2.postMessage(0)}}else"document"in n&&"onreadystatechange"in n.document.createElement("script")?y=function(){var d=n.document.createElement("script");d.onreadystatechange=function(){D(),d.onreadystatechange=null,d.parentNode.removeChild(d),d=null},n.document.documentElement.appendChild(d)}:y=function(){setTimeout(D,0)};var c,E=[];function D(){c=!0;for(var d,I,R=E.length;R;){for(I=E,E=[],d=-1;++d<R;)I[d]();R=E.length}c=!1}o.exports=S;function S(d){E.push(d)===1&&!c&&y()}}).call(this,typeof nt<"u"?nt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,o,s){var n=r(1);function l(){}var y={},h=["REJECTED"],u=["FULFILLED"],v=["PENDING"];o.exports=m;function m(x){if(typeof x!="function")throw new TypeError("resolver must be a function");this.state=v,this.queue=[],this.outcome=void 0,x!==l&&S(this,x)}m.prototype.catch=function(x){return this.then(null,x)},m.prototype.then=function(x,$){if(typeof x!="function"&&this.state===u||typeof $!="function"&&this.state===h)return this;var F=new this.constructor(l);if(this.state!==v){var Y=this.state===u?x:$;E(F,Y,this.outcome)}else this.queue.push(new c(F,x,$));return F};function c(x,$,F){this.promise=x,typeof $=="function"&&(this.onFulfilled=$,this.callFulfilled=this.otherCallFulfilled),typeof F=="function"&&(this.onRejected=F,this.callRejected=this.otherCallRejected)}c.prototype.callFulfilled=function(x){y.resolve(this.promise,x)},c.prototype.otherCallFulfilled=function(x){E(this.promise,this.onFulfilled,x)},c.prototype.callRejected=function(x){y.reject(this.promise,x)},c.prototype.otherCallRejected=function(x){E(this.promise,this.onRejected,x)};function E(x,$,F){n(function(){var Y;try{Y=$(F)}catch(de){return y.reject(x,de)}Y===x?y.reject(x,new TypeError("Cannot resolve promise with itself")):y.resolve(x,Y)})}y.resolve=function(x,$){var F=d(D,$);if(F.status==="error")return y.reject(x,F.value);var Y=F.value;if(Y)S(x,Y);else{x.state=u,x.outcome=$;for(var de=-1,ie=x.queue.length;++de<ie;)x.queue[de].callFulfilled($)}return x},y.reject=function(x,$){x.state=h,x.outcome=$;for(var F=-1,Y=x.queue.length;++F<Y;)x.queue[F].callRejected($);return x};function D(x){var $=x&&x.then;if(x&&(typeof x=="object"||typeof x=="function")&&typeof $=="function")return function(){$.apply(x,arguments)}}function S(x,$){var F=!1;function Y(fe){F||(F=!0,y.reject(x,fe))}function de(fe){F||(F=!0,y.resolve(x,fe))}function ie(){$(de,Y)}var te=d(ie);te.status==="error"&&Y(te.value)}function d(x,$){var F={};try{F.value=x($),F.status="success"}catch(Y){F.status="error",F.value=Y}return F}m.resolve=I;function I(x){return x instanceof this?x:y.resolve(new this(l),x)}m.reject=R;function R(x){var $=new this(l);return y.reject($,x)}m.all=N;function N(x){var $=this;if(Object.prototype.toString.call(x)!=="[object Array]")return this.reject(new TypeError("must be an array"));var F=x.length,Y=!1;if(!F)return this.resolve([]);for(var de=new Array(F),ie=0,te=-1,fe=new this(l);++te<F;)Ee(x[te],te);return fe;function Ee(L,w){$.resolve(L).then(B,function(_){Y||(Y=!0,y.reject(fe,_))});function B(_){de[w]=_,++ie===F&&!Y&&(Y=!0,y.resolve(fe,de))}}}m.race=j;function j(x){var $=this;if(Object.prototype.toString.call(x)!=="[object Array]")return this.reject(new TypeError("must be an array"));var F=x.length,Y=!1;if(!F)return this.resolve([]);for(var de=-1,ie=new this(l);++de<F;)te(x[de]);return ie;function te(fe){$.resolve(fe).then(function(Ee){Y||(Y=!0,y.resolve(ie,Ee))},function(Ee){Y||(Y=!0,y.reject(ie,Ee))})}}},{1:1}],3:[function(r,o,s){(function(n){typeof n.Promise!="function"&&(n.Promise=r(2))}).call(this,typeof nt<"u"?nt:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,o,s){var n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};function l(a,f){if(!(a instanceof f))throw new TypeError("Cannot call a class as a function")}function y(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var h=y();function u(){try{if(!h||!h.open)return!1;var a=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),f=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!a||f)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function v(a,f){a=a||[],f=f||{};try{return new Blob(a,f)}catch(p){if(p.name!=="TypeError")throw p;for(var i=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,g=new i,b=0;b<a.length;b+=1)g.append(a[b]);return g.getBlob(f.type)}}typeof Promise>"u"&&r(3);var m=Promise;function c(a,f){f&&a.then(function(i){f(null,i)},function(i){f(i)})}function E(a,f,i){typeof f=="function"&&a.then(f),typeof i=="function"&&a.catch(i)}function D(a){return typeof a!="string"&&(console.warn(a+" used as a key, but it is not a string."),a=String(a)),a}function S(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var d="local-forage-detect-blob-support",I=void 0,R={},N=Object.prototype.toString,j="readonly",x="readwrite";function $(a){for(var f=a.length,i=new ArrayBuffer(f),g=new Uint8Array(i),b=0;b<f;b++)g[b]=a.charCodeAt(b);return i}function F(a){return new m(function(f){var i=a.transaction(d,x),g=v([""]);i.objectStore(d).put(g,"key"),i.onabort=function(b){b.preventDefault(),b.stopPropagation(),f(!1)},i.oncomplete=function(){var b=navigator.userAgent.match(/Chrome\/(\d+)/),p=navigator.userAgent.match(/Edge\//);f(p||!b||parseInt(b[1],10)>=43)}}).catch(function(){return!1})}function Y(a){return typeof I=="boolean"?m.resolve(I):F(a).then(function(f){return I=f,I})}function de(a){var f=R[a.name],i={};i.promise=new m(function(g,b){i.resolve=g,i.reject=b}),f.deferredOperations.push(i),f.dbReady?f.dbReady=f.dbReady.then(function(){return i.promise}):f.dbReady=i.promise}function ie(a){var f=R[a.name],i=f.deferredOperations.pop();if(i)return i.resolve(),i.promise}function te(a,f){var i=R[a.name],g=i.deferredOperations.pop();if(g)return g.reject(f),g.promise}function fe(a,f){return new m(function(i,g){if(R[a.name]=R[a.name]||ee(),a.db)if(f)de(a),a.db.close();else return i(a.db);var b=[a.name];f&&b.push(a.version);var p=h.open.apply(h,b);f&&(p.onupgradeneeded=function(k){var A=p.result;try{A.createObjectStore(a.storeName),k.oldVersion<=1&&A.createObjectStore(d)}catch(M){if(M.name==="ConstraintError")console.warn('The database "'+a.name+'" has been upgraded from version '+k.oldVersion+" to version "+k.newVersion+', but the storage "'+a.storeName+'" already exists.');else throw M}}),p.onerror=function(k){k.preventDefault(),g(p.error)},p.onsuccess=function(){var k=p.result;k.onversionchange=function(A){A.target.close()},i(k),ie(a)}})}function Ee(a){return fe(a,!1)}function L(a){return fe(a,!0)}function w(a,f){if(!a.db)return!0;var i=!a.db.objectStoreNames.contains(a.storeName),g=a.version<a.db.version,b=a.version>a.db.version;if(g&&(a.version!==f&&console.warn('The database "'+a.name+`" can't be downgraded from version `+a.db.version+" to version "+a.version+"."),a.version=a.db.version),b||i){if(i){var p=a.db.version+1;p>a.version&&(a.version=p)}return!0}return!1}function B(a){return new m(function(f,i){var g=new FileReader;g.onerror=i,g.onloadend=function(b){var p=btoa(b.target.result||"");f({__local_forage_encoded_blob:!0,data:p,type:a.type})},g.readAsBinaryString(a)})}function _(a){var f=$(atob(a.data));return v([f],{type:a.type})}function W(a){return a&&a.__local_forage_encoded_blob}function H(a){var f=this,i=f._initReady().then(function(){var g=R[f._dbInfo.name];if(g&&g.dbReady)return g.dbReady});return E(i,a,a),i}function q(a){de(a);for(var f=R[a.name],i=f.forages,g=0;g<i.length;g++){var b=i[g];b._dbInfo.db&&(b._dbInfo.db.close(),b._dbInfo.db=null)}return a.db=null,Ee(a).then(function(p){return a.db=p,w(a)?L(a):p}).then(function(p){a.db=f.db=p;for(var k=0;k<i.length;k++)i[k]._dbInfo.db=p}).catch(function(p){throw te(a,p),p})}function J(a,f,i,g){g===void 0&&(g=1);try{var b=a.db.transaction(a.storeName,f);i(null,b)}catch(p){if(g>0&&(!a.db||p.name==="InvalidStateError"||p.name==="NotFoundError"))return m.resolve().then(function(){if(!a.db||p.name==="NotFoundError"&&!a.db.objectStoreNames.contains(a.storeName)&&a.version<=a.db.version)return a.db&&(a.version=a.db.version+1),L(a)}).then(function(){return q(a).then(function(){J(a,f,i,g-1)})}).catch(i);i(p)}}function ee(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function me(a){var f=this,i={db:null};if(a)for(var g in a)i[g]=a[g];var b=R[i.name];b||(b=ee(),R[i.name]=b),b.forages.push(f),f._initReady||(f._initReady=f.ready,f.ready=H);var p=[];function k(){return m.resolve()}for(var A=0;A<b.forages.length;A++){var M=b.forages[A];M!==f&&p.push(M._initReady().catch(k))}var O=b.forages.slice(0);return m.all(p).then(function(){return i.db=b.db,Ee(i)}).then(function(P){return i.db=P,w(i,f._defaultConfig.version)?L(i):P}).then(function(P){i.db=b.db=P,f._dbInfo=i;for(var z=0;z<O.length;z++){var Z=O[z];Z!==f&&(Z._dbInfo.db=i.db,Z._dbInfo.version=i.version)}})}function Se(a,f){var i=this;a=D(a);var g=new m(function(b,p){i.ready().then(function(){J(i._dbInfo,j,function(k,A){if(k)return p(k);try{var M=A.objectStore(i._dbInfo.storeName),O=M.get(a);O.onsuccess=function(){var P=O.result;P===void 0&&(P=null),W(P)&&(P=_(P)),b(P)},O.onerror=function(){p(O.error)}}catch(P){p(P)}})}).catch(p)});return c(g,f),g}function Ne(a,f){var i=this,g=new m(function(b,p){i.ready().then(function(){J(i._dbInfo,j,function(k,A){if(k)return p(k);try{var M=A.objectStore(i._dbInfo.storeName),O=M.openCursor(),P=1;O.onsuccess=function(){var z=O.result;if(z){var Z=z.value;W(Z)&&(Z=_(Z));var oe=a(Z,z.key,P++);oe!==void 0?b(oe):z.continue()}else b()},O.onerror=function(){p(O.error)}}catch(z){p(z)}})}).catch(p)});return c(g,f),g}function T(a,f,i){var g=this;a=D(a);var b=new m(function(p,k){var A;g.ready().then(function(){return A=g._dbInfo,N.call(f)==="[object Blob]"?Y(A.db).then(function(M){return M?f:B(f)}):f}).then(function(M){J(g._dbInfo,x,function(O,P){if(O)return k(O);try{var z=P.objectStore(g._dbInfo.storeName);M===null&&(M=void 0);var Z=z.put(M,a);P.oncomplete=function(){M===void 0&&(M=null),p(M)},P.onabort=P.onerror=function(){var oe=Z.error?Z.error:Z.transaction.error;k(oe)}}catch(oe){k(oe)}})}).catch(k)});return c(b,i),b}function V(a,f){var i=this;a=D(a);var g=new m(function(b,p){i.ready().then(function(){J(i._dbInfo,x,function(k,A){if(k)return p(k);try{var M=A.objectStore(i._dbInfo.storeName),O=M.delete(a);A.oncomplete=function(){b()},A.onerror=function(){p(O.error)},A.onabort=function(){var P=O.error?O.error:O.transaction.error;p(P)}}catch(P){p(P)}})}).catch(p)});return c(g,f),g}function K(a){var f=this,i=new m(function(g,b){f.ready().then(function(){J(f._dbInfo,x,function(p,k){if(p)return b(p);try{var A=k.objectStore(f._dbInfo.storeName),M=A.clear();k.oncomplete=function(){g()},k.onabort=k.onerror=function(){var O=M.error?M.error:M.transaction.error;b(O)}}catch(O){b(O)}})}).catch(b)});return c(i,a),i}function X(a){var f=this,i=new m(function(g,b){f.ready().then(function(){J(f._dbInfo,j,function(p,k){if(p)return b(p);try{var A=k.objectStore(f._dbInfo.storeName),M=A.count();M.onsuccess=function(){g(M.result)},M.onerror=function(){b(M.error)}}catch(O){b(O)}})}).catch(b)});return c(i,a),i}function ae(a,f){var i=this,g=new m(function(b,p){if(a<0){b(null);return}i.ready().then(function(){J(i._dbInfo,j,function(k,A){if(k)return p(k);try{var M=A.objectStore(i._dbInfo.storeName),O=!1,P=M.openKeyCursor();P.onsuccess=function(){var z=P.result;if(!z){b(null);return}a===0||O?b(z.key):(O=!0,z.advance(a))},P.onerror=function(){p(P.error)}}catch(z){p(z)}})}).catch(p)});return c(g,f),g}function ne(a){var f=this,i=new m(function(g,b){f.ready().then(function(){J(f._dbInfo,j,function(p,k){if(p)return b(p);try{var A=k.objectStore(f._dbInfo.storeName),M=A.openKeyCursor(),O=[];M.onsuccess=function(){var P=M.result;if(!P){g(O);return}O.push(P.key),P.continue()},M.onerror=function(){b(M.error)}}catch(P){b(P)}})}).catch(b)});return c(i,a),i}function be(a,f){f=S.apply(this,arguments);var i=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||i.name,a.storeName=a.storeName||i.storeName);var g=this,b;if(!a.name)b=m.reject("Invalid arguments");else{var p=a.name===i.name&&g._dbInfo.db,k=p?m.resolve(g._dbInfo.db):Ee(a).then(function(A){var M=R[a.name],O=M.forages;M.db=A;for(var P=0;P<O.length;P++)O[P]._dbInfo.db=A;return A});a.storeName?b=k.then(function(A){if(A.objectStoreNames.contains(a.storeName)){var M=A.version+1;de(a);var O=R[a.name],P=O.forages;A.close();for(var z=0;z<P.length;z++){var Z=P[z];Z._dbInfo.db=null,Z._dbInfo.version=M}var oe=new m(function(se,ve){var he=h.open(a.name,M);he.onerror=function(Ce){var et=he.result;et.close(),ve(Ce)},he.onupgradeneeded=function(){var Ce=he.result;Ce.deleteObjectStore(a.storeName)},he.onsuccess=function(){var Ce=he.result;Ce.close(),se(Ce)}});return oe.then(function(se){O.db=se;for(var ve=0;ve<P.length;ve++){var he=P[ve];he._dbInfo.db=se,ie(he._dbInfo)}}).catch(function(se){throw(te(a,se)||m.resolve()).catch(function(){}),se})}}):b=k.then(function(A){de(a);var M=R[a.name],O=M.forages;A.close();for(var P=0;P<O.length;P++){var z=O[P];z._dbInfo.db=null}var Z=new m(function(oe,se){var ve=h.deleteDatabase(a.name);ve.onerror=function(){var he=ve.result;he&&he.close(),se(ve.error)},ve.onblocked=function(){console.warn('dropInstance blocked for database "'+a.name+'" until all open connections are closed')},ve.onsuccess=function(){var he=ve.result;he&&he.close(),oe(he)}});return Z.then(function(oe){M.db=oe;for(var se=0;se<O.length;se++){var ve=O[se];ie(ve._dbInfo)}}).catch(function(oe){throw(te(a,oe)||m.resolve()).catch(function(){}),oe})})}return c(b,f),b}var qe={_driver:"asyncStorage",_initStorage:me,_support:u(),iterate:Ne,getItem:Se,setItem:T,removeItem:V,clear:K,length:X,key:ae,keys:ne,dropInstance:be};function wr(){return typeof openDatabase=="function"}var Oe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Tr="~~local_forage_type~",bn=/^~~local_forage_type~([^~]+)~/,ft="__lfsc__:",jt=ft.length,Bt="arbf",Rt="blob",En="si08",Sn="ui08",wn="uic8",Tn="si16",kn="si32",xn="ur16",Cn="ui32",In="fl32",Nn="fl64",An=jt+Bt.length,_n=Object.prototype.toString;function Dn(a){var f=a.length*.75,i=a.length,g,b=0,p,k,A,M;a[a.length-1]==="="&&(f--,a[a.length-2]==="="&&f--);var O=new ArrayBuffer(f),P=new Uint8Array(O);for(g=0;g<i;g+=4)p=Oe.indexOf(a[g]),k=Oe.indexOf(a[g+1]),A=Oe.indexOf(a[g+2]),M=Oe.indexOf(a[g+3]),P[b++]=p<<2|k>>4,P[b++]=(k&15)<<4|A>>2,P[b++]=(A&3)<<6|M&63;return O}function Ut(a){var f=new Uint8Array(a),i="",g;for(g=0;g<f.length;g+=3)i+=Oe[f[g]>>2],i+=Oe[(f[g]&3)<<4|f[g+1]>>4],i+=Oe[(f[g+1]&15)<<2|f[g+2]>>6],i+=Oe[f[g+2]&63];return f.length%3===2?i=i.substring(0,i.length-1)+"=":f.length%3===1&&(i=i.substring(0,i.length-2)+"=="),i}function kr(a,f){var i="";if(a&&(i=_n.call(a)),a&&(i==="[object ArrayBuffer]"||a.buffer&&_n.call(a.buffer)==="[object ArrayBuffer]")){var g,b=ft;a instanceof ArrayBuffer?(g=a,b+=Bt):(g=a.buffer,i==="[object Int8Array]"?b+=En:i==="[object Uint8Array]"?b+=Sn:i==="[object Uint8ClampedArray]"?b+=wn:i==="[object Int16Array]"?b+=Tn:i==="[object Uint16Array]"?b+=xn:i==="[object Int32Array]"?b+=kn:i==="[object Uint32Array]"?b+=Cn:i==="[object Float32Array]"?b+=In:i==="[object Float64Array]"?b+=Nn:f(new Error("Failed to get type for BinaryArray"))),f(b+Ut(g))}else if(i==="[object Blob]"){var p=new FileReader;p.onload=function(){var k=Tr+a.type+"~"+Ut(this.result);f(ft+Rt+k)},p.readAsArrayBuffer(a)}else try{f(JSON.stringify(a))}catch(k){console.error("Couldn't convert value into a JSON string: ",a),f(null,k)}}function xr(a){if(a.substring(0,jt)!==ft)return JSON.parse(a);var f=a.substring(An),i=a.substring(jt,An),g;if(i===Rt&&bn.test(f)){var b=f.match(bn);g=b[1],f=f.substring(b[0].length)}var p=Dn(f);switch(i){case Bt:return p;case Rt:return v([p],{type:g});case En:return new Int8Array(p);case Sn:return new Uint8Array(p);case wn:return new Uint8ClampedArray(p);case Tn:return new Int16Array(p);case xn:return new Uint16Array(p);case kn:return new Int32Array(p);case Cn:return new Uint32Array(p);case In:return new Float32Array(p);case Nn:return new Float64Array(p);default:throw new Error("Unkown type: "+i)}}var $t={serialize:kr,deserialize:xr,stringToBuffer:Dn,bufferToString:Ut};function Ln(a,f,i,g){a.executeSql("CREATE TABLE IF NOT EXISTS "+f.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],i,g)}function Cr(a){var f=this,i={db:null};if(a)for(var g in a)i[g]=typeof a[g]!="string"?a[g].toString():a[g];var b=new m(function(p,k){try{i.db=openDatabase(i.name,String(i.version),i.description,i.size)}catch(A){return k(A)}i.db.transaction(function(A){Ln(A,i,function(){f._dbInfo=i,p()},function(M,O){k(O)})},k)});return i.serializer=$t,b}function Pe(a,f,i,g,b,p){a.executeSql(i,g,b,function(k,A){A.code===A.SYNTAX_ERR?k.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[f.storeName],function(M,O){O.rows.length?p(M,A):Ln(M,f,function(){M.executeSql(i,g,b,p)},p)},p):p(k,A)},p)}function Ir(a,f){var i=this;a=D(a);var g=new m(function(b,p){i.ready().then(function(){var k=i._dbInfo;k.db.transaction(function(A){Pe(A,k,"SELECT * FROM "+k.storeName+" WHERE key = ? LIMIT 1",[a],function(M,O){var P=O.rows.length?O.rows.item(0).value:null;P&&(P=k.serializer.deserialize(P)),b(P)},function(M,O){p(O)})})}).catch(p)});return c(g,f),g}function Nr(a,f){var i=this,g=new m(function(b,p){i.ready().then(function(){var k=i._dbInfo;k.db.transaction(function(A){Pe(A,k,"SELECT * FROM "+k.storeName,[],function(M,O){for(var P=O.rows,z=P.length,Z=0;Z<z;Z++){var oe=P.item(Z),se=oe.value;if(se&&(se=k.serializer.deserialize(se)),se=a(se,oe.key,Z+1),se!==void 0){b(se);return}}b()},function(M,O){p(O)})})}).catch(p)});return c(g,f),g}function Mn(a,f,i,g){var b=this;a=D(a);var p=new m(function(k,A){b.ready().then(function(){f===void 0&&(f=null);var M=f,O=b._dbInfo;O.serializer.serialize(f,function(P,z){z?A(z):O.db.transaction(function(Z){Pe(Z,O,"INSERT OR REPLACE INTO "+O.storeName+" (key, value) VALUES (?, ?)",[a,P],function(){k(M)},function(oe,se){A(se)})},function(Z){if(Z.code===Z.QUOTA_ERR){if(g>0){k(Mn.apply(b,[a,M,i,g-1]));return}A(Z)}})})}).catch(A)});return c(p,i),p}function Ar(a,f,i){return Mn.apply(this,[a,f,i,1])}function _r(a,f){var i=this;a=D(a);var g=new m(function(b,p){i.ready().then(function(){var k=i._dbInfo;k.db.transaction(function(A){Pe(A,k,"DELETE FROM "+k.storeName+" WHERE key = ?",[a],function(){b()},function(M,O){p(O)})})}).catch(p)});return c(g,f),g}function Dr(a){var f=this,i=new m(function(g,b){f.ready().then(function(){var p=f._dbInfo;p.db.transaction(function(k){Pe(k,p,"DELETE FROM "+p.storeName,[],function(){g()},function(A,M){b(M)})})}).catch(b)});return c(i,a),i}function Lr(a){var f=this,i=new m(function(g,b){f.ready().then(function(){var p=f._dbInfo;p.db.transaction(function(k){Pe(k,p,"SELECT COUNT(key) as c FROM "+p.storeName,[],function(A,M){var O=M.rows.item(0).c;g(O)},function(A,M){b(M)})})}).catch(b)});return c(i,a),i}function Mr(a,f){var i=this,g=new m(function(b,p){i.ready().then(function(){var k=i._dbInfo;k.db.transaction(function(A){Pe(A,k,"SELECT key FROM "+k.storeName+" WHERE id = ? LIMIT 1",[a+1],function(M,O){var P=O.rows.length?O.rows.item(0).key:null;b(P)},function(M,O){p(O)})})}).catch(p)});return c(g,f),g}function Or(a){var f=this,i=new m(function(g,b){f.ready().then(function(){var p=f._dbInfo;p.db.transaction(function(k){Pe(k,p,"SELECT key FROM "+p.storeName,[],function(A,M){for(var O=[],P=0;P<M.rows.length;P++)O.push(M.rows.item(P).key);g(O)},function(A,M){b(M)})})}).catch(b)});return c(i,a),i}function Pr(a){return new m(function(f,i){a.transaction(function(g){g.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(b,p){for(var k=[],A=0;A<p.rows.length;A++)k.push(p.rows.item(A).name);f({db:a,storeNames:k})},function(b,p){i(p)})},function(g){i(g)})})}function jr(a,f){f=S.apply(this,arguments);var i=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||i.name,a.storeName=a.storeName||i.storeName);var g=this,b;return a.name?b=new m(function(p){var k;a.name===i.name?k=g._dbInfo.db:k=openDatabase(a.name,"","",0),a.storeName?p({db:k,storeNames:[a.storeName]}):p(Pr(k))}).then(function(p){return new m(function(k,A){p.db.transaction(function(M){function O(oe){return new m(function(se,ve){M.executeSql("DROP TABLE IF EXISTS "+oe,[],function(){se()},function(he,Ce){ve(Ce)})})}for(var P=[],z=0,Z=p.storeNames.length;z<Z;z++)P.push(O(p.storeNames[z]));m.all(P).then(function(){k()}).catch(function(oe){A(oe)})},function(M){A(M)})})}):b=m.reject("Invalid arguments"),c(b,f),b}var Br={_driver:"webSQLStorage",_initStorage:Cr,_support:wr(),iterate:Nr,getItem:Ir,setItem:Ar,removeItem:_r,clear:Dr,length:Lr,key:Mr,keys:Or,dropInstance:jr};function Rr(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function On(a,f){var i=a.name+"/";return a.storeName!==f.storeName&&(i+=a.storeName+"/"),i}function Ur(){var a="_localforage_support_test";try{return localStorage.setItem(a,!0),localStorage.removeItem(a),!1}catch{return!0}}function $r(){return!Ur()||localStorage.length>0}function Fr(a){var f=this,i={};if(a)for(var g in a)i[g]=a[g];return i.keyPrefix=On(a,f._defaultConfig),$r()?(f._dbInfo=i,i.serializer=$t,m.resolve()):m.reject()}function Vr(a){var f=this,i=f.ready().then(function(){for(var g=f._dbInfo.keyPrefix,b=localStorage.length-1;b>=0;b--){var p=localStorage.key(b);p.indexOf(g)===0&&localStorage.removeItem(p)}});return c(i,a),i}function Wr(a,f){var i=this;a=D(a);var g=i.ready().then(function(){var b=i._dbInfo,p=localStorage.getItem(b.keyPrefix+a);return p&&(p=b.serializer.deserialize(p)),p});return c(g,f),g}function zr(a,f){var i=this,g=i.ready().then(function(){for(var b=i._dbInfo,p=b.keyPrefix,k=p.length,A=localStorage.length,M=1,O=0;O<A;O++){var P=localStorage.key(O);if(P.indexOf(p)===0){var z=localStorage.getItem(P);if(z&&(z=b.serializer.deserialize(z)),z=a(z,P.substring(k),M++),z!==void 0)return z}}});return c(g,f),g}function qr(a,f){var i=this,g=i.ready().then(function(){var b=i._dbInfo,p;try{p=localStorage.key(a)}catch{p=null}return p&&(p=p.substring(b.keyPrefix.length)),p});return c(g,f),g}function Yr(a){var f=this,i=f.ready().then(function(){for(var g=f._dbInfo,b=localStorage.length,p=[],k=0;k<b;k++){var A=localStorage.key(k);A.indexOf(g.keyPrefix)===0&&p.push(A.substring(g.keyPrefix.length))}return p});return c(i,a),i}function Hr(a){var f=this,i=f.keys().then(function(g){return g.length});return c(i,a),i}function Gr(a,f){var i=this;a=D(a);var g=i.ready().then(function(){var b=i._dbInfo;localStorage.removeItem(b.keyPrefix+a)});return c(g,f),g}function Kr(a,f,i){var g=this;a=D(a);var b=g.ready().then(function(){f===void 0&&(f=null);var p=f;return new m(function(k,A){var M=g._dbInfo;M.serializer.serialize(f,function(O,P){if(P)A(P);else try{localStorage.setItem(M.keyPrefix+a,O),k(p)}catch(z){(z.name==="QuotaExceededError"||z.name==="NS_ERROR_DOM_QUOTA_REACHED")&&A(z),A(z)}})})});return c(b,i),b}function Xr(a,f){if(f=S.apply(this,arguments),a=typeof a!="function"&&a||{},!a.name){var i=this.config();a.name=a.name||i.name,a.storeName=a.storeName||i.storeName}var g=this,b;return a.name?b=new m(function(p){a.storeName?p(On(a,g._defaultConfig)):p(a.name+"/")}).then(function(p){for(var k=localStorage.length-1;k>=0;k--){var A=localStorage.key(k);A.indexOf(p)===0&&localStorage.removeItem(A)}}):b=m.reject("Invalid arguments"),c(b,f),b}var Jr={_driver:"localStorageWrapper",_initStorage:Fr,_support:Rr(),iterate:zr,getItem:Wr,setItem:Kr,removeItem:Gr,clear:Vr,length:Hr,key:qr,keys:Yr,dropInstance:Xr},Qr=function(f,i){return f===i||typeof f=="number"&&typeof i=="number"&&isNaN(f)&&isNaN(i)},Zr=function(f,i){for(var g=f.length,b=0;b<g;){if(Qr(f[b],i))return!0;b++}return!1},Pn=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},Ze={},jn={},Ye={INDEXEDDB:qe,WEBSQL:Br,LOCALSTORAGE:Jr},ea=[Ye.INDEXEDDB._driver,Ye.WEBSQL._driver,Ye.LOCALSTORAGE._driver],mt=["dropInstance"],Ft=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(mt),ta={description:"",driver:ea.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function na(a,f){a[f]=function(){var i=arguments;return a.ready().then(function(){return a[f].apply(a,i)})}}function Vt(){for(var a=1;a<arguments.length;a++){var f=arguments[a];if(f)for(var i in f)f.hasOwnProperty(i)&&(Pn(f[i])?arguments[0][i]=f[i].slice():arguments[0][i]=f[i])}return arguments[0]}var ra=function(){function a(f){l(this,a);for(var i in Ye)if(Ye.hasOwnProperty(i)){var g=Ye[i],b=g._driver;this[i]=b,Ze[b]||this.defineDriver(g)}this._defaultConfig=Vt({},ta),this._config=Vt({},this._defaultConfig,f),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return a.prototype.config=function(i){if((typeof i>"u"?"undefined":n(i))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var g in i){if(g==="storeName"&&(i[g]=i[g].replace(/\W/g,"_")),g==="version"&&typeof i[g]!="number")return new Error("Database version must be a number.");this._config[g]=i[g]}return"driver"in i&&i.driver?this.setDriver(this._config.driver):!0}else return typeof i=="string"?this._config[i]:this._config},a.prototype.defineDriver=function(i,g,b){var p=new m(function(k,A){try{var M=i._driver,O=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!i._driver){A(O);return}for(var P=Ft.concat("_initStorage"),z=0,Z=P.length;z<Z;z++){var oe=P[z],se=!Zr(mt,oe);if((se||i[oe])&&typeof i[oe]!="function"){A(O);return}}var ve=function(){for(var et=function(sa){return function(){var ia=new Error("Method "+sa+" is not implemented by the current driver"),Bn=m.reject(ia);return c(Bn,arguments[arguments.length-1]),Bn}},Wt=0,oa=mt.length;Wt<oa;Wt++){var zt=mt[Wt];i[zt]||(i[zt]=et(zt))}};ve();var he=function(et){Ze[M]&&console.info("Redefining LocalForage driver: "+M),Ze[M]=i,jn[M]=et,k()};"_support"in i?i._support&&typeof i._support=="function"?i._support().then(he,A):he(!!i._support):he(!0)}catch(Ce){A(Ce)}});return E(p,g,b),p},a.prototype.driver=function(){return this._driver||null},a.prototype.getDriver=function(i,g,b){var p=Ze[i]?m.resolve(Ze[i]):m.reject(new Error("Driver not found."));return E(p,g,b),p},a.prototype.getSerializer=function(i){var g=m.resolve($t);return E(g,i),g},a.prototype.ready=function(i){var g=this,b=g._driverSet.then(function(){return g._ready===null&&(g._ready=g._initDriver()),g._ready});return E(b,i,i),b},a.prototype.setDriver=function(i,g,b){var p=this;Pn(i)||(i=[i]);var k=this._getSupportedDrivers(i);function A(){p._config.driver=p.driver()}function M(z){return p._extend(z),A(),p._ready=p._initStorage(p._config),p._ready}function O(z){return function(){var Z=0;function oe(){for(;Z<z.length;){var se=z[Z];return Z++,p._dbInfo=null,p._ready=null,p.getDriver(se).then(M).catch(oe)}A();var ve=new Error("No available storage method found.");return p._driverSet=m.reject(ve),p._driverSet}return oe()}}var P=this._driverSet!==null?this._driverSet.catch(function(){return m.resolve()}):m.resolve();return this._driverSet=P.then(function(){var z=k[0];return p._dbInfo=null,p._ready=null,p.getDriver(z).then(function(Z){p._driver=Z._driver,A(),p._wrapLibraryMethodsWithReady(),p._initDriver=O(k)})}).catch(function(){A();var z=new Error("No available storage method found.");return p._driverSet=m.reject(z),p._driverSet}),E(this._driverSet,g,b),this._driverSet},a.prototype.supports=function(i){return!!jn[i]},a.prototype._extend=function(i){Vt(this,i)},a.prototype._getSupportedDrivers=function(i){for(var g=[],b=0,p=i.length;b<p;b++){var k=i[b];this.supports(k)&&g.push(k)}return g},a.prototype._wrapLibraryMethodsWithReady=function(){for(var i=0,g=Ft.length;i<g;i++)na(this,Ft[i])},a.prototype.createInstance=function(i){return new a(i)},a}(),aa=new ra;o.exports=aa},{3:3}]},{},[4])(4)})})(Jn);var ua=Jn.exports;const en=la(ua);function pt(t){if(typeof t!="string"||!t)throw new Error("expected a non-empty string, got: "+t)}function qt(t){if(typeof t!="number")throw new Error("expected a number, got: "+t)}const da=1,fa=1,ze="emoji",Je="keyvalue",mn="favorites",ma="tokens",Qn="tokens",ha="unicode",Zn="count",pa="group",va="order",er="group-order",tn="eTag",St="url",Un="skinTone",Qe="readonly",hn="readwrite",tr="skinUnicodes",ga="skinUnicodes",ya="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",ba="en";function Ea(t,e){const r=new Set,o=[];for(const s of t){const n=e(s);r.has(n)||(r.add(n),o.push(s))}return o}function $n(t){return Ea(t,e=>e.unicode)}function Sa(t){function e(r,o,s){const n=o?t.createObjectStore(r,{keyPath:o}):t.createObjectStore(r);if(s)for(const[l,[y,h]]of Object.entries(s))n.createIndex(l,y,{multiEntry:h});return n}e(Je),e(ze,ha,{[Qn]:[ma,!0],[er]:[[pa,va]],[tr]:[ga,!0]}),e(mn,void 0,{[Zn]:[""]})}const nn={},yt={},wt={};function nr(t,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>t(r.result)}async function wa(t){const e=await new Promise((r,o)=>{const s=indexedDB.open(t,da);nn[t]=s,s.onupgradeneeded=n=>{n.oldVersion<fa&&Sa(s.result)},nr(r,o,s)});return e.onclose=()=>pn(t),e}function Ta(t){return yt[t]||(yt[t]=wa(t)),yt[t]}function Me(t,e,r,o){return new Promise((s,n)=>{const l=t.transaction(e,r,{durability:"relaxed"}),y=typeof e=="string"?l.objectStore(e):e.map(u=>l.objectStore(u));let h;o(y,l,u=>{h=u}),l.oncomplete=()=>s(h),l.onerror=()=>n(l.error)})}function pn(t){const e=nn[t],r=e&&e.result;if(r){r.close();const o=wt[t];if(o)for(const s of o)s()}delete nn[t],delete yt[t],delete wt[t]}function ka(t){return new Promise((e,r)=>{pn(t);const o=indexedDB.deleteDatabase(t);nr(e,r,o)})}function xa(t,e){let r=wt[t];r||(r=wt[t]=[]),r.push(e)}const Ca=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function He(t){return t.split(/[\s_]+/).map(e=>!e.match(/\w/)||Ca.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const Ia=2;function rr(t){return t.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Ia)}function Na(t){return t.map(({annotation:r,emoticon:o,group:s,order:n,shortcodes:l,skins:y,tags:h,emoji:u,version:v})=>{const m=[...new Set(rr([...(l||[]).map(He).flat(),...h.map(He).flat(),...He(r),o]))].sort(),c={annotation:r,group:s,order:n,tags:h,tokens:m,unicode:u,version:v};if(o&&(c.emoticon=o),l&&(c.shortcodes=l),y){c.skinTones=[],c.skinUnicodes=[],c.skinVersions=[];for(const{tone:E,emoji:D,version:S}of y)c.skinTones.push(E),c.skinUnicodes.push(D),c.skinVersions.push(S)}return c})}function ar(t,e,r,o){t[e](r).onsuccess=s=>o&&o(s.target.result)}function We(t,e,r){ar(t,"get",e,r)}function or(t,e,r){ar(t,"getAll",e,r)}function vn(t){t.commit&&t.commit()}function Aa(t,e){let r=t[0];for(let o=1;o<t.length;o++){const s=t[o];e(r)>e(s)&&(r=s)}return r}function sr(t,e){const r=Aa(t,s=>s.length),o=[];for(const s of r)t.some(n=>n.findIndex(l=>e(l)===e(s))===-1)||o.push(s);return o}async function _a(t){return!await gn(t,Je,St)}async function Da(t,e,r){const[o,s]=await Promise.all([tn,St].map(n=>gn(t,Je,n)));return o===r&&s===e}async function La(t,e){return Me(t,ze,Qe,(o,s,n)=>{let l;const y=()=>{o.getAll(l&&IDBKeyRange.lowerBound(l,!0),50).onsuccess=h=>{const u=h.target.result;for(const v of u)if(l=v.unicode,e(v))return n(v);if(u.length<50)return n();y()}};y()})}async function ir(t,e,r,o){try{const s=Na(e);await Me(t,[ze,Je],hn,([n,l],y)=>{let h,u,v=0;function m(){++v===2&&c()}function c(){if(!(h===o&&u===r)){n.clear();for(const E of s)n.put(E);l.put(o,tn),l.put(r,St),vn(y)}}We(l,tn,E=>{h=E,m()}),We(l,St,E=>{u=E,m()})})}finally{}}async function Ma(t,e){return Me(t,ze,Qe,(r,o,s)=>{const n=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);or(r.index(er),n,s)})}async function cr(t,e){const r=rr(He(e));return r.length?Me(t,ze,Qe,(o,s,n)=>{const l=[],y=()=>{l.length===r.length&&h()},h=()=>{const u=sr(l,v=>v.unicode);n(u.sort((v,m)=>v.order<m.order?-1:1))};for(let u=0;u<r.length;u++){const v=r[u],m=u===r.length-1?IDBKeyRange.bound(v,v+"￿",!1,!0):IDBKeyRange.only(v);or(o.index(Qn),m,c=>{l.push(c),y()})}}):[]}async function Oa(t,e){const r=await cr(t,e);return r.length?r.filter(o=>(o.shortcodes||[]).map(n=>n.toLowerCase()).includes(e.toLowerCase()))[0]||null:await La(t,s=>(s.shortcodes||[]).includes(e.toLowerCase()))||null}async function Pa(t,e){return Me(t,ze,Qe,(r,o,s)=>We(r,e,n=>{if(n)return s(n);We(r.index(tr),e,l=>s(l||null))}))}function gn(t,e,r){return Me(t,e,Qe,(o,s,n)=>We(o,r,n))}function ja(t,e,r,o){return Me(t,e,hn,(s,n)=>{s.put(o,r),vn(n)})}function Ba(t,e){return Me(t,mn,hn,(r,o)=>We(r,e,s=>{r.put((s||0)+1,e),vn(o)}))}function Ra(t,e,r){return r===0?[]:Me(t,[mn,ze],Qe,([o,s],n,l)=>{const y=[];o.index(Zn).openCursor(void 0,"prev").onsuccess=h=>{const u=h.target.result;if(!u)return l(y);function v(E){if(y.push(E),y.length===r)return l(y);u.continue()}const m=u.primaryKey,c=e.byName(m);if(c)return v(c);We(s,m,E=>{if(E)return v(E);u.continue()})}})}const vt="";function Ua(t,e){const r=new Map;for(const s of t){const n=e(s);for(const l of n){let y=r;for(let u=0;u<l.length;u++){const v=l.charAt(u);let m=y.get(v);m||(m=new Map,y.set(v,m)),y=m}let h=y.get(vt);h||(h=[],y.set(vt,h)),h.push(s)}}return(s,n)=>{let l=r;for(let u=0;u<s.length;u++){const v=s.charAt(u),m=l.get(v);if(m)l=m;else return[]}if(n)return l.get(vt)||[];const y=[],h=[l];for(;h.length;){const v=[...h.shift().entries()].sort((m,c)=>m[0]<c[0]?-1:1);for(const[m,c]of v)m===vt?y.push(...c):h.push(c)}return y}}const $a=["name","url"];function Fa(t){const e=t&&Array.isArray(t),r=e&&t.length&&(!t[0]||$a.some(o=>!(o in t[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function Fn(t){Fa(t);const e=(c,E)=>c.name.toLowerCase()<E.name.toLowerCase()?-1:1,r=t.sort(e),s=Ua(t,c=>[...new Set((c.shortcodes||[]).map(E=>He(E)).flat())]),n=c=>s(c,!0),l=c=>s(c,!1),y=c=>{const E=He(c),D=E.map((S,d)=>(d<E.length-1?n:l)(S));return sr(D,S=>S.name).sort(e)},h=new Map,u=new Map;for(const c of t){u.set(c.name.toLowerCase(),c);for(const E of c.shortcodes||[])h.set(E.toLowerCase(),c)}return{all:r,search:y,byShortcode:c=>h.get(c.toLowerCase()),byName:c=>u.get(c.toLowerCase())}}const Va=typeof wrappedJSObject<"u";function tt(t){if(!t)return t;if(Va&&(t=structuredClone(t)),delete t.tokens,t.skinTones){const e=t.skinTones.length;t.skins=Array(e);for(let r=0;r<e;r++)t.skins[r]={tone:t.skinTones[r],unicode:t.skinUnicodes[r],version:t.skinVersions[r]};delete t.skinTones,delete t.skinUnicodes,delete t.skinVersions}return t}function lr(t){t||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const Wa=["annotation","emoji","group","order","tags","version"];function za(t){if(!t||!Array.isArray(t)||!t[0]||typeof t[0]!="object"||Wa.some(e=>!(e in t[0])))throw new Error("Emoji data is in the wrong format")}function ur(t,e){if(Math.floor(t.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+t.status)}async function qa(t){const e=await fetch(t,{method:"HEAD"});ur(e,t);const r=e.headers.get("etag");return lr(r),r}async function rn(t){const e=await fetch(t);ur(e,t);const r=e.headers.get("etag");lr(r);const o=await e.json();return za(o),[r,o]}function Ya(t){for(var e="",r=new Uint8Array(t),o=r.byteLength,s=-1;++s<o;)e+=String.fromCharCode(r[s]);return e}function Ha(t){for(var e=t.length,r=new ArrayBuffer(e),o=new Uint8Array(r),s=-1;++s<e;)o[s]=t.charCodeAt(s);return r}async function dr(t){const e=JSON.stringify(t);let r=Ha(e);const o=await crypto.subtle.digest("SHA-1",r),s=Ya(o);return btoa(s)}async function Ga(t,e){let r,o=await qa(e);if(!o){const s=await rn(e);o=s[0],r=s[1],o||(o=await dr(r))}await Da(t,e,o)||(r||(r=(await rn(e))[1]),await ir(t,r,e,o))}async function Ka(t,e){let[r,o]=await rn(e);r||(r=await dr(o)),await ir(t,o,e,r)}class Xa{constructor({dataSource:e=ya,locale:r=ba,customEmoji:o=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=Fn(o),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await Ta(this._dbName);xa(this._dbName,this._clear);const r=this.dataSource;await _a(e)?await Ka(e,r):this._lazyUpdate=Ga(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return qt(e),await this.ready(),$n(await Ma(this._db,e)).map(tt)}async getEmojiBySearchQuery(e){pt(e),await this.ready();const r=this._custom.search(e),o=$n(await cr(this._db,e)).map(tt);return[...r,...o]}async getEmojiByShortcode(e){pt(e),await this.ready();const r=this._custom.byShortcode(e);return r||tt(await Oa(this._db,e))}async getEmojiByUnicodeOrName(e){pt(e),await this.ready();const r=this._custom.byName(e);return r||tt(await Pa(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await gn(this._db,Je,Un)||0}async setPreferredSkinTone(e){return qt(e),await this.ready(),ja(this._db,Je,Un,e)}async incrementFavoriteEmojiCount(e){return pt(e),await this.ready(),Ba(this._db,e)}async getTopFavoriteEmoji(e){return qt(e),await this.ready(),(await Ra(this._db,this._custom,e)).map(tt)}set customEmoji(e){this._custom=Fn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await pn(this._dbName)}async delete(){await this._shutdown(),await ka(this._dbName)}}const an=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([t,e,r])=>({id:t,emoji:e,name:r})),Yt=an.slice(1),Ja=2,Vn=6,fr=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function Wn(t){return t.unicode.includes("‍")}const Qa={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},Za=1e3,eo="🖐️",to=8,no=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],mr='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',ro=(t,e)=>t<e?-1:t>e?1:0,zn=(t,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const o=r.getContext("2d");return o.textBaseline="top",o.font=`100px ${mr}`,o.fillStyle=e,o.scale(.01,.01),o.fillText(t,0,0),o.getImageData(0,0,1,1).data},ao=(t,e)=>{const r=[...t].join(","),o=[...e].join(",");return r===o&&!r.startsWith("0,0,0,")};function oo(t){const e=zn(t,"#000"),r=zn(t,"#fff");return e&&r&&ao(e,r)}function so(){const t=Object.entries(Qa);try{for(const[e,r]of t)if(oo(e))return r}catch{}finally{}return t[0][1]}let Ht;const Gt=()=>(Ht||(Ht=new Promise(t=>fr(()=>t(so())))),Ht),on=new Map,io="️",co="\uD83C",lo="‍",uo=127995,fo=57339;function mo(t,e){if(e===0)return t;const r=t.indexOf(lo);return r!==-1?t.substring(0,r)+String.fromCodePoint(uo+e-1)+t.substring(r):(t.endsWith(io)&&(t=t.substring(0,t.length-1)),t+co+String.fromCodePoint(fo+e-1))}function Ae(t){t.preventDefault(),t.stopPropagation()}function Kt(t,e,r){return e+=t?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function hr(t,e){const r=new Set,o=[];for(const s of t){const n=e(s);r.has(n)||(r.add(n),o.push(s))}return o}function ho(t,e){const r=o=>{const s={};for(const n of o)typeof n.tone=="number"&&n.version<=e&&(s[n.tone]=n.unicode);return s};return t.map(({unicode:o,skins:s,shortcodes:n,url:l,name:y,category:h,annotation:u})=>({unicode:o,name:y,shortcodes:n,url:l,category:h,annotation:u,id:o||y,skins:s&&r(s)}))}const bt=requestAnimationFrame;let po=typeof ResizeObserver=="function";function vo(t,e,r){let o;po?(o=new ResizeObserver(s=>r(s[0].contentRect.width)),o.observe(t)):bt(()=>r(t.getBoundingClientRect().width)),e.addEventListener("abort",()=>{o&&o.disconnect()})}function qn(t){{const e=document.createRange();return e.selectNode(t.firstChild),e.getBoundingClientRect().width}}let Xt;function go(t,e,r){for(const o of t){const s=r(o),n=qn(s);typeof Xt>"u"&&(Xt=qn(e));const l=n/1.8<Xt;on.set(o.unicode,l)}}function yo(t){return hr(t,e=>e)}function bo(t){t&&(t.scrollTop=0)}function ot(t,e,r){let o=t.get(e);return o||(o=r(),t.set(e,o)),o}function Yn(t){return""+t}function Eo(t){const e=document.createElement("template");return e.innerHTML=t,e}const So=new WeakMap,wo=new WeakMap,To=Symbol("un-keyed"),ko="replaceChildren"in Element.prototype;function xo(t,e){ko?t.replaceChildren(...e):(t.innerHTML="",t.append(...e))}function Co(t,e){let r=t.firstChild,o=0;for(;r;){if(e[o]!==r)return!0;r=r.nextSibling,o++}return o!==e.length}function Io(t,e){const{targetNode:r}=e;let{targetParentNode:o}=e,s=!1;o?s=Co(o,t):(s=!0,e.targetNode=void 0,e.targetParentNode=o=r.parentNode),s&&xo(o,t)}function No(t,e){for(const r of e){const{targetNode:o,currentExpression:s,binding:{expressionIndex:n,attributeName:l,attributeValuePre:y,attributeValuePost:h}}=r,u=t[n];if(s!==u)if(r.currentExpression=u,l)o.setAttribute(l,y+Yn(u)+h);else{let v;Array.isArray(u)?Io(u,r):u instanceof Element?(v=u,o.replaceWith(v)):o.nodeValue=Yn(u),v&&(r.targetNode=v)}}}function Ao(t){let e="",r=!1,o=!1,s=-1;const n=new Map,l=[];for(let h=0,u=t.length;h<u;h++){const v=t[h];if(e+=v,h===u-1)break;for(let I=0;I<v.length;I++)switch(v.charAt(I)){case"<":{v.charAt(I+1)==="/"?l.pop():(r=!0,l.push(++s));break}case">":{r=!1,o=!1;break}case"=":{o=!0;break}}const m=l[l.length-1],c=ot(n,m,()=>[]);let E,D,S;if(o){const I=/(\S+)="?([^"=]*)$/.exec(v);E=I[1],D=I[2],S=/^[^">]*/.exec(t[h+1])[0]}const d={attributeName:E,attributeValuePre:D,attributeValuePost:S,expressionIndex:h};c.push(d),!r&&!o&&(e+=" ")}return{template:Eo(e),elementsToBindings:n}}function _o(t,e){const r=[],o=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT);let s=t,n=-1;do{const l=e.get(++n);if(l)for(let y=0;y<l.length;y++){const h=l[y],u=h.attributeName?s:s.firstChild,v={binding:h,targetNode:u,targetParentNode:void 0,currentExpression:void 0};r.push(v)}}while(s=o.nextNode());return r}function Do(t){const{template:e,elementsToBindings:r}=ot(So,t,()=>Ao(t)),o=e.cloneNode(!0).content.firstElementChild,s=_o(o,r);return function(l){return No(l,s),o}}function Lo(t){const e=ot(wo,t,()=>new Map);let r=To;function o(n,...l){const y=ot(e,n,()=>new Map);return ot(y,r,()=>Do(n))(l)}function s(n,l,y){return n.map((h,u)=>{const v=r;r=y(h);try{return l(h,u)}finally{r=v}})}return{map:s,html:o}}function Mo(t,e,r,o,s,n,l,y){const{labelWithSkin:h,titleForEmoji:u,unicodeWithSkin:v}=r,{html:m,map:c}=Lo(e);function E(d,I,R){return c(d,(N,j)=>m`<button role="${I?"option":"menuitem"}" aria-selected="${e.searchMode?j===e.activeSearchItem:""}" aria-label="${h(N,e.currentSkinTone)}" title="${u(N)}" class="emoji ${I&&j===e.activeSearchItem?"active":""}" id="${`${R}-${N.id}`}">${N.unicode?v(N,e.currentSkinTone):m`<img class="custom-emoji" src="${N.url}" alt="" loading="lazy">`}</button>`,N=>`${R}-${N.id}`)}const S=m`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${c(e.skinTones,(d,I)=>m`<div id="skintone-${I}" class="emoji ${I===e.activeSkinTone?"active":""}" aria-selected="${I===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[I]}" aria-label="${e.i18n.skinTones[I]}">${d}</div>`,d=>d)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${c(e.groups,d=>m`<button role="tab" class="nav-button" aria-controls="tab-${d.id}" aria-label="${e.i18n.categories[d.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===d.id}" title="${e.i18n.categories[d.name]}" data-group-id="${d.id}"><div class="nav-emoji emoji">${d.emoji}</div></button>`,d=>d.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${c(e.currentEmojisWithCategories,(d,I)=>m`<div><div id="menu-label-${I}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:d.category?d.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${I}" id="${e.searchMode?"search-results":""}">${E(d.emojis,e.searchMode,"emo")}</div></div>`,d=>d.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${E(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(y){t.appendChild(S);const d=(I,R)=>{for(const N of t.querySelectorAll(`[${I}]`))R(N,N.getAttribute(I))};for(const I of["click","focusout","input","keydown","keyup"])d(`data-on-${I}`,(R,N)=>{R.addEventListener(I,o[N])});d("data-ref",(I,R)=>{n[R]=I}),d("data-action",(I,R)=>{s[R](I)}),l.addEventListener("abort",()=>{t.removeChild(S)})}}const Tt=typeof queueMicrotask=="function"?queueMicrotask:t=>Promise.resolve().then(t);function Oo(t){let e=!1,r;const o=new Map,s=new Set;let n;const l=()=>{if(e)return;const u=[...s];s.clear();try{for(const v of u)v()}finally{n=!1,s.size&&(n=!0,Tt(l))}},y=new Proxy({},{get(u,v){if(r){let m=o.get(v);m||(m=new Set,o.set(v,m)),m.add(r)}return u[v]},set(u,v,m){u[v]=m;const c=o.get(v);if(c){for(const E of c)s.add(E);n||(n=!0,Tt(l))}return!0}}),h=u=>{const v=()=>{const m=r;r=v;try{return u()}finally{r=m}};return v()};return t.addEventListener("abort",()=>{e=!0}),{state:y,createEffect:h}}function Jt(t,e,r){if(t.length!==e.length)return!1;for(let o=0;o<t.length;o++)if(!r(t[o],e[o]))return!1;return!0}const Qt=[],{assign:gt}=Object;function Po(t,e){const r={},o=new AbortController,s=o.signal,{state:n,createEffect:l}=Oo(s);gt(n,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),gt(n,e),gt(n,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:to,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:Yt,databaseLoaded:!1,activeSearchItemId:void 0}),l(()=>{n.currentGroup!==n.groups[n.currentGroupIndex]&&(n.currentGroup=n.groups[n.currentGroupIndex])});const y=T=>{t.getElementById(T).focus()},h=T=>t.getElementById(`emo-${T.id}`),u=(T,V)=>{r.rootElement.dispatchEvent(new CustomEvent(T,{detail:V,bubbles:!0,composed:!0}))},v=(T,V)=>T.id===V.id,m=(T,V)=>{const{category:K,emojis:X}=T,{category:ae,emojis:ne}=V;return K!==ae?!1:Jt(X,ne,v)},c=T=>{Jt(n.currentEmojis,T,v)||(n.currentEmojis=T)},E=T=>{n.searchMode!==T&&(n.searchMode=T)},D=T=>{Jt(n.currentEmojisWithCategories,T,m)||(n.currentEmojisWithCategories=T)},S=(T,V)=>V&&T.skins&&T.skins[V]||T.unicode,R={labelWithSkin:(T,V)=>yo([T.name||S(T,V),T.annotation,...T.shortcodes||Qt].filter(Boolean)).join(", "),titleForEmoji:T=>T.annotation||(T.shortcodes||Qt).join(", "),unicodeWithSkin:S},N={onClickSkinToneButton:J,onEmojiClick:W,onNavClick:w,onNavKeydown:B,onSearchKeydown:L,onSkinToneOptionsClick:q,onSkinToneOptionsFocusOut:Se,onSkinToneOptionsKeydown:ee,onSkinToneOptionsKeyup:me,onSearchInput:Ne},j={calculateEmojiGridStyle:F};let x=!0;l(()=>{Mo(t,n,R,N,j,r,s,x),x=!1}),n.emojiVersion||Gt().then(T=>{T||(n.message=n.i18n.emojiUnsupportedMessage)}),l(()=>{async function T(){let V=!1;const K=setTimeout(()=>{V=!0,n.message=n.i18n.loadingMessage},Za);try{await n.database.ready(),n.databaseLoaded=!0}catch(X){console.error(X),n.message=n.i18n.networkErrorMessage}finally{clearTimeout(K),V&&(V=!1,n.message="")}}n.database&&T()}),l(()=>{n.pickerStyle=`
      --num-groups: ${n.groups.length}; 
      --indicator-opacity: ${n.searchMode?0:1}; 
      --num-skintones: ${Vn};`}),l(()=>{n.customEmoji&&n.database&&$()}),l(()=>{n.customEmoji&&n.customEmoji.length?n.groups!==an&&(n.groups=an):n.groups!==Yt&&(n.currentGroupIndex&&n.currentGroupIndex--,n.groups=Yt)}),l(()=>{async function T(){n.databaseLoaded&&(n.currentSkinTone=await n.database.getPreferredSkinTone())}T()}),l(()=>{n.skinTones=Array(Vn).fill().map((T,V)=>mo(n.skinToneEmoji,V))}),l(()=>{n.skinToneButtonText=n.skinTones[n.currentSkinTone]}),l(()=>{n.skinToneButtonLabel=n.i18n.skinToneLabel.replace("{skinTone}",n.i18n.skinTones[n.currentSkinTone])}),l(()=>{async function T(){const{database:V}=n,K=(await Promise.all(no.map(X=>V.getEmojiByUnicodeOrName(X)))).filter(Boolean);n.defaultFavoriteEmojis=K}n.databaseLoaded&&T()});function $(){n.database.customEmoji=n.customEmoji||Qt}l(()=>{async function T(){$();const{database:V,defaultFavoriteEmojis:K,numColumns:X}=n,ae=await V.getTopFavoriteEmoji(X),ne=await te(hr([...ae,...K],be=>be.unicode||be.name).slice(0,X));n.currentFavorites=ne}n.databaseLoaded&&n.defaultFavoriteEmojis&&T()});function F(T){vo(T,s,V=>{{const K=getComputedStyle(r.rootElement),X=parseInt(K.getPropertyValue("--num-columns"),10),ae=K.getPropertyValue("direction")==="rtl",be=T.parentElement.getBoundingClientRect().width-V;n.numColumns=X,n.scrollbarWidth=be,n.isRtl=ae}})}l(()=>{async function T(){const{searchText:V,currentGroup:K,databaseLoaded:X,customEmoji:ae}=n;if(!X)n.currentEmojis=[],n.searchMode=!1;else if(V.length>=Ja){const ne=await Ee(V);n.searchText===V&&(c(ne),E(!0))}else{const{id:ne}=K;if(ne!==-1||ae&&ae.length){const be=await fe(ne);n.currentGroup.id===ne&&(c(be),E(!1))}}}T()}),l(()=>{const{currentEmojis:T,emojiVersion:V}=n,K=T.filter(X=>X.unicode).filter(X=>Wn(X)&&!on.has(X.unicode));if(!V&&K.length)c(T),bt(()=>Y(K));else{const X=V?T:T.filter(de);c(X),bt(()=>bo(r.tabpanelElement))}});function Y(T){go(T,r.baselineEmoji,h),n.currentEmojis=n.currentEmojis}function de(T){return!T.unicode||!Wn(T)||on.get(T.unicode)}async function ie(T){const V=n.emojiVersion||await Gt();return T.filter(({version:K})=>!K||K<=V)}async function te(T){return ho(T,n.emojiVersion||await Gt())}async function fe(T){const V=T===-1?n.customEmoji:await n.database.getEmojiByGroup(T);return te(await ie(V))}async function Ee(T){return te(await ie(await n.database.getEmojiBySearchQuery(T)))}l(()=>{}),l(()=>{function T(){const{searchMode:K,currentEmojis:X}=n;if(K)return[{category:"",emojis:X}];const ae=new Map;for(const ne of X){const be=ne.category||"";let qe=ae.get(be);qe||(qe=[],ae.set(be,qe)),qe.push(ne)}return[...ae.entries()].map(([ne,be])=>({category:ne,emojis:be})).sort((ne,be)=>n.customCategorySorting(ne.category,be.category))}const V=T();D(V)}),l(()=>{n.activeSearchItemId=n.activeSearchItem!==-1&&n.currentEmojis[n.activeSearchItem].id}),l(()=>{const{rawSearchText:T}=n;fr(()=>{n.searchText=(T||"").trim(),n.activeSearchItem=-1})});function L(T){if(!n.searchMode||!n.currentEmojis.length)return;const V=K=>{Ae(T),n.activeSearchItem=Kt(K,n.activeSearchItem,n.currentEmojis)};switch(T.key){case"ArrowDown":return V(!1);case"ArrowUp":return V(!0);case"Enter":if(n.activeSearchItem===-1)n.activeSearchItem=0;else return Ae(T),_(n.currentEmojis[n.activeSearchItem].id)}}function w(T){const{target:V}=T,K=V.closest(".nav-button");if(!K)return;const X=parseInt(K.dataset.groupId,10);r.searchElement.value="",n.rawSearchText="",n.searchText="",n.activeSearchItem=-1,n.currentGroupIndex=n.groups.findIndex(ae=>ae.id===X)}function B(T){const{target:V,key:K}=T,X=ae=>{ae&&(Ae(T),ae.focus())};switch(K){case"ArrowLeft":return X(V.previousElementSibling);case"ArrowRight":return X(V.nextElementSibling);case"Home":return X(V.parentElement.firstElementChild);case"End":return X(V.parentElement.lastElementChild)}}async function _(T){const V=await n.database.getEmojiByUnicodeOrName(T),K=[...n.currentEmojis,...n.currentFavorites].find(ae=>ae.id===T),X=K.unicode&&S(K,n.currentSkinTone);await n.database.incrementFavoriteEmojiCount(T),u("emoji-click",{emoji:V,skinTone:n.currentSkinTone,...X&&{unicode:X},...K.name&&{name:K.name}})}async function W(T){const{target:V}=T;if(!V.classList.contains("emoji"))return;Ae(T);const K=V.id.substring(4);_(K)}function H(T){n.currentSkinTone=T,n.skinTonePickerExpanded=!1,y("skintone-button"),u("skin-tone-change",{skinTone:T}),n.database.setPreferredSkinTone(T)}function q(T){const{target:{id:V}}=T,K=V&&V.match(/^skintone-(\d)/);if(!K)return;Ae(T);const X=parseInt(K[1],10);H(X)}function J(T){n.skinTonePickerExpanded=!n.skinTonePickerExpanded,n.activeSkinTone=n.currentSkinTone,n.skinTonePickerExpanded&&(Ae(T),bt(()=>y("skintone-list")))}l(()=>{n.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{n.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):n.skinTonePickerExpandedAfterAnimation=!1});function ee(T){if(!n.skinTonePickerExpanded)return;const V=async K=>{Ae(T),n.activeSkinTone=K};switch(T.key){case"ArrowUp":return V(Kt(!0,n.activeSkinTone,n.skinTones));case"ArrowDown":return V(Kt(!1,n.activeSkinTone,n.skinTones));case"Home":return V(0);case"End":return V(n.skinTones.length-1);case"Enter":return Ae(T),H(n.activeSkinTone);case"Escape":return Ae(T),n.skinTonePickerExpanded=!1,y("skintone-button")}}function me(T){if(n.skinTonePickerExpanded)switch(T.key){case" ":return Ae(T),H(n.activeSkinTone)}}async function Se(T){const{relatedTarget:V}=T;(!V||V.id!=="skintone-list")&&(n.skinTonePickerExpanded=!1)}function Ne(T){n.rawSearchText=T.target.value}return{$set(T){gt(n,T)},$destroy(){o.abort()}}}const jo="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Bo="en";var Ro={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Uo=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const pr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],$o=`:host{--emoji-font-family:${mr}}`;class yn extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=Uo+$o,this.shadowRoot.appendChild(r),this._ctx={locale:Bo,dataSource:jo,skinToneEmoji:eo,customCategorySorting:ro,customEmoji:null,i18n:Ro,emojiVersion:null,...e};for(const o of pr)o!=="database"&&Object.prototype.hasOwnProperty.call(this,o)&&(this._ctx[o]=this[o],delete this[o]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Po(this.shadowRoot,this._ctx))}disconnectedCallback(){Tt(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,o){this._set(e.replace(/-([a-z])/g,(s,n)=>n.toUpperCase()),e==="emoji-version"?parseFloat(o):o)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:o}=this._ctx;(!o||o.locale!==e||o.dataSource!==r)&&this._set("database",new Xa({locale:e,dataSource:r}))}_dbFlush(){Tt(()=>this._dbCreate())}}const vr={};for(const t of pr)vr[t]={get(){return t==="database"&&this._dbCreate(),this._ctx[t]},set(e){if(t==="database")throw new Error("database is read-only");this._set(t,e)}};Object.defineProperties(yn.prototype,vr);customElements.get("emoji-picker")||customElements.define("emoji-picker",yn);var sn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(t,e){(function(r,o){o(e)})(nt,function(r){var o="dnd-poly-",s=o+"snapback",n="dnd-poly-",l=n+"dragstart-pending",y=n+"dragstart-cancel",h=["none","copy","copyLink","copyMove","link","linkMove","move","all"],u=["none","copy","move","link"],v=function(){var L=!1;try{var w=Object.defineProperty({},"passive",{get:function(){L=!0}});window.addEventListener("test",null,w)}catch{}return L}();function m(L){return L&&L.tagName}function c(L,w,B){B===void 0&&(B=!0),document.addEventListener(L,w,!!v&&{passive:B})}function E(L,w){document.removeEventListener(L,w)}function D(L,w,B,_){_===void 0&&(_=!1);var W=v?{passive:!0,capture:_}:_;return L.addEventListener(w,B,W),{off:function(){L.removeEventListener(w,B,W)}}}function S(L){return L.length===0?0:L.reduce(function(w,B){return B+w},0)/L.length}function d(L,w){for(var B=0;B<L.changedTouches.length;B++)if(L.changedTouches[B].identifier===w)return!0;return!1}function I(L,w,B){for(var _=[],W=[],H=0;H<w.touches.length;H++){var q=w.touches[H];_.push(q[L+"X"]),W.push(q[L+"Y"])}B.x=S(_),B.y=S(W)}var R=["","-webkit-"];function N(L,w,B,_,W){W===void 0&&(W=!0);var H=w.x,q=w.y;_&&(H+=_.x,q+=_.y),W&&(H-=parseInt(L.offsetWidth,10)/2,q-=parseInt(L.offsetHeight,10)/2);for(var J="translate3d("+H+"px,"+q+"px, 0)",ee=0;ee<R.length;ee++){var me=R[ee]+"transform";L.style[me]=J+" "+B[ee]}}var j=function(){function L(w,B){this.t=w,this.i=B,this.s=u[0]}return Object.defineProperty(L.prototype,"dropEffect",{get:function(){return this.s},set:function(w){this.t.mode!==0&&h.indexOf(w)>-1&&(this.s=w)},enumerable:!0,configurable:!0}),Object.defineProperty(L.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(L.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(w){this.t.mode===2&&h.indexOf(w)>-1&&(this.t.effectAllowed=w)},enumerable:!0,configurable:!0}),L.prototype.setData=function(w,B){if(this.t.mode===2){if(w.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[w]=B,this.t.types.indexOf(w)===-1&&this.t.types.push(w)}},L.prototype.getData=function(w){if(this.t.mode===1||this.t.mode===2)return this.t.data[w]||""},L.prototype.clearData=function(w){if(this.t.mode===2){if(w&&this.t.data[w]){delete this.t.data[w];var B=this.t.types.indexOf(w);return void(B>-1&&this.t.types.splice(B,1))}this.t.data={},this.t.types=[]}},L.prototype.setDragImage=function(w,B,_){this.t.mode===2&&this.i(w,B,_)},L}();function x(L,w){return L?L===h[0]?u[0]:L.indexOf(h[1])===0||L===h[7]?u[1]:L.indexOf(h[4])===0?u[3]:L===h[6]?u[2]:u[1]:w.nodeType===3&&w.tagName==="A"?u[3]:u[1]}function $(L,w,B,_,W,H,q){H===void 0&&(H=!0),q===void 0&&(q=null);var J=function(me,Se,Ne,T,V,K,X){X===void 0&&(X=null);var ae=Se.changedTouches[0],ne=new Event(Ne,{bubbles:!0,cancelable:T});ne.dataTransfer=K,ne.relatedTarget=X,ne.screenX=ae.screenX,ne.screenY=ae.screenY,ne.clientX=ae.clientX,ne.clientY=ae.clientY,ne.pageX=ae.pageX,ne.pageY=ae.pageY;var be=me.getBoundingClientRect();return ne.offsetX=ne.clientX-be.left,ne.offsetY=ne.clientY-be.top,ne}(w,B,L,H,document.defaultView,W,q),ee=!w.dispatchEvent(J);return _.mode=0,ee}function F(L,w){if(!L||L===h[7])return w;if(w===u[1]){if(L.indexOf(u[1])===0)return u[1]}else if(w===u[3]){if(L.indexOf(u[3])===0||L.indexOf("Link")>-1)return u[3]}else if(w===u[2]&&(L.indexOf(u[2])===0||L.indexOf("Move")>-1))return u[2];return u[0]}var Y,de=function(){function L(w,B,_,W){this.h=w,this.o=B,this.u=_,this.l=W,this.v=0,this.p=null,this.g=null,this.m=w,this.I=w.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),c("touchmove",this.j,!1),c("touchend",this.S,!1),c("touchcancel",this.S,!1)}return L.prototype.A=function(){var w=this;this.v=1,this.O=u[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var B=this.u;if(this.N=new j(this.D,function(J,ee,me){B=J,typeof ee!="number"&&typeof me!="number"||(w.P={x:ee||0,y:me||0})}),this.D.mode=2,this.N.dropEffect=u[0],$("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;I("page",this.m,this.F);var _,W=this.o.dragImageSetup(B);if(this.L=(_=W,R.map(function(J){var ee=_.style[J+"transform"];return ee&&ee!=="none"?ee.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),W.style.position="absolute",W.style.left="0px",W.style.top="0px",W.style.zIndex="999999",W.classList.add("dnd-poly-drag-image"),W.classList.add("dnd-poly-icon"),this._=W,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var H=getComputedStyle(B);this.P={x:0-parseInt(H.marginLeft,10),y:0-parseInt(H.marginTop,10)}}else{var q=B.getBoundingClientRect();H=getComputedStyle(B),this.P={x:q.left-this.I.clientX-parseInt(H.marginLeft,10)+q.width/2,y:q.top-this.I.clientY-parseInt(H.marginTop,10)+q.height/2}}return N(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){w.X||(w.X=!0,w.Y(),w.X=!1)},this.o.iterationInterval),!0},L.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),E("touchmove",this.j),E("touchend",this.S),E("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},L.prototype.C=function(w){var B=this;if(d(w,this.I.identifier)!==!1){if(this.m=w,this.v===0){var _=void 0;if(this.o.dragStartConditionOverride)try{_=this.o.dragStartConditionOverride(w)}catch{_=!1}else _=w.touches.length===1;return _?void(this.A()===!0&&(this.h.preventDefault(),w.preventDefault())):void this.T()}if(w.preventDefault(),I("client",w,this.M),I("page",w,this.F),this.o.dragImageTranslateOverride)try{var W=!1;if(this.o.dragImageTranslateOverride(w,{x:this.M.x,y:this.M.y},this.p,function(H,q){B._&&(W=!0,B.M.x+=H,B.M.y+=q,B.F.x+=H,B.F.y+=q,N(B._,B.F,B.L,B.P,B.o.dragImageCenterOnTouch))}),W)return}catch{}N(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},L.prototype.k=function(w){if(d(w,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(w.preventDefault(),this.v=w.type==="touchcancel"?3:2):this.T()}},L.prototype.Y=function(){var w=this,B=this.O;this.D.mode=3,this.N.dropEffect=u[0];var _=$("drag",this.u,this.m,this.D,this.N);if(_&&(this.O=u[0]),_||this.v===2||this.v===3)return this.q(this.v)?void function(J,ee,me,Se){var Ne=getComputedStyle(J);if(Ne.visibility!=="hidden"&&Ne.display!=="none"){ee.classList.add(s);var T=getComputedStyle(ee),V=parseFloat(T.transitionDuration);if(isNaN(V)||V===0)Se();else{var K=J.getBoundingClientRect(),X={x:K.left,y:K.top};X.x+=document.body.scrollLeft||document.documentElement.scrollLeft,X.y+=document.body.scrollTop||document.documentElement.scrollTop,X.x-=parseInt(Ne.marginLeft,10),X.y-=parseInt(Ne.marginTop,10);var ae=parseFloat(T.transitionDelay),ne=Math.round(1e3*(V+ae));N(ee,X,me,void 0,!1),setTimeout(Se,ne)}}else Se()}(this.u,this._,this.L,function(){w.B()}):void this.B();var W=this.o.elementFromPoint(this.M.x,this.M.y),H=this.g;W!==this.p&&W!==this.g&&(this.p=W,this.g!==null&&(this.D.mode=3,this.N.dropEffect=u[0],$("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=x(this.D.effectAllowed,this.u),$("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=F(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),H!==this.g&&m(H)&&(this.D.mode=3,this.N.dropEffect=u[0],$("dragleave",H,this.m,this.D,this.N,!1,this.g)),m(this.g)&&(this.D.mode=3,this.N.dropEffect=x(this.D.effectAllowed,this.u),$("dragover",this.g,this.m,this.D,this.N)===!1?this.O=u[0]:this.O=F(this.N.effectAllowed,this.N.dropEffect)),B!==this.O&&this._.classList.remove(o+B);var q=o+this.O;this._.classList.add(q)},L.prototype.q=function(w){var B=this.O===u[0]||this.g===null||w===3;return B?m(this.g)&&(this.D.mode=3,this.N.dropEffect=u[0],$("dragleave",this.g,this.m,this.D,this.N,!1)):m(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,$("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=u[0]),B},L.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,$("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},L}(),ie={iterationInterval:150,tryFindDraggableTarget:function(L){var w=L.target;do if(w.draggable!==!1&&(w.draggable===!0||w.getAttribute&&w.getAttribute("draggable")==="true"))return w;while((w=w.parentNode)&&w!==document.body)},dragImageSetup:function(L){var w=L.cloneNode(!0);return function B(_,W){if(_.nodeType===1){for(var H=getComputedStyle(_),q=0;q<H.length;q++){var J=H[q];W.style.setProperty(J,H.getPropertyValue(J),H.getPropertyPriority(J))}if(W.style.pointerEvents="none",W.removeAttribute("id"),W.removeAttribute("class"),W.removeAttribute("draggable"),W.nodeName==="CANVAS"){var ee=_,me=W,Se=ee.getContext("2d").getImageData(0,0,ee.width,ee.height);me.getContext("2d").putImageData(Se,0,0)}}if(_.hasChildNodes())for(q=0;q<_.childNodes.length;q++)B(_.childNodes[q],W.childNodes[q])}(L,w),w},elementFromPoint:function(L,w){return document.elementFromPoint(L,w)}};function te(L){if(!Y){var w=ie.tryFindDraggableTarget(L);if(w)try{Y=new de(L,ie,w,Ee)}catch(B){throw Ee(ie,L,3),B}}}function fe(L){var w=L.target,B=function(ee){W.off(),H.off(),q.off(),J.off(),w&&w.dispatchEvent(new CustomEvent(y,{bubbles:!0,cancelable:!0})),clearTimeout(_)};w&&w.dispatchEvent(new CustomEvent(l,{bubbles:!0,cancelable:!0}));var _=window.setTimeout(function(){W.off(),H.off(),q.off(),J.off(),te(L)},ie.holdToDrag),W=D(w,"touchend",B),H=D(w,"touchcancel",B),q=D(w,"touchmove",B),J=D(window,"scroll",B,!0)}function Ee(L,w,B){if(B===0&&L.defaultActionOverride)try{L.defaultActionOverride(w),w.defaultPrevented}catch{}Y=null}r.polyfill=function(L){if(L&&Object.keys(L).forEach(function(W){ie[W]=L[W]}),!ie.forceApply){var w=(B={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},_=!!window.chrome||/chrome/i.test(navigator.userAgent),B.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||_&&"ontouchstart"in document.documentElement),B);if(w.userAgentSupportingNativeDnD&&w.draggable&&w.dragEvents)return!1}var B,_;return ie.holdToDrag?c("touchstart",fe,!1):c("touchstart",te,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(sn,sn.exports);var Fo=sn.exports;const Vo=t=>typeof t!="string"?t:t.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),Le=(t,e)=>{t.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{t.classList.add(e)})})},Wo=()=>{const t=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${t.height}px`);t.addEventListener("resize",e),e()};let Hn;const zo=(t=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),o=()=>{clearTimeout(r),clearTimeout(Hn),Hn=setTimeout(()=>{t.removeEventListener("scroll",o),e()},100)};t.addEventListener("scroll",o)}),qo="0.6.2 Beta",Fe=document.querySelector(".editor"),ue=document.getElementById("tones"),ge=document.getElementById("action"),ce=document.getElementById("musical-score"),$e=document.getElementById("add-track"),it=document.getElementById("remove-track"),Ve=document.getElementById("dialog"),re=document.forms["dialog-form"];re._title=re.querySelector(".form-title");re.description=re.querySelector(".description");re.inputs=re.querySelector(".inputs");re.buttons=re.querySelector(".buttons");const kt=document.getElementById("play"),xt=document.getElementById("clear"),Yo=document.getElementById("warn-out"),Ho=document.getElementById("mml"),Re=document.getElementById("copy"),je=document.getElementById("paste"),Ct=document.getElementById("save"),cn=document.getElementById("open"),Pt=document.getElementById("ctrl"),It=document.getElementById("undo"),Nt=document.getElementById("redo");var lt,le,Ie,Ge;class Go{constructor(){we(this,lt,`#COMMENT Generated by FlMML VisualSequencer ${qo}`);we(this,le,[]);we(this,Ie,(e,r)=>{});we(this,Ge,(e,r)=>{})}set onChange(e){xe(this,Ie,e)}set onError(e){xe(this,Ge,e)}setMmlArr(e){xe(this,le,e),U(this,Ie).call(this,this.getMmlArr(),this.getMml())}setMml(e){xe(this,le,e.split(`
`)),U(this,le).at(-2)===""&&U(this,le).at(-1)===U(this,lt)&&U(this,le).splice(-2,2),U(this,Ie).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return U(this,le)}getMml(){return U(this,le).length?U(this,le).concat(["",U(this,lt)]).join(`
`):""}getMmlLine(e){return U(this,le)[e]}insert(e,r){Object.hasOwn(U(this,le),e)||e===0?(U(this,le).splice(e,0,r),U(this,Ie).call(this,this.getMmlArr(),this.getMml())):U(this,Ge).call(this,"範囲外の書き換え指定",`範囲${U(this,le).length-1}までのところ、${e}`)}append(e){U(this,le).push(e),U(this,Ie).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(U(this,le),e)?(U(this,le)[e]+=r,U(this,Ie).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(U(this,le),e)?(U(this,le)[e]=r+U(this,le)[e],U(this,Ie).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(U(this,le),e)?(U(this,le)[e]=r,U(this,Ie).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(U(this,le),e)&&U(this,le).splice(e,r).length!==0?U(this,Ie).call(this,this.getMmlArr(),this.getMml()):U(this,Ge).call(this,"無効な指定",`範囲${U(this,le).length-1}までの中で${e}から${r}削除するのはできません`)}}lt=new WeakMap,le=new WeakMap,Ie=new WeakMap,Ge=new WeakMap;var Te,Ke,ut,Ue;class Ko{constructor(e,r){we(this,Te,[]);we(this,Ke,[]);we(this,ut,null);we(this,Ue,null);this.tonesElem=e,this.areaElem=r,xe(this,Ue,this.areaElem.querySelector(".track.active"))}set activeTrack(e){U(this,Ue).classList.remove("active"),xe(this,Ue,e),U(this,Ue).classList.add("active")}get activeTrack(){return U(this,Ue)}blocksDataUpdate(){xe(this,Te,[...this.areaElem.querySelectorAll(".track button")].map(e=>({label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),tone:{tone:e.dataset.tone,tonePitch:e.dataset.tonePitch},tempo:e.dataset.tempo,noteValue:e.dataset.noteValue,rest:e.dataset.rest,octave:e.dataset.octave,velocity:e.dataset.velocity,noteShift:e.dataset.noteShift,detune:e.dataset.detune,tieSlur:e.dataset.tieSlur,repeatStartEnd:e.dataset.repeatStartEnd,repeatBreak:e.dataset.repeatBreak,polyStartEnd:e.dataset.polyStartEnd,macroDef:e.dataset.macroDef,macroArgUse:e.dataset.macroArgUse,macroUse:e.dataset.macroUse,metaData:e.dataset.metaData,otherAction:e.dataset.otherAction,elem:e})))}saveBlocksData(){clearTimeout(U(this,ut)),xe(this,ut,setTimeout(()=>{const e=JSON.parse(JSON.stringify(U(this,Te)));en.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){en.getItem("BlocksData").then(e=>{e&&(xe(this,Te,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Q))})}parseBlocks(){const e=U(this,Te);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let o=0;e.forEach(s=>{if(s.trackNo!==o){const v=document.createElement("ul");v.classList.add("track"),this.activeTrack=v,this.areaElem.insertBefore(v,$e),o=s.trackNo}const n=document.createElement("li"),l='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',y=(()=>{const v=document.createElement("div");return v.innerHTML=l,v.firstElementChild})(),h=document.querySelector(`[class*="${s.className.replace(/ material-icons| droppable| bounce| pop| done/g,"")}"]`),u=(h==null?void 0:h.cloneNode(!0))||y;s.label&&(u.ariaLabel=s.label),s.tone.tonePitch&&(u.className=s.className,s.label!=="無調整"&&(u.textContent=s.label),u.dataset.tone=s.tone.tone,h?h.replaceWith(u.cloneNode(!0)):r.appendChild(u.cloneNode(!0)),u.dataset.tonePitch=s.tone.tonePitch),s.tempo&&(u.dataset.tempo=s.tempo),s.noteValue&&(u.dataset.noteValue=s.noteValue),s.rest&&(u.dataset.rest=s.rest),s.octave&&(u.dataset.octave=s.octave),s.velocity&&(u.dataset.velocity=s.velocity),s.noteShift&&(u.dataset.noteShift=s.noteShift),s.detune&&(u.dataset.detune=s.detune),s.tieSlur&&(u.dataset.tieSlur=s.tieSlur,s.tieSlur==="&"?u.ariaLabel="スラー":u.ariaLabel="タイ"),s.repeatStartEnd&&(u.dataset.repeatStartEnd=s.repeatStartEnd,s.repeatStartEnd.startsWith("/:")?(u.classList.remove("material-icons"),u.ariaLabel="リピート開始",u.textContent="◆"):s.repeatStartEnd===":/"&&(u.ariaLabel="リピート終了")),s.repeatBreak&&(u.dataset.repeatBreak=s.repeatBreak),s.polyStartEnd&&(u.dataset.polyStartEnd=s.polyStartEnd),s.macroDef&&(u.dataset.macroDef=s.macroDef,u.textContent=s.macroDef===";"?";":"$="),s.macroArgUse&&(u.dataset.macroArgUse=s.macroArgUse),s.macroUse&&(u.dataset.macroUse=s.macroUse),s.metaData&&(u.dataset.metaData=s.metaData),s.otherAction&&(u.dataset.otherAction=s.otherAction,u.textContent=s.otherAction.length>4?"…":s.otherAction),n.appendChild(u),this.activeTrack.appendChild(n)})}exportMml(e){e.setMmlArr([]);let r=0,o=0;const s=U(this,Te).filter(c=>c.tone.tone!==void 0),n=()=>s.filter(c=>c.trackNo===o),l=()=>new Set(n().map(c=>c.tone.tone));let y=l(),h=0,u=!1,v=[4,0],m=!1;U(this,Te).forEach(c=>{const{tone:E,tonePitch:D}=c.tone;if(c.trackNo!==o&&(y.size?([...y].forEach((S,d)=>{e.appendToStr(r+d,";")}),r+=y.size):(e.appendToStr(r,";"),r++),o=c.trackNo,y=l(),u=!1),E!==void 0)h=[...y].indexOf(E),u||([...y].forEach((S,d)=>{S&&e.beforeInsertToStr(r+d,S+" ")}),u=!0),[...y].forEach((S,d)=>{let I=D||"";d!==h&&(I=I.replace(/[a-g]/,m?"*":"r")),e.appendToStr(r+d,I)});else if(c.rest||c.tieSlur)y.size?[...y].forEach((S,d)=>{e.appendToStr(r+d,c.rest||c.tieSlur)}):e.appendToStr(r,c.rest||c.tieSlur);else if(c.noteValue||c.repeatStartEnd||c.repeatBreak||c.polyStartEnd){const S=d=>{if(!d)return v;const I=Number((d.match(/[0-9]+/)||[v[0]])[0]),R=(d.match(/\.+/)||[""])[0].length;return[I,R]};c.noteValue?v=S(c.noteValue):c.polyStartEnd==="["?m=!0:c.polyStartEnd==="]"&&(m=!1),y.size?[...y].forEach((d,I)=>{if(e.appendToStr(r+I,c.noteValue||c.repeatStartEnd||c.repeatBreak||c.polyStartEnd||""),c.polyStartEnd==="]"){const R=e.getMmlLine(r+I).match(/\[(.+?)\]/);if(R){const N=R[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(N){const j=[...N].map(F=>({type:F[1]==="r"?"rest":F[1]==="*"?"otherNote":"note",num:S(F[0])}));j.filter(Y=>Y.type==="note").map(Y=>Y.num),j.filter(Y=>Y.type==="otherNote").map(Y=>Y.num),j.filter(Y=>Y.type==="rest").map(Y=>Y.num);let x=R[0].replace(/\*\+?[0-9]*\.*/g,"");const $=e.getMmlLine(r+I).replace(/\[.+?\]/,x);e.rewrite(r+I,$)}}}}):e.appendToStr(r,c.noteValue||c.repeatStartEnd||c.repeatBreak||c.polyStartEnd||"")}else if(c.metaData)c.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,c.metaData.replace(`
`,"")||""),r++;else{const S=D||c.tempo||c.octave||c.velocity||c.noteShift||c.detune||c.tieSlur||c.macroDef||c.macroArgUse||c.macroUse||c.otherAction||"";e.appendToStr(r,S),/;/.test(S)&&(r+=y.size||1,y=l(),u=!1)}}),[...y].slice(0,-1).forEach((c,E)=>{e.appendToStr(r+E,";")})}importMml(e){const r=e.getMmlArr(),o=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig,s=[],n=new Set,l=new Set;let y=0,h="",u=!1,v=!1;r.forEach(m=>{(m.match(o)||[]).forEach(E=>{if(E=E.trim(),!E)return;const D=S=>{const d={};if(d.tone={},d.trackNo=y,/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(S)){h=S,l.add(h);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(S)){l.has(h)||l.add(h);const I=[...l].indexOf(h)+1;d.label="無調整",d.className=`material-icons note note-${I}`,d.tone.tone=h,d.tone.tonePitch=S,u&&(v=!0)}else if(S.startsWith("t"))d.className="material-icons tempo",d.tempo=S;else if(S.startsWith("l"))d.className="material-icons note-value",d.noteValue=S;else if(S.startsWith("r"))d.className="material-icons rest",d.rest=S;else if(/^o[0-8]|[><]+$/i.test(S))d.className="material-icons octave",d.octave=S;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(S))d.className="material-icons velocity",d.velocity=S;else if(S.startsWith("@ns")||S.startsWith("ns"))d.className="material-icons note-shift",d.noteShift=S;else if(S.startsWith("@d"))d.className="material-icons detune",d.detune=S;else if(S.startsWith("&"))d.className="tie-slur",d.tieSlur=S;else if(S.startsWith("/*"))d.className="other-action",d.otherAction=S;else if(S.startsWith("/:"))d.className="repeat-start-end",d.repeatStartEnd=S;else if(S.startsWith(":/"))d.className="material-icons repeat-start-end",d.repeatStartEnd=S;else if(S.startsWith("/"))d.className="repeat-break",d.repeatBreak=S;else if(S.startsWith("[")||S.startsWith("]"))d.className="poly-start-end",d.polyStartEnd=S;else if(/^\$.*?=$/.test(S))d.className="macro-def",d.macroDef=S.replaceAll(" ",""),n.add(d.macroDef.slice(0,-1)),u=!0;else if(S.startsWith("%"))d.className="macro-arg-use",d.macroArgUse=S;else if(S.startsWith("$")){d.className="macro-use";const I=[...n].sort((R,N)=>N.length-R.length).find(R=>S.includes(R));if(I){d.macroUse=I,s.push(d);const R=S.replace(I,"");R!==""&&D(R);return}else d.macroUse=S}else if(S.startsWith("#")){const I={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};d.label=(Object.entries(I).find(R=>S.startsWith(R[0]))||[,void 0])[1],d.className="meta-data",d.metaData=S+`
`}else if(S.startsWith(";")){if(y++,u&&!v){const I=[...l].join(" ");I&&(d.className="other-action",d.otherAction=I,s.push(d),l.clear())}u=!1,v=!1;return}else d.className="other-action",d.otherAction=S;s.push(d)};D(E)})}),this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((m,c)=>{c?m.remove():(m.textContent="",this.activeTrack=m)}),G=null,xe(this,Te,s),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}playRendering(){const e=U(this,Te);let r=120,o=0;[ue,ge,ce].forEach(v=>{v.classList.add("no-op")});const s=document.querySelector(".wrap"),n=document.getElementsByClassName("track"),y=(s.clientHeight-32)/n.length;[...n].forEach(v=>{v.style.setProperty("--max-height",`${y}px`)}),$e.disabled=!0,it.disabled=!0;const h=(v,{scoreNoteValue:m=4}={})=>{var B;let c=!1,E=-1,D=-1,S=!1,d=!1;const I=[],R=[],N=[],j=performance.now(),x=(B=v[0])==null?void 0:B.trackNo,$=n[x],F=o++;let Y=null;const de=new Promise(_=>Y=_);let ie=0,te=0;const fe=_=>{if(!_)return m;const W=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(_),H=W&&W[1]?Number(W[1]):m,q=W?W[2].length:0;return H*2**q/(2**(q+1)-1)},Ee=_=>{const W=q=>{!d&&$.scrollTo({top:q,behavior:"smooth"}),d=!0,zo($).then(()=>{d=!1})},H=q=>$.clientHeight*q;(te===0||_.elem.offsetTop>$.scrollTop+H(.8)||_.elem.offsetTop<$.scrollTop+H(.2))&&W(_.elem.offsetTop-H(.2))},L=_=>{const W=H=>{const q=H-j,J=60/r*4/_*1e3;q<ie+J?U(this,Ke)[F]=requestAnimationFrame(W):(ie+=J,w())};U(this,Ke)[F]=requestAnimationFrame(W)},w=async()=>{var W,H;const _=v[te];if(!_||te>=v.length){Y({scoreNoteValue:m});return}if(Ee(_),S){_.macroDef===";"&&(S=!1),te++,w();return}else if(E!==-1)(W=_.repeatStartEnd)!=null&&W.startsWith("/:")?D++:_.repeatStartEnd===":/"&&(D===E&&(Le(_.elem,"pop"),E=-1),D--),te++,w();else if(_.tone.tonePitch){const q=fe(_.tone.tonePitch);Le(_.elem,"bounce"),te++,c?w():L(q)}else if(_.rest||_.tieSlur)if(Le(_.elem,"pop"),te++,_.tieSlur==="&")w();else{const q=fe(_.rest||_.tieSlur);L(q)}else if(_.polyStartEnd)if(c=_.polyStartEnd==="[",Le(_.elem,"pop"),c)te++,w();else{const q=fe(v[te++-1].tone.tonePitch);L(q)}else if(_.macroDef&&_.macroDef!==";"){S=!0,te++,w();return}else{if(_.tempo&&(r=Number(_.tempo.replace("t",""))||r),_.noteValue&&(m=fe(_.noteValue)),Le(_.elem,"pop"),(H=_.repeatStartEnd)!=null&&H.startsWith("/:"))I[++D]=te,R[D]||(N[D]=_.repeatStartEnd.replace("/:",""),N[D]=N[D]===""?2:Number(N[D]),N[D]||(E=D));else if(_.repeatBreak){if(N[D]===1){if(!R[D]){let q=D;R[D]=v.findIndex((J,ee)=>{if(ee>I[D]){if(console.log(q),J.repeatStartEnd.startsWith("/:"))q++;else if(J.repeatStartEnd===":/"){if(q===D)return!0;q--}}})}te=R[D],w(),Le(_.elem,"done");return}}else if(_.repeatStartEnd===":/"){if(N[D]--,N[D]){R[D]=te,te=I[D],D--,w(),Le(_.elem,"done");return}R[D]=null,D--}else if(_.macroUse){const q=ee=>{const me=e[ee].trackNo;let Se=ee+1;for(;e[Se].macroDef!==";"&&e[Se].trackNo===me;)Se++;return Se},J={};if(J.start=e.findIndex(ee=>{var me;return(me=ee.macroDef)==null?void 0:me.startsWith(_.macroUse)}),J.start>-1){J.end=q(J.start),J.blocks=e.slice(J.start+1,J.end);const ee=performance.now();m=(await h(J.blocks,{scoreNoteValue:m})).scoreNoteValue;const me=performance.now();ie+=me-ee}}te++,w()}Le(_.elem,"done")};return w(),de},u=e.at(-1).trackNo+1;for(let v=0;v<u;v++)h(e.filter(m=>m.trackNo===v))}stopRendering(){[ue,ge,ce].forEach(e=>{e.classList.remove("no-op")}),$e.disabled=!1,it.disabled=!1,U(this,Te).forEach(e=>{e.elem.classList.remove("done")}),U(this,Ke).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!U(this,Te).length)return;const e=U(this,Te).at(-1).trackNo+1;for(let r=0;r<e;r++)U(this,Te).filter(s=>s.polyStartEnd&&s.trackNo===r).forEach((s,n)=>{n%2===0?(s.elem.dataset.polyStartEnd="[",s.elem.textContent="["):(s.elem.dataset.polyStartEnd="]",s.elem.textContent="]")});this.blocksDataUpdate()}}Te=new WeakMap,Ke=new WeakMap,ut=new WeakMap,Ue=new WeakMap;var pe,Dt,dt,Xe;class Xo{constructor(){we(this,pe,[[],[]]);we(this,Dt,70);we(this,dt,e=>{});we(this,Xe,e=>{})}set onPushstate(e){xe(this,dt,e)}set onPopstate(e){xe(this,Xe,e)}pushState(e){U(this,pe)[0].push(e),U(this,dt).call(this,e),U(this,pe)[0].length>U(this,Dt)&&U(this,pe)[0].shift(),U(this,pe)[1].length=0,console.log(U(this,pe))}undo(){const e=U(this,pe)[0].pop();return U(this,Xe).call(this,{reason:"undo",data:e}),e&&U(this,pe)[1].unshift(e),console.log(U(this,pe)),{canUndo:!!U(this,pe)[0].length,canRedo:!!U(this,pe)[1].length}}redo(){const e=U(this,pe)[1].shift();return U(this,Xe).call(this,{reason:"redo",data:e}),e&&U(this,pe)[0].push(e),console.log(U(this,pe)),{canUndo:!!U(this,pe)[0].length,canRedo:!!U(this,pe)[1].length}}clear(){U(this,pe)[0].length=0,U(this,pe)[1].length=0,console.log(U(this,pe))}}pe=new WeakMap,Dt=new WeakMap,dt=new WeakMap,Xe=new WeakMap;let G=ue.querySelector("button"),gr=!1,_e=!1;const Be={timeStamp:-1,tempo:120,scoreNoteValue:"4"};let ln=null,un=!1,Zt=null;const yr=()=>{C.activeTrack.querySelectorAll("button").forEach(t=>{t.classList.remove("done")}),un=!1},At=()=>{if(clearTimeout(ln),G&&G.closest(".track")!==C.activeTrack){G=C.activeTrack.querySelector("button");return}let t=G;if(!t){if(un){console.log("end1");return}Be.timeStamp=-1,setTimeout(()=>{G=C.activeTrack.querySelector("button"),yr()},2e3),un=!0,console.log("end2");return}(()=>{if("tonePitch"in t.dataset){t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,""),De(t,{noteValue:"1..."}),t.classList.add("bounce");return}"rest"in t.dataset&&(t.dataset.rest="r"),t.classList.add("done")})();const r=()=>{var n;G=t=((n=t.parentElement.nextElementSibling)==null?void 0:n.firstElementChild)||null};if("tonePitch"in t.dataset||ke.stop(),!["tonePitch","rest"].some(n=>n in t.dataset)){if("tempo"in t.dataset){const n=Number(t.dataset.tempo.replace("t",""));Be.tempo=n}else"noteValue"in t.dataset&&(Be.scoreNoteValue=(t.dataset.noteValue.match(/[0-9]+\.*/)||[Be.scoreNoteValue])[0]);r(),At(),console.log("end3");return}if((()=>{const n=60/Be.tempo*4*1e3*1.825;ln=setTimeout(At,n)})(),!performance.getEntriesByName("stepPoint")[0]){performance.mark("stepPoint"),Zt=t,r(),console.log("end4");return}(()=>{const n=performance.measure("stepElapsed","stepPoint");performance.mark("stepPoint");const l=n.duration,h=(v=>{const m=[1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,384],c=60/Be.tempo*4/v*1e3,{noteValue:E,dots:D}=m.reduce((S,d,I)=>{const R=Math.log2(c/(2*c-d));if(R<0||Number.isNaN(R))return S;const N=R-Math.floor(R);return N<S.smallerFractional?{noteValue:d,dots:Math.round(R),smallerFractional:N}:S},{noteValue:null,dots:null,smallerFractional:1});return E+".".repeat(D)})(l);(v=>{const m=Zt;if("tonePitch"in m.dataset){const c=v!==Be.scoreNoteValue?v:"";m.dataset.tonePitch=m.dataset.tonePitch+c}else if("rest"in m.dataset){const c=v!==Be.scoreNoteValue?v:"";m.dataset.rest="r"+c}})(h),C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q)})(),Zt=t,r()};var Lt,Mt,Ot;class Jo{constructor(e){we(this,Lt,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name"},{label:"音の定義",type:"text",name:"tone-def",autofocus:""}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}]},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}]},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0"}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}]},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}]},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}]},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8"}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}]},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127"}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}]},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift"}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}]},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune"}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}]},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}]},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0"}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}]},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg"}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}]},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use"}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}]},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg"}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}]},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}]},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action"}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}]},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}]},step:{title:"ステップ音価記録",description:`ステップ音価記録は、簡単に音価を指定できる機能です。

各トラックの空白部分をテンポよくクリック、またはスペースキーを押して最初の音符から順に音価を決定します。
途中から指定をやり直したいときは、やり直したい音符をクリックすることでそこからやり直せます。

この画面は、Shiftキーを押しながらステップ音価記録ブロックをクリックすることで再度表示できます。`,buttons:[{className:"primaly",value:"set-step",textContent:"開始"},{value:"cancel-step",textContent:"やめる"}]}});we(this,Mt,e=>{const r=U(this,Lt)[e];Object.keys(r).forEach(o=>{switch(o){case"title":re._title.textContent=r.title;break;case"description":(()=>{const s=document.createElement("p");s.innerHTML=r.description.replaceAll(`
`,"<br>"),re.description.appendChild(s)})();break;case"inputs":r.inputs.forEach(s=>{const n=document.createElement("input");let l=n;Object.entries(s).forEach(([y,h])=>{if(y==="label"){const u=document.createElement("label");u.textContent=h,u.appendChild(n),l=u}else if(y==="select"){const u=document.createElement("select");u.name=s.name,Object.entries(h).forEach(([m,c])=>{const E=document.createElement("option");E.value=m,E.textContent=c,u.appendChild(E)}),n.replaceWith(u)}else n[y]=h}),re.inputs.appendChild(l)});break;case"buttons":r.buttons.forEach(s=>{const n=document.createElement("button");Object.entries(s).forEach(([l,y])=>{n[l]=y}),re.buttons.appendChild(n)});break}})});we(this,Ot,(e,r)=>{re._title.textContent="",re.description.textContent="",re.inputs.textContent="",re.buttons.textContent="",U(this,Mt).call(this,e);for(const[o,s]of Object.entries(r))o==="run"?s():re.elements[o].value=s;this.type=e});this.type=null,this.submitTarget=null,this.resolve=null,e.addEventListener("submit",r=>{const o=this.submitTarget,s=r.submitter.value,n=JSON.parse(JSON.stringify(o.dataset));switch(s){case"set-tone":const y=o.className;document.querySelectorAll(`[class*="${y}"]`).forEach(c=>{c.ariaLabel=e.elements["tone-name"].value,(!c.classList.contains("material-icons")||e.elements["tone-name"].value!=="無調整")&&(c.classList.remove("material-icons"),c.textContent=e.elements["tone-name"].value),c.dataset.tone=e.elements["tone-def"].value});break;case"set-tone-pitch":o.dataset.tonePitch=o.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]+e.elements["tone-pitch"].value+".".repeat(e.elements.dot.value);break;case"set-tempo":o.dataset.tempo="t"+e.elements.tempo.value;break;case"set-note-value":o.dataset.noteValue="l"+e.elements["note-value"].value+".".repeat(e.elements.dot.value);break;case"set-rest":o.dataset.rest="r"+e.elements.rest.value+".".repeat(e.elements.dot.value);break;case"set-octave":o.dataset.octave="o"+e.elements.octave.value;break;case"set-octave-relative":o.dataset.octave=e.elements.octave.value>0?"<".repeat(e.elements.octave.value):">".repeat(-e.elements.octave.value);break;case"set-velocity":o.dataset.velocity="@v"+e.elements.velocity.value;break;case"set-velocity-relative":o.dataset.velocity=(e.elements.velocity.value>=0?"(":")")+Math.abs(e.elements.velocity.value);break;case"set-note-shift":o.dataset.noteShift="ns"+e.elements["note-shift"].value;break;case"set-note-shift-relative":o.dataset.noteShift="@ns"+e.elements["note-shift"].value;break;case"set-detune":o.dataset.detune="@d"+e.elements.detune.value;break;case"set-tie-slur":o.dataset.tieSlur="&"+e.elements["tie-slur"].value+".".repeat(e.elements.dot.value),o.dataset.tieSlur==="&"?o.ariaLabel="スラー":o.ariaLabel="タイ";break;case"set-repeat":o.dataset.repeatStartEnd="/:"+e.elements.repeat.value;break;case"set-macro-def":const h=o.dataset.macroDef;o.dataset.macroDef="$"+e.elements["macro-def-name"].value+(e.elements["macro-def-arg"].value!==""?`{${e.elements["macro-def-arg"].value}}`:"")+"=",ce.querySelectorAll(`[data-macro-use="${h.replace("=","")}"]`).forEach(c=>{c.dataset.macroUse=o.dataset.macroDef.replace("=","")});break;case"set-macro-arg-use":o.dataset.macroArgUse="%"+e.elements["macro-arg-use"].value;break;case"set-macro-use":o.dataset.macroUse="$"+e.elements["macro-use-name"].value+(e.elements["macro-use-arg"].value!==""?`{${e.elements["macro-use-arg"].value}}`:"");break;case"set-meta-data":o.ariaLabel=e.elements["select-meta-data"].selectedOptions[0].label,o.dataset.metaData=e.elements["select-meta-data"].value.replace("{n}",e.elements.number.value).replace("{desc}",e.elements.text.value);break;case"set-other-action":o.dataset.otherAction=e.elements["other-action"].value,o.textContent=o.dataset.otherAction.length>4?"…":o.dataset.otherAction;break;case"remove-left":case"remove-right":const u=o.parentElement,v=C.activeTrack,m=v.children;for([...m].indexOf(u),G=null;[...m].includes(u);){const c=s==="remove-left",E=c?v.firstElementChild:v.lastElementChild;ye.pushState({operation:"remove",removedElem:E,removedIndex:c?0:m.length-1,parent:v}),E.remove()}C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q);break;case"set-step":gr=!0,_e=!0;break;case"cancel-step":_e=!1;break}const l=JSON.parse(JSON.stringify(o.dataset));JSON.stringify(n)!==JSON.stringify(l)&&ye.pushState({operation:"valueChange",target:o,beforeChange:n,afterChange:l}),this.resolve()})}async prompt(e,r,o){return U(this,Ot).call(this,e,r),this.submitTarget=o,Ve.showModal(),new Promise(s=>this.resolve=s)}}Lt=new WeakMap,Mt=new WeakMap,Ot=new WeakMap;Xn.FlMML.prepare(".editor");const ke=new Xn.FlMML({workerURL:ca}),Q=new Go;en.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const C=new Ko(ue,ce),ye=new Xo,_t=new Jo(re),Qo={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},Zo=new yn({i18n:Qo,locale:"ja"});Fo.polyfill({holdToDrag:500});Wo();const ct=t=>`<span class="material-icons">${t}</span>`,br=ct("play_arrow")+"再生",es=ct("stop")+"停止",dn=()=>{C.playRendering()},ts=()=>{Yo.innerHTML=ke.getWarnings().replaceAll(`
`,"<br>")};ke.addEventListener("compilecomplete",ts);const ns=()=>{kt.innerHTML=br,C.stopRendering(),ke.removeEventListener("compilecomplete",dn),xt.disabled=!1};ke.addEventListener("complete",ns);Q.onChange=(t,e)=>{Ho.innerHTML=e?`<pre><code>${Vo(e).replaceAll(`
`,"<br>")}</code></pre>`:"(なし)";const r=!!t.length;[Re,Ct].forEach(o=>{o.disabled=!r})};Q.onError=(t,e)=>{alert(t+`
`+e)};C.checkSavedBlocksData();const De=(t,e={})=>{var D,S;const r=()=>{let d=t.parentElement;for(;d&&!("noteValue"in d.firstElementChild.dataset);)d=d.previousElementSibling;return(d==null?void 0:d.firstElementChild)||null},o=()=>{var I;let d=t.parentElement;for(;d&&!((I=d.firstElementChild.dataset.octave)!=null&&I.startsWith("o"));)d=d.previousElementSibling;return(d==null?void 0:d.firstElementChild)||null},s=()=>{var R;let d=t.parentElement.nextElementSibling,I="";for(;d&&((R=d.firstElementChild.dataset.tieSlur)!=null&&R.match(/&[0-9]+\.*/));)I+=d.firstElementChild.dataset.tieSlur,d=d.nextElementSibling;return I},n=((D=r())==null?void 0:D.dataset.noteValue)||"",l=((S=o())==null?void 0:S.dataset.octave)||"",y=[...C.activeTrack.children].indexOf(t.parentElement),h=[...C.activeTrack.children].slice(0,y).filter(d=>"tonePitch"in d.firstElementChild.dataset||"octave"in d.firstElementChild.dataset&&!d.firstElementChild.dataset.octave.startsWith("o")).map(d=>((d.firstElementChild.dataset.tonePitch||d.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),u=[">","<"],v=(d,I)=>(d.match(new RegExp(I,"g"))||[]).length,m=(()=>{const d=-v(h,u[0])+v(h,u[1]);return d<0?u[0].repeat(-d):d>0?u[1].repeat(d):""})(),c=s(),E=e.noteValue?t.dataset.tonePitch.replace(/[0-9]+\.*/,"")+e.noteValue:t.dataset.tonePitch;ke.play(t.dataset.tone+n+l+m+E+c)};ye.onPopstate=t=>{const e=t.data,r=o=>!!e.parent.closest("#"+o);switch(t.reason){case"undo":switch(e==null?void 0:e.operation){case"append":Q.delete(e.index);break;case"delete":Q.insert(e.index,e.mmlText);break;case"rewrite":Q.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q));break;case"move":const o=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(o,e.elem),r("musical-score")&&(C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q));break;case"valueChange":for(const[s,n]of Object.entries(e.beforeChange))e.target.dataset[s]=n;"tone"in e.target.dataset&&De(e.target),C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q));break;case"clear":e.tonesChildren.forEach(s=>{ue.querySelector("ul").appendChild(s)}),e.musicalScoreChildren.forEach(s=>{ce.insertBefore(s,$e)}),G=e.lastTouchedButton,C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":Q.append(e.mmlText);break;case"delete":Q.delete(e.index);break;case"rewrite":Q.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q)),"tonePitch"in G.dataset&&(De(G),G.classList.add("bounce"));break;case"move":const o=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(o,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q));break;case"valueChange":for(const[n,l]of Object.entries(e.afterChange))e.target.dataset[n]=l;"tone"in e.target.dataset&&De(e.target),C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q);break;case"remove":const s=e.removedElem.className;e.removedElem.remove(),r("tones")&&ce.querySelectorAll(`[class*="${s}"]`).forEach(n=>{n.parentElement.remove()}),C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q);break;case"clear":ue.querySelector("ul").textContent="",ce.querySelectorAll(".track").forEach((n,l)=>{l?n.remove():(n.textContent="",C.activeTrack=n)}),G=null,C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q);break}break}};const Er=()=>{const t=[...ue.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!t.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",t=>{var r;const e=t.ctrlKey||Pt.checked;switch((r=t.key)==null?void 0:r.toLowerCase()){case" ":_e?(t.preventDefault(),At()):document.activeElement.tagName.toLowerCase()!=="input"&&(t.preventDefault(),kt.click());break;case"s":e&&(t.preventDefault(),!Ct.disabled&&Ct.click());break;case"o":e&&(t.preventDefault(),!cn.disabled&&cn.click());break;case"z":e&&ye.undo();break;case"y":e&&ye.redo();break}});const rt=async t=>{const{dataset:e}=t,r={tempo:o=>({tempo:o.replace("t","")}),noteValue:o=>({"note-value":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),rest:o=>({rest:(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),octave:o=>({octave:o.startsWith("o")?o.replace("o",""):(o.match(/[><]+/)||[""])[0].length}),velocity:o=>({velocity:o.startsWith("@v")?o.replace("@v",""):Number((o.match(/[0-9]+/)||[""])[0])*(o.startsWith("(")?1:-1)}),noteShift:o=>({"note-shift":(o.match(/[0-9]+/)||[""])[0]}),detune:o=>({detune:o.replace("@d","")}),tieSlur:o=>({"tie-slur":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),repeatStartEnd:o=>({repeat:o.replace("/:","")}),macroDef:o=>({"macro-def-name":(o.match(/\$([^\{\=]*)[\{\=]/)||[,""])[1],"macro-def-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),macroArgUse:o=>({"macro-arg-use":o.replace("%","")}),macroUse:o=>({"macro-use-name":(o.match(/\$([^\{]*)\{?/)||[,""])[1],"macro-use-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),metaData:o=>({run:()=>{const n=o.split(" "),l=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let y=l.findIndex(c=>n[0].startsWith(c));y===-1&&(y=0),re.elements["select-meta-data"].selectedIndex=y;const h=c=>re.elements[c].previousSibling,u=()=>re.elements["select-meta-data"].selectedOptions[0],v=(c,E)=>{h("number").nodeValue=c[0],re.elements.number.value=c[1],re.elements.number.parentElement.style.display=c[2]?"none":"",h("text").nodeValue=E[0],re.elements.text.value=E[1],re.elements.text.parentElement.style.display=E[2]?"none":""},m=c=>{var S,d,I;const E=c===y,D=l[c];switch(D){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const R=E?n.slice(1).join(" ")??"":"";v(["無効","",!0],[u().label,R,!1]);break;case"#OCTAVE":case"#VELOCITY":v(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const N=D==="#WAV9",j=E?((S=n.slice(1).join(" "))==null?void 0:S.split(","))??[]:[];v(["波形番号",j[0]??0,!1],N?["初期変位,ループフラグ,データ",`${j[1]??0},${j[2]??0},${j[3]??""}`,!1]:["データ",j[1]??"",!1]),re.elements.number.min=0,re.elements.number.max=N?15:31;break;case"#OPM":case"#OPN":v(["音色番号",E?((d=n[0])==null?void 0:d.split("@")[1])??0:0,!1],["データ",E?((I=n.slice(1).join(" "))==null?void 0:I.slice(1,-1))??"":"",!1]),re.elements.number.min=0,re.elements.number.max=127;break;case"#FMGAIN":v(["音量利得",E?n[1].replace(`
`,"")??91:91,!1],["無効","",!0]),re.elements.number.min=-127,re.elements.number.max=127;break;case"#USING":v(["和音重ね数",E?n[2].replace(`
`,"")??2:2,!1],["無効","",!0]),re.elements.number.min=1,re.elements.number.max="";break}};m(y),re.elements["select-meta-data"].addEventListener("change",c=>{m(c.target.selectedIndex)})}}),otherAction:o=>({"other-action":o}),remove:()=>({}),step:()=>({})};for(const o of Object.keys(e)){const s=r[o];if(s){let n=e[o];switch(o){case"repeatStartEnd":if(n===":/"){const h=(()=>{var v;let u=t.parentElement;for(;u&&!((v=u.firstElementChild.dataset.repeatStartEnd)!=null&&v.startsWith("/:"));)u=u.previousElementSibling;return(u==null?void 0:u.firstElementChild)||null})();if(h)t=h;else{const u=C.activeTrack,v=document.createElement("li"),c=ge.querySelector(".repeat-start-end").cloneNode(!0);v.appendChild(c),u.insertBefore(v,t.parentElement),t=c}n=t.dataset.repeatStartEnd}break;case"macroDef":if(n===";")return;break}const l=s(n);await _t.prompt(o,l,t);break}}};Fe.addEventListener("click",async t=>{const e=t.ctrlKey||Pt.checked,r=s=>!!t.target.closest("#"+s),o=t.target.tagName.toLowerCase()==="button";if(![ue,ge,ce].some(s=>s.classList.contains("no-op"))){if(r("tones"))if(o)G=t.target,await _t.prompt("tone",{"tone-name":t.target.ariaLabel,"tone-def":t.target.dataset.tone,run:()=>{const s=re.elements["tone-name"];s.insertAdjacentElement("afterend",Zo);const n=document.querySelector("emoji-picker");s.addEventListener("focus",()=>{n.classList.add("expaned")},{once:!0}),n.addEventListener("emoji-click",l=>s.value=l.detail.unicode)}},t.target),ke.play(t.target.dataset.tone+t.target.dataset.tonePitch),C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q);else{const s=ue.querySelector("ul"),n=document.createElement("li"),y=`<button class="material-icons note ${Er()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;n.innerHTML=y;const h=n.firstElementChild;s.appendChild(n),G=h,ke.play(h.dataset.tone+h.dataset.tonePitch),ye.pushState({operation:"copy",toIndex:-1,newElem:n,parent:s})}else if(r("action")){if(o){if("otherAction"in t.target.dataset)await rt(t.target);else if("step"in t.target.dataset){gr&&!t.shiftKey?_e=!_e:await rt(t.target),_e?(t.target.classList.add("enable"),t.target.ariaLabel="ステップ音価記録(有効)",G=C.activeTrack.querySelector("button")):(t.target.classList.remove("enable"),t.target.ariaLabel="ステップ音価記録(無効)",yr(),ke.stop(),clearTimeout(ln));return}const s=C.activeTrack,n=document.createElement("li"),l=t.target.cloneNode(!0);if(["metaData","macroDef","macroArgUse","macroUse"].some(y=>y in l.dataset)&&await rt(l),"tieSlur"in l.dataset?l.ariaLabel="スラー":"repeatStartEnd"in l.dataset?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"):"polyStartEnd"in l.dataset?(l.dataset.polyStartEnd="[",l.textContent="["):"macroDef"in l.dataset&&(l.textContent="$="),n.appendChild(l),s.appendChild(n),G=l,C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:n,parent:s}),["repeatStartEnd","polyStartEnd","macroDef"].some(y=>y in G.dataset)){const y=document.createElement("li"),h=t.target.cloneNode(!0);"repeatStartEnd"in G.dataset?(h.ariaLabel="リピート終了",h.dataset.repeatStartEnd=":/"):"polyStartEnd"in G.dataset?(h.dataset.polyStartEnd="]",h.textContent="]"):"macroDef"in G.dataset&&(h.dataset.macroDef=";",h.textContent=";"),y.appendChild(h),G.parentElement.insertAdjacentElement("afterend",y),C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:y,parent:s})}}}else if(r("musical-score")){if(o&&t.target!==$e&&t.target!==it)t.target.closest(".track")&&(C.activeTrack=t.target.closest(".track")),_e||("tone"in t.target.dataset?(De(t.target),Le(t.target,"bounce"),e&&(await _t.prompt("tonePitch",{"tone-pitch":(t.target.dataset.tonePitch.match(/[0-9]+/)||[""])[0],dot:(t.target.dataset.tonePitch.match(/\.+/)||[""])[0].length},t.target),De(t.target))):await rt(t.target),C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q)),G=t.target;else if(t.target.closest(".track")&&(C.activeTrack=t.target.closest(".track")),_e)At();else if(G){const s=C.activeTrack,n=document.createElement("li"),l=G.cloneNode(!0);if("repeatStartEnd"in l.dataset&&(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"+(l.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),n.appendChild(l),s.appendChild(n),G=l,C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:n,parent:s}),"tonePitch"in l.dataset)l.dataset.tonePitch=l.dataset.tonePitch.replace(/[><]+/,""),De(l),l.classList.add("bounce");else if("repeatStartEnd"in G.dataset){const y=document.createElement("li"),h=G.cloneNode(!0);h.classList.add("material-icons"),h.ariaLabel="リピート終了",h.textContent="repeat",h.dataset.repeatStartEnd=":/",y.appendChild(h),G.parentElement.insertAdjacentElement("afterend",y),C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:y,parent:s})}}}}});Fe.addEventListener("contextmenu",t=>{var s,n,l,y;if(_e)return;const e=h=>h.closest("#tones, #musical-score"),r=h=>!!t.target.closest("#"+h),o=t.target.tagName.toLowerCase()==="button";if(!((s=e(t.target))!=null&&s.classList.contains("no-op"))&&e(t.target)){const h=o&&t.target!==$e&&t.target!==it?t.target:G;if(!h||e(h)!==e(t.target))return;t.preventDefault(),C.activeTrack=h.closest(".track")||C.activeTrack;const u=h.parentElement,v=h.className,m=((n=h.closest("#tones"))==null?void 0:n.querySelector("ul"))||C.activeTrack,c=[...m.children].indexOf(u);G=((l=u.previousElementSibling)==null?void 0:l.firstElementChild)||((y=u.nextElementSibling)==null?void 0:y.firstElementChild)||null,ye.pushState({operation:"remove",removedElem:u,removedIndex:c,parent:m}),r("tones")?ce.querySelectorAll(`[class*="${v}"]`).forEach(E=>{E.parentElement.remove()}):"macroDef"in h.dataset&&ce.querySelectorAll(`[data-macro-use="${h.dataset.macroDef.replace("=","")}"]`).forEach(E=>{E.parentElement.remove()}),u.remove(),C.blocksDataUpdate(),C.calcPoly(),C.saveBlocksData(),C.exportMml(Q)}});let Et=null,st=!1,fn=null;Fe.addEventListener("touchstart",t=>{Et=[...t.touches].at(-1).pageY,fn=setTimeout(()=>{st=!0},500)});const Sr=t=>{if(_e)return;const e=t.ctrlKey||Pt.checked,r=l=>!!t.target.closest("#"+l),o=t.target.tagName.toLowerCase()==="button";if(t.type==="touchmove"){const l=[...t.touches].at(-1).pageY;if(st){t.cancelable&&t.preventDefault();return}else if(l-Et<-20)t.deltaY=-1,clearTimeout(fn);else if(l-Et>20)t.deltaY=1,clearTimeout(fn);else{t.cancelable&&t.preventDefault();return}Et=l,st=!0,setTimeout(()=>st=!1,50)}const s=t.deltaY<0;let n=o?t.target:(G==null?void 0:G.closest("#musical-score"))&&G;if(n){if(r("musical-score")){if(ce.classList.contains("no-op"))return;t.preventDefault();let l=JSON.parse(JSON.stringify(n.dataset));if(!e&&"tone"in n.dataset){const h=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],u=[">","<"],v=n.dataset.tonePitch,m=h.findIndex(I=>v.match(/[a-g]\+?/)[0]===I),c=(I,R)=>(I.match(new RegExp(R,"g"))||[]).length,E=[c(v,u[0]),c(v,u[1])],D=u[0].repeat(E[0])+u[1].repeat(E[1]),S=(v.match(/[0-9]+/)||[""])[0],d=(n.dataset.tonePitch.match(/\.+/)||[""])[0];s?m===h.length-1?E[0]?n.dataset.tonePitch=D.substring(1)+h.at(0)+S+d:n.dataset.tonePitch=D+u[1]+h.at(0)+S+d:n.dataset.tonePitch=D+h[m+1]+S+d:m===0?E[1]?n.dataset.tonePitch=D.substring(1)+h.at(-1)+S+d:n.dataset.tonePitch=D+u[0]+h.at(-1)+S+d:n.dataset.tonePitch=D+h[m-1]+S+d,De(n)}else{const h=s?1:-1,u=(v,m=-1/0,c=1/0)=>v+h<m||v+h>c?0:h;if(e&&"tonePitch"in n.dataset){const v=Number((n.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),m=(n.dataset.tonePitch.match(/\.+/)||[""])[0],c=u(v,0,384),E=v+c!==0?v+c:"";n.dataset.tonePitch=n.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+E+m,De(n)}else if("tempo"in n.dataset){const v=Number(n.dataset.tempo.replace("t","")),m=u(v,0);n.dataset.tempo="t"+(v+m*10)}else if("noteValue"in n.dataset){const v=Number((n.dataset.noteValue.match(/[0-9]+/)||[""])[0]),m=u(v,1,384);n.dataset.noteValue=n.dataset.noteValue.replace(/[0-9]+/,v+m)}else if("rest"in n.dataset){const v=Number((n.dataset.rest.match(/[0-9]+/)||[""])[0]),m=(n.dataset.rest.match(/\.+/)||[""])[0],c=u(v,0,384),E=v+c!==0?v+c:"";n.dataset.rest="r"+E+m}else if("octave"in n.dataset)if(n.dataset.octave.startsWith("o")){const m=Number(n.dataset.octave.replace("o","")),c=u(m,0,8);n.dataset.octave="o"+(m+c)}else{const m=(n.dataset.octave.match(/<+/)||[""])[0].length-(n.dataset.octave.match(/>+/)||[""])[0].length,c=u(m,-8,8);n.dataset.octave=m+c>0?"<".repeat(m+c):">".repeat(-(m+c))}else if("velocity"in n.dataset)if(n.dataset.velocity.startsWith("@v")){const m=Number(n.dataset.velocity.replace("@v","")),c=u(m,0,127);n.dataset.velocity="@v"+(m+c)}else{const m=Number((n.dataset.velocity.match(/[0-9]+/)||[""])[0])*(n.dataset.velocity.startsWith("(")?1:-1),c=u(m,-127,127);n.dataset.velocity=(m+c>=0?"(":")")+Math.abs(m+c)}else if("noteShift"in n.dataset){const v=Number((n.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),m=h;n.dataset.noteShift=n.dataset.noteShift.match(/@?ns/)[0]+(v+m)}else if("detune"in n.dataset){const v=Number(n.dataset.detune.replace("@d","")),m=h;n.dataset.detune="@d"+(v+m)}else if("tieSlur"in n.dataset){const v=Number((n.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),m=(n.dataset.tieSlur.match(/\.+/)||[""])[0],c=u(v,0,384),E=v+c!==0?v+c:"";n.dataset.tieSlur="&"+E+m,n.dataset.tieSlur==="&"?n.ariaLabel="スラー":n.ariaLabel="タイ"}else if("repeatStartEnd"in n.dataset){if(n.dataset.repeatStartEnd===":/"){const D=(()=>{var d;let S=n.parentElement;for(;S&&!((d=S.firstElementChild.dataset.repeatStartEnd)!=null&&d.startsWith("/:"));)S=S.previousElementSibling;return(S==null?void 0:S.firstElementChild)||null})();if(D)n=D;else{const S=C.activeTrack,d=document.createElement("li"),R=ge.querySelector(".repeat-start-end").cloneNode(!0);d.appendChild(R),S.insertBefore(d,n.parentElement),n=R}l=JSON.parse(JSON.stringify(n.dataset))}const v=Number((n.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),m=u(v,-1),c=v+m!==-1?v+m:"";n.dataset.repeatStartEnd="/:"+c}}const y=JSON.parse(JSON.stringify(n.dataset));JSON.stringify(l)!==JSON.stringify(y)&&ye.pushState({operation:"valueChange",target:n,beforeChange:l,afterChange:y}),G=n,C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q)}}else return};Fe.addEventListener("wheel",Sr);Fe.addEventListener("touchmove",Sr);Fe.addEventListener("touchend",()=>{st=!1});let at={};Fe.addEventListener("dragstart",t=>{at={from:t.target.nodeType===1&&t.target.closest("#tones, #action, #musical-score"),item:t.target},t.dataTransfer.effectAllowed="copyMove"});let Gn=null;[ue,ge,ce].forEach(t=>{const e=n=>{const l=n.ctrlKey||Pt.checked,{from:y=null}=at,h=n.dataTransfer;switch(y){case ue:switch(t){case ue:n.preventDefault(),l?h.dropEffect="copy":h.dropEffect="move";break;case ge:break;case ce:n.preventDefault(),h.dropEffect="copy";break}break;case ge:switch(t){case ue:break;case ge:break;case ce:n.preventDefault(),h.dropEffect="copy";break}break;case ce:switch(t){case ue:break;case ge:break;case ce:n.preventDefault(),l?h.dropEffect="copy":h.dropEffect="move";break}break}Gn=h.dropEffect};t.addEventListener("dragover",e);const r=n=>{const{from:l=null}=at,y=n.target.tagName.toLowerCase()==="button",h=()=>n.target.classList.add("droppable");switch(l){case ue:switch(t){case ue:n.preventDefault(),y&&h();break;case ge:break;case ce:n.preventDefault(),y&&h();break}break;case ge:switch(t){case ue:break;case ge:break;case ce:n.preventDefault(),y&&h();break}break;case ce:switch(t){case ue:break;case ge:break;case ce:n.preventDefault(),y&&h();break}break}};t.addEventListener("dragenter",r);const o=n=>{const{from:l=null}=at,y=n.target.tagName.toLowerCase()==="button",h=()=>n.target.classList.remove("droppable");switch(l){case ue:switch(t){case ue:y&&h();break;case ge:break;case ce:y&&h();break}break;case ge:switch(t){case ue:break;case ge:break;case ce:y&&h();break}break;case ce:switch(t){case ue:break;case ge:break;case ce:y&&h();break}break}};t.addEventListener("dragleave",o),t.addEventListener("drop",async n=>{var E,D;if(n.preventDefault(),(E=n.dataTransfer.items)!=null&&E.length)return;n.dataTransfer.dropEffect=n.dataTransfer.dropEffect!=="none"?n.dataTransfer.dropEffect:Gn;const{from:l,item:y}=at,h=((D=n.target.closest("#tones"))==null?void 0:D.querySelector("ul"))||n.target.closest(".track")||C.activeTrack,u=[...h.children].indexOf(y.parentElement),v=[...h.children].indexOf(n.target.parentElement),m=n.target.tagName.toLowerCase()==="button";let c;switch(n.dataTransfer.dropEffect){case"copy":const S=document.createElement("li"),d=y.cloneNode(!0);if(t===ue){const I=[...y.classList].find(R=>R.includes("note-"));d.classList.replace(I,Er())}else l===ge&&("tieSlur"in d.dataset?d.ariaLabel="スラー":("metaData"in d.dataset||"macroDef"in d.dataset||"macroArgUse"in d.dataset||"macroUse"in d.dataset||"otherAction"in d.dataset)&&await rt(d));"repeatStartEnd"in d.dataset?(d.classList.remove("material-icons"),d.ariaLabel="リピート開始",d.textContent="◆",d.dataset.repeatStartEnd="/:"+(d.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in d.dataset?(d.dataset.polyStartEnd="[",d.textContent="["):"macroDef"in d.dataset&&(d.dataset.macroDef===";"&&(d.dataset.macroDef="$="),d.textContent="$="),S.appendChild(d),c=S;break;case"move":c=y.parentElement;break}if(m&&n.target.id!=="add-track"&&n.target.id!=="remove-track"){const S=n.dataTransfer.dropEffect==="copy"||v<u?"beforebegin":"afterend";n.target.parentElement.insertAdjacentElement(S,c)}else h.appendChild(c);switch(G=c.firstElementChild,t===ce&&(C.activeTrack=h,C.blocksDataUpdate(),n.dataTransfer.dropEffect==="move"&&C.calcPoly(),C.saveBlocksData(),C.exportMml(Q),"tonePitch"in G.dataset&&(G.dataset.tonePitch=G.dataset.tonePitch.replace(/[><]+/,""),De(G),G.classList.add("bounce"))),n.dataTransfer.dropEffect){case"copy":ye.pushState({operation:"copy",toIndex:v,newElem:c,parent:h});break;case"move":ye.pushState({operation:"move",fromIndex:u,toIndex:v,elem:c,parent:h});break}if(n.dataTransfer.dropEffect==="copy"&&("repeatStartEnd"in G.dataset||"polyStartEnd"in G.dataset||"macroDef"in G.dataset)){const S=document.createElement("li"),d=y.cloneNode(!0);"repeatStartEnd"in G.dataset?(d.classList.add("material-icons"),d.ariaLabel="リピート終了",d.textContent="repeat",d.dataset.repeatStartEnd=":/"):"polyStartEnd"in G.dataset?(d.dataset.polyStartEnd="]",d.textContent="]"):"macroDef"in G.dataset&&(d.dataset.macroDef=";",d.textContent=";"),S.appendChild(d),c.insertAdjacentElement("afterend",S),C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q),ye.pushState({operation:"copy",toIndex:v+1,newElem:S,parent:h})}});const s=n=>{[...document.getElementsByClassName("droppable")].forEach(l=>{l.classList.remove("droppable")})};t.addEventListener("dragend",s)});Fe.addEventListener("animationend",t=>{t.target.classList.remove("bounce"),t.target.classList.remove("pop")});$e.addEventListener("click",t=>{t.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),C.activeTrack=e,ce.insertBefore(e,$e)});it.addEventListener("click",t=>{t.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),C.activeTrack=r,C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q)});Ve.addEventListener("pointerdown",t=>{t.target===Ve&&Ve.addEventListener("pointerup",e=>{e.target===Ve&&Ve.close()},{once:!0})});Ve.addEventListener("close",()=>{switch(_t.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});kt.addEventListener("click",()=>{const t=ke.isPlaying();t?(ke.stop(),C.stopRendering(),ke.removeEventListener("compilecomplete",dn),xt.disabled=!1):(ke.play(Q.getMml()),ke.addEventListener("compilecomplete",dn),xt.disabled=!0),kt.innerHTML=t?br:es});xt.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const t=[...ce.children];t.pop(),ye.pushState({operation:"clear",tonesChildren:[...ue.querySelector("ul").children],musicalScoreChildren:t,lastTouchedButton:G}),ue.querySelector("ul").textContent="";const e=ue.querySelector("ul"),r=document.createElement("li"),o='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=o;const s=r.firstElementChild;e.appendChild(r),G=s,ce.querySelectorAll(".track").forEach((n,l)=>{l?n.remove():(n.textContent="",C.activeTrack=n)}),ke.play(""),C.blocksDataUpdate(),C.saveBlocksData(),C.exportMml(Q)}});Re.addEventListener("click",()=>{const t=Q.getMml(),e=Re.innerHTML;Re.disabled=!0,navigator.clipboard.writeText(t).then(()=>{Re.disabled=!0,Re.innerHTML=ct("content_copy")+"コピーしました",setTimeout(()=>{Re.innerHTML=e,Re.disabled=!1},1500)}).catch(r=>alert(`コピーできませんでした
`+r))});je.addEventListener("click",()=>{const t=je.innerHTML;je.disabled=!0,navigator.clipboard.readText().then(e=>{je.disabled=!0,e?(Q.setMml(e.replace(/\r/g,"")),C.importMml(Q),je.innerHTML=ct("content_paste")+"貼り付けました"):je.innerHTML=ct("content_paste")+"内容がありません",setTimeout(()=>{je.innerHTML=t,je.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});Ct.addEventListener("click",()=>{var n;const t=Q.getMml(),r=((n=Q.getMmlArr().find(l=>l.startsWith("#TITLE")))==null?void 0:n.split(" ").slice(1).join(" "))??"無題",o=new Blob([t],{type:"text/plain"}),s=document.createElement("a");s.download=r+".mml",s.href=URL.createObjectURL(o),s.click(),URL.revokeObjectURL(s.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。")});cn.addEventListener("click",()=>{const t=document.createElement("input"),e=new FileReader;t.type="file",t.accept=".mml,.flmml,.txt",t.click(),t.onchange=()=>{e.onload=()=>{Q.setMml(e.result),C.importMml(Q)},e.readAsText(t.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");ye.onPushstate=t=>{It.disabled=!1,Nt.disabled=!0};It.addEventListener("click",()=>{const{canUndo:t,canRedo:e}=ye.undo();It.disabled=!t,Nt.disabled=!e});Nt.addEventListener("click",()=>{const{canUndo:t,canRedo:e}=ye.redo();It.disabled=!t,Nt.disabled=!e});
