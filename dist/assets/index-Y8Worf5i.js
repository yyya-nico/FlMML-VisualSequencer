var $n=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var U=(t,e,r)=>($n(t,e,"read from private field"),r?r.call(t):e.get(t)),we=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},Ce=(t,e,r,o)=>($n(t,e,"write to private field"),o?o.call(t,r):e.set(t,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function r(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(s){if(s.ep)return;s.ep=!0;const n=r(s);fetch(s.href,n)}})();const ua="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var at=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function da(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Jn={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(t,e){(function(r,o){t.exports=o()})(self,function(){return(()=>{var r={587:(n,c,v)=>{var m;(m=(function(u,g){Object.defineProperty(g,"__esModule",{value:!0}),g.MsgTypes=g.SAMPLE_RATE=void 0,g.SAMPLE_RATE=44100,g.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(c,[v,c]))===void 0||(n.exports=m)},581:(n,c,v)=>{var m;(m=(function(u,g){Object.defineProperty(g,"__esModule",{value:!0}),g.FlMMLAudioExportError=void 0;class d extends Error{constructor(...T){super(...T),this.name="FlMMLAudioExportError"}}g.FlMMLAudioExportError=d}).apply(c,[v,c]))===void 0||(n.exports=m)},643:function(n,c,v){var m,u,g=this&&this.__awaiter||function(d,l,T,S){return new(T||(T=Promise))(function(E,b){function w(P){try{A(S.next(P))}catch(I){b(I)}}function B(P){try{A(S.throw(P))}catch(I){b(I)}}function A(P){var I;P.done?E(P.value):(I=P.value,I instanceof T?I:new T(function($){$(I)})).then(w,B)}A((S=S.apply(d,l||[])).next())})};m=[v,c,v(587),v(581),v(158)],(u=(function(d,l,T,S,E){Object.defineProperty(l,"__esModule",{value:!0}),l.FlMMLonHTML5=l.FlMMLAudioExportError=l.FlMML=void 0,Object.defineProperty(l,"FlMMLAudioExportError",{enumerable:!0,get:function(){return S.FlMMLAudioExportError}});const b="flmml-on-html5.worker.js";class w{constructor(A=b){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof A=="string"&&(A={workerURL:A});const P=A.workerURL||b,I=A.infoInterval>=0?A.infoInterval:125;this.bufferSize=A.bufferSize>=128?Math.floor(A.bufferSize-A.bufferSize%128):8192,this.bufferMultiple=A.bufferMultiple>=1?Math.floor(A.bufferMultiple):32,this.lamejsURL=A.lamejsURL,(this.worker=new Worker(A.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${P}")`],{type:"application/javascript"})):P)).addEventListener("message",$=>{this.onMessage($)}),this.setInfoInterval(I)}static initWebAudio(){const A=w.audioCtx=new AudioContext({sampleRate:T.SAMPLE_RATE}),P=A.createBufferSource();P.connect(A.destination),P.start(0),A.resume(),P.stop()}static hookInitWebAudio(A){const P=document.querySelectorAll(A);P.forEach(I=>{I.addEventListener("click",function $(){w.audioCtx||w.initWebAudio(),P.forEach(V=>{V.removeEventListener("click",$,!0)})},!0)})}static prepare(A){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{w.hookInitWebAudio(A)}):w.hookInitWebAudio(A)}onMessage(A){const P=A.data;switch(P.type){case T.MsgTypes.COMPCOMP:this.totalMSec=P.info.totalMSec,this.totalTimeStr=P.info.totalTimeStr,this.warnings=P.info.warnings,this.metaTitle=P.info.metaTitle,this.metaComment=P.info.metaComment,this.metaArtist=P.info.metaArtist,this.metaCoding=P.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case T.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(P),this.trigger("buffering",{progress:P.progress});break;case T.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case T.MsgTypes.SYNCINFO:this._isPlaying=P.info._isPlaying,this._isPaused=P.info._isPaused,this.nowMSec=P.info.nowMSec,this.nowTimeStr=P.info.nowTimeStr,this.voiceCount=P.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case T.MsgTypes.PLAYSOUND:this.playSound();break;case T.MsgTypes.STOPSOUND:this.stopSound();break;case T.MsgTypes.EXPORT:P.data?this.completeAudioExport(P.data):this.errorAudioExport(P.errorMsg)}}boot(){this.worker.postMessage({type:T.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const A=w.audioCtx,P=this.gainNode=A.createGain();P.gain.value=this.volume/127,P.connect(A.destination),g(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise($=>{const V=new FileReader;V.onload=J=>{A.audioWorklet.addModule(J.target.result).then($)},V.readAsDataURL(new Blob([E.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const I=this.workletNode=new AudioWorkletNode(A,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});I.connect(P),this.worker.postMessage({type:T.MsgTypes.PLAYSOUND,workletPort:I.port},[I.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:T.MsgTypes.STOPSOUND})}trigger(A,P){const I=this.events[A];if(!I)return;const $={};for(let V in P)$[V]=P[V];for(let V=0,J=I.length;V<J;V++)I[V]&&I[V].call(this,$)}exportAudio(A,P,I={}){return w.audioCtx||w.initWebAudio(),this.booted||this.boot(),new Promise(($,V)=>{this.audioExportResolve?V(new S.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:T.MsgTypes.EXPORT,mml:A,format:P},I)),this.audioExportResolve=$,this.audioExportReject=V)})}completeAudioExport(A){this.audioExportResolve&&(this.audioExportResolve(A),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(A){this.audioExportReject&&(this.audioExportReject(new S.FlMMLAudioExportError(A)),this.audioExportResolve=null,this.audioExportReject=null)}play(A){w.audioCtx||w.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:T.MsgTypes.PLAY,mml:A})}stop(){this.worker.postMessage({type:T.MsgTypes.STOP})}pause(){this.worker.postMessage({type:T.MsgTypes.PAUSE})}exportWav(A){return this.exportAudio(A,"wav")}exportMp3(A,P){return this.exportAudio(A,"mp3",{bitrate:P})}setMasterVolume(A){this.volume=A,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(A){this.worker.postMessage({type:T.MsgTypes.SYNCINFO,interval:A})}syncInfo(){this.worker.postMessage({type:T.MsgTypes.SYNCINFO,interval:null})}addEventListener(A,P){let I=this.events[A];I||(I=this.events[A]=[]);for(let $=I.length;$--;)if(I[$]===P)return!1;return I.push(P),!0}removeEventListener(A,P){const I=this.events[A];if(!I)return!1;for(let $=I.length;$--;)if(I[$]===P)return I.splice($,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}l.FlMML=w,l.FlMMLonHTML5=w}).apply(c,m))===void 0||(n.exports=u)},158:(n,c,v)=>{v.r(c),v.d(c,{FlMMLWorkletScript:()=>m});const m='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},o={};function s(n){var c=o[n];if(c!==void 0)return c.exports;var v=o[n]={exports:{}};return r[n].call(v.exports,v,v.exports,s),v.exports}return s.d=(n,c)=>{for(var v in c)s.o(c,v)&&!s.o(n,v)&&Object.defineProperty(n,v,{enumerable:!0,get:c[v]})},s.o=(n,c)=>Object.prototype.hasOwnProperty.call(n,c),s.r=n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},s(643)})()})})(Jn);var Qn=Jn.exports;function vt(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Zn={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(t,e){(function(r){t.exports=r()})(function(){return function r(o,s,n){function c(u,g){if(!s[u]){if(!o[u]){var d=typeof vt=="function"&&vt;if(!g&&d)return d(u,!0);if(v)return v(u,!0);var l=new Error("Cannot find module '"+u+"'");throw l.code="MODULE_NOT_FOUND",l}var T=s[u]={exports:{}};o[u][0].call(T.exports,function(S){var E=o[u][1][S];return c(E||S)},T,T.exports,r,o,s,n)}return s[u].exports}for(var v=typeof vt=="function"&&vt,m=0;m<n.length;m++)c(n[m]);return c}({1:[function(r,o,s){(function(n){var c=n.MutationObserver||n.WebKitMutationObserver,v;if(c){var m=0,u=new c(S),g=n.document.createTextNode("");u.observe(g,{characterData:!0}),v=function(){g.data=m=++m%2}}else if(!n.setImmediate&&typeof n.MessageChannel<"u"){var d=new n.MessageChannel;d.port1.onmessage=S,v=function(){d.port2.postMessage(0)}}else"document"in n&&"onreadystatechange"in n.document.createElement("script")?v=function(){var b=n.document.createElement("script");b.onreadystatechange=function(){S(),b.onreadystatechange=null,b.parentNode.removeChild(b),b=null},n.document.documentElement.appendChild(b)}:v=function(){setTimeout(S,0)};var l,T=[];function S(){l=!0;for(var b,w,B=T.length;B;){for(w=T,T=[],b=-1;++b<B;)w[b]();B=T.length}l=!1}o.exports=E;function E(b){T.push(b)===1&&!l&&v()}}).call(this,typeof at<"u"?at:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,o,s){var n=r(1);function c(){}var v={},m=["REJECTED"],u=["FULFILLED"],g=["PENDING"];o.exports=d;function d(I){if(typeof I!="function")throw new TypeError("resolver must be a function");this.state=g,this.queue=[],this.outcome=void 0,I!==c&&E(this,I)}d.prototype.catch=function(I){return this.then(null,I)},d.prototype.then=function(I,$){if(typeof I!="function"&&this.state===u||typeof $!="function"&&this.state===m)return this;var V=new this.constructor(c);if(this.state!==g){var J=this.state===u?I:$;T(V,J,this.outcome)}else this.queue.push(new l(V,I,$));return V};function l(I,$,V){this.promise=I,typeof $=="function"&&(this.onFulfilled=$,this.callFulfilled=this.otherCallFulfilled),typeof V=="function"&&(this.onRejected=V,this.callRejected=this.otherCallRejected)}l.prototype.callFulfilled=function(I){v.resolve(this.promise,I)},l.prototype.otherCallFulfilled=function(I){T(this.promise,this.onFulfilled,I)},l.prototype.callRejected=function(I){v.reject(this.promise,I)},l.prototype.otherCallRejected=function(I){T(this.promise,this.onRejected,I)};function T(I,$,V){n(function(){var J;try{J=$(V)}catch(oe){return v.reject(I,oe)}J===I?v.reject(I,new TypeError("Cannot resolve promise with itself")):v.resolve(I,J)})}v.resolve=function(I,$){var V=b(S,$);if(V.status==="error")return v.reject(I,V.value);var J=V.value;if(J)E(I,J);else{I.state=u,I.outcome=$;for(var oe=-1,ee=I.queue.length;++oe<ee;)I.queue[oe].callFulfilled($)}return I},v.reject=function(I,$){I.state=m,I.outcome=$;for(var V=-1,J=I.queue.length;++V<J;)I.queue[V].callRejected($);return I};function S(I){var $=I&&I.then;if(I&&(typeof I=="object"||typeof I=="function")&&typeof $=="function")return function(){$.apply(I,arguments)}}function E(I,$){var V=!1;function J(ae){V||(V=!0,v.reject(I,ae))}function oe(ae){V||(V=!0,v.resolve(I,ae))}function ee(){$(oe,J)}var fe=b(ee);fe.status==="error"&&J(fe.value)}function b(I,$){var V={};try{V.value=I($),V.status="success"}catch(J){V.status="error",V.value=J}return V}d.resolve=w;function w(I){return I instanceof this?I:v.resolve(new this(c),I)}d.reject=B;function B(I){var $=new this(c);return v.reject($,I)}d.all=A;function A(I){var $=this;if(Object.prototype.toString.call(I)!=="[object Array]")return this.reject(new TypeError("must be an array"));var V=I.length,J=!1;if(!V)return this.resolve([]);for(var oe=new Array(V),ee=0,fe=-1,ae=new this(c);++fe<V;)ge(I[fe],fe);return ae;function ge(L,k){$.resolve(L).then(j,function(z){J||(J=!0,v.reject(ae,z))});function j(z){oe[k]=z,++ee===V&&!J&&(J=!0,v.resolve(ae,oe))}}}d.race=P;function P(I){var $=this;if(Object.prototype.toString.call(I)!=="[object Array]")return this.reject(new TypeError("must be an array"));var V=I.length,J=!1;if(!V)return this.resolve([]);for(var oe=-1,ee=new this(c);++oe<V;)fe(I[oe]);return ee;function fe(ae){$.resolve(ae).then(function(ge){J||(J=!0,v.resolve(ee,ge))},function(ge){J||(J=!0,v.reject(ee,ge))})}}},{1:1}],3:[function(r,o,s){(function(n){typeof n.Promise!="function"&&(n.Promise=r(2))}).call(this,typeof at<"u"?at:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,o,s){var n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};function c(a,f){if(!(a instanceof f))throw new TypeError("Cannot call a class as a function")}function v(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var m=v();function u(){try{if(!m||!m.open)return!1;var a=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),f=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!a||f)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function g(a,f){a=a||[],f=f||{};try{return new Blob(a,f)}catch(h){if(h.name!=="TypeError")throw h;for(var i=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,p=new i,y=0;y<a.length;y+=1)p.append(a[y]);return p.getBlob(f.type)}}typeof Promise>"u"&&r(3);var d=Promise;function l(a,f){f&&a.then(function(i){f(null,i)},function(i){f(i)})}function T(a,f,i){typeof f=="function"&&a.then(f),typeof i=="function"&&a.catch(i)}function S(a){return typeof a!="string"&&(console.warn(a+" used as a key, but it is not a string."),a=String(a)),a}function E(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var b="local-forage-detect-blob-support",w=void 0,B={},A=Object.prototype.toString,P="readonly",I="readwrite";function $(a){for(var f=a.length,i=new ArrayBuffer(f),p=new Uint8Array(i),y=0;y<f;y++)p[y]=a.charCodeAt(y);return i}function V(a){return new d(function(f){var i=a.transaction(b,I),p=g([""]);i.objectStore(b).put(p,"key"),i.onabort=function(y){y.preventDefault(),y.stopPropagation(),f(!1)},i.oncomplete=function(){var y=navigator.userAgent.match(/Chrome\/(\d+)/),h=navigator.userAgent.match(/Edge\//);f(h||!y||parseInt(y[1],10)>=43)}}).catch(function(){return!1})}function J(a){return typeof w=="boolean"?d.resolve(w):V(a).then(function(f){return w=f,w})}function oe(a){var f=B[a.name],i={};i.promise=new d(function(p,y){i.resolve=p,i.reject=y}),f.deferredOperations.push(i),f.dbReady?f.dbReady=f.dbReady.then(function(){return i.promise}):f.dbReady=i.promise}function ee(a){var f=B[a.name],i=f.deferredOperations.pop();if(i)return i.resolve(),i.promise}function fe(a,f){var i=B[a.name],p=i.deferredOperations.pop();if(p)return p.reject(f),p.promise}function ae(a,f){return new d(function(i,p){if(B[a.name]=B[a.name]||Q(),a.db)if(f)oe(a),a.db.close();else return i(a.db);var y=[a.name];f&&y.push(a.version);var h=m.open.apply(m,y);f&&(h.onupgradeneeded=function(C){var D=h.result;try{D.createObjectStore(a.storeName),C.oldVersion<=1&&D.createObjectStore(b)}catch(M){if(M.name==="ConstraintError")console.warn('The database "'+a.name+'" has been upgraded from version '+C.oldVersion+" to version "+C.newVersion+', but the storage "'+a.storeName+'" already exists.');else throw M}}),h.onerror=function(C){C.preventDefault(),p(h.error)},h.onsuccess=function(){var C=h.result;C.onversionchange=function(D){D.target.close()},i(C),ee(a)}})}function ge(a){return ae(a,!1)}function L(a){return ae(a,!0)}function k(a,f){if(!a.db)return!0;var i=!a.db.objectStoreNames.contains(a.storeName),p=a.version<a.db.version,y=a.version>a.db.version;if(p&&(a.version!==f&&console.warn('The database "'+a.name+`" can't be downgraded from version `+a.db.version+" to version "+a.version+"."),a.version=a.db.version),y||i){if(i){var h=a.db.version+1;h>a.version&&(a.version=h)}return!0}return!1}function j(a){return new d(function(f,i){var p=new FileReader;p.onerror=i,p.onloadend=function(y){var h=btoa(y.target.result||"");f({__local_forage_encoded_blob:!0,data:h,type:a.type})},p.readAsBinaryString(a)})}function z(a){var f=$(atob(a.data));return g([f],{type:a.type})}function _(a){return a&&a.__local_forage_encoded_blob}function q(a){var f=this,i=f._initReady().then(function(){var p=B[f._dbInfo.name];if(p&&p.dbReady)return p.dbReady});return T(i,a,a),i}function G(a){oe(a);for(var f=B[a.name],i=f.forages,p=0;p<i.length;p++){var y=i[p];y._dbInfo.db&&(y._dbInfo.db.close(),y._dbInfo.db=null)}return a.db=null,ge(a).then(function(h){return a.db=h,k(a)?L(a):h}).then(function(h){a.db=f.db=h;for(var C=0;C<i.length;C++)i[C]._dbInfo.db=h}).catch(function(h){throw fe(a,h),h})}function Y(a,f,i,p){p===void 0&&(p=1);try{var y=a.db.transaction(a.storeName,f);i(null,y)}catch(h){if(p>0&&(!a.db||h.name==="InvalidStateError"||h.name==="NotFoundError"))return d.resolve().then(function(){if(!a.db||h.name==="NotFoundError"&&!a.db.objectStoreNames.contains(a.storeName)&&a.version<=a.db.version)return a.db&&(a.version=a.db.version+1),L(a)}).then(function(){return G(a).then(function(){Y(a,f,i,p-1)})}).catch(i);i(h)}}function Q(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function me(a){var f=this,i={db:null};if(a)for(var p in a)i[p]=a[p];var y=B[i.name];y||(y=Q(),B[i.name]=y),y.forages.push(f),f._initReady||(f._initReady=f.ready,f.ready=q);var h=[];function C(){return d.resolve()}for(var D=0;D<y.forages.length;D++){var M=y.forages[D];M!==f&&h.push(M._initReady().catch(C))}var O=y.forages.slice(0);return d.all(h).then(function(){return i.db=y.db,ge(i)}).then(function(R){return i.db=R,k(i,f._defaultConfig.version)?L(i):R}).then(function(R){i.db=y.db=R,f._dbInfo=i;for(var W=0;W<O.length;W++){var te=O[W];te!==f&&(te._dbInfo.db=i.db,te._dbInfo.version=i.version)}})}function Ee(a,f){var i=this;a=S(a);var p=new d(function(y,h){i.ready().then(function(){Y(i._dbInfo,P,function(C,D){if(C)return h(C);try{var M=D.objectStore(i._dbInfo.storeName),O=M.get(a);O.onsuccess=function(){var R=O.result;R===void 0&&(R=null),_(R)&&(R=z(R)),y(R)},O.onerror=function(){h(O.error)}}catch(R){h(R)}})}).catch(h)});return l(p,f),p}function ke(a,f){var i=this,p=new d(function(y,h){i.ready().then(function(){Y(i._dbInfo,P,function(C,D){if(C)return h(C);try{var M=D.objectStore(i._dbInfo.storeName),O=M.openCursor(),R=1;O.onsuccess=function(){var W=O.result;if(W){var te=W.value;_(te)&&(te=z(te));var ce=a(te,W.key,R++);ce!==void 0?y(ce):W.continue()}else y()},O.onerror=function(){h(O.error)}}catch(W){h(W)}})}).catch(h)});return l(p,f),p}function x(a,f,i){var p=this;a=S(a);var y=new d(function(h,C){var D;p.ready().then(function(){return D=p._dbInfo,A.call(f)==="[object Blob]"?J(D.db).then(function(M){return M?f:j(f)}):f}).then(function(M){Y(p._dbInfo,I,function(O,R){if(O)return C(O);try{var W=R.objectStore(p._dbInfo.storeName);M===null&&(M=void 0);var te=W.put(M,a);R.oncomplete=function(){M===void 0&&(M=null),h(M)},R.onabort=R.onerror=function(){var ce=te.error?te.error:te.transaction.error;C(ce)}}catch(ce){C(ce)}})}).catch(C)});return l(y,i),y}function F(a,f){var i=this;a=S(a);var p=new d(function(y,h){i.ready().then(function(){Y(i._dbInfo,I,function(C,D){if(C)return h(C);try{var M=D.objectStore(i._dbInfo.storeName),O=M.delete(a);D.oncomplete=function(){y()},D.onerror=function(){h(O.error)},D.onabort=function(){var R=O.error?O.error:O.transaction.error;h(R)}}catch(R){h(R)}})}).catch(h)});return l(p,f),p}function K(a){var f=this,i=new d(function(p,y){f.ready().then(function(){Y(f._dbInfo,I,function(h,C){if(h)return y(h);try{var D=C.objectStore(f._dbInfo.storeName),M=D.clear();C.oncomplete=function(){p()},C.onabort=C.onerror=function(){var O=M.error?M.error:M.transaction.error;y(O)}}catch(O){y(O)}})}).catch(y)});return l(i,a),i}function X(a){var f=this,i=new d(function(p,y){f.ready().then(function(){Y(f._dbInfo,P,function(h,C){if(h)return y(h);try{var D=C.objectStore(f._dbInfo.storeName),M=D.count();M.onsuccess=function(){p(M.result)},M.onerror=function(){y(M.error)}}catch(O){y(O)}})}).catch(y)});return l(i,a),i}function ie(a,f){var i=this,p=new d(function(y,h){if(a<0){y(null);return}i.ready().then(function(){Y(i._dbInfo,P,function(C,D){if(C)return h(C);try{var M=D.objectStore(i._dbInfo.storeName),O=!1,R=M.openKeyCursor();R.onsuccess=function(){var W=R.result;if(!W){y(null);return}a===0||O?y(W.key):(O=!0,W.advance(a))},R.onerror=function(){h(R.error)}}catch(W){h(W)}})}).catch(h)});return l(p,f),p}function ne(a){var f=this,i=new d(function(p,y){f.ready().then(function(){Y(f._dbInfo,P,function(h,C){if(h)return y(h);try{var D=C.objectStore(f._dbInfo.storeName),M=D.openKeyCursor(),O=[];M.onsuccess=function(){var R=M.result;if(!R){p(O);return}O.push(R.key),R.continue()},M.onerror=function(){y(M.error)}}catch(R){y(R)}})}).catch(y)});return l(i,a),i}function Se(a,f){f=E.apply(this,arguments);var i=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||i.name,a.storeName=a.storeName||i.storeName);var p=this,y;if(!a.name)y=d.reject("Invalid arguments");else{var h=a.name===i.name&&p._dbInfo.db,C=h?d.resolve(p._dbInfo.db):ge(a).then(function(D){var M=B[a.name],O=M.forages;M.db=D;for(var R=0;R<O.length;R++)O[R]._dbInfo.db=D;return D});a.storeName?y=C.then(function(D){if(D.objectStoreNames.contains(a.storeName)){var M=D.version+1;oe(a);var O=B[a.name],R=O.forages;D.close();for(var W=0;W<R.length;W++){var te=R[W];te._dbInfo.db=null,te._dbInfo.version=M}var ce=new d(function(le,ve){var he=m.open(a.name,M);he.onerror=function(Ie){var nt=he.result;nt.close(),ve(Ie)},he.onupgradeneeded=function(){var Ie=he.result;Ie.deleteObjectStore(a.storeName)},he.onsuccess=function(){var Ie=he.result;Ie.close(),le(Ie)}});return ce.then(function(le){O.db=le;for(var ve=0;ve<R.length;ve++){var he=R[ve];he._dbInfo.db=le,ee(he._dbInfo)}}).catch(function(le){throw(fe(a,le)||d.resolve()).catch(function(){}),le})}}):y=C.then(function(D){oe(a);var M=B[a.name],O=M.forages;D.close();for(var R=0;R<O.length;R++){var W=O[R];W._dbInfo.db=null}var te=new d(function(ce,le){var ve=m.deleteDatabase(a.name);ve.onerror=function(){var he=ve.result;he&&he.close(),le(ve.error)},ve.onblocked=function(){console.warn('dropInstance blocked for database "'+a.name+'" until all open connections are closed')},ve.onsuccess=function(){var he=ve.result;he&&he.close(),ce(he)}});return te.then(function(ce){M.db=ce;for(var le=0;le<O.length;le++){var ve=O[le];ee(ve._dbInfo)}}).catch(function(ce){throw(fe(a,ce)||d.resolve()).catch(function(){}),ce})})}return l(y,f),y}var He={_driver:"asyncStorage",_initStorage:me,_support:u(),iterate:ke,getItem:Ee,setItem:x,removeItem:F,clear:K,length:X,key:ie,keys:ne,dropInstance:Se};function kr(){return typeof openDatabase=="function"}var Pe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",xr="~~local_forage_type~",Sn=/^~~local_forage_type~([^~]+)~/,ht="__lfsc__:",Rt=ht.length,Ut="arbf",$t="blob",wn="si08",Tn="ui08",kn="uic8",xn="si16",Cn="si32",In="ur16",Nn="ui32",An="fl32",Dn="fl64",_n=Rt+Ut.length,Ln=Object.prototype.toString;function Mn(a){var f=a.length*.75,i=a.length,p,y=0,h,C,D,M;a[a.length-1]==="="&&(f--,a[a.length-2]==="="&&f--);var O=new ArrayBuffer(f),R=new Uint8Array(O);for(p=0;p<i;p+=4)h=Pe.indexOf(a[p]),C=Pe.indexOf(a[p+1]),D=Pe.indexOf(a[p+2]),M=Pe.indexOf(a[p+3]),R[y++]=h<<2|C>>4,R[y++]=(C&15)<<4|D>>2,R[y++]=(D&3)<<6|M&63;return O}function Ft(a){var f=new Uint8Array(a),i="",p;for(p=0;p<f.length;p+=3)i+=Pe[f[p]>>2],i+=Pe[(f[p]&3)<<4|f[p+1]>>4],i+=Pe[(f[p+1]&15)<<2|f[p+2]>>6],i+=Pe[f[p+2]&63];return f.length%3===2?i=i.substring(0,i.length-1)+"=":f.length%3===1&&(i=i.substring(0,i.length-2)+"=="),i}function Cr(a,f){var i="";if(a&&(i=Ln.call(a)),a&&(i==="[object ArrayBuffer]"||a.buffer&&Ln.call(a.buffer)==="[object ArrayBuffer]")){var p,y=ht;a instanceof ArrayBuffer?(p=a,y+=Ut):(p=a.buffer,i==="[object Int8Array]"?y+=wn:i==="[object Uint8Array]"?y+=Tn:i==="[object Uint8ClampedArray]"?y+=kn:i==="[object Int16Array]"?y+=xn:i==="[object Uint16Array]"?y+=In:i==="[object Int32Array]"?y+=Cn:i==="[object Uint32Array]"?y+=Nn:i==="[object Float32Array]"?y+=An:i==="[object Float64Array]"?y+=Dn:f(new Error("Failed to get type for BinaryArray"))),f(y+Ft(p))}else if(i==="[object Blob]"){var h=new FileReader;h.onload=function(){var C=xr+a.type+"~"+Ft(this.result);f(ht+$t+C)},h.readAsArrayBuffer(a)}else try{f(JSON.stringify(a))}catch(C){console.error("Couldn't convert value into a JSON string: ",a),f(null,C)}}function Ir(a){if(a.substring(0,Rt)!==ht)return JSON.parse(a);var f=a.substring(_n),i=a.substring(Rt,_n),p;if(i===$t&&Sn.test(f)){var y=f.match(Sn);p=y[1],f=f.substring(y[0].length)}var h=Mn(f);switch(i){case Ut:return h;case $t:return g([h],{type:p});case wn:return new Int8Array(h);case Tn:return new Uint8Array(h);case kn:return new Uint8ClampedArray(h);case xn:return new Int16Array(h);case In:return new Uint16Array(h);case Cn:return new Int32Array(h);case Nn:return new Uint32Array(h);case An:return new Float32Array(h);case Dn:return new Float64Array(h);default:throw new Error("Unkown type: "+i)}}var Vt={serialize:Cr,deserialize:Ir,stringToBuffer:Mn,bufferToString:Ft};function On(a,f,i,p){a.executeSql("CREATE TABLE IF NOT EXISTS "+f.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],i,p)}function Nr(a){var f=this,i={db:null};if(a)for(var p in a)i[p]=typeof a[p]!="string"?a[p].toString():a[p];var y=new d(function(h,C){try{i.db=openDatabase(i.name,String(i.version),i.description,i.size)}catch(D){return C(D)}i.db.transaction(function(D){On(D,i,function(){f._dbInfo=i,h()},function(M,O){C(O)})},C)});return i.serializer=Vt,y}function je(a,f,i,p,y,h){a.executeSql(i,p,y,function(C,D){D.code===D.SYNTAX_ERR?C.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[f.storeName],function(M,O){O.rows.length?h(M,D):On(M,f,function(){M.executeSql(i,p,y,h)},h)},h):h(C,D)},h)}function Ar(a,f){var i=this;a=S(a);var p=new d(function(y,h){i.ready().then(function(){var C=i._dbInfo;C.db.transaction(function(D){je(D,C,"SELECT * FROM "+C.storeName+" WHERE key = ? LIMIT 1",[a],function(M,O){var R=O.rows.length?O.rows.item(0).value:null;R&&(R=C.serializer.deserialize(R)),y(R)},function(M,O){h(O)})})}).catch(h)});return l(p,f),p}function Dr(a,f){var i=this,p=new d(function(y,h){i.ready().then(function(){var C=i._dbInfo;C.db.transaction(function(D){je(D,C,"SELECT * FROM "+C.storeName,[],function(M,O){for(var R=O.rows,W=R.length,te=0;te<W;te++){var ce=R.item(te),le=ce.value;if(le&&(le=C.serializer.deserialize(le)),le=a(le,ce.key,te+1),le!==void 0){y(le);return}}y()},function(M,O){h(O)})})}).catch(h)});return l(p,f),p}function Pn(a,f,i,p){var y=this;a=S(a);var h=new d(function(C,D){y.ready().then(function(){f===void 0&&(f=null);var M=f,O=y._dbInfo;O.serializer.serialize(f,function(R,W){W?D(W):O.db.transaction(function(te){je(te,O,"INSERT OR REPLACE INTO "+O.storeName+" (key, value) VALUES (?, ?)",[a,R],function(){C(M)},function(ce,le){D(le)})},function(te){if(te.code===te.QUOTA_ERR){if(p>0){C(Pn.apply(y,[a,M,i,p-1]));return}D(te)}})})}).catch(D)});return l(h,i),h}function _r(a,f,i){return Pn.apply(this,[a,f,i,1])}function Lr(a,f){var i=this;a=S(a);var p=new d(function(y,h){i.ready().then(function(){var C=i._dbInfo;C.db.transaction(function(D){je(D,C,"DELETE FROM "+C.storeName+" WHERE key = ?",[a],function(){y()},function(M,O){h(O)})})}).catch(h)});return l(p,f),p}function Mr(a){var f=this,i=new d(function(p,y){f.ready().then(function(){var h=f._dbInfo;h.db.transaction(function(C){je(C,h,"DELETE FROM "+h.storeName,[],function(){p()},function(D,M){y(M)})})}).catch(y)});return l(i,a),i}function Or(a){var f=this,i=new d(function(p,y){f.ready().then(function(){var h=f._dbInfo;h.db.transaction(function(C){je(C,h,"SELECT COUNT(key) as c FROM "+h.storeName,[],function(D,M){var O=M.rows.item(0).c;p(O)},function(D,M){y(M)})})}).catch(y)});return l(i,a),i}function Pr(a,f){var i=this,p=new d(function(y,h){i.ready().then(function(){var C=i._dbInfo;C.db.transaction(function(D){je(D,C,"SELECT key FROM "+C.storeName+" WHERE id = ? LIMIT 1",[a+1],function(M,O){var R=O.rows.length?O.rows.item(0).key:null;y(R)},function(M,O){h(O)})})}).catch(h)});return l(p,f),p}function jr(a){var f=this,i=new d(function(p,y){f.ready().then(function(){var h=f._dbInfo;h.db.transaction(function(C){je(C,h,"SELECT key FROM "+h.storeName,[],function(D,M){for(var O=[],R=0;R<M.rows.length;R++)O.push(M.rows.item(R).key);p(O)},function(D,M){y(M)})})}).catch(y)});return l(i,a),i}function Br(a){return new d(function(f,i){a.transaction(function(p){p.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(y,h){for(var C=[],D=0;D<h.rows.length;D++)C.push(h.rows.item(D).name);f({db:a,storeNames:C})},function(y,h){i(h)})},function(p){i(p)})})}function Rr(a,f){f=E.apply(this,arguments);var i=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||i.name,a.storeName=a.storeName||i.storeName);var p=this,y;return a.name?y=new d(function(h){var C;a.name===i.name?C=p._dbInfo.db:C=openDatabase(a.name,"","",0),a.storeName?h({db:C,storeNames:[a.storeName]}):h(Br(C))}).then(function(h){return new d(function(C,D){h.db.transaction(function(M){function O(ce){return new d(function(le,ve){M.executeSql("DROP TABLE IF EXISTS "+ce,[],function(){le()},function(he,Ie){ve(Ie)})})}for(var R=[],W=0,te=h.storeNames.length;W<te;W++)R.push(O(h.storeNames[W]));d.all(R).then(function(){C()}).catch(function(ce){D(ce)})},function(M){D(M)})})}):y=d.reject("Invalid arguments"),l(y,f),y}var Ur={_driver:"webSQLStorage",_initStorage:Nr,_support:kr(),iterate:Dr,getItem:Ar,setItem:_r,removeItem:Lr,clear:Mr,length:Or,key:Pr,keys:jr,dropInstance:Rr};function $r(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function jn(a,f){var i=a.name+"/";return a.storeName!==f.storeName&&(i+=a.storeName+"/"),i}function Fr(){var a="_localforage_support_test";try{return localStorage.setItem(a,!0),localStorage.removeItem(a),!1}catch{return!0}}function Vr(){return!Fr()||localStorage.length>0}function Wr(a){var f=this,i={};if(a)for(var p in a)i[p]=a[p];return i.keyPrefix=jn(a,f._defaultConfig),Vr()?(f._dbInfo=i,i.serializer=Vt,d.resolve()):d.reject()}function zr(a){var f=this,i=f.ready().then(function(){for(var p=f._dbInfo.keyPrefix,y=localStorage.length-1;y>=0;y--){var h=localStorage.key(y);h.indexOf(p)===0&&localStorage.removeItem(h)}});return l(i,a),i}function qr(a,f){var i=this;a=S(a);var p=i.ready().then(function(){var y=i._dbInfo,h=localStorage.getItem(y.keyPrefix+a);return h&&(h=y.serializer.deserialize(h)),h});return l(p,f),p}function Yr(a,f){var i=this,p=i.ready().then(function(){for(var y=i._dbInfo,h=y.keyPrefix,C=h.length,D=localStorage.length,M=1,O=0;O<D;O++){var R=localStorage.key(O);if(R.indexOf(h)===0){var W=localStorage.getItem(R);if(W&&(W=y.serializer.deserialize(W)),W=a(W,R.substring(C),M++),W!==void 0)return W}}});return l(p,f),p}function Hr(a,f){var i=this,p=i.ready().then(function(){var y=i._dbInfo,h;try{h=localStorage.key(a)}catch{h=null}return h&&(h=h.substring(y.keyPrefix.length)),h});return l(p,f),p}function Gr(a){var f=this,i=f.ready().then(function(){for(var p=f._dbInfo,y=localStorage.length,h=[],C=0;C<y;C++){var D=localStorage.key(C);D.indexOf(p.keyPrefix)===0&&h.push(D.substring(p.keyPrefix.length))}return h});return l(i,a),i}function Kr(a){var f=this,i=f.keys().then(function(p){return p.length});return l(i,a),i}function Xr(a,f){var i=this;a=S(a);var p=i.ready().then(function(){var y=i._dbInfo;localStorage.removeItem(y.keyPrefix+a)});return l(p,f),p}function Jr(a,f,i){var p=this;a=S(a);var y=p.ready().then(function(){f===void 0&&(f=null);var h=f;return new d(function(C,D){var M=p._dbInfo;M.serializer.serialize(f,function(O,R){if(R)D(R);else try{localStorage.setItem(M.keyPrefix+a,O),C(h)}catch(W){(W.name==="QuotaExceededError"||W.name==="NS_ERROR_DOM_QUOTA_REACHED")&&D(W),D(W)}})})});return l(y,i),y}function Qr(a,f){if(f=E.apply(this,arguments),a=typeof a!="function"&&a||{},!a.name){var i=this.config();a.name=a.name||i.name,a.storeName=a.storeName||i.storeName}var p=this,y;return a.name?y=new d(function(h){a.storeName?h(jn(a,p._defaultConfig)):h(a.name+"/")}).then(function(h){for(var C=localStorage.length-1;C>=0;C--){var D=localStorage.key(C);D.indexOf(h)===0&&localStorage.removeItem(D)}}):y=d.reject("Invalid arguments"),l(y,f),y}var Zr={_driver:"localStorageWrapper",_initStorage:Wr,_support:$r(),iterate:Yr,getItem:qr,setItem:Jr,removeItem:Xr,clear:zr,length:Kr,key:Hr,keys:Gr,dropInstance:Qr},ea=function(f,i){return f===i||typeof f=="number"&&typeof i=="number"&&isNaN(f)&&isNaN(i)},ta=function(f,i){for(var p=f.length,y=0;y<p;){if(ea(f[y],i))return!0;y++}return!1},Bn=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},tt={},Rn={},Ge={INDEXEDDB:He,WEBSQL:Ur,LOCALSTORAGE:Zr},na=[Ge.INDEXEDDB._driver,Ge.WEBSQL._driver,Ge.LOCALSTORAGE._driver],pt=["dropInstance"],Wt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(pt),ra={description:"",driver:na.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function aa(a,f){a[f]=function(){var i=arguments;return a.ready().then(function(){return a[f].apply(a,i)})}}function zt(){for(var a=1;a<arguments.length;a++){var f=arguments[a];if(f)for(var i in f)f.hasOwnProperty(i)&&(Bn(f[i])?arguments[0][i]=f[i].slice():arguments[0][i]=f[i])}return arguments[0]}var oa=function(){function a(f){c(this,a);for(var i in Ge)if(Ge.hasOwnProperty(i)){var p=Ge[i],y=p._driver;this[i]=y,tt[y]||this.defineDriver(p)}this._defaultConfig=zt({},ra),this._config=zt({},this._defaultConfig,f),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return a.prototype.config=function(i){if((typeof i>"u"?"undefined":n(i))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var p in i){if(p==="storeName"&&(i[p]=i[p].replace(/\W/g,"_")),p==="version"&&typeof i[p]!="number")return new Error("Database version must be a number.");this._config[p]=i[p]}return"driver"in i&&i.driver?this.setDriver(this._config.driver):!0}else return typeof i=="string"?this._config[i]:this._config},a.prototype.defineDriver=function(i,p,y){var h=new d(function(C,D){try{var M=i._driver,O=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!i._driver){D(O);return}for(var R=Wt.concat("_initStorage"),W=0,te=R.length;W<te;W++){var ce=R[W],le=!ta(pt,ce);if((le||i[ce])&&typeof i[ce]!="function"){D(O);return}}var ve=function(){for(var nt=function(ca){return function(){var la=new Error("Method "+ca+" is not implemented by the current driver"),Un=d.reject(la);return l(Un,arguments[arguments.length-1]),Un}},qt=0,ia=pt.length;qt<ia;qt++){var Yt=pt[qt];i[Yt]||(i[Yt]=nt(Yt))}};ve();var he=function(nt){tt[M]&&console.info("Redefining LocalForage driver: "+M),tt[M]=i,Rn[M]=nt,C()};"_support"in i?i._support&&typeof i._support=="function"?i._support().then(he,D):he(!!i._support):he(!0)}catch(Ie){D(Ie)}});return T(h,p,y),h},a.prototype.driver=function(){return this._driver||null},a.prototype.getDriver=function(i,p,y){var h=tt[i]?d.resolve(tt[i]):d.reject(new Error("Driver not found."));return T(h,p,y),h},a.prototype.getSerializer=function(i){var p=d.resolve(Vt);return T(p,i),p},a.prototype.ready=function(i){var p=this,y=p._driverSet.then(function(){return p._ready===null&&(p._ready=p._initDriver()),p._ready});return T(y,i,i),y},a.prototype.setDriver=function(i,p,y){var h=this;Bn(i)||(i=[i]);var C=this._getSupportedDrivers(i);function D(){h._config.driver=h.driver()}function M(W){return h._extend(W),D(),h._ready=h._initStorage(h._config),h._ready}function O(W){return function(){var te=0;function ce(){for(;te<W.length;){var le=W[te];return te++,h._dbInfo=null,h._ready=null,h.getDriver(le).then(M).catch(ce)}D();var ve=new Error("No available storage method found.");return h._driverSet=d.reject(ve),h._driverSet}return ce()}}var R=this._driverSet!==null?this._driverSet.catch(function(){return d.resolve()}):d.resolve();return this._driverSet=R.then(function(){var W=C[0];return h._dbInfo=null,h._ready=null,h.getDriver(W).then(function(te){h._driver=te._driver,D(),h._wrapLibraryMethodsWithReady(),h._initDriver=O(C)})}).catch(function(){D();var W=new Error("No available storage method found.");return h._driverSet=d.reject(W),h._driverSet}),T(this._driverSet,p,y),this._driverSet},a.prototype.supports=function(i){return!!Rn[i]},a.prototype._extend=function(i){zt(this,i)},a.prototype._getSupportedDrivers=function(i){for(var p=[],y=0,h=i.length;y<h;y++){var C=i[y];this.supports(C)&&p.push(C)}return p},a.prototype._wrapLibraryMethodsWithReady=function(){for(var i=0,p=Wt.length;i<p;i++)aa(this,Wt[i])},a.prototype.createInstance=function(i){return new a(i)},a}(),sa=new oa;o.exports=sa},{3:3}]},{},[4])(4)})})(Zn);var fa=Zn.exports;const nn=da(fa);function gt(t){if(typeof t!="string"||!t)throw new Error("expected a non-empty string, got: "+t)}function Ht(t){if(typeof t!="number")throw new Error("expected a number, got: "+t)}const ma=1,ha=1,Ye="emoji",Ze="keyvalue",pn="favorites",pa="tokens",er="tokens",va="unicode",tr="count",ga="group",ya="order",nr="group-order",rn="eTag",Tt="url",Fn="skinTone",et="readonly",vn="readwrite",rr="skinUnicodes",ba="skinUnicodes",Ea="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Sa="en";function wa(t,e){const r=new Set,o=[];for(const s of t){const n=e(s);r.has(n)||(r.add(n),o.push(s))}return o}function Vn(t){return wa(t,e=>e.unicode)}function Ta(t){function e(r,o,s){const n=o?t.createObjectStore(r,{keyPath:o}):t.createObjectStore(r);if(s)for(const[c,[v,m]]of Object.entries(s))n.createIndex(c,v,{multiEntry:m});return n}e(Ze),e(Ye,va,{[er]:[pa,!0],[nr]:[[ga,ya]],[rr]:[ba,!0]}),e(pn,void 0,{[tr]:[""]})}const an={},Et={},kt={};function ar(t,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>t(r.result)}async function ka(t){const e=await new Promise((r,o)=>{const s=indexedDB.open(t,ma);an[t]=s,s.onupgradeneeded=n=>{n.oldVersion<ha&&Ta(s.result)},ar(r,o,s)});return e.onclose=()=>gn(t),e}function xa(t){return Et[t]||(Et[t]=ka(t)),Et[t]}function Oe(t,e,r,o){return new Promise((s,n)=>{const c=t.transaction(e,r,{durability:"relaxed"}),v=typeof e=="string"?c.objectStore(e):e.map(u=>c.objectStore(u));let m;o(v,c,u=>{m=u}),c.oncomplete=()=>s(m),c.onerror=()=>n(c.error)})}function gn(t){const e=an[t],r=e&&e.result;if(r){r.close();const o=kt[t];if(o)for(const s of o)s()}delete an[t],delete Et[t],delete kt[t]}function Ca(t){return new Promise((e,r)=>{gn(t);const o=indexedDB.deleteDatabase(t);ar(e,r,o)})}function Ia(t,e){let r=kt[t];r||(r=kt[t]=[]),r.push(e)}const Na=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function Ke(t){return t.split(/[\s_]+/).map(e=>!e.match(/\w/)||Na.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const Aa=2;function or(t){return t.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Aa)}function Da(t){return t.map(({annotation:r,emoticon:o,group:s,order:n,shortcodes:c,skins:v,tags:m,emoji:u,version:g})=>{const d=[...new Set(or([...(c||[]).map(Ke).flat(),...m.map(Ke).flat(),...Ke(r),o]))].sort(),l={annotation:r,group:s,order:n,tags:m,tokens:d,unicode:u,version:g};if(o&&(l.emoticon=o),c&&(l.shortcodes=c),v){l.skinTones=[],l.skinUnicodes=[],l.skinVersions=[];for(const{tone:T,emoji:S,version:E}of v)l.skinTones.push(T),l.skinUnicodes.push(S),l.skinVersions.push(E)}return l})}function sr(t,e,r,o){t[e](r).onsuccess=s=>o&&o(s.target.result)}function qe(t,e,r){sr(t,"get",e,r)}function ir(t,e,r){sr(t,"getAll",e,r)}function yn(t){t.commit&&t.commit()}function _a(t,e){let r=t[0];for(let o=1;o<t.length;o++){const s=t[o];e(r)>e(s)&&(r=s)}return r}function cr(t,e){const r=_a(t,s=>s.length),o=[];for(const s of r)t.some(n=>n.findIndex(c=>e(c)===e(s))===-1)||o.push(s);return o}async function La(t){return!await bn(t,Ze,Tt)}async function Ma(t,e,r){const[o,s]=await Promise.all([rn,Tt].map(n=>bn(t,Ze,n)));return o===r&&s===e}async function Oa(t,e){return Oe(t,Ye,et,(o,s,n)=>{let c;const v=()=>{o.getAll(c&&IDBKeyRange.lowerBound(c,!0),50).onsuccess=m=>{const u=m.target.result;for(const g of u)if(c=g.unicode,e(g))return n(g);if(u.length<50)return n();v()}};v()})}async function lr(t,e,r,o){try{const s=Da(e);await Oe(t,[Ye,Ze],vn,([n,c],v)=>{let m,u,g=0;function d(){++g===2&&l()}function l(){if(!(m===o&&u===r)){n.clear();for(const T of s)n.put(T);c.put(o,rn),c.put(r,Tt),yn(v)}}qe(c,rn,T=>{m=T,d()}),qe(c,Tt,T=>{u=T,d()})})}finally{}}async function Pa(t,e){return Oe(t,Ye,et,(r,o,s)=>{const n=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);ir(r.index(nr),n,s)})}async function ur(t,e){const r=or(Ke(e));return r.length?Oe(t,Ye,et,(o,s,n)=>{const c=[],v=()=>{c.length===r.length&&m()},m=()=>{const u=cr(c,g=>g.unicode);n(u.sort((g,d)=>g.order<d.order?-1:1))};for(let u=0;u<r.length;u++){const g=r[u],d=u===r.length-1?IDBKeyRange.bound(g,g+"￿",!1,!0):IDBKeyRange.only(g);ir(o.index(er),d,l=>{c.push(l),v()})}}):[]}async function ja(t,e){const r=await ur(t,e);return r.length?r.filter(o=>(o.shortcodes||[]).map(n=>n.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Oa(t,s=>(s.shortcodes||[]).includes(e.toLowerCase()))||null}async function Ba(t,e){return Oe(t,Ye,et,(r,o,s)=>qe(r,e,n=>{if(n)return s(n);qe(r.index(rr),e,c=>s(c||null))}))}function bn(t,e,r){return Oe(t,e,et,(o,s,n)=>qe(o,r,n))}function Ra(t,e,r,o){return Oe(t,e,vn,(s,n)=>{s.put(o,r),yn(n)})}function Ua(t,e){return Oe(t,pn,vn,(r,o)=>qe(r,e,s=>{r.put((s||0)+1,e),yn(o)}))}function $a(t,e,r){return r===0?[]:Oe(t,[pn,Ye],et,([o,s],n,c)=>{const v=[];o.index(tr).openCursor(void 0,"prev").onsuccess=m=>{const u=m.target.result;if(!u)return c(v);function g(T){if(v.push(T),v.length===r)return c(v);u.continue()}const d=u.primaryKey,l=e.byName(d);if(l)return g(l);qe(s,d,T=>{if(T)return g(T);u.continue()})}})}const yt="";function Fa(t,e){const r=new Map;for(const s of t){const n=e(s);for(const c of n){let v=r;for(let u=0;u<c.length;u++){const g=c.charAt(u);let d=v.get(g);d||(d=new Map,v.set(g,d)),v=d}let m=v.get(yt);m||(m=[],v.set(yt,m)),m.push(s)}}return(s,n)=>{let c=r;for(let u=0;u<s.length;u++){const g=s.charAt(u),d=c.get(g);if(d)c=d;else return[]}if(n)return c.get(yt)||[];const v=[],m=[c];for(;m.length;){const g=[...m.shift().entries()].sort((d,l)=>d[0]<l[0]?-1:1);for(const[d,l]of g)d===yt?v.push(...l):m.push(l)}return v}}const Va=["name","url"];function Wa(t){const e=t&&Array.isArray(t),r=e&&t.length&&(!t[0]||Va.some(o=>!(o in t[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function Wn(t){Wa(t);const e=(l,T)=>l.name.toLowerCase()<T.name.toLowerCase()?-1:1,r=t.sort(e),s=Fa(t,l=>[...new Set((l.shortcodes||[]).map(T=>Ke(T)).flat())]),n=l=>s(l,!0),c=l=>s(l,!1),v=l=>{const T=Ke(l),S=T.map((E,b)=>(b<T.length-1?n:c)(E));return cr(S,E=>E.name).sort(e)},m=new Map,u=new Map;for(const l of t){u.set(l.name.toLowerCase(),l);for(const T of l.shortcodes||[])m.set(T.toLowerCase(),l)}return{all:r,search:v,byShortcode:l=>m.get(l.toLowerCase()),byName:l=>u.get(l.toLowerCase())}}const za=typeof wrappedJSObject<"u";function rt(t){if(!t)return t;if(za&&(t=structuredClone(t)),delete t.tokens,t.skinTones){const e=t.skinTones.length;t.skins=Array(e);for(let r=0;r<e;r++)t.skins[r]={tone:t.skinTones[r],unicode:t.skinUnicodes[r],version:t.skinVersions[r]};delete t.skinTones,delete t.skinUnicodes,delete t.skinVersions}return t}function dr(t){t||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const qa=["annotation","emoji","group","order","tags","version"];function Ya(t){if(!t||!Array.isArray(t)||!t[0]||typeof t[0]!="object"||qa.some(e=>!(e in t[0])))throw new Error("Emoji data is in the wrong format")}function fr(t,e){if(Math.floor(t.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+t.status)}async function Ha(t){const e=await fetch(t,{method:"HEAD"});fr(e,t);const r=e.headers.get("etag");return dr(r),r}async function on(t){const e=await fetch(t);fr(e,t);const r=e.headers.get("etag");dr(r);const o=await e.json();return Ya(o),[r,o]}function Ga(t){for(var e="",r=new Uint8Array(t),o=r.byteLength,s=-1;++s<o;)e+=String.fromCharCode(r[s]);return e}function Ka(t){for(var e=t.length,r=new ArrayBuffer(e),o=new Uint8Array(r),s=-1;++s<e;)o[s]=t.charCodeAt(s);return r}async function mr(t){const e=JSON.stringify(t);let r=Ka(e);const o=await crypto.subtle.digest("SHA-1",r),s=Ga(o);return btoa(s)}async function Xa(t,e){let r,o=await Ha(e);if(!o){const s=await on(e);o=s[0],r=s[1],o||(o=await mr(r))}await Ma(t,e,o)||(r||(r=(await on(e))[1]),await lr(t,r,e,o))}async function Ja(t,e){let[r,o]=await on(e);r||(r=await mr(o)),await lr(t,o,e,r)}class Qa{constructor({dataSource:e=Ea,locale:r=Sa,customEmoji:o=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=Wn(o),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await xa(this._dbName);Ia(this._dbName,this._clear);const r=this.dataSource;await La(e)?await Ja(e,r):this._lazyUpdate=Xa(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return Ht(e),await this.ready(),Vn(await Pa(this._db,e)).map(rt)}async getEmojiBySearchQuery(e){gt(e),await this.ready();const r=this._custom.search(e),o=Vn(await ur(this._db,e)).map(rt);return[...r,...o]}async getEmojiByShortcode(e){gt(e),await this.ready();const r=this._custom.byShortcode(e);return r||rt(await ja(this._db,e))}async getEmojiByUnicodeOrName(e){gt(e),await this.ready();const r=this._custom.byName(e);return r||rt(await Ba(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await bn(this._db,Ze,Fn)||0}async setPreferredSkinTone(e){return Ht(e),await this.ready(),Ra(this._db,Ze,Fn,e)}async incrementFavoriteEmojiCount(e){return gt(e),await this.ready(),Ua(this._db,e)}async getTopFavoriteEmoji(e){return Ht(e),await this.ready(),(await $a(this._db,this._custom,e)).map(rt)}set customEmoji(e){this._custom=Wn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await gn(this._dbName)}async delete(){await this._shutdown(),await Ca(this._dbName)}}const sn=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([t,e,r])=>({id:t,emoji:e,name:r})),Gt=sn.slice(1),Za=2,zn=6,hr=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function qn(t){return t.unicode.includes("‍")}const eo={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},to=1e3,no="🖐️",ro=8,ao=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],pr='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',oo=(t,e)=>t<e?-1:t>e?1:0,Yn=(t,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const o=r.getContext("2d");return o.textBaseline="top",o.font=`100px ${pr}`,o.fillStyle=e,o.scale(.01,.01),o.fillText(t,0,0),o.getImageData(0,0,1,1).data},so=(t,e)=>{const r=[...t].join(","),o=[...e].join(",");return r===o&&!r.startsWith("0,0,0,")};function io(t){const e=Yn(t,"#000"),r=Yn(t,"#fff");return e&&r&&so(e,r)}function co(){const t=Object.entries(eo);try{for(const[e,r]of t)if(io(e))return r}catch{}finally{}return t[0][1]}let Kt;const Xt=()=>(Kt||(Kt=new Promise(t=>hr(()=>t(co())))),Kt),cn=new Map,lo="️",uo="\uD83C",fo="‍",mo=127995,ho=57339;function po(t,e){if(e===0)return t;const r=t.indexOf(fo);return r!==-1?t.substring(0,r)+String.fromCodePoint(mo+e-1)+t.substring(r):(t.endsWith(lo)&&(t=t.substring(0,t.length-1)),t+uo+String.fromCodePoint(ho+e-1))}function Ae(t){t.preventDefault(),t.stopPropagation()}function Jt(t,e,r){return e+=t?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function vr(t,e){const r=new Set,o=[];for(const s of t){const n=e(s);r.has(n)||(r.add(n),o.push(s))}return o}function vo(t,e){const r=o=>{const s={};for(const n of o)typeof n.tone=="number"&&n.version<=e&&(s[n.tone]=n.unicode);return s};return t.map(({unicode:o,skins:s,shortcodes:n,url:c,name:v,category:m,annotation:u})=>({unicode:o,name:v,shortcodes:n,url:c,category:m,annotation:u,id:o||v,skins:s&&r(s)}))}const St=requestAnimationFrame;let go=typeof ResizeObserver=="function";function yo(t,e,r){let o;go?(o=new ResizeObserver(s=>r(s[0].contentRect.width)),o.observe(t)):St(()=>r(t.getBoundingClientRect().width)),e.addEventListener("abort",()=>{o&&o.disconnect()})}function Hn(t){{const e=document.createRange();return e.selectNode(t.firstChild),e.getBoundingClientRect().width}}let Qt;function bo(t,e,r){for(const o of t){const s=r(o),n=Hn(s);typeof Qt>"u"&&(Qt=Hn(e));const c=n/1.8<Qt;cn.set(o.unicode,c)}}function Eo(t){return vr(t,e=>e)}function So(t){t&&(t.scrollTop=0)}function it(t,e,r){let o=t.get(e);return o||(o=r(),t.set(e,o)),o}function Gn(t){return""+t}function wo(t){const e=document.createElement("template");return e.innerHTML=t,e}const To=new WeakMap,ko=new WeakMap,xo=Symbol("un-keyed"),Co="replaceChildren"in Element.prototype;function Io(t,e){Co?t.replaceChildren(...e):(t.innerHTML="",t.append(...e))}function No(t,e){let r=t.firstChild,o=0;for(;r;){if(e[o]!==r)return!0;r=r.nextSibling,o++}return o!==e.length}function Ao(t,e){const{targetNode:r}=e;let{targetParentNode:o}=e,s=!1;o?s=No(o,t):(s=!0,e.targetNode=void 0,e.targetParentNode=o=r.parentNode),s&&Io(o,t)}function Do(t,e){for(const r of e){const{targetNode:o,currentExpression:s,binding:{expressionIndex:n,attributeName:c,attributeValuePre:v,attributeValuePost:m}}=r,u=t[n];if(s!==u)if(r.currentExpression=u,c)o.setAttribute(c,v+Gn(u)+m);else{let g;Array.isArray(u)?Ao(u,r):u instanceof Element?(g=u,o.replaceWith(g)):o.nodeValue=Gn(u),g&&(r.targetNode=g)}}}function _o(t){let e="",r=!1,o=!1,s=-1;const n=new Map,c=[];for(let m=0,u=t.length;m<u;m++){const g=t[m];if(e+=g,m===u-1)break;for(let w=0;w<g.length;w++)switch(g.charAt(w)){case"<":{g.charAt(w+1)==="/"?c.pop():(r=!0,c.push(++s));break}case">":{r=!1,o=!1;break}case"=":{o=!0;break}}const d=c[c.length-1],l=it(n,d,()=>[]);let T,S,E;if(o){const w=/(\S+)="?([^"=]*)$/.exec(g);T=w[1],S=w[2],E=/^[^">]*/.exec(t[m+1])[0]}const b={attributeName:T,attributeValuePre:S,attributeValuePost:E,expressionIndex:m};l.push(b),!r&&!o&&(e+=" ")}return{template:wo(e),elementsToBindings:n}}function Lo(t,e){const r=[],o=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT);let s=t,n=-1;do{const c=e.get(++n);if(c)for(let v=0;v<c.length;v++){const m=c[v],u=m.attributeName?s:s.firstChild,g={binding:m,targetNode:u,targetParentNode:void 0,currentExpression:void 0};r.push(g)}}while(s=o.nextNode());return r}function Mo(t){const{template:e,elementsToBindings:r}=it(To,t,()=>_o(t)),o=e.cloneNode(!0).content.firstElementChild,s=Lo(o,r);return function(c){return Do(c,s),o}}function Oo(t){const e=it(ko,t,()=>new Map);let r=xo;function o(n,...c){const v=it(e,n,()=>new Map);return it(v,r,()=>Mo(n))(c)}function s(n,c,v){return n.map((m,u)=>{const g=r;r=v(m);try{return c(m,u)}finally{r=g}})}return{map:s,html:o}}function Po(t,e,r,o,s,n,c,v){const{labelWithSkin:m,titleForEmoji:u,unicodeWithSkin:g}=r,{html:d,map:l}=Oo(e);function T(b,w,B){return l(b,(A,P)=>d`<button role="${w?"option":"menuitem"}" aria-selected="${e.searchMode?P===e.activeSearchItem:""}" aria-label="${m(A,e.currentSkinTone)}" title="${u(A)}" class="emoji ${w&&P===e.activeSearchItem?"active":""}" id="${`${B}-${A.id}`}">${A.unicode?g(A,e.currentSkinTone):d`<img class="custom-emoji" src="${A.url}" alt="" loading="lazy">`}</button>`,A=>`${B}-${A.id}`)}const E=d`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${l(e.skinTones,(b,w)=>d`<div id="skintone-${w}" class="emoji ${w===e.activeSkinTone?"active":""}" aria-selected="${w===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[w]}" aria-label="${e.i18n.skinTones[w]}">${b}</div>`,b=>b)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${l(e.groups,b=>d`<button role="tab" class="nav-button" aria-controls="tab-${b.id}" aria-label="${e.i18n.categories[b.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===b.id}" title="${e.i18n.categories[b.name]}" data-group-id="${b.id}"><div class="nav-emoji emoji">${b.emoji}</div></button>`,b=>b.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${l(e.currentEmojisWithCategories,(b,w)=>d`<div><div id="menu-label-${w}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:b.category?b.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${w}" id="${e.searchMode?"search-results":""}">${T(b.emojis,e.searchMode,"emo")}</div></div>`,b=>b.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${T(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(v){t.appendChild(E);const b=(w,B)=>{for(const A of t.querySelectorAll(`[${w}]`))B(A,A.getAttribute(w))};for(const w of["click","focusout","input","keydown","keyup"])b(`data-on-${w}`,(B,A)=>{B.addEventListener(w,o[A])});b("data-ref",(w,B)=>{n[B]=w}),b("data-action",(w,B)=>{s[B](w)}),c.addEventListener("abort",()=>{t.removeChild(E)})}}const xt=typeof queueMicrotask=="function"?queueMicrotask:t=>Promise.resolve().then(t);function jo(t){let e=!1,r;const o=new Map,s=new Set;let n;const c=()=>{if(e)return;const u=[...s];s.clear();try{for(const g of u)g()}finally{n=!1,s.size&&(n=!0,xt(c))}},v=new Proxy({},{get(u,g){if(r){let d=o.get(g);d||(d=new Set,o.set(g,d)),d.add(r)}return u[g]},set(u,g,d){u[g]=d;const l=o.get(g);if(l){for(const T of l)s.add(T);n||(n=!0,xt(c))}return!0}}),m=u=>{const g=()=>{const d=r;r=g;try{return u()}finally{r=d}};return g()};return t.addEventListener("abort",()=>{e=!0}),{state:v,createEffect:m}}function Zt(t,e,r){if(t.length!==e.length)return!1;for(let o=0;o<t.length;o++)if(!r(t[o],e[o]))return!1;return!0}const en=[],{assign:bt}=Object;function Bo(t,e){const r={},o=new AbortController,s=o.signal,{state:n,createEffect:c}=jo(s);bt(n,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),bt(n,e),bt(n,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:ro,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:Gt,databaseLoaded:!1,activeSearchItemId:void 0}),c(()=>{n.currentGroup!==n.groups[n.currentGroupIndex]&&(n.currentGroup=n.groups[n.currentGroupIndex])});const v=x=>{t.getElementById(x).focus()},m=x=>t.getElementById(`emo-${x.id}`),u=(x,F)=>{r.rootElement.dispatchEvent(new CustomEvent(x,{detail:F,bubbles:!0,composed:!0}))},g=(x,F)=>x.id===F.id,d=(x,F)=>{const{category:K,emojis:X}=x,{category:ie,emojis:ne}=F;return K!==ie?!1:Zt(X,ne,g)},l=x=>{Zt(n.currentEmojis,x,g)||(n.currentEmojis=x)},T=x=>{n.searchMode!==x&&(n.searchMode=x)},S=x=>{Zt(n.currentEmojisWithCategories,x,d)||(n.currentEmojisWithCategories=x)},E=(x,F)=>F&&x.skins&&x.skins[F]||x.unicode,B={labelWithSkin:(x,F)=>Eo([x.name||E(x,F),x.annotation,...x.shortcodes||en].filter(Boolean)).join(", "),titleForEmoji:x=>x.annotation||(x.shortcodes||en).join(", "),unicodeWithSkin:E},A={onClickSkinToneButton:Y,onEmojiClick:_,onNavClick:k,onNavKeydown:j,onSearchKeydown:L,onSkinToneOptionsClick:G,onSkinToneOptionsFocusOut:Ee,onSkinToneOptionsKeydown:Q,onSkinToneOptionsKeyup:me,onSearchInput:ke},P={calculateEmojiGridStyle:V};let I=!0;c(()=>{Po(t,n,B,A,P,r,s,I),I=!1}),n.emojiVersion||Xt().then(x=>{x||(n.message=n.i18n.emojiUnsupportedMessage)}),c(()=>{async function x(){let F=!1;const K=setTimeout(()=>{F=!0,n.message=n.i18n.loadingMessage},to);try{await n.database.ready(),n.databaseLoaded=!0}catch(X){console.error(X),n.message=n.i18n.networkErrorMessage}finally{clearTimeout(K),F&&(F=!1,n.message="")}}n.database&&x()}),c(()=>{n.pickerStyle=`
      --num-groups: ${n.groups.length}; 
      --indicator-opacity: ${n.searchMode?0:1}; 
      --num-skintones: ${zn};`}),c(()=>{n.customEmoji&&n.database&&$()}),c(()=>{n.customEmoji&&n.customEmoji.length?n.groups!==sn&&(n.groups=sn):n.groups!==Gt&&(n.currentGroupIndex&&n.currentGroupIndex--,n.groups=Gt)}),c(()=>{async function x(){n.databaseLoaded&&(n.currentSkinTone=await n.database.getPreferredSkinTone())}x()}),c(()=>{n.skinTones=Array(zn).fill().map((x,F)=>po(n.skinToneEmoji,F))}),c(()=>{n.skinToneButtonText=n.skinTones[n.currentSkinTone]}),c(()=>{n.skinToneButtonLabel=n.i18n.skinToneLabel.replace("{skinTone}",n.i18n.skinTones[n.currentSkinTone])}),c(()=>{async function x(){const{database:F}=n,K=(await Promise.all(ao.map(X=>F.getEmojiByUnicodeOrName(X)))).filter(Boolean);n.defaultFavoriteEmojis=K}n.databaseLoaded&&x()});function $(){n.database.customEmoji=n.customEmoji||en}c(()=>{async function x(){$();const{database:F,defaultFavoriteEmojis:K,numColumns:X}=n,ie=await F.getTopFavoriteEmoji(X),ne=await fe(vr([...ie,...K],Se=>Se.unicode||Se.name).slice(0,X));n.currentFavorites=ne}n.databaseLoaded&&n.defaultFavoriteEmojis&&x()});function V(x){yo(x,s,F=>{{const K=getComputedStyle(r.rootElement),X=parseInt(K.getPropertyValue("--num-columns"),10),ie=K.getPropertyValue("direction")==="rtl",Se=x.parentElement.getBoundingClientRect().width-F;n.numColumns=X,n.scrollbarWidth=Se,n.isRtl=ie}})}c(()=>{async function x(){const{searchText:F,currentGroup:K,databaseLoaded:X,customEmoji:ie}=n;if(!X)n.currentEmojis=[],n.searchMode=!1;else if(F.length>=Za){const ne=await ge(F);n.searchText===F&&(l(ne),T(!0))}else{const{id:ne}=K;if(ne!==-1||ie&&ie.length){const Se=await ae(ne);n.currentGroup.id===ne&&(l(Se),T(!1))}}}x()}),c(()=>{const{currentEmojis:x,emojiVersion:F}=n,K=x.filter(X=>X.unicode).filter(X=>qn(X)&&!cn.has(X.unicode));if(!F&&K.length)l(x),St(()=>J(K));else{const X=F?x:x.filter(oe);l(X),St(()=>So(r.tabpanelElement))}});function J(x){bo(x,r.baselineEmoji,m),n.currentEmojis=n.currentEmojis}function oe(x){return!x.unicode||!qn(x)||cn.get(x.unicode)}async function ee(x){const F=n.emojiVersion||await Xt();return x.filter(({version:K})=>!K||K<=F)}async function fe(x){return vo(x,n.emojiVersion||await Xt())}async function ae(x){const F=x===-1?n.customEmoji:await n.database.getEmojiByGroup(x);return fe(await ee(F))}async function ge(x){return fe(await ee(await n.database.getEmojiBySearchQuery(x)))}c(()=>{}),c(()=>{function x(){const{searchMode:K,currentEmojis:X}=n;if(K)return[{category:"",emojis:X}];const ie=new Map;for(const ne of X){const Se=ne.category||"";let He=ie.get(Se);He||(He=[],ie.set(Se,He)),He.push(ne)}return[...ie.entries()].map(([ne,Se])=>({category:ne,emojis:Se})).sort((ne,Se)=>n.customCategorySorting(ne.category,Se.category))}const F=x();S(F)}),c(()=>{n.activeSearchItemId=n.activeSearchItem!==-1&&n.currentEmojis[n.activeSearchItem].id}),c(()=>{const{rawSearchText:x}=n;hr(()=>{n.searchText=(x||"").trim(),n.activeSearchItem=-1})});function L(x){if(!n.searchMode||!n.currentEmojis.length)return;const F=K=>{Ae(x),n.activeSearchItem=Jt(K,n.activeSearchItem,n.currentEmojis)};switch(x.key){case"ArrowDown":return F(!1);case"ArrowUp":return F(!0);case"Enter":if(n.activeSearchItem===-1)n.activeSearchItem=0;else return Ae(x),z(n.currentEmojis[n.activeSearchItem].id)}}function k(x){const{target:F}=x,K=F.closest(".nav-button");if(!K)return;const X=parseInt(K.dataset.groupId,10);r.searchElement.value="",n.rawSearchText="",n.searchText="",n.activeSearchItem=-1,n.currentGroupIndex=n.groups.findIndex(ie=>ie.id===X)}function j(x){const{target:F,key:K}=x,X=ie=>{ie&&(Ae(x),ie.focus())};switch(K){case"ArrowLeft":return X(F.previousElementSibling);case"ArrowRight":return X(F.nextElementSibling);case"Home":return X(F.parentElement.firstElementChild);case"End":return X(F.parentElement.lastElementChild)}}async function z(x){const F=await n.database.getEmojiByUnicodeOrName(x),K=[...n.currentEmojis,...n.currentFavorites].find(ie=>ie.id===x),X=K.unicode&&E(K,n.currentSkinTone);await n.database.incrementFavoriteEmojiCount(x),u("emoji-click",{emoji:F,skinTone:n.currentSkinTone,...X&&{unicode:X},...K.name&&{name:K.name}})}async function _(x){const{target:F}=x;if(!F.classList.contains("emoji"))return;Ae(x);const K=F.id.substring(4);z(K)}function q(x){n.currentSkinTone=x,n.skinTonePickerExpanded=!1,v("skintone-button"),u("skin-tone-change",{skinTone:x}),n.database.setPreferredSkinTone(x)}function G(x){const{target:{id:F}}=x,K=F&&F.match(/^skintone-(\d)/);if(!K)return;Ae(x);const X=parseInt(K[1],10);q(X)}function Y(x){n.skinTonePickerExpanded=!n.skinTonePickerExpanded,n.activeSkinTone=n.currentSkinTone,n.skinTonePickerExpanded&&(Ae(x),St(()=>v("skintone-list")))}c(()=>{n.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{n.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):n.skinTonePickerExpandedAfterAnimation=!1});function Q(x){if(!n.skinTonePickerExpanded)return;const F=async K=>{Ae(x),n.activeSkinTone=K};switch(x.key){case"ArrowUp":return F(Jt(!0,n.activeSkinTone,n.skinTones));case"ArrowDown":return F(Jt(!1,n.activeSkinTone,n.skinTones));case"Home":return F(0);case"End":return F(n.skinTones.length-1);case"Enter":return Ae(x),q(n.activeSkinTone);case"Escape":return Ae(x),n.skinTonePickerExpanded=!1,v("skintone-button")}}function me(x){if(n.skinTonePickerExpanded)switch(x.key){case" ":return Ae(x),q(n.activeSkinTone)}}async function Ee(x){const{relatedTarget:F}=x;(!F||F.id!=="skintone-list")&&(n.skinTonePickerExpanded=!1)}function ke(x){n.rawSearchText=x.target.value}return{$set(x){bt(n,x)},$destroy(){o.abort()}}}const Ro="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Uo="en";var $o={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Fo=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const gr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],Vo=`:host{--emoji-font-family:${pr}}`;class En extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=Fo+Vo,this.shadowRoot.appendChild(r),this._ctx={locale:Uo,dataSource:Ro,skinToneEmoji:no,customCategorySorting:oo,customEmoji:null,i18n:$o,emojiVersion:null,...e};for(const o of gr)o!=="database"&&Object.prototype.hasOwnProperty.call(this,o)&&(this._ctx[o]=this[o],delete this[o]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Bo(this.shadowRoot,this._ctx))}disconnectedCallback(){xt(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,o){this._set(e.replace(/-([a-z])/g,(s,n)=>n.toUpperCase()),e==="emoji-version"?parseFloat(o):o)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:o}=this._ctx;(!o||o.locale!==e||o.dataSource!==r)&&this._set("database",new Qa({locale:e,dataSource:r}))}_dbFlush(){xt(()=>this._dbCreate())}}const yr={};for(const t of gr)yr[t]={get(){return t==="database"&&this._dbCreate(),this._ctx[t]},set(e){if(t==="database")throw new Error("database is read-only");this._set(t,e)}};Object.defineProperties(En.prototype,yr);customElements.get("emoji-picker")||customElements.define("emoji-picker",En);var ln={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(t,e){(function(r,o){o(e)})(at,function(r){var o="dnd-poly-",s=o+"snapback",n="dnd-poly-",c=n+"dragstart-pending",v=n+"dragstart-cancel",m=["none","copy","copyLink","copyMove","link","linkMove","move","all"],u=["none","copy","move","link"],g=function(){var L=!1;try{var k=Object.defineProperty({},"passive",{get:function(){L=!0}});window.addEventListener("test",null,k)}catch{}return L}();function d(L){return L&&L.tagName}function l(L,k,j){j===void 0&&(j=!0),document.addEventListener(L,k,!!g&&{passive:j})}function T(L,k){document.removeEventListener(L,k)}function S(L,k,j,z){z===void 0&&(z=!1);var _=g?{passive:!0,capture:z}:z;return L.addEventListener(k,j,_),{off:function(){L.removeEventListener(k,j,_)}}}function E(L){return L.length===0?0:L.reduce(function(k,j){return j+k},0)/L.length}function b(L,k){for(var j=0;j<L.changedTouches.length;j++)if(L.changedTouches[j].identifier===k)return!0;return!1}function w(L,k,j){for(var z=[],_=[],q=0;q<k.touches.length;q++){var G=k.touches[q];z.push(G[L+"X"]),_.push(G[L+"Y"])}j.x=E(z),j.y=E(_)}var B=["","-webkit-"];function A(L,k,j,z,_){_===void 0&&(_=!0);var q=k.x,G=k.y;z&&(q+=z.x,G+=z.y),_&&(q-=parseInt(L.offsetWidth,10)/2,G-=parseInt(L.offsetHeight,10)/2);for(var Y="translate3d("+q+"px,"+G+"px, 0)",Q=0;Q<B.length;Q++){var me=B[Q]+"transform";L.style[me]=Y+" "+j[Q]}}var P=function(){function L(k,j){this.t=k,this.i=j,this.s=u[0]}return Object.defineProperty(L.prototype,"dropEffect",{get:function(){return this.s},set:function(k){this.t.mode!==0&&m.indexOf(k)>-1&&(this.s=k)},enumerable:!0,configurable:!0}),Object.defineProperty(L.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(L.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(k){this.t.mode===2&&m.indexOf(k)>-1&&(this.t.effectAllowed=k)},enumerable:!0,configurable:!0}),L.prototype.setData=function(k,j){if(this.t.mode===2){if(k.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[k]=j,this.t.types.indexOf(k)===-1&&this.t.types.push(k)}},L.prototype.getData=function(k){if(this.t.mode===1||this.t.mode===2)return this.t.data[k]||""},L.prototype.clearData=function(k){if(this.t.mode===2){if(k&&this.t.data[k]){delete this.t.data[k];var j=this.t.types.indexOf(k);return void(j>-1&&this.t.types.splice(j,1))}this.t.data={},this.t.types=[]}},L.prototype.setDragImage=function(k,j,z){this.t.mode===2&&this.i(k,j,z)},L}();function I(L,k){return L?L===m[0]?u[0]:L.indexOf(m[1])===0||L===m[7]?u[1]:L.indexOf(m[4])===0?u[3]:L===m[6]?u[2]:u[1]:k.nodeType===3&&k.tagName==="A"?u[3]:u[1]}function $(L,k,j,z,_,q,G){q===void 0&&(q=!0),G===void 0&&(G=null);var Y=function(me,Ee,ke,x,F,K,X){X===void 0&&(X=null);var ie=Ee.changedTouches[0],ne=new Event(ke,{bubbles:!0,cancelable:x});ne.dataTransfer=K,ne.relatedTarget=X,ne.screenX=ie.screenX,ne.screenY=ie.screenY,ne.clientX=ie.clientX,ne.clientY=ie.clientY,ne.pageX=ie.pageX,ne.pageY=ie.pageY;var Se=me.getBoundingClientRect();return ne.offsetX=ne.clientX-Se.left,ne.offsetY=ne.clientY-Se.top,ne}(k,j,L,q,document.defaultView,_,G),Q=!k.dispatchEvent(Y);return z.mode=0,Q}function V(L,k){if(!L||L===m[7])return k;if(k===u[1]){if(L.indexOf(u[1])===0)return u[1]}else if(k===u[3]){if(L.indexOf(u[3])===0||L.indexOf("Link")>-1)return u[3]}else if(k===u[2]&&(L.indexOf(u[2])===0||L.indexOf("Move")>-1))return u[2];return u[0]}var J,oe=function(){function L(k,j,z,_){this.h=k,this.o=j,this.u=z,this.l=_,this.v=0,this.p=null,this.g=null,this.m=k,this.I=k.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),l("touchmove",this.j,!1),l("touchend",this.S,!1),l("touchcancel",this.S,!1)}return L.prototype.A=function(){var k=this;this.v=1,this.O=u[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var j=this.u;if(this.N=new P(this.D,function(Y,Q,me){j=Y,typeof Q!="number"&&typeof me!="number"||(k.P={x:Q||0,y:me||0})}),this.D.mode=2,this.N.dropEffect=u[0],$("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;w("page",this.m,this.F);var z,_=this.o.dragImageSetup(j);if(this.L=(z=_,B.map(function(Y){var Q=z.style[Y+"transform"];return Q&&Q!=="none"?Q.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),_.style.position="absolute",_.style.left="0px",_.style.top="0px",_.style.zIndex="999999",_.classList.add("dnd-poly-drag-image"),_.classList.add("dnd-poly-icon"),this._=_,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var q=getComputedStyle(j);this.P={x:0-parseInt(q.marginLeft,10),y:0-parseInt(q.marginTop,10)}}else{var G=j.getBoundingClientRect();q=getComputedStyle(j),this.P={x:G.left-this.I.clientX-parseInt(q.marginLeft,10)+G.width/2,y:G.top-this.I.clientY-parseInt(q.marginTop,10)+G.height/2}}return A(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){k.X||(k.X=!0,k.Y(),k.X=!1)},this.o.iterationInterval),!0},L.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),T("touchmove",this.j),T("touchend",this.S),T("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},L.prototype.C=function(k){var j=this;if(b(k,this.I.identifier)!==!1){if(this.m=k,this.v===0){var z=void 0;if(this.o.dragStartConditionOverride)try{z=this.o.dragStartConditionOverride(k)}catch{z=!1}else z=k.touches.length===1;return z?void(this.A()===!0&&(this.h.preventDefault(),k.preventDefault())):void this.T()}if(k.preventDefault(),w("client",k,this.M),w("page",k,this.F),this.o.dragImageTranslateOverride)try{var _=!1;if(this.o.dragImageTranslateOverride(k,{x:this.M.x,y:this.M.y},this.p,function(q,G){j._&&(_=!0,j.M.x+=q,j.M.y+=G,j.F.x+=q,j.F.y+=G,A(j._,j.F,j.L,j.P,j.o.dragImageCenterOnTouch))}),_)return}catch{}A(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},L.prototype.k=function(k){if(b(k,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(k.preventDefault(),this.v=k.type==="touchcancel"?3:2):this.T()}},L.prototype.Y=function(){var k=this,j=this.O;this.D.mode=3,this.N.dropEffect=u[0];var z=$("drag",this.u,this.m,this.D,this.N);if(z&&(this.O=u[0]),z||this.v===2||this.v===3)return this.q(this.v)?void function(Y,Q,me,Ee){var ke=getComputedStyle(Y);if(ke.visibility!=="hidden"&&ke.display!=="none"){Q.classList.add(s);var x=getComputedStyle(Q),F=parseFloat(x.transitionDuration);if(isNaN(F)||F===0)Ee();else{var K=Y.getBoundingClientRect(),X={x:K.left,y:K.top};X.x+=document.body.scrollLeft||document.documentElement.scrollLeft,X.y+=document.body.scrollTop||document.documentElement.scrollTop,X.x-=parseInt(ke.marginLeft,10),X.y-=parseInt(ke.marginTop,10);var ie=parseFloat(x.transitionDelay),ne=Math.round(1e3*(F+ie));A(Q,X,me,void 0,!1),setTimeout(Ee,ne)}}else Ee()}(this.u,this._,this.L,function(){k.B()}):void this.B();var _=this.o.elementFromPoint(this.M.x,this.M.y),q=this.g;_!==this.p&&_!==this.g&&(this.p=_,this.g!==null&&(this.D.mode=3,this.N.dropEffect=u[0],$("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=I(this.D.effectAllowed,this.u),$("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=V(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),q!==this.g&&d(q)&&(this.D.mode=3,this.N.dropEffect=u[0],$("dragleave",q,this.m,this.D,this.N,!1,this.g)),d(this.g)&&(this.D.mode=3,this.N.dropEffect=I(this.D.effectAllowed,this.u),$("dragover",this.g,this.m,this.D,this.N)===!1?this.O=u[0]:this.O=V(this.N.effectAllowed,this.N.dropEffect)),j!==this.O&&this._.classList.remove(o+j);var G=o+this.O;this._.classList.add(G)},L.prototype.q=function(k){var j=this.O===u[0]||this.g===null||k===3;return j?d(this.g)&&(this.D.mode=3,this.N.dropEffect=u[0],$("dragleave",this.g,this.m,this.D,this.N,!1)):d(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,$("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=u[0]),j},L.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,$("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},L}(),ee={iterationInterval:150,tryFindDraggableTarget:function(L){var k=L.target;do if(k.draggable!==!1&&(k.draggable===!0||k.getAttribute&&k.getAttribute("draggable")==="true"))return k;while((k=k.parentNode)&&k!==document.body)},dragImageSetup:function(L){var k=L.cloneNode(!0);return function j(z,_){if(z.nodeType===1){for(var q=getComputedStyle(z),G=0;G<q.length;G++){var Y=q[G];_.style.setProperty(Y,q.getPropertyValue(Y),q.getPropertyPriority(Y))}if(_.style.pointerEvents="none",_.removeAttribute("id"),_.removeAttribute("class"),_.removeAttribute("draggable"),_.nodeName==="CANVAS"){var Q=z,me=_,Ee=Q.getContext("2d").getImageData(0,0,Q.width,Q.height);me.getContext("2d").putImageData(Ee,0,0)}}if(z.hasChildNodes())for(G=0;G<z.childNodes.length;G++)j(z.childNodes[G],_.childNodes[G])}(L,k),k},elementFromPoint:function(L,k){return document.elementFromPoint(L,k)}};function fe(L){if(!J){var k=ee.tryFindDraggableTarget(L);if(k)try{J=new oe(L,ee,k,ge)}catch(j){throw ge(ee,L,3),j}}}function ae(L){var k=L.target,j=function(Q){_.off(),q.off(),G.off(),Y.off(),k&&k.dispatchEvent(new CustomEvent(v,{bubbles:!0,cancelable:!0})),clearTimeout(z)};k&&k.dispatchEvent(new CustomEvent(c,{bubbles:!0,cancelable:!0}));var z=window.setTimeout(function(){_.off(),q.off(),G.off(),Y.off(),fe(L)},ee.holdToDrag),_=S(k,"touchend",j),q=S(k,"touchcancel",j),G=S(k,"touchmove",j),Y=S(window,"scroll",j,!0)}function ge(L,k,j){if(j===0&&L.defaultActionOverride)try{L.defaultActionOverride(k),k.defaultPrevented}catch{}J=null}r.polyfill=function(L){if(L&&Object.keys(L).forEach(function(_){ee[_]=L[_]}),!ee.forceApply){var k=(j={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},z=!!window.chrome||/chrome/i.test(navigator.userAgent),j.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||z&&"ontouchstart"in document.documentElement),j);if(k.userAgentSupportingNativeDnD&&k.draggable&&k.dragEvents)return!1}var j,z;return ee.holdToDrag?l("touchstart",ae,!1):l("touchstart",fe,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(ln,ln.exports);var Wo=ln.exports;const zo=t=>typeof t!="string"?t:t.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),Me=(t,e)=>{t.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{t.classList.add(e)})})},qo=()=>{const t=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${t.height}px`);t.addEventListener("resize",e),e()};let Kn;const Yo=(t=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),o=()=>{clearTimeout(r),clearTimeout(Kn),Kn=setTimeout(()=>{t.removeEventListener("scroll",o),e()},100)};t.addEventListener("scroll",o)}),Ho="0.6.3 Beta",Ve=document.querySelector(".editor"),de=document.getElementById("tones"),ye=document.getElementById("action"),se=document.getElementById("musical-score"),Fe=document.getElementById("add-track"),lt=document.getElementById("remove-track"),We=document.getElementById("dialog"),re=document.forms["dialog-form"];re._title=re.querySelector(".form-title");re.description=re.querySelector(".description");re.inputs=re.querySelector(".inputs");re.buttons=re.querySelector(".buttons");const Ct=document.getElementById("play"),It=document.getElementById("clear"),Go=document.getElementById("warn-out"),Ko=document.getElementById("mml"),Ue=document.getElementById("copy"),Be=document.getElementById("paste"),Nt=document.getElementById("save"),un=document.getElementById("open"),Bt=document.getElementById("ctrl"),At=document.getElementById("undo"),Dt=document.getElementById("redo");var dt,ue,Ne,Xe;class Xo{constructor(){we(this,dt,`#COMMENT Generated by FlMML VisualSequencer ${Ho}`);we(this,ue,[]);we(this,Ne,(e,r)=>{});we(this,Xe,(e,r)=>{})}set onChange(e){Ce(this,Ne,e)}set onError(e){Ce(this,Xe,e)}setMmlArr(e){Ce(this,ue,e),U(this,Ne).call(this,this.getMmlArr(),this.getMml())}setMml(e){Ce(this,ue,e.split(`
`)),U(this,ue).at(-2)===""&&U(this,ue).at(-1)===U(this,dt)&&U(this,ue).splice(-2,2),U(this,Ne).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return U(this,ue)}getMml(){return U(this,ue).length?U(this,ue).concat(["",U(this,dt)]).join(`
`):""}getMmlLine(e){return U(this,ue)[e]}insert(e,r){Object.hasOwn(U(this,ue),e)||e===0?(U(this,ue).splice(e,0,r),U(this,Ne).call(this,this.getMmlArr(),this.getMml())):U(this,Xe).call(this,"範囲外の書き換え指定",`範囲${U(this,ue).length-1}までのところ、${e}`)}append(e){U(this,ue).push(e),U(this,Ne).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(U(this,ue),e)?(U(this,ue)[e]+=r,U(this,Ne).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(U(this,ue),e)?(U(this,ue)[e]=r+U(this,ue)[e],U(this,Ne).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(U(this,ue),e)?(U(this,ue)[e]=r,U(this,Ne).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(U(this,ue),e)&&U(this,ue).splice(e,r).length!==0?U(this,Ne).call(this,this.getMmlArr(),this.getMml()):U(this,Xe).call(this,"無効な指定",`範囲${U(this,ue).length-1}までの中で${e}から${r}削除するのはできません`)}}dt=new WeakMap,ue=new WeakMap,Ne=new WeakMap,Xe=new WeakMap;var Te,Je,ft,$e;class Jo{constructor(e,r){we(this,Te,[]);we(this,Je,[]);we(this,ft,null);we(this,$e,null);this.tonesElem=e,this.areaElem=r,Ce(this,$e,this.areaElem.querySelector(".track.active"))}set activeTrack(e){U(this,$e).classList.remove("active"),Ce(this,$e,e),U(this,$e).classList.add("active")}get activeTrack(){return U(this,$e)}blocksDataUpdate(){Ce(this,Te,[...this.areaElem.querySelectorAll(".track button")].map(e=>({label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),tone:{tone:e.dataset.tone,tonePitch:e.dataset.tonePitch},tempo:e.dataset.tempo,noteValue:e.dataset.noteValue,rest:e.dataset.rest,octave:e.dataset.octave,velocity:e.dataset.velocity,noteShift:e.dataset.noteShift,detune:e.dataset.detune,tieSlur:e.dataset.tieSlur,repeatStartEnd:e.dataset.repeatStartEnd,repeatBreak:e.dataset.repeatBreak,polyStartEnd:e.dataset.polyStartEnd,macroDef:e.dataset.macroDef,macroArgUse:e.dataset.macroArgUse,macroUse:e.dataset.macroUse,metaData:e.dataset.metaData,otherAction:e.dataset.otherAction,elem:e})))}saveBlocksData(){clearTimeout(U(this,ft)),Ce(this,ft,setTimeout(()=>{const e=JSON.parse(JSON.stringify(U(this,Te)));nn.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){nn.getItem("BlocksData").then(e=>{e&&(Ce(this,Te,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Z))})}parseBlocks(){const e=U(this,Te);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let o=0;e.forEach(s=>{if(s.trackNo!==o){const g=document.createElement("ul");g.classList.add("track"),this.activeTrack=g,this.areaElem.insertBefore(g,Fe),o=s.trackNo}const n=document.createElement("li"),c='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',v=(()=>{const g=document.createElement("div");return g.innerHTML=c,g.firstElementChild})(),m=document.querySelector(`[class*="${s.className.replace(/ material-icons| droppable| bounce| pop| done| inactive/g,"")}"]`),u=(m==null?void 0:m.cloneNode(!0))||v;s.label&&(u.ariaLabel=s.label),u.className=s.className,s.tone.tonePitch&&(s.label!=="無調整"&&(u.textContent=s.label),u.dataset.tone=s.tone.tone,m?m.replaceWith(u.cloneNode(!0)):r.appendChild(u.cloneNode(!0)),u.dataset.tonePitch=s.tone.tonePitch),s.tempo&&(u.dataset.tempo=s.tempo),s.noteValue&&(u.dataset.noteValue=s.noteValue),s.rest&&(u.dataset.rest=s.rest),s.octave&&(u.dataset.octave=s.octave),s.velocity&&(u.dataset.velocity=s.velocity),s.noteShift&&(u.dataset.noteShift=s.noteShift),s.detune&&(u.dataset.detune=s.detune),s.tieSlur&&(u.dataset.tieSlur=s.tieSlur,s.tieSlur==="&"?u.ariaLabel="スラー":u.ariaLabel="タイ"),s.repeatStartEnd&&(u.dataset.repeatStartEnd=s.repeatStartEnd,s.repeatStartEnd.startsWith("/:")?(u.classList.remove("material-icons"),u.ariaLabel="リピート開始",u.textContent="◆"):s.repeatStartEnd===":/"&&(u.ariaLabel="リピート終了")),s.repeatBreak&&(u.dataset.repeatBreak=s.repeatBreak),s.polyStartEnd&&(u.dataset.polyStartEnd=s.polyStartEnd),s.macroDef&&(u.dataset.macroDef=s.macroDef,u.textContent=s.macroDef===";"?";":"$="),s.macroArgUse&&(u.dataset.macroArgUse=s.macroArgUse),s.macroUse&&(u.dataset.macroUse=s.macroUse),s.metaData&&(u.dataset.metaData=s.metaData),s.otherAction&&(u.dataset.otherAction=s.otherAction,u.textContent=s.otherAction.length>4?"…":s.otherAction),n.appendChild(u),this.activeTrack.appendChild(n)})}exportMml(e){e.setMmlArr([]);let r=0,o=0;const s=U(this,Te).filter(S=>S.tone.tone!==void 0),n=()=>s.filter(S=>S.trackNo===o),c=()=>new Set(n().map(S=>S.tone.tone));let v=c(),m=0,u=!1,g=[4,0],d=!1;const l=U(this,Te).findIndex(S=>S.elem.classList.contains("play-from-here")),T=l===-1?-1:U(this,Te)[l].trackNo;U(this,Te).filter((S,E)=>l===-1||S.tempo||S.noteValue||S.octave||S.velocity||S.noteShift||S.detune||S.repeatStartEnd||S.repeatBreak||S.macroDef||S.macroUse||S.metaData||S.trackNo===T&&E>=l).forEach(S=>{const{tone:E,tonePitch:b}=S.tone;if(S.trackNo!==o&&(v.size?([...v].forEach((w,B)=>{e.appendToStr(r+B,";")}),r+=v.size):(e.appendToStr(r,";"),r++),o=S.trackNo,v=c(),u=!1),E!==void 0)m=[...v].indexOf(E),u||([...v].forEach((w,B)=>{w&&e.beforeInsertToStr(r+B,w+" ")}),u=!0),[...v].forEach((w,B)=>{let A=b||"";B!==m&&(A=A.replace(/[a-g]/,d?"*":"r")),e.appendToStr(r+B,A)});else if(S.rest||S.tieSlur)v.size?[...v].forEach((w,B)=>{e.appendToStr(r+B,S.rest||S.tieSlur)}):e.appendToStr(r,S.rest||S.tieSlur);else if(S.noteValue||S.repeatStartEnd||S.repeatBreak||S.polyStartEnd){const w=B=>{if(!B)return g;const A=Number((B.match(/[0-9]+/)||[g[0]])[0]),P=(B.match(/\.+/)||[""])[0].length;return[A,P]};S.noteValue?g=w(S.noteValue):S.polyStartEnd==="["?d=!0:S.polyStartEnd==="]"&&(d=!1),v.size?[...v].forEach((B,A)=>{if(e.appendToStr(r+A,S.noteValue||S.repeatStartEnd||S.repeatBreak||S.polyStartEnd||""),S.polyStartEnd==="]"){const P=e.getMmlLine(r+A).match(/\[(.+?)\]/);if(P){const I=P[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(I){const $=[...I].map(oe=>({type:oe[1]==="r"?"rest":oe[1]==="*"?"otherNote":"note",num:w(oe[0])}));$.filter(ee=>ee.type==="note").map(ee=>ee.num),$.filter(ee=>ee.type==="otherNote").map(ee=>ee.num),$.filter(ee=>ee.type==="rest").map(ee=>ee.num);let V=P[0].replace(/\*\+?[0-9]*\.*/g,"");const J=e.getMmlLine(r+A).replace(/\[.+?\]/,V);e.rewrite(r+A,J)}}}}):e.appendToStr(r,S.noteValue||S.repeatStartEnd||S.repeatBreak||S.polyStartEnd||"")}else if(S.metaData)S.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,S.metaData.replace(`
`,"")||""),r++;else{const w=b||S.tempo||S.octave||S.velocity||S.noteShift||S.detune||S.tieSlur||S.macroDef||S.macroArgUse||S.macroUse||S.otherAction||"";e.appendToStr(r,w),/;/.test(w)&&(r+=v.size||1,v=c(),u=!1)}}),[...v].slice(0,-1).forEach((S,E)=>{e.appendToStr(r+E,";")})}importMml(e){const r=e.getMmlArr(),o=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig,s=[],n=new Set,c=new Set;let v=0,m="",u=!1,g=!1;r.forEach(d=>{(d.match(o)||[]).forEach(T=>{if(T=T.trim(),!T)return;const S=E=>{const b={};if(b.tone={},b.trackNo=v,/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(E)){m=E,c.add(m);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(E)){c.has(m)||c.add(m);const w=[...c].indexOf(m)+1;b.label="無調整",b.className=`material-icons note note-${w}`,b.tone.tone=m,b.tone.tonePitch=E,u&&(g=!0)}else if(E.startsWith("t"))b.className="material-icons tempo",b.tempo=E;else if(E.startsWith("l"))b.className="material-icons note-value",b.noteValue=E;else if(E.startsWith("r"))b.className="material-icons rest",b.rest=E;else if(/^o[0-8]|[><]+$/i.test(E))b.className="material-icons octave",b.octave=E;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(E))b.className="material-icons velocity",b.velocity=E;else if(E.startsWith("@ns")||E.startsWith("ns"))b.className="material-icons note-shift",b.noteShift=E;else if(E.startsWith("@d"))b.className="material-icons detune",b.detune=E;else if(E.startsWith("&"))b.className="tie-slur",b.tieSlur=E;else if(E.startsWith("/*"))b.className="other-action",b.otherAction=E;else if(E.startsWith("/:"))b.className="repeat-start-end",b.repeatStartEnd=E;else if(E.startsWith(":/"))b.className="material-icons repeat-start-end",b.repeatStartEnd=E;else if(E.startsWith("/"))b.className="repeat-break",b.repeatBreak=E;else if(E.startsWith("[")||E.startsWith("]"))b.className="poly-start-end",b.polyStartEnd=E;else if(/^\$.*?=$/.test(E))b.className="macro-def",b.macroDef=E.replaceAll(" ",""),n.add(b.macroDef.slice(0,-1)),u=!0;else if(E.startsWith("%"))b.className="macro-arg-use",b.macroArgUse=E;else if(E.startsWith("$")){b.className="macro-use";const w=[...n].sort((B,A)=>A.length-B.length).find(B=>E.includes(B));if(w){b.macroUse=w,s.push(b);const B=E.replace(w,"");B!==""&&S(B);return}else b.macroUse=E}else if(E.startsWith("#")){const w={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};b.label=(Object.entries(w).find(B=>E.startsWith(B[0]))||[,void 0])[1],b.className="meta-data",b.metaData=E+`
`}else if(E.startsWith(";")){if(v++,u&&!g){const w=[...c].join(" ");w&&(b.className="other-action",b.otherAction=w,s.push(b),c.clear())}u=!1,g=!1;return}else b.className="other-action",b.otherAction=E;s.push(b)};S(T)})}),this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((d,l)=>{l?d.remove():(d.textContent="",this.activeTrack=d)}),H=null,Ce(this,Te,s),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}playRendering(e=-1){const r=U(this,Te);let o=120,s=0;[de,ye,se].forEach(d=>{d.classList.add("no-op")});const n=document.querySelector(".wrap"),c=document.getElementsByClassName("track"),m=(n.clientHeight-32)/c.length;[...c].forEach(d=>{d.style.setProperty("--max-height",`${m}px`)}),Fe.disabled=!0,lt.disabled=!0;const u=(d,{scoreNoteValue:l=4}={})=>{var z;let T=!1,S=-1,E=-1,b=!1,w=!1;const B=[],A=[],P=[],I=performance.now(),$=(z=d[0])==null?void 0:z.trackNo,V=c[$],J=s++;let oe=null;const ee=new Promise(_=>oe=_);let fe=0,ae=0;const ge=_=>{if(!_)return l;const q=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(_),G=q&&q[1]?Number(q[1]):l,Y=q?q[2].length:0;return G*2**Y/(2**(Y+1)-1)},L=_=>{const q=Y=>{!w&&V.scrollTo({top:Y,behavior:"smooth"}),w=!0,Yo(V).then(()=>{w=!1})},G=Y=>V.clientHeight*Y;(ae===0||_.elem.offsetTop>V.scrollTop+G(.8)||_.elem.offsetTop<V.scrollTop+G(.2))&&q(_.elem.offsetTop-G(.2))},k=_=>{const q=G=>{const Y=G-I,Q=60/o*4/_*1e3;Y<fe+Q?U(this,Je)[J]=requestAnimationFrame(q):(fe+=Q,j())};U(this,Je)[J]=requestAnimationFrame(q)},j=async()=>{var q,G;const _=d[ae];if(!_||ae>=d.length){oe({scoreNoteValue:l});return}if(L(_),b){_.macroDef===";"&&(b=!1),ae++,j();return}else if(S!==-1)(q=_.repeatStartEnd)!=null&&q.startsWith("/:")?E++:_.repeatStartEnd===":/"&&(E===S&&(Me(_.elem,"pop"),S=-1),E--),ae++,j();else if(_.tone.tonePitch){const Y=ge(_.tone.tonePitch);Me(_.elem,"bounce"),ae++,T?j():k(Y)}else if(_.rest||_.tieSlur)if(Me(_.elem,"pop"),ae++,_.tieSlur==="&")j();else{const Y=ge(_.rest||_.tieSlur);k(Y)}else if(_.polyStartEnd)if(T=_.polyStartEnd==="[",Me(_.elem,"pop"),T)ae++,j();else{const Y=ge(d[ae++-1].tone.tonePitch);k(Y)}else if(_.macroDef&&_.macroDef!==";"){b=!0,ae++,j();return}else{if(_.tempo&&(o=Number(_.tempo.replace("t",""))||o),_.noteValue&&(l=ge(_.noteValue)),Me(_.elem,"pop"),(G=_.repeatStartEnd)!=null&&G.startsWith("/:"))B[++E]=ae,A[E]||(P[E]=_.repeatStartEnd.replace("/:",""),P[E]=P[E]===""?2:Number(P[E]),P[E]||(S=E));else if(_.repeatBreak){if(P[E]===1){if(!A[E]){let Y=E;A[E]=d.findIndex((Q,me)=>{if(me>B[E]){if(console.log(Y),Q.repeatStartEnd.startsWith("/:"))Y++;else if(Q.repeatStartEnd===":/"){if(Y===E)return!0;Y--}}})}ae=A[E],j(),Me(_.elem,"done");return}}else if(_.repeatStartEnd===":/"){if(P[E]--,P[E]){A[E]=ae,ae=B[E],E--,j(),Me(_.elem,"done");return}A[E]=null,E--}else if(_.macroUse){const Y=me=>{const Ee=r[me].trackNo;let ke=me+1;for(;r[ke].macroDef!==";"&&r[ke].trackNo===Ee;)ke++;return ke},Q={};if(Q.start=r.findIndex(me=>{var Ee;return(Ee=me.macroDef)==null?void 0:Ee.startsWith(_.macroUse)}),Q.start>-1){Q.end=Y(Q.start),Q.blocks=r.slice(Q.start+1,Q.end);const me=performance.now();l=(await u(Q.blocks,{scoreNoteValue:l})).scoreNoteValue;const Ee=performance.now();fe+=Ee-me}}ae++,j()}Me(_.elem,"done")};return j(),ee};if(e!==-1){const d=r[e].trackNo;u(r.filter((l,T)=>e===-1||l.tempo||l.noteValue||l.octave||l.velocity||l.noteShift||l.detune||l.repeatStartEnd||l.repeatBreak||l.macroDef||l.macroUse||l.metaData||l.trackNo===d&&T>=e));return}const g=r.at(-1).trackNo+1;for(let d=0;d<g;d++)u(r.filter(l=>l.trackNo===d))}stopRendering(){[de,ye,se].forEach(e=>{e.classList.remove("no-op")}),Fe.disabled=!1,lt.disabled=!1,U(this,Te).forEach(e=>{e.elem.classList.remove("done")}),U(this,Je).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!U(this,Te).length)return;const e=U(this,Te).at(-1).trackNo+1;for(let r=0;r<e;r++)U(this,Te).filter(s=>s.polyStartEnd&&s.trackNo===r).forEach((s,n)=>{n%2===0?(s.elem.dataset.polyStartEnd="[",s.elem.textContent="["):(s.elem.dataset.polyStartEnd="]",s.elem.textContent="]")});this.blocksDataUpdate()}}Te=new WeakMap,Je=new WeakMap,ft=new WeakMap,$e=new WeakMap;var pe,Mt,mt,Qe;class Qo{constructor(){we(this,pe,[[],[]]);we(this,Mt,70);we(this,mt,e=>{});we(this,Qe,e=>{})}set onPushstate(e){Ce(this,mt,e)}set onPopstate(e){Ce(this,Qe,e)}pushState(e){U(this,pe)[0].push(e),U(this,mt).call(this,e),U(this,pe)[0].length>U(this,Mt)&&U(this,pe)[0].shift(),U(this,pe)[1].length=0,console.log(U(this,pe))}undo(){const e=U(this,pe)[0].pop();return U(this,Qe).call(this,{reason:"undo",data:e}),e&&U(this,pe)[1].unshift(e),console.log(U(this,pe)),{canUndo:!!U(this,pe)[0].length,canRedo:!!U(this,pe)[1].length}}redo(){const e=U(this,pe)[1].shift();return U(this,Qe).call(this,{reason:"redo",data:e}),e&&U(this,pe)[0].push(e),console.log(U(this,pe)),{canUndo:!!U(this,pe)[0].length,canRedo:!!U(this,pe)[1].length}}clear(){U(this,pe)[0].length=0,U(this,pe)[1].length=0,console.log(U(this,pe))}}pe=new WeakMap,Mt=new WeakMap,mt=new WeakMap,Qe=new WeakMap;const De=[1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,384];let H=de.querySelector("button"),br=!1,_e=!1;const Re={timeStamp:-1,tempo:120,scoreNoteValue:"4"};let dn=null,fn=!1,tn=null;const Er=()=>{N.activeTrack.querySelectorAll("button").forEach(t=>{t.classList.remove("done")}),fn=!1},_t=()=>{if(clearTimeout(dn),H&&H.closest(".track")!==N.activeTrack){H=N.activeTrack.querySelector("button");return}let t=H;if(!t){if(fn){console.log("end1");return}Re.timeStamp=-1,setTimeout(()=>{H=N.activeTrack.querySelector("button"),Er()},2e3),fn=!0,console.log("end2");return}(()=>{if("tonePitch"in t.dataset){t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,""),Le(t,{noteValue:"1..."}),t.classList.add("bounce");return}"rest"in t.dataset&&(t.dataset.rest="r"),t.classList.add("done")})();const r=()=>{var n;H=t=((n=t.parentElement.nextElementSibling)==null?void 0:n.firstElementChild)||null};if("tonePitch"in t.dataset||xe.stop(),!["tonePitch","rest"].some(n=>n in t.dataset)){if("tempo"in t.dataset){const n=Number(t.dataset.tempo.replace("t",""));Re.tempo=n}else"noteValue"in t.dataset&&(Re.scoreNoteValue=(t.dataset.noteValue.match(/[0-9]+\.*/)||[Re.scoreNoteValue])[0]);r(),_t(),console.log("end3");return}if((()=>{const n=60/Re.tempo*4*1e3*1.825;dn=setTimeout(_t,n)})(),!performance.getEntriesByName("stepPoint")[0]){performance.mark("stepPoint"),tn=t,r(),console.log("end4");return}(()=>{const n=performance.measure("stepElapsed","stepPoint");performance.mark("stepPoint");const c=n.duration,m=(g=>{const d=60/Re.tempo*4/g*1e3,{noteValue:l,dots:T}=De.reduce((S,E,b)=>{const w=Math.log2(d/(2*d-E));if(w<0||Number.isNaN(w))return S;const B=w-Math.floor(w);return B<S.smallerFractional?{noteValue:E,dots:Math.round(w),smallerFractional:B}:S},{noteValue:null,dots:null,smallerFractional:1});return l+".".repeat(T)})(c);(g=>{const d=tn;if("tonePitch"in d.dataset){const l=g!==Re.scoreNoteValue?g:"";d.dataset.tonePitch=d.dataset.tonePitch+l}else if("rest"in d.dataset){const l=g!==Re.scoreNoteValue?g:"";d.dataset.rest="r"+l}})(m),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z)})(),tn=t,r()};var ze,Ot,Pt,jt;class Zo{constructor(e){we(this,ze,()=>Object.fromEntries(De.map(e=>[e,e===1?"全音符":`${e}分音符`])));we(this,Ot,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name"},{label:"音の定義",type:"text",name:"tone-def",autofocus:!0}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}]},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",select:U(this,ze).call(this),name:"tone-pitch"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}]},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0"}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}]},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",select:U(this,ze).call(this),name:"note-value"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}]},rest:{title:"休符設定",inputs:[{label:"休符の長さ",select:U(this,ze).call(this),name:"rest"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}]},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8"}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}]},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127"}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}]},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift"}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}]},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune"}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}]},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",select:U(this,ze).call(this),name:"tie-slur"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}]},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0"}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}]},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg"}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}]},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use"}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}]},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg"}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}]},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}]},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action"}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}]},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}]},step:{title:"ステップ音価記録",description:`ステップ音価記録は、簡単に音価を指定できる機能です。

各トラックの空白部分をテンポよくクリック、またはスペースキーを押して最初の音符から順に音価を決定します。
途中から指定をやり直したいときは、やり直したい音符をクリックすることでそこからやり直せます。

この画面は、Shiftキーを押しながらステップ音価記録ブロックをクリックすることで再度表示できます。`,buttons:[{className:"primaly",value:"set-step",textContent:"開始"},{value:"cancel-step",textContent:"やめる"}]}});we(this,Pt,e=>{const r=U(this,Ot)[e];Object.keys(r).forEach(o=>{switch(o){case"title":re._title.textContent=r.title;break;case"description":(()=>{const s=document.createElement("p");s.innerHTML=r.description.replaceAll(`
`,"<br>"),re.description.appendChild(s)})();break;case"inputs":r.inputs.forEach(s=>{const n=document.createElement("input");let c=n;Object.entries(s).forEach(([v,m])=>{if(v==="label"){const u=document.createElement("label");u.textContent=m,u.appendChild(n),c=u}else if(v==="select"){const u=document.createElement("select");u.name=s.name,Object.entries(m).forEach(([d,l])=>{const T=document.createElement("option");T.value=d,T.textContent=l,u.appendChild(T)}),n.replaceWith(u)}else n[v]=m}),re.inputs.appendChild(c)});break;case"buttons":r.buttons.forEach(s=>{const n=document.createElement("button");Object.entries(s).forEach(([c,v])=>{n[c]=v}),re.buttons.appendChild(n)});break}})});we(this,jt,(e,r)=>{re._title.textContent="",re.description.textContent="",re.inputs.textContent="",re.buttons.textContent="",U(this,Pt).call(this,e);for(const[o,s]of Object.entries(r))o==="run"?s():re.elements[o].value=s;this.type=e});this.type=null,this.submitTarget=null,this.resolve=null,e.addEventListener("submit",r=>{const o=this.submitTarget,s=r.submitter.value,n=JSON.parse(JSON.stringify(o.dataset));switch(s){case"set-tone":const v=o.className;document.querySelectorAll(`[class*="${v}"]`).forEach(l=>{l.ariaLabel=e.elements["tone-name"].value,(!l.classList.contains("material-icons")||e.elements["tone-name"].value!=="無調整")&&(l.classList.remove("material-icons"),l.textContent=e.elements["tone-name"].value),l.dataset.tone=e.elements["tone-def"].value});break;case"set-tone-pitch":o.dataset.tonePitch=o.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]+e.elements["tone-pitch"].value+".".repeat(e.elements.dot.value);break;case"set-tempo":o.dataset.tempo="t"+e.elements.tempo.value;break;case"set-note-value":o.dataset.noteValue="l"+e.elements["note-value"].value+".".repeat(e.elements.dot.value);break;case"set-rest":o.dataset.rest="r"+e.elements.rest.value+".".repeat(e.elements.dot.value);break;case"set-octave":o.dataset.octave="o"+e.elements.octave.value;break;case"set-octave-relative":o.dataset.octave=e.elements.octave.value>0?"<".repeat(e.elements.octave.value):">".repeat(-e.elements.octave.value);break;case"set-velocity":o.dataset.velocity="@v"+e.elements.velocity.value;break;case"set-velocity-relative":o.dataset.velocity=(e.elements.velocity.value>=0?"(":")")+Math.abs(e.elements.velocity.value);break;case"set-note-shift":o.dataset.noteShift="ns"+e.elements["note-shift"].value;break;case"set-note-shift-relative":o.dataset.noteShift="@ns"+e.elements["note-shift"].value;break;case"set-detune":o.dataset.detune="@d"+e.elements.detune.value;break;case"set-tie-slur":o.dataset.tieSlur="&"+e.elements["tie-slur"].value+".".repeat(e.elements.dot.value),o.dataset.tieSlur==="&"?o.ariaLabel="スラー":o.ariaLabel="タイ";break;case"set-repeat":o.dataset.repeatStartEnd="/:"+e.elements.repeat.value;break;case"set-macro-def":const m=o.dataset.macroDef;o.dataset.macroDef="$"+e.elements["macro-def-name"].value+(e.elements["macro-def-arg"].value!==""?`{${e.elements["macro-def-arg"].value}}`:"")+"=",se.querySelectorAll(`[data-macro-use="${m.replace("=","")}"]`).forEach(l=>{l.dataset.macroUse=o.dataset.macroDef.replace("=","")});break;case"set-macro-arg-use":o.dataset.macroArgUse="%"+e.elements["macro-arg-use"].value;break;case"set-macro-use":o.dataset.macroUse="$"+e.elements["macro-use-name"].value+(e.elements["macro-use-arg"].value!==""?`{${e.elements["macro-use-arg"].value}}`:"");break;case"set-meta-data":o.ariaLabel=e.elements["select-meta-data"].selectedOptions[0].label,o.dataset.metaData=e.elements["select-meta-data"].value.replace("{n}",e.elements.number.value).replace("{desc}",e.elements.text.value);break;case"set-other-action":o.dataset.otherAction=e.elements["other-action"].value,o.textContent=o.dataset.otherAction.length>4?"…":o.dataset.otherAction;break;case"remove-left":case"remove-right":const u=o.parentElement,g=N.activeTrack,d=g.children;for([...d].indexOf(u),H=null;[...d].includes(u);){const l=s==="remove-left",T=l?g.firstElementChild:g.lastElementChild;be.pushState({operation:"remove",removedElem:T,removedIndex:l?0:d.length-1,parent:g}),T.remove()}N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z);break;case"set-step":br=!0,_e=!0;break;case"cancel-step":_e=!1;break}const c=JSON.parse(JSON.stringify(o.dataset));JSON.stringify(n)!==JSON.stringify(c)&&be.pushState({operation:"valueChange",target:o,beforeChange:n,afterChange:c}),this.resolve()})}async prompt(e,r,o){return U(this,jt).call(this,e,r),this.submitTarget=o,We.showModal(),new Promise(s=>this.resolve=s)}}ze=new WeakMap,Ot=new WeakMap,Pt=new WeakMap,jt=new WeakMap;Qn.FlMML.prepare(".editor");const xe=new Qn.FlMML({workerURL:ua}),Z=new Xo;nn.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const N=new Jo(de,se),be=new Qo,Lt=new Zo(re),es={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},ts=new En({i18n:es,locale:"ja"});Wo.polyfill({holdToDrag:500});qo();const ut=t=>`<span class="material-icons">${t}</span>`,Sr=ut("play_arrow")+"再生",ns=ut("stop")+"停止",mn=()=>{const t=[...se.querySelectorAll(".track button")].findIndex(e=>e.classList.contains("play-from-here"));N.playRendering(t)},rs=()=>{Go.innerHTML=xe.getWarnings().replaceAll(`
`,"<br>")};xe.addEventListener("compilecomplete",rs);const as=()=>{Ct.innerHTML=Sr,N.stopRendering(),xe.removeEventListener("compilecomplete",mn),It.disabled=!1};xe.addEventListener("complete",as);Z.onChange=(t,e)=>{Ko.innerHTML=e?`<pre><code>${zo(e).replaceAll(`
`,"<br>")}</code></pre>`:"(なし)";const r=!!t.length;[Ue,Nt].forEach(o=>{o.disabled=!r})};Z.onError=(t,e)=>{alert(t+`
`+e)};N.checkSavedBlocksData();const Le=(t,e={})=>{var b;const r=()=>{let w=t.parentElement;for(;w&&!("noteValue"in w.firstElementChild.dataset);)w=w.previousElementSibling;return(w==null?void 0:w.firstElementChild)||null},o=()=>{var B;let w=t.parentElement;for(;w&&!((B=w.firstElementChild.dataset.octave)!=null&&B.startsWith("o"));)w=w.previousElementSibling;return(w==null?void 0:w.firstElementChild)||null},s=()=>{var A;let w=t.parentElement.nextElementSibling,B="";for(;w&&((A=w.firstElementChild.dataset.tieSlur)!=null&&A.match(/&[0-9]+\.*/));)B+=w.firstElementChild.dataset.tieSlur,w=w.nextElementSibling;return B},n=((b=r())==null?void 0:b.dataset.noteValue)||"",c=o(),v=[...N.activeTrack.children].indexOf(c==null?void 0:c.parentElement),m=(c==null?void 0:c.dataset.octave)||"",u=[...N.activeTrack.children].indexOf(t.parentElement),g=[...N.activeTrack.children].slice(v,u).filter(w=>"tonePitch"in w.firstElementChild.dataset||"octave"in w.firstElementChild.dataset&&!w.firstElementChild.dataset.octave.startsWith("o")).map(w=>((w.firstElementChild.dataset.tonePitch||w.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),d={down:">",up:"<"},l=(w,B)=>(w.match(new RegExp(B,"g"))||[]).length,T=(()=>{const w=-l(g,d.down)+l(g,d.up);return w<0?d.down.repeat(-w):w>0?d.up.repeat(w):""})(),S=s(),E=e.noteValue?t.dataset.tonePitch.replace(/[0-9]+\.*/,"")+e.noteValue:t.dataset.tonePitch;xe.play(t.dataset.tone+n+m+T+E+S)};be.onPopstate=t=>{const e=t.data,r=o=>!!e.parent.closest("#"+o);switch(t.reason){case"undo":switch(e==null?void 0:e.operation){case"append":Z.delete(e.index);break;case"delete":Z.insert(e.index,e.mmlText);break;case"rewrite":Z.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z));break;case"move":const o=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(o,e.elem),r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z));break;case"valueChange":for(const[s,n]of Object.entries(e.beforeChange))e.target.dataset[s]=n;"tone"in e.target.dataset&&Le(e.target),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z));break;case"clear":e.tonesChildren.forEach(s=>{de.querySelector("ul").appendChild(s)}),e.musicalScoreChildren.forEach(s=>{se.insertBefore(s,Fe)}),H=e.lastTouchedButton,N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":Z.append(e.mmlText);break;case"delete":Z.delete(e.index);break;case"rewrite":Z.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z)),"tonePitch"in H.dataset&&(Le(H),H.classList.add("bounce"));break;case"move":const o=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(o,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z));break;case"valueChange":for(const[n,c]of Object.entries(e.afterChange))e.target.dataset[n]=c;"tone"in e.target.dataset&&Le(e.target),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z);break;case"remove":const s=e.removedElem.className;e.removedElem.remove(),r("tones")&&se.querySelectorAll(`[class*="${s}"]`).forEach(n=>{n.parentElement.remove()}),N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z);break;case"clear":de.querySelector("ul").textContent="",se.querySelectorAll(".track").forEach((n,c)=>{c?n.remove():(n.textContent="",N.activeTrack=n)}),H=null,N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z);break}break}};const wr=()=>{const t=[...de.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!t.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",t=>{var r;const e=t.ctrlKey||Bt.checked;switch((r=t.key)==null?void 0:r.toLowerCase()){case" ":_e?(t.preventDefault(),_t()):document.activeElement.tagName.toLowerCase()!=="input"&&(t.preventDefault(),Ct.click());break;case"s":e&&(t.preventDefault(),!Nt.disabled&&Nt.click());break;case"o":e&&(t.preventDefault(),!un.disabled&&un.click());break;case"z":e&&be.undo();break;case"y":e&&be.redo();break}});const ot=async t=>{const{dataset:e}=t,r={tempo:o=>({tempo:o.replace("t","")}),noteValue:o=>({"note-value":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),rest:o=>({rest:(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),octave:o=>({octave:o.startsWith("o")?o.replace("o",""):(o.match(/[><]+/)||[""])[0].length}),velocity:o=>({velocity:o.startsWith("@v")?o.replace("@v",""):Number((o.match(/[0-9]+/)||[""])[0])*(o.startsWith("(")?1:-1)}),noteShift:o=>({"note-shift":(o.match(/[0-9]+/)||[""])[0]}),detune:o=>({detune:o.replace("@d","")}),tieSlur:o=>({"tie-slur":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),repeatStartEnd:o=>({repeat:o.replace("/:","")}),macroDef:o=>({"macro-def-name":(o.match(/\$([^\{\=]*)[\{\=]/)||[,""])[1],"macro-def-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),macroArgUse:o=>({"macro-arg-use":o.replace("%","")}),macroUse:o=>({"macro-use-name":(o.match(/\$([^\{]*)\{?/)||[,""])[1],"macro-use-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),metaData:o=>({run:()=>{const n=o.split(" "),c=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let v=c.findIndex(l=>n[0].startsWith(l));v===-1&&(v=0),re.elements["select-meta-data"].selectedIndex=v;const m=l=>re.elements[l].previousSibling,u=()=>re.elements["select-meta-data"].selectedOptions[0],g=(l,T)=>{m("number").nodeValue=l[0],re.elements.number.value=l[1],re.elements.number.parentElement.style.display=l[2]?"none":"",m("text").nodeValue=T[0],re.elements.text.value=T[1],re.elements.text.parentElement.style.display=T[2]?"none":""},d=l=>{var E,b,w;const T=l===v,S=c[l];switch(S){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const B=T?n.slice(1).join(" ")??"":"";g(["無効","",!0],[u().label,B,!1]);break;case"#OCTAVE":case"#VELOCITY":g(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const A=S==="#WAV9",P=T?((E=n.slice(1).join(" "))==null?void 0:E.split(","))??[]:[];g(["波形番号",P[0]??0,!1],A?["初期変位,ループフラグ,データ",`${P[1]??0},${P[2]??0},${P[3]??""}`,!1]:["データ",P[1]??"",!1]),re.elements.number.min=0,re.elements.number.max=A?15:31;break;case"#OPM":case"#OPN":g(["音色番号",T?((b=n[0])==null?void 0:b.split("@")[1])??0:0,!1],["データ",T?((w=n.slice(1).join(" "))==null?void 0:w.slice(1,-1))??"":"",!1]),re.elements.number.min=0,re.elements.number.max=127;break;case"#FMGAIN":g(["音量利得",T?n[1].replace(`
`,"")??91:91,!1],["無効","",!0]),re.elements.number.min=-127,re.elements.number.max=127;break;case"#USING":g(["和音重ね数",T?n[2].replace(`
`,"")??2:2,!1],["無効","",!0]),re.elements.number.min=1,re.elements.number.max="";break}};d(v),re.elements["select-meta-data"].addEventListener("change",l=>{d(l.target.selectedIndex)})}}),otherAction:o=>({"other-action":o}),remove:()=>({}),step:()=>({})};for(const o of Object.keys(e)){const s=r[o];if(s){let n=e[o];switch(o){case"repeatStartEnd":if(n===":/"){const m=(()=>{var g;let u=t.parentElement;for(;u&&!((g=u.firstElementChild.dataset.repeatStartEnd)!=null&&g.startsWith("/:"));)u=u.previousElementSibling;return(u==null?void 0:u.firstElementChild)||null})();if(m)t=m;else{const u=N.activeTrack,g=document.createElement("li"),l=ye.querySelector(".repeat-start-end").cloneNode(!0);g.appendChild(l),u.insertBefore(g,t.parentElement),t=l}n=t.dataset.repeatStartEnd}break;case"macroDef":if(n===";")return;break}const c=s(n);await Lt.prompt(o,c,t);break}}};Ve.addEventListener("click",async t=>{const e=t.ctrlKey||Bt.checked,r=s=>!!t.target.closest("#"+s),o=t.target.tagName.toLowerCase()==="button";if(![de,ye,se].some(s=>s.classList.contains("no-op"))){if(r("tones"))if(o)H=t.target,await Lt.prompt("tone",{"tone-name":t.target.ariaLabel,"tone-def":t.target.dataset.tone,run:()=>{const s=re.elements["tone-name"];s.insertAdjacentElement("afterend",ts);const n=document.querySelector("emoji-picker");s.addEventListener("focus",()=>{n.classList.add("expaned")},{once:!0}),n.addEventListener("emoji-click",c=>s.value=c.detail.unicode)}},t.target),xe.play(t.target.dataset.tone+t.target.dataset.tonePitch),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z);else{const s=de.querySelector("ul"),n=document.createElement("li"),v=`<button class="material-icons note ${wr()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;n.innerHTML=v;const m=n.firstElementChild;s.appendChild(n),H=m,xe.play(m.dataset.tone+m.dataset.tonePitch),be.pushState({operation:"copy",toIndex:-1,newElem:n,parent:s})}else if(r("action")){if(o){if("otherAction"in t.target.dataset)await ot(t.target);else if("step"in t.target.dataset){br&&!t.shiftKey?_e=!_e:await ot(t.target),_e?(t.target.classList.add("enable"),t.target.ariaLabel="ステップ音価記録(有効)",H=N.activeTrack.querySelector("button")):(t.target.classList.remove("enable"),t.target.ariaLabel="ステップ音価記録(無効)",Er(),xe.stop(),clearTimeout(dn));return}const s=N.activeTrack,n=document.createElement("li"),c=t.target.cloneNode(!0);if(["metaData","macroDef","macroArgUse","macroUse"].some(v=>v in c.dataset)&&await ot(c),"tieSlur"in c.dataset?c.ariaLabel="スラー":"repeatStartEnd"in c.dataset?(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"):"polyStartEnd"in c.dataset?(c.dataset.polyStartEnd="[",c.textContent="["):"macroDef"in c.dataset?c.textContent="$=":"playFromHere"in c.dataset&&se.querySelectorAll(".track button").forEach(v=>{v.classList.add("inactive")}),n.appendChild(c),s.appendChild(n),H=c,N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z),be.pushState({operation:"copy",toIndex:-1,newElem:n,parent:s}),["repeatStartEnd","polyStartEnd","macroDef"].some(v=>v in H.dataset)){const v=document.createElement("li"),m=t.target.cloneNode(!0);"repeatStartEnd"in H.dataset?(m.ariaLabel="リピート終了",m.dataset.repeatStartEnd=":/"):"polyStartEnd"in H.dataset?(m.dataset.polyStartEnd="]",m.textContent="]"):"macroDef"in H.dataset&&(m.dataset.macroDef=";",m.textContent=";"),v.appendChild(m),H.parentElement.insertAdjacentElement("afterend",v),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z),be.pushState({operation:"copy",toIndex:-1,newElem:v,parent:s})}}}else if(r("musical-score")){if(o&&t.target!==Fe&&t.target!==lt)t.target.closest(".track")&&(N.activeTrack=t.target.closest(".track")),_e||("tone"in t.target.dataset?(Le(t.target),Me(t.target,"bounce"),e&&(await Lt.prompt("tonePitch",{"tone-pitch":(t.target.dataset.tonePitch.match(/[0-9]+/)||[""])[0],dot:(t.target.dataset.tonePitch.match(/\.+/)||[""])[0].length},t.target),Le(t.target))):await ot(t.target),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z)),H=t.target;else if(t.target.closest(".track")&&(N.activeTrack=t.target.closest(".track")),_e)_t();else if(H){const s=N.activeTrack,n=document.createElement("li"),c=H.cloneNode(!0);if("repeatStartEnd"in c.dataset&&(c.classList.remove("material-icons"),c.ariaLabel="リピート開始",c.textContent="◆",c.dataset.repeatStartEnd="/:"+(c.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),n.appendChild(c),s.appendChild(n),H=c,N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z),be.pushState({operation:"copy",toIndex:-1,newElem:n,parent:s}),"tonePitch"in c.dataset)c.dataset.tonePitch=c.dataset.tonePitch.replace(/[><]+/,""),Le(c),c.classList.add("bounce");else if("repeatStartEnd"in H.dataset){const v=document.createElement("li"),m=H.cloneNode(!0);m.classList.add("material-icons"),m.ariaLabel="リピート終了",m.textContent="repeat",m.dataset.repeatStartEnd=":/",v.appendChild(m),H.parentElement.insertAdjacentElement("afterend",v),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z),be.pushState({operation:"copy",toIndex:-1,newElem:v,parent:s})}}}}});Ve.addEventListener("contextmenu",t=>{var s,n,c,v;if(_e)return;const e=m=>m.closest("#tones, #musical-score"),r=m=>!!t.target.closest("#"+m),o=t.target.tagName.toLowerCase()==="button";if(!((s=e(t.target))!=null&&s.classList.contains("no-op"))&&e(t.target)){const m=o&&t.target!==Fe&&t.target!==lt?t.target:H;if(!m||e(m)!==e(t.target))return;t.preventDefault(),N.activeTrack=m.closest(".track")||N.activeTrack;const u=m.parentElement,g=m.className,d=((n=m.closest("#tones"))==null?void 0:n.querySelector("ul"))||N.activeTrack,l=[...d.children].indexOf(u);H=((c=u.previousElementSibling)==null?void 0:c.firstElementChild)||((v=u.nextElementSibling)==null?void 0:v.firstElementChild)||null,be.pushState({operation:"remove",removedElem:u,removedIndex:l,parent:d}),r("tones")?se.querySelectorAll(`[class*="${g}"]`).forEach(T=>{T.parentElement.remove()}):"macroDef"in m.dataset?se.querySelectorAll(`[data-macro-use="${m.dataset.macroDef.replace("=","")}"]`).forEach(T=>{T.parentElement.remove()}):"playFromHere"in m.dataset&&se.querySelectorAll(".inactive").forEach(T=>{T.classList.remove("inactive")}),u.remove(),N.blocksDataUpdate(),N.calcPoly(),N.saveBlocksData(),N.exportMml(Z)}});let wt=null,ct=!1,hn=null;Ve.addEventListener("touchstart",t=>{wt=[...t.touches].at(-1).pageY,hn=setTimeout(()=>{ct=!0},500)});const Tr=t=>{if(_e)return;const e=t.ctrlKey||Bt.checked,r=c=>!!t.target.closest("#"+c),o=t.target.tagName.toLowerCase()==="button";if(t.type==="touchmove"){const c=[...t.touches].at(-1).pageY;if(ct){t.cancelable&&t.preventDefault();return}else if(c-wt<-20)t.deltaY=-1,clearTimeout(hn);else if(c-wt>20)t.deltaY=1,clearTimeout(hn);else{t.cancelable&&t.preventDefault();return}wt=c,ct=!0,setTimeout(()=>ct=!1,50)}const s=t.deltaY<0;let n=o?t.target:(H==null?void 0:H.closest("#musical-score"))&&H;if(n){if(r("musical-score")){if(se.classList.contains("no-op"))return;t.preventDefault();let c=JSON.parse(JSON.stringify(n.dataset));if(!e&&"tone"in n.dataset){const m=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],u={down:">",up:"<"},g=n.dataset.tonePitch,d=m.findIndex(w=>g.match(/[a-g]\+?/)[0]===w),l=(w,B)=>(w.match(new RegExp(B,"g"))||[]).length,T={down:l(g,u.down),up:l(g,u.up)},S=u.down.repeat(T.down)+u.up.repeat(T.up),E=(g.match(/[0-9]+/)||[""])[0],b=(n.dataset.tonePitch.match(/\.+/)||[""])[0];s?d===m.length-1?T.down?n.dataset.tonePitch=S.substring(1)+m.at(0)+E+b:n.dataset.tonePitch=S+u.up+m.at(0)+E+b:n.dataset.tonePitch=S+m[d+1]+E+b:d===0?T.up?n.dataset.tonePitch=S.substring(1)+m.at(-1)+E+b:n.dataset.tonePitch=S+u.down+m.at(-1)+E+b:n.dataset.tonePitch=S+m[d-1]+E+b,Le(n)}else{const m=s?1:-1,u=(g,d=-1/0,l=1/0)=>g+m<d||g+m>l?0:m;if(e&&"tonePitch"in n.dataset){const g=Number((n.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),d=(n.dataset.tonePitch.match(/\.+/)||[""])[0],l=u(g,0,384),T=De.findIndex(E=>E===g),S=g+l!==0?De[T+l]:"";n.dataset.tonePitch=n.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+S+d,Le(n)}else if("tempo"in n.dataset){const g=Number(n.dataset.tempo.replace("t","")),d=u(g,0);n.dataset.tempo="t"+(g+d*10)}else if("noteValue"in n.dataset){const g=Number((n.dataset.noteValue.match(/[0-9]+/)||[""])[0]),d=u(g,1,384),l=De.findIndex(T=>T===g);n.dataset.noteValue=n.dataset.noteValue.replace(/[0-9]+/,De[l+d])}else if("rest"in n.dataset){const g=Number((n.dataset.rest.match(/[0-9]+/)||[""])[0]),d=(n.dataset.rest.match(/\.+/)||[""])[0],l=u(g,0,384),T=De.findIndex(E=>E===g),S=g+l!==0?De[T+l]:"";n.dataset.rest="r"+S+d}else if("octave"in n.dataset)if(n.dataset.octave.startsWith("o")){const d=Number(n.dataset.octave.replace("o","")),l=u(d,0,8);n.dataset.octave="o"+(d+l)}else{const d=(n.dataset.octave.match(/<+/)||[""])[0].length-(n.dataset.octave.match(/>+/)||[""])[0].length,l=u(d,-8,8);n.dataset.octave=d+l>0?"<".repeat(d+l):">".repeat(-(d+l))}else if("velocity"in n.dataset)if(n.dataset.velocity.startsWith("@v")){const d=Number(n.dataset.velocity.replace("@v","")),l=u(d,0,127);n.dataset.velocity="@v"+(d+l)}else{const d=Number((n.dataset.velocity.match(/[0-9]+/)||[""])[0])*(n.dataset.velocity.startsWith("(")?1:-1),l=u(d,-127,127);n.dataset.velocity=(d+l>=0?"(":")")+Math.abs(d+l)}else if("noteShift"in n.dataset){const g=Number((n.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),d=m;n.dataset.noteShift=n.dataset.noteShift.match(/@?ns/)[0]+(g+d)}else if("detune"in n.dataset){const g=Number(n.dataset.detune.replace("@d","")),d=m;n.dataset.detune="@d"+(g+d)}else if("tieSlur"in n.dataset){const g=Number((n.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),d=(n.dataset.tieSlur.match(/\.+/)||[""])[0],l=u(g,0,384),T=De.findIndex(E=>E===g),S=g+l!==0?De[T+l]:"";n.dataset.tieSlur="&"+S+d,n.dataset.tieSlur==="&"?n.ariaLabel="スラー":n.ariaLabel="タイ"}else if("repeatStartEnd"in n.dataset){if(n.dataset.repeatStartEnd===":/"){const S=(()=>{var b;let E=n.parentElement;for(;E&&!((b=E.firstElementChild.dataset.repeatStartEnd)!=null&&b.startsWith("/:"));)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null})();if(S)n=S;else{const E=N.activeTrack,b=document.createElement("li"),B=ye.querySelector(".repeat-start-end").cloneNode(!0);b.appendChild(B),E.insertBefore(b,n.parentElement),n=B}c=JSON.parse(JSON.stringify(n.dataset))}const g=Number((n.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),d=u(g,-1),l=g+d!==-1?g+d:"";n.dataset.repeatStartEnd="/:"+l}}const v=JSON.parse(JSON.stringify(n.dataset));JSON.stringify(c)!==JSON.stringify(v)&&be.pushState({operation:"valueChange",target:n,beforeChange:c,afterChange:v}),H=n,N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z)}}else return};Ve.addEventListener("wheel",Tr);Ve.addEventListener("touchmove",Tr);Ve.addEventListener("touchend",()=>{ct=!1});let st={};Ve.addEventListener("dragstart",t=>{st={from:t.target.nodeType===1&&t.target.closest("#tones, #action, #musical-score"),item:t.target},t.dataTransfer.effectAllowed="copyMove"});let Xn=null;[de,ye,se].forEach(t=>{const e=n=>{const c=n.ctrlKey||Bt.checked,{from:v=null}=st,m=n.dataTransfer;switch(v){case de:switch(t){case de:n.preventDefault(),c?m.dropEffect="copy":m.dropEffect="move";break;case ye:break;case se:n.preventDefault(),m.dropEffect="copy";break}break;case ye:switch(t){case de:break;case ye:break;case se:n.preventDefault(),m.dropEffect="copy";break}break;case se:switch(t){case de:break;case ye:break;case se:n.preventDefault(),c?m.dropEffect="copy":m.dropEffect="move";break}break}Xn=m.dropEffect};t.addEventListener("dragover",e);const r=n=>{const{from:c=null}=st,v=n.target.tagName.toLowerCase()==="button",m=()=>n.target.classList.add("droppable");switch(c){case de:switch(t){case de:n.preventDefault(),v&&m();break;case ye:break;case se:n.preventDefault(),v&&m();break}break;case ye:switch(t){case de:break;case ye:break;case se:n.preventDefault(),v&&m();break}break;case se:switch(t){case de:break;case ye:break;case se:n.preventDefault(),v&&m();break}break}};t.addEventListener("dragenter",r);const o=n=>{const{from:c=null}=st,v=n.target.tagName.toLowerCase()==="button",m=()=>n.target.classList.remove("droppable");switch(c){case de:switch(t){case de:v&&m();break;case ye:break;case se:v&&m();break}break;case ye:switch(t){case de:break;case ye:break;case se:v&&m();break}break;case se:switch(t){case de:break;case ye:break;case se:v&&m();break}break}};t.addEventListener("dragleave",o),t.addEventListener("drop",async n=>{var T,S;if(n.preventDefault(),(T=n.dataTransfer.items)!=null&&T.length)return;n.dataTransfer.dropEffect=n.dataTransfer.dropEffect!=="none"?n.dataTransfer.dropEffect:Xn;const{from:c,item:v}=st,m=((S=n.target.closest("#tones"))==null?void 0:S.querySelector("ul"))||n.target.closest(".track")||N.activeTrack,u=[...t.querySelectorAll("button")].indexOf(v),g=[...t.querySelectorAll("button")].indexOf(n.target),d=n.target.tagName.toLowerCase()==="button";let l;switch(n.dataTransfer.dropEffect){case"copy":const E=document.createElement("li"),b=v.cloneNode(!0);if(t===de){const w=[...v.classList].find(B=>B.includes("note-"));b.classList.replace(w,wr())}else c===ye&&("tieSlur"in b.dataset?b.ariaLabel="スラー":["metaData","macroDef","macroArgUse","macroUse","otherAction"].some(w=>w in b.dataset)&&await ot(b));"repeatStartEnd"in b.dataset?(b.classList.remove("material-icons"),b.ariaLabel="リピート開始",b.textContent="◆",b.dataset.repeatStartEnd="/:"+(b.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in b.dataset?(b.dataset.polyStartEnd="[",b.textContent="["):"macroDef"in b.dataset&&(b.dataset.macroDef===";"&&(b.dataset.macroDef="$="),b.textContent="$="),E.appendChild(b),l=E;break;case"move":l=v.parentElement;break}if(d&&n.target.id!=="add-track"&&n.target.id!=="remove-track"){const E=n.dataTransfer.dropEffect==="copy"||g<u?"beforebegin":"afterend";n.target.parentElement.insertAdjacentElement(E,l)}else m.appendChild(l);switch(H=l.firstElementChild,t===se&&(N.activeTrack=m,N.blocksDataUpdate(),n.dataTransfer.dropEffect==="move"&&N.calcPoly(),"playFromHere"in H.dataset&&(t.querySelectorAll(".inactive").forEach(E=>{E.classList.remove("inactive")}),[...t.querySelectorAll(".track button")].filter((E,b)=>E===H?!1:N.activeTrack.contains(E)?g<u?b<g:b<=g:!0).forEach(E=>{E.classList.add("inactive")})),N.saveBlocksData(),N.exportMml(Z),"tonePitch"in H.dataset&&(H.dataset.tonePitch=H.dataset.tonePitch.replace(/[><]+/,""),Le(H),H.classList.add("bounce"))),n.dataTransfer.dropEffect){case"copy":be.pushState({operation:"copy",toIndex:g,newElem:l,parent:m});break;case"move":be.pushState({operation:"move",fromIndex:u,toIndex:g,elem:l,parent:m});break}if(n.dataTransfer.dropEffect==="copy"&&["repeatStartEnd","polyStartEnd","macroDef"].some(E=>E in H.dataset)){const E=document.createElement("li"),b=v.cloneNode(!0);"repeatStartEnd"in H.dataset?(b.classList.add("material-icons"),b.ariaLabel="リピート終了",b.textContent="repeat",b.dataset.repeatStartEnd=":/"):"polyStartEnd"in H.dataset?(b.dataset.polyStartEnd="]",b.textContent="]"):"macroDef"in H.dataset&&(b.dataset.macroDef=";",b.textContent=";"),E.appendChild(b),l.insertAdjacentElement("afterend",E),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z),be.pushState({operation:"copy",toIndex:g+1,newElem:E,parent:m})}});const s=n=>{[...document.getElementsByClassName("droppable")].forEach(c=>{c.classList.remove("droppable")})};t.addEventListener("dragend",s)});Ve.addEventListener("animationend",t=>{t.target.classList.remove("bounce"),t.target.classList.remove("pop")});Fe.addEventListener("click",t=>{t.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),N.activeTrack=e,se.insertBefore(e,Fe)});lt.addEventListener("click",t=>{t.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),N.activeTrack=r,N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z)});We.addEventListener("pointerdown",t=>{t.target===We&&We.addEventListener("pointerup",e=>{e.target===We&&We.close()},{once:!0})});We.addEventListener("close",()=>{switch(Lt.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});Ct.addEventListener("click",()=>{const t=xe.isPlaying();t?(xe.stop(),N.stopRendering(),xe.removeEventListener("compilecomplete",mn),It.disabled=!1):(xe.play(Z.getMml()),xe.addEventListener("compilecomplete",mn),It.disabled=!0),Ct.innerHTML=t?Sr:ns});It.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const t=[...se.children];t.pop(),be.pushState({operation:"clear",tonesChildren:[...de.querySelector("ul").children],musicalScoreChildren:t,lastTouchedButton:H}),de.querySelector("ul").textContent="";const e=de.querySelector("ul"),r=document.createElement("li"),o='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=o;const s=r.firstElementChild;e.appendChild(r),H=s,se.querySelectorAll(".track").forEach((n,c)=>{c?n.remove():(n.textContent="",N.activeTrack=n)}),xe.play(""),N.blocksDataUpdate(),N.saveBlocksData(),N.exportMml(Z)}});Ue.addEventListener("click",()=>{const t=Z.getMml(),e=Ue.innerHTML;Ue.disabled=!0,navigator.clipboard.writeText(t).then(()=>{Ue.disabled=!0,Ue.innerHTML=ut("content_copy")+"コピーしました",setTimeout(()=>{Ue.innerHTML=e,Ue.disabled=!1},1500)}).catch(r=>alert(`コピーできませんでした
`+r))});Be.addEventListener("click",()=>{const t=Be.innerHTML;Be.disabled=!0,navigator.clipboard.readText().then(e=>{Be.disabled=!0,e?(Z.setMml(e.replace(/\r/g,"")),N.importMml(Z),Be.innerHTML=ut("content_paste")+"貼り付けました"):Be.innerHTML=ut("content_paste")+"内容がありません",setTimeout(()=>{Be.innerHTML=t,Be.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});Nt.addEventListener("click",()=>{var n;const t=Z.getMml(),r=((n=Z.getMmlArr().find(c=>c.startsWith("#TITLE")))==null?void 0:n.split(" ").slice(1).join(" "))??"無題",o=new Blob([t],{type:"text/plain"}),s=document.createElement("a");s.download=r+".mml",s.href=URL.createObjectURL(o),s.click(),URL.revokeObjectURL(s.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。")});un.addEventListener("click",()=>{const t=document.createElement("input"),e=new FileReader;t.type="file",t.accept=".mml,.flmml,.txt",t.click(),t.onchange=()=>{e.onload=()=>{Z.setMml(e.result),N.importMml(Z)},e.readAsText(t.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");be.onPushstate=t=>{At.disabled=!1,Dt.disabled=!0};At.addEventListener("click",()=>{const{canUndo:t,canRedo:e}=be.undo();At.disabled=!t,Dt.disabled=!e});Dt.addEventListener("click",()=>{const{canUndo:t,canRedo:e}=be.redo();At.disabled=!t,Dt.disabled=!e});
