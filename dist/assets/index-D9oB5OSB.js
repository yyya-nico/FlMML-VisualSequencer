var Ln=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var R=(n,e,r)=>(Ln(n,e,"read from private field"),r?r.call(n):e.get(n)),we=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},ke=(n,e,r,o)=>(Ln(n,e,"write to private field"),o?o.call(n,r):e.set(n,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const t of i)if(t.type==="childList")for(const l of t.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function r(i){const t={};return i.integrity&&(t.integrity=i.integrity),i.referrerPolicy&&(t.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?t.credentials="include":i.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function o(i){if(i.ep)return;i.ep=!0;const t=r(i);fetch(i.href,t)}})();const ea="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var et=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ta(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Vn={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(r,o){n.exports=o()})(self,function(){return(()=>{var r={587:(t,l,v)=>{var f;(f=(function(u,y){Object.defineProperty(y,"__esModule",{value:!0}),y.MsgTypes=y.SAMPLE_RATE=void 0,y.SAMPLE_RATE=44100,y.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(l,[v,l]))===void 0||(t.exports=f)},581:(t,l,v)=>{var f;(f=(function(u,y){Object.defineProperty(y,"__esModule",{value:!0}),y.FlMMLAudioExportError=void 0;class h extends Error{constructor(...E){super(...E),this.name="FlMMLAudioExportError"}}y.FlMMLAudioExportError=h}).apply(l,[v,l]))===void 0||(t.exports=f)},643:function(t,l,v){var f,u,y=this&&this.__awaiter||function(h,c,E,T){return new(E||(E=Promise))(function(S,g){function D(j){try{N(T.next(j))}catch(C){g(C)}}function $(j){try{N(T.throw(j))}catch(C){g(C)}}function N(j){var C;j.done?S(j.value):(C=j.value,C instanceof E?C:new E(function(U){U(C)})).then(D,$)}N((T=T.apply(h,c||[])).next())})};f=[v,l,v(587),v(581),v(158)],(u=(function(h,c,E,T,S){Object.defineProperty(c,"__esModule",{value:!0}),c.FlMMLonHTML5=c.FlMMLAudioExportError=c.FlMML=void 0,Object.defineProperty(c,"FlMMLAudioExportError",{enumerable:!0,get:function(){return T.FlMMLAudioExportError}});const g="flmml-on-html5.worker.js";class D{constructor(N=g){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof N=="string"&&(N={workerURL:N});const j=N.workerURL||g,C=N.infoInterval>=0?N.infoInterval:125;this.bufferSize=N.bufferSize>=128?Math.floor(N.bufferSize-N.bufferSize%128):8192,this.bufferMultiple=N.bufferMultiple>=1?Math.floor(N.bufferMultiple):32,this.lamejsURL=N.lamejsURL,(this.worker=new Worker(N.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${j}")`],{type:"application/javascript"})):j)).addEventListener("message",U=>{this.onMessage(U)}),this.setInfoInterval(C)}static initWebAudio(){const N=D.audioCtx=new AudioContext({sampleRate:E.SAMPLE_RATE}),j=N.createBufferSource();j.connect(N.destination),j.start(0),N.resume(),j.stop()}static hookInitWebAudio(N){const j=document.querySelectorAll(N);j.forEach(C=>{C.addEventListener("click",function U(){D.audioCtx||D.initWebAudio(),j.forEach(F=>{F.removeEventListener("click",U,!0)})},!0)})}static prepare(N){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{D.hookInitWebAudio(N)}):D.hookInitWebAudio(N)}onMessage(N){const j=N.data;switch(j.type){case E.MsgTypes.COMPCOMP:this.totalMSec=j.info.totalMSec,this.totalTimeStr=j.info.totalTimeStr,this.warnings=j.info.warnings,this.metaTitle=j.info.metaTitle,this.metaComment=j.info.metaComment,this.metaArtist=j.info.metaArtist,this.metaCoding=j.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case E.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(j),this.trigger("buffering",{progress:j.progress});break;case E.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case E.MsgTypes.SYNCINFO:this._isPlaying=j.info._isPlaying,this._isPaused=j.info._isPaused,this.nowMSec=j.info.nowMSec,this.nowTimeStr=j.info.nowTimeStr,this.voiceCount=j.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case E.MsgTypes.PLAYSOUND:this.playSound();break;case E.MsgTypes.STOPSOUND:this.stopSound();break;case E.MsgTypes.EXPORT:j.data?this.completeAudioExport(j.data):this.errorAudioExport(j.errorMsg)}}boot(){this.worker.postMessage({type:E.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const N=D.audioCtx,j=this.gainNode=N.createGain();j.gain.value=this.volume/127,j.connect(N.destination),y(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(U=>{const F=new FileReader;F.onload=q=>{N.audioWorklet.addModule(q.target.result).then(U)},F.readAsDataURL(new Blob([S.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const C=this.workletNode=new AudioWorkletNode(N,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});C.connect(j),this.worker.postMessage({type:E.MsgTypes.PLAYSOUND,workletPort:C.port},[C.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:E.MsgTypes.STOPSOUND})}trigger(N,j){const C=this.events[N];if(!C)return;const U={};for(let F in j)U[F]=j[F];for(let F=0,q=C.length;F<q;F++)C[F]&&C[F].call(this,U)}exportAudio(N,j,C={}){return D.audioCtx||D.initWebAudio(),this.booted||this.boot(),new Promise((U,F)=>{this.audioExportResolve?F(new T.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:E.MsgTypes.EXPORT,mml:N,format:j},C)),this.audioExportResolve=U,this.audioExportReject=F)})}completeAudioExport(N){this.audioExportResolve&&(this.audioExportResolve(N),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(N){this.audioExportReject&&(this.audioExportReject(new T.FlMMLAudioExportError(N)),this.audioExportResolve=null,this.audioExportReject=null)}play(N){D.audioCtx||D.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:E.MsgTypes.PLAY,mml:N})}stop(){this.worker.postMessage({type:E.MsgTypes.STOP})}pause(){this.worker.postMessage({type:E.MsgTypes.PAUSE})}exportWav(N){return this.exportAudio(N,"wav")}exportMp3(N,j){return this.exportAudio(N,"mp3",{bitrate:j})}setMasterVolume(N){this.volume=N,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(N){this.worker.postMessage({type:E.MsgTypes.SYNCINFO,interval:N})}syncInfo(){this.worker.postMessage({type:E.MsgTypes.SYNCINFO,interval:null})}addEventListener(N,j){let C=this.events[N];C||(C=this.events[N]=[]);for(let U=C.length;U--;)if(C[U]===j)return!1;return C.push(j),!0}removeEventListener(N,j){const C=this.events[N];if(!C)return!1;for(let U=C.length;U--;)if(C[U]===j)return C.splice(U,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}c.FlMML=D,c.FlMMLonHTML5=D}).apply(l,f))===void 0||(t.exports=u)},158:(t,l,v)=>{v.r(l),v.d(l,{FlMMLWorkletScript:()=>f});const f='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},o={};function i(t){var l=o[t];if(l!==void 0)return l.exports;var v=o[t]={exports:{}};return r[t].call(v.exports,v,v.exports,i),v.exports}return i.d=(t,l)=>{for(var v in l)i.o(l,v)&&!i.o(t,v)&&Object.defineProperty(t,v,{enumerable:!0,get:l[v]})},i.o=(t,l)=>Object.prototype.hasOwnProperty.call(t,l),i.r=t=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i(643)})()})})(Vn);var zn=Vn.exports;function dt(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Yn={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(r){n.exports=r()})(function(){return function r(o,i,t){function l(u,y){if(!i[u]){if(!o[u]){var h=typeof dt=="function"&&dt;if(!y&&h)return h(u,!0);if(v)return v(u,!0);var c=new Error("Cannot find module '"+u+"'");throw c.code="MODULE_NOT_FOUND",c}var E=i[u]={exports:{}};o[u][0].call(E.exports,function(T){var S=o[u][1][T];return l(S||T)},E,E.exports,r,o,i,t)}return i[u].exports}for(var v=typeof dt=="function"&&dt,f=0;f<t.length;f++)l(t[f]);return l}({1:[function(r,o,i){(function(t){var l=t.MutationObserver||t.WebKitMutationObserver,v;if(l){var f=0,u=new l(T),y=t.document.createTextNode("");u.observe(y,{characterData:!0}),v=function(){y.data=f=++f%2}}else if(!t.setImmediate&&typeof t.MessageChannel<"u"){var h=new t.MessageChannel;h.port1.onmessage=T,v=function(){h.port2.postMessage(0)}}else"document"in t&&"onreadystatechange"in t.document.createElement("script")?v=function(){var g=t.document.createElement("script");g.onreadystatechange=function(){T(),g.onreadystatechange=null,g.parentNode.removeChild(g),g=null},t.document.documentElement.appendChild(g)}:v=function(){setTimeout(T,0)};var c,E=[];function T(){c=!0;for(var g,D,$=E.length;$;){for(D=E,E=[],g=-1;++g<$;)D[g]();$=E.length}c=!1}o.exports=S;function S(g){E.push(g)===1&&!c&&v()}}).call(this,typeof et<"u"?et:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,o,i){var t=r(1);function l(){}var v={},f=["REJECTED"],u=["FULFILLED"],y=["PENDING"];o.exports=h;function h(C){if(typeof C!="function")throw new TypeError("resolver must be a function");this.state=y,this.queue=[],this.outcome=void 0,C!==l&&S(this,C)}h.prototype.catch=function(C){return this.then(null,C)},h.prototype.then=function(C,U){if(typeof C!="function"&&this.state===u||typeof U!="function"&&this.state===f)return this;var F=new this.constructor(l);if(this.state!==y){var q=this.state===u?C:U;E(F,q,this.outcome)}else this.queue.push(new c(F,C,U));return F};function c(C,U,F){this.promise=C,typeof U=="function"&&(this.onFulfilled=U,this.callFulfilled=this.otherCallFulfilled),typeof F=="function"&&(this.onRejected=F,this.callRejected=this.otherCallRejected)}c.prototype.callFulfilled=function(C){v.resolve(this.promise,C)},c.prototype.otherCallFulfilled=function(C){E(this.promise,this.onFulfilled,C)},c.prototype.callRejected=function(C){v.reject(this.promise,C)},c.prototype.otherCallRejected=function(C){E(this.promise,this.onRejected,C)};function E(C,U,F){t(function(){var q;try{q=U(F)}catch(de){return v.reject(C,de)}q===C?v.reject(C,new TypeError("Cannot resolve promise with itself")):v.resolve(C,q)})}v.resolve=function(C,U){var F=g(T,U);if(F.status==="error")return v.reject(C,F.value);var q=F.value;if(q)S(C,q);else{C.state=u,C.outcome=U;for(var de=-1,ie=C.queue.length;++de<ie;)C.queue[de].callFulfilled(U)}return C},v.reject=function(C,U){C.state=f,C.outcome=U;for(var F=-1,q=C.queue.length;++F<q;)C.queue[F].callRejected(U);return C};function T(C){var U=C&&C.then;if(C&&(typeof C=="object"||typeof C=="function")&&typeof U=="function")return function(){U.apply(C,arguments)}}function S(C,U){var F=!1;function q(fe){F||(F=!0,v.reject(C,fe))}function de(fe){F||(F=!0,v.resolve(C,fe))}function ie(){U(de,q)}var te=g(ie);te.status==="error"&&q(te.value)}function g(C,U){var F={};try{F.value=C(U),F.status="success"}catch(q){F.status="error",F.value=q}return F}h.resolve=D;function D(C){return C instanceof this?C:v.resolve(new this(l),C)}h.reject=$;function $(C){var U=new this(l);return v.reject(U,C)}h.all=N;function N(C){var U=this;if(Object.prototype.toString.call(C)!=="[object Array]")return this.reject(new TypeError("must be an array"));var F=C.length,q=!1;if(!F)return this.resolve([]);for(var de=new Array(F),ie=0,te=-1,fe=new this(l);++te<F;)Ee(C[te],te);return fe;function Ee(L,w){U.resolve(L).then(B,function(_){q||(q=!0,v.reject(fe,_))});function B(_){de[w]=_,++ie===F&&!q&&(q=!0,v.resolve(fe,de))}}}h.race=j;function j(C){var U=this;if(Object.prototype.toString.call(C)!=="[object Array]")return this.reject(new TypeError("must be an array"));var F=C.length,q=!1;if(!F)return this.resolve([]);for(var de=-1,ie=new this(l);++de<F;)te(C[de]);return ie;function te(fe){U.resolve(fe).then(function(Ee){q||(q=!0,v.resolve(ie,Ee))},function(Ee){q||(q=!0,v.reject(ie,Ee))})}}},{1:1}],3:[function(r,o,i){(function(t){typeof t.Promise!="function"&&(t.Promise=r(2))}).call(this,typeof et<"u"?et:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,o,i){var t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};function l(a,d){if(!(a instanceof d))throw new TypeError("Cannot call a class as a function")}function v(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var f=v();function u(){try{if(!f||!f.open)return!1;var a=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),d=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!a||d)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function y(a,d){a=a||[],d=d||{};try{return new Blob(a,d)}catch(m){if(m.name!=="TypeError")throw m;for(var s=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,p=new s,b=0;b<a.length;b+=1)p.append(a[b]);return p.getBlob(d.type)}}typeof Promise>"u"&&r(3);var h=Promise;function c(a,d){d&&a.then(function(s){d(null,s)},function(s){d(s)})}function E(a,d,s){typeof d=="function"&&a.then(d),typeof s=="function"&&a.catch(s)}function T(a){return typeof a!="string"&&(console.warn(a+" used as a key, but it is not a string."),a=String(a)),a}function S(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var g="local-forage-detect-blob-support",D=void 0,$={},N=Object.prototype.toString,j="readonly",C="readwrite";function U(a){for(var d=a.length,s=new ArrayBuffer(d),p=new Uint8Array(s),b=0;b<d;b++)p[b]=a.charCodeAt(b);return s}function F(a){return new h(function(d){var s=a.transaction(g,C),p=y([""]);s.objectStore(g).put(p,"key"),s.onabort=function(b){b.preventDefault(),b.stopPropagation(),d(!1)},s.oncomplete=function(){var b=navigator.userAgent.match(/Chrome\/(\d+)/),m=navigator.userAgent.match(/Edge\//);d(m||!b||parseInt(b[1],10)>=43)}}).catch(function(){return!1})}function q(a){return typeof D=="boolean"?h.resolve(D):F(a).then(function(d){return D=d,D})}function de(a){var d=$[a.name],s={};s.promise=new h(function(p,b){s.resolve=p,s.reject=b}),d.deferredOperations.push(s),d.dbReady?d.dbReady=d.dbReady.then(function(){return s.promise}):d.dbReady=s.promise}function ie(a){var d=$[a.name],s=d.deferredOperations.pop();if(s)return s.resolve(),s.promise}function te(a,d){var s=$[a.name],p=s.deferredOperations.pop();if(p)return p.reject(d),p.promise}function fe(a,d){return new h(function(s,p){if($[a.name]=$[a.name]||ee(),a.db)if(d)de(a),a.db.close();else return s(a.db);var b=[a.name];d&&b.push(a.version);var m=f.open.apply(f,b);d&&(m.onupgradeneeded=function(x){var A=m.result;try{A.createObjectStore(a.storeName),x.oldVersion<=1&&A.createObjectStore(g)}catch(M){if(M.name==="ConstraintError")console.warn('The database "'+a.name+'" has been upgraded from version '+x.oldVersion+" to version "+x.newVersion+', but the storage "'+a.storeName+'" already exists.');else throw M}}),m.onerror=function(x){x.preventDefault(),p(m.error)},m.onsuccess=function(){var x=m.result;x.onversionchange=function(A){A.target.close()},s(x),ie(a)}})}function Ee(a){return fe(a,!1)}function L(a){return fe(a,!0)}function w(a,d){if(!a.db)return!0;var s=!a.db.objectStoreNames.contains(a.storeName),p=a.version<a.db.version,b=a.version>a.db.version;if(p&&(a.version!==d&&console.warn('The database "'+a.name+`" can't be downgraded from version `+a.db.version+" to version "+a.version+"."),a.version=a.db.version),b||s){if(s){var m=a.db.version+1;m>a.version&&(a.version=m)}return!0}return!1}function B(a){return new h(function(d,s){var p=new FileReader;p.onerror=s,p.onloadend=function(b){var m=btoa(b.target.result||"");d({__local_forage_encoded_blob:!0,data:m,type:a.type})},p.readAsBinaryString(a)})}function _(a){var d=U(atob(a.data));return y([d],{type:a.type})}function V(a){return a&&a.__local_forage_encoded_blob}function H(a){var d=this,s=d._initReady().then(function(){var p=$[d._dbInfo.name];if(p&&p.dbReady)return p.dbReady});return E(s,a,a),s}function Y(a){de(a);for(var d=$[a.name],s=d.forages,p=0;p<s.length;p++){var b=s[p];b._dbInfo.db&&(b._dbInfo.db.close(),b._dbInfo.db=null)}return a.db=null,Ee(a).then(function(m){return a.db=m,w(a)?L(a):m}).then(function(m){a.db=d.db=m;for(var x=0;x<s.length;x++)s[x]._dbInfo.db=m}).catch(function(m){throw te(a,m),m})}function X(a,d,s,p){p===void 0&&(p=1);try{var b=a.db.transaction(a.storeName,d);s(null,b)}catch(m){if(p>0&&(!a.db||m.name==="InvalidStateError"||m.name==="NotFoundError"))return h.resolve().then(function(){if(!a.db||m.name==="NotFoundError"&&!a.db.objectStoreNames.contains(a.storeName)&&a.version<=a.db.version)return a.db&&(a.version=a.db.version+1),L(a)}).then(function(){return Y(a).then(function(){X(a,d,s,p-1)})}).catch(s);s(m)}}function ee(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function he(a){var d=this,s={db:null};if(a)for(var p in a)s[p]=a[p];var b=$[s.name];b||(b=ee(),$[s.name]=b),b.forages.push(d),d._initReady||(d._initReady=d.ready,d.ready=H);var m=[];function x(){return h.resolve()}for(var A=0;A<b.forages.length;A++){var M=b.forages[A];M!==d&&m.push(M._initReady().catch(x))}var O=b.forages.slice(0);return h.all(m).then(function(){return s.db=b.db,Ee(s)}).then(function(P){return s.db=P,w(s,d._defaultConfig.version)?L(s):P}).then(function(P){s.db=b.db=P,d._dbInfo=s;for(var z=0;z<O.length;z++){var Z=O[z];Z!==d&&(Z._dbInfo.db=s.db,Z._dbInfo.version=s.version)}})}function Se(a,d){var s=this;a=T(a);var p=new h(function(b,m){s.ready().then(function(){X(s._dbInfo,j,function(x,A){if(x)return m(x);try{var M=A.objectStore(s._dbInfo.storeName),O=M.get(a);O.onsuccess=function(){var P=O.result;P===void 0&&(P=null),V(P)&&(P=_(P)),b(P)},O.onerror=function(){m(O.error)}}catch(P){m(P)}})}).catch(m)});return c(p,d),p}function Ne(a,d){var s=this,p=new h(function(b,m){s.ready().then(function(){X(s._dbInfo,j,function(x,A){if(x)return m(x);try{var M=A.objectStore(s._dbInfo.storeName),O=M.openCursor(),P=1;O.onsuccess=function(){var z=O.result;if(z){var Z=z.value;V(Z)&&(Z=_(Z));var oe=a(Z,z.key,P++);oe!==void 0?b(oe):z.continue()}else b()},O.onerror=function(){m(O.error)}}catch(z){m(z)}})}).catch(m)});return c(p,d),p}function k(a,d,s){var p=this;a=T(a);var b=new h(function(m,x){var A;p.ready().then(function(){return A=p._dbInfo,N.call(d)==="[object Blob]"?q(A.db).then(function(M){return M?d:B(d)}):d}).then(function(M){X(p._dbInfo,C,function(O,P){if(O)return x(O);try{var z=P.objectStore(p._dbInfo.storeName);M===null&&(M=void 0);var Z=z.put(M,a);P.oncomplete=function(){M===void 0&&(M=null),m(M)},P.onabort=P.onerror=function(){var oe=Z.error?Z.error:Z.transaction.error;x(oe)}}catch(oe){x(oe)}})}).catch(x)});return c(b,s),b}function W(a,d){var s=this;a=T(a);var p=new h(function(b,m){s.ready().then(function(){X(s._dbInfo,C,function(x,A){if(x)return m(x);try{var M=A.objectStore(s._dbInfo.storeName),O=M.delete(a);A.oncomplete=function(){b()},A.onerror=function(){m(O.error)},A.onabort=function(){var P=O.error?O.error:O.transaction.error;m(P)}}catch(P){m(P)}})}).catch(m)});return c(p,d),p}function G(a){var d=this,s=new h(function(p,b){d.ready().then(function(){X(d._dbInfo,C,function(m,x){if(m)return b(m);try{var A=x.objectStore(d._dbInfo.storeName),M=A.clear();x.oncomplete=function(){p()},x.onabort=x.onerror=function(){var O=M.error?M.error:M.transaction.error;b(O)}}catch(O){b(O)}})}).catch(b)});return c(s,a),s}function K(a){var d=this,s=new h(function(p,b){d.ready().then(function(){X(d._dbInfo,j,function(m,x){if(m)return b(m);try{var A=x.objectStore(d._dbInfo.storeName),M=A.count();M.onsuccess=function(){p(M.result)},M.onerror=function(){b(M.error)}}catch(O){b(O)}})}).catch(b)});return c(s,a),s}function ae(a,d){var s=this,p=new h(function(b,m){if(a<0){b(null);return}s.ready().then(function(){X(s._dbInfo,j,function(x,A){if(x)return m(x);try{var M=A.objectStore(s._dbInfo.storeName),O=!1,P=M.openKeyCursor();P.onsuccess=function(){var z=P.result;if(!z){b(null);return}a===0||O?b(z.key):(O=!0,z.advance(a))},P.onerror=function(){m(P.error)}}catch(z){m(z)}})}).catch(m)});return c(p,d),p}function ne(a){var d=this,s=new h(function(p,b){d.ready().then(function(){X(d._dbInfo,j,function(m,x){if(m)return b(m);try{var A=x.objectStore(d._dbInfo.storeName),M=A.openKeyCursor(),O=[];M.onsuccess=function(){var P=M.result;if(!P){p(O);return}O.push(P.key),P.continue()},M.onerror=function(){b(M.error)}}catch(P){b(P)}})}).catch(b)});return c(s,a),s}function be(a,d){d=S.apply(this,arguments);var s=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||s.name,a.storeName=a.storeName||s.storeName);var p=this,b;if(!a.name)b=h.reject("Invalid arguments");else{var m=a.name===s.name&&p._dbInfo.db,x=m?h.resolve(p._dbInfo.db):Ee(a).then(function(A){var M=$[a.name],O=M.forages;M.db=A;for(var P=0;P<O.length;P++)O[P]._dbInfo.db=A;return A});a.storeName?b=x.then(function(A){if(A.objectStoreNames.contains(a.storeName)){var M=A.version+1;de(a);var O=$[a.name],P=O.forages;A.close();for(var z=0;z<P.length;z++){var Z=P[z];Z._dbInfo.db=null,Z._dbInfo.version=M}var oe=new h(function(se,ve){var me=f.open(a.name,M);me.onerror=function(Ce){var Qe=me.result;Qe.close(),ve(Ce)},me.onupgradeneeded=function(){var Ce=me.result;Ce.deleteObjectStore(a.storeName)},me.onsuccess=function(){var Ce=me.result;Ce.close(),se(Ce)}});return oe.then(function(se){O.db=se;for(var ve=0;ve<P.length;ve++){var me=P[ve];me._dbInfo.db=se,ie(me._dbInfo)}}).catch(function(se){throw(te(a,se)||h.resolve()).catch(function(){}),se})}}):b=x.then(function(A){de(a);var M=$[a.name],O=M.forages;A.close();for(var P=0;P<O.length;P++){var z=O[P];z._dbInfo.db=null}var Z=new h(function(oe,se){var ve=f.deleteDatabase(a.name);ve.onerror=function(){var me=ve.result;me&&me.close(),se(ve.error)},ve.onblocked=function(){console.warn('dropInstance blocked for database "'+a.name+'" until all open connections are closed')},ve.onsuccess=function(){var me=ve.result;me&&me.close(),oe(me)}});return Z.then(function(oe){M.db=oe;for(var se=0;se<O.length;se++){var ve=O[se];ie(ve._dbInfo)}}).catch(function(oe){throw(te(a,oe)||h.resolve()).catch(function(){}),oe})})}return c(b,d),b}var Ve={_driver:"asyncStorage",_initStorage:he,_support:u(),iterate:Ne,getItem:Se,setItem:k,removeItem:W,clear:G,length:K,key:ae,keys:ne,dropInstance:be};function mr(){return typeof openDatabase=="function"}var Me="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",pr="~~local_forage_type~",hn=/^~~local_forage_type~([^~]+)~/,lt="__lfsc__:",Mt=lt.length,Ot="arbf",Pt="blob",mn="si08",pn="ui08",vn="uic8",gn="si16",yn="si32",bn="ur16",En="ui32",Sn="fl32",wn="fl64",Tn=Mt+Ot.length,kn=Object.prototype.toString;function xn(a){var d=a.length*.75,s=a.length,p,b=0,m,x,A,M;a[a.length-1]==="="&&(d--,a[a.length-2]==="="&&d--);var O=new ArrayBuffer(d),P=new Uint8Array(O);for(p=0;p<s;p+=4)m=Me.indexOf(a[p]),x=Me.indexOf(a[p+1]),A=Me.indexOf(a[p+2]),M=Me.indexOf(a[p+3]),P[b++]=m<<2|x>>4,P[b++]=(x&15)<<4|A>>2,P[b++]=(A&3)<<6|M&63;return O}function jt(a){var d=new Uint8Array(a),s="",p;for(p=0;p<d.length;p+=3)s+=Me[d[p]>>2],s+=Me[(d[p]&3)<<4|d[p+1]>>4],s+=Me[(d[p+1]&15)<<2|d[p+2]>>6],s+=Me[d[p+2]&63];return d.length%3===2?s=s.substring(0,s.length-1)+"=":d.length%3===1&&(s=s.substring(0,s.length-2)+"=="),s}function vr(a,d){var s="";if(a&&(s=kn.call(a)),a&&(s==="[object ArrayBuffer]"||a.buffer&&kn.call(a.buffer)==="[object ArrayBuffer]")){var p,b=lt;a instanceof ArrayBuffer?(p=a,b+=Ot):(p=a.buffer,s==="[object Int8Array]"?b+=mn:s==="[object Uint8Array]"?b+=pn:s==="[object Uint8ClampedArray]"?b+=vn:s==="[object Int16Array]"?b+=gn:s==="[object Uint16Array]"?b+=bn:s==="[object Int32Array]"?b+=yn:s==="[object Uint32Array]"?b+=En:s==="[object Float32Array]"?b+=Sn:s==="[object Float64Array]"?b+=wn:d(new Error("Failed to get type for BinaryArray"))),d(b+jt(p))}else if(s==="[object Blob]"){var m=new FileReader;m.onload=function(){var x=pr+a.type+"~"+jt(this.result);d(lt+Pt+x)},m.readAsArrayBuffer(a)}else try{d(JSON.stringify(a))}catch(x){console.error("Couldn't convert value into a JSON string: ",a),d(null,x)}}function gr(a){if(a.substring(0,Mt)!==lt)return JSON.parse(a);var d=a.substring(Tn),s=a.substring(Mt,Tn),p;if(s===Pt&&hn.test(d)){var b=d.match(hn);p=b[1],d=d.substring(b[0].length)}var m=xn(d);switch(s){case Ot:return m;case Pt:return y([m],{type:p});case mn:return new Int8Array(m);case pn:return new Uint8Array(m);case vn:return new Uint8ClampedArray(m);case gn:return new Int16Array(m);case bn:return new Uint16Array(m);case yn:return new Int32Array(m);case En:return new Uint32Array(m);case Sn:return new Float32Array(m);case wn:return new Float64Array(m);default:throw new Error("Unkown type: "+s)}}var Bt={serialize:vr,deserialize:gr,stringToBuffer:xn,bufferToString:jt};function Cn(a,d,s,p){a.executeSql("CREATE TABLE IF NOT EXISTS "+d.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],s,p)}function yr(a){var d=this,s={db:null};if(a)for(var p in a)s[p]=typeof a[p]!="string"?a[p].toString():a[p];var b=new h(function(m,x){try{s.db=openDatabase(s.name,String(s.version),s.description,s.size)}catch(A){return x(A)}s.db.transaction(function(A){Cn(A,s,function(){d._dbInfo=s,m()},function(M,O){x(O)})},x)});return s.serializer=Bt,b}function Oe(a,d,s,p,b,m){a.executeSql(s,p,b,function(x,A){A.code===A.SYNTAX_ERR?x.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[d.storeName],function(M,O){O.rows.length?m(M,A):Cn(M,d,function(){M.executeSql(s,p,b,m)},m)},m):m(x,A)},m)}function br(a,d){var s=this;a=T(a);var p=new h(function(b,m){s.ready().then(function(){var x=s._dbInfo;x.db.transaction(function(A){Oe(A,x,"SELECT * FROM "+x.storeName+" WHERE key = ? LIMIT 1",[a],function(M,O){var P=O.rows.length?O.rows.item(0).value:null;P&&(P=x.serializer.deserialize(P)),b(P)},function(M,O){m(O)})})}).catch(m)});return c(p,d),p}function Er(a,d){var s=this,p=new h(function(b,m){s.ready().then(function(){var x=s._dbInfo;x.db.transaction(function(A){Oe(A,x,"SELECT * FROM "+x.storeName,[],function(M,O){for(var P=O.rows,z=P.length,Z=0;Z<z;Z++){var oe=P.item(Z),se=oe.value;if(se&&(se=x.serializer.deserialize(se)),se=a(se,oe.key,Z+1),se!==void 0){b(se);return}}b()},function(M,O){m(O)})})}).catch(m)});return c(p,d),p}function In(a,d,s,p){var b=this;a=T(a);var m=new h(function(x,A){b.ready().then(function(){d===void 0&&(d=null);var M=d,O=b._dbInfo;O.serializer.serialize(d,function(P,z){z?A(z):O.db.transaction(function(Z){Oe(Z,O,"INSERT OR REPLACE INTO "+O.storeName+" (key, value) VALUES (?, ?)",[a,P],function(){x(M)},function(oe,se){A(se)})},function(Z){if(Z.code===Z.QUOTA_ERR){if(p>0){x(In.apply(b,[a,M,s,p-1]));return}A(Z)}})})}).catch(A)});return c(m,s),m}function Sr(a,d,s){return In.apply(this,[a,d,s,1])}function wr(a,d){var s=this;a=T(a);var p=new h(function(b,m){s.ready().then(function(){var x=s._dbInfo;x.db.transaction(function(A){Oe(A,x,"DELETE FROM "+x.storeName+" WHERE key = ?",[a],function(){b()},function(M,O){m(O)})})}).catch(m)});return c(p,d),p}function Tr(a){var d=this,s=new h(function(p,b){d.ready().then(function(){var m=d._dbInfo;m.db.transaction(function(x){Oe(x,m,"DELETE FROM "+m.storeName,[],function(){p()},function(A,M){b(M)})})}).catch(b)});return c(s,a),s}function kr(a){var d=this,s=new h(function(p,b){d.ready().then(function(){var m=d._dbInfo;m.db.transaction(function(x){Oe(x,m,"SELECT COUNT(key) as c FROM "+m.storeName,[],function(A,M){var O=M.rows.item(0).c;p(O)},function(A,M){b(M)})})}).catch(b)});return c(s,a),s}function xr(a,d){var s=this,p=new h(function(b,m){s.ready().then(function(){var x=s._dbInfo;x.db.transaction(function(A){Oe(A,x,"SELECT key FROM "+x.storeName+" WHERE id = ? LIMIT 1",[a+1],function(M,O){var P=O.rows.length?O.rows.item(0).key:null;b(P)},function(M,O){m(O)})})}).catch(m)});return c(p,d),p}function Cr(a){var d=this,s=new h(function(p,b){d.ready().then(function(){var m=d._dbInfo;m.db.transaction(function(x){Oe(x,m,"SELECT key FROM "+m.storeName,[],function(A,M){for(var O=[],P=0;P<M.rows.length;P++)O.push(M.rows.item(P).key);p(O)},function(A,M){b(M)})})}).catch(b)});return c(s,a),s}function Ir(a){return new h(function(d,s){a.transaction(function(p){p.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(b,m){for(var x=[],A=0;A<m.rows.length;A++)x.push(m.rows.item(A).name);d({db:a,storeNames:x})},function(b,m){s(m)})},function(p){s(p)})})}function Nr(a,d){d=S.apply(this,arguments);var s=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||s.name,a.storeName=a.storeName||s.storeName);var p=this,b;return a.name?b=new h(function(m){var x;a.name===s.name?x=p._dbInfo.db:x=openDatabase(a.name,"","",0),a.storeName?m({db:x,storeNames:[a.storeName]}):m(Ir(x))}).then(function(m){return new h(function(x,A){m.db.transaction(function(M){function O(oe){return new h(function(se,ve){M.executeSql("DROP TABLE IF EXISTS "+oe,[],function(){se()},function(me,Ce){ve(Ce)})})}for(var P=[],z=0,Z=m.storeNames.length;z<Z;z++)P.push(O(m.storeNames[z]));h.all(P).then(function(){x()}).catch(function(oe){A(oe)})},function(M){A(M)})})}):b=h.reject("Invalid arguments"),c(b,d),b}var Ar={_driver:"webSQLStorage",_initStorage:yr,_support:mr(),iterate:Er,getItem:br,setItem:Sr,removeItem:wr,clear:Tr,length:kr,key:xr,keys:Cr,dropInstance:Nr};function _r(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function Nn(a,d){var s=a.name+"/";return a.storeName!==d.storeName&&(s+=a.storeName+"/"),s}function Dr(){var a="_localforage_support_test";try{return localStorage.setItem(a,!0),localStorage.removeItem(a),!1}catch{return!0}}function Lr(){return!Dr()||localStorage.length>0}function Mr(a){var d=this,s={};if(a)for(var p in a)s[p]=a[p];return s.keyPrefix=Nn(a,d._defaultConfig),Lr()?(d._dbInfo=s,s.serializer=Bt,h.resolve()):h.reject()}function Or(a){var d=this,s=d.ready().then(function(){for(var p=d._dbInfo.keyPrefix,b=localStorage.length-1;b>=0;b--){var m=localStorage.key(b);m.indexOf(p)===0&&localStorage.removeItem(m)}});return c(s,a),s}function Pr(a,d){var s=this;a=T(a);var p=s.ready().then(function(){var b=s._dbInfo,m=localStorage.getItem(b.keyPrefix+a);return m&&(m=b.serializer.deserialize(m)),m});return c(p,d),p}function jr(a,d){var s=this,p=s.ready().then(function(){for(var b=s._dbInfo,m=b.keyPrefix,x=m.length,A=localStorage.length,M=1,O=0;O<A;O++){var P=localStorage.key(O);if(P.indexOf(m)===0){var z=localStorage.getItem(P);if(z&&(z=b.serializer.deserialize(z)),z=a(z,P.substring(x),M++),z!==void 0)return z}}});return c(p,d),p}function Br(a,d){var s=this,p=s.ready().then(function(){var b=s._dbInfo,m;try{m=localStorage.key(a)}catch{m=null}return m&&(m=m.substring(b.keyPrefix.length)),m});return c(p,d),p}function Rr(a){var d=this,s=d.ready().then(function(){for(var p=d._dbInfo,b=localStorage.length,m=[],x=0;x<b;x++){var A=localStorage.key(x);A.indexOf(p.keyPrefix)===0&&m.push(A.substring(p.keyPrefix.length))}return m});return c(s,a),s}function Ur(a){var d=this,s=d.keys().then(function(p){return p.length});return c(s,a),s}function $r(a,d){var s=this;a=T(a);var p=s.ready().then(function(){var b=s._dbInfo;localStorage.removeItem(b.keyPrefix+a)});return c(p,d),p}function Fr(a,d,s){var p=this;a=T(a);var b=p.ready().then(function(){d===void 0&&(d=null);var m=d;return new h(function(x,A){var M=p._dbInfo;M.serializer.serialize(d,function(O,P){if(P)A(P);else try{localStorage.setItem(M.keyPrefix+a,O),x(m)}catch(z){(z.name==="QuotaExceededError"||z.name==="NS_ERROR_DOM_QUOTA_REACHED")&&A(z),A(z)}})})});return c(b,s),b}function Wr(a,d){if(d=S.apply(this,arguments),a=typeof a!="function"&&a||{},!a.name){var s=this.config();a.name=a.name||s.name,a.storeName=a.storeName||s.storeName}var p=this,b;return a.name?b=new h(function(m){a.storeName?m(Nn(a,p._defaultConfig)):m(a.name+"/")}).then(function(m){for(var x=localStorage.length-1;x>=0;x--){var A=localStorage.key(x);A.indexOf(m)===0&&localStorage.removeItem(A)}}):b=h.reject("Invalid arguments"),c(b,d),b}var Vr={_driver:"localStorageWrapper",_initStorage:Mr,_support:_r(),iterate:jr,getItem:Pr,setItem:Fr,removeItem:$r,clear:Or,length:Ur,key:Br,keys:Rr,dropInstance:Wr},zr=function(d,s){return d===s||typeof d=="number"&&typeof s=="number"&&isNaN(d)&&isNaN(s)},Yr=function(d,s){for(var p=d.length,b=0;b<p;){if(zr(d[b],s))return!0;b++}return!1},An=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},Je={},_n={},ze={INDEXEDDB:Ve,WEBSQL:Ar,LOCALSTORAGE:Vr},qr=[ze.INDEXEDDB._driver,ze.WEBSQL._driver,ze.LOCALSTORAGE._driver],ut=["dropInstance"],Rt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(ut),Hr={description:"",driver:qr.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Gr(a,d){a[d]=function(){var s=arguments;return a.ready().then(function(){return a[d].apply(a,s)})}}function Ut(){for(var a=1;a<arguments.length;a++){var d=arguments[a];if(d)for(var s in d)d.hasOwnProperty(s)&&(An(d[s])?arguments[0][s]=d[s].slice():arguments[0][s]=d[s])}return arguments[0]}var Kr=function(){function a(d){l(this,a);for(var s in ze)if(ze.hasOwnProperty(s)){var p=ze[s],b=p._driver;this[s]=b,Je[b]||this.defineDriver(p)}this._defaultConfig=Ut({},Hr),this._config=Ut({},this._defaultConfig,d),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return a.prototype.config=function(s){if((typeof s>"u"?"undefined":t(s))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var p in s){if(p==="storeName"&&(s[p]=s[p].replace(/\W/g,"_")),p==="version"&&typeof s[p]!="number")return new Error("Database version must be a number.");this._config[p]=s[p]}return"driver"in s&&s.driver?this.setDriver(this._config.driver):!0}else return typeof s=="string"?this._config[s]:this._config},a.prototype.defineDriver=function(s,p,b){var m=new h(function(x,A){try{var M=s._driver,O=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!s._driver){A(O);return}for(var P=Rt.concat("_initStorage"),z=0,Z=P.length;z<Z;z++){var oe=P[z],se=!Yr(ut,oe);if((se||s[oe])&&typeof s[oe]!="function"){A(O);return}}var ve=function(){for(var Qe=function(Qr){return function(){var Zr=new Error("Method "+Qr+" is not implemented by the current driver"),Dn=h.reject(Zr);return c(Dn,arguments[arguments.length-1]),Dn}},$t=0,Jr=ut.length;$t<Jr;$t++){var Ft=ut[$t];s[Ft]||(s[Ft]=Qe(Ft))}};ve();var me=function(Qe){Je[M]&&console.info("Redefining LocalForage driver: "+M),Je[M]=s,_n[M]=Qe,x()};"_support"in s?s._support&&typeof s._support=="function"?s._support().then(me,A):me(!!s._support):me(!0)}catch(Ce){A(Ce)}});return E(m,p,b),m},a.prototype.driver=function(){return this._driver||null},a.prototype.getDriver=function(s,p,b){var m=Je[s]?h.resolve(Je[s]):h.reject(new Error("Driver not found."));return E(m,p,b),m},a.prototype.getSerializer=function(s){var p=h.resolve(Bt);return E(p,s),p},a.prototype.ready=function(s){var p=this,b=p._driverSet.then(function(){return p._ready===null&&(p._ready=p._initDriver()),p._ready});return E(b,s,s),b},a.prototype.setDriver=function(s,p,b){var m=this;An(s)||(s=[s]);var x=this._getSupportedDrivers(s);function A(){m._config.driver=m.driver()}function M(z){return m._extend(z),A(),m._ready=m._initStorage(m._config),m._ready}function O(z){return function(){var Z=0;function oe(){for(;Z<z.length;){var se=z[Z];return Z++,m._dbInfo=null,m._ready=null,m.getDriver(se).then(M).catch(oe)}A();var ve=new Error("No available storage method found.");return m._driverSet=h.reject(ve),m._driverSet}return oe()}}var P=this._driverSet!==null?this._driverSet.catch(function(){return h.resolve()}):h.resolve();return this._driverSet=P.then(function(){var z=x[0];return m._dbInfo=null,m._ready=null,m.getDriver(z).then(function(Z){m._driver=Z._driver,A(),m._wrapLibraryMethodsWithReady(),m._initDriver=O(x)})}).catch(function(){A();var z=new Error("No available storage method found.");return m._driverSet=h.reject(z),m._driverSet}),E(this._driverSet,p,b),this._driverSet},a.prototype.supports=function(s){return!!_n[s]},a.prototype._extend=function(s){Ut(this,s)},a.prototype._getSupportedDrivers=function(s){for(var p=[],b=0,m=s.length;b<m;b++){var x=s[b];this.supports(x)&&p.push(x)}return p},a.prototype._wrapLibraryMethodsWithReady=function(){for(var s=0,p=Rt.length;s<p;s++)Gr(this,Rt[s])},a.prototype.createInstance=function(s){return new a(s)},a}(),Xr=new Kr;o.exports=Xr},{3:3}]},{},[4])(4)})})(Yn);var na=Yn.exports;const Xt=ta(na);function ft(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function Wt(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const ra=1,aa=1,We="emoji",Ke="keyvalue",sn="favorites",oa="tokens",qn="tokens",sa="unicode",Hn="count",ia="group",ca="order",Gn="group-order",Jt="eTag",bt="url",Mn="skinTone",Xe="readonly",cn="readwrite",Kn="skinUnicodes",la="skinUnicodes",ua="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",da="en";function fa(n,e){const r=new Set,o=[];for(const i of n){const t=e(i);r.has(t)||(r.add(t),o.push(i))}return o}function On(n){return fa(n,e=>e.unicode)}function ha(n){function e(r,o,i){const t=o?n.createObjectStore(r,{keyPath:o}):n.createObjectStore(r);if(i)for(const[l,[v,f]]of Object.entries(i))t.createIndex(l,v,{multiEntry:f});return t}e(Ke),e(We,sa,{[qn]:[oa,!0],[Gn]:[[ia,ca]],[Kn]:[la,!0]}),e(sn,void 0,{[Hn]:[""]})}const Qt={},pt={},Et={};function Xn(n,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>n(r.result)}async function ma(n){const e=await new Promise((r,o)=>{const i=indexedDB.open(n,ra);Qt[n]=i,i.onupgradeneeded=t=>{t.oldVersion<aa&&ha(i.result)},Xn(r,o,i)});return e.onclose=()=>ln(n),e}function pa(n){return pt[n]||(pt[n]=ma(n)),pt[n]}function Le(n,e,r,o){return new Promise((i,t)=>{const l=n.transaction(e,r,{durability:"relaxed"}),v=typeof e=="string"?l.objectStore(e):e.map(u=>l.objectStore(u));let f;o(v,l,u=>{f=u}),l.oncomplete=()=>i(f),l.onerror=()=>t(l.error)})}function ln(n){const e=Qt[n],r=e&&e.result;if(r){r.close();const o=Et[n];if(o)for(const i of o)i()}delete Qt[n],delete pt[n],delete Et[n]}function va(n){return new Promise((e,r)=>{ln(n);const o=indexedDB.deleteDatabase(n);Xn(e,r,o)})}function ga(n,e){let r=Et[n];r||(r=Et[n]=[]),r.push(e)}const ya=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function Ye(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||ya.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const ba=2;function Jn(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=ba)}function Ea(n){return n.map(({annotation:r,emoticon:o,group:i,order:t,shortcodes:l,skins:v,tags:f,emoji:u,version:y})=>{const h=[...new Set(Jn([...(l||[]).map(Ye).flat(),...f.map(Ye).flat(),...Ye(r),o]))].sort(),c={annotation:r,group:i,order:t,tags:f,tokens:h,unicode:u,version:y};if(o&&(c.emoticon=o),l&&(c.shortcodes=l),v){c.skinTones=[],c.skinUnicodes=[],c.skinVersions=[];for(const{tone:E,emoji:T,version:S}of v)c.skinTones.push(E),c.skinUnicodes.push(T),c.skinVersions.push(S)}return c})}function Qn(n,e,r,o){n[e](r).onsuccess=i=>o&&o(i.target.result)}function Fe(n,e,r){Qn(n,"get",e,r)}function Zn(n,e,r){Qn(n,"getAll",e,r)}function un(n){n.commit&&n.commit()}function Sa(n,e){let r=n[0];for(let o=1;o<n.length;o++){const i=n[o];e(r)>e(i)&&(r=i)}return r}function er(n,e){const r=Sa(n,i=>i.length),o=[];for(const i of r)n.some(t=>t.findIndex(l=>e(l)===e(i))===-1)||o.push(i);return o}async function wa(n){return!await dn(n,Ke,bt)}async function Ta(n,e,r){const[o,i]=await Promise.all([Jt,bt].map(t=>dn(n,Ke,t)));return o===r&&i===e}async function ka(n,e){return Le(n,We,Xe,(o,i,t)=>{let l;const v=()=>{o.getAll(l&&IDBKeyRange.lowerBound(l,!0),50).onsuccess=f=>{const u=f.target.result;for(const y of u)if(l=y.unicode,e(y))return t(y);if(u.length<50)return t();v()}};v()})}async function tr(n,e,r,o){try{const i=Ea(e);await Le(n,[We,Ke],cn,([t,l],v)=>{let f,u,y=0;function h(){++y===2&&c()}function c(){if(!(f===o&&u===r)){t.clear();for(const E of i)t.put(E);l.put(o,Jt),l.put(r,bt),un(v)}}Fe(l,Jt,E=>{f=E,h()}),Fe(l,bt,E=>{u=E,h()})})}finally{}}async function xa(n,e){return Le(n,We,Xe,(r,o,i)=>{const t=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);Zn(r.index(Gn),t,i)})}async function nr(n,e){const r=Jn(Ye(e));return r.length?Le(n,We,Xe,(o,i,t)=>{const l=[],v=()=>{l.length===r.length&&f()},f=()=>{const u=er(l,y=>y.unicode);t(u.sort((y,h)=>y.order<h.order?-1:1))};for(let u=0;u<r.length;u++){const y=r[u],h=u===r.length-1?IDBKeyRange.bound(y,y+"￿",!1,!0):IDBKeyRange.only(y);Zn(o.index(qn),h,c=>{l.push(c),v()})}}):[]}async function Ca(n,e){const r=await nr(n,e);return r.length?r.filter(o=>(o.shortcodes||[]).map(t=>t.toLowerCase()).includes(e.toLowerCase()))[0]||null:await ka(n,i=>(i.shortcodes||[]).includes(e.toLowerCase()))||null}async function Ia(n,e){return Le(n,We,Xe,(r,o,i)=>Fe(r,e,t=>{if(t)return i(t);Fe(r.index(Kn),e,l=>i(l||null))}))}function dn(n,e,r){return Le(n,e,Xe,(o,i,t)=>Fe(o,r,t))}function Na(n,e,r,o){return Le(n,e,cn,(i,t)=>{i.put(o,r),un(t)})}function Aa(n,e){return Le(n,sn,cn,(r,o)=>Fe(r,e,i=>{r.put((i||0)+1,e),un(o)}))}function _a(n,e,r){return r===0?[]:Le(n,[sn,We],Xe,([o,i],t,l)=>{const v=[];o.index(Hn).openCursor(void 0,"prev").onsuccess=f=>{const u=f.target.result;if(!u)return l(v);function y(E){if(v.push(E),v.length===r)return l(v);u.continue()}const h=u.primaryKey,c=e.byName(h);if(c)return y(c);Fe(i,h,E=>{if(E)return y(E);u.continue()})}})}const ht="";function Da(n,e){const r=new Map;for(const i of n){const t=e(i);for(const l of t){let v=r;for(let u=0;u<l.length;u++){const y=l.charAt(u);let h=v.get(y);h||(h=new Map,v.set(y,h)),v=h}let f=v.get(ht);f||(f=[],v.set(ht,f)),f.push(i)}}return(i,t)=>{let l=r;for(let u=0;u<i.length;u++){const y=i.charAt(u),h=l.get(y);if(h)l=h;else return[]}if(t)return l.get(ht)||[];const v=[],f=[l];for(;f.length;){const y=[...f.shift().entries()].sort((h,c)=>h[0]<c[0]?-1:1);for(const[h,c]of y)h===ht?v.push(...c):f.push(c)}return v}}const La=["name","url"];function Ma(n){const e=n&&Array.isArray(n),r=e&&n.length&&(!n[0]||La.some(o=>!(o in n[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function Pn(n){Ma(n);const e=(c,E)=>c.name.toLowerCase()<E.name.toLowerCase()?-1:1,r=n.sort(e),i=Da(n,c=>[...new Set((c.shortcodes||[]).map(E=>Ye(E)).flat())]),t=c=>i(c,!0),l=c=>i(c,!1),v=c=>{const E=Ye(c),T=E.map((S,g)=>(g<E.length-1?t:l)(S));return er(T,S=>S.name).sort(e)},f=new Map,u=new Map;for(const c of n){u.set(c.name.toLowerCase(),c);for(const E of c.shortcodes||[])f.set(E.toLowerCase(),c)}return{all:r,search:v,byShortcode:c=>f.get(c.toLowerCase()),byName:c=>u.get(c.toLowerCase())}}const Oa=typeof wrappedJSObject<"u";function Ze(n){if(!n)return n;if(Oa&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let r=0;r<e;r++)n.skins[r]={tone:n.skinTones[r],unicode:n.skinUnicodes[r],version:n.skinVersions[r]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function rr(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const Pa=["annotation","emoji","group","order","tags","version"];function ja(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||Pa.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function ar(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function Ba(n){const e=await fetch(n,{method:"HEAD"});ar(e,n);const r=e.headers.get("etag");return rr(r),r}async function Zt(n){const e=await fetch(n);ar(e,n);const r=e.headers.get("etag");rr(r);const o=await e.json();return ja(o),[r,o]}function Ra(n){for(var e="",r=new Uint8Array(n),o=r.byteLength,i=-1;++i<o;)e+=String.fromCharCode(r[i]);return e}function Ua(n){for(var e=n.length,r=new ArrayBuffer(e),o=new Uint8Array(r),i=-1;++i<e;)o[i]=n.charCodeAt(i);return r}async function or(n){const e=JSON.stringify(n);let r=Ua(e);const o=await crypto.subtle.digest("SHA-1",r),i=Ra(o);return btoa(i)}async function $a(n,e){let r,o=await Ba(e);if(!o){const i=await Zt(e);o=i[0],r=i[1],o||(o=await or(r))}await Ta(n,e,o)||(r||(r=(await Zt(e))[1]),await tr(n,r,e,o))}async function Fa(n,e){let[r,o]=await Zt(e);r||(r=await or(o)),await tr(n,o,e,r)}class Wa{constructor({dataSource:e=ua,locale:r=da,customEmoji:o=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=Pn(o),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await pa(this._dbName);ga(this._dbName,this._clear);const r=this.dataSource;await wa(e)?await Fa(e,r):this._lazyUpdate=$a(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return Wt(e),await this.ready(),On(await xa(this._db,e)).map(Ze)}async getEmojiBySearchQuery(e){ft(e),await this.ready();const r=this._custom.search(e),o=On(await nr(this._db,e)).map(Ze);return[...r,...o]}async getEmojiByShortcode(e){ft(e),await this.ready();const r=this._custom.byShortcode(e);return r||Ze(await Ca(this._db,e))}async getEmojiByUnicodeOrName(e){ft(e),await this.ready();const r=this._custom.byName(e);return r||Ze(await Ia(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await dn(this._db,Ke,Mn)||0}async setPreferredSkinTone(e){return Wt(e),await this.ready(),Na(this._db,Ke,Mn,e)}async incrementFavoriteEmojiCount(e){return ft(e),await this.ready(),Aa(this._db,e)}async getTopFavoriteEmoji(e){return Wt(e),await this.ready(),(await _a(this._db,this._custom,e)).map(Ze)}set customEmoji(e){this._custom=Pn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await ln(this._dbName)}async delete(){await this._shutdown(),await va(this._dbName)}}const en=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([n,e,r])=>({id:n,emoji:e,name:r})),Vt=en.slice(1),Va=2,jn=6,sr=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function Bn(n){return n.unicode.includes("‍")}const za={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},Ya=1e3,qa="🖐️",Ha=8,Ga=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],ir='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',Ka=(n,e)=>n<e?-1:n>e?1:0,Rn=(n,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const o=r.getContext("2d");return o.textBaseline="top",o.font=`100px ${ir}`,o.fillStyle=e,o.scale(.01,.01),o.fillText(n,0,0),o.getImageData(0,0,1,1).data},Xa=(n,e)=>{const r=[...n].join(","),o=[...e].join(",");return r===o&&!r.startsWith("0,0,0,")};function Ja(n){const e=Rn(n,"#000"),r=Rn(n,"#fff");return e&&r&&Xa(e,r)}function Qa(){const n=Object.entries(za);try{for(const[e,r]of n)if(Ja(e))return r}catch{}finally{}return n[0][1]}let zt;const Yt=()=>(zt||(zt=new Promise(n=>sr(()=>n(Qa())))),zt),tn=new Map,Za="️",eo="\uD83C",to="‍",no=127995,ro=57339;function ao(n,e){if(e===0)return n;const r=n.indexOf(to);return r!==-1?n.substring(0,r)+String.fromCodePoint(no+e-1)+n.substring(r):(n.endsWith(Za)&&(n=n.substring(0,n.length-1)),n+eo+String.fromCodePoint(ro+e-1))}function Ae(n){n.preventDefault(),n.stopPropagation()}function qt(n,e,r){return e+=n?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function cr(n,e){const r=new Set,o=[];for(const i of n){const t=e(i);r.has(t)||(r.add(t),o.push(i))}return o}function oo(n,e){const r=o=>{const i={};for(const t of o)typeof t.tone=="number"&&t.version<=e&&(i[t.tone]=t.unicode);return i};return n.map(({unicode:o,skins:i,shortcodes:t,url:l,name:v,category:f,annotation:u})=>({unicode:o,name:v,shortcodes:t,url:l,category:f,annotation:u,id:o||v,skins:i&&r(i)}))}const vt=requestAnimationFrame;let so=typeof ResizeObserver=="function";function io(n,e,r){let o;so?(o=new ResizeObserver(i=>r(i[0].contentRect.width)),o.observe(n)):vt(()=>r(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{o&&o.disconnect()})}function Un(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let Ht;function co(n,e,r){for(const o of n){const i=r(o),t=Un(i);typeof Ht>"u"&&(Ht=Un(e));const l=t/1.8<Ht;tn.set(o.unicode,l)}}function lo(n){return cr(n,e=>e)}function uo(n){n&&(n.scrollTop=0)}function nt(n,e,r){let o=n.get(e);return o||(o=r(),n.set(e,o)),o}function $n(n){return""+n}function fo(n){const e=document.createElement("template");return e.innerHTML=n,e}const ho=new WeakMap,mo=new WeakMap,po=Symbol("un-keyed"),vo="replaceChildren"in Element.prototype;function go(n,e){vo?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function yo(n,e){let r=n.firstChild,o=0;for(;r;){if(e[o]!==r)return!0;r=r.nextSibling,o++}return o!==e.length}function bo(n,e){const{targetNode:r}=e;let{targetParentNode:o}=e,i=!1;o?i=yo(o,n):(i=!0,e.targetNode=void 0,e.targetParentNode=o=r.parentNode),i&&go(o,n)}function Eo(n,e){for(const r of e){const{targetNode:o,currentExpression:i,binding:{expressionIndex:t,attributeName:l,attributeValuePre:v,attributeValuePost:f}}=r,u=n[t];if(i!==u)if(r.currentExpression=u,l)o.setAttribute(l,v+$n(u)+f);else{let y;Array.isArray(u)?bo(u,r):u instanceof Element?(y=u,o.replaceWith(y)):o.nodeValue=$n(u),y&&(r.targetNode=y)}}}function So(n){let e="",r=!1,o=!1,i=-1;const t=new Map,l=[];for(let f=0,u=n.length;f<u;f++){const y=n[f];if(e+=y,f===u-1)break;for(let D=0;D<y.length;D++)switch(y.charAt(D)){case"<":{y.charAt(D+1)==="/"?l.pop():(r=!0,l.push(++i));break}case">":{r=!1,o=!1;break}case"=":{o=!0;break}}const h=l[l.length-1],c=nt(t,h,()=>[]);let E,T,S;if(o){const D=/(\S+)="?([^"=]*)$/.exec(y);E=D[1],T=D[2],S=/^[^">]*/.exec(n[f+1])[0]}const g={attributeName:E,attributeValuePre:T,attributeValuePost:S,expressionIndex:f};c.push(g),!r&&!o&&(e+=" ")}return{template:fo(e),elementsToBindings:t}}function wo(n,e){const r=[],o=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let i=n,t=-1;do{const l=e.get(++t);if(l)for(let v=0;v<l.length;v++){const f=l[v],u=f.attributeName?i:i.firstChild,y={binding:f,targetNode:u,targetParentNode:void 0,currentExpression:void 0};r.push(y)}}while(i=o.nextNode());return r}function To(n){const{template:e,elementsToBindings:r}=nt(ho,n,()=>So(n)),o=e.cloneNode(!0).content.firstElementChild,i=wo(o,r);return function(l){return Eo(l,i),o}}function ko(n){const e=nt(mo,n,()=>new Map);let r=po;function o(t,...l){const v=nt(e,t,()=>new Map);return nt(v,r,()=>To(t))(l)}function i(t,l,v){return t.map((f,u)=>{const y=r;r=v(f);try{return l(f,u)}finally{r=y}})}return{map:i,html:o}}function xo(n,e,r,o,i,t,l,v){const{labelWithSkin:f,titleForEmoji:u,unicodeWithSkin:y}=r,{html:h,map:c}=ko(e);function E(g,D,$){return c(g,(N,j)=>h`<button role="${D?"option":"menuitem"}" aria-selected="${e.searchMode?j===e.activeSearchItem:""}" aria-label="${f(N,e.currentSkinTone)}" title="${u(N)}" class="emoji ${D&&j===e.activeSearchItem?"active":""}" id="${`${$}-${N.id}`}">${N.unicode?y(N,e.currentSkinTone):h`<img class="custom-emoji" src="${N.url}" alt="" loading="lazy">`}</button>`,N=>`${$}-${N.id}`)}const S=h`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${c(e.skinTones,(g,D)=>h`<div id="skintone-${D}" class="emoji ${D===e.activeSkinTone?"active":""}" aria-selected="${D===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[D]}" aria-label="${e.i18n.skinTones[D]}">${g}</div>`,g=>g)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${c(e.groups,g=>h`<button role="tab" class="nav-button" aria-controls="tab-${g.id}" aria-label="${e.i18n.categories[g.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===g.id}" title="${e.i18n.categories[g.name]}" data-group-id="${g.id}"><div class="nav-emoji emoji">${g.emoji}</div></button>`,g=>g.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${c(e.currentEmojisWithCategories,(g,D)=>h`<div><div id="menu-label-${D}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:g.category?g.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${D}" id="${e.searchMode?"search-results":""}">${E(g.emojis,e.searchMode,"emo")}</div></div>`,g=>g.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${E(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(v){n.appendChild(S);const g=(D,$)=>{for(const N of n.querySelectorAll(`[${D}]`))$(N,N.getAttribute(D))};for(const D of["click","focusout","input","keydown","keyup"])g(`data-on-${D}`,($,N)=>{$.addEventListener(D,o[N])});g("data-ref",(D,$)=>{t[$]=D}),g("data-action",(D,$)=>{i[$](D)}),l.addEventListener("abort",()=>{n.removeChild(S)})}}const St=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function Co(n){let e=!1,r;const o=new Map,i=new Set;let t;const l=()=>{if(e)return;const u=[...i];i.clear();try{for(const y of u)y()}finally{t=!1,i.size&&(t=!0,St(l))}},v=new Proxy({},{get(u,y){if(r){let h=o.get(y);h||(h=new Set,o.set(y,h)),h.add(r)}return u[y]},set(u,y,h){u[y]=h;const c=o.get(y);if(c){for(const E of c)i.add(E);t||(t=!0,St(l))}return!0}}),f=u=>{const y=()=>{const h=r;r=y;try{return u()}finally{r=h}};return y()};return n.addEventListener("abort",()=>{e=!0}),{state:v,createEffect:f}}function Gt(n,e,r){if(n.length!==e.length)return!1;for(let o=0;o<n.length;o++)if(!r(n[o],e[o]))return!1;return!0}const Kt=[],{assign:mt}=Object;function Io(n,e){const r={},o=new AbortController,i=o.signal,{state:t,createEffect:l}=Co(i);mt(t,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),mt(t,e),mt(t,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:Ha,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:Vt,databaseLoaded:!1,activeSearchItemId:void 0}),l(()=>{t.currentGroup!==t.groups[t.currentGroupIndex]&&(t.currentGroup=t.groups[t.currentGroupIndex])});const v=k=>{n.getElementById(k).focus()},f=k=>n.getElementById(`emo-${k.id}`),u=(k,W)=>{r.rootElement.dispatchEvent(new CustomEvent(k,{detail:W,bubbles:!0,composed:!0}))},y=(k,W)=>k.id===W.id,h=(k,W)=>{const{category:G,emojis:K}=k,{category:ae,emojis:ne}=W;return G!==ae?!1:Gt(K,ne,y)},c=k=>{Gt(t.currentEmojis,k,y)||(t.currentEmojis=k)},E=k=>{t.searchMode!==k&&(t.searchMode=k)},T=k=>{Gt(t.currentEmojisWithCategories,k,h)||(t.currentEmojisWithCategories=k)},S=(k,W)=>W&&k.skins&&k.skins[W]||k.unicode,$={labelWithSkin:(k,W)=>lo([k.name||S(k,W),k.annotation,...k.shortcodes||Kt].filter(Boolean)).join(", "),titleForEmoji:k=>k.annotation||(k.shortcodes||Kt).join(", "),unicodeWithSkin:S},N={onClickSkinToneButton:X,onEmojiClick:V,onNavClick:w,onNavKeydown:B,onSearchKeydown:L,onSkinToneOptionsClick:Y,onSkinToneOptionsFocusOut:Se,onSkinToneOptionsKeydown:ee,onSkinToneOptionsKeyup:he,onSearchInput:Ne},j={calculateEmojiGridStyle:F};let C=!0;l(()=>{xo(n,t,$,N,j,r,i,C),C=!1}),t.emojiVersion||Yt().then(k=>{k||(t.message=t.i18n.emojiUnsupportedMessage)}),l(()=>{async function k(){let W=!1;const G=setTimeout(()=>{W=!0,t.message=t.i18n.loadingMessage},Ya);try{await t.database.ready(),t.databaseLoaded=!0}catch(K){console.error(K),t.message=t.i18n.networkErrorMessage}finally{clearTimeout(G),W&&(W=!1,t.message="")}}t.database&&k()}),l(()=>{t.pickerStyle=`
      --num-groups: ${t.groups.length}; 
      --indicator-opacity: ${t.searchMode?0:1}; 
      --num-skintones: ${jn};`}),l(()=>{t.customEmoji&&t.database&&U()}),l(()=>{t.customEmoji&&t.customEmoji.length?t.groups!==en&&(t.groups=en):t.groups!==Vt&&(t.currentGroupIndex&&t.currentGroupIndex--,t.groups=Vt)}),l(()=>{async function k(){t.databaseLoaded&&(t.currentSkinTone=await t.database.getPreferredSkinTone())}k()}),l(()=>{t.skinTones=Array(jn).fill().map((k,W)=>ao(t.skinToneEmoji,W))}),l(()=>{t.skinToneButtonText=t.skinTones[t.currentSkinTone]}),l(()=>{t.skinToneButtonLabel=t.i18n.skinToneLabel.replace("{skinTone}",t.i18n.skinTones[t.currentSkinTone])}),l(()=>{async function k(){const{database:W}=t,G=(await Promise.all(Ga.map(K=>W.getEmojiByUnicodeOrName(K)))).filter(Boolean);t.defaultFavoriteEmojis=G}t.databaseLoaded&&k()});function U(){t.database.customEmoji=t.customEmoji||Kt}l(()=>{async function k(){U();const{database:W,defaultFavoriteEmojis:G,numColumns:K}=t,ae=await W.getTopFavoriteEmoji(K),ne=await te(cr([...ae,...G],be=>be.unicode||be.name).slice(0,K));t.currentFavorites=ne}t.databaseLoaded&&t.defaultFavoriteEmojis&&k()});function F(k){io(k,i,W=>{{const G=getComputedStyle(r.rootElement),K=parseInt(G.getPropertyValue("--num-columns"),10),ae=G.getPropertyValue("direction")==="rtl",be=k.parentElement.getBoundingClientRect().width-W;t.numColumns=K,t.scrollbarWidth=be,t.isRtl=ae}})}l(()=>{async function k(){const{searchText:W,currentGroup:G,databaseLoaded:K,customEmoji:ae}=t;if(!K)t.currentEmojis=[],t.searchMode=!1;else if(W.length>=Va){const ne=await Ee(W);t.searchText===W&&(c(ne),E(!0))}else{const{id:ne}=G;if(ne!==-1||ae&&ae.length){const be=await fe(ne);t.currentGroup.id===ne&&(c(be),E(!1))}}}k()}),l(()=>{const{currentEmojis:k,emojiVersion:W}=t,G=k.filter(K=>K.unicode).filter(K=>Bn(K)&&!tn.has(K.unicode));if(!W&&G.length)c(k),vt(()=>q(G));else{const K=W?k:k.filter(de);c(K),vt(()=>uo(r.tabpanelElement))}});function q(k){co(k,r.baselineEmoji,f),t.currentEmojis=t.currentEmojis}function de(k){return!k.unicode||!Bn(k)||tn.get(k.unicode)}async function ie(k){const W=t.emojiVersion||await Yt();return k.filter(({version:G})=>!G||G<=W)}async function te(k){return oo(k,t.emojiVersion||await Yt())}async function fe(k){const W=k===-1?t.customEmoji:await t.database.getEmojiByGroup(k);return te(await ie(W))}async function Ee(k){return te(await ie(await t.database.getEmojiBySearchQuery(k)))}l(()=>{}),l(()=>{function k(){const{searchMode:G,currentEmojis:K}=t;if(G)return[{category:"",emojis:K}];const ae=new Map;for(const ne of K){const be=ne.category||"";let Ve=ae.get(be);Ve||(Ve=[],ae.set(be,Ve)),Ve.push(ne)}return[...ae.entries()].map(([ne,be])=>({category:ne,emojis:be})).sort((ne,be)=>t.customCategorySorting(ne.category,be.category))}const W=k();T(W)}),l(()=>{t.activeSearchItemId=t.activeSearchItem!==-1&&t.currentEmojis[t.activeSearchItem].id}),l(()=>{const{rawSearchText:k}=t;sr(()=>{t.searchText=(k||"").trim(),t.activeSearchItem=-1})});function L(k){if(!t.searchMode||!t.currentEmojis.length)return;const W=G=>{Ae(k),t.activeSearchItem=qt(G,t.activeSearchItem,t.currentEmojis)};switch(k.key){case"ArrowDown":return W(!1);case"ArrowUp":return W(!0);case"Enter":if(t.activeSearchItem===-1)t.activeSearchItem=0;else return Ae(k),_(t.currentEmojis[t.activeSearchItem].id)}}function w(k){const{target:W}=k,G=W.closest(".nav-button");if(!G)return;const K=parseInt(G.dataset.groupId,10);r.searchElement.value="",t.rawSearchText="",t.searchText="",t.activeSearchItem=-1,t.currentGroupIndex=t.groups.findIndex(ae=>ae.id===K)}function B(k){const{target:W,key:G}=k,K=ae=>{ae&&(Ae(k),ae.focus())};switch(G){case"ArrowLeft":return K(W.previousElementSibling);case"ArrowRight":return K(W.nextElementSibling);case"Home":return K(W.parentElement.firstElementChild);case"End":return K(W.parentElement.lastElementChild)}}async function _(k){const W=await t.database.getEmojiByUnicodeOrName(k),G=[...t.currentEmojis,...t.currentFavorites].find(ae=>ae.id===k),K=G.unicode&&S(G,t.currentSkinTone);await t.database.incrementFavoriteEmojiCount(k),u("emoji-click",{emoji:W,skinTone:t.currentSkinTone,...K&&{unicode:K},...G.name&&{name:G.name}})}async function V(k){const{target:W}=k;if(!W.classList.contains("emoji"))return;Ae(k);const G=W.id.substring(4);_(G)}function H(k){t.currentSkinTone=k,t.skinTonePickerExpanded=!1,v("skintone-button"),u("skin-tone-change",{skinTone:k}),t.database.setPreferredSkinTone(k)}function Y(k){const{target:{id:W}}=k,G=W&&W.match(/^skintone-(\d)/);if(!G)return;Ae(k);const K=parseInt(G[1],10);H(K)}function X(k){t.skinTonePickerExpanded=!t.skinTonePickerExpanded,t.activeSkinTone=t.currentSkinTone,t.skinTonePickerExpanded&&(Ae(k),vt(()=>v("skintone-list")))}l(()=>{t.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{t.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):t.skinTonePickerExpandedAfterAnimation=!1});function ee(k){if(!t.skinTonePickerExpanded)return;const W=async G=>{Ae(k),t.activeSkinTone=G};switch(k.key){case"ArrowUp":return W(qt(!0,t.activeSkinTone,t.skinTones));case"ArrowDown":return W(qt(!1,t.activeSkinTone,t.skinTones));case"Home":return W(0);case"End":return W(t.skinTones.length-1);case"Enter":return Ae(k),H(t.activeSkinTone);case"Escape":return Ae(k),t.skinTonePickerExpanded=!1,v("skintone-button")}}function he(k){if(t.skinTonePickerExpanded)switch(k.key){case" ":return Ae(k),H(t.activeSkinTone)}}async function Se(k){const{relatedTarget:W}=k;(!W||W.id!=="skintone-list")&&(t.skinTonePickerExpanded=!1)}function Ne(k){t.rawSearchText=k.target.value}return{$set(k){mt(t,k)},$destroy(){o.abort()}}}const No="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Ao="en";var _o={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Do=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const lr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],Lo=`:host{--emoji-font-family:${ir}}`;class fn extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=Do+Lo,this.shadowRoot.appendChild(r),this._ctx={locale:Ao,dataSource:No,skinToneEmoji:qa,customCategorySorting:Ka,customEmoji:null,i18n:_o,emojiVersion:null,...e};for(const o of lr)o!=="database"&&Object.prototype.hasOwnProperty.call(this,o)&&(this._ctx[o]=this[o],delete this[o]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Io(this.shadowRoot,this._ctx))}disconnectedCallback(){St(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,o){this._set(e.replace(/-([a-z])/g,(i,t)=>t.toUpperCase()),e==="emoji-version"?parseFloat(o):o)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:o}=this._ctx;(!o||o.locale!==e||o.dataSource!==r)&&this._set("database",new Wa({locale:e,dataSource:r}))}_dbFlush(){St(()=>this._dbCreate())}}const ur={};for(const n of lr)ur[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(fn.prototype,ur);customElements.get("emoji-picker")||customElements.define("emoji-picker",fn);var nn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(r,o){o(e)})(et,function(r){var o="dnd-poly-",i=o+"snapback",t="dnd-poly-",l=t+"dragstart-pending",v=t+"dragstart-cancel",f=["none","copy","copyLink","copyMove","link","linkMove","move","all"],u=["none","copy","move","link"],y=function(){var L=!1;try{var w=Object.defineProperty({},"passive",{get:function(){L=!0}});window.addEventListener("test",null,w)}catch{}return L}();function h(L){return L&&L.tagName}function c(L,w,B){B===void 0&&(B=!0),document.addEventListener(L,w,!!y&&{passive:B})}function E(L,w){document.removeEventListener(L,w)}function T(L,w,B,_){_===void 0&&(_=!1);var V=y?{passive:!0,capture:_}:_;return L.addEventListener(w,B,V),{off:function(){L.removeEventListener(w,B,V)}}}function S(L){return L.length===0?0:L.reduce(function(w,B){return B+w},0)/L.length}function g(L,w){for(var B=0;B<L.changedTouches.length;B++)if(L.changedTouches[B].identifier===w)return!0;return!1}function D(L,w,B){for(var _=[],V=[],H=0;H<w.touches.length;H++){var Y=w.touches[H];_.push(Y[L+"X"]),V.push(Y[L+"Y"])}B.x=S(_),B.y=S(V)}var $=["","-webkit-"];function N(L,w,B,_,V){V===void 0&&(V=!0);var H=w.x,Y=w.y;_&&(H+=_.x,Y+=_.y),V&&(H-=parseInt(L.offsetWidth,10)/2,Y-=parseInt(L.offsetHeight,10)/2);for(var X="translate3d("+H+"px,"+Y+"px, 0)",ee=0;ee<$.length;ee++){var he=$[ee]+"transform";L.style[he]=X+" "+B[ee]}}var j=function(){function L(w,B){this.t=w,this.i=B,this.s=u[0]}return Object.defineProperty(L.prototype,"dropEffect",{get:function(){return this.s},set:function(w){this.t.mode!==0&&f.indexOf(w)>-1&&(this.s=w)},enumerable:!0,configurable:!0}),Object.defineProperty(L.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(L.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(w){this.t.mode===2&&f.indexOf(w)>-1&&(this.t.effectAllowed=w)},enumerable:!0,configurable:!0}),L.prototype.setData=function(w,B){if(this.t.mode===2){if(w.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[w]=B,this.t.types.indexOf(w)===-1&&this.t.types.push(w)}},L.prototype.getData=function(w){if(this.t.mode===1||this.t.mode===2)return this.t.data[w]||""},L.prototype.clearData=function(w){if(this.t.mode===2){if(w&&this.t.data[w]){delete this.t.data[w];var B=this.t.types.indexOf(w);return void(B>-1&&this.t.types.splice(B,1))}this.t.data={},this.t.types=[]}},L.prototype.setDragImage=function(w,B,_){this.t.mode===2&&this.i(w,B,_)},L}();function C(L,w){return L?L===f[0]?u[0]:L.indexOf(f[1])===0||L===f[7]?u[1]:L.indexOf(f[4])===0?u[3]:L===f[6]?u[2]:u[1]:w.nodeType===3&&w.tagName==="A"?u[3]:u[1]}function U(L,w,B,_,V,H,Y){H===void 0&&(H=!0),Y===void 0&&(Y=null);var X=function(he,Se,Ne,k,W,G,K){K===void 0&&(K=null);var ae=Se.changedTouches[0],ne=new Event(Ne,{bubbles:!0,cancelable:k});ne.dataTransfer=G,ne.relatedTarget=K,ne.screenX=ae.screenX,ne.screenY=ae.screenY,ne.clientX=ae.clientX,ne.clientY=ae.clientY,ne.pageX=ae.pageX,ne.pageY=ae.pageY;var be=he.getBoundingClientRect();return ne.offsetX=ne.clientX-be.left,ne.offsetY=ne.clientY-be.top,ne}(w,B,L,H,document.defaultView,V,Y),ee=!w.dispatchEvent(X);return _.mode=0,ee}function F(L,w){if(!L||L===f[7])return w;if(w===u[1]){if(L.indexOf(u[1])===0)return u[1]}else if(w===u[3]){if(L.indexOf(u[3])===0||L.indexOf("Link")>-1)return u[3]}else if(w===u[2]&&(L.indexOf(u[2])===0||L.indexOf("Move")>-1))return u[2];return u[0]}var q,de=function(){function L(w,B,_,V){this.h=w,this.o=B,this.u=_,this.l=V,this.v=0,this.p=null,this.g=null,this.m=w,this.I=w.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),c("touchmove",this.j,!1),c("touchend",this.S,!1),c("touchcancel",this.S,!1)}return L.prototype.A=function(){var w=this;this.v=1,this.O=u[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var B=this.u;if(this.N=new j(this.D,function(X,ee,he){B=X,typeof ee!="number"&&typeof he!="number"||(w.P={x:ee||0,y:he||0})}),this.D.mode=2,this.N.dropEffect=u[0],U("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;D("page",this.m,this.F);var _,V=this.o.dragImageSetup(B);if(this.L=(_=V,$.map(function(X){var ee=_.style[X+"transform"];return ee&&ee!=="none"?ee.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),V.style.position="absolute",V.style.left="0px",V.style.top="0px",V.style.zIndex="999999",V.classList.add("dnd-poly-drag-image"),V.classList.add("dnd-poly-icon"),this._=V,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var H=getComputedStyle(B);this.P={x:0-parseInt(H.marginLeft,10),y:0-parseInt(H.marginTop,10)}}else{var Y=B.getBoundingClientRect();H=getComputedStyle(B),this.P={x:Y.left-this.I.clientX-parseInt(H.marginLeft,10)+Y.width/2,y:Y.top-this.I.clientY-parseInt(H.marginTop,10)+Y.height/2}}return N(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){w.X||(w.X=!0,w.Y(),w.X=!1)},this.o.iterationInterval),!0},L.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),E("touchmove",this.j),E("touchend",this.S),E("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},L.prototype.C=function(w){var B=this;if(g(w,this.I.identifier)!==!1){if(this.m=w,this.v===0){var _=void 0;if(this.o.dragStartConditionOverride)try{_=this.o.dragStartConditionOverride(w)}catch{_=!1}else _=w.touches.length===1;return _?void(this.A()===!0&&(this.h.preventDefault(),w.preventDefault())):void this.T()}if(w.preventDefault(),D("client",w,this.M),D("page",w,this.F),this.o.dragImageTranslateOverride)try{var V=!1;if(this.o.dragImageTranslateOverride(w,{x:this.M.x,y:this.M.y},this.p,function(H,Y){B._&&(V=!0,B.M.x+=H,B.M.y+=Y,B.F.x+=H,B.F.y+=Y,N(B._,B.F,B.L,B.P,B.o.dragImageCenterOnTouch))}),V)return}catch{}N(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},L.prototype.k=function(w){if(g(w,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(w.preventDefault(),this.v=w.type==="touchcancel"?3:2):this.T()}},L.prototype.Y=function(){var w=this,B=this.O;this.D.mode=3,this.N.dropEffect=u[0];var _=U("drag",this.u,this.m,this.D,this.N);if(_&&(this.O=u[0]),_||this.v===2||this.v===3)return this.q(this.v)?void function(X,ee,he,Se){var Ne=getComputedStyle(X);if(Ne.visibility!=="hidden"&&Ne.display!=="none"){ee.classList.add(i);var k=getComputedStyle(ee),W=parseFloat(k.transitionDuration);if(isNaN(W)||W===0)Se();else{var G=X.getBoundingClientRect(),K={x:G.left,y:G.top};K.x+=document.body.scrollLeft||document.documentElement.scrollLeft,K.y+=document.body.scrollTop||document.documentElement.scrollTop,K.x-=parseInt(Ne.marginLeft,10),K.y-=parseInt(Ne.marginTop,10);var ae=parseFloat(k.transitionDelay),ne=Math.round(1e3*(W+ae));N(ee,K,he,void 0,!1),setTimeout(Se,ne)}}else Se()}(this.u,this._,this.L,function(){w.B()}):void this.B();var V=this.o.elementFromPoint(this.M.x,this.M.y),H=this.g;V!==this.p&&V!==this.g&&(this.p=V,this.g!==null&&(this.D.mode=3,this.N.dropEffect=u[0],U("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=C(this.D.effectAllowed,this.u),U("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=F(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),H!==this.g&&h(H)&&(this.D.mode=3,this.N.dropEffect=u[0],U("dragleave",H,this.m,this.D,this.N,!1,this.g)),h(this.g)&&(this.D.mode=3,this.N.dropEffect=C(this.D.effectAllowed,this.u),U("dragover",this.g,this.m,this.D,this.N)===!1?this.O=u[0]:this.O=F(this.N.effectAllowed,this.N.dropEffect)),B!==this.O&&this._.classList.remove(o+B);var Y=o+this.O;this._.classList.add(Y)},L.prototype.q=function(w){var B=this.O===u[0]||this.g===null||w===3;return B?h(this.g)&&(this.D.mode=3,this.N.dropEffect=u[0],U("dragleave",this.g,this.m,this.D,this.N,!1)):h(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,U("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=u[0]),B},L.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,U("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},L}(),ie={iterationInterval:150,tryFindDraggableTarget:function(L){var w=L.target;do if(w.draggable!==!1&&(w.draggable===!0||w.getAttribute&&w.getAttribute("draggable")==="true"))return w;while((w=w.parentNode)&&w!==document.body)},dragImageSetup:function(L){var w=L.cloneNode(!0);return function B(_,V){if(_.nodeType===1){for(var H=getComputedStyle(_),Y=0;Y<H.length;Y++){var X=H[Y];V.style.setProperty(X,H.getPropertyValue(X),H.getPropertyPriority(X))}if(V.style.pointerEvents="none",V.removeAttribute("id"),V.removeAttribute("class"),V.removeAttribute("draggable"),V.nodeName==="CANVAS"){var ee=_,he=V,Se=ee.getContext("2d").getImageData(0,0,ee.width,ee.height);he.getContext("2d").putImageData(Se,0,0)}}if(_.hasChildNodes())for(Y=0;Y<_.childNodes.length;Y++)B(_.childNodes[Y],V.childNodes[Y])}(L,w),w},elementFromPoint:function(L,w){return document.elementFromPoint(L,w)}};function te(L){if(!q){var w=ie.tryFindDraggableTarget(L);if(w)try{q=new de(L,ie,w,Ee)}catch(B){throw Ee(ie,L,3),B}}}function fe(L){var w=L.target,B=function(ee){V.off(),H.off(),Y.off(),X.off(),w&&w.dispatchEvent(new CustomEvent(v,{bubbles:!0,cancelable:!0})),clearTimeout(_)};w&&w.dispatchEvent(new CustomEvent(l,{bubbles:!0,cancelable:!0}));var _=window.setTimeout(function(){V.off(),H.off(),Y.off(),X.off(),te(L)},ie.holdToDrag),V=T(w,"touchend",B),H=T(w,"touchcancel",B),Y=T(w,"touchmove",B),X=T(window,"scroll",B,!0)}function Ee(L,w,B){if(B===0&&L.defaultActionOverride)try{L.defaultActionOverride(w),w.defaultPrevented}catch{}q=null}r.polyfill=function(L){if(L&&Object.keys(L).forEach(function(V){ie[V]=L[V]}),!ie.forceApply){var w=(B={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},_=!!window.chrome||/chrome/i.test(navigator.userAgent),B.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||_&&"ontouchstart"in document.documentElement),B);if(w.userAgentSupportingNativeDnD&&w.draggable&&w.dragEvents)return!1}var B,_;return ie.holdToDrag?c("touchstart",fe,!1):c("touchstart",te,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(nn,nn.exports);var Mo=nn.exports;const Oo=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),_e=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},Po=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let Fn;const jo=(n=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),o=()=>{clearTimeout(r),clearTimeout(Fn),Fn=setTimeout(()=>{n.removeEventListener("scroll",o),e()},100)};n.addEventListener("scroll",o)}),Bo="0.6.2 Beta",Ue=document.querySelector(".editor"),ue=document.getElementById("tones"),ge=document.getElementById("action"),ce=document.getElementById("musical-score"),Re=document.getElementById("add-track"),at=document.getElementById("remove-track"),$e=document.getElementById("dialog"),re=document.forms["dialog-form"];re._title=re.querySelector(".form-title");re.inputs=re.querySelector(".inputs");re.buttons=re.querySelector(".buttons");const wt=document.getElementById("play"),Tt=document.getElementById("clear"),Ro=document.getElementById("warn-out"),Uo=document.getElementById("mml"),je=document.getElementById("copy"),Pe=document.getElementById("paste"),kt=document.getElementById("save"),rn=document.getElementById("open"),Lt=document.getElementById("ctrl"),xt=document.getElementById("undo"),Ct=document.getElementById("redo");var st,le,Ie,qe;class $o{constructor(){we(this,st,`#COMMENT Generated by FlMML VisualSequencer ${Bo}`);we(this,le,[]);we(this,Ie,(e,r)=>{});we(this,qe,(e,r)=>{})}set onChange(e){ke(this,Ie,e)}set onError(e){ke(this,qe,e)}setMmlArr(e){ke(this,le,e),R(this,Ie).call(this,this.getMmlArr(),this.getMml())}setMml(e){ke(this,le,e.split(`
`)),R(this,le).at(-2)===""&&R(this,le).at(-1)===R(this,st)&&R(this,le).splice(-2,2),R(this,Ie).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return R(this,le)}getMml(){return R(this,le).length?R(this,le).concat(["",R(this,st)]).join(`
`):""}getMmlLine(e){return R(this,le)[e]}insert(e,r){Object.hasOwn(R(this,le),e)||e===0?(R(this,le).splice(e,0,r),R(this,Ie).call(this,this.getMmlArr(),this.getMml())):R(this,qe).call(this,"範囲外の書き換え指定",`範囲${R(this,le).length-1}までのところ、${e}`)}append(e){R(this,le).push(e),R(this,Ie).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(R(this,le),e)?(R(this,le)[e]+=r,R(this,Ie).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(R(this,le),e)?(R(this,le)[e]=r+R(this,le)[e],R(this,Ie).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(R(this,le),e)?(R(this,le)[e]=r,R(this,Ie).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(R(this,le),e)&&R(this,le).splice(e,r).length!==0?R(this,Ie).call(this,this.getMmlArr(),this.getMml()):R(this,qe).call(this,"無効な指定",`範囲${R(this,le).length-1}までの中で${e}から${r}削除するのはできません`)}}st=new WeakMap,le=new WeakMap,Ie=new WeakMap,qe=new WeakMap;var Te,He,it,Be;class Fo{constructor(e,r){we(this,Te,[]);we(this,He,[]);we(this,it,null);we(this,Be,null);this.tonesElem=e,this.areaElem=r,ke(this,Be,this.areaElem.querySelector(".track.active"))}set activeTrack(e){R(this,Be).classList.remove("active"),ke(this,Be,e),R(this,Be).classList.add("active")}get activeTrack(){return R(this,Be)}blocksDataUpdate(){ke(this,Te,[...this.areaElem.querySelectorAll(".track button")].map(e=>({label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),tone:{tone:e.dataset.tone,tonePitch:e.dataset.tonePitch},tempo:e.dataset.tempo,noteValue:e.dataset.noteValue,rest:e.dataset.rest,octave:e.dataset.octave,velocity:e.dataset.velocity,noteShift:e.dataset.noteShift,detune:e.dataset.detune,tieSlur:e.dataset.tieSlur,repeatStartEnd:e.dataset.repeatStartEnd,repeatBreak:e.dataset.repeatBreak,polyStartEnd:e.dataset.polyStartEnd,macroDef:e.dataset.macroDef,macroArgUse:e.dataset.macroArgUse,macroUse:e.dataset.macroUse,metaData:e.dataset.metaData,otherAction:e.dataset.otherAction,elem:e})))}saveBlocksData(){clearTimeout(R(this,it)),ke(this,it,setTimeout(()=>{const e=JSON.parse(JSON.stringify(R(this,Te)));Xt.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){Xt.getItem("BlocksData").then(e=>{e&&(ke(this,Te,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Q))})}parseBlocks(){const e=R(this,Te);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let o=0;e.forEach(i=>{if(i.trackNo!==o){const y=document.createElement("ul");y.classList.add("track"),this.activeTrack=y,this.areaElem.insertBefore(y,Re),o=i.trackNo}const t=document.createElement("li"),l='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',v=(()=>{const y=document.createElement("div");return y.innerHTML=l,y.firstElementChild})(),f=document.querySelector(`[class*="${i.className.replace(/ material-icons| droppable| bounce| pop| done/g,"")}"]`),u=(f==null?void 0:f.cloneNode(!0))||v;i.label&&(u.ariaLabel=i.label),i.tone.tonePitch&&(u.className=i.className,i.label!=="無調整"&&(u.textContent=i.label),u.dataset.tone=i.tone.tone,f?f.replaceWith(u.cloneNode(!0)):r.appendChild(u.cloneNode(!0)),u.dataset.tonePitch=i.tone.tonePitch),i.tempo&&(u.dataset.tempo=i.tempo),i.noteValue&&(u.dataset.noteValue=i.noteValue),i.rest&&(u.dataset.rest=i.rest),i.octave&&(u.dataset.octave=i.octave),i.velocity&&(u.dataset.velocity=i.velocity),i.noteShift&&(u.dataset.noteShift=i.noteShift),i.detune&&(u.dataset.detune=i.detune),i.tieSlur&&(u.dataset.tieSlur=i.tieSlur,i.tieSlur==="&"?u.ariaLabel="スラー":u.ariaLabel="タイ"),i.repeatStartEnd&&(u.dataset.repeatStartEnd=i.repeatStartEnd,i.repeatStartEnd.startsWith("/:")?(u.classList.remove("material-icons"),u.ariaLabel="リピート開始",u.textContent="◆"):i.repeatStartEnd===":/"&&(u.ariaLabel="リピート終了")),i.repeatBreak&&(u.dataset.repeatBreak=i.repeatBreak),i.polyStartEnd&&(u.dataset.polyStartEnd=i.polyStartEnd),i.macroDef&&(u.dataset.macroDef=i.macroDef,u.textContent=i.macroDef===";"?";":"$="),i.macroArgUse&&(u.dataset.macroArgUse=i.macroArgUse),i.macroUse&&(u.dataset.macroUse=i.macroUse),i.metaData&&(u.dataset.metaData=i.metaData),i.otherAction&&(u.dataset.otherAction=i.otherAction,u.textContent=i.otherAction.length>4?"…":i.otherAction),t.appendChild(u),this.activeTrack.appendChild(t)})}exportMml(e){e.setMmlArr([]);let r=0,o=0;const i=R(this,Te).filter(c=>c.tone.tone!==void 0),t=()=>i.filter(c=>c.trackNo===o),l=()=>new Set(t().map(c=>c.tone.tone));let v=l(),f=0,u=!1,y=[4,0],h=!1;R(this,Te).forEach(c=>{const{tone:E,tonePitch:T}=c.tone;if(c.trackNo!==o&&(v.size?([...v].forEach((S,g)=>{e.appendToStr(r+g,";")}),r+=v.size):(e.appendToStr(r,";"),r++),o=c.trackNo,v=l(),u=!1),E!==void 0)f=[...v].indexOf(E),u||([...v].forEach((S,g)=>{S&&e.beforeInsertToStr(r+g,S+" ")}),u=!0),[...v].forEach((S,g)=>{let D=T||"";g!==f&&(D=D.replace(/[a-g]/,h?"*":"r")),e.appendToStr(r+g,D)});else if(c.rest||c.tieSlur)v.size?[...v].forEach((S,g)=>{e.appendToStr(r+g,c.rest||c.tieSlur)}):e.appendToStr(r,c.rest||c.tieSlur);else if(c.noteValue||c.repeatStartEnd||c.repeatBreak||c.polyStartEnd){const S=g=>{if(!g)return y;const D=Number((g.match(/[0-9]+/)||[y[0]])[0]),$=(g.match(/\.+/)||[""])[0].length;return[D,$]};c.noteValue?y=S(c.noteValue):c.polyStartEnd==="["?h=!0:c.polyStartEnd==="]"&&(h=!1),v.size?[...v].forEach((g,D)=>{if(e.appendToStr(r+D,c.noteValue||c.repeatStartEnd||c.repeatBreak||c.polyStartEnd||""),c.polyStartEnd==="]"){const $=e.getMmlLine(r+D).match(/\[(.+?)\]/);if($){const N=$[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(N){const j=[...N].map(F=>({type:F[1]==="r"?"rest":F[1]==="*"?"otherNote":"note",num:S(F[0])}));j.filter(q=>q.type==="note").map(q=>q.num),j.filter(q=>q.type==="otherNote").map(q=>q.num),j.filter(q=>q.type==="rest").map(q=>q.num);let C=$[0].replace(/\*\+?[0-9]*\.*/g,"");const U=e.getMmlLine(r+D).replace(/\[.+?\]/,C);e.rewrite(r+D,U)}}}}):e.appendToStr(r,c.noteValue||c.repeatStartEnd||c.repeatBreak||c.polyStartEnd||"")}else if(c.metaData)c.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,c.metaData.replace(`
`,"")||""),r++;else{const S=T||c.tempo||c.octave||c.velocity||c.noteShift||c.detune||c.tieSlur||c.macroDef||c.macroArgUse||c.macroUse||c.otherAction||"";e.appendToStr(r,S),/;/.test(S)&&(r+=v.size||1,v=l(),u=!1)}}),[...v].slice(0,-1).forEach((c,E)=>{e.appendToStr(r+E,";")})}importMml(e){const r=e.getMmlArr(),o=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig,i=[],t=new Set,l=new Set;let v=0,f="",u=!1,y=!1;r.forEach(h=>{(h.match(o)||[]).forEach(E=>{if(E=E.trim(),!E)return;const T=S=>{const g={};if(g.tone={},g.trackNo=v,/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(S)){f=S,l.add(f);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(S)){l.has(f)||l.add(f);const D=[...l].indexOf(f)+1;g.label="無調整",g.className=`material-icons note note-${D}`,g.tone.tone=f,g.tone.tonePitch=S,u&&(y=!0)}else if(S.startsWith("t"))g.className="material-icons tempo",g.tempo=S;else if(S.startsWith("l"))g.className="material-icons note-value",g.noteValue=S;else if(S.startsWith("r"))g.className="material-icons rest",g.rest=S;else if(/^o[0-8]|[><]+$/i.test(S))g.className="material-icons octave",g.octave=S;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(S))g.className="material-icons velocity",g.velocity=S;else if(S.startsWith("@ns")||S.startsWith("ns"))g.className="material-icons note-shift",g.noteShift=S;else if(S.startsWith("@d"))g.className="material-icons detune",g.detune=S;else if(S.startsWith("&"))g.className="tie-slur",g.tieSlur=S;else if(S.startsWith("/*"))g.className="other-action",g.otherAction=S;else if(S.startsWith("/:"))g.className="repeat-start-end",g.repeatStartEnd=S;else if(S.startsWith(":/"))g.className="material-icons repeat-start-end",g.repeatStartEnd=S;else if(S.startsWith("/"))g.className="repeat-break",g.repeatBreak=S;else if(S.startsWith("[")||S.startsWith("]"))g.className="poly-start-end",g.polyStartEnd=S;else if(/^\$.*?=$/.test(S))g.className="macro-def",g.macroDef=S.replaceAll(" ",""),t.add(g.macroDef.slice(0,-1)),u=!0;else if(S.startsWith("%"))g.className="macro-arg-use",g.macroArgUse=S;else if(S.startsWith("$")){g.className="macro-use";const D=[...t].sort(($,N)=>N.length-$.length).find($=>S.includes($));if(D){g.macroUse=D,i.push(g);const $=S.replace(D,"");$!==""&&T($);return}else g.macroUse=S}else if(S.startsWith("#")){const D={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};g.label=(Object.entries(D).find($=>S.startsWith($[0]))||[,void 0])[1],g.className="meta-data",g.metaData=S+`
`}else if(S.startsWith(";")){if(v++,u&&!y){const D=[...l].join(" ");D&&(g.className="other-action",g.otherAction=D,i.push(g),l.clear())}u=!1,y=!1;return}else g.className="other-action",g.otherAction=S;i.push(g)};T(E)})}),this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((h,c)=>{c?h.remove():(h.textContent="",this.activeTrack=h)}),J=null,ke(this,Te,i),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}playRendering(){const e=R(this,Te);let r=120,o=0;[ue,ge,ce].forEach(y=>{y.classList.add("no-op")});const i=document.querySelector(".wrap"),t=document.getElementsByClassName("track"),v=(i.clientHeight-32)/t.length;[...t].forEach(y=>{y.style.setProperty("--max-height",`${v}px`)}),Re.disabled=!0,at.disabled=!0;const f=(y,{scoreNoteValue:h=4}={})=>{var B;let c=!1,E=-1,T=-1,S=!1,g=!1;const D=[],$=[],N=[],j=performance.now(),C=(B=y[0])==null?void 0:B.trackNo,U=t[C],F=o++;let q=null;const de=new Promise(_=>q=_);let ie=0,te=0;const fe=_=>{if(!_)return h;const V=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(_),H=V&&V[1]?Number(V[1]):h,Y=V?V[2].length:0;return H*2**Y/(2**(Y+1)-1)},Ee=_=>{const V=Y=>{!g&&U.scrollTo({top:Y,behavior:"smooth"}),g=!0,jo(U).then(()=>{g=!1})},H=Y=>U.clientHeight*Y;(te===0||_.elem.offsetTop>U.scrollTop+H(.8)||_.elem.offsetTop<U.scrollTop+H(.2))&&V(_.elem.offsetTop-H(.2))},L=_=>{const V=H=>{const Y=H-j,X=60/r*4/_*1e3;Y<ie+X?R(this,He)[F]=requestAnimationFrame(V):(ie+=X,w())};R(this,He)[F]=requestAnimationFrame(V)},w=async()=>{var V,H;const _=y[te];if(!_||te>=y.length){q({scoreNoteValue:h});return}if(Ee(_),S){_.macroDef===";"&&(S=!1),te++,w();return}else if(E!==-1)(V=_.repeatStartEnd)!=null&&V.startsWith("/:")?T++:_.repeatStartEnd===":/"&&(T===E&&(_e(_.elem,"pop"),E=-1),T--),te++,w();else if(_.tone.tonePitch){const Y=fe(_.tone.tonePitch);_e(_.elem,"bounce"),te++,c?w():L(Y)}else if(_.rest||_.tieSlur)if(_e(_.elem,"pop"),te++,_.tieSlur==="&")w();else{const Y=fe(_.rest||_.tieSlur);L(Y)}else if(_.polyStartEnd)if(c=_.polyStartEnd==="[",_e(_.elem,"pop"),c)te++,w();else{const Y=fe(y[te++-1].tone.tonePitch);L(Y)}else if(_.macroDef&&_.macroDef!==";"){S=!0,te++,w();return}else{if(_.tempo&&(r=Number(_.tempo.replace("t",""))||r),_.noteValue&&(h=fe(_.noteValue)),_e(_.elem,"pop"),(H=_.repeatStartEnd)!=null&&H.startsWith("/:"))D[++T]=te,$[T]||(N[T]=_.repeatStartEnd.replace("/:",""),N[T]=N[T]===""?2:Number(N[T]),N[T]||(E=T));else if(_.repeatBreak){if(N[T]===1){if(!$[T]){let Y=T;$[T]=y.findIndex((X,ee)=>{if(ee>D[T]){if(console.log(Y),X.repeatStartEnd.startsWith("/:"))Y++;else if(X.repeatStartEnd===":/"){if(Y===T)return!0;Y--}}})}te=$[T],w(),_e(_.elem,"done");return}}else if(_.repeatStartEnd===":/"){if(N[T]--,N[T]){$[T]=te,te=D[T],T--,w(),_e(_.elem,"done");return}$[T]=null,T--}else if(_.macroUse){const Y=ee=>{const he=e[ee].trackNo;let Se=ee+1;for(;e[Se].macroDef!==";"&&e[Se].trackNo===he;)Se++;return Se},X={};if(X.start=e.findIndex(ee=>{var he;return(he=ee.macroDef)==null?void 0:he.startsWith(_.macroUse)}),X.start>-1){X.end=Y(X.start),X.blocks=e.slice(X.start+1,X.end);const ee=performance.now();h=(await f(X.blocks,{scoreNoteValue:h})).scoreNoteValue;const he=performance.now();ie+=he-ee}}te++,w()}_e(_.elem,"done")};return w(),de},u=e.at(-1).trackNo+1;for(let y=0;y<u;y++)f(e.filter(h=>h.trackNo===y))}stopRendering(){[ue,ge,ce].forEach(e=>{e.classList.remove("no-op")}),Re.disabled=!1,at.disabled=!1,R(this,Te).forEach(e=>{e.elem.classList.remove("done")}),R(this,He).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!R(this,Te).length)return;const e=R(this,Te).at(-1).trackNo+1;for(let r=0;r<e;r++)R(this,Te).filter(i=>i.polyStartEnd&&i.trackNo===r).forEach((i,t)=>{t%2===0?(i.elem.dataset.polyStartEnd="[",i.elem.textContent="["):(i.elem.dataset.polyStartEnd="]",i.elem.textContent="]")});this.blocksDataUpdate()}}Te=new WeakMap,He=new WeakMap,it=new WeakMap,Be=new WeakMap;var pe,Nt,ct,Ge;class Wo{constructor(){we(this,pe,[[],[]]);we(this,Nt,70);we(this,ct,e=>{});we(this,Ge,e=>{})}set onPushstate(e){ke(this,ct,e)}set onPopstate(e){ke(this,Ge,e)}pushState(e){R(this,pe)[0].push(e),R(this,ct).call(this,e),R(this,pe)[0].length>R(this,Nt)&&R(this,pe)[0].shift(),R(this,pe)[1].length=0,console.log(R(this,pe))}undo(){const e=R(this,pe)[0].pop();return R(this,Ge).call(this,{reason:"undo",data:e}),e&&R(this,pe)[1].unshift(e),console.log(R(this,pe)),{canUndo:!!R(this,pe)[0].length,canRedo:!!R(this,pe)[1].length}}redo(){const e=R(this,pe)[1].shift();return R(this,Ge).call(this,{reason:"redo",data:e}),e&&R(this,pe)[0].push(e),console.log(R(this,pe)),{canUndo:!!R(this,pe)[0].length,canRedo:!!R(this,pe)[1].length}}clear(){R(this,pe)[0].length=0,R(this,pe)[1].length=0,console.log(R(this,pe))}}pe=new WeakMap,Nt=new WeakMap,ct=new WeakMap,Ge=new WeakMap;var At,_t,Dt;class Vo{constructor(e){we(this,At,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name"},{label:"音の定義",type:"text",name:"tone-def",autofocus:""}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}]},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}]},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0"}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}]},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}]},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}]},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8"}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}]},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127"}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}]},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift"}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}]},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune"}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}]},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}]},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0"}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}]},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg"}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}]},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use"}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}]},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg"}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}]},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}]},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action"}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}]},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}]}});we(this,_t,e=>{const r=R(this,At)[e];Object.keys(r).forEach(o=>{switch(o){case"title":re._title.textContent=r.title;break;case"inputs":r.inputs.forEach(i=>{const t=document.createElement("input");let l=t;Object.entries(i).forEach(([v,f])=>{if(v==="label"){const u=document.createElement("label");u.textContent=f,u.appendChild(t),l=u}else if(v==="select"){const u=document.createElement("select");u.name=i.name,Object.entries(f).forEach(([h,c])=>{const E=document.createElement("option");E.value=h,E.textContent=c,u.appendChild(E)}),t.replaceWith(u)}else t[v]=f}),re.inputs.appendChild(l)});break;case"buttons":r.buttons.forEach(i=>{const t=document.createElement("button");Object.entries(i).forEach(([l,v])=>{t[l]=v}),re.buttons.appendChild(t)});break}})});we(this,Dt,(e,r)=>{re._title.textContent="",re.inputs.textContent="",re.buttons.textContent="",R(this,_t).call(this,e);for(const[o,i]of Object.entries(r))o==="run"?i():re.elements[o].value=i;this.type=e});this.type=null,this.submitTarget=null,this.resolve=null,e.addEventListener("submit",r=>{const o=this.submitTarget,i=r.submitter.value,t=JSON.parse(JSON.stringify(o.dataset));switch(i){case"set-tone":const v=o.className;document.querySelectorAll(`[class*="${v}"]`).forEach(c=>{c.ariaLabel=e.elements["tone-name"].value,(!c.classList.contains("material-icons")||e.elements["tone-name"].value!=="無調整")&&(c.classList.remove("material-icons"),c.textContent=e.elements["tone-name"].value),c.dataset.tone=e.elements["tone-def"].value});break;case"set-tone-pitch":o.dataset.tonePitch=o.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]+e.elements["tone-pitch"].value+".".repeat(e.elements.dot.value);break;case"set-tempo":o.dataset.tempo="t"+e.elements.tempo.value;break;case"set-note-value":o.dataset.noteValue="l"+e.elements["note-value"].value+".".repeat(e.elements.dot.value);break;case"set-rest":o.dataset.rest="r"+e.elements.rest.value+".".repeat(e.elements.dot.value);break;case"set-octave":o.dataset.octave="o"+e.elements.octave.value;break;case"set-octave-relative":o.dataset.octave=e.elements.octave.value>0?"<".repeat(e.elements.octave.value):">".repeat(-e.elements.octave.value);break;case"set-velocity":o.dataset.velocity="@v"+e.elements.velocity.value;break;case"set-velocity-relative":o.dataset.velocity=(e.elements.velocity.value>=0?"(":")")+Math.abs(e.elements.velocity.value);break;case"set-note-shift":o.dataset.noteShift="ns"+e.elements["note-shift"].value;break;case"set-note-shift-relative":o.dataset.noteShift="@ns"+e.elements["note-shift"].value;break;case"set-detune":o.dataset.detune="@d"+e.elements.detune.value;break;case"set-tie-slur":o.dataset.tieSlur="&"+e.elements["tie-slur"].value+".".repeat(e.elements.dot.value),o.dataset.tieSlur==="&"?o.ariaLabel="スラー":o.ariaLabel="タイ";break;case"set-repeat":o.dataset.repeatStartEnd="/:"+e.elements.repeat.value;break;case"set-macro-def":const f=o.dataset.macroDef;o.dataset.macroDef="$"+e.elements["macro-def-name"].value+(e.elements["macro-def-arg"].value!==""?`{${e.elements["macro-def-arg"].value}}`:"")+"=",ce.querySelectorAll(`[data-macro-use="${f.replace("=","")}"]`).forEach(c=>{c.dataset.macroUse=o.dataset.macroDef.replace("=","")});break;case"set-macro-arg-use":o.dataset.macroArgUse="%"+e.elements["macro-arg-use"].value;break;case"set-macro-use":o.dataset.macroUse="$"+e.elements["macro-use-name"].value+(e.elements["macro-use-arg"].value!==""?`{${e.elements["macro-use-arg"].value}}`:"");break;case"set-meta-data":o.ariaLabel=e.elements["select-meta-data"].selectedOptions[0].label,o.dataset.metaData=e.elements["select-meta-data"].value.replace("{n}",e.elements.number.value).replace("{desc}",e.elements.text.value);break;case"set-other-action":o.dataset.otherAction=e.elements["other-action"].value,o.textContent=o.dataset.otherAction.length>4?"…":o.dataset.otherAction;break;case"remove-left":case"remove-right":const u=o.parentElement,y=I.activeTrack,h=y.children;for([...h].indexOf(u),J=null;[...h].includes(u);){const c=i==="remove-left",E=c?y.firstElementChild:y.lastElementChild;ye.pushState({operation:"remove",removedElem:E,removedIndex:c?0:h.length-1,parent:y}),E.remove()}I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q);break}const l=JSON.parse(JSON.stringify(o.dataset));JSON.stringify(t)!==JSON.stringify(l)&&ye.pushState({operation:"valueChange",target:o,beforeChange:t,afterChange:l}),this.resolve()})}async prompt(e,r,o){return R(this,Dt).call(this,e,r),this.submitTarget=o,$e.showModal(),new Promise(i=>this.resolve=i)}}At=new WeakMap,_t=new WeakMap,Dt=new WeakMap;zn.FlMML.prepare(".editor");const xe=new zn.FlMML({workerURL:ea}),Q=new $o;Xt.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const I=new Fo(ue,ce),ye=new Wo,It=new Vo(re),zo={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},Yo=new fn({i18n:zo,locale:"ja"});Mo.polyfill({holdToDrag:500});Po();const ot=n=>`<span class="material-icons">${n}</span>`,dr=ot("play_arrow")+"再生",qo=ot("stop")+"停止",an=()=>{I.playRendering()},Ho=()=>{Ro.innerHTML=xe.getWarnings().replaceAll(`
`,"<br>")};xe.addEventListener("compilecomplete",Ho);const Go=()=>{wt.innerHTML=dr,I.stopRendering(),xe.removeEventListener("compilecomplete",an),Tt.disabled=!1};xe.addEventListener("complete",Go);Q.onChange=(n,e)=>{Uo.innerHTML=e?`<pre><code>${Oo(e).replaceAll(`
`,"<br>")}</code></pre>`:"(なし)";const r=!!n.length;[je,kt].forEach(o=>{o.disabled=!r})};Q.onError=(n,e)=>{alert(n+`
`+e)};I.checkSavedBlocksData();const De=n=>{var c,E;const e=()=>{let T=n.parentElement;for(;T&&!("noteValue"in T.firstElementChild.dataset);)T=T.previousElementSibling;return(T==null?void 0:T.firstElementChild)||null},r=()=>{var S;let T=n.parentElement;for(;T&&!((S=T.firstElementChild.dataset.octave)!=null&&S.startsWith("o"));)T=T.previousElementSibling;return(T==null?void 0:T.firstElementChild)||null},o=()=>{var g;let T=n.parentElement.nextElementSibling,S="";for(;T&&((g=T.firstElementChild.dataset.tieSlur)!=null&&g.match(/&[0-9]+\.*/));)S+=T.firstElementChild.dataset.tieSlur,T=T.nextElementSibling;return S},i=((c=e())==null?void 0:c.dataset.noteValue)||"",t=((E=r())==null?void 0:E.dataset.octave)||"",l=[...I.activeTrack.children].indexOf(n.parentElement),v=[...I.activeTrack.children].slice(0,l).filter(T=>"tonePitch"in T.firstElementChild.dataset||"octave"in T.firstElementChild.dataset&&!T.firstElementChild.dataset.octave.startsWith("o")).map(T=>((T.firstElementChild.dataset.tonePitch||T.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),f=[">","<"],u=(T,S)=>(T.match(new RegExp(S,"g"))||[]).length,y=(()=>{const T=-u(v,f[0])+u(v,f[1]);return T<0?f[0].repeat(-T):T>0?f[1].repeat(T):""})(),h=o();xe.play(n.dataset.tone+i+t+y+n.dataset.tonePitch+h)};ye.onPopstate=n=>{const e=n.data,r=o=>!!e.parent.closest("#"+o);switch(n.reason){case"undo":switch(e==null?void 0:e.operation){case"append":Q.delete(e.index);break;case"delete":Q.insert(e.index,e.mmlText);break;case"rewrite":Q.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q));break;case"move":const o=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(o,e.elem),r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q));break;case"valueChange":for(const[i,t]of Object.entries(e.beforeChange))e.target.dataset[i]=t;"tone"in e.target.dataset&&De(e.target),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q));break;case"clear":e.tonesChildren.forEach(i=>{ue.querySelector("ul").appendChild(i)}),e.musicalScoreChildren.forEach(i=>{ce.insertBefore(i,Re)}),J=e.lastTouchedButton,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":Q.append(e.mmlText);break;case"delete":Q.delete(e.index);break;case"rewrite":Q.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q)),"tonePitch"in J.dataset&&(De(J),J.classList.add("bounce"));break;case"move":const o=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(o,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q));break;case"valueChange":for(const[t,l]of Object.entries(e.afterChange))e.target.dataset[t]=l;"tone"in e.target.dataset&&De(e.target),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);break;case"remove":const i=e.removedElem.className;e.removedElem.remove(),r("tones")&&ce.querySelectorAll(`[class*="${i}"]`).forEach(t=>{t.parentElement.remove()}),I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q);break;case"clear":ue.querySelector("ul").textContent="",ce.querySelectorAll(".track").forEach((t,l)=>{l?t.remove():(t.textContent="",I.activeTrack=t)}),J=null,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);break}break}};const fr=()=>{const n=[...ue.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!n.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",n=>{var r;const e=n.ctrlKey||Lt.checked;switch((r=n.key)==null?void 0:r.toLowerCase()){case" ":document.activeElement.tagName.toLowerCase()!=="input"&&(n.preventDefault(),wt.click());break;case"s":e&&(n.preventDefault(),!kt.disabled&&kt.click());break;case"o":e&&(n.preventDefault(),!rn.disabled&&rn.click());break;case"z":e&&ye.undo();break;case"y":e&&ye.redo();break}});const gt=async n=>{const{dataset:e}=n,r={tempo:o=>({tempo:o.replace("t","")}),noteValue:o=>({"note-value":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),rest:o=>({rest:(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),octave:o=>({octave:o.startsWith("o")?o.replace("o",""):(o.match(/[><]+/)||[""])[0].length}),velocity:o=>({velocity:o.startsWith("@v")?o.replace("@v",""):Number((o.match(/[0-9]+/)||[""])[0])*(o.startsWith("(")?1:-1)}),noteShift:o=>({"note-shift":(o.match(/[0-9]+/)||[""])[0]}),detune:o=>({detune:o.replace("@d","")}),tieSlur:o=>({"tie-slur":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),repeatStartEnd:o=>({repeat:o.replace("/:","")}),macroDef:o=>({"macro-def-name":(o.match(/\$([^\{\=]*)[\{\=]/)||[,""])[1],"macro-def-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),macroArgUse:o=>({"macro-arg-use":o.replace("%","")}),macroUse:o=>({"macro-use-name":(o.match(/\$([^\{]*)\{?/)||[,""])[1],"macro-use-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),metaData:o=>({run:()=>{const t=o.split(" "),l=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let v=l.findIndex(c=>t[0].startsWith(c));v===-1&&(v=0),re.elements["select-meta-data"].selectedIndex=v;const f=c=>re.elements[c].previousSibling,u=()=>re.elements["select-meta-data"].selectedOptions[0],y=(c,E)=>{f("number").nodeValue=c[0],re.elements.number.value=c[1],re.elements.number.parentElement.style.display=c[2]?"none":"",f("text").nodeValue=E[0],re.elements.text.value=E[1],re.elements.text.parentElement.style.display=E[2]?"none":""},h=c=>{var S,g,D;const E=c===v,T=l[c];switch(T){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const $=E?t.slice(1).join(" ")??"":"";y(["無効","",!0],[u().label,$,!1]);break;case"#OCTAVE":case"#VELOCITY":y(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const N=T==="#WAV9",j=E?((S=t.slice(1).join(" "))==null?void 0:S.split(","))??[]:[];y(["波形番号",j[0]??0,!1],N?["初期変位,ループフラグ,データ",`${j[1]??0},${j[2]??0},${j[3]??""}`,!1]:["データ",j[1]??"",!1]),re.elements.number.min=0,re.elements.number.max=N?15:31;break;case"#OPM":case"#OPN":y(["音色番号",E?((g=t[0])==null?void 0:g.split("@")[1])??0:0,!1],["データ",E?((D=t.slice(1).join(" "))==null?void 0:D.slice(1,-1))??"":"",!1]),re.elements.number.min=0,re.elements.number.max=127;break;case"#FMGAIN":y(["音量利得",E?t[1].replace(`
`,"")??91:91,!1],["無効","",!0]),re.elements.number.min=-127,re.elements.number.max=127;break;case"#USING":y(["和音重ね数",E?t[2].replace(`
`,"")??2:2,!1],["無効","",!0]),re.elements.number.min=1,re.elements.number.max="";break}};h(v),re.elements["select-meta-data"].addEventListener("change",c=>{h(c.target.selectedIndex)})}}),otherAction:o=>({"other-action":o}),remove:()=>({})};for(const o of Object.keys(e)){const i=r[o];if(i){let t=e[o];switch(o){case"repeatStartEnd":if(t===":/"){const f=(()=>{var y;let u=n.parentElement;for(;u&&!((y=u.firstElementChild.dataset.repeatStartEnd)!=null&&y.startsWith("/:"));)u=u.previousElementSibling;return(u==null?void 0:u.firstElementChild)||null})();if(f)n=f;else{const u=I.activeTrack,y=document.createElement("li"),c=ge.querySelector(".repeat-start-end").cloneNode(!0);y.appendChild(c),u.insertBefore(y,n.parentElement),n=c}t=n.dataset.repeatStartEnd}break;case"macroDef":if(t===";")return;break}const l=i(t);await It.prompt(o,l,n);break}}};let J=ue.querySelector("button");Ue.addEventListener("click",async n=>{const e=n.ctrlKey||Lt.checked,r=i=>!!n.target.closest("#"+i),o=n.target.tagName.toLowerCase()==="button";if(![ue,ge,ce].some(i=>i.classList.contains("no-op"))){if(r("tones"))if(o)J=n.target,await It.prompt("tone",{"tone-name":n.target.ariaLabel,"tone-def":n.target.dataset.tone,run:()=>{const i=re.elements["tone-name"];i.insertAdjacentElement("afterend",Yo);const t=document.querySelector("emoji-picker");i.addEventListener("focus",()=>{t.classList.add("expaned")},{once:!0}),t.addEventListener("emoji-click",l=>i.value=l.detail.unicode)}},n.target),xe.play(n.target.dataset.tone+n.target.dataset.tonePitch),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);else{const i=ue.querySelector("ul"),t=document.createElement("li"),v=`<button class="material-icons note ${fr()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;t.innerHTML=v;const f=t.firstElementChild;i.appendChild(t),J=f,xe.play(f.dataset.tone+f.dataset.tonePitch),ye.pushState({operation:"copy",toIndex:-1,newElem:t,parent:i})}else if(r("action")){if(o){"otherAction"in n.target.dataset&&await gt(n.target);const i=I.activeTrack,t=document.createElement("li"),l=n.target.cloneNode(!0);if(["metaData","macroDef","macroArgUse","macroUse"].some(v=>v in l.dataset)&&await gt(l),"tieSlur"in l.dataset?l.ariaLabel="スラー":"repeatStartEnd"in l.dataset?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"):"polyStartEnd"in l.dataset?(l.dataset.polyStartEnd="[",l.textContent="["):"macroDef"in l.dataset&&(l.textContent="$="),t.appendChild(l),i.appendChild(t),J=l,I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:t,parent:i}),["repeatStartEnd","polyStartEnd","macroDef"].some(v=>v in J.dataset)){const v=document.createElement("li"),f=n.target.cloneNode(!0);"repeatStartEnd"in J.dataset?(f.ariaLabel="リピート終了",f.dataset.repeatStartEnd=":/"):"polyStartEnd"in J.dataset?(f.dataset.polyStartEnd="]",f.textContent="]"):"macroDef"in J.dataset&&(f.dataset.macroDef=";",f.textContent=";"),v.appendChild(f),J.parentElement.insertAdjacentElement("afterend",v),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:v,parent:i})}}}else if(r("musical-score")){if(o&&n.target!==Re&&n.target!==at)n.target.closest(".track")&&(I.activeTrack=n.target.closest(".track")),"tone"in n.target.dataset?(De(n.target),_e(n.target,"bounce"),e&&(await It.prompt("tonePitch",{"tone-pitch":(n.target.dataset.tonePitch.match(/[0-9]+/)||[""])[0],dot:(n.target.dataset.tonePitch.match(/\.+/)||[""])[0].length},n.target),De(n.target))):await gt(n.target),J=n.target,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);else if(J){n.target.closest(".track")&&(I.activeTrack=n.target.closest(".track"));const i=I.activeTrack,t=document.createElement("li"),l=J.cloneNode(!0);if("repeatStartEnd"in l.dataset&&(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"+(l.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),t.appendChild(l),i.appendChild(t),J=l,I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:t,parent:i}),"tonePitch"in l.dataset)l.dataset.tonePitch=l.dataset.tonePitch.replace(/[><]+/,""),De(l),l.classList.add("bounce");else if("repeatStartEnd"in J.dataset){const v=document.createElement("li"),f=J.cloneNode(!0);f.classList.add("material-icons"),f.ariaLabel="リピート終了",f.textContent="repeat",f.dataset.repeatStartEnd=":/",v.appendChild(f),J.parentElement.insertAdjacentElement("afterend",v),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:v,parent:i})}}}}});Ue.addEventListener("contextmenu",n=>{var i,t,l,v;const e=f=>f.closest("#tones, #musical-score"),r=f=>!!n.target.closest("#"+f),o=n.target.tagName.toLowerCase()==="button";if(!((i=e(n.target))!=null&&i.classList.contains("no-op"))&&e(n.target)){const f=o&&n.target!==Re&&n.target!==at?n.target:J;if(!f||e(f)!==e(n.target))return;n.preventDefault(),I.activeTrack=f.closest(".track")||I.activeTrack;const u=f.parentElement,y=f.className,h=((t=f.closest("#tones"))==null?void 0:t.querySelector("ul"))||I.activeTrack,c=[...h.children].indexOf(u);J=((l=u.previousElementSibling)==null?void 0:l.firstElementChild)||((v=u.nextElementSibling)==null?void 0:v.firstElementChild)||null,ye.pushState({operation:"remove",removedElem:u,removedIndex:c,parent:h}),r("tones")?ce.querySelectorAll(`[class*="${y}"]`).forEach(E=>{E.parentElement.remove()}):"macroDef"in f.dataset&&ce.querySelectorAll(`[data-macro-use="${f.dataset.macroDef.replace("=","")}"]`).forEach(E=>{E.parentElement.remove()}),u.remove(),I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q)}});let yt=null,rt=!1,on=null;Ue.addEventListener("touchstart",n=>{yt=[...n.touches].at(-1).pageY,on=setTimeout(()=>{rt=!0},500)});const hr=n=>{const e=n.ctrlKey||Lt.checked,r=l=>!!n.target.closest("#"+l),o=n.target.tagName.toLowerCase()==="button";if(n.type==="touchmove"){const l=[...n.touches].at(-1).pageY;if(rt){n.cancelable&&n.preventDefault();return}else if(l-yt<-20)n.deltaY=-1,clearTimeout(on);else if(l-yt>20)n.deltaY=1,clearTimeout(on);else{n.cancelable&&n.preventDefault();return}yt=l,rt=!0,setTimeout(()=>rt=!1,50)}const i=n.deltaY<0;let t=o?n.target:(J==null?void 0:J.closest("#musical-score"))&&J;if(t){if(r("musical-score")){if(ce.classList.contains("no-op"))return;n.preventDefault();let l=JSON.parse(JSON.stringify(t.dataset));if(!e&&"tone"in t.dataset){const f=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],u=[">","<"],y=t.dataset.tonePitch,h=f.findIndex(D=>y.match(/[a-g]\+?/)[0]===D),c=(D,$)=>(D.match(new RegExp($,"g"))||[]).length,E=[c(y,u[0]),c(y,u[1])],T=u[0].repeat(E[0])+u[1].repeat(E[1]),S=(y.match(/[0-9]+/)||[""])[0],g=".".repeat((t.dataset.tonePitch.match(/\.+/)||[""])[0].length);i?h===f.length-1?E[0]?t.dataset.tonePitch=T.substring(1)+f.at(0)+S+g:t.dataset.tonePitch=T+u[1]+f.at(0)+S+g:t.dataset.tonePitch=T+f[h+1]+S+g:h===0?E[1]?t.dataset.tonePitch=T.substring(1)+f.at(-1)+S+g:t.dataset.tonePitch=T+u[0]+f.at(-1)+S+g:t.dataset.tonePitch=T+f[h-1]+S+g,De(t)}else{const f=i?1:-1,u=(y,h=-1/0,c=1/0)=>y+f<h||y+f>c?0:f;if(e&&"tonePitch"in t.dataset){const y=Number((t.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),h=".".repeat((t.dataset.tonePitch.match(/\.+/)||[""])[0].length),c=u(y,0,384),E=y+c!==0?y+c:"";t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+E+h,De(t)}else if("tempo"in t.dataset){const y=Number(t.dataset.tempo.replace("t","")),h=u(y,0);t.dataset.tempo="t"+(y+h*10)}else if("noteValue"in t.dataset){const y=Number((t.dataset.noteValue.match(/[0-9]+/)||[""])[0]),h=u(y,1,384);t.dataset.noteValue=t.dataset.noteValue.replace(/[0-9]+/,y+h)}else if("rest"in t.dataset){const y=Number((t.dataset.rest.match(/[0-9]+/)||[""])[0]),h=".".repeat((t.dataset.rest.match(/\.+/)||[""])[0].length),c=u(y,0,384),E=y+c!==0?y+c:"";t.dataset.rest="r"+E+h}else if("octave"in t.dataset)if(t.dataset.octave.startsWith("o")){const h=Number(t.dataset.octave.replace("o","")),c=u(h,0,8);t.dataset.octave="o"+(h+c)}else{const h=(t.dataset.octave.match(/<+/)||[""])[0].length-(t.dataset.octave.match(/>+/)||[""])[0].length,c=u(h,-8,8);t.dataset.octave=h+c>0?"<".repeat(h+c):">".repeat(-(h+c))}else if("velocity"in t.dataset)if(t.dataset.velocity.startsWith("@v")){const h=Number(t.dataset.velocity.replace("@v","")),c=u(h,0,127);t.dataset.velocity="@v"+(h+c)}else{const h=Number((t.dataset.velocity.match(/[0-9]+/)||[""])[0])*(t.dataset.velocity.startsWith("(")?1:-1),c=u(h,-127,127);t.dataset.velocity=(h+c>=0?"(":")")+Math.abs(h+c)}else if("noteShift"in t.dataset){const y=Number((t.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),h=f;t.dataset.noteShift=t.dataset.noteShift.match(/@?ns/)[0]+(y+h)}else if("detune"in t.dataset){const y=Number(t.dataset.detune.replace("@d","")),h=f;t.dataset.detune="@d"+(y+h)}else if("tieSlur"in t.dataset){const y=Number((t.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),h=".".repeat((t.dataset.tieSlur.match(/\.+/)||[""])[0].length),c=u(y,0,384),E=y+c!==0?y+c:"";t.dataset.tieSlur="&"+E+h,t.dataset.tieSlur==="&"?t.ariaLabel="スラー":t.ariaLabel="タイ"}else if("repeatStartEnd"in t.dataset){if(t.dataset.repeatStartEnd===":/"){const T=(()=>{var g;let S=t.parentElement;for(;S&&!((g=S.firstElementChild.dataset.repeatStartEnd)!=null&&g.startsWith("/:"));)S=S.previousElementSibling;return(S==null?void 0:S.firstElementChild)||null})();if(T)t=T;else{const S=I.activeTrack,g=document.createElement("li"),$=ge.querySelector(".repeat-start-end").cloneNode(!0);g.appendChild($),S.insertBefore(g,t.parentElement),t=$}l=JSON.parse(JSON.stringify(t.dataset))}const y=Number((t.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),h=u(y,-1),c=y+h!==-1?y+h:"";t.dataset.repeatStartEnd="/:"+c}}const v=JSON.parse(JSON.stringify(t.dataset));JSON.stringify(l)!==JSON.stringify(v)&&ye.pushState({operation:"valueChange",target:t,beforeChange:l,afterChange:v}),J=t,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q)}}else return};Ue.addEventListener("wheel",hr);Ue.addEventListener("touchmove",hr);Ue.addEventListener("touchend",()=>{rt=!1});let tt={};Ue.addEventListener("dragstart",n=>{tt={from:n.target.nodeType===1&&n.target.closest("#tones, #action, #musical-score"),item:n.target},n.dataTransfer.effectAllowed="copyMove"});let Wn=null;[ue,ge,ce].forEach(n=>{const e=t=>{const l=t.ctrlKey||Lt.checked,{from:v=null}=tt,f=t.dataTransfer;switch(v){case ue:switch(n){case ue:t.preventDefault(),l?f.dropEffect="copy":f.dropEffect="move";break;case ge:break;case ce:t.preventDefault(),f.dropEffect="copy";break}break;case ge:switch(n){case ue:break;case ge:break;case ce:t.preventDefault(),f.dropEffect="copy";break}break;case ce:switch(n){case ue:break;case ge:break;case ce:t.preventDefault(),l?f.dropEffect="copy":f.dropEffect="move";break}break}Wn=f.dropEffect};n.addEventListener("dragover",e);const r=t=>{const{from:l=null}=tt,v=t.target.tagName.toLowerCase()==="button",f=()=>t.target.classList.add("droppable");switch(l){case ue:switch(n){case ue:t.preventDefault(),v&&f();break;case ge:break;case ce:t.preventDefault(),v&&f();break}break;case ge:switch(n){case ue:break;case ge:break;case ce:t.preventDefault(),v&&f();break}break;case ce:switch(n){case ue:break;case ge:break;case ce:t.preventDefault(),v&&f();break}break}};n.addEventListener("dragenter",r);const o=t=>{const{from:l=null}=tt,v=t.target.tagName.toLowerCase()==="button",f=()=>t.target.classList.remove("droppable");switch(l){case ue:switch(n){case ue:v&&f();break;case ge:break;case ce:v&&f();break}break;case ge:switch(n){case ue:break;case ge:break;case ce:v&&f();break}break;case ce:switch(n){case ue:break;case ge:break;case ce:v&&f();break}break}};n.addEventListener("dragleave",o),n.addEventListener("drop",async t=>{var E,T;if(t.preventDefault(),(E=t.dataTransfer.items)!=null&&E.length)return;t.dataTransfer.dropEffect=t.dataTransfer.dropEffect!=="none"?t.dataTransfer.dropEffect:Wn;const{from:l,item:v}=tt,f=((T=t.target.closest("#tones"))==null?void 0:T.querySelector("ul"))||t.target.closest(".track")||I.activeTrack,u=[...f.children].indexOf(v.parentElement),y=[...f.children].indexOf(t.target.parentElement),h=t.target.tagName.toLowerCase()==="button";let c;switch(t.dataTransfer.dropEffect){case"copy":const S=document.createElement("li"),g=v.cloneNode(!0);if(n===ue){const D=[...v.classList].find($=>$.includes("note-"));g.classList.replace(D,fr())}else l===ge&&("tieSlur"in g.dataset?g.ariaLabel="スラー":("metaData"in g.dataset||"macroDef"in g.dataset||"macroArgUse"in g.dataset||"macroUse"in g.dataset||"otherAction"in g.dataset)&&await gt(g));"repeatStartEnd"in g.dataset?(g.classList.remove("material-icons"),g.ariaLabel="リピート開始",g.textContent="◆",g.dataset.repeatStartEnd="/:"+(g.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in g.dataset?(g.dataset.polyStartEnd="[",g.textContent="["):"macroDef"in g.dataset&&(g.dataset.macroDef===";"&&(g.dataset.macroDef="$="),g.textContent="$="),S.appendChild(g),c=S;break;case"move":c=v.parentElement;break}if(h&&t.target.id!=="add-track"&&t.target.id!=="remove-track"){const S=t.dataTransfer.dropEffect==="copy"||y<u?"beforebegin":"afterend";t.target.parentElement.insertAdjacentElement(S,c)}else f.appendChild(c);switch(J=c.firstElementChild,n===ce&&(I.activeTrack=f,I.blocksDataUpdate(),t.dataTransfer.dropEffect==="move"&&I.calcPoly(),I.saveBlocksData(),I.exportMml(Q),"tonePitch"in J.dataset&&(J.dataset.tonePitch=J.dataset.tonePitch.replace(/[><]+/,""),De(J),J.classList.add("bounce"))),t.dataTransfer.dropEffect){case"copy":ye.pushState({operation:"copy",toIndex:y,newElem:c,parent:f});break;case"move":ye.pushState({operation:"move",fromIndex:u,toIndex:y,elem:c,parent:f});break}if(t.dataTransfer.dropEffect==="copy"&&("repeatStartEnd"in J.dataset||"polyStartEnd"in J.dataset||"macroDef"in J.dataset)){const S=document.createElement("li"),g=v.cloneNode(!0);"repeatStartEnd"in J.dataset?(g.classList.add("material-icons"),g.ariaLabel="リピート終了",g.textContent="repeat",g.dataset.repeatStartEnd=":/"):"polyStartEnd"in J.dataset?(g.dataset.polyStartEnd="]",g.textContent="]"):"macroDef"in J.dataset&&(g.dataset.macroDef=";",g.textContent=";"),S.appendChild(g),c.insertAdjacentElement("afterend",S),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:y+1,newElem:S,parent:f})}});const i=t=>{[...document.getElementsByClassName("droppable")].forEach(l=>{l.classList.remove("droppable")})};n.addEventListener("dragend",i)});Ue.addEventListener("animationend",n=>{n.target.classList.remove("bounce"),n.target.classList.remove("pop")});Re.addEventListener("click",n=>{n.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),I.activeTrack=e,ce.insertBefore(e,Re)});at.addEventListener("click",n=>{n.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),I.activeTrack=r,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q)});$e.addEventListener("pointerdown",n=>{n.target===$e&&$e.addEventListener("pointerup",e=>{e.target===$e&&$e.close()},{once:!0})});$e.addEventListener("close",()=>{switch(It.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});wt.addEventListener("click",()=>{const n=xe.isPlaying();n?(xe.stop(),I.stopRendering(),xe.removeEventListener("compilecomplete",an),Tt.disabled=!1):(xe.play(Q.getMml()),xe.addEventListener("compilecomplete",an),Tt.disabled=!0),wt.innerHTML=n?dr:qo});Tt.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const n=[...ce.children];n.pop(),ye.pushState({operation:"clear",tonesChildren:[...ue.querySelector("ul").children],musicalScoreChildren:n,lastTouchedButton:J}),ue.querySelector("ul").textContent="";const e=ue.querySelector("ul"),r=document.createElement("li"),o='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=o;const i=r.firstElementChild;e.appendChild(r),J=i,ce.querySelectorAll(".track").forEach((t,l)=>{l?t.remove():(t.textContent="",I.activeTrack=t)}),xe.play(""),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q)}});je.addEventListener("click",()=>{const n=Q.getMml(),e=je.innerHTML;je.disabled=!0,navigator.clipboard.writeText(n).then(()=>{je.disabled=!0,je.innerHTML=ot("content_copy")+"コピーしました",setTimeout(()=>{je.innerHTML=e,je.disabled=!1},1500)}).catch(r=>alert(`コピーできませんでした
`+r))});Pe.addEventListener("click",()=>{const n=Pe.innerHTML;Pe.disabled=!0,navigator.clipboard.readText().then(e=>{Pe.disabled=!0,e?(Q.setMml(e.replace(/\r/g,"")),I.importMml(Q),Pe.innerHTML=ot("content_paste")+"貼り付けました"):Pe.innerHTML=ot("content_paste")+"内容がありません",setTimeout(()=>{Pe.innerHTML=n,Pe.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});kt.addEventListener("click",()=>{var t;const n=Q.getMml(),r=((t=Q.getMmlArr().find(l=>l.startsWith("#TITLE")))==null?void 0:t.split(" ").slice(1).join(" "))??"無題",o=new Blob([n],{type:"text/plain"}),i=document.createElement("a");i.download=r+".mml",i.href=URL.createObjectURL(o),i.click(),URL.revokeObjectURL(i.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。")});rn.addEventListener("click",()=>{const n=document.createElement("input"),e=new FileReader;n.type="file",n.accept=".mml,.flmml,.txt",n.click(),n.onchange=()=>{e.onload=()=>{Q.setMml(e.result),I.importMml(Q)},e.readAsText(n.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");ye.onPushstate=n=>{xt.disabled=!1,Ct.disabled=!0};xt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=ye.undo();xt.disabled=!n,Ct.disabled=!e});Ct.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=ye.redo();xt.disabled=!n,Ct.disabled=!e});
