var sn=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var D=(n,e,r)=>(sn(n,e,"read from private field"),r?r.call(n):e.get(n)),le=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},ke=(n,e,r,a)=>(sn(n,e,"write to private field"),a?a.call(n,r):e.set(n,r),r);var cn=(n,e,r)=>(sn(n,e,"access private method"),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const i of t.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function r(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(o){if(o.ep)return;o.ep=!0;const t=r(o);fetch(o.href,t)}})();const ka="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var dt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Na(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var fr={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(r,a){n.exports=a()})(self,function(){return(()=>{var r={587:(t,i,m)=>{var h;(h=(function(u,E){Object.defineProperty(E,"__esModule",{value:!0}),E.MsgTypes=E.SAMPLE_RATE=void 0,E.SAMPLE_RATE=44100,E.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(i,[m,i]))===void 0||(t.exports=h)},581:(t,i,m)=>{var h;(h=(function(u,E){Object.defineProperty(E,"__esModule",{value:!0}),E.FlMMLAudioExportError=void 0;class f extends Error{constructor(...w){super(...w),this.name="FlMMLAudioExportError"}}E.FlMMLAudioExportError=f}).apply(i,[m,i]))===void 0||(t.exports=h)},643:function(t,i,m){var h,u,E=this&&this.__awaiter||function(f,b,w,N){return new(w||(w=Promise))(function(_,l){function p(B){try{M(N.next(B))}catch(g){l(g)}}function A(B){try{M(N.throw(B))}catch(g){l(g)}}function M(B){var g;B.done?_(B.value):(g=B.value,g instanceof w?g:new w(function(O){O(g)})).then(p,A)}M((N=N.apply(f,b||[])).next())})};h=[m,i,m(587),m(581),m(158)],(u=(function(f,b,w,N,_){Object.defineProperty(b,"__esModule",{value:!0}),b.FlMMLonHTML5=b.FlMMLAudioExportError=b.FlMML=void 0,Object.defineProperty(b,"FlMMLAudioExportError",{enumerable:!0,get:function(){return N.FlMMLAudioExportError}});const l="flmml-on-html5.worker.js";class p{constructor(M=l){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof M=="string"&&(M={workerURL:M});const B=M.workerURL||l,g=M.infoInterval>=0?M.infoInterval:125;this.bufferSize=M.bufferSize>=128?Math.floor(M.bufferSize-M.bufferSize%128):8192,this.bufferMultiple=M.bufferMultiple>=1?Math.floor(M.bufferMultiple):32,this.lamejsURL=M.lamejsURL,(this.worker=new Worker(M.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${B}")`],{type:"application/javascript"})):B)).addEventListener("message",O=>{this.onMessage(O)}),this.setInfoInterval(g)}static initWebAudio(){const M=p.audioCtx=new AudioContext({sampleRate:w.SAMPLE_RATE}),B=M.createBufferSource();B.connect(M.destination),B.start(0),M.resume(),B.stop()}static hookInitWebAudio(M){const B=document.querySelectorAll(M);B.forEach(g=>{g.addEventListener("click",function O(){p.audioCtx||p.initWebAudio(),B.forEach($=>{$.removeEventListener("click",O,!0)})},!0)})}static prepare(M){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{p.hookInitWebAudio(M)}):p.hookInitWebAudio(M)}onMessage(M){const B=M.data;switch(B.type){case w.MsgTypes.COMPCOMP:this.totalMSec=B.info.totalMSec,this.totalTimeStr=B.info.totalTimeStr,this.warnings=B.info.warnings,this.metaTitle=B.info.metaTitle,this.metaComment=B.info.metaComment,this.metaArtist=B.info.metaArtist,this.metaCoding=B.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case w.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(B),this.trigger("buffering",{progress:B.progress});break;case w.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case w.MsgTypes.SYNCINFO:this._isPlaying=B.info._isPlaying,this._isPaused=B.info._isPaused,this.nowMSec=B.info.nowMSec,this.nowTimeStr=B.info.nowTimeStr,this.voiceCount=B.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case w.MsgTypes.PLAYSOUND:this.playSound();break;case w.MsgTypes.STOPSOUND:this.stopSound();break;case w.MsgTypes.EXPORT:B.data?this.completeAudioExport(B.data):this.errorAudioExport(B.errorMsg)}}boot(){this.worker.postMessage({type:w.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const M=p.audioCtx,B=this.gainNode=M.createGain();B.gain.value=this.volume/127,B.connect(M.destination),E(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(O=>{const $=new FileReader;$.onload=q=>{M.audioWorklet.addModule(q.target.result).then(O)},$.readAsDataURL(new Blob([_.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const g=this.workletNode=new AudioWorkletNode(M,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});g.connect(B),this.worker.postMessage({type:w.MsgTypes.PLAYSOUND,workletPort:g.port},[g.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:w.MsgTypes.STOPSOUND})}trigger(M,B){const g=this.events[M];if(!g)return;const O={};for(let $ in B)O[$]=B[$];for(let $=0,q=g.length;$<q;$++)g[$]&&g[$].call(this,O)}exportAudio(M,B,g={}){return p.audioCtx||p.initWebAudio(),this.booted||this.boot(),new Promise((O,$)=>{this.audioExportResolve?$(new N.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:w.MsgTypes.EXPORT,mml:M,format:B},g)),this.audioExportResolve=O,this.audioExportReject=$)})}completeAudioExport(M){this.audioExportResolve&&(this.audioExportResolve(M),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(M){this.audioExportReject&&(this.audioExportReject(new N.FlMMLAudioExportError(M)),this.audioExportResolve=null,this.audioExportReject=null)}play(M){p.audioCtx||p.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:w.MsgTypes.PLAY,mml:M})}stop(){this.worker.postMessage({type:w.MsgTypes.STOP})}pause(){this.worker.postMessage({type:w.MsgTypes.PAUSE})}exportWav(M){return this.exportAudio(M,"wav")}exportMp3(M,B){return this.exportAudio(M,"mp3",{bitrate:B})}setMasterVolume(M){this.volume=M,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(M){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:M})}syncInfo(){this.worker.postMessage({type:w.MsgTypes.SYNCINFO,interval:null})}addEventListener(M,B){let g=this.events[M];g||(g=this.events[M]=[]);for(let O=g.length;O--;)if(g[O]===B)return!1;return g.push(B),!0}removeEventListener(M,B){const g=this.events[M];if(!g)return!1;for(let O=g.length;O--;)if(g[O]===B)return g.splice(O,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}b.FlMML=p,b.FlMMLonHTML5=p}).apply(i,h))===void 0||(t.exports=u)},158:(t,i,m)=>{m.r(i),m.d(i,{FlMMLWorkletScript:()=>h});const h='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},a={};function o(t){var i=a[t];if(i!==void 0)return i.exports;var m=a[t]={exports:{}};return r[t].call(m.exports,m,m.exports,o),m.exports}return o.d=(t,i)=>{for(var m in i)o.o(i,m)&&!o.o(t,m)&&Object.defineProperty(t,m,{enumerable:!0,get:i[m]})},o.o=(t,i)=>Object.prototype.hasOwnProperty.call(t,i),o.r=t=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o(643)})()})})(fr);var mr=fr.exports;function Tt(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var hr={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(r){n.exports=r()})(function(){return function r(a,o,t){function i(u,E){if(!o[u]){if(!a[u]){var f=typeof Tt=="function"&&Tt;if(!E&&f)return f(u,!0);if(m)return m(u,!0);var b=new Error("Cannot find module '"+u+"'");throw b.code="MODULE_NOT_FOUND",b}var w=o[u]={exports:{}};a[u][0].call(w.exports,function(N){var _=a[u][1][N];return i(_||N)},w,w.exports,r,a,o,t)}return o[u].exports}for(var m=typeof Tt=="function"&&Tt,h=0;h<t.length;h++)i(t[h]);return i}({1:[function(r,a,o){(function(t){var i=t.MutationObserver||t.WebKitMutationObserver,m;if(i){var h=0,u=new i(N),E=t.document.createTextNode("");u.observe(E,{characterData:!0}),m=function(){E.data=h=++h%2}}else if(!t.setImmediate&&typeof t.MessageChannel<"u"){var f=new t.MessageChannel;f.port1.onmessage=N,m=function(){f.port2.postMessage(0)}}else"document"in t&&"onreadystatechange"in t.document.createElement("script")?m=function(){var l=t.document.createElement("script");l.onreadystatechange=function(){N(),l.onreadystatechange=null,l.parentNode.removeChild(l),l=null},t.document.documentElement.appendChild(l)}:m=function(){setTimeout(N,0)};var b,w=[];function N(){b=!0;for(var l,p,A=w.length;A;){for(p=w,w=[],l=-1;++l<A;)p[l]();A=w.length}b=!1}a.exports=_;function _(l){w.push(l)===1&&!b&&m()}}).call(this,typeof dt<"u"?dt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,a,o){var t=r(1);function i(){}var m={},h=["REJECTED"],u=["FULFILLED"],E=["PENDING"];a.exports=f;function f(g){if(typeof g!="function")throw new TypeError("resolver must be a function");this.state=E,this.queue=[],this.outcome=void 0,g!==i&&_(this,g)}f.prototype.catch=function(g){return this.then(null,g)},f.prototype.then=function(g,O){if(typeof g!="function"&&this.state===u||typeof O!="function"&&this.state===h)return this;var $=new this.constructor(i);if(this.state!==E){var q=this.state===u?g:O;w($,q,this.outcome)}else this.queue.push(new b($,g,O));return $};function b(g,O,$){this.promise=g,typeof O=="function"&&(this.onFulfilled=O,this.callFulfilled=this.otherCallFulfilled),typeof $=="function"&&(this.onRejected=$,this.callRejected=this.otherCallRejected)}b.prototype.callFulfilled=function(g){m.resolve(this.promise,g)},b.prototype.otherCallFulfilled=function(g){w(this.promise,this.onFulfilled,g)},b.prototype.callRejected=function(g){m.reject(this.promise,g)},b.prototype.otherCallRejected=function(g){w(this.promise,this.onRejected,g)};function w(g,O,$){t(function(){var q;try{q=O($)}catch(oe){return m.reject(g,oe)}q===g?m.reject(g,new TypeError("Cannot resolve promise with itself")):m.resolve(g,q)})}m.resolve=function(g,O){var $=l(N,O);if($.status==="error")return m.reject(g,$.value);var q=$.value;if(q)_(g,q);else{g.state=u,g.outcome=O;for(var oe=-1,se=g.queue.length;++oe<se;)g.queue[oe].callFulfilled(O)}return g},m.reject=function(g,O){g.state=h,g.outcome=O;for(var $=-1,q=g.queue.length;++$<q;)g.queue[$].callRejected(O);return g};function N(g){var O=g&&g.then;if(g&&(typeof g=="object"||typeof g=="function")&&typeof O=="function")return function(){O.apply(g,arguments)}}function _(g,O){var $=!1;function q(ge){$||($=!0,m.reject(g,ge))}function oe(ge){$||($=!0,m.resolve(g,ge))}function se(){O(oe,q)}var me=l(se);me.status==="error"&&q(me.value)}function l(g,O){var $={};try{$.value=g(O),$.status="success"}catch(q){$.status="error",$.value=q}return $}f.resolve=p;function p(g){return g instanceof this?g:m.resolve(new this(i),g)}f.reject=A;function A(g){var O=new this(i);return m.reject(O,g)}f.all=M;function M(g){var O=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var $=g.length,q=!1;if(!$)return this.resolve([]);for(var oe=new Array($),se=0,me=-1,ge=new this(i);++me<$;)fe(g[me],me);return ge;function fe(I,k){O.resolve(I).then(V,function(Y){q||(q=!0,m.reject(ge,Y))});function V(Y){oe[k]=Y,++se===$&&!q&&(q=!0,m.resolve(ge,oe))}}}f.race=B;function B(g){var O=this;if(Object.prototype.toString.call(g)!=="[object Array]")return this.reject(new TypeError("must be an array"));var $=g.length,q=!1;if(!$)return this.resolve([]);for(var oe=-1,se=new this(i);++oe<$;)me(g[oe]);return se;function me(ge){O.resolve(ge).then(function(fe){q||(q=!0,m.resolve(se,fe))},function(fe){q||(q=!0,m.reject(se,fe))})}}},{1:1}],3:[function(r,a,o){(function(t){typeof t.Promise!="function"&&(t.Promise=r(2))}).call(this,typeof dt<"u"?dt:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,a,o){var t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s};function i(s,d){if(!(s instanceof d))throw new TypeError("Cannot call a class as a function")}function m(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var h=m();function u(){try{if(!h||!h.open)return!1;var s=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),d=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!s||d)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function E(s,d){s=s||[],d=d||{};try{return new Blob(s,d)}catch(v){if(v.name!=="TypeError")throw v;for(var c=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,y=new c,S=0;S<s.length;S+=1)y.append(s[S]);return y.getBlob(d.type)}}typeof Promise>"u"&&r(3);var f=Promise;function b(s,d){d&&s.then(function(c){d(null,c)},function(c){d(c)})}function w(s,d,c){typeof d=="function"&&s.then(d),typeof c=="function"&&s.catch(c)}function N(s){return typeof s!="string"&&(console.warn(s+" used as a key, but it is not a string."),s=String(s)),s}function _(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var l="local-forage-detect-blob-support",p=void 0,A={},M=Object.prototype.toString,B="readonly",g="readwrite";function O(s){for(var d=s.length,c=new ArrayBuffer(d),y=new Uint8Array(c),S=0;S<d;S++)y[S]=s.charCodeAt(S);return c}function $(s){return new f(function(d){var c=s.transaction(l,g),y=E([""]);c.objectStore(l).put(y,"key"),c.onabort=function(S){S.preventDefault(),S.stopPropagation(),d(!1)},c.oncomplete=function(){var S=navigator.userAgent.match(/Chrome\/(\d+)/),v=navigator.userAgent.match(/Edge\//);d(v||!S||parseInt(S[1],10)>=43)}}).catch(function(){return!1})}function q(s){return typeof p=="boolean"?f.resolve(p):$(s).then(function(d){return p=d,p})}function oe(s){var d=A[s.name],c={};c.promise=new f(function(y,S){c.resolve=y,c.reject=S}),d.deferredOperations.push(c),d.dbReady?d.dbReady=d.dbReady.then(function(){return c.promise}):d.dbReady=c.promise}function se(s){var d=A[s.name],c=d.deferredOperations.pop();if(c)return c.resolve(),c.promise}function me(s,d){var c=A[s.name],y=c.deferredOperations.pop();if(y)return y.reject(d),y.promise}function ge(s,d){return new f(function(c,y){if(A[s.name]=A[s.name]||J(),s.db)if(d)oe(s),s.db.close();else return c(s.db);var S=[s.name];d&&S.push(s.version);var v=h.open.apply(h,S);d&&(v.onupgradeneeded=function(C){var L=v.result;try{L.createObjectStore(s.storeName),C.oldVersion<=1&&L.createObjectStore(l)}catch(P){if(P.name==="ConstraintError")console.warn('The database "'+s.name+'" has been upgraded from version '+C.oldVersion+" to version "+C.newVersion+', but the storage "'+s.storeName+'" already exists.');else throw P}}),v.onerror=function(C){C.preventDefault(),y(v.error)},v.onsuccess=function(){var C=v.result;C.onversionchange=function(L){L.target.close()},c(C),se(s)}})}function fe(s){return ge(s,!1)}function I(s){return ge(s,!0)}function k(s,d){if(!s.db)return!0;var c=!s.db.objectStoreNames.contains(s.storeName),y=s.version<s.db.version,S=s.version>s.db.version;if(y&&(s.version!==d&&console.warn('The database "'+s.name+`" can't be downgraded from version `+s.db.version+" to version "+s.version+"."),s.version=s.db.version),S||c){if(c){var v=s.db.version+1;v>s.version&&(s.version=v)}return!0}return!1}function V(s){return new f(function(d,c){var y=new FileReader;y.onerror=c,y.onloadend=function(S){var v=btoa(S.target.result||"");d({__local_forage_encoded_blob:!0,data:v,type:s.type})},y.readAsBinaryString(s)})}function Y(s){var d=O(atob(s.data));return E([d],{type:s.type})}function W(s){return s&&s.__local_forage_encoded_blob}function X(s){var d=this,c=d._initReady().then(function(){var y=A[d._dbInfo.name];if(y&&y.dbReady)return y.dbReady});return w(c,s,s),c}function R(s){oe(s);for(var d=A[s.name],c=d.forages,y=0;y<c.length;y++){var S=c[y];S._dbInfo.db&&(S._dbInfo.db.close(),S._dbInfo.db=null)}return s.db=null,fe(s).then(function(v){return s.db=v,k(s)?I(s):v}).then(function(v){s.db=d.db=v;for(var C=0;C<c.length;C++)c[C]._dbInfo.db=v}).catch(function(v){throw me(s,v),v})}function te(s,d,c,y){y===void 0&&(y=1);try{var S=s.db.transaction(s.storeName,d);c(null,S)}catch(v){if(y>0&&(!s.db||v.name==="InvalidStateError"||v.name==="NotFoundError"))return f.resolve().then(function(){if(!s.db||v.name==="NotFoundError"&&!s.db.objectStoreNames.contains(s.storeName)&&s.version<=s.db.version)return s.db&&(s.version=s.db.version+1),I(s)}).then(function(){return R(s).then(function(){te(s,d,c,y-1)})}).catch(c);c(v)}}function J(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function he(s){var d=this,c={db:null};if(s)for(var y in s)c[y]=s[y];var S=A[c.name];S||(S=J(),A[c.name]=S),S.forages.push(d),d._initReady||(d._initReady=d.ready,d.ready=X);var v=[];function C(){return f.resolve()}for(var L=0;L<S.forages.length;L++){var P=S.forages[L];P!==d&&v.push(P._initReady().catch(C))}var j=S.forages.slice(0);return f.all(v).then(function(){return c.db=S.db,fe(c)}).then(function(U){return c.db=U,k(c,d._defaultConfig.version)?I(c):U}).then(function(U){c.db=S.db=U,d._dbInfo=c;for(var z=0;z<j.length;z++){var ee=j[z];ee!==d&&(ee._dbInfo.db=c.db,ee._dbInfo.version=c.version)}})}function Te(s,d){var c=this;s=N(s);var y=new f(function(S,v){c.ready().then(function(){te(c._dbInfo,B,function(C,L){if(C)return v(C);try{var P=L.objectStore(c._dbInfo.storeName),j=P.get(s);j.onsuccess=function(){var U=j.result;U===void 0&&(U=null),W(U)&&(U=Y(U)),S(U)},j.onerror=function(){v(j.error)}}catch(U){v(U)}})}).catch(v)});return b(y,d),y}function Ie(s,d){var c=this,y=new f(function(S,v){c.ready().then(function(){te(c._dbInfo,B,function(C,L){if(C)return v(C);try{var P=L.objectStore(c._dbInfo.storeName),j=P.openCursor(),U=1;j.onsuccess=function(){var z=j.result;if(z){var ee=z.value;W(ee)&&(ee=Y(ee));var ie=s(ee,z.key,U++);ie!==void 0?S(ie):z.continue()}else S()},j.onerror=function(){v(j.error)}}catch(z){v(z)}})}).catch(v)});return b(y,d),y}function x(s,d,c){var y=this;s=N(s);var S=new f(function(v,C){var L;y.ready().then(function(){return L=y._dbInfo,M.call(d)==="[object Blob]"?q(L.db).then(function(P){return P?d:V(d)}):d}).then(function(P){te(y._dbInfo,g,function(j,U){if(j)return C(j);try{var z=U.objectStore(y._dbInfo.storeName);P===null&&(P=void 0);var ee=z.put(P,s);U.oncomplete=function(){P===void 0&&(P=null),v(P)},U.onabort=U.onerror=function(){var ie=ee.error?ee.error:ee.transaction.error;C(ie)}}catch(ie){C(ie)}})}).catch(C)});return b(S,c),S}function F(s,d){var c=this;s=N(s);var y=new f(function(S,v){c.ready().then(function(){te(c._dbInfo,g,function(C,L){if(C)return v(C);try{var P=L.objectStore(c._dbInfo.storeName),j=P.delete(s);L.oncomplete=function(){S()},L.onerror=function(){v(j.error)},L.onabort=function(){var U=j.error?j.error:j.transaction.error;v(U)}}catch(U){v(U)}})}).catch(v)});return b(y,d),y}function H(s){var d=this,c=new f(function(y,S){d.ready().then(function(){te(d._dbInfo,g,function(v,C){if(v)return S(v);try{var L=C.objectStore(d._dbInfo.storeName),P=L.clear();C.oncomplete=function(){y()},C.onabort=C.onerror=function(){var j=P.error?P.error:P.transaction.error;S(j)}}catch(j){S(j)}})}).catch(S)});return b(c,s),c}function G(s){var d=this,c=new f(function(y,S){d.ready().then(function(){te(d._dbInfo,B,function(v,C){if(v)return S(v);try{var L=C.objectStore(d._dbInfo.storeName),P=L.count();P.onsuccess=function(){y(P.result)},P.onerror=function(){S(P.error)}}catch(j){S(j)}})}).catch(S)});return b(c,s),c}function Z(s,d){var c=this,y=new f(function(S,v){if(s<0){S(null);return}c.ready().then(function(){te(c._dbInfo,B,function(C,L){if(C)return v(C);try{var P=L.objectStore(c._dbInfo.storeName),j=!1,U=P.openKeyCursor();U.onsuccess=function(){var z=U.result;if(!z){S(null);return}s===0||j?S(z.key):(j=!0,z.advance(s))},U.onerror=function(){v(U.error)}}catch(z){v(z)}})}).catch(v)});return b(y,d),y}function ne(s){var d=this,c=new f(function(y,S){d.ready().then(function(){te(d._dbInfo,B,function(v,C){if(v)return S(v);try{var L=C.objectStore(d._dbInfo.storeName),P=L.openKeyCursor(),j=[];P.onsuccess=function(){var U=P.result;if(!U){y(j);return}j.push(U.key),U.continue()},P.onerror=function(){S(P.error)}}catch(U){S(U)}})}).catch(S)});return b(c,s),c}function we(s,d){d=_.apply(this,arguments);var c=this.config();s=typeof s!="function"&&s||{},s.name||(s.name=s.name||c.name,s.storeName=s.storeName||c.storeName);var y=this,S;if(!s.name)S=f.reject("Invalid arguments");else{var v=s.name===c.name&&y._dbInfo.db,C=v?f.resolve(y._dbInfo.db):fe(s).then(function(L){var P=A[s.name],j=P.forages;P.db=L;for(var U=0;U<j.length;U++)j[U]._dbInfo.db=L;return L});s.storeName?S=C.then(function(L){if(L.objectStoreNames.contains(s.storeName)){var P=L.version+1;oe(s);var j=A[s.name],U=j.forages;L.close();for(var z=0;z<U.length;z++){var ee=U[z];ee._dbInfo.db=null,ee._dbInfo.version=P}var ie=new f(function(ce,ye){var pe=h.open(s.name,P);pe.onerror=function(Ce){var lt=pe.result;lt.close(),ye(Ce)},pe.onupgradeneeded=function(){var Ce=pe.result;Ce.deleteObjectStore(s.storeName)},pe.onsuccess=function(){var Ce=pe.result;Ce.close(),ce(Ce)}});return ie.then(function(ce){j.db=ce;for(var ye=0;ye<U.length;ye++){var pe=U[ye];pe._dbInfo.db=ce,se(pe._dbInfo)}}).catch(function(ce){throw(me(s,ce)||f.resolve()).catch(function(){}),ce})}}):S=C.then(function(L){oe(s);var P=A[s.name],j=P.forages;L.close();for(var U=0;U<j.length;U++){var z=j[U];z._dbInfo.db=null}var ee=new f(function(ie,ce){var ye=h.deleteDatabase(s.name);ye.onerror=function(){var pe=ye.result;pe&&pe.close(),ce(ye.error)},ye.onblocked=function(){console.warn('dropInstance blocked for database "'+s.name+'" until all open connections are closed')},ye.onsuccess=function(){var pe=ye.result;pe&&pe.close(),ie(pe)}});return ee.then(function(ie){P.db=ie;for(var ce=0;ce<j.length;ce++){var ye=j[ce];se(ye._dbInfo)}}).catch(function(ie){throw(me(s,ie)||f.resolve()).catch(function(){}),ie})})}return b(S,d),S}var Qe={_driver:"asyncStorage",_initStorage:he,_support:u(),iterate:Ie,getItem:Te,setItem:x,removeItem:F,clear:H,length:G,key:Z,keys:ne,dropInstance:we};function Fr(){return typeof openDatabase=="function"}var Ue="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",$r="~~local_forage_type~",Bn=/^~~local_forage_type~([^~]+)~/,St="__lfsc__:",Xt=St.length,Qt="arbf",Zt="blob",Rn="si08",Fn="ui08",$n="uic8",Un="si16",Vn="si32",Wn="ur16",zn="ui32",Hn="fl32",qn="fl64",Yn=Xt+Qt.length,Gn=Object.prototype.toString;function Kn(s){var d=s.length*.75,c=s.length,y,S=0,v,C,L,P;s[s.length-1]==="="&&(d--,s[s.length-2]==="="&&d--);var j=new ArrayBuffer(d),U=new Uint8Array(j);for(y=0;y<c;y+=4)v=Ue.indexOf(s[y]),C=Ue.indexOf(s[y+1]),L=Ue.indexOf(s[y+2]),P=Ue.indexOf(s[y+3]),U[S++]=v<<2|C>>4,U[S++]=(C&15)<<4|L>>2,U[S++]=(L&3)<<6|P&63;return j}function en(s){var d=new Uint8Array(s),c="",y;for(y=0;y<d.length;y+=3)c+=Ue[d[y]>>2],c+=Ue[(d[y]&3)<<4|d[y+1]>>4],c+=Ue[(d[y+1]&15)<<2|d[y+2]>>6],c+=Ue[d[y+2]&63];return d.length%3===2?c=c.substring(0,c.length-1)+"=":d.length%3===1&&(c=c.substring(0,c.length-2)+"=="),c}function Ur(s,d){var c="";if(s&&(c=Gn.call(s)),s&&(c==="[object ArrayBuffer]"||s.buffer&&Gn.call(s.buffer)==="[object ArrayBuffer]")){var y,S=St;s instanceof ArrayBuffer?(y=s,S+=Qt):(y=s.buffer,c==="[object Int8Array]"?S+=Rn:c==="[object Uint8Array]"?S+=Fn:c==="[object Uint8ClampedArray]"?S+=$n:c==="[object Int16Array]"?S+=Un:c==="[object Uint16Array]"?S+=Wn:c==="[object Int32Array]"?S+=Vn:c==="[object Uint32Array]"?S+=zn:c==="[object Float32Array]"?S+=Hn:c==="[object Float64Array]"?S+=qn:d(new Error("Failed to get type for BinaryArray"))),d(S+en(y))}else if(c==="[object Blob]"){var v=new FileReader;v.onload=function(){var C=$r+s.type+"~"+en(this.result);d(St+Zt+C)},v.readAsArrayBuffer(s)}else try{d(JSON.stringify(s))}catch(C){console.error("Couldn't convert value into a JSON string: ",s),d(null,C)}}function Vr(s){if(s.substring(0,Xt)!==St)return JSON.parse(s);var d=s.substring(Yn),c=s.substring(Xt,Yn),y;if(c===Zt&&Bn.test(d)){var S=d.match(Bn);y=S[1],d=d.substring(S[0].length)}var v=Kn(d);switch(c){case Qt:return v;case Zt:return E([v],{type:y});case Rn:return new Int8Array(v);case Fn:return new Uint8Array(v);case $n:return new Uint8ClampedArray(v);case Un:return new Int16Array(v);case Wn:return new Uint16Array(v);case Vn:return new Int32Array(v);case zn:return new Uint32Array(v);case Hn:return new Float32Array(v);case qn:return new Float64Array(v);default:throw new Error("Unkown type: "+c)}}var tn={serialize:Ur,deserialize:Vr,stringToBuffer:Kn,bufferToString:en};function Jn(s,d,c,y){s.executeSql("CREATE TABLE IF NOT EXISTS "+d.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],c,y)}function Wr(s){var d=this,c={db:null};if(s)for(var y in s)c[y]=typeof s[y]!="string"?s[y].toString():s[y];var S=new f(function(v,C){try{c.db=openDatabase(c.name,String(c.version),c.description,c.size)}catch(L){return C(L)}c.db.transaction(function(L){Jn(L,c,function(){d._dbInfo=c,v()},function(P,j){C(j)})},C)});return c.serializer=tn,S}function Ve(s,d,c,y,S,v){s.executeSql(c,y,S,function(C,L){L.code===L.SYNTAX_ERR?C.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[d.storeName],function(P,j){j.rows.length?v(P,L):Jn(P,d,function(){P.executeSql(c,y,S,v)},v)},v):v(C,L)},v)}function zr(s,d){var c=this;s=N(s);var y=new f(function(S,v){c.ready().then(function(){var C=c._dbInfo;C.db.transaction(function(L){Ve(L,C,"SELECT * FROM "+C.storeName+" WHERE key = ? LIMIT 1",[s],function(P,j){var U=j.rows.length?j.rows.item(0).value:null;U&&(U=C.serializer.deserialize(U)),S(U)},function(P,j){v(j)})})}).catch(v)});return b(y,d),y}function Hr(s,d){var c=this,y=new f(function(S,v){c.ready().then(function(){var C=c._dbInfo;C.db.transaction(function(L){Ve(L,C,"SELECT * FROM "+C.storeName,[],function(P,j){for(var U=j.rows,z=U.length,ee=0;ee<z;ee++){var ie=U.item(ee),ce=ie.value;if(ce&&(ce=C.serializer.deserialize(ce)),ce=s(ce,ie.key,ee+1),ce!==void 0){S(ce);return}}S()},function(P,j){v(j)})})}).catch(v)});return b(y,d),y}function Xn(s,d,c,y){var S=this;s=N(s);var v=new f(function(C,L){S.ready().then(function(){d===void 0&&(d=null);var P=d,j=S._dbInfo;j.serializer.serialize(d,function(U,z){z?L(z):j.db.transaction(function(ee){Ve(ee,j,"INSERT OR REPLACE INTO "+j.storeName+" (key, value) VALUES (?, ?)",[s,U],function(){C(P)},function(ie,ce){L(ce)})},function(ee){if(ee.code===ee.QUOTA_ERR){if(y>0){C(Xn.apply(S,[s,P,c,y-1]));return}L(ee)}})})}).catch(L)});return b(v,c),v}function qr(s,d,c){return Xn.apply(this,[s,d,c,1])}function Yr(s,d){var c=this;s=N(s);var y=new f(function(S,v){c.ready().then(function(){var C=c._dbInfo;C.db.transaction(function(L){Ve(L,C,"DELETE FROM "+C.storeName+" WHERE key = ?",[s],function(){S()},function(P,j){v(j)})})}).catch(v)});return b(y,d),y}function Gr(s){var d=this,c=new f(function(y,S){d.ready().then(function(){var v=d._dbInfo;v.db.transaction(function(C){Ve(C,v,"DELETE FROM "+v.storeName,[],function(){y()},function(L,P){S(P)})})}).catch(S)});return b(c,s),c}function Kr(s){var d=this,c=new f(function(y,S){d.ready().then(function(){var v=d._dbInfo;v.db.transaction(function(C){Ve(C,v,"SELECT COUNT(key) as c FROM "+v.storeName,[],function(L,P){var j=P.rows.item(0).c;y(j)},function(L,P){S(P)})})}).catch(S)});return b(c,s),c}function Jr(s,d){var c=this,y=new f(function(S,v){c.ready().then(function(){var C=c._dbInfo;C.db.transaction(function(L){Ve(L,C,"SELECT key FROM "+C.storeName+" WHERE id = ? LIMIT 1",[s+1],function(P,j){var U=j.rows.length?j.rows.item(0).key:null;S(U)},function(P,j){v(j)})})}).catch(v)});return b(y,d),y}function Xr(s){var d=this,c=new f(function(y,S){d.ready().then(function(){var v=d._dbInfo;v.db.transaction(function(C){Ve(C,v,"SELECT key FROM "+v.storeName,[],function(L,P){for(var j=[],U=0;U<P.rows.length;U++)j.push(P.rows.item(U).key);y(j)},function(L,P){S(P)})})}).catch(S)});return b(c,s),c}function Qr(s){return new f(function(d,c){s.transaction(function(y){y.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(S,v){for(var C=[],L=0;L<v.rows.length;L++)C.push(v.rows.item(L).name);d({db:s,storeNames:C})},function(S,v){c(v)})},function(y){c(y)})})}function Zr(s,d){d=_.apply(this,arguments);var c=this.config();s=typeof s!="function"&&s||{},s.name||(s.name=s.name||c.name,s.storeName=s.storeName||c.storeName);var y=this,S;return s.name?S=new f(function(v){var C;s.name===c.name?C=y._dbInfo.db:C=openDatabase(s.name,"","",0),s.storeName?v({db:C,storeNames:[s.storeName]}):v(Qr(C))}).then(function(v){return new f(function(C,L){v.db.transaction(function(P){function j(ie){return new f(function(ce,ye){P.executeSql("DROP TABLE IF EXISTS "+ie,[],function(){ce()},function(pe,Ce){ye(Ce)})})}for(var U=[],z=0,ee=v.storeNames.length;z<ee;z++)U.push(j(v.storeNames[z]));f.all(U).then(function(){C()}).catch(function(ie){L(ie)})},function(P){L(P)})})}):S=f.reject("Invalid arguments"),b(S,d),S}var ea={_driver:"webSQLStorage",_initStorage:Wr,_support:Fr(),iterate:Hr,getItem:zr,setItem:qr,removeItem:Yr,clear:Gr,length:Kr,key:Jr,keys:Xr,dropInstance:Zr};function ta(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function Qn(s,d){var c=s.name+"/";return s.storeName!==d.storeName&&(c+=s.storeName+"/"),c}function na(){var s="_localforage_support_test";try{return localStorage.setItem(s,!0),localStorage.removeItem(s),!1}catch{return!0}}function ra(){return!na()||localStorage.length>0}function aa(s){var d=this,c={};if(s)for(var y in s)c[y]=s[y];return c.keyPrefix=Qn(s,d._defaultConfig),ra()?(d._dbInfo=c,c.serializer=tn,f.resolve()):f.reject()}function oa(s){var d=this,c=d.ready().then(function(){for(var y=d._dbInfo.keyPrefix,S=localStorage.length-1;S>=0;S--){var v=localStorage.key(S);v.indexOf(y)===0&&localStorage.removeItem(v)}});return b(c,s),c}function sa(s,d){var c=this;s=N(s);var y=c.ready().then(function(){var S=c._dbInfo,v=localStorage.getItem(S.keyPrefix+s);return v&&(v=S.serializer.deserialize(v)),v});return b(y,d),y}function ia(s,d){var c=this,y=c.ready().then(function(){for(var S=c._dbInfo,v=S.keyPrefix,C=v.length,L=localStorage.length,P=1,j=0;j<L;j++){var U=localStorage.key(j);if(U.indexOf(v)===0){var z=localStorage.getItem(U);if(z&&(z=S.serializer.deserialize(z)),z=s(z,U.substring(C),P++),z!==void 0)return z}}});return b(y,d),y}function ca(s,d){var c=this,y=c.ready().then(function(){var S=c._dbInfo,v;try{v=localStorage.key(s)}catch{v=null}return v&&(v=v.substring(S.keyPrefix.length)),v});return b(y,d),y}function la(s){var d=this,c=d.ready().then(function(){for(var y=d._dbInfo,S=localStorage.length,v=[],C=0;C<S;C++){var L=localStorage.key(C);L.indexOf(y.keyPrefix)===0&&v.push(L.substring(y.keyPrefix.length))}return v});return b(c,s),c}function ua(s){var d=this,c=d.keys().then(function(y){return y.length});return b(c,s),c}function da(s,d){var c=this;s=N(s);var y=c.ready().then(function(){var S=c._dbInfo;localStorage.removeItem(S.keyPrefix+s)});return b(y,d),y}function fa(s,d,c){var y=this;s=N(s);var S=y.ready().then(function(){d===void 0&&(d=null);var v=d;return new f(function(C,L){var P=y._dbInfo;P.serializer.serialize(d,function(j,U){if(U)L(U);else try{localStorage.setItem(P.keyPrefix+s,j),C(v)}catch(z){(z.name==="QuotaExceededError"||z.name==="NS_ERROR_DOM_QUOTA_REACHED")&&L(z),L(z)}})})});return b(S,c),S}function ma(s,d){if(d=_.apply(this,arguments),s=typeof s!="function"&&s||{},!s.name){var c=this.config();s.name=s.name||c.name,s.storeName=s.storeName||c.storeName}var y=this,S;return s.name?S=new f(function(v){s.storeName?v(Qn(s,y._defaultConfig)):v(s.name+"/")}).then(function(v){for(var C=localStorage.length-1;C>=0;C--){var L=localStorage.key(C);L.indexOf(v)===0&&localStorage.removeItem(L)}}):S=f.reject("Invalid arguments"),b(S,d),S}var ha={_driver:"localStorageWrapper",_initStorage:aa,_support:ta(),iterate:ia,getItem:sa,setItem:fa,removeItem:da,clear:oa,length:ua,key:ca,keys:la,dropInstance:ma},pa=function(d,c){return d===c||typeof d=="number"&&typeof c=="number"&&isNaN(d)&&isNaN(c)},va=function(d,c){for(var y=d.length,S=0;S<y;){if(pa(d[S],c))return!0;S++}return!1},Zn=Array.isArray||function(s){return Object.prototype.toString.call(s)==="[object Array]"},ct={},er={},Ze={INDEXEDDB:Qe,WEBSQL:ea,LOCALSTORAGE:ha},ga=[Ze.INDEXEDDB._driver,Ze.WEBSQL._driver,Ze.LOCALSTORAGE._driver],wt=["dropInstance"],nn=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(wt),ya={description:"",driver:ga.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function ba(s,d){s[d]=function(){var c=arguments;return s.ready().then(function(){return s[d].apply(s,c)})}}function rn(){for(var s=1;s<arguments.length;s++){var d=arguments[s];if(d)for(var c in d)d.hasOwnProperty(c)&&(Zn(d[c])?arguments[0][c]=d[c].slice():arguments[0][c]=d[c])}return arguments[0]}var Ea=function(){function s(d){i(this,s);for(var c in Ze)if(Ze.hasOwnProperty(c)){var y=Ze[c],S=y._driver;this[c]=S,ct[S]||this.defineDriver(y)}this._defaultConfig=rn({},ya),this._config=rn({},this._defaultConfig,d),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return s.prototype.config=function(c){if((typeof c>"u"?"undefined":t(c))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var y in c){if(y==="storeName"&&(c[y]=c[y].replace(/\W/g,"_")),y==="version"&&typeof c[y]!="number")return new Error("Database version must be a number.");this._config[y]=c[y]}return"driver"in c&&c.driver?this.setDriver(this._config.driver):!0}else return typeof c=="string"?this._config[c]:this._config},s.prototype.defineDriver=function(c,y,S){var v=new f(function(C,L){try{var P=c._driver,j=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!c._driver){L(j);return}for(var U=nn.concat("_initStorage"),z=0,ee=U.length;z<ee;z++){var ie=U[z],ce=!va(wt,ie);if((ce||c[ie])&&typeof c[ie]!="function"){L(j);return}}var ye=function(){for(var lt=function(Ta){return function(){var xa=new Error("Method "+Ta+" is not implemented by the current driver"),tr=f.reject(xa);return b(tr,arguments[arguments.length-1]),tr}},an=0,wa=wt.length;an<wa;an++){var on=wt[an];c[on]||(c[on]=lt(on))}};ye();var pe=function(lt){ct[P]&&console.info("Redefining LocalForage driver: "+P),ct[P]=c,er[P]=lt,C()};"_support"in c?c._support&&typeof c._support=="function"?c._support().then(pe,L):pe(!!c._support):pe(!0)}catch(Ce){L(Ce)}});return w(v,y,S),v},s.prototype.driver=function(){return this._driver||null},s.prototype.getDriver=function(c,y,S){var v=ct[c]?f.resolve(ct[c]):f.reject(new Error("Driver not found."));return w(v,y,S),v},s.prototype.getSerializer=function(c){var y=f.resolve(tn);return w(y,c),y},s.prototype.ready=function(c){var y=this,S=y._driverSet.then(function(){return y._ready===null&&(y._ready=y._initDriver()),y._ready});return w(S,c,c),S},s.prototype.setDriver=function(c,y,S){var v=this;Zn(c)||(c=[c]);var C=this._getSupportedDrivers(c);function L(){v._config.driver=v.driver()}function P(z){return v._extend(z),L(),v._ready=v._initStorage(v._config),v._ready}function j(z){return function(){var ee=0;function ie(){for(;ee<z.length;){var ce=z[ee];return ee++,v._dbInfo=null,v._ready=null,v.getDriver(ce).then(P).catch(ie)}L();var ye=new Error("No available storage method found.");return v._driverSet=f.reject(ye),v._driverSet}return ie()}}var U=this._driverSet!==null?this._driverSet.catch(function(){return f.resolve()}):f.resolve();return this._driverSet=U.then(function(){var z=C[0];return v._dbInfo=null,v._ready=null,v.getDriver(z).then(function(ee){v._driver=ee._driver,L(),v._wrapLibraryMethodsWithReady(),v._initDriver=j(C)})}).catch(function(){L();var z=new Error("No available storage method found.");return v._driverSet=f.reject(z),v._driverSet}),w(this._driverSet,y,S),this._driverSet},s.prototype.supports=function(c){return!!er[c]},s.prototype._extend=function(c){rn(this,c)},s.prototype._getSupportedDrivers=function(c){for(var y=[],S=0,v=c.length;S<v;S++){var C=c[S];this.supports(C)&&y.push(C)}return y},s.prototype._wrapLibraryMethodsWithReady=function(){for(var c=0,y=nn.length;c<y;c++)ba(this,nn[c])},s.prototype.createInstance=function(c){return new s(c)},s}(),Sa=new Ea;a.exports=Sa},{3:3}]},{},[4])(4)})})(hr);var Ia=hr.exports;const gn=Na(Ia);function xt(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function ln(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const Ca=1,Da=1,Xe="emoji",ot="keyvalue",Mn="favorites",Ma="tokens",pr="tokens",Aa="unicode",vr="count",La="group",_a="order",gr="group-order",yn="eTag",At="url",nr="skinTone",it="readonly",An="readwrite",yr="skinUnicodes",Oa="skinUnicodes",Pa="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",ja="en";function Ba(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function rr(n){return Ba(n,e=>e.unicode)}function Ra(n){function e(r,a,o){const t=a?n.createObjectStore(r,{keyPath:a}):n.createObjectStore(r);if(o)for(const[i,[m,h]]of Object.entries(o))t.createIndex(i,m,{multiEntry:h});return t}e(ot),e(Xe,Aa,{[pr]:[Ma,!0],[gr]:[[La,_a]],[yr]:[Oa,!0]}),e(Mn,void 0,{[vr]:[""]})}const bn={},Ct={},Lt={};function br(n,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>n(r.result)}async function Fa(n){const e=await new Promise((r,a)=>{const o=indexedDB.open(n,Ca);bn[n]=o,o.onupgradeneeded=t=>{t.oldVersion<Da&&Ra(o.result)},br(r,a,o)});return e.onclose=()=>Ln(n),e}function $a(n){return Ct[n]||(Ct[n]=Fa(n)),Ct[n]}function $e(n,e,r,a){return new Promise((o,t)=>{const i=n.transaction(e,r,{durability:"relaxed"}),m=typeof e=="string"?i.objectStore(e):e.map(u=>i.objectStore(u));let h;a(m,i,u=>{h=u}),i.oncomplete=()=>o(h),i.onerror=()=>t(i.error)})}function Ln(n){const e=bn[n],r=e&&e.result;if(r){r.close();const a=Lt[n];if(a)for(const o of a)o()}delete bn[n],delete Ct[n],delete Lt[n]}function Ua(n){return new Promise((e,r)=>{Ln(n);const a=indexedDB.deleteDatabase(n);br(e,r,a)})}function Va(n,e){let r=Lt[n];r||(r=Lt[n]=[]),r.push(e)}const Wa=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function et(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||Wa.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const za=2;function Er(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=za)}function Ha(n){return n.map(({annotation:r,emoticon:a,group:o,order:t,shortcodes:i,skins:m,tags:h,emoji:u,version:E})=>{const f=[...new Set(Er([...(i||[]).map(et).flat(),...h.map(et).flat(),...et(r),a]))].sort(),b={annotation:r,group:o,order:t,tags:h,tokens:f,unicode:u,version:E};if(a&&(b.emoticon=a),i&&(b.shortcodes=i),m){b.skinTones=[],b.skinUnicodes=[],b.skinVersions=[];for(const{tone:w,emoji:N,version:_}of m)b.skinTones.push(w),b.skinUnicodes.push(N),b.skinVersions.push(_)}return b})}function Sr(n,e,r,a){n[e](r).onsuccess=o=>a&&a(o.target.result)}function Je(n,e,r){Sr(n,"get",e,r)}function wr(n,e,r){Sr(n,"getAll",e,r)}function _n(n){n.commit&&n.commit()}function qa(n,e){let r=n[0];for(let a=1;a<n.length;a++){const o=n[a];e(r)>e(o)&&(r=o)}return r}function Tr(n,e){const r=qa(n,o=>o.length),a=[];for(const o of r)n.some(t=>t.findIndex(i=>e(i)===e(o))===-1)||a.push(o);return a}async function Ya(n){return!await On(n,ot,At)}async function Ga(n,e,r){const[a,o]=await Promise.all([yn,At].map(t=>On(n,ot,t)));return a===r&&o===e}async function Ka(n,e){return $e(n,Xe,it,(a,o,t)=>{let i;const m=()=>{a.getAll(i&&IDBKeyRange.lowerBound(i,!0),50).onsuccess=h=>{const u=h.target.result;for(const E of u)if(i=E.unicode,e(E))return t(E);if(u.length<50)return t();m()}};m()})}async function xr(n,e,r,a){try{const o=Ha(e);await $e(n,[Xe,ot],An,([t,i],m)=>{let h,u,E=0;function f(){++E===2&&b()}function b(){if(!(h===a&&u===r)){t.clear();for(const w of o)t.put(w);i.put(a,yn),i.put(r,At),_n(m)}}Je(i,yn,w=>{h=w,f()}),Je(i,At,w=>{u=w,f()})})}finally{}}async function Ja(n,e){return $e(n,Xe,it,(r,a,o)=>{const t=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);wr(r.index(gr),t,o)})}async function kr(n,e){const r=Er(et(e));return r.length?$e(n,Xe,it,(a,o,t)=>{const i=[],m=()=>{i.length===r.length&&h()},h=()=>{const u=Tr(i,E=>E.unicode);t(u.sort((E,f)=>E.order<f.order?-1:1))};for(let u=0;u<r.length;u++){const E=r[u],f=u===r.length-1?IDBKeyRange.bound(E,E+"￿",!1,!0):IDBKeyRange.only(E);wr(a.index(pr),f,b=>{i.push(b),m()})}}):[]}async function Xa(n,e){const r=await kr(n,e);return r.length?r.filter(a=>(a.shortcodes||[]).map(t=>t.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Ka(n,o=>(o.shortcodes||[]).includes(e.toLowerCase()))||null}async function Qa(n,e){return $e(n,Xe,it,(r,a,o)=>Je(r,e,t=>{if(t)return o(t);Je(r.index(yr),e,i=>o(i||null))}))}function On(n,e,r){return $e(n,e,it,(a,o,t)=>Je(a,r,t))}function Za(n,e,r,a){return $e(n,e,An,(o,t)=>{o.put(a,r),_n(t)})}function eo(n,e){return $e(n,Mn,An,(r,a)=>Je(r,e,o=>{r.put((o||0)+1,e),_n(a)}))}function to(n,e,r){return r===0?[]:$e(n,[Mn,Xe],it,([a,o],t,i)=>{const m=[];a.index(vr).openCursor(void 0,"prev").onsuccess=h=>{const u=h.target.result;if(!u)return i(m);function E(w){if(m.push(w),m.length===r)return i(m);u.continue()}const f=u.primaryKey,b=e.byName(f);if(b)return E(b);Je(o,f,w=>{if(w)return E(w);u.continue()})}})}const kt="";function no(n,e){const r=new Map;for(const o of n){const t=e(o);for(const i of t){let m=r;for(let u=0;u<i.length;u++){const E=i.charAt(u);let f=m.get(E);f||(f=new Map,m.set(E,f)),m=f}let h=m.get(kt);h||(h=[],m.set(kt,h)),h.push(o)}}return(o,t)=>{let i=r;for(let u=0;u<o.length;u++){const E=o.charAt(u),f=i.get(E);if(f)i=f;else return[]}if(t)return i.get(kt)||[];const m=[],h=[i];for(;h.length;){const E=[...h.shift().entries()].sort((f,b)=>f[0]<b[0]?-1:1);for(const[f,b]of E)f===kt?m.push(...b):h.push(b)}return m}}const ro=["name","url"];function ao(n){const e=n&&Array.isArray(n),r=e&&n.length&&(!n[0]||ro.some(a=>!(a in n[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function ar(n){ao(n);const e=(b,w)=>b.name.toLowerCase()<w.name.toLowerCase()?-1:1,r=n.sort(e),o=no(n,b=>[...new Set((b.shortcodes||[]).map(w=>et(w)).flat())]),t=b=>o(b,!0),i=b=>o(b,!1),m=b=>{const w=et(b),N=w.map((_,l)=>(l<w.length-1?t:i)(_));return Tr(N,_=>_.name).sort(e)},h=new Map,u=new Map;for(const b of n){u.set(b.name.toLowerCase(),b);for(const w of b.shortcodes||[])h.set(w.toLowerCase(),b)}return{all:r,search:m,byShortcode:b=>h.get(b.toLowerCase()),byName:b=>u.get(b.toLowerCase())}}const oo=typeof wrappedJSObject<"u";function ut(n){if(!n)return n;if(oo&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let r=0;r<e;r++)n.skins[r]={tone:n.skinTones[r],unicode:n.skinUnicodes[r],version:n.skinVersions[r]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function Nr(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const so=["annotation","emoji","group","order","tags","version"];function io(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||so.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function Ir(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function co(n){const e=await fetch(n,{method:"HEAD"});Ir(e,n);const r=e.headers.get("etag");return Nr(r),r}async function En(n){const e=await fetch(n);Ir(e,n);const r=e.headers.get("etag");Nr(r);const a=await e.json();return io(a),[r,a]}function lo(n){for(var e="",r=new Uint8Array(n),a=r.byteLength,o=-1;++o<a;)e+=String.fromCharCode(r[o]);return e}function uo(n){for(var e=n.length,r=new ArrayBuffer(e),a=new Uint8Array(r),o=-1;++o<e;)a[o]=n.charCodeAt(o);return r}async function Cr(n){const e=JSON.stringify(n);let r=uo(e);const a=await crypto.subtle.digest("SHA-1",r),o=lo(a);return btoa(o)}async function fo(n,e){let r,a=await co(e);if(!a){const o=await En(e);a=o[0],r=o[1],a||(a=await Cr(r))}await Ga(n,e,a)||(r||(r=(await En(e))[1]),await xr(n,r,e,a))}async function mo(n,e){let[r,a]=await En(e);r||(r=await Cr(a)),await xr(n,a,e,r)}class ho{constructor({dataSource:e=Pa,locale:r=ja,customEmoji:a=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=ar(a),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await $a(this._dbName);Va(this._dbName,this._clear);const r=this.dataSource;await Ya(e)?await mo(e,r):this._lazyUpdate=fo(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return ln(e),await this.ready(),rr(await Ja(this._db,e)).map(ut)}async getEmojiBySearchQuery(e){xt(e),await this.ready();const r=this._custom.search(e),a=rr(await kr(this._db,e)).map(ut);return[...r,...a]}async getEmojiByShortcode(e){xt(e),await this.ready();const r=this._custom.byShortcode(e);return r||ut(await Xa(this._db,e))}async getEmojiByUnicodeOrName(e){xt(e),await this.ready();const r=this._custom.byName(e);return r||ut(await Qa(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await On(this._db,ot,nr)||0}async setPreferredSkinTone(e){return ln(e),await this.ready(),Za(this._db,ot,nr,e)}async incrementFavoriteEmojiCount(e){return xt(e),await this.ready(),eo(this._db,e)}async getTopFavoriteEmoji(e){return ln(e),await this.ready(),(await to(this._db,this._custom,e)).map(ut)}set customEmoji(e){this._custom=ar(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await Ln(this._dbName)}async delete(){await this._shutdown(),await Ua(this._dbName)}}const Sn=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([n,e,r])=>({id:n,emoji:e,name:r})),un=Sn.slice(1),po=2,or=6,Dr=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function sr(n){return n.unicode.includes("‍")}const vo={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},go=1e3,yo="🖐️",bo=8,Eo=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],Mr='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',So=(n,e)=>n<e?-1:n>e?1:0,ir=(n,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const a=r.getContext("2d");return a.textBaseline="top",a.font=`100px ${Mr}`,a.fillStyle=e,a.scale(.01,.01),a.fillText(n,0,0),a.getImageData(0,0,1,1).data},wo=(n,e)=>{const r=[...n].join(","),a=[...e].join(",");return r===a&&!r.startsWith("0,0,0,")};function To(n){const e=ir(n,"#000"),r=ir(n,"#fff");return e&&r&&wo(e,r)}function xo(){const n=Object.entries(vo);try{for(const[e,r]of n)if(To(e))return r}catch{}finally{}return n[0][1]}let dn;const fn=()=>(dn||(dn=new Promise(n=>Dr(()=>n(xo())))),dn),wn=new Map,ko="️",No="\uD83C",Io="‍",Co=127995,Do=57339;function Mo(n,e){if(e===0)return n;const r=n.indexOf(Io);return r!==-1?n.substring(0,r)+String.fromCodePoint(Co+e-1)+n.substring(r):(n.endsWith(ko)&&(n=n.substring(0,n.length-1)),n+No+String.fromCodePoint(Do+e-1))}function _e(n){n.preventDefault(),n.stopPropagation()}function mn(n,e,r){return e+=n?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function Ar(n,e){const r=new Set,a=[];for(const o of n){const t=e(o);r.has(t)||(r.add(t),a.push(o))}return a}function Ao(n,e){const r=a=>{const o={};for(const t of a)typeof t.tone=="number"&&t.version<=e&&(o[t.tone]=t.unicode);return o};return n.map(({unicode:a,skins:o,shortcodes:t,url:i,name:m,category:h,annotation:u})=>({unicode:a,name:m,shortcodes:t,url:i,category:h,annotation:u,id:a||m,skins:o&&r(o)}))}const Dt=requestAnimationFrame;let Lo=typeof ResizeObserver=="function";function _o(n,e,r){let a;Lo?(a=new ResizeObserver(o=>r(o[0].contentRect.width)),a.observe(n)):Dt(()=>r(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{a&&a.disconnect()})}function cr(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let hn;function Oo(n,e,r){for(const a of n){const o=r(a),t=cr(o);typeof hn>"u"&&(hn=cr(e));const i=t/1.8<hn;wn.set(a.unicode,i)}}function Po(n){return Ar(n,e=>e)}function jo(n){n&&(n.scrollTop=0)}function mt(n,e,r){let a=n.get(e);return a||(a=r(),n.set(e,a)),a}function lr(n){return""+n}function Bo(n){const e=document.createElement("template");return e.innerHTML=n,e}const Ro=new WeakMap,Fo=new WeakMap,$o=Symbol("un-keyed"),Uo="replaceChildren"in Element.prototype;function Vo(n,e){Uo?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function Wo(n,e){let r=n.firstChild,a=0;for(;r;){if(e[a]!==r)return!0;r=r.nextSibling,a++}return a!==e.length}function zo(n,e){const{targetNode:r}=e;let{targetParentNode:a}=e,o=!1;a?o=Wo(a,n):(o=!0,e.targetNode=void 0,e.targetParentNode=a=r.parentNode),o&&Vo(a,n)}function Ho(n,e){for(const r of e){const{targetNode:a,currentExpression:o,binding:{expressionIndex:t,attributeName:i,attributeValuePre:m,attributeValuePost:h}}=r,u=n[t];if(o!==u)if(r.currentExpression=u,i)a.setAttribute(i,m+lr(u)+h);else{let E;Array.isArray(u)?zo(u,r):u instanceof Element?(E=u,a.replaceWith(E)):a.nodeValue=lr(u),E&&(r.targetNode=E)}}}function qo(n){let e="",r=!1,a=!1,o=-1;const t=new Map,i=[];for(let h=0,u=n.length;h<u;h++){const E=n[h];if(e+=E,h===u-1)break;for(let p=0;p<E.length;p++)switch(E.charAt(p)){case"<":{E.charAt(p+1)==="/"?i.pop():(r=!0,i.push(++o));break}case">":{r=!1,a=!1;break}case"=":{a=!0;break}}const f=i[i.length-1],b=mt(t,f,()=>[]);let w,N,_;if(a){const p=/(\S+)="?([^"=]*)$/.exec(E);w=p[1],N=p[2],_=/^[^">]*/.exec(n[h+1])[0]}const l={attributeName:w,attributeValuePre:N,attributeValuePost:_,expressionIndex:h};b.push(l),!r&&!a&&(e+=" ")}return{template:Bo(e),elementsToBindings:t}}function Yo(n,e){const r=[],a=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let o=n,t=-1;do{const i=e.get(++t);if(i)for(let m=0;m<i.length;m++){const h=i[m],u=h.attributeName?o:o.firstChild,E={binding:h,targetNode:u,targetParentNode:void 0,currentExpression:void 0};r.push(E)}}while(o=a.nextNode());return r}function Go(n){const{template:e,elementsToBindings:r}=mt(Ro,n,()=>qo(n)),a=e.cloneNode(!0).content.firstElementChild,o=Yo(a,r);return function(i){return Ho(i,o),a}}function Ko(n){const e=mt(Fo,n,()=>new Map);let r=$o;function a(t,...i){const m=mt(e,t,()=>new Map);return mt(m,r,()=>Go(t))(i)}function o(t,i,m){return t.map((h,u)=>{const E=r;r=m(h);try{return i(h,u)}finally{r=E}})}return{map:o,html:a}}function Jo(n,e,r,a,o,t,i,m){const{labelWithSkin:h,titleForEmoji:u,unicodeWithSkin:E}=r,{html:f,map:b}=Ko(e);function w(l,p,A){return b(l,(M,B)=>f`<button role="${p?"option":"menuitem"}" aria-selected="${e.searchMode?B===e.activeSearchItem:""}" aria-label="${h(M,e.currentSkinTone)}" title="${u(M)}" class="emoji ${p&&B===e.activeSearchItem?"active":""}" id="${`${A}-${M.id}`}">${M.unicode?E(M,e.currentSkinTone):f`<img class="custom-emoji" src="${M.url}" alt="" loading="lazy">`}</button>`,M=>`${A}-${M.id}`)}const _=f`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${b(e.skinTones,(l,p)=>f`<div id="skintone-${p}" class="emoji ${p===e.activeSkinTone?"active":""}" aria-selected="${p===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[p]}" aria-label="${e.i18n.skinTones[p]}">${l}</div>`,l=>l)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${b(e.groups,l=>f`<button role="tab" class="nav-button" aria-controls="tab-${l.id}" aria-label="${e.i18n.categories[l.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===l.id}" title="${e.i18n.categories[l.name]}" data-group-id="${l.id}"><div class="nav-emoji emoji">${l.emoji}</div></button>`,l=>l.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${b(e.currentEmojisWithCategories,(l,p)=>f`<div><div id="menu-label-${p}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:l.category?l.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${p}" id="${e.searchMode?"search-results":""}">${w(l.emojis,e.searchMode,"emo")}</div></div>`,l=>l.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${w(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(m){n.appendChild(_);const l=(p,A)=>{for(const M of n.querySelectorAll(`[${p}]`))A(M,M.getAttribute(p))};for(const p of["click","focusout","input","keydown","keyup"])l(`data-on-${p}`,(A,M)=>{A.addEventListener(p,a[M])});l("data-ref",(p,A)=>{t[A]=p}),l("data-action",(p,A)=>{o[A](p)}),i.addEventListener("abort",()=>{n.removeChild(_)})}}const _t=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function Xo(n){let e=!1,r;const a=new Map,o=new Set;let t;const i=()=>{if(e)return;const u=[...o];o.clear();try{for(const E of u)E()}finally{t=!1,o.size&&(t=!0,_t(i))}},m=new Proxy({},{get(u,E){if(r){let f=a.get(E);f||(f=new Set,a.set(E,f)),f.add(r)}return u[E]},set(u,E,f){u[E]=f;const b=a.get(E);if(b){for(const w of b)o.add(w);t||(t=!0,_t(i))}return!0}}),h=u=>{const E=()=>{const f=r;r=E;try{return u()}finally{r=f}};return E()};return n.addEventListener("abort",()=>{e=!0}),{state:m,createEffect:h}}function pn(n,e,r){if(n.length!==e.length)return!1;for(let a=0;a<n.length;a++)if(!r(n[a],e[a]))return!1;return!0}const vn=[],{assign:Nt}=Object;function Qo(n,e){const r={},a=new AbortController,o=a.signal,{state:t,createEffect:i}=Xo(o);Nt(t,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),Nt(t,e),Nt(t,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:bo,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:un,databaseLoaded:!1,activeSearchItemId:void 0}),i(()=>{t.currentGroup!==t.groups[t.currentGroupIndex]&&(t.currentGroup=t.groups[t.currentGroupIndex])});const m=x=>{n.getElementById(x).focus()},h=x=>n.getElementById(`emo-${x.id}`),u=(x,F)=>{r.rootElement.dispatchEvent(new CustomEvent(x,{detail:F,bubbles:!0,composed:!0}))},E=(x,F)=>x.id===F.id,f=(x,F)=>{const{category:H,emojis:G}=x,{category:Z,emojis:ne}=F;return H!==Z?!1:pn(G,ne,E)},b=x=>{pn(t.currentEmojis,x,E)||(t.currentEmojis=x)},w=x=>{t.searchMode!==x&&(t.searchMode=x)},N=x=>{pn(t.currentEmojisWithCategories,x,f)||(t.currentEmojisWithCategories=x)},_=(x,F)=>F&&x.skins&&x.skins[F]||x.unicode,A={labelWithSkin:(x,F)=>Po([x.name||_(x,F),x.annotation,...x.shortcodes||vn].filter(Boolean)).join(", "),titleForEmoji:x=>x.annotation||(x.shortcodes||vn).join(", "),unicodeWithSkin:_},M={onClickSkinToneButton:te,onEmojiClick:W,onNavClick:k,onNavKeydown:V,onSearchKeydown:I,onSkinToneOptionsClick:R,onSkinToneOptionsFocusOut:Te,onSkinToneOptionsKeydown:J,onSkinToneOptionsKeyup:he,onSearchInput:Ie},B={calculateEmojiGridStyle:$};let g=!0;i(()=>{Jo(n,t,A,M,B,r,o,g),g=!1}),t.emojiVersion||fn().then(x=>{x||(t.message=t.i18n.emojiUnsupportedMessage)}),i(()=>{async function x(){let F=!1;const H=setTimeout(()=>{F=!0,t.message=t.i18n.loadingMessage},go);try{await t.database.ready(),t.databaseLoaded=!0}catch(G){console.error(G),t.message=t.i18n.networkErrorMessage}finally{clearTimeout(H),F&&(F=!1,t.message="")}}t.database&&x()}),i(()=>{t.pickerStyle=`
      --num-groups: ${t.groups.length}; 
      --indicator-opacity: ${t.searchMode?0:1}; 
      --num-skintones: ${or};`}),i(()=>{t.customEmoji&&t.database&&O()}),i(()=>{t.customEmoji&&t.customEmoji.length?t.groups!==Sn&&(t.groups=Sn):t.groups!==un&&(t.currentGroupIndex&&t.currentGroupIndex--,t.groups=un)}),i(()=>{async function x(){t.databaseLoaded&&(t.currentSkinTone=await t.database.getPreferredSkinTone())}x()}),i(()=>{t.skinTones=Array(or).fill().map((x,F)=>Mo(t.skinToneEmoji,F))}),i(()=>{t.skinToneButtonText=t.skinTones[t.currentSkinTone]}),i(()=>{t.skinToneButtonLabel=t.i18n.skinToneLabel.replace("{skinTone}",t.i18n.skinTones[t.currentSkinTone])}),i(()=>{async function x(){const{database:F}=t,H=(await Promise.all(Eo.map(G=>F.getEmojiByUnicodeOrName(G)))).filter(Boolean);t.defaultFavoriteEmojis=H}t.databaseLoaded&&x()});function O(){t.database.customEmoji=t.customEmoji||vn}i(()=>{async function x(){O();const{database:F,defaultFavoriteEmojis:H,numColumns:G}=t,Z=await F.getTopFavoriteEmoji(G),ne=await me(Ar([...Z,...H],we=>we.unicode||we.name).slice(0,G));t.currentFavorites=ne}t.databaseLoaded&&t.defaultFavoriteEmojis&&x()});function $(x){_o(x,o,F=>{{const H=getComputedStyle(r.rootElement),G=parseInt(H.getPropertyValue("--num-columns"),10),Z=H.getPropertyValue("direction")==="rtl",we=x.parentElement.getBoundingClientRect().width-F;t.numColumns=G,t.scrollbarWidth=we,t.isRtl=Z}})}i(()=>{async function x(){const{searchText:F,currentGroup:H,databaseLoaded:G,customEmoji:Z}=t;if(!G)t.currentEmojis=[],t.searchMode=!1;else if(F.length>=po){const ne=await fe(F);t.searchText===F&&(b(ne),w(!0))}else{const{id:ne}=H;if(ne!==-1||Z&&Z.length){const we=await ge(ne);t.currentGroup.id===ne&&(b(we),w(!1))}}}x()}),i(()=>{const{currentEmojis:x,emojiVersion:F}=t,H=x.filter(G=>G.unicode).filter(G=>sr(G)&&!wn.has(G.unicode));if(!F&&H.length)b(x),Dt(()=>q(H));else{const G=F?x:x.filter(oe);b(G),Dt(()=>jo(r.tabpanelElement))}});function q(x){Oo(x,r.baselineEmoji,h),t.currentEmojis=t.currentEmojis}function oe(x){return!x.unicode||!sr(x)||wn.get(x.unicode)}async function se(x){const F=t.emojiVersion||await fn();return x.filter(({version:H})=>!H||H<=F)}async function me(x){return Ao(x,t.emojiVersion||await fn())}async function ge(x){const F=x===-1?t.customEmoji:await t.database.getEmojiByGroup(x);return me(await se(F))}async function fe(x){return me(await se(await t.database.getEmojiBySearchQuery(x)))}i(()=>{}),i(()=>{function x(){const{searchMode:H,currentEmojis:G}=t;if(H)return[{category:"",emojis:G}];const Z=new Map;for(const ne of G){const we=ne.category||"";let Qe=Z.get(we);Qe||(Qe=[],Z.set(we,Qe)),Qe.push(ne)}return[...Z.entries()].map(([ne,we])=>({category:ne,emojis:we})).sort((ne,we)=>t.customCategorySorting(ne.category,we.category))}const F=x();N(F)}),i(()=>{t.activeSearchItemId=t.activeSearchItem!==-1&&t.currentEmojis[t.activeSearchItem].id}),i(()=>{const{rawSearchText:x}=t;Dr(()=>{t.searchText=(x||"").trim(),t.activeSearchItem=-1})});function I(x){if(!t.searchMode||!t.currentEmojis.length)return;const F=H=>{_e(x),t.activeSearchItem=mn(H,t.activeSearchItem,t.currentEmojis)};switch(x.key){case"ArrowDown":return F(!1);case"ArrowUp":return F(!0);case"Enter":if(t.activeSearchItem===-1)t.activeSearchItem=0;else return _e(x),Y(t.currentEmojis[t.activeSearchItem].id)}}function k(x){const{target:F}=x,H=F.closest(".nav-button");if(!H)return;const G=parseInt(H.dataset.groupId,10);r.searchElement.value="",t.rawSearchText="",t.searchText="",t.activeSearchItem=-1,t.currentGroupIndex=t.groups.findIndex(Z=>Z.id===G)}function V(x){const{target:F,key:H}=x,G=Z=>{Z&&(_e(x),Z.focus())};switch(H){case"ArrowLeft":return G(F.previousElementSibling);case"ArrowRight":return G(F.nextElementSibling);case"Home":return G(F.parentElement.firstElementChild);case"End":return G(F.parentElement.lastElementChild)}}async function Y(x){const F=await t.database.getEmojiByUnicodeOrName(x),H=[...t.currentEmojis,...t.currentFavorites].find(Z=>Z.id===x),G=H.unicode&&_(H,t.currentSkinTone);await t.database.incrementFavoriteEmojiCount(x),u("emoji-click",{emoji:F,skinTone:t.currentSkinTone,...G&&{unicode:G},...H.name&&{name:H.name}})}async function W(x){const{target:F}=x;if(!F.classList.contains("emoji"))return;_e(x);const H=F.id.substring(4);Y(H)}function X(x){t.currentSkinTone=x,t.skinTonePickerExpanded=!1,m("skintone-button"),u("skin-tone-change",{skinTone:x}),t.database.setPreferredSkinTone(x)}function R(x){const{target:{id:F}}=x,H=F&&F.match(/^skintone-(\d)/);if(!H)return;_e(x);const G=parseInt(H[1],10);X(G)}function te(x){t.skinTonePickerExpanded=!t.skinTonePickerExpanded,t.activeSkinTone=t.currentSkinTone,t.skinTonePickerExpanded&&(_e(x),Dt(()=>m("skintone-list")))}i(()=>{t.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{t.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):t.skinTonePickerExpandedAfterAnimation=!1});function J(x){if(!t.skinTonePickerExpanded)return;const F=async H=>{_e(x),t.activeSkinTone=H};switch(x.key){case"ArrowUp":return F(mn(!0,t.activeSkinTone,t.skinTones));case"ArrowDown":return F(mn(!1,t.activeSkinTone,t.skinTones));case"Home":return F(0);case"End":return F(t.skinTones.length-1);case"Enter":return _e(x),X(t.activeSkinTone);case"Escape":return _e(x),t.skinTonePickerExpanded=!1,m("skintone-button")}}function he(x){if(t.skinTonePickerExpanded)switch(x.key){case" ":return _e(x),X(t.activeSkinTone)}}async function Te(x){const{relatedTarget:F}=x;(!F||F.id!=="skintone-list")&&(t.skinTonePickerExpanded=!1)}function Ie(x){t.rawSearchText=x.target.value}return{$set(x){Nt(t,x)},$destroy(){a.abort()}}}const Zo="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",es="en";var ts={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},ns=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const Lr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],rs=`:host{--emoji-font-family:${Mr}}`;class Pn extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=ns+rs,this.shadowRoot.appendChild(r),this._ctx={locale:es,dataSource:Zo,skinToneEmoji:yo,customCategorySorting:So,customEmoji:null,i18n:ts,emojiVersion:null,...e};for(const a of Lr)a!=="database"&&Object.prototype.hasOwnProperty.call(this,a)&&(this._ctx[a]=this[a],delete this[a]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Qo(this.shadowRoot,this._ctx))}disconnectedCallback(){_t(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,a){this._set(e.replace(/-([a-z])/g,(o,t)=>t.toUpperCase()),e==="emoji-version"?parseFloat(a):a)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:a}=this._ctx;(!a||a.locale!==e||a.dataSource!==r)&&this._set("database",new ho({locale:e,dataSource:r}))}_dbFlush(){_t(()=>this._dbCreate())}}const _r={};for(const n of Lr)_r[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(Pn.prototype,_r);customElements.get("emoji-picker")||customElements.define("emoji-picker",Pn);var Tn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(r,a){a(e)})(dt,function(r){var a="dnd-poly-",o=a+"snapback",t="dnd-poly-",i=t+"dragstart-pending",m=t+"dragstart-cancel",h=["none","copy","copyLink","copyMove","link","linkMove","move","all"],u=["none","copy","move","link"],E=function(){var I=!1;try{var k=Object.defineProperty({},"passive",{get:function(){I=!0}});window.addEventListener("test",null,k)}catch{}return I}();function f(I){return I&&I.tagName}function b(I,k,V){V===void 0&&(V=!0),document.addEventListener(I,k,!!E&&{passive:V})}function w(I,k){document.removeEventListener(I,k)}function N(I,k,V,Y){Y===void 0&&(Y=!1);var W=E?{passive:!0,capture:Y}:Y;return I.addEventListener(k,V,W),{off:function(){I.removeEventListener(k,V,W)}}}function _(I){return I.length===0?0:I.reduce(function(k,V){return V+k},0)/I.length}function l(I,k){for(var V=0;V<I.changedTouches.length;V++)if(I.changedTouches[V].identifier===k)return!0;return!1}function p(I,k,V){for(var Y=[],W=[],X=0;X<k.touches.length;X++){var R=k.touches[X];Y.push(R[I+"X"]),W.push(R[I+"Y"])}V.x=_(Y),V.y=_(W)}var A=["","-webkit-"];function M(I,k,V,Y,W){W===void 0&&(W=!0);var X=k.x,R=k.y;Y&&(X+=Y.x,R+=Y.y),W&&(X-=parseInt(I.offsetWidth,10)/2,R-=parseInt(I.offsetHeight,10)/2);for(var te="translate3d("+X+"px,"+R+"px, 0)",J=0;J<A.length;J++){var he=A[J]+"transform";I.style[he]=te+" "+V[J]}}var B=function(){function I(k,V){this.t=k,this.i=V,this.s=u[0]}return Object.defineProperty(I.prototype,"dropEffect",{get:function(){return this.s},set:function(k){this.t.mode!==0&&h.indexOf(k)>-1&&(this.s=k)},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(k){this.t.mode===2&&h.indexOf(k)>-1&&(this.t.effectAllowed=k)},enumerable:!0,configurable:!0}),I.prototype.setData=function(k,V){if(this.t.mode===2){if(k.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[k]=V,this.t.types.indexOf(k)===-1&&this.t.types.push(k)}},I.prototype.getData=function(k){if(this.t.mode===1||this.t.mode===2)return this.t.data[k]||""},I.prototype.clearData=function(k){if(this.t.mode===2){if(k&&this.t.data[k]){delete this.t.data[k];var V=this.t.types.indexOf(k);return void(V>-1&&this.t.types.splice(V,1))}this.t.data={},this.t.types=[]}},I.prototype.setDragImage=function(k,V,Y){this.t.mode===2&&this.i(k,V,Y)},I}();function g(I,k){return I?I===h[0]?u[0]:I.indexOf(h[1])===0||I===h[7]?u[1]:I.indexOf(h[4])===0?u[3]:I===h[6]?u[2]:u[1]:k.nodeType===3&&k.tagName==="A"?u[3]:u[1]}function O(I,k,V,Y,W,X,R){X===void 0&&(X=!0),R===void 0&&(R=null);var te=function(he,Te,Ie,x,F,H,G){G===void 0&&(G=null);var Z=Te.changedTouches[0],ne=new Event(Ie,{bubbles:!0,cancelable:x});ne.dataTransfer=H,ne.relatedTarget=G,ne.screenX=Z.screenX,ne.screenY=Z.screenY,ne.clientX=Z.clientX,ne.clientY=Z.clientY,ne.pageX=Z.pageX,ne.pageY=Z.pageY;var we=he.getBoundingClientRect();return ne.offsetX=ne.clientX-we.left,ne.offsetY=ne.clientY-we.top,ne}(k,V,I,X,document.defaultView,W,R),J=!k.dispatchEvent(te);return Y.mode=0,J}function $(I,k){if(!I||I===h[7])return k;if(k===u[1]){if(I.indexOf(u[1])===0)return u[1]}else if(k===u[3]){if(I.indexOf(u[3])===0||I.indexOf("Link")>-1)return u[3]}else if(k===u[2]&&(I.indexOf(u[2])===0||I.indexOf("Move")>-1))return u[2];return u[0]}var q,oe=function(){function I(k,V,Y,W){this.h=k,this.o=V,this.u=Y,this.l=W,this.v=0,this.p=null,this.g=null,this.m=k,this.I=k.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),b("touchmove",this.j,!1),b("touchend",this.S,!1),b("touchcancel",this.S,!1)}return I.prototype.A=function(){var k=this;this.v=1,this.O=u[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var V=this.u;if(this.N=new B(this.D,function(te,J,he){V=te,typeof J!="number"&&typeof he!="number"||(k.P={x:J||0,y:he||0})}),this.D.mode=2,this.N.dropEffect=u[0],O("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;p("page",this.m,this.F);var Y,W=this.o.dragImageSetup(V);if(this.L=(Y=W,A.map(function(te){var J=Y.style[te+"transform"];return J&&J!=="none"?J.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),W.style.position="absolute",W.style.left="0px",W.style.top="0px",W.style.zIndex="999999",W.classList.add("dnd-poly-drag-image"),W.classList.add("dnd-poly-icon"),this._=W,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var X=getComputedStyle(V);this.P={x:0-parseInt(X.marginLeft,10),y:0-parseInt(X.marginTop,10)}}else{var R=V.getBoundingClientRect();X=getComputedStyle(V),this.P={x:R.left-this.I.clientX-parseInt(X.marginLeft,10)+R.width/2,y:R.top-this.I.clientY-parseInt(X.marginTop,10)+R.height/2}}return M(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){k.X||(k.X=!0,k.Y(),k.X=!1)},this.o.iterationInterval),!0},I.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),w("touchmove",this.j),w("touchend",this.S),w("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},I.prototype.C=function(k){var V=this;if(l(k,this.I.identifier)!==!1){if(this.m=k,this.v===0){var Y=void 0;if(this.o.dragStartConditionOverride)try{Y=this.o.dragStartConditionOverride(k)}catch{Y=!1}else Y=k.touches.length===1;return Y?void(this.A()===!0&&(this.h.preventDefault(),k.preventDefault())):void this.T()}if(k.preventDefault(),p("client",k,this.M),p("page",k,this.F),this.o.dragImageTranslateOverride)try{var W=!1;if(this.o.dragImageTranslateOverride(k,{x:this.M.x,y:this.M.y},this.p,function(X,R){V._&&(W=!0,V.M.x+=X,V.M.y+=R,V.F.x+=X,V.F.y+=R,M(V._,V.F,V.L,V.P,V.o.dragImageCenterOnTouch))}),W)return}catch{}M(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},I.prototype.k=function(k){if(l(k,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(k.preventDefault(),this.v=k.type==="touchcancel"?3:2):this.T()}},I.prototype.Y=function(){var k=this,V=this.O;this.D.mode=3,this.N.dropEffect=u[0];var Y=O("drag",this.u,this.m,this.D,this.N);if(Y&&(this.O=u[0]),Y||this.v===2||this.v===3)return this.q(this.v)?void function(te,J,he,Te){var Ie=getComputedStyle(te);if(Ie.visibility!=="hidden"&&Ie.display!=="none"){J.classList.add(o);var x=getComputedStyle(J),F=parseFloat(x.transitionDuration);if(isNaN(F)||F===0)Te();else{var H=te.getBoundingClientRect(),G={x:H.left,y:H.top};G.x+=document.body.scrollLeft||document.documentElement.scrollLeft,G.y+=document.body.scrollTop||document.documentElement.scrollTop,G.x-=parseInt(Ie.marginLeft,10),G.y-=parseInt(Ie.marginTop,10);var Z=parseFloat(x.transitionDelay),ne=Math.round(1e3*(F+Z));M(J,G,he,void 0,!1),setTimeout(Te,ne)}}else Te()}(this.u,this._,this.L,function(){k.B()}):void this.B();var W=this.o.elementFromPoint(this.M.x,this.M.y),X=this.g;W!==this.p&&W!==this.g&&(this.p=W,this.g!==null&&(this.D.mode=3,this.N.dropEffect=u[0],O("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=g(this.D.effectAllowed,this.u),O("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=$(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),X!==this.g&&f(X)&&(this.D.mode=3,this.N.dropEffect=u[0],O("dragleave",X,this.m,this.D,this.N,!1,this.g)),f(this.g)&&(this.D.mode=3,this.N.dropEffect=g(this.D.effectAllowed,this.u),O("dragover",this.g,this.m,this.D,this.N)===!1?this.O=u[0]:this.O=$(this.N.effectAllowed,this.N.dropEffect)),V!==this.O&&this._.classList.remove(a+V);var R=a+this.O;this._.classList.add(R)},I.prototype.q=function(k){var V=this.O===u[0]||this.g===null||k===3;return V?f(this.g)&&(this.D.mode=3,this.N.dropEffect=u[0],O("dragleave",this.g,this.m,this.D,this.N,!1)):f(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,O("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=u[0]),V},I.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,O("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},I}(),se={iterationInterval:150,tryFindDraggableTarget:function(I){var k=I.target;do if(k.draggable!==!1&&(k.draggable===!0||k.getAttribute&&k.getAttribute("draggable")==="true"))return k;while((k=k.parentNode)&&k!==document.body)},dragImageSetup:function(I){var k=I.cloneNode(!0);return function V(Y,W){if(Y.nodeType===1){for(var X=getComputedStyle(Y),R=0;R<X.length;R++){var te=X[R];W.style.setProperty(te,X.getPropertyValue(te),X.getPropertyPriority(te))}if(W.style.pointerEvents="none",W.removeAttribute("id"),W.removeAttribute("class"),W.removeAttribute("draggable"),W.nodeName==="CANVAS"){var J=Y,he=W,Te=J.getContext("2d").getImageData(0,0,J.width,J.height);he.getContext("2d").putImageData(Te,0,0)}}if(Y.hasChildNodes())for(R=0;R<Y.childNodes.length;R++)V(Y.childNodes[R],W.childNodes[R])}(I,k),k},elementFromPoint:function(I,k){return document.elementFromPoint(I,k)}};function me(I){if(!q){var k=se.tryFindDraggableTarget(I);if(k)try{q=new oe(I,se,k,fe)}catch(V){throw fe(se,I,3),V}}}function ge(I){var k=I.target,V=function(J){W.off(),X.off(),R.off(),te.off(),k&&k.dispatchEvent(new CustomEvent(m,{bubbles:!0,cancelable:!0})),clearTimeout(Y)};k&&k.dispatchEvent(new CustomEvent(i,{bubbles:!0,cancelable:!0}));var Y=window.setTimeout(function(){W.off(),X.off(),R.off(),te.off(),me(I)},se.holdToDrag),W=N(k,"touchend",V),X=N(k,"touchcancel",V),R=N(k,"touchmove",V),te=N(window,"scroll",V,!0)}function fe(I,k,V){if(V===0&&I.defaultActionOverride)try{I.defaultActionOverride(k),k.defaultPrevented}catch{}q=null}r.polyfill=function(I){if(I&&Object.keys(I).forEach(function(W){se[W]=I[W]}),!se.forceApply){var k=(V={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},Y=!!window.chrome||/chrome/i.test(navigator.userAgent),V.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||Y&&"ontouchstart"in document.documentElement),V);if(k.userAgentSupportingNativeDnD&&k.draggable&&k.dragEvents)return!1}var V,Y;return se.holdToDrag?b("touchstart",ge,!1):b("touchstart",me,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(Tn,Tn.exports);var as=Tn.exports;const os=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),ss=n=>n.replace(/\n/g,"<br>"),De=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},is=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let ur;const cs=(n=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),a=()=>{clearTimeout(r),clearTimeout(ur),ur=setTimeout(()=>{n.removeEventListener("scroll",a),e()},100)};n.addEventListener("scroll",a)}),xn=n=>{try{return JSON.parse(n),!0}catch{return!1}},ls="0.6.5 Beta",Ye=document.querySelector(".editor"),de=document.getElementById("tones"),Se=document.getElementById("action"),ae=document.getElementById("musical-score"),Fe=document.getElementById("add-track"),st=document.getElementById("remove-track"),Ge=document.getElementById("dialog"),be=document.forms["dialog-form"];be._title=be.querySelector(".form-title");be.description=be.querySelector(".description");be.inputs=be.querySelector(".inputs");be.buttons=be.querySelector(".buttons");const Ot=document.getElementById("play"),Pt=document.getElementById("clear"),us=document.getElementById("warn-out"),ds=document.getElementById("mml"),Le=document.getElementById("copy"),We=document.getElementById("paste"),qe=document.getElementById("save"),kn=document.getElementById("open"),Jt=document.getElementById("ctrl"),jt=document.getElementById("undo"),Bt=document.getElementById("redo");var pt,ue,Me,tt;class fs{constructor(){le(this,pt,`#COMMENT Generated by FlMML VisualSequencer v${ls}`);le(this,ue,[]);le(this,Me,(e,r)=>{});le(this,tt,(e,r)=>{})}set onChange(e){ke(this,Me,e)}set onError(e){ke(this,tt,e)}setMmlArr(e){ke(this,ue,e),D(this,Me).call(this,this.getMmlArr(),this.getMml())}setMml(e){ke(this,ue,e.split(`
`)),D(this,ue).at(-2)===""&&D(this,ue).at(-1)===D(this,pt)&&D(this,ue).splice(-2,2),D(this,Me).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return D(this,ue)}getMml(){return D(this,ue).length?D(this,ue).concat(["",D(this,pt)]).join(`
`):""}getMmlLine(e){return D(this,ue)[e]}insert(e,r){Object.hasOwn(D(this,ue),e)||e===0?(D(this,ue).splice(e,0,r),D(this,Me).call(this,this.getMmlArr(),this.getMml())):D(this,tt).call(this,"範囲外の書き換え指定",`範囲${D(this,ue).length-1}までのところ、${e}`)}append(e){D(this,ue).push(e),D(this,Me).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(D(this,ue),e)?(D(this,ue)[e]+=r,D(this,Me).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(D(this,ue),e)?(D(this,ue)[e]=r+D(this,ue)[e],D(this,Me).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(D(this,ue),e)?(D(this,ue)[e]=r,D(this,Me).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(D(this,ue),e)&&D(this,ue).splice(e,r).length!==0?D(this,Me).call(this,this.getMmlArr(),this.getMml()):D(this,tt).call(this,"無効な指定",`範囲${D(this,ue).length-1}までの中で${e}から${r}削除するのはできません`)}}pt=new WeakMap,ue=new WeakMap,Me=new WeakMap,tt=new WeakMap;var re,nt,rt,vt,ze,gt,Nn;class ms{constructor(e,r){le(this,gt);le(this,re,[]);le(this,nt,new Set);le(this,rt,[]);le(this,vt,null);le(this,ze,null);this.tonesElem=e,this.areaElem=r,ke(this,ze,this.areaElem.querySelector(".track.active"))}set activeTrack(e){D(this,ze).classList.remove("active"),ke(this,ze,e),D(this,ze).classList.add("active")}get activeTrack(){return D(this,ze)}blocksDataUpdate(){ke(this,re,[...this.areaElem.querySelectorAll(".track button")].map(this.extractBlockData))}extractBlockData(e){return{label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),...e.dataset,elem:e}}saveBlocksData(){clearTimeout(D(this,vt)),ke(this,vt,setTimeout(()=>{const e=JSON.parse(JSON.stringify(D(this,re)));gn.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){gn.getItem("BlocksData").then(e=>{e&&(ke(this,re,e.map(r=>{const a=r.tone;return(a==null?void 0:a.tone)!==void 0&&(a==null?void 0:a.tonePitch)!==void 0&&(r.tone=a.tone,r.tonePitch=a.tonePitch),r})),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Q),this.calcPlayFromHere())})}parseBlocks(){const e=D(this,re);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let a=0;e.forEach(o=>{if(o.trackNo!==a){const E=document.createElement("ul");E.classList.add("track"),this.activeTrack=E,this.areaElem.insertBefore(E,Fe),a=o.trackNo}const t=document.createElement("li"),i='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',m=(()=>{const E=document.createElement("div");return E.innerHTML=i,E.firstElementChild})(),h=document.querySelector(`[class*="${o.className.replace(/ material-icons| droppable| bounce| pop| done| inactive/g,"")}"]`),u=(h==null?void 0:h.cloneNode(!0))||m;o.label&&(u.ariaLabel=o.label),u.className=o.className,o.tonePitch&&(o.label!=="無調整"&&(u.textContent=o.label),u.dataset.tone=o.tone,h?h.replaceWith(u.cloneNode(!0)):r.appendChild(u.cloneNode(!0)),u.dataset.tonePitch=o.tonePitch),o.tempo&&(u.dataset.tempo=o.tempo),o.noteValue&&(u.dataset.noteValue=o.noteValue),o.rest&&(u.dataset.rest=o.rest),o.octave&&(u.dataset.octave=o.octave),o.velocity&&(u.dataset.velocity=o.velocity),o.noteShift&&(u.dataset.noteShift=o.noteShift),o.detune&&(u.dataset.detune=o.detune),o.tieSlur&&(u.dataset.tieSlur=o.tieSlur,o.tieSlur==="&"?u.ariaLabel="スラー":u.ariaLabel="タイ"),o.repeatStartEnd&&(u.dataset.repeatStartEnd=o.repeatStartEnd,o.repeatStartEnd.startsWith("/:")?(u.classList.remove("material-icons"),u.ariaLabel="リピート開始",u.textContent="◆"):o.repeatStartEnd===":/"&&(u.ariaLabel="リピート終了")),o.repeatBreak&&(u.dataset.repeatBreak=o.repeatBreak),o.polyStartEnd&&(u.dataset.polyStartEnd=o.polyStartEnd),o.macroDef&&(u.dataset.macroDef=o.macroDef,o.macroDef===";"?u.textContent=";":u.textContent="$="),o.macroArgUse&&(u.dataset.macroArgUse=o.macroArgUse),o.macroUse&&(u.dataset.macroUse=o.macroUse),o.metaData&&(u.dataset.metaData=o.metaData),o.otherAction&&(u.dataset.otherAction=o.otherAction,u.textContent=o.otherAction.length>4?"…":o.otherAction),t.appendChild(u),this.activeTrack.appendChild(t)})}exportMml(e){e.setMmlArr([]);let r=0,a=0;const o=D(this,re).filter(l=>l.tone!==void 0),t=()=>o.filter(l=>l.trackNo===a),i=()=>new Set(t().map(l=>l.tone));let m=i(),h=0,u=!1,E={noteValue:4,dots:0},f=!1,b=!1;const w=D(this,re).findIndex(l=>l.elem.classList.contains("play-from-here")),N=w!==-1,_=N?D(this,re)[w].trackNo:-1;D(this,re).forEach((l,p)=>{const{tone:A,tonePitch:M}=l,B=!N||b||N&&l.trackNo===_&&p>=w;if(l.trackNo!==a&&(m.size?([...m].forEach((g,O)=>{e.appendToStr(r+O,";")}),r+=m.size):(e.appendToStr(r,";"),r++),a=l.trackNo,m=i(),u=!1,b=!1),A!==void 0)h=[...m].indexOf(A),u||([...m].forEach((g,O)=>{g&&e.beforeInsertToStr(r+O,g+" ")}),u=!0),[...m].forEach((g,O)=>{let $=M||"";O!==h&&($=$.replace(/[a-g]/,f?"*":"r")),B||($=$.replace(/[a-gr*]\+?[0-9]*\.*/i,"")),e.appendToStr(r+O,$)});else if(l.rest||l.tieSlur){let g=l.rest||l.tieSlur;B||(g=g.replace(/[r&]\+?[0-9]*\.*/i,"")),m.size?[...m].forEach((O,$)=>{e.appendToStr(r+$,g)}):e.appendToStr(r,g)}else if(l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd){const g=O=>{if(!O)return E;const $=Number((O.match(/[0-9]+/)||[E.noteValue])[0]),q=(O.match(/\.+/)||[""])[0].length;return{noteValue:$,dots:q}};l.noteValue?E=g(l.noteValue):l.polyStartEnd==="["?f=!0:l.polyStartEnd==="]"&&(f=!1),m.size?[...m].forEach((O,$)=>{if(e.appendToStr(r+$,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||""),l.polyStartEnd==="]"){const q=e.getMmlLine(r+$).match(/\[(.+?)\]/);if(q){const oe=q[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(oe){const se=[...oe].map(fe=>({type:fe[1]==="r"?"rest":fe[1]==="*"?"otherNote":"note",num:g(fe[0])}));se.filter(I=>I.type==="note").map(I=>I.num),se.filter(I=>I.type==="otherNote").map(I=>I.num),se.filter(I=>I.type==="rest").map(I=>I.num);let me=q[0].replace(/\*\+?[0-9]*\.*/g,"");const ge=e.getMmlLine(r+$).replace(/\[.+?\]/,me);e.rewrite(r+$,ge)}}}}):e.appendToStr(r,l.noteValue||l.repeatStartEnd||l.repeatBreak||l.polyStartEnd||"")}else if(l.metaData)l.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,l.metaData.replace(`
`,"")||""),r++;else if(l.macroDef)b=l.macroDef!==";",e.appendToStr(r,l.macroDef||"");else{let g;B?g=M||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.macroArgUse||l.macroUse||l.otherAction||"":g=(M==null?void 0:M.replace(/[a-g]\+?[0-9]*\.*/i,""))||l.tempo||l.octave||l.velocity||l.noteShift||l.detune||l.tieSlur||l.otherAction||"",e.appendToStr(r,g),/;/.test(g)&&(r+=m.size||1,m=i(),u=!1)}}),[...m].slice(0,-1).forEach((l,p)=>{e.appendToStr(r+p,";")})}importMml(e){const r=e.getMmlArr(),a=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_.]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig;D(this,nt).clear();const o=new Set;let t=0,i="",m=!1,h=!1;const u=f=>(f.match(a)||[]).reduce((w,N)=>(N=N.trim(),N&&(l=>{const p={};if(p.tone={},p.trackNo=t,l.startsWith("#")){const A={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};p.label=(Object.entries(A).find(M=>l.startsWith(M[0]))||[,void 0])[1],p.className="meta-data",p.metaData=l+`
`}else if(/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(l)){i=l,o.add(i);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(l)){o.has(i)||o.add(i);const A=[...o].indexOf(i)+1;p.label="無調整",p.className=`material-icons note note-${A}`,p.tone=i,p.tonePitch=l,m&&(h=!0)}else if(l.startsWith("t"))p.className="material-icons tempo",p.tempo=l;else if(l.startsWith("l"))p.className="material-icons note-value",p.noteValue=l;else if(l.startsWith("r"))p.className="material-icons rest",p.rest=l;else if(/^o[0-8]|[><]+$/i.test(l))p.className="material-icons octave",p.octave=l;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(l))p.className="material-icons velocity",p.velocity=l;else if(l.startsWith("@ns")||l.startsWith("ns"))p.className="material-icons note-shift",p.noteShift=l;else if(l.startsWith("@d"))p.className="material-icons detune",p.detune=l;else if(l.startsWith("&"))p.className="tie-slur",p.tieSlur=l;else if(l.startsWith("/*"))p.className="other-action",p.otherAction=l;else if(l.startsWith("/:"))p.className="repeat-start-end",p.repeatStartEnd=l;else if(l.startsWith(":/"))p.className="material-icons repeat-start-end",p.repeatStartEnd=l;else if(l.startsWith("/"))p.className="repeat-break",p.repeatBreak=l;else if(l.startsWith("[")||l.startsWith("]"))p.className="poly-start-end",p.polyStartEnd=l;else if(/^\$.*?=$/.test(l))p.className="macro-def",p.macroDef=l.replaceAll(" ",""),D(this,nt).add(p.macroDef.replace("=","")),m=!0;else if(l.startsWith("%"))p.className="macro-arg-use",p.macroArgUse=l;else if(l.startsWith("$")){p.className="macro-use";const A=l.replace(/\{.*/,""),M=[...D(this,nt)].sort((B,g)=>g.length-B.length).find(B=>A.includes(B));if(M){const B=(l.match(/\{[^\}]*\}/)||[""])[0];p.macroUse=`${M}${B}`,w.push(p);const g=l.replace(M,"");g!==""&&(w=w.concat(u(g)));return}else p.macroUse=l}else if(l.startsWith(";")){if(t++,m&&!h){const A=[...o].join(" ");A&&(p.className="other-action",p.otherAction=A,w.push(p),o.clear())}i="",m=!1,h=!1;return}else p.className="other-action",p.otherAction=l;w.push(p)})(N),w),[]);this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((f,b)=>{b?f.remove():(f.textContent="",this.activeTrack=f)}),K=null;const E=r.map(u).flat();ke(this,re,E),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}get blocksData(){return D(this,re)}set blocksData(e){this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((r,a)=>{a?r.remove():(r.textContent="",this.activeTrack=r)}),K=null,ke(this,re,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData(),this.exportMml(Q),this.calcPlayFromHere()}playRendering(e=-1){const r=D(this,re);if(!r.length)return;const a=e!==-1,o=r[e],t=a?o.trackNo:-1;let i=120,m=0;[de,Se,ae].forEach(N=>{N.classList.add("no-op")});const h=document.querySelector(".wrap"),u=document.getElementsByClassName("track"),f=(h.clientHeight-32)/u.length;[...u].forEach(N=>{N.style.setProperty("--max-height",`${f}px`)}),Fe.disabled=!0,st.disabled=!0;const b=(N,{scoreNoteValue:_=4,ignorePlayFromHere:l=!1}={})=>{var X;let p=!1,A=-1,M=!1,B=!1;const g=[],O=performance.now(),$=(X=N[0])==null?void 0:X.trackNo,q=u[$],oe=m++,se=N.findIndex(R=>R===o);let me=null;const ge=new Promise(R=>me=R);let fe=0,I=0;const k=R=>cn(this,gt,Nn).call(this,{str:R,scoreNoteValue:_}),V=R=>{const te=he=>{!B&&q.scrollTo({top:he,behavior:"smooth"}),B=!0,cs(q).then(()=>{B=!1})},J=he=>q.clientHeight*he;(I===0||R.elem.offsetTop>q.scrollTop+J(.8)||R.elem.offsetTop<q.scrollTop+J(.2))&&te(R.elem.offsetTop-J(.2))},Y=R=>{const te=J=>{const he=J-O,Te=60/i*4/R*1e3;he<fe+Te?D(this,rt)[oe]=requestAnimationFrame(te):(fe+=Te,W())};D(this,rt)[oe]=requestAnimationFrame(te)},W=async()=>{var he,Te,Ie;const R=N[I];if(!R||I>=N.length){me({scoreNoteValue:_});return}V(R);const te=x=>{let F=0;return N.findIndex((H,G)=>{var Z;if(G>x+1){if((Z=H.repeatStartEnd)!=null&&Z.startsWith("/:"))F++;else if(H.repeatStartEnd===":/"){if(F===0)return!0;F--}}return!1})},J=!a||l||a&&R.trackNo===t&&I>=se;if(M){R.macroDef===";"&&(M=!1),I++,W();return}else if(R.tonePitch)if(J&&De(R.elem,"bounce"),I++,p||!J)W();else{const x=k(R.tonePitch);Y(x)}else if(R.rest||R.tieSlur)if(J&&De(R.elem,"pop"),I++,R.tieSlur==="&"||!J)W();else{const x=k(R.rest||R.tieSlur);Y(x)}else if(R.polyStartEnd)if(p=R.polyStartEnd==="[",J&&De(R.elem,"pop"),p||!J)I++,W();else{const x=k(N[I++-1].tonePitch);Y(x)}else if(R.macroDef&&R.macroDef!==";"){M=!0,I++,W();return}else{if(R.tempo&&(i=Number(R.tempo.replace("t",""))||i),R.noteValue&&(_=k(R.noteValue)),(he=R.repeatStartEnd)!=null&&he.startsWith("/:")){g[Te=++A]??(g[Te]={start:I});let x=R.repeatStartEnd.replace("/:","");if(x=x===""?2:Number(x),x)if(g[A].end){if(!g[A].remaining){R.elem.dataset.repeatStartEnd=`/:${g[A].remaining}`,I=g[A].end,W();return}N.slice(g[A].start+1,g[A].end-1).filter(F=>{var H;return(H=F.repeatStartEnd)==null?void 0:H.startsWith("/:")}).forEach(F=>{F.elem.dataset.repeatStartEnd=F.repeatStartEnd})}else g[A].remaining=x;else{I=te(I),W(),J&&(De(R.elem,"pop"),De(R.elem,"done"));return}R.elem.dataset.repeatStartEnd=`/:${g[A].remaining}`}else if(R.repeatBreak){if(g[A].remaining===1){g[A].end||(g[A].end=te(g[A].start)),I=g[A].end,W(),J&&(De(R.elem,"pop"),De(R.elem,"done"));return}}else if(R.repeatStartEnd===":/"){if((Ie=g[A]).end??(Ie.end=I),g[A].remaining){g[A].remaining--,I=g[A].start,A--,W(),J&&(De(R.elem,"pop"),De(R.elem,"done"));return}g.pop(),A--}else if(R.macroUse&&J){const x=H=>{const G=r[H].trackNo;let Z=H+1;for(;r[Z].macroDef!==";"&&r[Z].trackNo===G;)Z++;return Z},F={};if(F.start=r.findIndex(H=>{var G;return(G=H.macroDef)==null?void 0:G.startsWith(R.macroUse)}),F.start>-1){F.end=x(F.start),F.blocks=r.slice(F.start+1,F.end);const H=performance.now();_=(await b(F.blocks,{scoreNoteValue:_,ignorePlayFromHere:!0})).scoreNoteValue;const G=performance.now();fe+=G-H}}I++,W(),J&&De(R.elem,"pop")}J&&De(R.elem,"done")};return W(),ge},w=r.at(-1).trackNo+1;for(let N=0;N<w;N++){const _=r.filter(l=>l.trackNo===N);b(_)}}stopRendering(){[de,Se,ae].forEach(e=>{e.classList.remove("no-op")}),Fe.disabled=!1,st.disabled=!1,D(this,re).forEach(e=>{e.elem.classList.remove("done")}),D(this,re).filter(e=>{var r;return(r=e.repeatStartEnd)==null?void 0:r.startsWith("/:")}).forEach(e=>{e.elem.dataset.repeatStartEnd=e.repeatStartEnd}),D(this,rt).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){if(!D(this,re).length)return;const e=D(this,re).at(-1).trackNo+1;for(let r=0;r<e;r++)D(this,re).filter(o=>o.polyStartEnd&&o.trackNo===r).forEach((o,t)=>{t%2===0?(o.elem.dataset.polyStartEnd="[",o.elem.textContent="["):(o.elem.dataset.polyStartEnd="]",o.elem.textContent="]")});this.blocksDataUpdate()}calcPlayFromHere(){if(!D(this,re).length)return;D(this,re).filter(o=>o.elem.classList.contains("inactive")).forEach(o=>{o.elem.classList.remove("inactive")});const e=D(this,re).find(o=>o.elem.classList.contains("play-from-here"));if(!e){Pe&&(Ne.additionalStartMSec=0),Le.disabled=qe.disabled=!1;return}const r=D(this,re).indexOf(e);if(D(this,re).filter((o,t)=>o.trackNo!==e.trackNo||t<r).forEach(o=>{o.elem.classList.add("inactive")}),Pe){const o=D(this,re).filter((t,i)=>t.trackNo===e.trackNo&&i<r);Ne.additionalStartMSec=(t=>{var i;if(t.length){let m=Number((i=D(this,re).find(N=>N.tempo))==null?void 0:i.tempo.replace("t",""))||120,h=4,u=!1,E=!1;const f=N=>cn(this,gt,Nn).call(this,{str:N,scoreNoteValue:h}),b=(N,_)=>N.reduce((l,p,A)=>{var B;const M=g=>{let O=0;return N.findIndex(($,q)=>{var oe;if(q>g+1){if((oe=$.repeatStartEnd)!=null&&oe.startsWith("/:"))O++;else if($.repeatStartEnd===":/"){if(O===0)return!0;O--}}return!1})};if(E)p.macroDef===";"&&(E=!1);else if(p.tonePitch||p.rest||p.tieSlur){if(u||p.tieSlur==="&")return l;const g=f(p.tonePitch||p.rest||p.tieSlur);return l+60/m*4/g*1e3}else if(p.polyStartEnd){if(u=p.polyStartEnd==="[",u)return l;const g=f(N[A-1].tonePitch);return l+60/m*4/g*1e3}else if(p.macroDef&&p.macroDef!==";")E=!0;else if(p.tempo)m=Number(p.tempo.replace("t",""))||m;else if(p.noteValue)h=f(p.noteValue);else if((B=p.repeatStartEnd)!=null&&B.startsWith("/:")){let g=p.repeatStartEnd.replace("/:","");g=g===""?2:Number(g);let O=M(A);return O===-1&&(O=N.length+1),g?l+b(N.slice(A+1,O-1),!0)*(g-1):l-b(N.slice(A+1,O-1))}else if(p.repeatBreak&&!_){let g=M(A);return g===-1&&(g=N.length+1),l-b(N.slice(A+1,g-1))}else if(p.macroUse){const g={};if(g.start=D(this,re).findIndex(O=>{var $;return($=O.macroDef)==null?void 0:$.startsWith(p.macroUse)}),g.start>-1){const O=$=>{let q=$+1;for(;D(this,re)[q].macroDef!==";"&&D(this,re)[q].trackNo===D(this,re)[$].trackNo;)q++;return q};return g.end=O(g.start),g.blocks=D(this,re).slice(g.start+1,g.end),l+b(g.blocks)}}return l},0);return b(t)}else return 0})(o),console.log(`Skipped playback time: ${Ne.additionalStartMSec} ms`)}Le.disabled=qe.disabled=!0}}re=new WeakMap,nt=new WeakMap,rt=new WeakMap,vt=new WeakMap,ze=new WeakMap,gt=new WeakSet,Nn=function({str:e,scoreNoteValue:r=4}={}){if(!e)return r;const a=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(e),o=a&&a[1]?Number(a[1]):r,t=a?a[2].length:0;return o*2**t/(2**(t+1)-1)};var ve,$t,yt,at;class hs{constructor(){le(this,ve,[[],[]]);le(this,$t,70);le(this,yt,e=>{});le(this,at,e=>{})}set onPushstate(e){ke(this,yt,e)}set onPopstate(e){ke(this,at,e)}pushState(e){D(this,ve)[0].push(e),D(this,yt).call(this,e),D(this,ve)[0].length>D(this,$t)&&D(this,ve)[0].shift(),D(this,ve)[1].length=0,console.log(D(this,ve))}undo(){const e=D(this,ve)[0].pop();return D(this,at).call(this,{reason:"undo",data:e}),e&&D(this,ve)[1].unshift(e),console.log(D(this,ve)),{canUndo:!!D(this,ve)[0].length,canRedo:!!D(this,ve)[1].length}}redo(){const e=D(this,ve)[1].shift();return D(this,at).call(this,{reason:"redo",data:e}),e&&D(this,ve)[0].push(e),console.log(D(this,ve)),{canUndo:!!D(this,ve)[0].length,canRedo:!!D(this,ve)[1].length}}clear(){D(this,ve)[0].length=0,D(this,ve)[1].length=0,console.log(D(this,ve))}}ve=new WeakMap,$t=new WeakMap,yt=new WeakMap,at=new WeakMap;const Ae=[1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,384];let K=de.querySelector("button"),Or=!1,Oe=!1;const Be={timeStamp:-1,tempo:120,scoreNoteValue:"4"};let In=null,Cn=!1,It=null;const Pr=()=>{T.activeTrack.querySelectorAll("button").forEach(n=>{n.classList.remove("done")}),Cn=!1},Rt=()=>{if(clearTimeout(In),K&&K.closest(".track")!==T.activeTrack){K=T.activeTrack.querySelector("button");return}let n=K;const e=()=>{const t=performance.measure("stepElapsed","stepPoint");performance.mark("stepPoint");const i=t.duration,h=(E=>{const f=60/Be.tempo*4/E*1e3,{noteValue:b,dots:w}=Ae.reduce((N,_,l)=>{const p=Math.log2(f/(2*f-_));if(p<0||Number.isNaN(p))return N;const A=p-Math.floor(p);return A<N.smallerFractional?{noteValue:_,dots:Math.round(p),smallerFractional:A}:N},{noteValue:null,dots:null,smallerFractional:1});if(b+".".repeat(w)===Be.scoreNoteValue)return"";if(String(b)===Be.scoreNoteValue){const N=Be.scoreNoteValue.match(/\.*/),_=N?N[0].length:0;return".".repeat(w-_)}else return b+".".repeat(w)})(i);(E=>{const f=It;"tonePitch"in f.dataset?f.dataset.tonePitch=f.dataset.tonePitch+E:"rest"in f.dataset&&(f.dataset.rest="r"+E)})(h),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)};if(!n){if(Cn){console.log("end1");return}xe.stop(),e(),Be.timeStamp=-1,It=null,performance.clearMarks("stepPoint"),setTimeout(()=>{K=T.activeTrack.querySelector("button"),Pr()},2e3),Cn=!0,console.log("end2");return}(()=>{if("tonePitch"in n.dataset){n.dataset.tonePitch=n.dataset.tonePitch.match(/[><]*?[a-g]\+?/i)[0],je(n,{noteValue:"1..."}),n.classList.add("bounce");return}"rest"in n.dataset&&(n.dataset.rest="r"),n.classList.add("done")})();const a=()=>{var t;K=n=((t=n.parentElement.nextElementSibling)==null?void 0:t.firstElementChild)||null};if("tonePitch"in n.dataset||xe.stop(),!["tonePitch","rest"].some(t=>t in n.dataset)){if("tempo"in n.dataset){const t=Number(n.dataset.tempo.replace("t",""));Be.tempo=t}else"noteValue"in n.dataset&&(Be.scoreNoteValue=(n.dataset.noteValue.match(/[0-9]+\.*/)||[Be.scoreNoteValue])[0]);a(),Rt(),console.log("end3");return}if((()=>{const t=60/Be.tempo*4*1e3*1.825;In=setTimeout(Rt,t)})(),!performance.getEntriesByName("stepPoint")[0]){performance.mark("stepPoint"),It=n,a(),console.log("end4");return}e(),It=n,a()};let Pe=!1;var He,bt;class ps{constructor(){le(this,He,30);le(this,bt,1e3/(D(this,He)*4));this.outputs=null,this.output=null,this.startMSec=0,this.additionalStartMSec=0,this.startTime=0,this.timer=null,this.initialized=!1}getQuarterFrameMessages(e,r,a,o){return[[241,0|o&15],[241,16|o>>4&1],[241,32|a&15],[241,48|a>>4&3],[241,64|r&15],[241,80|r>>4&3],[241,96|e&15],[241,118|e>>4&1]]}framesToTimecode(e){const r=e%D(this,He),a=Math.floor(e/D(this,He)),o=a%60,t=Math.floor(a/60),i=t%60;return{hours:Math.floor(t/60)%24,minutes:i,seconds:o,frames:r}}sendQuarterFrame(){if(!this.output)return;const e=performance.now(),r=(e-this.startTime)/1e3,a=Math.floor((this.startMSec+this.additionalStartMSec)/1e3*D(this,He)+r*D(this,He)),{hours:o,minutes:t,seconds:i,frames:m}=this.framesToTimecode(a);this.getQuarterFrameMessages(o,t,i,m).forEach((u,E)=>{var f;(f=this.output)==null||f.send(u,e+E*D(this,bt))}),this.timer=window.setTimeout(()=>this.sendQuarterFrame(),D(this,bt)*8)}async init(){if(!this.initialized)return this.initialized=!0,navigator.requestMIDIAccess().then(e=>this.outputs=Array.from(e.outputs.values()))}configure(e){Object.assign(this,e)}start(){if(!this.output){console.warn("MTC Sync output not available.");return}this.startTime=performance.now(),this.sendQuarterFrame()}stop(){this.timer&&(clearTimeout(this.timer),this.timer=null)}}He=new WeakMap,bt=new WeakMap;const Ne=new ps;var Et,Ke,Ut,Vt,Wt,zt,Ht,qt,Yt,Gt,Kt;class vs{constructor(e){le(this,Et,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name",value:(e,r)=>r.ariaLabel},{label:"音の定義",type:"text",name:"tone-def",autofocus:!0,value:e=>e}],buttons:[{className:"primaly",value:"set-tone",textContent:"確定"}],run:(e,r)=>{const{"tone-name":a}=r;a.insertAdjacentElement("afterend",ys);const o=document.querySelector("emoji-picker");a.addEventListener("focus",()=>{o.classList.add("expaned")},{once:!0}),o.addEventListener("emoji-click",t=>a.value=t.detail.unicode)},on:{"set-tone":(e,r)=>{const{"tone-name":a,"tone-def":o}=r,t=e.className;document.querySelectorAll(`[class*="${t}"]`).forEach(i=>{i.ariaLabel=a,(!i.classList.contains("material-icons")||a!=="無調整")&&(i.classList.remove("material-icons"),i.textContent=a),i.dataset.tone=o})}}},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tone-pitch",textContent:"確定"}],run:(e,r)=>{const{"tone-pitch":a}=r;D(this,Ke).call(this,a)},on:{"set-tone-pitch":(e,r)=>{const{"tone-pitch":a,dot:o}=r;e.dataset.tonePitch=`${e.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]}${a}${".".repeat(o)}`}}},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0",value:e=>e.replace("t","")}],buttons:[{className:"primaly",value:"set-tempo",textContent:"確定"}],on:{"set-tempo":(e,r)=>{const{tempo:a}=r;e.dataset.tempo=`t${a}`}}},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-note-value",textContent:"確定"}],run:(e,r)=>{const{"note-value":a}=r;D(this,Ke).call(this,a)},on:{"set-note-value":(e,r)=>{const{"note-value":a,dot:o}=r;e.dataset.noteValue=`l${a}${".".repeat(o)}`}}},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-rest",textContent:"確定"}],run:(e,r)=>{const{rest:a}=r;D(this,Ke).call(this,a)},on:{"set-rest":(e,r)=>{const{rest:a,dot:o}=r;e.dataset.rest=`r${a}${".".repeat(o)}`}}},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8",value:e=>e.startsWith("o")?e.replace("o",""):(e.match(/[><]+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}],on:{"set-octave":(e,r)=>{const{octave:a}=r;e.dataset.octave=`o${a}`},"set-octave-relative":(e,r)=>{const{octave:a}=r;e.dataset.octave=(a>0?"<":">").repeat(Math.abs(a))}}},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127",value:e=>e.startsWith("@v")?e.replace("@v",""):Number((e.match(/[0-9]+/)||[""])[0])*(e.startsWith("(")?1:-1)}],buttons:[{className:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}],on:{"set-velocity":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=`@v${a}`},"set-velocity-relative":(e,r)=>{const{velocity:a}=r;e.dataset.velocity=(a>0?"(":")").repeat(Math.abs(a))}}},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift",value:e=>(e.match(/[0-9]+/)||[""])[0]}],buttons:[{className:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}],on:{"set-note-shift":(e,r)=>{const{"note-shift":a}=r;e.dataset.noteShift=`ns${a}`},"set-note-shift-relative":(e,r)=>{const{noteShift:a}=r;e.dataset.noteShift=`@ns${a}`}}},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune",value:e=>e.replace("@d","")}],buttons:[{className:"primaly",value:"set-detune",textContent:"確定"}],on:{"set-detune":(e,r)=>{const{detune:a}=r;e.dataset.detune=`@d${a}`}}},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"0",max:"384",value:e=>(e.match(/[0-9]+/)||[""])[0]},{label:"付点の数",type:"number",name:"dot",min:"0",value:e=>(e.match(/\.+/)||[""])[0].length}],buttons:[{className:"primaly",value:"set-tie-slur",textContent:"確定"}],run:(e,r)=>{const{"tie-slur":a}=r;D(this,Ke).call(this,a)},on:{"set-tie-slur":(e,r)=>{const{"tie-slur":a,dot:o}=r;e.dataset.tieSlur=`&${a}${".".repeat(o)}`,e.dataset.tieSlur==="&"?e.ariaLabel="スラー":e.ariaLabel="タイ"}}},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0",value:e=>e.replace("/:","")}],buttons:[{className:"primaly",value:"set-repeat",textContent:"確定"}],on:{"set-repeat":(e,r)=>{const{repeat:a}=r;e.dataset.repeatStartEnd=`/:${a}`}}},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name",value:e=>(e.match(/\$([^\{\=]*)/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-def",textContent:"確定"}],on:{"set-macro-def":(e,r)=>{const{"macro-def-name":a,"macro-def-arg":o}=r;e.dataset.macroDef=`$${a}${o?`{${o}}`:""}=`;const t=(e.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];ae.querySelectorAll(`[data-macro-use^="${t}"]`).forEach(i=>{i.dataset.macroUse=i.dataset.macroUse.replace(t,`$${a}`)})}}},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use",value:e=>e.replace("%","")}],buttons:[{className:"primaly",value:"set-macro-arg-use",textContent:"確定"}],run:(e,r)=>{const{"macro-arg-use":a}=r,t=(()=>{let E=this.item.parentElement;for(;E&&!E.firstElementChild.dataset.macroDef;)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null})();if(!t||t.dataset.macroDef===";")return;const h=(t.dataset.macroDef.match(/\{([^\}]*)\}/)||[,""])[1].split(","),u=document.createElement("datalist");u.id="macro-arg-use-list",h.forEach(E=>{const f=document.createElement("option");f.value=E,u.appendChild(f)}),a.after(u),a.setAttribute("list","macro-arg-use-list")},on:{"set-macro-arg-use":(e,r)=>{const{"macro-arg-use":a}=r;e.dataset.macroArgUse=`%${a}`}}},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name",value:e=>(e.match(/\$([^\{]*)\{?/)||[,""])[1]},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg",value:e=>(e.match(/\{([^\}]*)\}/)||[,""])[1]}],buttons:[{className:"primaly",value:"set-macro-use",textContent:"確定"}],run:(e,r)=>{const{"macro-use-name":a}=r,o=document.createElement("datalist");o.id="macro-use-name-list",T.blocksData.filter(i=>i.macroDef&&i.macroDef!==";").map(i=>i.macroDef.replace("=","")).forEach(i=>{const m=document.createElement("option");m.label=(i.match(/\{[^\}]*\}/)||[""])[0],m.value=(i.match(/\$([^\{]*)\{?/)||[,""])[1],o.appendChild(m)}),a.after(o),a.setAttribute("list","macro-use-name-list")},on:{"set-macro-use":(e,r)=>{const{"macro-use-name":a,"macro-use-arg":o}=r;e.dataset.macroUse=`$${a}${o?`{${o}}`:""}`}}},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{className:"primaly",value:"set-meta-data",textContent:"確定"}],run:(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r,i=e.split(" "),m=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let h=m.findIndex(w=>i[0].startsWith(w));h===-1&&(h=0),a.selectedIndex=h;const u=w=>w.previousSibling,E=()=>a.selectedOptions[0],f=(w,N)=>{u(o).nodeValue=w[0],o.value=w[1],o.parentElement.style.display=w[2]?"none":"",u(t).nodeValue=N[0],t.value=N[1],t.parentElement.style.display=N[2]?"none":""},b=w=>{var l,p,A;const N=w===h,_=m[w];switch(_){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const M=N?i.slice(1).join(" ")??"":"";f(["無効","",!0],[E().label,M,!1]);break;case"#OCTAVE":case"#VELOCITY":f(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const B=_==="#WAV9",g=N?((l=i.slice(1).join(" "))==null?void 0:l.split(","))??[]:[];f(["波形番号",g[0]??0,!1],B?["初期変位,ループフラグ,データ",`${g[1]??0},${g[2]??0},${g[3]??""}`,!1]:["データ",g[1]??"",!1]),o.min=0,o.max=B?15:31;break;case"#OPM":case"#OPN":f(["音色番号",N?((p=i[0])==null?void 0:p.split("@")[1])??0:0,!1],["データ",N?((A=i.slice(1).join(" "))==null?void 0:A.slice(1,-1))??"":"",!1]),o.min=0,o.max=127;break;case"#FMGAIN":f(["音量利得",N?i[1].replace(`
`,"")??91:91,!1],["無効","",!0]),o.min=-127,o.max=127;break;case"#USING":f(["和音重ね数",N?i[2].replace(`
`,"")??2:2,!1],["無効","",!0]),o.min=1,o.max="";break}};b(h),a.addEventListener("change",w=>{b(w.target.selectedIndex)})},on:{"set-meta-data":(e,r)=>{const{"select-meta-data":a,number:o,text:t}=r;e.ariaLabel=a.label,e.dataset.metaData=`${a.value.replace("{n}",o).replace("{desc}",t)}`}}},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action",value:e=>e}],buttons:[{className:"primaly",value:"set-other-action",textContent:"確定"}],on:{"set-other-action":(e,r)=>{const{"other-action":a}=r;e.dataset.otherAction=a,e.textContent=a.length>4?"…":a}}},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}],on:{"remove-left":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(K=null;[...o].includes(r);){const t=a.firstElementChild;Ee.pushState({operation:"remove",removedElem:t,removedIndex:0,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere()},"remove-right":e=>{const r=e.parentElement,a=T.activeTrack,o=a.children;for(K=null;[...o].includes(r);){const t=a.lastElementChild;Ee.pushState({operation:"remove",removedElem:t,removedIndex:o.length-1,parent:a}),t.remove()}T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere()}}},step:{title:"ステップ音価記録",description:`ステップ音価記録は、簡単に音価を指定できる機能です。

各トラックの空白部分をテンポよくクリック、またはスペースキーを押して最初の音符から順に音価を決定します。
途中から指定をやり直したいときは、やり直したい音符をクリックすることでそこからやり直せます。

この画面は、Shiftキーを押しながらステップ音価記録ブロックをクリックすることで再度表示できます。`,buttons:[{className:"primaly",value:"set-step",textContent:"開始"},{value:"cancel-step",textContent:"やめる"}],on:{"set-step":()=>{Or=!0,Oe=!0},"cancel-step":()=>{Oe=!1}}},mtcSync:{title:"MTC同期設定",description:`他のMIDIシーケンサー等と再生を同期できます。
MTC Senderとして動作します。`,inputs:[{label:"送信先MIDIデバイス",select:{"":"---デバイスがありません---"},name:"select-mtc-sync",disabled:!0},{label:"再生開始オフセットミリ秒",type:"number",name:"start-msec",value:()=>Ne.startMSec||0,min:"0",disabled:!0}],buttons:[{className:"primaly",value:"set-sync-mtc",textContent:"開始",disabled:!0},{value:"cancel-sync-mtc",textContent:"やめる"}],run:async(e,r)=>{const{"select-mtc-sync":a,"start-msec":o}=r,t=be.buttons.querySelector('button[value="set-sync-mtc"]'),i=Ne.outputs?Ne.outputs:await Ne.init();if(i.length===0)return;a.textContent="",a.disabled=!1,o.disabled=!1,t.disabled=!1;for(const h of i){const u=document.createElement("option");u.value=h.id,u.textContent=h.name,a.appendChild(u)}let m=i.indexOf(Ne.output);m===-1&&(m=0),a.selectedIndex=m},on:{"set-sync-mtc":(e,r)=>{const{"select-mtc-sync":a,"start-msec":o}=r,t=Ne.outputs.find(m=>m.id===a.value),i=o;Ne.configure({output:t,startMSec:i}),Pe=!0,T.calcPlayFromHere()},"cancel-sync-mtc":()=>{Pe=!1}}}});le(this,Ke,e=>{let r=e.valueAsNumber,a=Ae.findIndex(o=>o===r);e.addEventListener("input",()=>{const o=e.valueAsNumber;o!==r&&(o===0?(a=-1,e.value=""):o>r||Number.isNaN(r)?e.value=Ae[++a]:o<r&&(e.value=Ae[--a]),r=e.valueAsNumber)})});le(this,Ut,e=>{const r=D(this,Et)[e];D(this,Vt).call(this,r.title),D(this,Wt).call(this,r.description),D(this,zt).call(this,r.inputs),D(this,Ht).call(this,r.buttons),D(this,qt).call(this,r.run),D(this,Yt).call(this,r.on)});le(this,Vt,e=>{be._title.textContent=e||""});le(this,Wt,e=>{if(be.description.textContent="",e){const r=document.createElement("p");r.innerText=e,be.description.appendChild(r)}});le(this,zt,e=>{be.inputs.textContent="",e==null||e.forEach(r=>{const a="select"in r,o=document.createElement(a?"select":"input");let t=o;Object.entries(r).forEach(([i,m])=>{if(i==="label"){const h=document.createElement("label");h.textContent=m,h.appendChild(o),t=h}else i==="select"?Object.entries(m).forEach(([h,u])=>{const E=document.createElement("option");E.value=h,E.textContent=u,o.appendChild(E)}):i==="value"&&typeof m=="function"?o.value=m(this.mmlText,this.item):o[i]=m}),be.inputs.appendChild(t)})});le(this,Ht,e=>{be.buttons.textContent="",e==null||e.forEach(r=>{const a=document.createElement("button");Object.entries(r).forEach(([o,t])=>{a[o]=t}),be.buttons.appendChild(a)})});le(this,qt,e=>{e&&e(this.mmlText,D(this,Gt).call(this))});le(this,Yt,e=>{be.addEventListener("submit",r=>{const a=this.item,o=r.submitter.value,t=D(this,Kt).call(this),i=JSON.parse(JSON.stringify(a.dataset));console.log(o),e[o](a,t);const m=JSON.parse(JSON.stringify(a.dataset));JSON.stringify(i)!==JSON.stringify(m)&&Ee.pushState({operation:"valueChange",target:a,beforeChange:i,afterChange:m}),this.resolve()},{once:!0})});le(this,Gt,()=>Object.fromEntries([...be.elements].map(e=>[e.name,e])));le(this,Kt,()=>Object.fromEntries([...be.elements].map(r=>{var a;return r instanceof HTMLSelectElement?[r.name,{label:(a=r.selectedOptions[0])==null?void 0:a.label,value:r.value}]:[r.name,r.valueAsNumber||r.value]})));this.item=null,this.type=null,this.mmlText=null,this.resolve=null}async prompt(e,r){if(this.item=e,this.type=r||Object.keys(D(this,Et)).find(a=>a in e.dataset),!this.type){console.warn("No dialog type found for the item:",e);return}switch(this.mmlText=e.dataset[this.type],this.type){case"repeatStartEnd":if(this.mmlText===":/"){const o=(()=>{var i;let t=e.parentElement;for(;t&&!((i=t.firstElementChild.dataset.repeatStartEnd)!=null&&i.startsWith("/:"));)t=t.previousElementSibling;return(t==null?void 0:t.firstElementChild)||null})();if(o)e=o;else{const t=T.activeTrack,i=document.createElement("li"),h=Se.querySelector(".repeat-start-end").cloneNode(!0);i.appendChild(h),t.insertBefore(i,e.parentElement),e=h}this.mmlText=e.dataset.repeatStartEnd}break;case"macroDef":if(this.mmlText===";")return;break}return D(this,Ut).call(this,this.type),Ge.showModal(),new Promise(a=>this.resolve=a)}}Et=new WeakMap,Ke=new WeakMap,Ut=new WeakMap,Vt=new WeakMap,Wt=new WeakMap,zt=new WeakMap,Ht=new WeakMap,qt=new WeakMap,Yt=new WeakMap,Gt=new WeakMap,Kt=new WeakMap;mr.FlMML.prepare(".editor");const xe=new mr.FlMML({workerURL:ka}),Q=new fs;gn.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const T=new ms(de,ae),Ee=new hs,Re=new vs(be),gs={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},ys=new Pn({i18n:gs,locale:"ja"});as.polyfill({holdToDrag:500});is();const ht=n=>`<span class="material-icons">${n}</span>`,jr=ht("play_arrow")+"再生",bs=ht("stop")+"停止",Dn=()=>{const n=[...ae.querySelectorAll(".track button")].findIndex(e=>e.classList.contains("play-from-here"));T.playRendering(n),Pe&&Ne.start()},Es=()=>{us.innerText=xe.getWarnings()};xe.addEventListener("compilecomplete",Es);const Ss=()=>{Ot.innerHTML=jr,T.stopRendering(),Pe&&Ne.stop(),xe.removeEventListener("compilecomplete",Dn),Pt.disabled=!1};xe.addEventListener("complete",Ss);Q.onChange=(n,e)=>{ds.innerHTML=e?`<pre><code>${ss(os(e))}</code></pre>`:"(なし)";const r=!!n.length;Le.disabled=qe.disabled=!r};Q.onError=(n,e)=>{alert(n+`
`+e)};T.checkSavedBlocksData();const je=(n,e={})=>{var l;const r=()=>{let p=n.parentElement;for(;p&&!("noteValue"in p.firstElementChild.dataset);)p=p.previousElementSibling;return(p==null?void 0:p.firstElementChild)||null},a=()=>{var A;let p=n.parentElement;for(;p&&!((A=p.firstElementChild.dataset.octave)!=null&&A.startsWith("o"));)p=p.previousElementSibling;return(p==null?void 0:p.firstElementChild)||null},o=()=>{var M;let p=n.parentElement.nextElementSibling,A="";for(;p&&((M=p.firstElementChild.dataset.tieSlur)!=null&&M.match(/&[0-9]+\.*/));)A+=p.firstElementChild.dataset.tieSlur,p=p.nextElementSibling;return A},t=((l=r())==null?void 0:l.dataset.noteValue)||"",i=a(),m=i?[...T.activeTrack.children].indexOf(i.parentElement):0,h=(i==null?void 0:i.dataset.octave)||"",u=[...T.activeTrack.children].indexOf(n.parentElement),E=[...T.activeTrack.children].slice(m,u).filter(p=>"tonePitch"in p.firstElementChild.dataset||"octave"in p.firstElementChild.dataset&&!p.firstElementChild.dataset.octave.startsWith("o")).map(p=>((p.firstElementChild.dataset.tonePitch||p.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),f={down:">",up:"<"},b=(p,A)=>(p.match(new RegExp(A,"g"))||[]).length,w=(()=>{const p=-b(E,f.down)+b(E,f.up);return p<0?f.down.repeat(-p):p>0?f.up.repeat(p):""})(),N=o(),_=e.noteValue?n.dataset.tonePitch.replace(/[0-9]+\.*/,"")+e.noteValue:n.dataset.tonePitch;xe.play(n.dataset.tone+t+h+w+_+N)};Ee.onPopstate=n=>{const e=n.data,r=a=>!!e.parent.closest("#"+a);switch(n.reason){case"undo":switch(e==null?void 0:e.operation){case"append":Q.delete(e.index);break;case"delete":Q.insert(e.index,e.mmlText);break;case"rewrite":Q.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere());break;case"move":const a=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(a,e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere());break;case"valueChange":for(const[o,t]of Object.entries(e.beforeChange))e.target.dataset[o]=t;"tone"in e.target.dataset&&je(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere());break;case"clear":e.tonesChildren.forEach(o=>{de.querySelector("ul").appendChild(o)}),e.musicalScoreChildren.forEach(o=>{ae.insertBefore(o,Fe)}),K=e.lastTouchedButton,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":Q.append(e.mmlText);break;case"delete":Q.delete(e.index);break;case"rewrite":Q.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere()),"tonePitch"in K.dataset&&(je(K),K.classList.add("bounce"));break;case"move":const a=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(a,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere());break;case"valueChange":for(const[t,i]of Object.entries(e.afterChange))e.target.dataset[t]=i;"tone"in e.target.dataset&&je(e.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);break;case"remove":const o=e.removedElem.className;e.removedElem.remove(),r("tones")&&ae.querySelectorAll(`[class*="${o}"]`).forEach(t=>{t.parentElement.remove()}),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere();break;case"clear":de.querySelector("ul").textContent="",ae.querySelectorAll(".track").forEach((t,i)=>{i?t.remove():(t.textContent="",T.activeTrack=t)}),K=null,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);break}break}};const Br=()=>{const n=[...de.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!n.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",n=>{var r;const e=n.ctrlKey||Jt.checked;switch((r=n.key)==null?void 0:r.toLowerCase()){case" ":Oe?(n.preventDefault(),Rt()):document.activeElement.tagName.toLowerCase()!=="input"&&(n.preventDefault(),Ot.click());break;case"s":e&&(n.preventDefault(),!qe.disabled&&qe.click());break;case"o":e&&(n.preventDefault(),!kn.disabled&&kn.click());break;case"z":e&&Ee.undo();break;case"y":e&&Ee.redo();break}});Ye.addEventListener("click",async n=>{const e=n.ctrlKey||Jt.checked,r=o=>!!n.target.closest("#"+o),a=n.target.tagName.toLowerCase()==="button";if(![de,Se,ae].some(o=>o.classList.contains("no-op"))){if(r("tones"))if(a)K=n.target,await Re.prompt(n.target,"tone"),xe.play(n.target.dataset.tone+n.target.dataset.tonePitch),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q);else{const o=de.querySelector("ul"),t=document.createElement("li"),m=`<button class="material-icons note ${Br()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;t.innerHTML=m;const h=t.firstElementChild;o.appendChild(t),K=h,xe.play(h.dataset.tone+h.dataset.tonePitch),Ee.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o})}else if(r("action")){if(a){if("otherAction"in n.target.dataset)await Re.prompt(n.target);else if("step"in n.target.dataset){Or&&!n.shiftKey?Oe=!Oe:await Re.prompt(n.target),Oe?(n.target.classList.add("enable"),n.target.ariaLabel="ステップ音価記録(有効)",K=T.activeTrack.querySelector("button")):(n.target.classList.remove("enable"),n.target.ariaLabel="ステップ音価記録(無効)",Pr(),xe.stop(),clearTimeout(In));return}else if("mtcSync"in n.target.dataset){Pe?(Ne.stop(),Pe=!1):await Re.prompt(n.target,"mtcSync"),Pe?(n.target.classList.add("enable"),n.target.ariaLabel="MTC同期(有効)"):(n.target.classList.remove("enable"),n.target.ariaLabel="MTC同期(無効)");return}const o=T.activeTrack,t=document.createElement("li"),i=n.target.cloneNode(!0);if(["metaData","macroDef","macroUse"].some(m=>m in i.dataset)&&await Re.prompt(i),"tieSlur"in i.dataset?i.ariaLabel="スラー":"repeatStartEnd"in i.dataset?(i.classList.remove("material-icons"),i.ariaLabel="リピート開始",i.textContent="◆",i.dataset.repeatStartEnd="/:"):"polyStartEnd"in i.dataset?(i.dataset.polyStartEnd="[",i.textContent="["):"macroDef"in i.dataset?i.textContent="$=":"playFromHere"in i.dataset&&(ae.querySelectorAll(".track button").forEach(m=>{m.classList.add("inactive")}),Le.disabled=qe.disabled=!0),t.appendChild(i),o.appendChild(t),K=i,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere(),Ee.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),["repeatStartEnd","polyStartEnd","macroDef"].some(m=>m in K.dataset)){const m=document.createElement("li"),h=n.target.cloneNode(!0);"repeatStartEnd"in K.dataset?(h.ariaLabel="リピート終了",h.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(h.dataset.polyStartEnd="]",h.textContent="]"):"macroDef"in K.dataset&&(h.dataset.macroDef=";",h.textContent=";"),m.appendChild(h),K.parentElement.insertAdjacentElement("afterend",m),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q),Ee.pushState({operation:"copy",toIndex:-1,newElem:m,parent:o})}}}else if(r("musical-score")){if(a&&n.target!==Fe&&n.target!==st)n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Oe||("tone"in n.target.dataset?(je(n.target),De(n.target,"bounce"),e&&(await Re.prompt(n.target,"tonePitch"),je(n.target))):await Re.prompt(n.target),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)),K=n.target;else if(n.target.closest(".track")&&(T.activeTrack=n.target.closest(".track")),Oe)Rt();else if(K){const o=T.activeTrack,t=document.createElement("li"),i=K.cloneNode(!0);if("repeatStartEnd"in i.dataset&&(i.classList.remove("material-icons"),i.ariaLabel="リピート開始",i.textContent="◆",i.dataset.repeatStartEnd="/:"+(i.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),t.appendChild(i),o.appendChild(t),K=i,T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere(),Ee.pushState({operation:"copy",toIndex:-1,newElem:t,parent:o}),"tonePitch"in i.dataset)i.dataset.tonePitch=i.dataset.tonePitch.replace(/[><]+/,""),je(i),i.classList.add("bounce");else if("repeatStartEnd"in K.dataset){const m=document.createElement("li"),h=K.cloneNode(!0);h.classList.add("material-icons"),h.ariaLabel="リピート終了",h.textContent="repeat",h.dataset.repeatStartEnd=":/",m.appendChild(h),K.parentElement.insertAdjacentElement("afterend",m),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q),Ee.pushState({operation:"copy",toIndex:-1,newElem:m,parent:o})}}}}});Ye.addEventListener("contextmenu",n=>{var o,t,i,m;if(Oe)return;const e=h=>h.closest("#tones, #musical-score"),r=h=>!!n.target.closest("#"+h),a=n.target.tagName.toLowerCase()==="button";if(!((o=e(n.target))!=null&&o.classList.contains("no-op"))&&e(n.target)){const h=a&&n.target!==Fe&&n.target!==st?n.target:K;if(!h||e(h)!==e(n.target))return;n.preventDefault(),T.activeTrack=h.closest(".track")||T.activeTrack;const u=h.parentElement,E=h.className,f=((t=h.closest("#tones"))==null?void 0:t.querySelector("ul"))||T.activeTrack,b=[...f.children].indexOf(u);if(K=((i=u.previousElementSibling)==null?void 0:i.firstElementChild)||((m=u.nextElementSibling)==null?void 0:m.firstElementChild)||null,Ee.pushState({operation:"remove",removedElem:u,removedIndex:b,parent:f}),r("tones"))ae.querySelectorAll(`[class*="${E}"]`).forEach(w=>{w.parentElement.remove()});else if("macroDef"in h.dataset){const w=(h.dataset.macroDef.match(/\$[^\{\=]*/)||[""])[0];ae.querySelectorAll(`[data-macro-use^="${w}"]`).forEach(N=>{N.parentElement.remove()})}else"playFromHere"in h.dataset&&(ae.querySelectorAll(".inactive").forEach(w=>{w.classList.remove("inactive")}),Le.disabled=qe.disabled=!1);u.remove(),T.blocksDataUpdate(),T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere()}});let Mt=null,jn=!1,Ft=null;Ye.addEventListener("touchstart",n=>{Mt=[...n.touches].at(-1).pageY,Ft=setTimeout(()=>{jn=!0},500)});const Rr=n=>{if(Oe)return;const e=n.ctrlKey||Jt.checked,r=i=>!!n.target.closest("#"+i),a=n.target.tagName.toLowerCase()==="button";if(n.type==="touchmove"){const i=[...n.touches].at(-1).pageY;if(jn){n.cancelable&&n.preventDefault();return}else if(i-Mt<-30)n.deltaY=-1,clearTimeout(Ft);else if(i-Mt>30)n.deltaY=1,clearTimeout(Ft);else{n.cancelable&&n.preventDefault();return}Mt=i}const o=n.deltaY<0;let t=a&&n.target!==Fe&&n.target!==st?n.target:(K==null?void 0:K.closest("#musical-score"))&&K;if(t){if(r("musical-score")){if(ae.classList.contains("no-op"))return;n.preventDefault();let i=JSON.parse(JSON.stringify(t.dataset));if(!e&&"tone"in t.dataset){const h=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],u={down:">",up:"<"},E=t.dataset.tonePitch,f=h.findIndex(p=>E.match(/[a-g]\+?/)[0]===p),b=(p,A)=>(p.match(new RegExp(A,"g"))||[]).length,w={down:b(E,u.down),up:b(E,u.up)},N=u.down.repeat(w.down)+u.up.repeat(w.up),_=(E.match(/[0-9]+/)||[""])[0],l=(t.dataset.tonePitch.match(/\.+/)||[""])[0];o?f===h.length-1?w.down?t.dataset.tonePitch=N.substring(1)+h.at(0)+_+l:t.dataset.tonePitch=N+u.up+h.at(0)+_+l:t.dataset.tonePitch=N+h[f+1]+_+l:f===0?w.up?t.dataset.tonePitch=N.substring(1)+h.at(-1)+_+l:t.dataset.tonePitch=N+u.down+h.at(-1)+_+l:t.dataset.tonePitch=N+h[f-1]+_+l,je(t)}else{const h=o?1:-1,u=(E,f=-1/0,b=1/0)=>E+h<f||E+h>b?0:h;if(e&&"tonePitch"in t.dataset){const E=Number((t.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),f=(t.dataset.tonePitch.match(/\.+/)||[""])[0],b=u(E,0,384),w=Ae.findIndex(_=>_===E),N=E+b!==0?Ae[w+b]:"";t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+N+f,je(t)}else if("tempo"in t.dataset){const E=Number(t.dataset.tempo.replace("t","")),f=u(E,0);t.dataset.tempo="t"+(E+f*10)}else if("noteValue"in t.dataset){const E=Number((t.dataset.noteValue.match(/[0-9]+/)||[""])[0]),f=u(E,1,384),b=Ae.findIndex(w=>w===E);t.dataset.noteValue=t.dataset.noteValue.replace(/[0-9]+/,Ae[b+f])}else if("rest"in t.dataset){const E=Number((t.dataset.rest.match(/[0-9]+/)||[""])[0]),f=(t.dataset.rest.match(/\.+/)||[""])[0],b=u(E,0,384),w=Ae.findIndex(_=>_===E),N=E+b!==0?Ae[w+b]:"";t.dataset.rest="r"+N+f}else if("octave"in t.dataset)if(t.dataset.octave.startsWith("o")){const f=Number(t.dataset.octave.replace("o","")),b=u(f,0,8);t.dataset.octave="o"+(f+b)}else{const f=(t.dataset.octave.match(/<+/)||[""])[0].length-(t.dataset.octave.match(/>+/)||[""])[0].length,b=u(f,-8,8);t.dataset.octave=f+b>0?"<".repeat(f+b):">".repeat(-(f+b))}else if("velocity"in t.dataset)if(t.dataset.velocity.startsWith("@v")){const f=Number(t.dataset.velocity.replace("@v","")),b=u(f,0,127);t.dataset.velocity="@v"+(f+b)}else{const f=Number((t.dataset.velocity.match(/[0-9]+/)||[""])[0])*(t.dataset.velocity.startsWith("(")?1:-1),b=u(f,-127,127);t.dataset.velocity=(f+b>=0?"(":")")+Math.abs(f+b)}else if("noteShift"in t.dataset){const E=Number((t.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),f=h;t.dataset.noteShift=t.dataset.noteShift.match(/@?ns/)[0]+(E+f)}else if("detune"in t.dataset){const E=Number(t.dataset.detune.replace("@d","")),f=h;t.dataset.detune="@d"+(E+f)}else if("tieSlur"in t.dataset){const E=Number((t.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),f=(t.dataset.tieSlur.match(/\.+/)||[""])[0],b=u(E,0,384),w=Ae.findIndex(_=>_===E),N=E+b!==0?Ae[w+b]:"";t.dataset.tieSlur="&"+N+f,t.dataset.tieSlur==="&"?t.ariaLabel="スラー":t.ariaLabel="タイ"}else if("repeatStartEnd"in t.dataset){if(t.dataset.repeatStartEnd===":/"){const N=(()=>{var l;let _=t.parentElement;for(;_&&!((l=_.firstElementChild.dataset.repeatStartEnd)!=null&&l.startsWith("/:"));)_=_.previousElementSibling;return(_==null?void 0:_.firstElementChild)||null})();if(N)t=N;else{const _=T.activeTrack,l=document.createElement("li"),A=Se.querySelector(".repeat-start-end").cloneNode(!0);l.appendChild(A),_.insertBefore(l,t.parentElement),t=A}i=JSON.parse(JSON.stringify(t.dataset))}const E=Number((t.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),f=u(E,-1),b=E+f!==-1?E+f:"";t.dataset.repeatStartEnd="/:"+b}}const m=JSON.parse(JSON.stringify(t.dataset));JSON.stringify(i)!==JSON.stringify(m)&&Ee.pushState({operation:"valueChange",target:t,beforeChange:i,afterChange:m}),K=t,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)}}else return};Ye.addEventListener("wheel",Rr);Ye.addEventListener("touchmove",Rr);Ye.addEventListener("touchend",()=>{clearTimeout(Ft),jn=!1});let ft={};Ye.addEventListener("dragstart",n=>{ft={from:n.target.nodeType===1&&n.target.closest("#tones, #action, #musical-score"),item:n.target},n.dataTransfer.effectAllowed="copyMove"});let dr=null;[de,Se,ae].forEach(n=>{const e=t=>{const i=t.ctrlKey||Jt.checked,{from:m=null}=ft,h=t.dataTransfer;switch(m){case de:switch(n){case de:t.preventDefault(),i?h.dropEffect="copy":h.dropEffect="move";break;case Se:break;case ae:t.preventDefault(),h.dropEffect="copy";break}break;case Se:switch(n){case de:break;case Se:break;case ae:t.preventDefault(),h.dropEffect="copy";break}break;case ae:switch(n){case de:break;case Se:break;case ae:t.preventDefault(),i?h.dropEffect="copy":h.dropEffect="move";break}break}dr=h.dropEffect};n.addEventListener("dragover",e);const r=t=>{const{from:i=null}=ft,m=t.target.tagName.toLowerCase()==="button",h=()=>t.target.classList.add("droppable");switch(i){case de:switch(n){case de:t.preventDefault(),m&&h();break;case Se:break;case ae:t.preventDefault(),m&&h();break}break;case Se:switch(n){case de:break;case Se:break;case ae:t.preventDefault(),m&&h();break}break;case ae:switch(n){case de:break;case Se:break;case ae:t.preventDefault(),m&&h();break}break}};n.addEventListener("dragenter",r);const a=t=>{const{from:i=null}=ft,m=t.target.tagName.toLowerCase()==="button",h=()=>t.target.classList.remove("droppable");switch(i){case de:switch(n){case de:m&&h();break;case Se:break;case ae:m&&h();break}break;case Se:switch(n){case de:break;case Se:break;case ae:m&&h();break}break;case ae:switch(n){case de:break;case Se:break;case ae:m&&h();break}break}};n.addEventListener("dragleave",a),n.addEventListener("drop",async t=>{var w,N;if(t.preventDefault(),(w=t.dataTransfer.items)!=null&&w.length)return;t.dataTransfer.dropEffect=t.dataTransfer.dropEffect!=="none"?t.dataTransfer.dropEffect:dr;const{from:i,item:m}=ft,h=((N=t.target.closest("#tones"))==null?void 0:N.querySelector("ul"))||t.target.closest(".track")||T.activeTrack,u=[...n.querySelectorAll("button")].indexOf(m),E=[...n.querySelectorAll("button")].indexOf(t.target),f=t.target.tagName.toLowerCase()==="button";let b;switch(t.dataTransfer.dropEffect){case"copy":const _=document.createElement("li"),l=m.cloneNode(!0);if(n===de){const p=[...m.classList].find(A=>A.includes("note-"));l.classList.replace(p,Br())}else i===Se&&("tieSlur"in l.dataset?l.ariaLabel="スラー":["metaData","macroDef","macroUse","otherAction"].some(p=>p in l.dataset)&&await Re.prompt(l));"repeatStartEnd"in l.dataset?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"+(l.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in l.dataset?(l.dataset.polyStartEnd="[",l.textContent="["):"macroDef"in l.dataset&&(l.dataset.macroDef===";"&&(l.dataset.macroDef="$="),l.textContent="$="),_.appendChild(l),b=_;break;case"move":b=m.parentElement;break}if(f&&t.target.id!=="add-track"&&t.target.id!=="remove-track"){const _=t.dataTransfer.dropEffect==="copy"||E<u?"beforebegin":"afterend";t.target.parentElement.insertAdjacentElement(_,b)}else h.appendChild(b);switch(K=b.firstElementChild,n===ae&&(T.activeTrack=h,T.blocksDataUpdate(),t.dataTransfer.dropEffect==="move"&&T.calcPoly(),T.saveBlocksData(),T.exportMml(Q),T.calcPlayFromHere(),"tonePitch"in K.dataset&&(K.dataset.tonePitch=K.dataset.tonePitch.replace(/[><]+/,""),je(K),K.classList.add("bounce"))),t.dataTransfer.dropEffect){case"copy":Ee.pushState({operation:"copy",toIndex:E,newElem:b,parent:h});break;case"move":Ee.pushState({operation:"move",fromIndex:u,toIndex:E,elem:b,parent:h});break}if(t.dataTransfer.dropEffect==="copy"&&["repeatStartEnd","polyStartEnd","macroDef"].some(_=>_ in K.dataset)){const _=document.createElement("li"),l=m.cloneNode(!0);"repeatStartEnd"in K.dataset?(l.classList.add("material-icons"),l.ariaLabel="リピート終了",l.textContent="repeat",l.dataset.repeatStartEnd=":/"):"polyStartEnd"in K.dataset?(l.dataset.polyStartEnd="]",l.textContent="]"):"macroDef"in K.dataset&&(l.dataset.macroDef=";",l.textContent=";"),_.appendChild(l),b.insertAdjacentElement("afterend",_),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q),Ee.pushState({operation:"copy",toIndex:E+1,newElem:_,parent:h})}});const o=t=>{[...document.getElementsByClassName("droppable")].forEach(i=>{i.classList.remove("droppable")})};n.addEventListener("dragend",o)});Ye.addEventListener("animationend",n=>{n.target.classList.remove("bounce"),n.target.classList.remove("pop")});Fe.addEventListener("click",n=>{n.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),T.activeTrack=e,ae.insertBefore(e,Fe)});st.addEventListener("click",n=>{n.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),T.activeTrack=r,T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)});Ge.addEventListener("pointerdown",n=>{n.target===Ge&&Ge.addEventListener("pointerup",e=>{e.target===Ge&&Ge.close()},{once:!0})});Ge.addEventListener("close",()=>{switch(Re.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});Ot.addEventListener("click",()=>{const n=xe.isPlaying();n?(xe.stop(),T.stopRendering(),Pe&&Ne.stop(),xe.removeEventListener("compilecomplete",Dn),Pt.disabled=!1):(xe.play(Q.getMml()),xe.addEventListener("compilecomplete",Dn),Pt.disabled=!0),Ot.innerHTML=n?jr:bs});Pt.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const n=[...ae.children];n.pop(),Ee.pushState({operation:"clear",tonesChildren:[...de.querySelector("ul").children],musicalScoreChildren:n,lastTouchedButton:K}),de.querySelector("ul").textContent="";const e=de.querySelector("ul"),r=document.createElement("li"),a='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=a;const o=r.firstElementChild;e.appendChild(r),K=o,ae.querySelectorAll(".track").forEach((t,i)=>{i?t.remove():(t.textContent="",T.activeTrack=t)}),xe.play(""),T.blocksDataUpdate(),T.saveBlocksData(),T.exportMml(Q)}});Le.addEventListener("click",async n=>{const e=n.shiftKey?JSON.stringify(T.blocksData):Q.getMml(),r=Le.innerHTML;Le.disabled=!0,navigator.clipboard.writeText(e).then(()=>{Le.disabled=!0,Le.innerHTML=ht("content_copy")+"コピーしました",n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータをコピーしました。"),setTimeout(()=>{Le.innerHTML=r,Le.disabled=!1},1500)}).catch(a=>alert(`コピーできませんでした
`+a))});We.addEventListener("click",()=>{const n=We.innerHTML;We.disabled=!0,navigator.clipboard.readText().then(e=>{We.disabled=!0,e?(xn(e)?T.blocksData=JSON.parse(e):(Q.setMml(e.replace(/\r/g,"")),T.importMml(Q)),We.innerHTML=ht("content_paste")+"貼り付けました",xn(e)&&alert("JSONブロックデータが貼り付けられました。")):We.innerHTML=ht("content_paste")+"内容がありません",setTimeout(()=>{We.innerHTML=n,We.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});qe.addEventListener("click",n=>{var i;const r=((i=Q.getMmlArr().find(m=>m.startsWith("#TITLE")))==null?void 0:i.split(" ").slice(1).join(" "))??"無題",a=n.shiftKey?JSON.stringify(T.blocksData):Q.getMml(),o=new Blob([a],{type:n.shiftKey?"application/json":"text/plain"}),t=document.createElement("a");t.download=r+(n.shiftKey?".json":".mml"),t.href=URL.createObjectURL(o),t.click(),URL.revokeObjectURL(t.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。"),n.shiftKey&&alert("Shiftキーを押しながらクリックしたため、JSONブロックデータを保存しました。")});kn.addEventListener("click",()=>{const n=document.createElement("input"),e=new FileReader;n.type="file",n.accept=".mml,.flmml,.txt,.json",n.click(),n.onchange=()=>{e.onload=()=>{const r=e.result;xn(r)?(T.blocksData=JSON.parse(r),alert("JSONブロックデータが読み込まれました。")):(Q.setMml(r.replace(/\r/g,"")),T.importMml(Q))},e.readAsText(n.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");Ee.onPushstate=n=>{jt.disabled=!1,Bt.disabled=!0};jt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=Ee.undo();jt.disabled=!n,Bt.disabled=!e});Bt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=Ee.redo();jt.disabled=!n,Bt.disabled=!e});
