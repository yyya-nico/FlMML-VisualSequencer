var Ln=(n,e,r)=>{if(!e.has(n))throw TypeError("Cannot "+r)};var R=(n,e,r)=>(Ln(n,e,"read from private field"),r?r.call(n):e.get(n)),we=(n,e,r)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,r)},ke=(n,e,r,o)=>(Ln(n,e,"write to private field"),o?o.call(n,r):e.set(n,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const t of i)if(t.type==="childList")for(const l of t.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function r(i){const t={};return i.integrity&&(t.integrity=i.integrity),i.referrerPolicy&&(t.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?t.credentials="include":i.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function o(i){if(i.ep)return;i.ep=!0;const t=r(i);fetch(i.href,t)}})();const ea="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var et=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ta(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Vn={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(r,o){n.exports=o()})(self,function(){return(()=>{var r={587:(t,l,y)=>{var f;(f=(function(d,v){Object.defineProperty(v,"__esModule",{value:!0}),v.MsgTypes=v.SAMPLE_RATE=void 0,v.SAMPLE_RATE=44100,v.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(l,[y,l]))===void 0||(t.exports=f)},581:(t,l,y)=>{var f;(f=(function(d,v){Object.defineProperty(v,"__esModule",{value:!0}),v.FlMMLAudioExportError=void 0;class h extends Error{constructor(...S){super(...S),this.name="FlMMLAudioExportError"}}v.FlMMLAudioExportError=h}).apply(l,[y,l]))===void 0||(t.exports=f)},643:function(t,l,y){var f,d,v=this&&this.__awaiter||function(h,c,S,T){return new(S||(S=Promise))(function(E,g){function N(j){try{A(T.next(j))}catch(C){g(C)}}function $(j){try{A(T.throw(j))}catch(C){g(C)}}function A(j){var C;j.done?E(j.value):(C=j.value,C instanceof S?C:new S(function(U){U(C)})).then(N,$)}A((T=T.apply(h,c||[])).next())})};f=[y,l,y(587),y(581),y(158)],(d=(function(h,c,S,T,E){Object.defineProperty(c,"__esModule",{value:!0}),c.FlMMLonHTML5=c.FlMMLAudioExportError=c.FlMML=void 0,Object.defineProperty(c,"FlMMLAudioExportError",{enumerable:!0,get:function(){return T.FlMMLAudioExportError}});const g="flmml-on-html5.worker.js";class N{constructor(A=g){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof A=="string"&&(A={workerURL:A});const j=A.workerURL||g,C=A.infoInterval>=0?A.infoInterval:125;this.bufferSize=A.bufferSize>=128?Math.floor(A.bufferSize-A.bufferSize%128):8192,this.bufferMultiple=A.bufferMultiple>=1?Math.floor(A.bufferMultiple):32,this.lamejsURL=A.lamejsURL,(this.worker=new Worker(A.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${j}")`],{type:"application/javascript"})):j)).addEventListener("message",U=>{this.onMessage(U)}),this.setInfoInterval(C)}static initWebAudio(){const A=N.audioCtx=new AudioContext({sampleRate:S.SAMPLE_RATE}),j=A.createBufferSource();j.connect(A.destination),j.start(0),A.resume(),j.stop()}static hookInitWebAudio(A){const j=document.querySelectorAll(A);j.forEach(C=>{C.addEventListener("click",function U(){N.audioCtx||N.initWebAudio(),j.forEach(F=>{F.removeEventListener("click",U,!0)})},!0)})}static prepare(A){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{N.hookInitWebAudio(A)}):N.hookInitWebAudio(A)}onMessage(A){const j=A.data;switch(j.type){case S.MsgTypes.COMPCOMP:this.totalMSec=j.info.totalMSec,this.totalTimeStr=j.info.totalTimeStr,this.warnings=j.info.warnings,this.metaTitle=j.info.metaTitle,this.metaComment=j.info.metaComment,this.metaArtist=j.info.metaArtist,this.metaCoding=j.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case S.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(j),this.trigger("buffering",{progress:j.progress});break;case S.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case S.MsgTypes.SYNCINFO:this._isPlaying=j.info._isPlaying,this._isPaused=j.info._isPaused,this.nowMSec=j.info.nowMSec,this.nowTimeStr=j.info.nowTimeStr,this.voiceCount=j.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case S.MsgTypes.PLAYSOUND:this.playSound();break;case S.MsgTypes.STOPSOUND:this.stopSound();break;case S.MsgTypes.EXPORT:j.data?this.completeAudioExport(j.data):this.errorAudioExport(j.errorMsg)}}boot(){this.worker.postMessage({type:S.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const A=N.audioCtx,j=this.gainNode=A.createGain();j.gain.value=this.volume/127,j.connect(A.destination),v(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(U=>{const F=new FileReader;F.onload=H=>{A.audioWorklet.addModule(H.target.result).then(U)},F.readAsDataURL(new Blob([E.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const C=this.workletNode=new AudioWorkletNode(A,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});C.connect(j),this.worker.postMessage({type:S.MsgTypes.PLAYSOUND,workletPort:C.port},[C.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:S.MsgTypes.STOPSOUND})}trigger(A,j){const C=this.events[A];if(!C)return;const U={};for(let F in j)U[F]=j[F];for(let F=0,H=C.length;F<H;F++)C[F]&&C[F].call(this,U)}exportAudio(A,j,C={}){return N.audioCtx||N.initWebAudio(),this.booted||this.boot(),new Promise((U,F)=>{this.audioExportResolve?F(new T.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:S.MsgTypes.EXPORT,mml:A,format:j},C)),this.audioExportResolve=U,this.audioExportReject=F)})}completeAudioExport(A){this.audioExportResolve&&(this.audioExportResolve(A),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(A){this.audioExportReject&&(this.audioExportReject(new T.FlMMLAudioExportError(A)),this.audioExportResolve=null,this.audioExportReject=null)}play(A){N.audioCtx||N.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:S.MsgTypes.PLAY,mml:A})}stop(){this.worker.postMessage({type:S.MsgTypes.STOP})}pause(){this.worker.postMessage({type:S.MsgTypes.PAUSE})}exportWav(A){return this.exportAudio(A,"wav")}exportMp3(A,j){return this.exportAudio(A,"mp3",{bitrate:j})}setMasterVolume(A){this.volume=A,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(A){this.worker.postMessage({type:S.MsgTypes.SYNCINFO,interval:A})}syncInfo(){this.worker.postMessage({type:S.MsgTypes.SYNCINFO,interval:null})}addEventListener(A,j){let C=this.events[A];C||(C=this.events[A]=[]);for(let U=C.length;U--;)if(C[U]===j)return!1;return C.push(j),!0}removeEventListener(A,j){const C=this.events[A];if(!C)return!1;for(let U=C.length;U--;)if(C[U]===j)return C.splice(U,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}c.FlMML=N,c.FlMMLonHTML5=N}).apply(l,f))===void 0||(t.exports=d)},158:(t,l,y)=>{y.r(l),y.d(l,{FlMMLWorkletScript:()=>f});const f='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},o={};function i(t){var l=o[t];if(l!==void 0)return l.exports;var y=o[t]={exports:{}};return r[t].call(y.exports,y,y.exports,i),y.exports}return i.d=(t,l)=>{for(var y in l)i.o(l,y)&&!i.o(t,y)&&Object.defineProperty(t,y,{enumerable:!0,get:l[y]})},i.o=(t,l)=>Object.prototype.hasOwnProperty.call(t,l),i.r=t=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i(643)})()})})(Vn);var zn=Vn.exports;function dt(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Yn={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(r){n.exports=r()})(function(){return function r(o,i,t){function l(d,v){if(!i[d]){if(!o[d]){var h=typeof dt=="function"&&dt;if(!v&&h)return h(d,!0);if(y)return y(d,!0);var c=new Error("Cannot find module '"+d+"'");throw c.code="MODULE_NOT_FOUND",c}var S=i[d]={exports:{}};o[d][0].call(S.exports,function(T){var E=o[d][1][T];return l(E||T)},S,S.exports,r,o,i,t)}return i[d].exports}for(var y=typeof dt=="function"&&dt,f=0;f<t.length;f++)l(t[f]);return l}({1:[function(r,o,i){(function(t){var l=t.MutationObserver||t.WebKitMutationObserver,y;if(l){var f=0,d=new l(T),v=t.document.createTextNode("");d.observe(v,{characterData:!0}),y=function(){v.data=f=++f%2}}else if(!t.setImmediate&&typeof t.MessageChannel<"u"){var h=new t.MessageChannel;h.port1.onmessage=T,y=function(){h.port2.postMessage(0)}}else"document"in t&&"onreadystatechange"in t.document.createElement("script")?y=function(){var g=t.document.createElement("script");g.onreadystatechange=function(){T(),g.onreadystatechange=null,g.parentNode.removeChild(g),g=null},t.document.documentElement.appendChild(g)}:y=function(){setTimeout(T,0)};var c,S=[];function T(){c=!0;for(var g,N,$=S.length;$;){for(N=S,S=[],g=-1;++g<$;)N[g]();$=S.length}c=!1}o.exports=E;function E(g){S.push(g)===1&&!c&&y()}}).call(this,typeof et<"u"?et:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,o,i){var t=r(1);function l(){}var y={},f=["REJECTED"],d=["FULFILLED"],v=["PENDING"];o.exports=h;function h(C){if(typeof C!="function")throw new TypeError("resolver must be a function");this.state=v,this.queue=[],this.outcome=void 0,C!==l&&E(this,C)}h.prototype.catch=function(C){return this.then(null,C)},h.prototype.then=function(C,U){if(typeof C!="function"&&this.state===d||typeof U!="function"&&this.state===f)return this;var F=new this.constructor(l);if(this.state!==v){var H=this.state===d?C:U;S(F,H,this.outcome)}else this.queue.push(new c(F,C,U));return F};function c(C,U,F){this.promise=C,typeof U=="function"&&(this.onFulfilled=U,this.callFulfilled=this.otherCallFulfilled),typeof F=="function"&&(this.onRejected=F,this.callRejected=this.otherCallRejected)}c.prototype.callFulfilled=function(C){y.resolve(this.promise,C)},c.prototype.otherCallFulfilled=function(C){S(this.promise,this.onFulfilled,C)},c.prototype.callRejected=function(C){y.reject(this.promise,C)},c.prototype.otherCallRejected=function(C){S(this.promise,this.onRejected,C)};function S(C,U,F){t(function(){var H;try{H=U(F)}catch(de){return y.reject(C,de)}H===C?y.reject(C,new TypeError("Cannot resolve promise with itself")):y.resolve(C,H)})}y.resolve=function(C,U){var F=g(T,U);if(F.status==="error")return y.reject(C,F.value);var H=F.value;if(H)E(C,H);else{C.state=d,C.outcome=U;for(var de=-1,ie=C.queue.length;++de<ie;)C.queue[de].callFulfilled(U)}return C},y.reject=function(C,U){C.state=f,C.outcome=U;for(var F=-1,H=C.queue.length;++F<H;)C.queue[F].callRejected(U);return C};function T(C){var U=C&&C.then;if(C&&(typeof C=="object"||typeof C=="function")&&typeof U=="function")return function(){U.apply(C,arguments)}}function E(C,U){var F=!1;function H(fe){F||(F=!0,y.reject(C,fe))}function de(fe){F||(F=!0,y.resolve(C,fe))}function ie(){U(de,H)}var te=g(ie);te.status==="error"&&H(te.value)}function g(C,U){var F={};try{F.value=C(U),F.status="success"}catch(H){F.status="error",F.value=H}return F}h.resolve=N;function N(C){return C instanceof this?C:y.resolve(new this(l),C)}h.reject=$;function $(C){var U=new this(l);return y.reject(U,C)}h.all=A;function A(C){var U=this;if(Object.prototype.toString.call(C)!=="[object Array]")return this.reject(new TypeError("must be an array"));var F=C.length,H=!1;if(!F)return this.resolve([]);for(var de=new Array(F),ie=0,te=-1,fe=new this(l);++te<F;)Ee(C[te],te);return fe;function Ee(L,w){U.resolve(L).then(B,function(D){H||(H=!0,y.reject(fe,D))});function B(D){de[w]=D,++ie===F&&!H&&(H=!0,y.resolve(fe,de))}}}h.race=j;function j(C){var U=this;if(Object.prototype.toString.call(C)!=="[object Array]")return this.reject(new TypeError("must be an array"));var F=C.length,H=!1;if(!F)return this.resolve([]);for(var de=-1,ie=new this(l);++de<F;)te(C[de]);return ie;function te(fe){U.resolve(fe).then(function(Ee){H||(H=!0,y.resolve(ie,Ee))},function(Ee){H||(H=!0,y.reject(ie,Ee))})}}},{1:1}],3:[function(r,o,i){(function(t){typeof t.Promise!="function"&&(t.Promise=r(2))}).call(this,typeof et<"u"?et:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,o,i){var t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};function l(a,u){if(!(a instanceof u))throw new TypeError("Cannot call a class as a function")}function y(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var f=y();function d(){try{if(!f||!f.open)return!1;var a=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),u=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!a||u)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function v(a,u){a=a||[],u=u||{};try{return new Blob(a,u)}catch(m){if(m.name!=="TypeError")throw m;for(var s=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,p=new s,b=0;b<a.length;b+=1)p.append(a[b]);return p.getBlob(u.type)}}typeof Promise>"u"&&r(3);var h=Promise;function c(a,u){u&&a.then(function(s){u(null,s)},function(s){u(s)})}function S(a,u,s){typeof u=="function"&&a.then(u),typeof s=="function"&&a.catch(s)}function T(a){return typeof a!="string"&&(console.warn(a+" used as a key, but it is not a string."),a=String(a)),a}function E(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var g="local-forage-detect-blob-support",N=void 0,$={},A=Object.prototype.toString,j="readonly",C="readwrite";function U(a){for(var u=a.length,s=new ArrayBuffer(u),p=new Uint8Array(s),b=0;b<u;b++)p[b]=a.charCodeAt(b);return s}function F(a){return new h(function(u){var s=a.transaction(g,C),p=v([""]);s.objectStore(g).put(p,"key"),s.onabort=function(b){b.preventDefault(),b.stopPropagation(),u(!1)},s.oncomplete=function(){var b=navigator.userAgent.match(/Chrome\/(\d+)/),m=navigator.userAgent.match(/Edge\//);u(m||!b||parseInt(b[1],10)>=43)}}).catch(function(){return!1})}function H(a){return typeof N=="boolean"?h.resolve(N):F(a).then(function(u){return N=u,N})}function de(a){var u=$[a.name],s={};s.promise=new h(function(p,b){s.resolve=p,s.reject=b}),u.deferredOperations.push(s),u.dbReady?u.dbReady=u.dbReady.then(function(){return s.promise}):u.dbReady=s.promise}function ie(a){var u=$[a.name],s=u.deferredOperations.pop();if(s)return s.resolve(),s.promise}function te(a,u){var s=$[a.name],p=s.deferredOperations.pop();if(p)return p.reject(u),p.promise}function fe(a,u){return new h(function(s,p){if($[a.name]=$[a.name]||ee(),a.db)if(u)de(a),a.db.close();else return s(a.db);var b=[a.name];u&&b.push(a.version);var m=f.open.apply(f,b);u&&(m.onupgradeneeded=function(x){var _=m.result;try{_.createObjectStore(a.storeName),x.oldVersion<=1&&_.createObjectStore(g)}catch(M){if(M.name==="ConstraintError")console.warn('The database "'+a.name+'" has been upgraded from version '+x.oldVersion+" to version "+x.newVersion+', but the storage "'+a.storeName+'" already exists.');else throw M}}),m.onerror=function(x){x.preventDefault(),p(m.error)},m.onsuccess=function(){var x=m.result;x.onversionchange=function(_){_.target.close()},s(x),ie(a)}})}function Ee(a){return fe(a,!1)}function L(a){return fe(a,!0)}function w(a,u){if(!a.db)return!0;var s=!a.db.objectStoreNames.contains(a.storeName),p=a.version<a.db.version,b=a.version>a.db.version;if(p&&(a.version!==u&&console.warn('The database "'+a.name+`" can't be downgraded from version `+a.db.version+" to version "+a.version+"."),a.version=a.db.version),b||s){if(s){var m=a.db.version+1;m>a.version&&(a.version=m)}return!0}return!1}function B(a){return new h(function(u,s){var p=new FileReader;p.onerror=s,p.onloadend=function(b){var m=btoa(b.target.result||"");u({__local_forage_encoded_blob:!0,data:m,type:a.type})},p.readAsBinaryString(a)})}function D(a){var u=U(atob(a.data));return v([u],{type:a.type})}function V(a){return a&&a.__local_forage_encoded_blob}function q(a){var u=this,s=u._initReady().then(function(){var p=$[u._dbInfo.name];if(p&&p.dbReady)return p.dbReady});return S(s,a,a),s}function Y(a){de(a);for(var u=$[a.name],s=u.forages,p=0;p<s.length;p++){var b=s[p];b._dbInfo.db&&(b._dbInfo.db.close(),b._dbInfo.db=null)}return a.db=null,Ee(a).then(function(m){return a.db=m,w(a)?L(a):m}).then(function(m){a.db=u.db=m;for(var x=0;x<s.length;x++)s[x]._dbInfo.db=m}).catch(function(m){throw te(a,m),m})}function J(a,u,s,p){p===void 0&&(p=1);try{var b=a.db.transaction(a.storeName,u);s(null,b)}catch(m){if(p>0&&(!a.db||m.name==="InvalidStateError"||m.name==="NotFoundError"))return h.resolve().then(function(){if(!a.db||m.name==="NotFoundError"&&!a.db.objectStoreNames.contains(a.storeName)&&a.version<=a.db.version)return a.db&&(a.version=a.db.version+1),L(a)}).then(function(){return Y(a).then(function(){J(a,u,s,p-1)})}).catch(s);s(m)}}function ee(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function he(a){var u=this,s={db:null};if(a)for(var p in a)s[p]=a[p];var b=$[s.name];b||(b=ee(),$[s.name]=b),b.forages.push(u),u._initReady||(u._initReady=u.ready,u.ready=q);var m=[];function x(){return h.resolve()}for(var _=0;_<b.forages.length;_++){var M=b.forages[_];M!==u&&m.push(M._initReady().catch(x))}var O=b.forages.slice(0);return h.all(m).then(function(){return s.db=b.db,Ee(s)}).then(function(P){return s.db=P,w(s,u._defaultConfig.version)?L(s):P}).then(function(P){s.db=b.db=P,u._dbInfo=s;for(var z=0;z<O.length;z++){var Z=O[z];Z!==u&&(Z._dbInfo.db=s.db,Z._dbInfo.version=s.version)}})}function Se(a,u){var s=this;a=T(a);var p=new h(function(b,m){s.ready().then(function(){J(s._dbInfo,j,function(x,_){if(x)return m(x);try{var M=_.objectStore(s._dbInfo.storeName),O=M.get(a);O.onsuccess=function(){var P=O.result;P===void 0&&(P=null),V(P)&&(P=D(P)),b(P)},O.onerror=function(){m(O.error)}}catch(P){m(P)}})}).catch(m)});return c(p,u),p}function Ae(a,u){var s=this,p=new h(function(b,m){s.ready().then(function(){J(s._dbInfo,j,function(x,_){if(x)return m(x);try{var M=_.objectStore(s._dbInfo.storeName),O=M.openCursor(),P=1;O.onsuccess=function(){var z=O.result;if(z){var Z=z.value;V(Z)&&(Z=D(Z));var oe=a(Z,z.key,P++);oe!==void 0?b(oe):z.continue()}else b()},O.onerror=function(){m(O.error)}}catch(z){m(z)}})}).catch(m)});return c(p,u),p}function k(a,u,s){var p=this;a=T(a);var b=new h(function(m,x){var _;p.ready().then(function(){return _=p._dbInfo,A.call(u)==="[object Blob]"?H(_.db).then(function(M){return M?u:B(u)}):u}).then(function(M){J(p._dbInfo,C,function(O,P){if(O)return x(O);try{var z=P.objectStore(p._dbInfo.storeName);M===null&&(M=void 0);var Z=z.put(M,a);P.oncomplete=function(){M===void 0&&(M=null),m(M)},P.onabort=P.onerror=function(){var oe=Z.error?Z.error:Z.transaction.error;x(oe)}}catch(oe){x(oe)}})}).catch(x)});return c(b,s),b}function W(a,u){var s=this;a=T(a);var p=new h(function(b,m){s.ready().then(function(){J(s._dbInfo,C,function(x,_){if(x)return m(x);try{var M=_.objectStore(s._dbInfo.storeName),O=M.delete(a);_.oncomplete=function(){b()},_.onerror=function(){m(O.error)},_.onabort=function(){var P=O.error?O.error:O.transaction.error;m(P)}}catch(P){m(P)}})}).catch(m)});return c(p,u),p}function G(a){var u=this,s=new h(function(p,b){u.ready().then(function(){J(u._dbInfo,C,function(m,x){if(m)return b(m);try{var _=x.objectStore(u._dbInfo.storeName),M=_.clear();x.oncomplete=function(){p()},x.onabort=x.onerror=function(){var O=M.error?M.error:M.transaction.error;b(O)}}catch(O){b(O)}})}).catch(b)});return c(s,a),s}function K(a){var u=this,s=new h(function(p,b){u.ready().then(function(){J(u._dbInfo,j,function(m,x){if(m)return b(m);try{var _=x.objectStore(u._dbInfo.storeName),M=_.count();M.onsuccess=function(){p(M.result)},M.onerror=function(){b(M.error)}}catch(O){b(O)}})}).catch(b)});return c(s,a),s}function ae(a,u){var s=this,p=new h(function(b,m){if(a<0){b(null);return}s.ready().then(function(){J(s._dbInfo,j,function(x,_){if(x)return m(x);try{var M=_.objectStore(s._dbInfo.storeName),O=!1,P=M.openKeyCursor();P.onsuccess=function(){var z=P.result;if(!z){b(null);return}a===0||O?b(z.key):(O=!0,z.advance(a))},P.onerror=function(){m(P.error)}}catch(z){m(z)}})}).catch(m)});return c(p,u),p}function ne(a){var u=this,s=new h(function(p,b){u.ready().then(function(){J(u._dbInfo,j,function(m,x){if(m)return b(m);try{var _=x.objectStore(u._dbInfo.storeName),M=_.openKeyCursor(),O=[];M.onsuccess=function(){var P=M.result;if(!P){p(O);return}O.push(P.key),P.continue()},M.onerror=function(){b(M.error)}}catch(P){b(P)}})}).catch(b)});return c(s,a),s}function be(a,u){u=E.apply(this,arguments);var s=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||s.name,a.storeName=a.storeName||s.storeName);var p=this,b;if(!a.name)b=h.reject("Invalid arguments");else{var m=a.name===s.name&&p._dbInfo.db,x=m?h.resolve(p._dbInfo.db):Ee(a).then(function(_){var M=$[a.name],O=M.forages;M.db=_;for(var P=0;P<O.length;P++)O[P]._dbInfo.db=_;return _});a.storeName?b=x.then(function(_){if(_.objectStoreNames.contains(a.storeName)){var M=_.version+1;de(a);var O=$[a.name],P=O.forages;_.close();for(var z=0;z<P.length;z++){var Z=P[z];Z._dbInfo.db=null,Z._dbInfo.version=M}var oe=new h(function(se,ve){var me=f.open(a.name,M);me.onerror=function(xe){var Qe=me.result;Qe.close(),ve(xe)},me.onupgradeneeded=function(){var xe=me.result;xe.deleteObjectStore(a.storeName)},me.onsuccess=function(){var xe=me.result;xe.close(),se(xe)}});return oe.then(function(se){O.db=se;for(var ve=0;ve<P.length;ve++){var me=P[ve];me._dbInfo.db=se,ie(me._dbInfo)}}).catch(function(se){throw(te(a,se)||h.resolve()).catch(function(){}),se})}}):b=x.then(function(_){de(a);var M=$[a.name],O=M.forages;_.close();for(var P=0;P<O.length;P++){var z=O[P];z._dbInfo.db=null}var Z=new h(function(oe,se){var ve=f.deleteDatabase(a.name);ve.onerror=function(){var me=ve.result;me&&me.close(),se(ve.error)},ve.onblocked=function(){console.warn('dropInstance blocked for database "'+a.name+'" until all open connections are closed')},ve.onsuccess=function(){var me=ve.result;me&&me.close(),oe(me)}});return Z.then(function(oe){M.db=oe;for(var se=0;se<O.length;se++){var ve=O[se];ie(ve._dbInfo)}}).catch(function(oe){throw(te(a,oe)||h.resolve()).catch(function(){}),oe})})}return c(b,u),b}var Ve={_driver:"asyncStorage",_initStorage:he,_support:d(),iterate:Ae,getItem:Se,setItem:k,removeItem:W,clear:G,length:K,key:ae,keys:ne,dropInstance:be};function mr(){return typeof openDatabase=="function"}var Me="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",pr="~~local_forage_type~",hn=/^~~local_forage_type~([^~]+)~/,lt="__lfsc__:",Mt=lt.length,Ot="arbf",Pt="blob",mn="si08",pn="ui08",vn="uic8",gn="si16",yn="si32",bn="ur16",En="ui32",Sn="fl32",wn="fl64",Tn=Mt+Ot.length,kn=Object.prototype.toString;function xn(a){var u=a.length*.75,s=a.length,p,b=0,m,x,_,M;a[a.length-1]==="="&&(u--,a[a.length-2]==="="&&u--);var O=new ArrayBuffer(u),P=new Uint8Array(O);for(p=0;p<s;p+=4)m=Me.indexOf(a[p]),x=Me.indexOf(a[p+1]),_=Me.indexOf(a[p+2]),M=Me.indexOf(a[p+3]),P[b++]=m<<2|x>>4,P[b++]=(x&15)<<4|_>>2,P[b++]=(_&3)<<6|M&63;return O}function jt(a){var u=new Uint8Array(a),s="",p;for(p=0;p<u.length;p+=3)s+=Me[u[p]>>2],s+=Me[(u[p]&3)<<4|u[p+1]>>4],s+=Me[(u[p+1]&15)<<2|u[p+2]>>6],s+=Me[u[p+2]&63];return u.length%3===2?s=s.substring(0,s.length-1)+"=":u.length%3===1&&(s=s.substring(0,s.length-2)+"=="),s}function vr(a,u){var s="";if(a&&(s=kn.call(a)),a&&(s==="[object ArrayBuffer]"||a.buffer&&kn.call(a.buffer)==="[object ArrayBuffer]")){var p,b=lt;a instanceof ArrayBuffer?(p=a,b+=Ot):(p=a.buffer,s==="[object Int8Array]"?b+=mn:s==="[object Uint8Array]"?b+=pn:s==="[object Uint8ClampedArray]"?b+=vn:s==="[object Int16Array]"?b+=gn:s==="[object Uint16Array]"?b+=bn:s==="[object Int32Array]"?b+=yn:s==="[object Uint32Array]"?b+=En:s==="[object Float32Array]"?b+=Sn:s==="[object Float64Array]"?b+=wn:u(new Error("Failed to get type for BinaryArray"))),u(b+jt(p))}else if(s==="[object Blob]"){var m=new FileReader;m.onload=function(){var x=pr+a.type+"~"+jt(this.result);u(lt+Pt+x)},m.readAsArrayBuffer(a)}else try{u(JSON.stringify(a))}catch(x){console.error("Couldn't convert value into a JSON string: ",a),u(null,x)}}function gr(a){if(a.substring(0,Mt)!==lt)return JSON.parse(a);var u=a.substring(Tn),s=a.substring(Mt,Tn),p;if(s===Pt&&hn.test(u)){var b=u.match(hn);p=b[1],u=u.substring(b[0].length)}var m=xn(u);switch(s){case Ot:return m;case Pt:return v([m],{type:p});case mn:return new Int8Array(m);case pn:return new Uint8Array(m);case vn:return new Uint8ClampedArray(m);case gn:return new Int16Array(m);case bn:return new Uint16Array(m);case yn:return new Int32Array(m);case En:return new Uint32Array(m);case Sn:return new Float32Array(m);case wn:return new Float64Array(m);default:throw new Error("Unkown type: "+s)}}var Bt={serialize:vr,deserialize:gr,stringToBuffer:xn,bufferToString:jt};function Cn(a,u,s,p){a.executeSql("CREATE TABLE IF NOT EXISTS "+u.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],s,p)}function yr(a){var u=this,s={db:null};if(a)for(var p in a)s[p]=typeof a[p]!="string"?a[p].toString():a[p];var b=new h(function(m,x){try{s.db=openDatabase(s.name,String(s.version),s.description,s.size)}catch(_){return x(_)}s.db.transaction(function(_){Cn(_,s,function(){u._dbInfo=s,m()},function(M,O){x(O)})},x)});return s.serializer=Bt,b}function Oe(a,u,s,p,b,m){a.executeSql(s,p,b,function(x,_){_.code===_.SYNTAX_ERR?x.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[u.storeName],function(M,O){O.rows.length?m(M,_):Cn(M,u,function(){M.executeSql(s,p,b,m)},m)},m):m(x,_)},m)}function br(a,u){var s=this;a=T(a);var p=new h(function(b,m){s.ready().then(function(){var x=s._dbInfo;x.db.transaction(function(_){Oe(_,x,"SELECT * FROM "+x.storeName+" WHERE key = ? LIMIT 1",[a],function(M,O){var P=O.rows.length?O.rows.item(0).value:null;P&&(P=x.serializer.deserialize(P)),b(P)},function(M,O){m(O)})})}).catch(m)});return c(p,u),p}function Er(a,u){var s=this,p=new h(function(b,m){s.ready().then(function(){var x=s._dbInfo;x.db.transaction(function(_){Oe(_,x,"SELECT * FROM "+x.storeName,[],function(M,O){for(var P=O.rows,z=P.length,Z=0;Z<z;Z++){var oe=P.item(Z),se=oe.value;if(se&&(se=x.serializer.deserialize(se)),se=a(se,oe.key,Z+1),se!==void 0){b(se);return}}b()},function(M,O){m(O)})})}).catch(m)});return c(p,u),p}function In(a,u,s,p){var b=this;a=T(a);var m=new h(function(x,_){b.ready().then(function(){u===void 0&&(u=null);var M=u,O=b._dbInfo;O.serializer.serialize(u,function(P,z){z?_(z):O.db.transaction(function(Z){Oe(Z,O,"INSERT OR REPLACE INTO "+O.storeName+" (key, value) VALUES (?, ?)",[a,P],function(){x(M)},function(oe,se){_(se)})},function(Z){if(Z.code===Z.QUOTA_ERR){if(p>0){x(In.apply(b,[a,M,s,p-1]));return}_(Z)}})})}).catch(_)});return c(m,s),m}function Sr(a,u,s){return In.apply(this,[a,u,s,1])}function wr(a,u){var s=this;a=T(a);var p=new h(function(b,m){s.ready().then(function(){var x=s._dbInfo;x.db.transaction(function(_){Oe(_,x,"DELETE FROM "+x.storeName+" WHERE key = ?",[a],function(){b()},function(M,O){m(O)})})}).catch(m)});return c(p,u),p}function Tr(a){var u=this,s=new h(function(p,b){u.ready().then(function(){var m=u._dbInfo;m.db.transaction(function(x){Oe(x,m,"DELETE FROM "+m.storeName,[],function(){p()},function(_,M){b(M)})})}).catch(b)});return c(s,a),s}function kr(a){var u=this,s=new h(function(p,b){u.ready().then(function(){var m=u._dbInfo;m.db.transaction(function(x){Oe(x,m,"SELECT COUNT(key) as c FROM "+m.storeName,[],function(_,M){var O=M.rows.item(0).c;p(O)},function(_,M){b(M)})})}).catch(b)});return c(s,a),s}function xr(a,u){var s=this,p=new h(function(b,m){s.ready().then(function(){var x=s._dbInfo;x.db.transaction(function(_){Oe(_,x,"SELECT key FROM "+x.storeName+" WHERE id = ? LIMIT 1",[a+1],function(M,O){var P=O.rows.length?O.rows.item(0).key:null;b(P)},function(M,O){m(O)})})}).catch(m)});return c(p,u),p}function Cr(a){var u=this,s=new h(function(p,b){u.ready().then(function(){var m=u._dbInfo;m.db.transaction(function(x){Oe(x,m,"SELECT key FROM "+m.storeName,[],function(_,M){for(var O=[],P=0;P<M.rows.length;P++)O.push(M.rows.item(P).key);p(O)},function(_,M){b(M)})})}).catch(b)});return c(s,a),s}function Ir(a){return new h(function(u,s){a.transaction(function(p){p.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(b,m){for(var x=[],_=0;_<m.rows.length;_++)x.push(m.rows.item(_).name);u({db:a,storeNames:x})},function(b,m){s(m)})},function(p){s(p)})})}function Ar(a,u){u=E.apply(this,arguments);var s=this.config();a=typeof a!="function"&&a||{},a.name||(a.name=a.name||s.name,a.storeName=a.storeName||s.storeName);var p=this,b;return a.name?b=new h(function(m){var x;a.name===s.name?x=p._dbInfo.db:x=openDatabase(a.name,"","",0),a.storeName?m({db:x,storeNames:[a.storeName]}):m(Ir(x))}).then(function(m){return new h(function(x,_){m.db.transaction(function(M){function O(oe){return new h(function(se,ve){M.executeSql("DROP TABLE IF EXISTS "+oe,[],function(){se()},function(me,xe){ve(xe)})})}for(var P=[],z=0,Z=m.storeNames.length;z<Z;z++)P.push(O(m.storeNames[z]));h.all(P).then(function(){x()}).catch(function(oe){_(oe)})},function(M){_(M)})})}):b=h.reject("Invalid arguments"),c(b,u),b}var _r={_driver:"webSQLStorage",_initStorage:yr,_support:mr(),iterate:Er,getItem:br,setItem:Sr,removeItem:wr,clear:Tr,length:kr,key:xr,keys:Cr,dropInstance:Ar};function Dr(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function An(a,u){var s=a.name+"/";return a.storeName!==u.storeName&&(s+=a.storeName+"/"),s}function Nr(){var a="_localforage_support_test";try{return localStorage.setItem(a,!0),localStorage.removeItem(a),!1}catch{return!0}}function Lr(){return!Nr()||localStorage.length>0}function Mr(a){var u=this,s={};if(a)for(var p in a)s[p]=a[p];return s.keyPrefix=An(a,u._defaultConfig),Lr()?(u._dbInfo=s,s.serializer=Bt,h.resolve()):h.reject()}function Or(a){var u=this,s=u.ready().then(function(){for(var p=u._dbInfo.keyPrefix,b=localStorage.length-1;b>=0;b--){var m=localStorage.key(b);m.indexOf(p)===0&&localStorage.removeItem(m)}});return c(s,a),s}function Pr(a,u){var s=this;a=T(a);var p=s.ready().then(function(){var b=s._dbInfo,m=localStorage.getItem(b.keyPrefix+a);return m&&(m=b.serializer.deserialize(m)),m});return c(p,u),p}function jr(a,u){var s=this,p=s.ready().then(function(){for(var b=s._dbInfo,m=b.keyPrefix,x=m.length,_=localStorage.length,M=1,O=0;O<_;O++){var P=localStorage.key(O);if(P.indexOf(m)===0){var z=localStorage.getItem(P);if(z&&(z=b.serializer.deserialize(z)),z=a(z,P.substring(x),M++),z!==void 0)return z}}});return c(p,u),p}function Br(a,u){var s=this,p=s.ready().then(function(){var b=s._dbInfo,m;try{m=localStorage.key(a)}catch{m=null}return m&&(m=m.substring(b.keyPrefix.length)),m});return c(p,u),p}function Rr(a){var u=this,s=u.ready().then(function(){for(var p=u._dbInfo,b=localStorage.length,m=[],x=0;x<b;x++){var _=localStorage.key(x);_.indexOf(p.keyPrefix)===0&&m.push(_.substring(p.keyPrefix.length))}return m});return c(s,a),s}function Ur(a){var u=this,s=u.keys().then(function(p){return p.length});return c(s,a),s}function $r(a,u){var s=this;a=T(a);var p=s.ready().then(function(){var b=s._dbInfo;localStorage.removeItem(b.keyPrefix+a)});return c(p,u),p}function Fr(a,u,s){var p=this;a=T(a);var b=p.ready().then(function(){u===void 0&&(u=null);var m=u;return new h(function(x,_){var M=p._dbInfo;M.serializer.serialize(u,function(O,P){if(P)_(P);else try{localStorage.setItem(M.keyPrefix+a,O),x(m)}catch(z){(z.name==="QuotaExceededError"||z.name==="NS_ERROR_DOM_QUOTA_REACHED")&&_(z),_(z)}})})});return c(b,s),b}function Wr(a,u){if(u=E.apply(this,arguments),a=typeof a!="function"&&a||{},!a.name){var s=this.config();a.name=a.name||s.name,a.storeName=a.storeName||s.storeName}var p=this,b;return a.name?b=new h(function(m){a.storeName?m(An(a,p._defaultConfig)):m(a.name+"/")}).then(function(m){for(var x=localStorage.length-1;x>=0;x--){var _=localStorage.key(x);_.indexOf(m)===0&&localStorage.removeItem(_)}}):b=h.reject("Invalid arguments"),c(b,u),b}var Vr={_driver:"localStorageWrapper",_initStorage:Mr,_support:Dr(),iterate:jr,getItem:Pr,setItem:Fr,removeItem:$r,clear:Or,length:Ur,key:Br,keys:Rr,dropInstance:Wr},zr=function(u,s){return u===s||typeof u=="number"&&typeof s=="number"&&isNaN(u)&&isNaN(s)},Yr=function(u,s){for(var p=u.length,b=0;b<p;){if(zr(u[b],s))return!0;b++}return!1},_n=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},Je={},Dn={},ze={INDEXEDDB:Ve,WEBSQL:_r,LOCALSTORAGE:Vr},Hr=[ze.INDEXEDDB._driver,ze.WEBSQL._driver,ze.LOCALSTORAGE._driver],ut=["dropInstance"],Rt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(ut),qr={description:"",driver:Hr.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Gr(a,u){a[u]=function(){var s=arguments;return a.ready().then(function(){return a[u].apply(a,s)})}}function Ut(){for(var a=1;a<arguments.length;a++){var u=arguments[a];if(u)for(var s in u)u.hasOwnProperty(s)&&(_n(u[s])?arguments[0][s]=u[s].slice():arguments[0][s]=u[s])}return arguments[0]}var Kr=function(){function a(u){l(this,a);for(var s in ze)if(ze.hasOwnProperty(s)){var p=ze[s],b=p._driver;this[s]=b,Je[b]||this.defineDriver(p)}this._defaultConfig=Ut({},qr),this._config=Ut({},this._defaultConfig,u),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return a.prototype.config=function(s){if((typeof s>"u"?"undefined":t(s))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var p in s){if(p==="storeName"&&(s[p]=s[p].replace(/\W/g,"_")),p==="version"&&typeof s[p]!="number")return new Error("Database version must be a number.");this._config[p]=s[p]}return"driver"in s&&s.driver?this.setDriver(this._config.driver):!0}else return typeof s=="string"?this._config[s]:this._config},a.prototype.defineDriver=function(s,p,b){var m=new h(function(x,_){try{var M=s._driver,O=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!s._driver){_(O);return}for(var P=Rt.concat("_initStorage"),z=0,Z=P.length;z<Z;z++){var oe=P[z],se=!Yr(ut,oe);if((se||s[oe])&&typeof s[oe]!="function"){_(O);return}}var ve=function(){for(var Qe=function(Qr){return function(){var Zr=new Error("Method "+Qr+" is not implemented by the current driver"),Nn=h.reject(Zr);return c(Nn,arguments[arguments.length-1]),Nn}},$t=0,Jr=ut.length;$t<Jr;$t++){var Ft=ut[$t];s[Ft]||(s[Ft]=Qe(Ft))}};ve();var me=function(Qe){Je[M]&&console.info("Redefining LocalForage driver: "+M),Je[M]=s,Dn[M]=Qe,x()};"_support"in s?s._support&&typeof s._support=="function"?s._support().then(me,_):me(!!s._support):me(!0)}catch(xe){_(xe)}});return S(m,p,b),m},a.prototype.driver=function(){return this._driver||null},a.prototype.getDriver=function(s,p,b){var m=Je[s]?h.resolve(Je[s]):h.reject(new Error("Driver not found."));return S(m,p,b),m},a.prototype.getSerializer=function(s){var p=h.resolve(Bt);return S(p,s),p},a.prototype.ready=function(s){var p=this,b=p._driverSet.then(function(){return p._ready===null&&(p._ready=p._initDriver()),p._ready});return S(b,s,s),b},a.prototype.setDriver=function(s,p,b){var m=this;_n(s)||(s=[s]);var x=this._getSupportedDrivers(s);function _(){m._config.driver=m.driver()}function M(z){return m._extend(z),_(),m._ready=m._initStorage(m._config),m._ready}function O(z){return function(){var Z=0;function oe(){for(;Z<z.length;){var se=z[Z];return Z++,m._dbInfo=null,m._ready=null,m.getDriver(se).then(M).catch(oe)}_();var ve=new Error("No available storage method found.");return m._driverSet=h.reject(ve),m._driverSet}return oe()}}var P=this._driverSet!==null?this._driverSet.catch(function(){return h.resolve()}):h.resolve();return this._driverSet=P.then(function(){var z=x[0];return m._dbInfo=null,m._ready=null,m.getDriver(z).then(function(Z){m._driver=Z._driver,_(),m._wrapLibraryMethodsWithReady(),m._initDriver=O(x)})}).catch(function(){_();var z=new Error("No available storage method found.");return m._driverSet=h.reject(z),m._driverSet}),S(this._driverSet,p,b),this._driverSet},a.prototype.supports=function(s){return!!Dn[s]},a.prototype._extend=function(s){Ut(this,s)},a.prototype._getSupportedDrivers=function(s){for(var p=[],b=0,m=s.length;b<m;b++){var x=s[b];this.supports(x)&&p.push(x)}return p},a.prototype._wrapLibraryMethodsWithReady=function(){for(var s=0,p=Rt.length;s<p;s++)Gr(this,Rt[s])},a.prototype.createInstance=function(s){return new a(s)},a}(),Xr=new Kr;o.exports=Xr},{3:3}]},{},[4])(4)})})(Yn);var na=Yn.exports;const Xt=ta(na);function ft(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function Wt(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const ra=1,aa=1,We="emoji",Ke="keyvalue",sn="favorites",oa="tokens",Hn="tokens",sa="unicode",qn="count",ia="group",ca="order",Gn="group-order",Jt="eTag",bt="url",Mn="skinTone",Xe="readonly",cn="readwrite",Kn="skinUnicodes",la="skinUnicodes",ua="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",da="en";function fa(n,e){const r=new Set,o=[];for(const i of n){const t=e(i);r.has(t)||(r.add(t),o.push(i))}return o}function On(n){return fa(n,e=>e.unicode)}function ha(n){function e(r,o,i){const t=o?n.createObjectStore(r,{keyPath:o}):n.createObjectStore(r);if(i)for(const[l,[y,f]]of Object.entries(i))t.createIndex(l,y,{multiEntry:f});return t}e(Ke),e(We,sa,{[Hn]:[oa,!0],[Gn]:[[ia,ca]],[Kn]:[la,!0]}),e(sn,void 0,{[qn]:[""]})}const Qt={},pt={},Et={};function Xn(n,e,r){r.onerror=()=>e(r.error),r.onblocked=()=>e(new Error("IDB blocked")),r.onsuccess=()=>n(r.result)}async function ma(n){const e=await new Promise((r,o)=>{const i=indexedDB.open(n,ra);Qt[n]=i,i.onupgradeneeded=t=>{t.oldVersion<aa&&ha(i.result)},Xn(r,o,i)});return e.onclose=()=>ln(n),e}function pa(n){return pt[n]||(pt[n]=ma(n)),pt[n]}function Le(n,e,r,o){return new Promise((i,t)=>{const l=n.transaction(e,r,{durability:"relaxed"}),y=typeof e=="string"?l.objectStore(e):e.map(d=>l.objectStore(d));let f;o(y,l,d=>{f=d}),l.oncomplete=()=>i(f),l.onerror=()=>t(l.error)})}function ln(n){const e=Qt[n],r=e&&e.result;if(r){r.close();const o=Et[n];if(o)for(const i of o)i()}delete Qt[n],delete pt[n],delete Et[n]}function va(n){return new Promise((e,r)=>{ln(n);const o=indexedDB.deleteDatabase(n);Xn(e,r,o)})}function ga(n,e){let r=Et[n];r||(r=Et[n]=[]),r.push(e)}const ya=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function Ye(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||ya.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const ba=2;function Jn(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=ba)}function Ea(n){return n.map(({annotation:r,emoticon:o,group:i,order:t,shortcodes:l,skins:y,tags:f,emoji:d,version:v})=>{const h=[...new Set(Jn([...(l||[]).map(Ye).flat(),...f.map(Ye).flat(),...Ye(r),o]))].sort(),c={annotation:r,group:i,order:t,tags:f,tokens:h,unicode:d,version:v};if(o&&(c.emoticon=o),l&&(c.shortcodes=l),y){c.skinTones=[],c.skinUnicodes=[],c.skinVersions=[];for(const{tone:S,emoji:T,version:E}of y)c.skinTones.push(S),c.skinUnicodes.push(T),c.skinVersions.push(E)}return c})}function Qn(n,e,r,o){n[e](r).onsuccess=i=>o&&o(i.target.result)}function Fe(n,e,r){Qn(n,"get",e,r)}function Zn(n,e,r){Qn(n,"getAll",e,r)}function un(n){n.commit&&n.commit()}function Sa(n,e){let r=n[0];for(let o=1;o<n.length;o++){const i=n[o];e(r)>e(i)&&(r=i)}return r}function er(n,e){const r=Sa(n,i=>i.length),o=[];for(const i of r)n.some(t=>t.findIndex(l=>e(l)===e(i))===-1)||o.push(i);return o}async function wa(n){return!await dn(n,Ke,bt)}async function Ta(n,e,r){const[o,i]=await Promise.all([Jt,bt].map(t=>dn(n,Ke,t)));return o===r&&i===e}async function ka(n,e){return Le(n,We,Xe,(o,i,t)=>{let l;const y=()=>{o.getAll(l&&IDBKeyRange.lowerBound(l,!0),50).onsuccess=f=>{const d=f.target.result;for(const v of d)if(l=v.unicode,e(v))return t(v);if(d.length<50)return t();y()}};y()})}async function tr(n,e,r,o){try{const i=Ea(e);await Le(n,[We,Ke],cn,([t,l],y)=>{let f,d,v=0;function h(){++v===2&&c()}function c(){if(!(f===o&&d===r)){t.clear();for(const S of i)t.put(S);l.put(o,Jt),l.put(r,bt),un(y)}}Fe(l,Jt,S=>{f=S,h()}),Fe(l,bt,S=>{d=S,h()})})}finally{}}async function xa(n,e){return Le(n,We,Xe,(r,o,i)=>{const t=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);Zn(r.index(Gn),t,i)})}async function nr(n,e){const r=Jn(Ye(e));return r.length?Le(n,We,Xe,(o,i,t)=>{const l=[],y=()=>{l.length===r.length&&f()},f=()=>{const d=er(l,v=>v.unicode);t(d.sort((v,h)=>v.order<h.order?-1:1))};for(let d=0;d<r.length;d++){const v=r[d],h=d===r.length-1?IDBKeyRange.bound(v,v+"￿",!1,!0):IDBKeyRange.only(v);Zn(o.index(Hn),h,c=>{l.push(c),y()})}}):[]}async function Ca(n,e){const r=await nr(n,e);return r.length?r.filter(o=>(o.shortcodes||[]).map(t=>t.toLowerCase()).includes(e.toLowerCase()))[0]||null:await ka(n,i=>(i.shortcodes||[]).includes(e.toLowerCase()))||null}async function Ia(n,e){return Le(n,We,Xe,(r,o,i)=>Fe(r,e,t=>{if(t)return i(t);Fe(r.index(Kn),e,l=>i(l||null))}))}function dn(n,e,r){return Le(n,e,Xe,(o,i,t)=>Fe(o,r,t))}function Aa(n,e,r,o){return Le(n,e,cn,(i,t)=>{i.put(o,r),un(t)})}function _a(n,e){return Le(n,sn,cn,(r,o)=>Fe(r,e,i=>{r.put((i||0)+1,e),un(o)}))}function Da(n,e,r){return r===0?[]:Le(n,[sn,We],Xe,([o,i],t,l)=>{const y=[];o.index(qn).openCursor(void 0,"prev").onsuccess=f=>{const d=f.target.result;if(!d)return l(y);function v(S){if(y.push(S),y.length===r)return l(y);d.continue()}const h=d.primaryKey,c=e.byName(h);if(c)return v(c);Fe(i,h,S=>{if(S)return v(S);d.continue()})}})}const ht="";function Na(n,e){const r=new Map;for(const i of n){const t=e(i);for(const l of t){let y=r;for(let d=0;d<l.length;d++){const v=l.charAt(d);let h=y.get(v);h||(h=new Map,y.set(v,h)),y=h}let f=y.get(ht);f||(f=[],y.set(ht,f)),f.push(i)}}return(i,t)=>{let l=r;for(let d=0;d<i.length;d++){const v=i.charAt(d),h=l.get(v);if(h)l=h;else return[]}if(t)return l.get(ht)||[];const y=[],f=[l];for(;f.length;){const v=[...f.shift().entries()].sort((h,c)=>h[0]<c[0]?-1:1);for(const[h,c]of v)h===ht?y.push(...c):f.push(c)}return y}}const La=["name","url"];function Ma(n){const e=n&&Array.isArray(n),r=e&&n.length&&(!n[0]||La.some(o=>!(o in n[0])));if(!e||r)throw new Error("Custom emojis are in the wrong format")}function Pn(n){Ma(n);const e=(c,S)=>c.name.toLowerCase()<S.name.toLowerCase()?-1:1,r=n.sort(e),i=Na(n,c=>[...new Set((c.shortcodes||[]).map(S=>Ye(S)).flat())]),t=c=>i(c,!0),l=c=>i(c,!1),y=c=>{const S=Ye(c),T=S.map((E,g)=>(g<S.length-1?t:l)(E));return er(T,E=>E.name).sort(e)},f=new Map,d=new Map;for(const c of n){d.set(c.name.toLowerCase(),c);for(const S of c.shortcodes||[])f.set(S.toLowerCase(),c)}return{all:r,search:y,byShortcode:c=>f.get(c.toLowerCase()),byName:c=>d.get(c.toLowerCase())}}const Oa=typeof wrappedJSObject<"u";function Ze(n){if(!n)return n;if(Oa&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let r=0;r<e;r++)n.skins[r]={tone:n.skinTones[r],unicode:n.skinUnicodes[r],version:n.skinVersions[r]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function rr(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const Pa=["annotation","emoji","group","order","tags","version"];function ja(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||Pa.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function ar(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function Ba(n){const e=await fetch(n,{method:"HEAD"});ar(e,n);const r=e.headers.get("etag");return rr(r),r}async function Zt(n){const e=await fetch(n);ar(e,n);const r=e.headers.get("etag");rr(r);const o=await e.json();return ja(o),[r,o]}function Ra(n){for(var e="",r=new Uint8Array(n),o=r.byteLength,i=-1;++i<o;)e+=String.fromCharCode(r[i]);return e}function Ua(n){for(var e=n.length,r=new ArrayBuffer(e),o=new Uint8Array(r),i=-1;++i<e;)o[i]=n.charCodeAt(i);return r}async function or(n){const e=JSON.stringify(n);let r=Ua(e);const o=await crypto.subtle.digest("SHA-1",r),i=Ra(o);return btoa(i)}async function $a(n,e){let r,o=await Ba(e);if(!o){const i=await Zt(e);o=i[0],r=i[1],o||(o=await or(r))}await Ta(n,e,o)||(r||(r=(await Zt(e))[1]),await tr(n,r,e,o))}async function Fa(n,e){let[r,o]=await Zt(e);r||(r=await or(o)),await tr(n,o,e,r)}class Wa{constructor({dataSource:e=ua,locale:r=da,customEmoji:o=[]}={}){this.dataSource=e,this.locale=r,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=Pn(o),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await pa(this._dbName);ga(this._dbName,this._clear);const r=this.dataSource;await wa(e)?await Fa(e,r):this._lazyUpdate=$a(e,r)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return Wt(e),await this.ready(),On(await xa(this._db,e)).map(Ze)}async getEmojiBySearchQuery(e){ft(e),await this.ready();const r=this._custom.search(e),o=On(await nr(this._db,e)).map(Ze);return[...r,...o]}async getEmojiByShortcode(e){ft(e),await this.ready();const r=this._custom.byShortcode(e);return r||Ze(await Ca(this._db,e))}async getEmojiByUnicodeOrName(e){ft(e),await this.ready();const r=this._custom.byName(e);return r||Ze(await Ia(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await dn(this._db,Ke,Mn)||0}async setPreferredSkinTone(e){return Wt(e),await this.ready(),Aa(this._db,Ke,Mn,e)}async incrementFavoriteEmojiCount(e){return ft(e),await this.ready(),_a(this._db,e)}async getTopFavoriteEmoji(e){return Wt(e),await this.ready(),(await Da(this._db,this._custom,e)).map(Ze)}set customEmoji(e){this._custom=Pn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await ln(this._dbName)}async delete(){await this._shutdown(),await va(this._dbName)}}const en=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([n,e,r])=>({id:n,emoji:e,name:r})),Vt=en.slice(1),Va=2,jn=6,sr=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function Bn(n){return n.unicode.includes("‍")}const za={"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},Ya=1e3,Ha="🖐️",qa=8,Ga=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],ir='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',Ka=(n,e)=>n<e?-1:n>e?1:0,Rn=(n,e)=>{const r=document.createElement("canvas");r.width=r.height=1;const o=r.getContext("2d");return o.textBaseline="top",o.font=`100px ${ir}`,o.fillStyle=e,o.scale(.01,.01),o.fillText(n,0,0),o.getImageData(0,0,1,1).data},Xa=(n,e)=>{const r=[...n].join(","),o=[...e].join(",");return r===o&&!r.startsWith("0,0,0,")};function Ja(n){const e=Rn(n,"#000"),r=Rn(n,"#fff");return e&&r&&Xa(e,r)}function Qa(){const n=Object.entries(za);try{for(const[e,r]of n)if(Ja(e))return r}catch{}finally{}return n[0][1]}let zt;const Yt=()=>(zt||(zt=new Promise(n=>sr(()=>n(Qa())))),zt),tn=new Map,Za="️",eo="\uD83C",to="‍",no=127995,ro=57339;function ao(n,e){if(e===0)return n;const r=n.indexOf(to);return r!==-1?n.substring(0,r)+String.fromCodePoint(no+e-1)+n.substring(r):(n.endsWith(Za)&&(n=n.substring(0,n.length-1)),n+eo+String.fromCodePoint(ro+e-1))}function _e(n){n.preventDefault(),n.stopPropagation()}function Ht(n,e,r){return e+=n?-1:1,e<0?e=r.length-1:e>=r.length&&(e=0),e}function cr(n,e){const r=new Set,o=[];for(const i of n){const t=e(i);r.has(t)||(r.add(t),o.push(i))}return o}function oo(n,e){const r=o=>{const i={};for(const t of o)typeof t.tone=="number"&&t.version<=e&&(i[t.tone]=t.unicode);return i};return n.map(({unicode:o,skins:i,shortcodes:t,url:l,name:y,category:f,annotation:d})=>({unicode:o,name:y,shortcodes:t,url:l,category:f,annotation:d,id:o||y,skins:i&&r(i)}))}const vt=requestAnimationFrame;let so=typeof ResizeObserver=="function";function io(n,e,r){let o;so?(o=new ResizeObserver(i=>r(i[0].contentRect.width)),o.observe(n)):vt(()=>r(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{o&&o.disconnect()})}function Un(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let qt;function co(n,e,r){for(const o of n){const i=r(o),t=Un(i);typeof qt>"u"&&(qt=Un(e));const l=t/1.8<qt;tn.set(o.unicode,l)}}function lo(n){return cr(n,e=>e)}function uo(n){n&&(n.scrollTop=0)}function nt(n,e,r){let o=n.get(e);return o||(o=r(),n.set(e,o)),o}function $n(n){return""+n}function fo(n){const e=document.createElement("template");return e.innerHTML=n,e}const ho=new WeakMap,mo=new WeakMap,po=Symbol("un-keyed"),vo="replaceChildren"in Element.prototype;function go(n,e){vo?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function yo(n,e){let r=n.firstChild,o=0;for(;r;){if(e[o]!==r)return!0;r=r.nextSibling,o++}return o!==e.length}function bo(n,e){const{targetNode:r}=e;let{targetParentNode:o}=e,i=!1;o?i=yo(o,n):(i=!0,e.targetNode=void 0,e.targetParentNode=o=r.parentNode),i&&go(o,n)}function Eo(n,e){for(const r of e){const{targetNode:o,currentExpression:i,binding:{expressionIndex:t,attributeName:l,attributeValuePre:y,attributeValuePost:f}}=r,d=n[t];if(i!==d)if(r.currentExpression=d,l)o.setAttribute(l,y+$n(d)+f);else{let v;Array.isArray(d)?bo(d,r):d instanceof Element?(v=d,o.replaceWith(v)):o.nodeValue=$n(d),v&&(r.targetNode=v)}}}function So(n){let e="",r=!1,o=!1,i=-1;const t=new Map,l=[];for(let f=0,d=n.length;f<d;f++){const v=n[f];if(e+=v,f===d-1)break;for(let N=0;N<v.length;N++)switch(v.charAt(N)){case"<":{v.charAt(N+1)==="/"?l.pop():(r=!0,l.push(++i));break}case">":{r=!1,o=!1;break}case"=":{o=!0;break}}const h=l[l.length-1],c=nt(t,h,()=>[]);let S,T,E;if(o){const N=/(\S+)="?([^"=]*)$/.exec(v);S=N[1],T=N[2],E=/^[^">]*/.exec(n[f+1])[0]}const g={attributeName:S,attributeValuePre:T,attributeValuePost:E,expressionIndex:f};c.push(g),!r&&!o&&(e+=" ")}return{template:fo(e),elementsToBindings:t}}function wo(n,e){const r=[],o=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let i=n,t=-1;do{const l=e.get(++t);if(l)for(let y=0;y<l.length;y++){const f=l[y],d=f.attributeName?i:i.firstChild,v={binding:f,targetNode:d,targetParentNode:void 0,currentExpression:void 0};r.push(v)}}while(i=o.nextNode());return r}function To(n){const{template:e,elementsToBindings:r}=nt(ho,n,()=>So(n)),o=e.cloneNode(!0).content.firstElementChild,i=wo(o,r);return function(l){return Eo(l,i),o}}function ko(n){const e=nt(mo,n,()=>new Map);let r=po;function o(t,...l){const y=nt(e,t,()=>new Map);return nt(y,r,()=>To(t))(l)}function i(t,l,y){return t.map((f,d)=>{const v=r;r=y(f);try{return l(f,d)}finally{r=v}})}return{map:i,html:o}}function xo(n,e,r,o,i,t,l,y){const{labelWithSkin:f,titleForEmoji:d,unicodeWithSkin:v}=r,{html:h,map:c}=ko(e);function S(g,N,$){return c(g,(A,j)=>h`<button role="${N?"option":"menuitem"}" aria-selected="${e.searchMode?j===e.activeSearchItem:""}" aria-label="${f(A,e.currentSkinTone)}" title="${d(A)}" class="emoji ${N&&j===e.activeSearchItem?"active":""}" id="${`${$}-${A.id}`}">${A.unicode?v(A,e.currentSkinTone):h`<img class="custom-emoji" src="${A.url}" alt="" loading="lazy">`}</button>`,A=>`${$}-${A.id}`)}const E=h`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${c(e.skinTones,(g,N)=>h`<div id="skintone-${N}" class="emoji ${N===e.activeSkinTone?"active":""}" aria-selected="${N===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[N]}" aria-label="${e.i18n.skinTones[N]}">${g}</div>`,g=>g)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${c(e.groups,g=>h`<button role="tab" class="nav-button" aria-controls="tab-${g.id}" aria-label="${e.i18n.categories[g.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===g.id}" title="${e.i18n.categories[g.name]}" data-group-id="${g.id}"><div class="nav-emoji emoji">${g.emoji}</div></button>`,g=>g.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${c(e.currentEmojisWithCategories,(g,N)=>h`<div><div id="menu-label-${N}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:g.category?g.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${N}" id="${e.searchMode?"search-results":""}">${S(g.emojis,e.searchMode,"emo")}</div></div>`,g=>g.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${S(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`;if(y){n.appendChild(E);const g=(N,$)=>{for(const A of n.querySelectorAll(`[${N}]`))$(A,A.getAttribute(N))};for(const N of["click","focusout","input","keydown","keyup"])g(`data-on-${N}`,($,A)=>{$.addEventListener(N,o[A])});g("data-ref",(N,$)=>{t[$]=N}),g("data-action",(N,$)=>{i[$](N)}),l.addEventListener("abort",()=>{n.removeChild(E)})}}const St=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function Co(n){let e=!1,r;const o=new Map,i=new Set;let t;const l=()=>{if(e)return;const d=[...i];i.clear();try{for(const v of d)v()}finally{t=!1,i.size&&(t=!0,St(l))}},y=new Proxy({},{get(d,v){if(r){let h=o.get(v);h||(h=new Set,o.set(v,h)),h.add(r)}return d[v]},set(d,v,h){d[v]=h;const c=o.get(v);if(c){for(const S of c)i.add(S);t||(t=!0,St(l))}return!0}}),f=d=>{const v=()=>{const h=r;r=v;try{return d()}finally{r=h}};return v()};return n.addEventListener("abort",()=>{e=!0}),{state:y,createEffect:f}}function Gt(n,e,r){if(n.length!==e.length)return!1;for(let o=0;o<n.length;o++)if(!r(n[o],e[o]))return!1;return!0}const Kt=[],{assign:mt}=Object;function Io(n,e){const r={},o=new AbortController,i=o.signal,{state:t,createEffect:l}=Co(i);mt(t,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),mt(t,e),mt(t,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:qa,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:Vt,databaseLoaded:!1,activeSearchItemId:void 0}),l(()=>{t.currentGroup!==t.groups[t.currentGroupIndex]&&(t.currentGroup=t.groups[t.currentGroupIndex])});const y=k=>{n.getElementById(k).focus()},f=k=>n.getElementById(`emo-${k.id}`),d=(k,W)=>{r.rootElement.dispatchEvent(new CustomEvent(k,{detail:W,bubbles:!0,composed:!0}))},v=(k,W)=>k.id===W.id,h=(k,W)=>{const{category:G,emojis:K}=k,{category:ae,emojis:ne}=W;return G!==ae?!1:Gt(K,ne,v)},c=k=>{Gt(t.currentEmojis,k,v)||(t.currentEmojis=k)},S=k=>{t.searchMode!==k&&(t.searchMode=k)},T=k=>{Gt(t.currentEmojisWithCategories,k,h)||(t.currentEmojisWithCategories=k)},E=(k,W)=>W&&k.skins&&k.skins[W]||k.unicode,$={labelWithSkin:(k,W)=>lo([k.name||E(k,W),k.annotation,...k.shortcodes||Kt].filter(Boolean)).join(", "),titleForEmoji:k=>k.annotation||(k.shortcodes||Kt).join(", "),unicodeWithSkin:E},A={onClickSkinToneButton:J,onEmojiClick:V,onNavClick:w,onNavKeydown:B,onSearchKeydown:L,onSkinToneOptionsClick:Y,onSkinToneOptionsFocusOut:Se,onSkinToneOptionsKeydown:ee,onSkinToneOptionsKeyup:he,onSearchInput:Ae},j={calculateEmojiGridStyle:F};let C=!0;l(()=>{xo(n,t,$,A,j,r,i,C),C=!1}),t.emojiVersion||Yt().then(k=>{k||(t.message=t.i18n.emojiUnsupportedMessage)}),l(()=>{async function k(){let W=!1;const G=setTimeout(()=>{W=!0,t.message=t.i18n.loadingMessage},Ya);try{await t.database.ready(),t.databaseLoaded=!0}catch(K){console.error(K),t.message=t.i18n.networkErrorMessage}finally{clearTimeout(G),W&&(W=!1,t.message="")}}t.database&&k()}),l(()=>{t.pickerStyle=`
      --num-groups: ${t.groups.length}; 
      --indicator-opacity: ${t.searchMode?0:1}; 
      --num-skintones: ${jn};`}),l(()=>{t.customEmoji&&t.database&&U()}),l(()=>{t.customEmoji&&t.customEmoji.length?t.groups!==en&&(t.groups=en):t.groups!==Vt&&(t.currentGroupIndex&&t.currentGroupIndex--,t.groups=Vt)}),l(()=>{async function k(){t.databaseLoaded&&(t.currentSkinTone=await t.database.getPreferredSkinTone())}k()}),l(()=>{t.skinTones=Array(jn).fill().map((k,W)=>ao(t.skinToneEmoji,W))}),l(()=>{t.skinToneButtonText=t.skinTones[t.currentSkinTone]}),l(()=>{t.skinToneButtonLabel=t.i18n.skinToneLabel.replace("{skinTone}",t.i18n.skinTones[t.currentSkinTone])}),l(()=>{async function k(){const{database:W}=t,G=(await Promise.all(Ga.map(K=>W.getEmojiByUnicodeOrName(K)))).filter(Boolean);t.defaultFavoriteEmojis=G}t.databaseLoaded&&k()});function U(){t.database.customEmoji=t.customEmoji||Kt}l(()=>{async function k(){U();const{database:W,defaultFavoriteEmojis:G,numColumns:K}=t,ae=await W.getTopFavoriteEmoji(K),ne=await te(cr([...ae,...G],be=>be.unicode||be.name).slice(0,K));t.currentFavorites=ne}t.databaseLoaded&&t.defaultFavoriteEmojis&&k()});function F(k){io(k,i,W=>{{const G=getComputedStyle(r.rootElement),K=parseInt(G.getPropertyValue("--num-columns"),10),ae=G.getPropertyValue("direction")==="rtl",be=k.parentElement.getBoundingClientRect().width-W;t.numColumns=K,t.scrollbarWidth=be,t.isRtl=ae}})}l(()=>{async function k(){const{searchText:W,currentGroup:G,databaseLoaded:K,customEmoji:ae}=t;if(!K)t.currentEmojis=[],t.searchMode=!1;else if(W.length>=Va){const ne=await Ee(W);t.searchText===W&&(c(ne),S(!0))}else{const{id:ne}=G;if(ne!==-1||ae&&ae.length){const be=await fe(ne);t.currentGroup.id===ne&&(c(be),S(!1))}}}k()}),l(()=>{const{currentEmojis:k,emojiVersion:W}=t,G=k.filter(K=>K.unicode).filter(K=>Bn(K)&&!tn.has(K.unicode));if(!W&&G.length)c(k),vt(()=>H(G));else{const K=W?k:k.filter(de);c(K),vt(()=>uo(r.tabpanelElement))}});function H(k){co(k,r.baselineEmoji,f),t.currentEmojis=t.currentEmojis}function de(k){return!k.unicode||!Bn(k)||tn.get(k.unicode)}async function ie(k){const W=t.emojiVersion||await Yt();return k.filter(({version:G})=>!G||G<=W)}async function te(k){return oo(k,t.emojiVersion||await Yt())}async function fe(k){const W=k===-1?t.customEmoji:await t.database.getEmojiByGroup(k);return te(await ie(W))}async function Ee(k){return te(await ie(await t.database.getEmojiBySearchQuery(k)))}l(()=>{}),l(()=>{function k(){const{searchMode:G,currentEmojis:K}=t;if(G)return[{category:"",emojis:K}];const ae=new Map;for(const ne of K){const be=ne.category||"";let Ve=ae.get(be);Ve||(Ve=[],ae.set(be,Ve)),Ve.push(ne)}return[...ae.entries()].map(([ne,be])=>({category:ne,emojis:be})).sort((ne,be)=>t.customCategorySorting(ne.category,be.category))}const W=k();T(W)}),l(()=>{t.activeSearchItemId=t.activeSearchItem!==-1&&t.currentEmojis[t.activeSearchItem].id}),l(()=>{const{rawSearchText:k}=t;sr(()=>{t.searchText=(k||"").trim(),t.activeSearchItem=-1})});function L(k){if(!t.searchMode||!t.currentEmojis.length)return;const W=G=>{_e(k),t.activeSearchItem=Ht(G,t.activeSearchItem,t.currentEmojis)};switch(k.key){case"ArrowDown":return W(!1);case"ArrowUp":return W(!0);case"Enter":if(t.activeSearchItem===-1)t.activeSearchItem=0;else return _e(k),D(t.currentEmojis[t.activeSearchItem].id)}}function w(k){const{target:W}=k,G=W.closest(".nav-button");if(!G)return;const K=parseInt(G.dataset.groupId,10);r.searchElement.value="",t.rawSearchText="",t.searchText="",t.activeSearchItem=-1,t.currentGroupIndex=t.groups.findIndex(ae=>ae.id===K)}function B(k){const{target:W,key:G}=k,K=ae=>{ae&&(_e(k),ae.focus())};switch(G){case"ArrowLeft":return K(W.previousElementSibling);case"ArrowRight":return K(W.nextElementSibling);case"Home":return K(W.parentElement.firstElementChild);case"End":return K(W.parentElement.lastElementChild)}}async function D(k){const W=await t.database.getEmojiByUnicodeOrName(k),G=[...t.currentEmojis,...t.currentFavorites].find(ae=>ae.id===k),K=G.unicode&&E(G,t.currentSkinTone);await t.database.incrementFavoriteEmojiCount(k),d("emoji-click",{emoji:W,skinTone:t.currentSkinTone,...K&&{unicode:K},...G.name&&{name:G.name}})}async function V(k){const{target:W}=k;if(!W.classList.contains("emoji"))return;_e(k);const G=W.id.substring(4);D(G)}function q(k){t.currentSkinTone=k,t.skinTonePickerExpanded=!1,y("skintone-button"),d("skin-tone-change",{skinTone:k}),t.database.setPreferredSkinTone(k)}function Y(k){const{target:{id:W}}=k,G=W&&W.match(/^skintone-(\d)/);if(!G)return;_e(k);const K=parseInt(G[1],10);q(K)}function J(k){t.skinTonePickerExpanded=!t.skinTonePickerExpanded,t.activeSkinTone=t.currentSkinTone,t.skinTonePickerExpanded&&(_e(k),vt(()=>y("skintone-list")))}l(()=>{t.skinTonePickerExpanded?r.skinToneDropdown.addEventListener("transitionend",()=>{t.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):t.skinTonePickerExpandedAfterAnimation=!1});function ee(k){if(!t.skinTonePickerExpanded)return;const W=async G=>{_e(k),t.activeSkinTone=G};switch(k.key){case"ArrowUp":return W(Ht(!0,t.activeSkinTone,t.skinTones));case"ArrowDown":return W(Ht(!1,t.activeSkinTone,t.skinTones));case"Home":return W(0);case"End":return W(t.skinTones.length-1);case"Enter":return _e(k),q(t.activeSkinTone);case"Escape":return _e(k),t.skinTonePickerExpanded=!1,y("skintone-button")}}function he(k){if(t.skinTonePickerExpanded)switch(k.key){case" ":return _e(k),q(t.activeSkinTone)}}async function Se(k){const{relatedTarget:W}=k;(!W||W.id!=="skintone-list")&&(t.skinTonePickerExpanded=!1)}function Ae(k){t.rawSearchText=k.target.value}return{$set(k){mt(t,k)},$destroy(){o.abort()}}}const Ao="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",_o="en";var Do={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},No=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const lr=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],Lo=`:host{--emoji-font-family:${ir}}`;class fn extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const r=document.createElement("style");r.textContent=No+Lo,this.shadowRoot.appendChild(r),this._ctx={locale:_o,dataSource:Ao,skinToneEmoji:Ha,customCategorySorting:Ka,customEmoji:null,i18n:Do,emojiVersion:null,...e};for(const o of lr)o!=="database"&&Object.prototype.hasOwnProperty.call(this,o)&&(this._ctx[o]=this[o],delete this[o]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Io(this.shadowRoot,this._ctx))}disconnectedCallback(){St(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(r=>console.error(r))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,r,o){this._set(e.replace(/-([a-z])/g,(i,t)=>t.toUpperCase()),e==="emoji-version"?parseFloat(o):o)}_set(e,r){this._ctx[e]=r,this._cmp&&this._cmp.$set({[e]:r}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:r,database:o}=this._ctx;(!o||o.locale!==e||o.dataSource!==r)&&this._set("database",new Wa({locale:e,dataSource:r}))}_dbFlush(){St(()=>this._dbCreate())}}const ur={};for(const n of lr)ur[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(fn.prototype,ur);customElements.get("emoji-picker")||customElements.define("emoji-picker",fn);var nn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(r,o){o(e)})(et,function(r){var o="dnd-poly-",i=o+"snapback",t="dnd-poly-",l=t+"dragstart-pending",y=t+"dragstart-cancel",f=["none","copy","copyLink","copyMove","link","linkMove","move","all"],d=["none","copy","move","link"],v=function(){var L=!1;try{var w=Object.defineProperty({},"passive",{get:function(){L=!0}});window.addEventListener("test",null,w)}catch{}return L}();function h(L){return L&&L.tagName}function c(L,w,B){B===void 0&&(B=!0),document.addEventListener(L,w,!!v&&{passive:B})}function S(L,w){document.removeEventListener(L,w)}function T(L,w,B,D){D===void 0&&(D=!1);var V=v?{passive:!0,capture:D}:D;return L.addEventListener(w,B,V),{off:function(){L.removeEventListener(w,B,V)}}}function E(L){return L.length===0?0:L.reduce(function(w,B){return B+w},0)/L.length}function g(L,w){for(var B=0;B<L.changedTouches.length;B++)if(L.changedTouches[B].identifier===w)return!0;return!1}function N(L,w,B){for(var D=[],V=[],q=0;q<w.touches.length;q++){var Y=w.touches[q];D.push(Y[L+"X"]),V.push(Y[L+"Y"])}B.x=E(D),B.y=E(V)}var $=["","-webkit-"];function A(L,w,B,D,V){V===void 0&&(V=!0);var q=w.x,Y=w.y;D&&(q+=D.x,Y+=D.y),V&&(q-=parseInt(L.offsetWidth,10)/2,Y-=parseInt(L.offsetHeight,10)/2);for(var J="translate3d("+q+"px,"+Y+"px, 0)",ee=0;ee<$.length;ee++){var he=$[ee]+"transform";L.style[he]=J+" "+B[ee]}}var j=function(){function L(w,B){this.t=w,this.i=B,this.s=d[0]}return Object.defineProperty(L.prototype,"dropEffect",{get:function(){return this.s},set:function(w){this.t.mode!==0&&f.indexOf(w)>-1&&(this.s=w)},enumerable:!0,configurable:!0}),Object.defineProperty(L.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(L.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(w){this.t.mode===2&&f.indexOf(w)>-1&&(this.t.effectAllowed=w)},enumerable:!0,configurable:!0}),L.prototype.setData=function(w,B){if(this.t.mode===2){if(w.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[w]=B,this.t.types.indexOf(w)===-1&&this.t.types.push(w)}},L.prototype.getData=function(w){if(this.t.mode===1||this.t.mode===2)return this.t.data[w]||""},L.prototype.clearData=function(w){if(this.t.mode===2){if(w&&this.t.data[w]){delete this.t.data[w];var B=this.t.types.indexOf(w);return void(B>-1&&this.t.types.splice(B,1))}this.t.data={},this.t.types=[]}},L.prototype.setDragImage=function(w,B,D){this.t.mode===2&&this.i(w,B,D)},L}();function C(L,w){return L?L===f[0]?d[0]:L.indexOf(f[1])===0||L===f[7]?d[1]:L.indexOf(f[4])===0?d[3]:L===f[6]?d[2]:d[1]:w.nodeType===3&&w.tagName==="A"?d[3]:d[1]}function U(L,w,B,D,V,q,Y){q===void 0&&(q=!0),Y===void 0&&(Y=null);var J=function(he,Se,Ae,k,W,G,K){K===void 0&&(K=null);var ae=Se.changedTouches[0],ne=new Event(Ae,{bubbles:!0,cancelable:k});ne.dataTransfer=G,ne.relatedTarget=K,ne.screenX=ae.screenX,ne.screenY=ae.screenY,ne.clientX=ae.clientX,ne.clientY=ae.clientY,ne.pageX=ae.pageX,ne.pageY=ae.pageY;var be=he.getBoundingClientRect();return ne.offsetX=ne.clientX-be.left,ne.offsetY=ne.clientY-be.top,ne}(w,B,L,q,document.defaultView,V,Y),ee=!w.dispatchEvent(J);return D.mode=0,ee}function F(L,w){if(!L||L===f[7])return w;if(w===d[1]){if(L.indexOf(d[1])===0)return d[1]}else if(w===d[3]){if(L.indexOf(d[3])===0||L.indexOf("Link")>-1)return d[3]}else if(w===d[2]&&(L.indexOf(d[2])===0||L.indexOf("Move")>-1))return d[2];return d[0]}var H,de=function(){function L(w,B,D,V){this.h=w,this.o=B,this.u=D,this.l=V,this.v=0,this.p=null,this.g=null,this.m=w,this.I=w.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),c("touchmove",this.j,!1),c("touchend",this.S,!1),c("touchcancel",this.S,!1)}return L.prototype.A=function(){var w=this;this.v=1,this.O=d[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var B=this.u;if(this.N=new j(this.D,function(J,ee,he){B=J,typeof ee!="number"&&typeof he!="number"||(w.P={x:ee||0,y:he||0})}),this.D.mode=2,this.N.dropEffect=d[0],U("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;N("page",this.m,this.F);var D,V=this.o.dragImageSetup(B);if(this.L=(D=V,$.map(function(J){var ee=D.style[J+"transform"];return ee&&ee!=="none"?ee.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),V.style.position="absolute",V.style.left="0px",V.style.top="0px",V.style.zIndex="999999",V.classList.add("dnd-poly-drag-image"),V.classList.add("dnd-poly-icon"),this._=V,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var q=getComputedStyle(B);this.P={x:0-parseInt(q.marginLeft,10),y:0-parseInt(q.marginTop,10)}}else{var Y=B.getBoundingClientRect();q=getComputedStyle(B),this.P={x:Y.left-this.I.clientX-parseInt(q.marginLeft,10)+Y.width/2,y:Y.top-this.I.clientY-parseInt(q.marginTop,10)+Y.height/2}}return A(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){w.X||(w.X=!0,w.Y(),w.X=!1)},this.o.iterationInterval),!0},L.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),S("touchmove",this.j),S("touchend",this.S),S("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},L.prototype.C=function(w){var B=this;if(g(w,this.I.identifier)!==!1){if(this.m=w,this.v===0){var D=void 0;if(this.o.dragStartConditionOverride)try{D=this.o.dragStartConditionOverride(w)}catch{D=!1}else D=w.touches.length===1;return D?void(this.A()===!0&&(this.h.preventDefault(),w.preventDefault())):void this.T()}if(w.preventDefault(),N("client",w,this.M),N("page",w,this.F),this.o.dragImageTranslateOverride)try{var V=!1;if(this.o.dragImageTranslateOverride(w,{x:this.M.x,y:this.M.y},this.p,function(q,Y){B._&&(V=!0,B.M.x+=q,B.M.y+=Y,B.F.x+=q,B.F.y+=Y,A(B._,B.F,B.L,B.P,B.o.dragImageCenterOnTouch))}),V)return}catch{}A(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},L.prototype.k=function(w){if(g(w,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(w.preventDefault(),this.v=w.type==="touchcancel"?3:2):this.T()}},L.prototype.Y=function(){var w=this,B=this.O;this.D.mode=3,this.N.dropEffect=d[0];var D=U("drag",this.u,this.m,this.D,this.N);if(D&&(this.O=d[0]),D||this.v===2||this.v===3)return this.q(this.v)?void function(J,ee,he,Se){var Ae=getComputedStyle(J);if(Ae.visibility!=="hidden"&&Ae.display!=="none"){ee.classList.add(i);var k=getComputedStyle(ee),W=parseFloat(k.transitionDuration);if(isNaN(W)||W===0)Se();else{var G=J.getBoundingClientRect(),K={x:G.left,y:G.top};K.x+=document.body.scrollLeft||document.documentElement.scrollLeft,K.y+=document.body.scrollTop||document.documentElement.scrollTop,K.x-=parseInt(Ae.marginLeft,10),K.y-=parseInt(Ae.marginTop,10);var ae=parseFloat(k.transitionDelay),ne=Math.round(1e3*(W+ae));A(ee,K,he,void 0,!1),setTimeout(Se,ne)}}else Se()}(this.u,this._,this.L,function(){w.B()}):void this.B();var V=this.o.elementFromPoint(this.M.x,this.M.y),q=this.g;V!==this.p&&V!==this.g&&(this.p=V,this.g!==null&&(this.D.mode=3,this.N.dropEffect=d[0],U("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=C(this.D.effectAllowed,this.u),U("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=F(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),q!==this.g&&h(q)&&(this.D.mode=3,this.N.dropEffect=d[0],U("dragleave",q,this.m,this.D,this.N,!1,this.g)),h(this.g)&&(this.D.mode=3,this.N.dropEffect=C(this.D.effectAllowed,this.u),U("dragover",this.g,this.m,this.D,this.N)===!1?this.O=d[0]:this.O=F(this.N.effectAllowed,this.N.dropEffect)),B!==this.O&&this._.classList.remove(o+B);var Y=o+this.O;this._.classList.add(Y)},L.prototype.q=function(w){var B=this.O===d[0]||this.g===null||w===3;return B?h(this.g)&&(this.D.mode=3,this.N.dropEffect=d[0],U("dragleave",this.g,this.m,this.D,this.N,!1)):h(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,U("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=d[0]),B},L.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,U("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},L}(),ie={iterationInterval:150,tryFindDraggableTarget:function(L){var w=L.target;do if(w.draggable!==!1&&(w.draggable===!0||w.getAttribute&&w.getAttribute("draggable")==="true"))return w;while((w=w.parentNode)&&w!==document.body)},dragImageSetup:function(L){var w=L.cloneNode(!0);return function B(D,V){if(D.nodeType===1){for(var q=getComputedStyle(D),Y=0;Y<q.length;Y++){var J=q[Y];V.style.setProperty(J,q.getPropertyValue(J),q.getPropertyPriority(J))}if(V.style.pointerEvents="none",V.removeAttribute("id"),V.removeAttribute("class"),V.removeAttribute("draggable"),V.nodeName==="CANVAS"){var ee=D,he=V,Se=ee.getContext("2d").getImageData(0,0,ee.width,ee.height);he.getContext("2d").putImageData(Se,0,0)}}if(D.hasChildNodes())for(Y=0;Y<D.childNodes.length;Y++)B(D.childNodes[Y],V.childNodes[Y])}(L,w),w},elementFromPoint:function(L,w){return document.elementFromPoint(L,w)}};function te(L){if(!H){var w=ie.tryFindDraggableTarget(L);if(w)try{H=new de(L,ie,w,Ee)}catch(B){throw Ee(ie,L,3),B}}}function fe(L){var w=L.target,B=function(ee){V.off(),q.off(),Y.off(),J.off(),w&&w.dispatchEvent(new CustomEvent(y,{bubbles:!0,cancelable:!0})),clearTimeout(D)};w&&w.dispatchEvent(new CustomEvent(l,{bubbles:!0,cancelable:!0}));var D=window.setTimeout(function(){V.off(),q.off(),Y.off(),J.off(),te(L)},ie.holdToDrag),V=T(w,"touchend",B),q=T(w,"touchcancel",B),Y=T(w,"touchmove",B),J=T(window,"scroll",B,!0)}function Ee(L,w,B){if(B===0&&L.defaultActionOverride)try{L.defaultActionOverride(w),w.defaultPrevented}catch{}H=null}r.polyfill=function(L){if(L&&Object.keys(L).forEach(function(V){ie[V]=L[V]}),!ie.forceApply){var w=(B={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},D=!!window.chrome||/chrome/i.test(navigator.userAgent),B.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||D&&"ontouchstart"in document.documentElement),B);if(w.userAgentSupportingNativeDnD&&w.draggable&&w.dragEvents)return!1}var B,D;return ie.holdToDrag?c("touchstart",fe,!1):c("touchstart",te,!1),!0},Object.defineProperty(r,"__esModule",{value:!0})})})(nn,nn.exports);var Mo=nn.exports;const Oo=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),De=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},Po=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let Fn;const jo=(n=window)=>new Promise(e=>{const r=setTimeout(()=>{e()},100),o=()=>{clearTimeout(r),clearTimeout(Fn),Fn=setTimeout(()=>{n.removeEventListener("scroll",o),e()},100)};n.addEventListener("scroll",o)}),Bo="v0.6.2 Beta",Ue=document.querySelector(".editor"),ue=document.getElementById("tones"),ge=document.getElementById("action"),ce=document.getElementById("musical-score"),Re=document.getElementById("add-track"),at=document.getElementById("remove-track"),$e=document.getElementById("dialog"),re=document.forms["dialog-form"];re._title=re.querySelector(".form-title");re.inputs=re.querySelector(".inputs");re.buttons=re.querySelector(".buttons");const wt=document.getElementById("play"),Tt=document.getElementById("clear"),Ro=document.getElementById("warn-out"),Uo=document.getElementById("mml"),je=document.getElementById("copy"),Pe=document.getElementById("paste"),kt=document.getElementById("save"),rn=document.getElementById("open"),Lt=document.getElementById("ctrl"),xt=document.getElementById("undo"),Ct=document.getElementById("redo");var st,le,Ce,He;class $o{constructor(){we(this,st,`#COMMENT Generated by FlMML VisualSequencer ${Bo}`);we(this,le,[]);we(this,Ce,(e,r)=>{});we(this,He,(e,r)=>{})}set onChange(e){ke(this,Ce,e)}set onError(e){ke(this,He,e)}setMmlArr(e){ke(this,le,e),R(this,Ce).call(this,this.getMmlArr(),this.getMml())}setMml(e){ke(this,le,e.split(`
`)),R(this,le).at(-2)===""&&R(this,le).at(-1)===R(this,st)&&R(this,le).splice(-2,2),R(this,Ce).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return R(this,le)}getMml(){return R(this,le).length?R(this,le).concat(["",R(this,st)]).join(`
`):""}getMmlLine(e){return R(this,le)[e]}insert(e,r){Object.hasOwn(R(this,le),e)||e===0?(R(this,le).splice(e,0,r),R(this,Ce).call(this,this.getMmlArr(),this.getMml())):R(this,He).call(this,"範囲外の書き換え指定",`範囲${R(this,le).length-1}までのところ、${e}`)}append(e){R(this,le).push(e),R(this,Ce).call(this,this.getMmlArr(),this.getMml())}appendToStr(e,r){Object.hasOwn(R(this,le),e)?(R(this,le)[e]+=r,R(this,Ce).call(this,this.getMmlArr(),this.getMml())):this.append(r)}beforeInsertToStr(e,r){Object.hasOwn(R(this,le),e)?(R(this,le)[e]=r+R(this,le)[e],R(this,Ce).call(this,this.getMmlArr(),this.getMml())):this.append(r)}rewrite(e,r){Object.hasOwn(R(this,le),e)?(R(this,le)[e]=r,R(this,Ce).call(this,this.getMmlArr(),this.getMml())):this.append(r)}delete(e,r=1){Object.hasOwn(R(this,le),e)&&R(this,le).splice(e,r).length!==0?R(this,Ce).call(this,this.getMmlArr(),this.getMml()):R(this,He).call(this,"無効な指定",`範囲${R(this,le).length-1}までの中で${e}から${r}削除するのはできません`)}}st=new WeakMap,le=new WeakMap,Ce=new WeakMap,He=new WeakMap;var Te,qe,it,Be;class Fo{constructor(e,r){we(this,Te,[]);we(this,qe,[]);we(this,it,null);we(this,Be,null);this.tonesElem=e,this.areaElem=r,ke(this,Be,this.areaElem.querySelector(".track.active"))}set activeTrack(e){R(this,Be).classList.remove("active"),ke(this,Be,e),R(this,Be).classList.add("active")}get activeTrack(){return R(this,Be)}blocksDataUpdate(){ke(this,Te,[...this.areaElem.querySelectorAll(".track button")].map(e=>({label:e.ariaLabel,className:e.className,trackNo:[...document.getElementsByClassName("track")].findIndex(r=>r.contains(e)),tone:{tone:e.dataset.tone,tonePitch:e.dataset.tonePitch},tempo:e.dataset.tempo,noteValue:e.dataset.noteValue,rest:e.dataset.rest,octave:e.dataset.octave,velocity:e.dataset.velocity,noteShift:e.dataset.noteShift,detune:e.dataset.detune,tieSlur:e.dataset.tieSlur,repeatStartEnd:e.dataset.repeatStartEnd,repeatBreak:e.dataset.repeatBreak,polyStartEnd:e.dataset.polyStartEnd,macroDef:e.dataset.macroDef,macroArgUse:e.dataset.macroArgUse,macroUse:e.dataset.macroUse,metaData:e.dataset.metaData,otherAction:e.dataset.otherAction,elem:e})))}saveBlocksData(){clearTimeout(R(this,it)),ke(this,it,setTimeout(()=>{const e=JSON.parse(JSON.stringify(R(this,Te)));Xt.setItem("BlocksData",e).catch(r=>{alert("セーブができませんでした。"+r)})},1e3))}checkSavedBlocksData(){Xt.getItem("BlocksData").then(e=>{e&&(ke(this,Te,e),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(Q))})}parseBlocks(){const e=R(this,Te);this.activeTrack=this.areaElem.querySelector(".track");const r=this.tonesElem.querySelector("ul");let o=0;e.forEach(i=>{if(i.trackNo!==o){const v=document.createElement("ul");v.classList.add("track"),this.activeTrack=v,this.areaElem.insertBefore(v,Re),o=i.trackNo}const t=document.createElement("li"),l='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',y=(()=>{const v=document.createElement("div");return v.innerHTML=l,v.firstElementChild})(),f=document.querySelector(`[class*="${i.className.replace(/ material-icons| droppable| bounce| pop| done/g,"")}"]`),d=(f==null?void 0:f.cloneNode(!0))||y;i.label&&(d.ariaLabel=i.label),i.tone.tonePitch&&(d.className=i.className,i.label!=="無調整"&&(d.textContent=i.label),d.dataset.tone=i.tone.tone,f?f.replaceWith(d.cloneNode(!0)):r.appendChild(d.cloneNode(!0)),d.dataset.tonePitch=i.tone.tonePitch),i.tempo&&(d.dataset.tempo=i.tempo),i.noteValue&&(d.dataset.noteValue=i.noteValue),i.rest&&(d.dataset.rest=i.rest),i.octave&&(d.dataset.octave=i.octave),i.velocity&&(d.dataset.velocity=i.velocity),i.noteShift&&(d.dataset.noteShift=i.noteShift),i.detune&&(d.dataset.detune=i.detune),i.tieSlur&&(d.dataset.tieSlur=i.tieSlur,i.tieSlur==="&"?d.ariaLabel="スラー":d.ariaLabel="タイ"),i.repeatStartEnd&&(d.dataset.repeatStartEnd=i.repeatStartEnd,i.repeatStartEnd.startsWith("/:")?(d.classList.remove("material-icons"),d.ariaLabel="リピート開始",d.textContent="◆"):i.repeatStartEnd===":/"&&(d.ariaLabel="リピート終了")),i.repeatBreak&&(d.dataset.repeatBreak=i.repeatBreak),i.polyStartEnd&&(d.dataset.polyStartEnd=i.polyStartEnd),i.macroDef&&(d.dataset.macroDef=i.macroDef,d.textContent=i.macroDef===";"?";":"$="),i.macroArgUse&&(d.dataset.macroArgUse=i.macroArgUse),i.macroUse&&(d.dataset.macroUse=i.macroUse),i.metaData&&(d.dataset.metaData=i.metaData),i.otherAction&&(d.dataset.otherAction=i.otherAction,d.textContent=i.otherAction.length>4?"…":i.otherAction),t.appendChild(d),this.activeTrack.appendChild(t)})}exportMml(e){e.setMmlArr([]);let r=0,o=0;const i=R(this,Te).filter(c=>c.tone.tone!==void 0),t=()=>i.filter(c=>c.trackNo===o),l=()=>new Set(t().map(c=>c.tone.tone));let y=l(),f=0,d=!1,v=[4,0],h=!1;R(this,Te).forEach(c=>{const{tone:S,tonePitch:T}=c.tone;if(c.trackNo!==o&&(y.size?([...y].forEach((E,g)=>{e.appendToStr(r+g,";")}),r+=y.size):(e.appendToStr(r,";"),r++),o=c.trackNo,y=l(),d=!1),S!==void 0)f=[...y].indexOf(S),d||([...y].forEach((E,g)=>{E&&e.beforeInsertToStr(r+g,E+" ")}),d=!0),[...y].forEach((E,g)=>{let N=T||"";g!==f&&(N=N.replace(/[a-g]/,h?"*":"r")),e.appendToStr(r+g,N)});else if(c.rest||c.tieSlur)y.size?[...y].forEach((E,g)=>{e.appendToStr(r+g,c.rest||c.tieSlur)}):e.appendToStr(r,c.rest||c.tieSlur);else if(c.noteValue||c.repeatStartEnd||c.repeatBreak||c.polyStartEnd){const E=g=>{if(!g)return v;const N=Number((g.match(/[0-9]+/)||[v[0]])[0]),$=(g.match(/\.+/)||[""])[0].length;return[N,$]};c.noteValue?v=E(c.noteValue):c.polyStartEnd==="["?h=!0:c.polyStartEnd==="]"&&(h=!1),y.size?[...y].forEach((g,N)=>{if(e.appendToStr(r+N,c.noteValue||c.repeatStartEnd||c.repeatBreak||c.polyStartEnd||""),c.polyStartEnd==="]"){const $=e.getMmlLine(r+N).match(/\[(.+?)\]/);if($){const A=$[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(A){const j=[...A].map(F=>({type:F[1]==="r"?"rest":F[1]==="*"?"otherNote":"note",num:E(F[0])}));j.filter(H=>H.type==="note").map(H=>H.num),j.filter(H=>H.type==="otherNote").map(H=>H.num),j.filter(H=>H.type==="rest").map(H=>H.num);let C=$[0].replace(/\*\+?[0-9]*\.*/g,"");const U=e.getMmlLine(r+N).replace(/\[.+?\]/,C);e.rewrite(r+N,U)}}}}):e.appendToStr(r,c.noteValue||c.repeatStartEnd||c.repeatBreak||c.polyStartEnd||"")}else if(c.metaData)c.metaData&&e.getMmlLine(r)&&r++,e.appendToStr(r,c.metaData.replace(`
`,"")||""),r++;else{const E=T||c.tempo||c.octave||c.velocity||c.noteShift||c.detune||c.tieSlur||c.macroDef||c.macroArgUse||c.macroUse||c.otherAction||"";e.appendToStr(r,E),/;/.test(E)&&(r+=y.size||1,y=l(),d=!1)}}),[...y].slice(0,-1).forEach((c,S)=>{e.appendToStr(r+S,";")})}importMml(e){const r=e.getMmlArr(),o=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_]+(\{[^\}]*\})?|^#.*|;| +|@pl[0-9]+|[^;]+/ig,i=[],t=new Set,l=new Set;let y=0,f="",d=!1,v=!1;r.forEach(h=>{(h.match(o)||[]).forEach(S=>{if(S=S.trim(),!S)return;const T=E=>{const g={};if(g.tone={},g.trackNo=y,/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(E)){f=E,l.add(f);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(E)){l.has(f)||l.add(f);const N=[...l].indexOf(f)+1;g.label="無調整",g.className=`material-icons note note-${N}`,g.tone.tone=f,g.tone.tonePitch=E,d&&(v=!0)}else if(E.startsWith("t"))g.className="material-icons tempo",g.tempo=E;else if(E.startsWith("l"))g.className="material-icons note-value",g.noteValue=E;else if(E.startsWith("r"))g.className="material-icons rest",g.rest=E;else if(/^o[0-8]|[><]+$/i.test(E))g.className="material-icons octave",g.octave=E;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(E))g.className="material-icons velocity",g.velocity=E;else if(E.startsWith("@ns")||E.startsWith("ns"))g.className="material-icons note-shift",g.noteShift=E;else if(E.startsWith("@d"))g.className="material-icons detune",g.detune=E;else if(E.startsWith("&"))g.className="tie-slur",g.tieSlur=E;else if(E.startsWith("/*"))g.className="other-action",g.otherAction=E;else if(E.startsWith("/:"))g.className="repeat-start-end",g.repeatStartEnd=E;else if(E.startsWith(":/"))g.className="material-icons repeat-start-end",g.repeatStartEnd=E;else if(E.startsWith("/"))g.className="repeat-break",g.repeatBreak=E;else if(E.startsWith("[")||E.startsWith("]"))g.className="poly-start-end",g.polyStartEnd=E;else if(/^\$.*?=$/.test(E))g.className="macro-def",g.macroDef=E.replaceAll(" ",""),t.add(g.macroDef.slice(0,-1)),d=!0;else if(E.startsWith("%"))g.className="macro-arg-use",g.macroArgUse=E;else if(E.startsWith("$")){g.className="macro-use";const N=[...t].sort(($,A)=>A.length-$.length).find($=>E.includes($));if(N){g.macroUse=N,i.push(g);const $=E.replace(N,"");$!==""&&T($);return}else g.macroUse=E}else if(E.startsWith("#")){const N={"#TITLE":"タイトル","#ARTIST":"アーティスト","#COMMENT":"コメント","#CODING":"作成者","#PRAGMA":"PRAGMA","#OCTAVE":"相対オクターブ反転","#VELOCITY REVERSE":"相対ベロシティ反転","#WAV9":"@9 波形データ","#WAV10":"@10 波形データ","#WAV13":"@13 波形データ","#OPM":"@14 OPM音色データ","#OPN":"@14 OPN音色データ","#FMGAIN":"@14 音量利得","#USING":"和音利用宣言"};g.label=(Object.entries(N).find($=>E.startsWith($[0]))||[,void 0])[1],g.className="meta-data",g.metaData=E+`
`}else if(E.startsWith(";")){if(y++,d&&!v){const N=[...l].join(" ");N&&(g.className="other-action",g.otherAction=N,i.push(g),l.clear())}d=!1,v=!1;return}else g.className="other-action",g.otherAction=E;i.push(g)};T(S)})}),this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((h,c)=>{c?h.remove():(h.textContent="",this.activeTrack=h)}),X=null,ke(this,Te,i),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}playRendering(){const e=R(this,Te);let r=120,o=0;[ue,ge,ce].forEach(v=>{v.classList.add("no-op")});const i=document.querySelector(".wrap"),t=document.getElementsByClassName("track"),y=(i.clientHeight-32)/t.length;[...t].forEach(v=>{v.style.setProperty("--max-height",`${y}px`)}),Re.disabled=!0,at.disabled=!0;const f=(v,{scoreNoteValue:h=4}={})=>{var B;let c=!1,S=-1,T=-1,E=!1,g=!1;const N=[],$=[],A=[],j=performance.now(),C=(B=v[0])==null?void 0:B.trackNo,U=t[C],F=o++;let H=null;const de=new Promise(D=>H=D);let ie=0,te=0;const fe=D=>{if(!D)return h;const V=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(D),q=V&&V[1]?Number(V[1]):h,Y=V?V[2].length:0;return q*2**Y/(2**(Y+1)-1)},Ee=D=>{const V=Y=>{!g&&U.scrollTo({top:Y,behavior:"smooth"}),g=!0,jo(U).then(()=>{g=!1})},q=Y=>U.clientHeight*Y;(te===0||D.elem.offsetTop>U.scrollTop+q(.8)||D.elem.offsetTop<U.scrollTop+q(.2))&&V(D.elem.offsetTop-q(.2))},L=D=>{const V=q=>{const Y=q-j,J=60/r*4/D*1e3;Y<ie+J?R(this,qe)[F]=requestAnimationFrame(V):(ie+=J,w())};R(this,qe)[F]=requestAnimationFrame(V)},w=async()=>{var V,q;const D=v[te];if(!D||te>=v.length){H({scoreNoteValue:h});return}if(Ee(D),E){D.macroDef===";"&&(E=!1),te++,w();return}else if(S!==-1)(V=D.repeatStartEnd)!=null&&V.startsWith("/:")?T++:D.repeatStartEnd===":/"&&(T===S&&(De(D.elem,"pop"),S=-1),T--),te++,w();else if(D.tone.tonePitch){const Y=fe(D.tone.tonePitch);De(D.elem,"bounce"),te++,c?w():L(Y)}else if(D.rest||D.tieSlur)if(De(D.elem,"pop"),te++,D.tieSlur==="&")w();else{const Y=fe(D.rest||D.tieSlur);L(Y)}else if(D.polyStartEnd)if(c=D.polyStartEnd==="[",De(D.elem,"pop"),c)te++,w();else{const Y=fe(v[te++-1].tone.tonePitch);L(Y)}else if(D.macroDef&&D.macroDef!==";"){E=!0,te++,w();return}else{if(D.tempo&&(r=Number(D.tempo.replace("t",""))||r),D.noteValue&&(h=fe(D.noteValue)),De(D.elem,"pop"),(q=D.repeatStartEnd)!=null&&q.startsWith("/:"))N[++T]=te,$[T]||(A[T]=D.repeatStartEnd.replace("/:",""),A[T]=A[T]===""?2:Number(A[T]),A[T]||(S=T));else if(D.repeatBreak){if(A[T]===1){if(!$[T]){let Y=T;$[T]=v.findIndex((J,ee)=>{if(ee>N[T]){if(console.log(Y),J.repeatStartEnd.startsWith("/:"))Y++;else if(J.repeatStartEnd===":/"){if(Y===T)return!0;Y--}}})}te=$[T],w(),De(D.elem,"done");return}}else if(D.repeatStartEnd===":/"){if(A[T]--,A[T]){$[T]=te,te=N[T],T--,w(),De(D.elem,"done");return}$[T]=null,T--}else if(D.macroUse){const Y=ee=>{const he=e[ee].trackNo;let Se=ee+1;for(;e[Se].macroDef!==";"&&e[Se].trackNo===he;)Se++;return Se},J={};if(J.start=e.findIndex(ee=>{var he;return(he=ee.macroDef)==null?void 0:he.startsWith(D.macroUse)}),J.start>-1){J.end=Y(J.start),J.blocks=e.slice(J.start+1,J.end);const ee=performance.now();h=(await f(J.blocks,{scoreNoteValue:h})).scoreNoteValue;const he=performance.now();ie+=he-ee}}te++,w()}De(D.elem,"done")};return w(),de},d=Math.max(...e.map(v=>v.trackNo))+1;for(let v=0;v<d;v++)f(e.filter(h=>h.trackNo===v))}stopRendering(){[ue,ge,ce].forEach(e=>{e.classList.remove("no-op")}),Re.disabled=!1,at.disabled=!1,R(this,Te).forEach(e=>{e.elem.classList.remove("done")}),R(this,qe).forEach(e=>{cancelAnimationFrame(e)})}calcPoly(){const e=Math.max(...R(this,Te).map(r=>r.trackNo))+1;for(let r=0;r<e;r++)R(this,Te).filter(i=>i.polyStartEnd&&i.trackNo===r).forEach((i,t)=>{t%2===0?(i.elem.dataset.polyStartEnd="[",i.elem.textContent="["):(i.elem.dataset.polyStartEnd="]",i.elem.textContent="]")});this.blocksDataUpdate()}}Te=new WeakMap,qe=new WeakMap,it=new WeakMap,Be=new WeakMap;var pe,At,ct,Ge;class Wo{constructor(){we(this,pe,[[],[]]);we(this,At,70);we(this,ct,e=>{});we(this,Ge,e=>{})}set onPushstate(e){ke(this,ct,e)}set onPopstate(e){ke(this,Ge,e)}pushState(e){R(this,pe)[0].push(e),R(this,ct).call(this,e),R(this,pe)[0].length>R(this,At)&&R(this,pe)[0].shift(),R(this,pe)[1].length=0,console.log(R(this,pe))}undo(){const e=R(this,pe)[0].pop();return R(this,Ge).call(this,{reason:"undo",data:e}),e&&R(this,pe)[1].unshift(e),console.log(R(this,pe)),{canUndo:!!R(this,pe)[0].length,canRedo:!!R(this,pe)[1].length}}redo(){const e=R(this,pe)[1].shift();return R(this,Ge).call(this,{reason:"redo",data:e}),e&&R(this,pe)[0].push(e),console.log(R(this,pe)),{canUndo:!!R(this,pe)[0].length,canRedo:!!R(this,pe)[1].length}}clear(){R(this,pe)[0].length=0,R(this,pe)[1].length=0,console.log(R(this,pe))}}pe=new WeakMap,At=new WeakMap,ct=new WeakMap,Ge=new WeakMap;var _t,Dt,Nt;class Vo{constructor(e){we(this,_t,{tone:{title:"音色設定",inputs:[{label:"名前",type:"text",name:"tone-name"},{label:"音の定義",type:"text",name:"tone-def",autofocus:""}],buttons:[{class:"primaly",value:"set-tone",textContent:"確定"}]},tonePitch:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tone-pitch",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-tone-pitch",textContent:"確定"}]},tempo:{title:"テンポ設定",inputs:[{label:"テンポ指定(BPM)",type:"number",name:"tempo",min:"0"}],buttons:[{class:"primaly",value:"set-tempo",textContent:"確定"}]},noteValue:{title:"音価設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"note-value",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-note-value",textContent:"確定"}]},rest:{title:"休符設定",inputs:[{label:"休符の長さ",type:"number",name:"rest",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-rest",textContent:"確定"}]},octave:{title:"オクターブ設定",inputs:[{label:"オクターブ位置",type:"number",name:"octave",min:"-8",max:"8"}],buttons:[{class:"primaly",value:"set-octave",textContent:"絶対指定"},{value:"set-octave-relative",textContent:"相対指定"}]},velocity:{title:"音量設定",inputs:[{label:"音量",type:"number",name:"velocity",min:"-127",max:"127"}],buttons:[{class:"primaly",value:"set-velocity",textContent:"絶対指定"},{value:"set-velocity-relative",textContent:"相対指定"}]},noteShift:{title:"ノートシフト設定",inputs:[{label:"シフト量",type:"number",name:"note-shift"}],buttons:[{class:"primaly",value:"set-note-shift",textContent:"絶対指定"},{value:"set-note-shift-relative",textContent:"相対指定"}]},detune:{title:"デチューン設定",inputs:[{label:"デチューン量",type:"number",name:"detune"}],buttons:[{class:"primaly",value:"set-detune",textContent:"確定"}]},tieSlur:{title:"タイ設定",inputs:[{label:"音価(音の長さ)",type:"number",name:"tie-slur",min:"1",max:"384"},{label:"付点の数",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-tie-slur",textContent:"確定"}]},repeatStartEnd:{title:"ループ設定",inputs:[{label:"ループ回数",type:"number",name:"repeat",min:"0"}],buttons:[{class:"primaly",value:"set-repeat",textContent:"確定"}]},macroDef:{title:"マクロ定義設定",inputs:[{label:"名前",type:"text",name:"macro-def-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-def-arg"}],buttons:[{class:"primaly",value:"set-macro-def",textContent:"確定"}]},macroArgUse:{title:"マクロ引数使用設定",inputs:[{label:"引数名",type:"text",name:"macro-arg-use"}],buttons:[{class:"primaly",value:"set-macro-arg-use",textContent:"確定"}]},macroUse:{title:"マクロ使用設定",inputs:[{label:"名前",type:"text",name:"macro-use-name"},{label:"引数 カンマ区切り",type:"text",name:"macro-use-arg"}],buttons:[{class:"primaly",value:"set-macro-use",textContent:"確定"}]},metaData:{title:"メタデータ設定",inputs:[{label:"定義選択",select:{"#TITLE {desc}\n":"タイトル","#ARTIST {desc}\n":"アーティスト","#COMMENT {desc}\n":"コメント","#CODING {desc}\n":"作成者","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"相対オクターブ反転","#VELOCITY REVERSE\n":"相対ベロシティ反転","#WAV9 {n},{desc}\n":"@9 波形データ","#WAV10 {n},{desc}\n":"@10 波形データ","#WAV13 {n},{desc}\n":"@13 波形データ","#OPM@{n} {{desc}}\n":"@14 OPM音色データ","#OPN@{n} {{desc}}\n":"@14 OPN音色データ","#FMGAIN {n}\n":"@14 音量利得","#USING POLY {n} force\n":"和音利用宣言"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{class:"primaly",value:"set-meta-data",textContent:"確定"}]},otherAction:{title:"その他の作用設定",inputs:[{label:"任意のMML",type:"text",name:"other-action"}],buttons:[{class:"primaly",value:"set-other-action",textContent:"確定"}]},remove:{title:"一部の消去メニュー",buttons:[{value:"remove-left",textContent:"このブロックから左をすべて消去"},{value:"remove-right",textContent:"このブロックから右をすべて消去"}]}});we(this,Dt,e=>{const r=R(this,_t)[e];Object.keys(r).forEach(o=>{switch(o){case"title":re._title.textContent=r.title;break;case"inputs":r.inputs.forEach(i=>{const t=document.createElement("input");let l=t;Object.entries(i).forEach(y=>{if(y[0]==="label"){const f=document.createElement("label");f.innerHTML=y[1],f.appendChild(t),l=f}else if(y[0]==="select"){const f=document.createElement("select");f.name=i.name;const d=y[1];Object.entries(d).forEach(v=>{const h=document.createElement("option");h.value=v[0],h.textContent=v[1],f.appendChild(h)}),t.replaceWith(f)}else t.setAttribute(y[0],y[1])}),re.inputs.appendChild(l)});break;case"buttons":r.buttons.forEach(i=>{const t=document.createElement("button");Object.entries(i).forEach(l=>{l[0]==="textContent"?t.textContent=l[1]:t.setAttribute(l[0],l[1])}),re.buttons.appendChild(t)});break}})});we(this,Nt,(e,r)=>{re._title.textContent="",re.inputs.textContent="",re.buttons.textContent="",R(this,Dt).call(this,e);for(const[o,i]of Object.entries(r))o==="run"?i():re.elements[o].value=i;this.type=e});this.type=null,this.submitTarget=null,this.resolve=null,e.addEventListener("submit",r=>{const o=this.submitTarget,i=r.submitter.value,t=JSON.parse(JSON.stringify(o.dataset));switch(i){case"set-tone":const y=o.className;document.querySelectorAll(`[class*="${y}"]`).forEach(c=>{c.ariaLabel=e.elements["tone-name"].value,(!c.classList.contains("material-icons")||e.elements["tone-name"].value!=="無調整")&&(c.classList.remove("material-icons"),c.textContent=e.elements["tone-name"].value),c.dataset.tone=e.elements["tone-def"].value});break;case"set-tone-pitch":o.dataset.tonePitch=o.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]+e.elements["tone-pitch"].value+".".repeat(e.elements.dot.value);break;case"set-tempo":o.dataset.tempo="t"+e.elements.tempo.value;break;case"set-note-value":o.dataset.noteValue="l"+e.elements["note-value"].value+".".repeat(e.elements.dot.value);break;case"set-rest":o.dataset.rest="r"+e.elements.rest.value+".".repeat(e.elements.dot.value);break;case"set-octave":o.dataset.octave="o"+e.elements.octave.value;break;case"set-octave-relative":o.dataset.octave=e.elements.octave.value>0?"<".repeat(e.elements.octave.value):">".repeat(-e.elements.octave.value);break;case"set-velocity":o.dataset.velocity="@v"+e.elements.velocity.value;break;case"set-velocity-relative":o.dataset.velocity=(e.elements.velocity.value>=0?"(":")")+Math.abs(e.elements.velocity.value);break;case"set-note-shift":o.dataset.noteShift="ns"+e.elements["note-shift"].value;break;case"set-note-shift-relative":o.dataset.noteShift="@ns"+e.elements["note-shift"].value;break;case"set-detune":o.dataset.detune="@d"+e.elements.detune.value;break;case"set-tie-slur":o.dataset.tieSlur="&"+e.elements["tie-slur"].value+".".repeat(e.elements.dot.value),o.dataset.tieSlur==="&"?o.ariaLabel="スラー":o.ariaLabel="タイ";break;case"set-repeat":o.dataset.repeatStartEnd="/:"+e.elements.repeat.value;break;case"set-macro-def":const f=o.dataset.macroDef;o.dataset.macroDef="$"+e.elements["macro-def-name"].value+(e.elements["macro-def-arg"].value!==""?`{${e.elements["macro-def-arg"].value}}`:"")+"=",ce.querySelectorAll(`[data-macro-use="${f.replace("=","")}"]`).forEach(c=>{c.dataset.macroUse=o.dataset.macroDef.replace("=","")});break;case"set-macro-arg-use":o.dataset.macroArgUse="%"+e.elements["macro-arg-use"].value;break;case"set-macro-use":o.dataset.macroUse="$"+e.elements["macro-use-name"].value+(e.elements["macro-use-arg"].value!==""?`{${e.elements["macro-use-arg"].value}}`:"");break;case"set-meta-data":o.ariaLabel=e.elements["select-meta-data"].selectedOptions[0].label,o.dataset.metaData=e.elements["select-meta-data"].value.replace("{n}",e.elements.number.value).replace("{desc}",e.elements.text.value);break;case"set-other-action":o.dataset.otherAction=e.elements["other-action"].value,o.textContent=o.dataset.otherAction.length>4?"…":o.dataset.otherAction;break;case"remove-left":case"remove-right":const d=o.parentElement,v=I.activeTrack,h=v.children;for([...h].indexOf(d),X=null;[...h].includes(d);){const c=i==="remove-left",S=c?v.firstElementChild:v.lastElementChild;ye.pushState({operation:"remove",removedElem:S,removedIndex:c?0:h.length-1,parent:v}),S.remove()}I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q);break}const l=JSON.parse(JSON.stringify(o.dataset));JSON.stringify(t)!==JSON.stringify(l)&&ye.pushState({operation:"valueChange",target:o,beforeChange:t,afterChange:l}),this.resolve()})}async prompt(e,r,o){return R(this,Nt).call(this,e,r),this.submitTarget=o,$e.showModal(),new Promise(i=>this.resolve=i)}}_t=new WeakMap,Dt=new WeakMap,Nt=new WeakMap;zn.FlMML.prepare(".editor");const Ie=new zn.FlMML({workerURL:ea}),Q=new $o;Xt.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const I=new Fo(ue,ce),ye=new Wo,It=new Vo(re),zo={categories:{custom:"カスタム","smileys-emotion":"スマイリーと感情","people-body":"人々と体","animals-nature":"動物と自然","food-drink":"食べ物と飲み物","travel-places":"旅行と場所",activities:"活動",objects:"オブジェクト",symbols:"シンボル",flags:"フラグ"},categoriesLabel:"カテゴリー",emojiUnsupportedMessage:"お使いのブラウザはカラー絵文字に対応していません。",favoritesLabel:"お気に入り",loadingMessage:"読み込み中…",networkErrorMessage:"絵文字を読み込めませんでした。",regionLabel:"絵文字ピッカー",searchDescription:"検索結果が利用可能な場合、上下キーを押して選択し、Enter キーを押して選択します。",searchLabel:"検索",searchResultsLabel:"検索結果",skinToneDescription:"展開された状態で、上下キーを押して選択し、Enter キーを押して選択します。",skinToneLabel:"スキントーンを選択してください（現在のスキントーンは {skinTone} です）",skinTones:["デフォルト","ライト","ミディアムライト","ミディアム","ミディアムダーク","ダーク"],skinTonesLabel:"スキントーン"},Yo=new fn({i18n:zo,locale:"ja"});Mo.polyfill({holdToDrag:500});Po();const ot=n=>`<span class="material-icons">${n}</span>`,dr=ot("play_arrow")+"再生",Ho=ot("stop")+"停止",an=()=>{I.playRendering()},qo=()=>{Ro.innerHTML=Ie.getWarnings().replaceAll(`
`,"<br>")};Ie.addEventListener("compilecomplete",qo);const Go=()=>{wt.innerHTML=dr,I.stopRendering(),Ie.removeEventListener("compilecomplete",an),Tt.disabled=!1};Ie.addEventListener("complete",Go);Q.onChange=(n,e)=>{Uo.innerHTML=e?`<pre><code>${Oo(e).replaceAll(`
`,"<br>")}</code></pre>`:"(なし)";const r=!!n.length;[je,kt].forEach(o=>{o.disabled=!r})};Q.onError=(n,e)=>{alert(n+`
`+e)};I.checkSavedBlocksData();const Ne=n=>{var c,S;const e=()=>{let T=n.parentElement;for(;T&&!("noteValue"in T.firstElementChild.dataset);)T=T.previousElementSibling;return(T==null?void 0:T.firstElementChild)||null},r=()=>{var E;let T=n.parentElement;for(;T&&!((E=T.firstElementChild.dataset.octave)!=null&&E.startsWith("o"));)T=T.previousElementSibling;return(T==null?void 0:T.firstElementChild)||null},o=()=>{var g;let T=n.parentElement.nextElementSibling,E="";for(;T&&((g=T.firstElementChild.dataset.tieSlur)!=null&&g.match(/&[0-9]+\.*/));)E+=T.firstElementChild.dataset.tieSlur,T=T.nextElementSibling;return E},i=((c=e())==null?void 0:c.dataset.noteValue)||"",t=((S=r())==null?void 0:S.dataset.octave)||"",l=[...I.activeTrack.children].indexOf(n.parentElement),y=[...I.activeTrack.children].slice(0,l).filter(T=>"tonePitch"in T.firstElementChild.dataset||"octave"in T.firstElementChild.dataset&&!T.firstElementChild.dataset.octave.startsWith("o")).map(T=>((T.firstElementChild.dataset.tonePitch||T.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),f=[">","<"],d=(T,E)=>(T.match(new RegExp(E,"g"))||[]).length,v=(()=>{const T=-d(y,f[0])+d(y,f[1]);return T<0?f[0].repeat(-T):T>0?f[1].repeat(T):""})(),h=o();Ie.play(n.dataset.tone+i+t+v+n.dataset.tonePitch+h)};ye.onPopstate=n=>{const e=n.data,r=o=>!!e.parent.closest("#"+o);switch(n.reason){case"undo":switch(e==null?void 0:e.operation){case"append":Q.delete(e.index);break;case"delete":Q.insert(e.index,e.mmlText);break;case"rewrite":Q.rewrite(e.index,e.beforeMmlText);break;case"copy":e.newElem.remove(),r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q));break;case"move":const o=e.fromIndex<=e.toIndex?"beforebegin":"afterend";e.parent.children[e.fromIndex].insertAdjacentElement(o,e.elem),r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q));break;case"valueChange":for(const[i,t]of Object.entries(e.beforeChange))e.target.dataset[i]=t;"tone"in e.target.dataset&&Ne(e.target),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);break;case"remove":e.parent.insertBefore(e.removedElem,e.parent.children[e.removedIndex]),r("tones")||r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q));break;case"clear":e.tonesChildren.forEach(i=>{ue.querySelector("ul").appendChild(i)}),e.musicalScoreChildren.forEach(i=>{ce.insertBefore(i,Re)}),X=e.lastTouchedButton,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);break}break;case"redo":switch(e==null?void 0:e.operation){case"append":Q.append(e.mmlText);break;case"delete":Q.delete(e.index);break;case"rewrite":Q.rewrite(e.index,e.afterMmlText);break;case"copy":e.toIndex!==-1?e.parent.insertBefore(e.newElem,e.parent.children[e.toIndex]):e.parent.appendChild(e.newElem),r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q)),"tonePitch"in X.dataset&&(Ne(X),X.classList.add("bounce"));break;case"move":const o=e.toIndex>e.fromIndex?"beforebegin":"afterend";e.toIndex!==-1?e.parent.children[e.toIndex].insertAdjacentElement(o,e.elem):e.parent.appendChild(e.elem),r("musical-score")&&(I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q));break;case"valueChange":for(const[t,l]of Object.entries(e.afterChange))e.target.dataset[t]=l;"tone"in e.target.dataset&&Ne(e.target),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);break;case"remove":const i=e.removedElem.className;e.removedElem.remove(),r("tones")&&ce.querySelectorAll(`[class*="${i}"]`).forEach(t=>{t.parentElement.remove()}),I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q);break;case"clear":ue.querySelector("ul").textContent="",ce.querySelectorAll(".track").forEach((t,l)=>{l?t.remove():(t.textContent="",I.activeTrack=t)}),X=null,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);break}break}};const fr=()=>{const n=[...ue.getElementsByTagName("button")].map(e=>[...e.classList].find(r=>r.includes("note-")));for(let e=1;;e++)if(!n.includes("note-"+e))return"note-"+e};document.addEventListener("keydown",n=>{var r;const e=n.ctrlKey||Lt.checked;switch((r=n.key)==null?void 0:r.toLowerCase()){case" ":document.activeElement.tagName.toLowerCase()!=="input"&&(n.preventDefault(),wt.click());break;case"s":e&&(n.preventDefault(),!kt.disabled&&kt.click());break;case"o":e&&(n.preventDefault(),!rn.disabled&&rn.click());break;case"z":e&&ye.undo();break;case"y":e&&ye.redo();break}});const gt=async n=>{const{dataset:e}=n,r={tempo:o=>({tempo:o.replace("t","")}),noteValue:o=>({"note-value":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),rest:o=>({rest:(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),octave:o=>({octave:o.startsWith("o")?o.replace("o",""):(o.match(/[><]+/)||[""])[0].length}),velocity:o=>({velocity:o.startsWith("@v")?o.replace("@v",""):Number((o.match(/[0-9]+/)||[""])[0])*(o.startsWith("(")?1:-1)}),noteShift:o=>({"note-shift":(o.match(/[0-9]+/)||[""])[0]}),detune:o=>({detune:o.replace("@d","")}),tieSlur:o=>({"tie-slur":(o.match(/[0-9]+/)||[""])[0],dot:(o.match(/\.+/)||[""])[0].length}),repeatStartEnd:o=>({repeat:o.replace("/:","")}),macroDef:o=>({"macro-def-name":(o.match(/\$([^\{\=]*)[\{\=]/)||[,""])[1],"macro-def-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),macroArgUse:o=>({"macro-arg-use":o.replace("%","")}),macroUse:o=>({"macro-use-name":(o.match(/\$([^\{]*)\{?/)||[,""])[1],"macro-use-arg":(o.match(/\{([^\}]*)\}/)||[,""])[1]}),metaData:o=>({run:()=>{const t=o.split(" "),l=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let y=l.findIndex(c=>t[0].startsWith(c));y===-1&&(y=0),re.elements["select-meta-data"].selectedIndex=y;const f=c=>re.elements[c].previousSibling,d=()=>re.elements["select-meta-data"].selectedOptions[0],v=(c,S)=>{f("number").nodeValue=c[0],re.elements.number.value=c[1],re.elements.number.parentElement.style.display=c[2]?"none":"",f("text").nodeValue=S[0],re.elements.text.value=S[1],re.elements.text.parentElement.style.display=S[2]?"none":""},h=c=>{var E,g,N;const S=c===y,T=l[c];switch(T){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const $=S?t.slice(1).join(" ")??"":"";v(["無効","",!0],[d().label,$,!1]);break;case"#OCTAVE":case"#VELOCITY":v(["無効","",!0],["無効","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const A=T==="#WAV9",j=S?((E=t.slice(1).join(" "))==null?void 0:E.split(","))??[]:[];v(["波形番号",j[0]??0,!1],A?["初期変位,ループフラグ,データ",`${j[1]??0},${j[2]??0},${j[3]??""}`,!1]:["データ",j[1]??"",!1]),re.elements.number.min=0,re.elements.number.max=A?15:31;break;case"#OPM":case"#OPN":v(["音色番号",S?((g=t[0])==null?void 0:g.split("@")[1])??0:0,!1],["データ",S?((N=t.slice(1).join(" "))==null?void 0:N.slice(1,-1))??"":"",!1]),re.elements.number.min=0,re.elements.number.max=127;break;case"#FMGAIN":v(["音量利得",S?t[1].replace(`
`,"")??91:91,!1],["無効","",!0]),re.elements.number.min=-127,re.elements.number.max=127;break;case"#USING":v(["和音重ね数",S?t[2].replace(`
`,"")??2:2,!1],["無効","",!0]),re.elements.number.min=1,re.elements.number.max="";break}};h(y),re.elements["select-meta-data"].addEventListener("change",c=>{h(c.target.selectedIndex)})}}),otherAction:o=>({"other-action":o}),remove:()=>({})};for(const o of Object.keys(e)){const i=r[o];if(i){let t=e[o];switch(o){case"repeatStartEnd":if(t===":/"){const f=(()=>{var v;let d=n.parentElement;for(;d&&!((v=d.firstElementChild.dataset.repeatStartEnd)!=null&&v.startsWith("/:"));)d=d.previousElementSibling;return(d==null?void 0:d.firstElementChild)||null})();if(f)n=f;else{const d=I.activeTrack,v=document.createElement("li"),c=ge.querySelector(".repeat-start-end").cloneNode(!0);v.appendChild(c),d.insertBefore(v,n.parentElement),n=c}t=n.dataset.repeatStartEnd}break;case"macroDef":if(t===";")return;break}const l=i(t);await It.prompt(o,l,n);break}}};let X=ue.querySelector("button");Ue.addEventListener("click",async n=>{const e=n.ctrlKey||Lt.checked,r=i=>!!n.target.closest("#"+i),o=n.target.tagName.toLowerCase()==="button";if(![ue,ge,ce].some(i=>i.classList.contains("no-op"))){if(r("tones"))if(o)X=n.target,await It.prompt("tone",{"tone-name":n.target.ariaLabel,"tone-def":n.target.dataset.tone,run:()=>{const i=re.elements["tone-name"];i.insertAdjacentElement("afterend",Yo);const t=document.querySelector("emoji-picker");i.addEventListener("focus",()=>{t.classList.add("expaned")},{once:!0}),t.addEventListener("emoji-click",l=>i.value=l.detail.unicode)}},n.target),Ie.play(n.target.dataset.tone+n.target.dataset.tonePitch),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);else{const i=ue.querySelector("ul"),t=document.createElement("li"),y=`<button class="material-icons note ${fr()}" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;t.innerHTML=y;const f=t.firstElementChild;i.appendChild(t),X=f,Ie.play(f.dataset.tone+f.dataset.tonePitch),ye.pushState({operation:"copy",toIndex:-1,newElem:t,parent:i})}else if(r("action")){if(o){"otherAction"in n.target.dataset&&await gt(n.target);const i=I.activeTrack,t=document.createElement("li"),l=n.target.cloneNode(!0);if(("metaData"in l.dataset||"macroDef"in l.dataset||"macroArgUse"in l.dataset||"macroUse"in l.dataset)&&await gt(l),"tieSlur"in l.dataset?l.ariaLabel="スラー":"repeatStartEnd"in l.dataset?(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"):"polyStartEnd"in l.dataset?(l.dataset.polyStartEnd="[",l.textContent="["):"macroDef"in l.dataset&&(l.textContent="$="),t.appendChild(l),i.appendChild(t),X=l,I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:t,parent:i}),"repeatStartEnd"in X.dataset||"polyStartEnd"in X.dataset||"macroDef"in X.dataset){const y=document.createElement("li"),f=n.target.cloneNode(!0);"repeatStartEnd"in X.dataset?(f.ariaLabel="リピート終了",f.dataset.repeatStartEnd=":/"):"polyStartEnd"in X.dataset?(f.dataset.polyStartEnd="]",f.textContent="]"):"macroDef"in X.dataset&&(f.dataset.macroDef=";",f.textContent=";"),y.appendChild(f),X.parentElement.insertAdjacentElement("afterend",y),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:y,parent:i})}}}else if(r("musical-score")){if(o&&n.target!==Re&&n.target!==at)n.target.closest(".track")&&(I.activeTrack=n.target.closest(".track")),"tone"in n.target.dataset?(Ne(n.target),De(n.target,"bounce"),e&&(await It.prompt("tonePitch",{"tone-pitch":(n.target.dataset.tonePitch.match(/[0-9]+/)||[""])[0],dot:(n.target.dataset.tonePitch.match(/\.+/)||[""])[0].length},n.target),Ne(n.target))):await gt(n.target),X=n.target,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q);else if(X){n.target.closest(".track")&&(I.activeTrack=n.target.closest(".track"));const i=I.activeTrack,t=document.createElement("li"),l=X.cloneNode(!0);if("repeatStartEnd"in l.dataset&&(l.classList.remove("material-icons"),l.ariaLabel="リピート開始",l.textContent="◆",l.dataset.repeatStartEnd="/:"+(l.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),t.appendChild(l),i.appendChild(t),X=l,I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:t,parent:i}),"tonePitch"in l.dataset)l.dataset.tonePitch=l.dataset.tonePitch.replace(/[><]+/,""),Ne(l),l.classList.add("bounce");else if("repeatStartEnd"in X.dataset){const y=document.createElement("li"),f=X.cloneNode(!0);f.classList.add("material-icons"),f.ariaLabel="リピート終了",f.textContent="repeat",f.dataset.repeatStartEnd=":/",y.appendChild(f),X.parentElement.insertAdjacentElement("afterend",y),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:-1,newElem:y,parent:i})}}}}});Ue.addEventListener("contextmenu",n=>{var i,t,l,y;const e=f=>f.closest("#tones, #musical-score"),r=f=>!!n.target.closest("#"+f),o=n.target.tagName.toLowerCase()==="button";if(!((i=e(n.target))!=null&&i.classList.contains("no-op"))&&e(n.target)){const f=o&&n.target!==Re&&n.target!==at?n.target:X;if(!f||e(f)!==e(n.target))return;n.preventDefault(),I.activeTrack=f.closest(".track")||I.activeTrack;const d=f.parentElement,v=f.className,h=((t=f.closest("#tones"))==null?void 0:t.querySelector("ul"))||I.activeTrack,c=[...h.children].indexOf(d);X=((l=d.previousElementSibling)==null?void 0:l.firstElementChild)||((y=d.nextElementSibling)==null?void 0:y.firstElementChild)||null,ye.pushState({operation:"remove",removedElem:d,removedIndex:c,parent:h}),r("tones")?ce.querySelectorAll(`[class*="${v}"]`).forEach(S=>{S.parentElement.remove()}):"macroDef"in f.dataset&&ce.querySelectorAll(`[data-macro-use="${f.dataset.macroDef.replace("=","")}"]`).forEach(S=>{S.parentElement.remove()}),d.remove(),I.blocksDataUpdate(),I.calcPoly(),I.saveBlocksData(),I.exportMml(Q)}});let yt=null,rt=!1,on=null;Ue.addEventListener("touchstart",n=>{yt=[...n.touches].at(-1).pageY,on=setTimeout(()=>{rt=!0},500)});const hr=n=>{const e=n.ctrlKey||Lt.checked,r=l=>!!n.target.closest("#"+l),o=n.target.tagName.toLowerCase()==="button";if(n.type==="touchmove"){const l=[...n.touches].at(-1).pageY;if(rt){n.cancelable&&n.preventDefault();return}else if(l-yt<-20)n.deltaY=-1,clearTimeout(on);else if(l-yt>20)n.deltaY=1,clearTimeout(on);else{n.cancelable&&n.preventDefault();return}yt=l,rt=!0,setTimeout(()=>rt=!1,50)}const i=n.deltaY<0;let t=o?n.target:(X==null?void 0:X.closest("#musical-score"))&&X;if(t){if(r("musical-score")){if(ce.classList.contains("no-op"))return;n.preventDefault();let l=JSON.parse(JSON.stringify(t.dataset));if(!e&&"tone"in t.dataset){const f=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],d=[">","<"],v=t.dataset.tonePitch,h=f.findIndex(N=>v.match(/[a-g]\+?/)[0]===N),c=(N,$)=>(N.match(new RegExp($,"g"))||[]).length,S=[c(v,d[0]),c(v,d[1])],T=d[0].repeat(S[0])+d[1].repeat(S[1]),E=(v.match(/[0-9]+/)||[""])[0],g=".".repeat((t.dataset.tonePitch.match(/\.+/)||[""])[0].length);i?h===f.length-1?S[0]?t.dataset.tonePitch=T.substring(1)+f.at(0)+E+g:t.dataset.tonePitch=T+d[1]+f.at(0)+E+g:t.dataset.tonePitch=T+f[h+1]+E+g:h===0?S[1]?t.dataset.tonePitch=T.substring(1)+f.at(-1)+E+g:t.dataset.tonePitch=T+d[0]+f.at(-1)+E+g:t.dataset.tonePitch=T+f[h-1]+E+g,Ne(t)}else{const f=i?1:-1,d=(v,h=-1/0,c=1/0)=>v+f<h||v+f>c?0:f;if(e&&"tonePitch"in t.dataset){const v=Number((t.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),h=".".repeat((t.dataset.tonePitch.match(/\.+/)||[""])[0].length),c=d(v,0,384),S=v+c!==0?v+c:"";t.dataset.tonePitch=t.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+S+h,Ne(t)}else if("tempo"in t.dataset){const v=Number(t.dataset.tempo.replace("t","")),h=d(v,0);t.dataset.tempo="t"+(v+h*10)}else if("noteValue"in t.dataset){const v=Number((t.dataset.noteValue.match(/[0-9]+/)||[""])[0]),h=d(v,1,384);t.dataset.noteValue=t.dataset.noteValue.replace(/[0-9]+/,v+h)}else if("rest"in t.dataset){const v=Number((t.dataset.rest.match(/[0-9]+/)||[""])[0]),h=".".repeat((t.dataset.rest.match(/\.+/)||[""])[0].length),c=d(v,0,384),S=v+c!==0?v+c:"";t.dataset.rest="r"+S+h}else if("octave"in t.dataset)if(t.dataset.octave.startsWith("o")){const h=Number(t.dataset.octave.replace("o","")),c=d(h,0,8);t.dataset.octave="o"+(h+c)}else{const h=(t.dataset.octave.match(/<+/)||[""])[0].length-(t.dataset.octave.match(/>+/)||[""])[0].length,c=d(h,-8,8);t.dataset.octave=h+c>0?"<".repeat(h+c):">".repeat(-(h+c))}else if("velocity"in t.dataset)if(t.dataset.velocity.startsWith("@v")){const h=Number(t.dataset.velocity.replace("@v","")),c=d(h,0,127);t.dataset.velocity="@v"+(h+c)}else{const h=Number((t.dataset.velocity.match(/[0-9]+/)||[""])[0])*(t.dataset.velocity.startsWith("(")?1:-1),c=d(h,-127,127);t.dataset.velocity=(h+c>=0?"(":")")+Math.abs(h+c)}else if("noteShift"in t.dataset){const v=Number((t.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),h=f;t.dataset.noteShift=t.dataset.noteShift.match(/@?ns/)[0]+(v+h)}else if("detune"in t.dataset){const v=Number(t.dataset.detune.replace("@d","")),h=f;t.dataset.detune="@d"+(v+h)}else if("tieSlur"in t.dataset){const v=Number((t.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),h=".".repeat((t.dataset.tieSlur.match(/\.+/)||[""])[0].length),c=d(v,0,384),S=v+c!==0?v+c:"";t.dataset.tieSlur="&"+S+h,t.dataset.tieSlur==="&"?t.ariaLabel="スラー":t.ariaLabel="タイ"}else if("repeatStartEnd"in t.dataset){if(t.dataset.repeatStartEnd===":/"){const T=(()=>{var g;let E=t.parentElement;for(;E&&!((g=E.firstElementChild.dataset.repeatStartEnd)!=null&&g.startsWith("/:"));)E=E.previousElementSibling;return(E==null?void 0:E.firstElementChild)||null})();if(T)t=T;else{const E=I.activeTrack,g=document.createElement("li"),$=ge.querySelector(".repeat-start-end").cloneNode(!0);g.appendChild($),E.insertBefore(g,t.parentElement),t=$}l=JSON.parse(JSON.stringify(t.dataset))}const v=Number((t.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),h=d(v,-1),c=v+h!==-1?v+h:"";t.dataset.repeatStartEnd="/:"+c}}const y=JSON.parse(JSON.stringify(t.dataset));JSON.stringify(l)!==JSON.stringify(y)&&ye.pushState({operation:"valueChange",target:t,beforeChange:l,afterChange:y}),X=t,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q)}}else return};Ue.addEventListener("wheel",hr);Ue.addEventListener("touchmove",hr);Ue.addEventListener("touchend",()=>{rt=!1});let tt={};Ue.addEventListener("dragstart",n=>{tt={from:n.target.nodeType===1&&n.target.closest("#tones, #action, #musical-score"),item:n.target},n.dataTransfer.effectAllowed="copyMove"});let Wn=null;[ue,ge,ce].forEach(n=>{const e=t=>{const l=t.ctrlKey||Lt.checked,{from:y=null}=tt,f=t.dataTransfer;switch(y){case ue:switch(n){case ue:t.preventDefault(),l?f.dropEffect="copy":f.dropEffect="move";break;case ge:break;case ce:t.preventDefault(),f.dropEffect="copy";break}break;case ge:switch(n){case ue:break;case ge:break;case ce:t.preventDefault(),f.dropEffect="copy";break}break;case ce:switch(n){case ue:break;case ge:break;case ce:t.preventDefault(),l?f.dropEffect="copy":f.dropEffect="move";break}break}Wn=f.dropEffect};n.addEventListener("dragover",e);const r=t=>{const{from:l=null}=tt,y=t.target.tagName.toLowerCase()==="button",f=()=>t.target.classList.add("droppable");switch(l){case ue:switch(n){case ue:t.preventDefault(),y&&f();break;case ge:break;case ce:t.preventDefault(),y&&f();break}break;case ge:switch(n){case ue:break;case ge:break;case ce:t.preventDefault(),y&&f();break}break;case ce:switch(n){case ue:break;case ge:break;case ce:t.preventDefault(),y&&f();break}break}};n.addEventListener("dragenter",r);const o=t=>{const{from:l=null}=tt,y=t.target.tagName.toLowerCase()==="button",f=()=>t.target.classList.remove("droppable");switch(l){case ue:switch(n){case ue:y&&f();break;case ge:break;case ce:y&&f();break}break;case ge:switch(n){case ue:break;case ge:break;case ce:y&&f();break}break;case ce:switch(n){case ue:break;case ge:break;case ce:y&&f();break}break}};n.addEventListener("dragleave",o),n.addEventListener("drop",async t=>{var S,T;if(t.preventDefault(),(S=t.dataTransfer.items)!=null&&S.length)return;t.dataTransfer.dropEffect=t.dataTransfer.dropEffect!=="none"?t.dataTransfer.dropEffect:Wn;const{from:l,item:y}=tt,f=((T=t.target.closest("#tones"))==null?void 0:T.querySelector("ul"))||t.target.closest(".track")||I.activeTrack,d=[...f.children].indexOf(y.parentElement),v=[...f.children].indexOf(t.target.parentElement),h=t.target.tagName.toLowerCase()==="button";let c;switch(t.dataTransfer.dropEffect){case"copy":const E=document.createElement("li"),g=y.cloneNode(!0);if(n===ue){const N=[...y.classList].find($=>$.includes("note-"));g.classList.replace(N,fr())}else l===ge&&("tieSlur"in g.dataset?g.ariaLabel="スラー":("metaData"in g.dataset||"macroDef"in g.dataset||"macroArgUse"in g.dataset||"macroUse"in g.dataset||"otherAction"in g.dataset)&&await gt(g));"repeatStartEnd"in g.dataset?(g.classList.remove("material-icons"),g.ariaLabel="リピート開始",g.textContent="◆",g.dataset.repeatStartEnd="/:"+(g.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in g.dataset?(g.dataset.polyStartEnd="[",g.textContent="["):"macroDef"in g.dataset&&(g.dataset.macroDef===";"&&(g.dataset.macroDef="$="),g.textContent="$="),E.appendChild(g),c=E;break;case"move":c=y.parentElement;break}if(h&&t.target.id!=="add-track"&&t.target.id!=="remove-track"){const E=t.dataTransfer.dropEffect==="copy"||v<d?"beforebegin":"afterend";t.target.parentElement.insertAdjacentElement(E,c)}else f.appendChild(c);switch(X=c.firstElementChild,n===ce&&(I.activeTrack=f,I.blocksDataUpdate(),t.dataTransfer.dropEffect==="move"&&I.calcPoly(),I.saveBlocksData(),I.exportMml(Q),"tonePitch"in X.dataset&&(X.dataset.tonePitch=X.dataset.tonePitch.replace(/[><]+/,""),Ne(X),X.classList.add("bounce"))),t.dataTransfer.dropEffect){case"copy":ye.pushState({operation:"copy",toIndex:v,newElem:c,parent:f});break;case"move":ye.pushState({operation:"move",fromIndex:d,toIndex:v,elem:c,parent:f});break}if(t.dataTransfer.dropEffect==="copy"&&("repeatStartEnd"in X.dataset||"polyStartEnd"in X.dataset||"macroDef"in X.dataset)){const E=document.createElement("li"),g=y.cloneNode(!0);"repeatStartEnd"in X.dataset?(g.classList.add("material-icons"),g.ariaLabel="リピート終了",g.textContent="repeat",g.dataset.repeatStartEnd=":/"):"polyStartEnd"in X.dataset?(g.dataset.polyStartEnd="]",g.textContent="]"):"macroDef"in X.dataset&&(g.dataset.macroDef=";",g.textContent=";"),E.appendChild(g),c.insertAdjacentElement("afterend",E),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q),ye.pushState({operation:"copy",toIndex:v+1,newElem:E,parent:f})}});const i=t=>{[...document.getElementsByClassName("droppable")].forEach(l=>{l.classList.remove("droppable")})};n.addEventListener("dragend",i)});Ue.addEventListener("animationend",n=>{n.target.classList.remove("bounce"),n.target.classList.remove("pop")});Re.addEventListener("click",n=>{n.stopPropagation();const e=document.createElement("ul");e.classList.add("track"),I.activeTrack=e,ce.insertBefore(e,Re)});at.addEventListener("click",n=>{n.stopPropagation();const e=[...document.getElementsByClassName("track")].at(-1),r=e.previousElementSibling;e.remove(),I.activeTrack=r,I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q)});$e.addEventListener("pointerdown",n=>{n.target===$e&&$e.addEventListener("pointerup",e=>{e.target===$e&&$e.close()},{once:!0})});$e.addEventListener("close",()=>{switch(It.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}});wt.addEventListener("click",()=>{const n=Ie.isPlaying();n?(Ie.stop(),I.stopRendering(),Ie.removeEventListener("compilecomplete",an),Tt.disabled=!1):(Ie.play(Q.getMml()),Ie.addEventListener("compilecomplete",an),Tt.disabled=!0),wt.innerHTML=n?dr:Ho});Tt.addEventListener("click",()=>{if(confirm("音色と追加したブロックを全て消去しますか？")){const n=[...ce.children];n.pop(),ye.pushState({operation:"clear",tonesChildren:[...ue.querySelector("ul").children],musicalScoreChildren:n,lastTouchedButton:X}),ue.querySelector("ul").textContent="";const e=ue.querySelector("ul"),r=document.createElement("li"),o='<button class="material-icons note note-1" aria-label="無調整" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';r.innerHTML=o;const i=r.firstElementChild;e.appendChild(r),X=i,ce.querySelectorAll(".track").forEach((t,l)=>{l?t.remove():(t.textContent="",I.activeTrack=t)}),I.blocksDataUpdate(),I.saveBlocksData(),I.exportMml(Q)}});je.addEventListener("click",()=>{const n=Q.getMml(),e=je.innerHTML;je.disabled=!0,navigator.clipboard.writeText(n).then(()=>{je.disabled=!0,je.innerHTML=ot("content_copy")+"コピーしました",setTimeout(()=>{je.innerHTML=e,je.disabled=!1},1500)}).catch(r=>alert(`コピーできませんでした
`+r))});Pe.addEventListener("click",()=>{const n=Pe.innerHTML;Pe.disabled=!0,navigator.clipboard.readText().then(e=>{Pe.disabled=!0,e?(Q.setMml(e.replace(/\r/g,"")),I.importMml(Q),Pe.innerHTML=ot("content_paste")+"貼り付けました"):Pe.innerHTML=ot("content_paste")+"内容がありません",setTimeout(()=>{Pe.innerHTML=n,Pe.disabled=!1},1500)}).catch(e=>alert(`貼り付けできませんでした
`+e))});kt.addEventListener("click",()=>{var t;const n=Q.getMml(),r=((t=Q.getMmlArr().find(l=>l.startsWith("#TITLE")))==null?void 0:t.split(" ").slice(1).join(" "))??"無題",o=new Blob([n],{type:"text/plain"}),i=document.createElement("a");i.download=r+".mml",i.href=URL.createObjectURL(o),i.click(),URL.revokeObjectURL(i.href),r==="無題"&&alert("ファイル名を付けるには、先頭にメタデータブロックを追加->タイトルを選択して入力->確定してタイトルを付けてください。")});rn.addEventListener("click",()=>{const n=document.createElement("input"),e=new FileReader;n.type="file",n.accept=".mml,.flmml,.txt",n.click(),n.onchange=()=>{e.onload=()=>{Q.setMml(e.result),I.importMml(Q)},e.readAsText(n.files[0])}});("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile");ye.onPushstate=n=>{xt.disabled=!1,Ct.disabled=!0};xt.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=ye.undo();xt.disabled=!n,Ct.disabled=!e});Ct.addEventListener("click",()=>{const{canUndo:n,canRedo:e}=ye.redo();xt.disabled=!n,Ct.disabled=!e});
