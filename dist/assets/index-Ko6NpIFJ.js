var hn=(n,e,i)=>{if(!e.has(n))throw TypeError("Cannot "+i)};var Q=(n,e,i)=>(hn(n,e,"read from private field"),i?i.call(n):e.get(n)),We=(n,e,i)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,i)},He=(n,e,i,s)=>(hn(n,e,"write to private field"),s?s.call(n,i):e.set(n,i),i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const m of document.querySelectorAll('link[rel="modulepreload"]'))s(m);new MutationObserver(m=>{for(const o of m)if(o.type==="childList")for(const v of o.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&s(v)}).observe(document,{childList:!0,subtree:!0});function i(m){const o={};return m.integrity&&(o.integrity=m.integrity),m.referrerPolicy&&(o.referrerPolicy=m.referrerPolicy),m.crossOrigin==="use-credentials"?o.credentials="include":m.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(m){if(m.ep)return;m.ep=!0;const o=i(m);fetch(m.href,o)}})();const ar="/flmml-visualsequencer/assets/flmml-on-html5.worker-4sfLOJFg.js";var Tt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function or(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var kn={exports:{}};/*! flmml-on-html5 v2.0.3 | (c) 2015, argentum384 (c) 2007, Takeshi OKUBO | BSD-3-Clause | https://github.com/argentum384/flmml-on-html5 */(function(n,e){(function(i,s){n.exports=s()})(self,function(){return(()=>{var i={587:(o,v,g)=>{var j;(j=(function(E,F){Object.defineProperty(F,"__esModule",{value:!0}),F.MsgTypes=F.SAMPLE_RATE=void 0,F.SAMPLE_RATE=44100,F.MsgTypes={BOOT:1,PLAY:2,STOP:3,PAUSE:4,COMPCOMP:6,BUFRING:7,COMPLETE:8,SYNCINFO:9,PLAYSOUND:10,STOPSOUND:11,EXPORT:12}}).apply(v,[g,v]))===void 0||(o.exports=j)},581:(o,v,g)=>{var j;(j=(function(E,F){Object.defineProperty(F,"__esModule",{value:!0}),F.FlMMLAudioExportError=void 0;class w extends Error{constructor(...B){super(...B),this.name="FlMMLAudioExportError"}}F.FlMMLAudioExportError=w}).apply(v,[g,v]))===void 0||(o.exports=j)},643:function(o,v,g){var j,E,F=this&&this.__awaiter||function(w,S,B,ue){return new(B||(B=Promise))(function(ve,ee){function te(J){try{z(ue.next(J))}catch(I){ee(I)}}function pe(J){try{z(ue.throw(J))}catch(I){ee(I)}}function z(J){var I;J.done?ve(J.value):(I=J.value,I instanceof B?I:new B(function(Z){Z(I)})).then(te,pe)}z((ue=ue.apply(w,S||[])).next())})};j=[g,v,g(587),g(581),g(158)],(E=(function(w,S,B,ue,ve){Object.defineProperty(S,"__esModule",{value:!0}),S.FlMMLonHTML5=S.FlMMLAudioExportError=S.FlMML=void 0,Object.defineProperty(S,"FlMMLAudioExportError",{enumerable:!0,get:function(){return ue.FlMMLAudioExportError}});const ee="flmml-on-html5.worker.js";class te{constructor(z=ee){this.booted=!1,this.volume=100,this.events={},this.workletModuleLoaded=!1,this.totalMSec=0,this.totalTimeStr="00:00",this.warnings="",this.metaTitle="",this.metaComment="",this.metaArtist="",this.metaCoding="",this._isPlaying=!1,this._isPaused=!1,this.nowMSec=0,this.nowTimeStr="00:00",this.voiceCount=0,typeof z=="string"&&(z={workerURL:z});const J=z.workerURL||ee,I=z.infoInterval>=0?z.infoInterval:125;this.bufferSize=z.bufferSize>=128?Math.floor(z.bufferSize-z.bufferSize%128):8192,this.bufferMultiple=z.bufferMultiple>=1?Math.floor(z.bufferMultiple):32,this.lamejsURL=z.lamejsURL,(this.worker=new Worker(z.crossOriginWorker?URL.createObjectURL(new Blob([`importScripts("${J}")`],{type:"application/javascript"})):J)).addEventListener("message",Z=>{this.onMessage(Z)}),this.setInfoInterval(I)}static initWebAudio(){const z=te.audioCtx=new AudioContext({sampleRate:B.SAMPLE_RATE}),J=z.createBufferSource();J.connect(z.destination),J.start(0),z.resume(),J.stop()}static hookInitWebAudio(z){const J=document.querySelectorAll(z);J.forEach(I=>{I.addEventListener("click",function Z(){te.audioCtx||te.initWebAudio(),J.forEach(K=>{K.removeEventListener("click",Z,!0)})},!0)})}static prepare(z){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{te.hookInitWebAudio(z)}):te.hookInitWebAudio(z)}onMessage(z){const J=z.data;switch(J.type){case B.MsgTypes.COMPCOMP:this.totalMSec=J.info.totalMSec,this.totalTimeStr=J.info.totalTimeStr,this.warnings=J.info.warnings,this.metaTitle=J.info.metaTitle,this.metaComment=J.info.metaComment,this.metaArtist=J.info.metaArtist,this.metaCoding=J.info.metaCoding,this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case B.MsgTypes.BUFRING:this.onbuffering&&this.onbuffering(J),this.trigger("buffering",{progress:J.progress});break;case B.MsgTypes.COMPLETE:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case B.MsgTypes.SYNCINFO:this._isPlaying=J.info._isPlaying,this._isPaused=J.info._isPaused,this.nowMSec=J.info.nowMSec,this.nowTimeStr=J.info.nowTimeStr,this.voiceCount=J.info.voiceCount,this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case B.MsgTypes.PLAYSOUND:this.playSound();break;case B.MsgTypes.STOPSOUND:this.stopSound();break;case B.MsgTypes.EXPORT:J.data?this.completeAudioExport(J.data):this.errorAudioExport(J.errorMsg)}}boot(){this.worker.postMessage({type:B.MsgTypes.BOOT,bufferSize:this.bufferSize,bufferMultiple:this.bufferMultiple,lamejsURL:this.lamejsURL}),this.booted=!0}playSound(){if(this.gainNode||this.workletNode)return;const z=te.audioCtx,J=this.gainNode=z.createGain();J.gain.value=this.volume/127,J.connect(z.destination),F(this,void 0,void 0,function*(){this.workletModuleLoaded||(yield new Promise(Z=>{const K=new FileReader;K.onload=q=>{z.audioWorklet.addModule(q.target.result).then(Z)},K.readAsDataURL(new Blob([ve.FlMMLWorkletScript],{type:"application/javascript"}))}),this.workletModuleLoaded=!0);const I=this.workletNode=new AudioWorkletNode(z,"flmml-worklet-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});I.connect(J),this.worker.postMessage({type:B.MsgTypes.PLAYSOUND,workletPort:I.port},[I.port])})}stopSound(){this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null),this.worker.postMessage({type:B.MsgTypes.STOPSOUND})}trigger(z,J){const I=this.events[z];if(!I)return;const Z={};for(let K in J)Z[K]=J[K];for(let K=0,q=I.length;K<q;K++)I[K]&&I[K].call(this,Z)}exportAudio(z,J,I={}){return te.audioCtx||te.initWebAudio(),this.booted||this.boot(),new Promise((Z,K)=>{this.audioExportResolve?K(new ue.FlMMLAudioExportError("Another process is already running")):(this.worker.postMessage(Object.assign({type:B.MsgTypes.EXPORT,mml:z,format:J},I)),this.audioExportResolve=Z,this.audioExportReject=K)})}completeAudioExport(z){this.audioExportResolve&&(this.audioExportResolve(z),this.audioExportResolve=null,this.audioExportReject=null)}errorAudioExport(z){this.audioExportReject&&(this.audioExportReject(new ue.FlMMLAudioExportError(z)),this.audioExportResolve=null,this.audioExportReject=null)}play(z){te.audioCtx||te.initWebAudio(),this.booted||this.boot(),this.worker.postMessage({type:B.MsgTypes.PLAY,mml:z})}stop(){this.worker.postMessage({type:B.MsgTypes.STOP})}pause(){this.worker.postMessage({type:B.MsgTypes.PAUSE})}exportWav(z){return this.exportAudio(z,"wav")}exportMp3(z,J){return this.exportAudio(z,"mp3",{bitrate:J})}setMasterVolume(z){this.volume=z,this.gainNode&&(this.gainNode.gain.value=this.volume/127)}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}getWarnings(){return this.warnings}getTotalMSec(){return Math.floor(this.totalMSec)}getTotalTimeStr(){return this.totalTimeStr}getNowMSec(){return Math.floor(this.nowMSec)}getNowTimeStr(){return this.nowTimeStr}getVoiceCount(){return this.voiceCount}getMetaTitle(){return this.metaTitle}getMetaComment(){return this.metaComment}getMetaArtist(){return this.metaArtist}getMetaCoding(){return this.metaCoding}setInfoInterval(z){this.worker.postMessage({type:B.MsgTypes.SYNCINFO,interval:z})}syncInfo(){this.worker.postMessage({type:B.MsgTypes.SYNCINFO,interval:null})}addEventListener(z,J){let I=this.events[z];I||(I=this.events[z]=[]);for(let Z=I.length;Z--;)if(I[Z]===J)return!1;return I.push(J),!0}removeEventListener(z,J){const I=this.events[z];if(!I)return!1;for(let Z=I.length;Z--;)if(I[Z]===J)return I.splice(Z,1),!0;return!1}release(){this.stopSound(),this.worker.terminate()}}S.FlMML=te,S.FlMMLonHTML5=te}).apply(v,j))===void 0||(o.exports=E)},158:(o,v,g)=>{g.r(v),g.d(v,{FlMMLWorkletScript:()=>j});const j='registerProcessor("flmml-worklet-processor",class extends AudioWorkletProcessor{constructor(...s){super(...s),this.buffer=null,this.backBuffer=null,this.bufferId=1,this.offset=0,this.reqTimes=0,this.reqCount=0,this.release=!1,this.port.addEventListener("message",(s=>this.onMessage(s))),this.port.start()}process(s,e,t){if(this.buffer){if(e[0][0].set(this.buffer[0].subarray(this.offset,this.offset+128)),e[0][1].set(this.buffer[1].subarray(this.offset,this.offset+128)),this.offset+=128,this.offset>=this.buffer[0].length){const s=this.buffer;this.backBuffer?(this.buffer=this.backBuffer,this.backBuffer=null):this.buffer=null,this.offset=0,this.port.postMessage({bufferId:this.bufferId,retBuf:s},[s[0].buffer,s[1].buffer])}}else e[0][0].fill(0),e[0][1].fill(0),++this.reqCount>=1<<this.reqTimes&&(this.port.postMessage({bufferId:this.bufferId,retBuf:null}),this.reqTimes<10&&this.reqTimes++,this.reqCount=0);return!this.release}onMessage(s){const e=s.data;e.buffer&&(this.bufferId++,this.buffer?this.backBuffer=e.buffer:(this.buffer=e.buffer,this.reqTimes=0,this.reqCount=0,this.port.postMessage({bufferId:this.bufferId,retBuf:null}))),e.release&&(this.release=!0)}});'}},s={};function m(o){var v=s[o];if(v!==void 0)return v.exports;var g=s[o]={exports:{}};return i[o].call(g.exports,g,g.exports,m),g.exports}return m.d=(o,v)=>{for(var g in v)m.o(v,g)&&!m.o(o,g)&&Object.defineProperty(o,g,{enumerable:!0,get:v[g]})},m.o=(o,v)=>Object.prototype.hasOwnProperty.call(o,v),m.r=o=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},m(643)})()})})(kn);var mn=kn.exports;function It(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var xn={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(n,e){(function(i){n.exports=i()})(function(){return function i(s,m,o){function v(E,F){if(!m[E]){if(!s[E]){var w=typeof It=="function"&&It;if(!F&&w)return w(E,!0);if(g)return g(E,!0);var S=new Error("Cannot find module '"+E+"'");throw S.code="MODULE_NOT_FOUND",S}var B=m[E]={exports:{}};s[E][0].call(B.exports,function(ue){var ve=s[E][1][ue];return v(ve||ue)},B,B.exports,i,s,m,o)}return m[E].exports}for(var g=typeof It=="function"&&It,j=0;j<o.length;j++)v(o[j]);return v}({1:[function(i,s,m){(function(o){var v=o.MutationObserver||o.WebKitMutationObserver,g;if(v){var j=0,E=new v(ue),F=o.document.createTextNode("");E.observe(F,{characterData:!0}),g=function(){F.data=j=++j%2}}else if(!o.setImmediate&&typeof o.MessageChannel<"u"){var w=new o.MessageChannel;w.port1.onmessage=ue,g=function(){w.port2.postMessage(0)}}else"document"in o&&"onreadystatechange"in o.document.createElement("script")?g=function(){var ee=o.document.createElement("script");ee.onreadystatechange=function(){ue(),ee.onreadystatechange=null,ee.parentNode.removeChild(ee),ee=null},o.document.documentElement.appendChild(ee)}:g=function(){setTimeout(ue,0)};var S,B=[];function ue(){S=!0;for(var ee,te,pe=B.length;pe;){for(te=B,B=[],ee=-1;++ee<pe;)te[ee]();pe=B.length}S=!1}s.exports=ve;function ve(ee){B.push(ee)===1&&!S&&g()}}).call(this,typeof Tt<"u"?Tt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(i,s,m){var o=i(1);function v(){}var g={},j=["REJECTED"],E=["FULFILLED"],F=["PENDING"];s.exports=w;function w(I){if(typeof I!="function")throw new TypeError("resolver must be a function");this.state=F,this.queue=[],this.outcome=void 0,I!==v&&ve(this,I)}w.prototype.catch=function(I){return this.then(null,I)},w.prototype.then=function(I,Z){if(typeof I!="function"&&this.state===E||typeof Z!="function"&&this.state===j)return this;var K=new this.constructor(v);if(this.state!==F){var q=this.state===E?I:Z;B(K,q,this.outcome)}else this.queue.push(new S(K,I,Z));return K};function S(I,Z,K){this.promise=I,typeof Z=="function"&&(this.onFulfilled=Z,this.callFulfilled=this.otherCallFulfilled),typeof K=="function"&&(this.onRejected=K,this.callRejected=this.otherCallRejected)}S.prototype.callFulfilled=function(I){g.resolve(this.promise,I)},S.prototype.otherCallFulfilled=function(I){B(this.promise,this.onFulfilled,I)},S.prototype.callRejected=function(I){g.reject(this.promise,I)},S.prototype.otherCallRejected=function(I){B(this.promise,this.onRejected,I)};function B(I,Z,K){o(function(){var q;try{q=Z(K)}catch(b){return g.reject(I,b)}q===I?g.reject(I,new TypeError("Cannot resolve promise with itself")):g.resolve(I,q)})}g.resolve=function(I,Z){var K=ee(ue,Z);if(K.status==="error")return g.reject(I,K.value);var q=K.value;if(q)ve(I,q);else{I.state=E,I.outcome=Z;for(var b=-1,he=I.queue.length;++b<he;)I.queue[b].callFulfilled(Z)}return I},g.reject=function(I,Z){I.state=j,I.outcome=Z;for(var K=-1,q=I.queue.length;++K<q;)I.queue[K].callRejected(Z);return I};function ue(I){var Z=I&&I.then;if(I&&(typeof I=="object"||typeof I=="function")&&typeof Z=="function")return function(){Z.apply(I,arguments)}}function ve(I,Z){var K=!1;function q(Ne){K||(K=!0,g.reject(I,Ne))}function b(Ne){K||(K=!0,g.resolve(I,Ne))}function he(){Z(b,q)}var Ce=ee(he);Ce.status==="error"&&q(Ce.value)}function ee(I,Z){var K={};try{K.value=I(Z),K.status="success"}catch(q){K.status="error",K.value=q}return K}w.resolve=te;function te(I){return I instanceof this?I:g.resolve(new this(v),I)}w.reject=pe;function pe(I){var Z=new this(v);return g.reject(Z,I)}w.all=z;function z(I){var Z=this;if(Object.prototype.toString.call(I)!=="[object Array]")return this.reject(new TypeError("must be an array"));var K=I.length,q=!1;if(!K)return this.resolve([]);for(var b=new Array(K),he=0,Ce=-1,Ne=new this(v);++Ce<K;)Oe(I[Ce],Ce);return Ne;function Oe(O,T){Z.resolve(O).then(H,function(ie){q||(q=!0,g.reject(Ne,ie))});function H(ie){b[T]=ie,++he===K&&!q&&(q=!0,g.resolve(Ne,b))}}}w.race=J;function J(I){var Z=this;if(Object.prototype.toString.call(I)!=="[object Array]")return this.reject(new TypeError("must be an array"));var K=I.length,q=!1;if(!K)return this.resolve([]);for(var b=-1,he=new this(v);++b<K;)Ce(I[b]);return he;function Ce(Ne){Z.resolve(Ne).then(function(Oe){q||(q=!0,g.resolve(he,Oe))},function(Oe){q||(q=!0,g.reject(he,Oe))})}}},{1:1}],3:[function(i,s,m){(function(o){typeof o.Promise!="function"&&(o.Promise=i(2))}).call(this,typeof Tt<"u"?Tt:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(i,s,m){var o=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function v(t,c){if(!(t instanceof c))throw new TypeError("Cannot call a class as a function")}function g(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var j=g();function E(){try{if(!j||!j.open)return!1;var t=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),c=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!t||c)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function F(t,c){t=t||[],c=c||{};try{return new Blob(t,c)}catch(l){if(l.name!=="TypeError")throw l;for(var r=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,u=new r,f=0;f<t.length;f+=1)u.append(t[f]);return u.getBlob(c.type)}}typeof Promise>"u"&&i(3);var w=Promise;function S(t,c){c&&t.then(function(r){c(null,r)},function(r){c(r)})}function B(t,c,r){typeof c=="function"&&t.then(c),typeof r=="function"&&t.catch(r)}function ue(t){return typeof t!="string"&&(console.warn(t+" used as a key, but it is not a string."),t=String(t)),t}function ve(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var ee="local-forage-detect-blob-support",te=void 0,pe={},z=Object.prototype.toString,J="readonly",I="readwrite";function Z(t){for(var c=t.length,r=new ArrayBuffer(c),u=new Uint8Array(r),f=0;f<c;f++)u[f]=t.charCodeAt(f);return r}function K(t){return new w(function(c){var r=t.transaction(ee,I),u=F([""]);r.objectStore(ee).put(u,"key"),r.onabort=function(f){f.preventDefault(),f.stopPropagation(),c(!1)},r.oncomplete=function(){var f=navigator.userAgent.match(/Chrome\/(\d+)/),l=navigator.userAgent.match(/Edge\//);c(l||!f||parseInt(f[1],10)>=43)}}).catch(function(){return!1})}function q(t){return typeof te=="boolean"?w.resolve(te):K(t).then(function(c){return te=c,te})}function b(t){var c=pe[t.name],r={};r.promise=new w(function(u,f){r.resolve=u,r.reject=f}),c.deferredOperations.push(r),c.dbReady?c.dbReady=c.dbReady.then(function(){return r.promise}):c.dbReady=r.promise}function he(t){var c=pe[t.name],r=c.deferredOperations.pop();if(r)return r.resolve(),r.promise}function Ce(t,c){var r=pe[t.name],u=r.deferredOperations.pop();if(u)return u.reject(c),u.promise}function Ne(t,c){return new w(function(r,u){if(pe[t.name]=pe[t.name]||we(),t.db)if(c)b(t),t.db.close();else return r(t.db);var f=[t.name];c&&f.push(t.version);var l=j.open.apply(j,f);c&&(l.onupgradeneeded=function(x){var M=l.result;try{M.createObjectStore(t.storeName),x.oldVersion<=1&&M.createObjectStore(ee)}catch(R){if(R.name==="ConstraintError")console.warn('The database "'+t.name+'" has been upgraded from version '+x.oldVersion+" to version "+x.newVersion+', but the storage "'+t.storeName+'" already exists.');else throw R}}),l.onerror=function(x){x.preventDefault(),u(l.error)},l.onsuccess=function(){var x=l.result;x.onversionchange=function(M){M.target.close()},r(x),he(t)}})}function Oe(t){return Ne(t,!1)}function O(t){return Ne(t,!0)}function T(t,c){if(!t.db)return!0;var r=!t.db.objectStoreNames.contains(t.storeName),u=t.version<t.db.version,f=t.version>t.db.version;if(u&&(t.version!==c&&console.warn('The database "'+t.name+`" can't be downgraded from version `+t.db.version+" to version "+t.version+"."),t.version=t.db.version),f||r){if(r){var l=t.db.version+1;l>t.version&&(t.version=l)}return!0}return!1}function H(t){return new w(function(c,r){var u=new FileReader;u.onerror=r,u.onloadend=function(f){var l=btoa(f.target.result||"");c({__local_forage_encoded_blob:!0,data:l,type:t.type})},u.readAsBinaryString(t)})}function ie(t){var c=Z(atob(t.data));return F([c],{type:t.type})}function ce(t){return t&&t.__local_forage_encoded_blob}function me(t){var c=this,r=c._initReady().then(function(){var u=pe[c._dbInfo.name];if(u&&u.dbReady)return u.dbReady});return B(r,t,t),r}function fe(t){b(t);for(var c=pe[t.name],r=c.forages,u=0;u<r.length;u++){var f=r[u];f._dbInfo.db&&(f._dbInfo.db.close(),f._dbInfo.db=null)}return t.db=null,Oe(t).then(function(l){return t.db=l,T(t)?O(t):l}).then(function(l){t.db=c.db=l;for(var x=0;x<r.length;x++)r[x]._dbInfo.db=l}).catch(function(l){throw Ce(t,l),l})}function Se(t,c,r,u){u===void 0&&(u=1);try{var f=t.db.transaction(t.storeName,c);r(null,f)}catch(l){if(u>0&&(!t.db||l.name==="InvalidStateError"||l.name==="NotFoundError"))return w.resolve().then(function(){if(!t.db||l.name==="NotFoundError"&&!t.db.objectStoreNames.contains(t.storeName)&&t.version<=t.db.version)return t.db&&(t.version=t.db.version+1),O(t)}).then(function(){return fe(t).then(function(){Se(t,c,r,u-1)})}).catch(r);r(l)}}function we(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function re(t){var c=this,r={db:null};if(t)for(var u in t)r[u]=t[u];var f=pe[r.name];f||(f=we(),pe[r.name]=f),f.forages.push(c),c._initReady||(c._initReady=c.ready,c.ready=me);var l=[];function x(){return w.resolve()}for(var M=0;M<f.forages.length;M++){var R=f.forages[M];R!==c&&l.push(R._initReady().catch(x))}var U=f.forages.slice(0);return w.all(l).then(function(){return r.db=f.db,Oe(r)}).then(function(Y){return r.db=Y,T(r,c._defaultConfig.version)?O(r):Y}).then(function(Y){r.db=f.db=Y,c._dbInfo=r;for(var ae=0;ae<U.length;ae++){var ge=U[ae];ge!==c&&(ge._dbInfo.db=r.db,ge._dbInfo.version=r.version)}})}function je(t,c){var r=this;t=ue(t);var u=new w(function(f,l){r.ready().then(function(){Se(r._dbInfo,J,function(x,M){if(x)return l(x);try{var R=M.objectStore(r._dbInfo.storeName),U=R.get(t);U.onsuccess=function(){var Y=U.result;Y===void 0&&(Y=null),ce(Y)&&(Y=ie(Y)),f(Y)},U.onerror=function(){l(U.error)}}catch(Y){l(Y)}})}).catch(l)});return S(u,c),u}function Pe(t,c){var r=this,u=new w(function(f,l){r.ready().then(function(){Se(r._dbInfo,J,function(x,M){if(x)return l(x);try{var R=M.objectStore(r._dbInfo.storeName),U=R.openCursor(),Y=1;U.onsuccess=function(){var ae=U.result;if(ae){var ge=ae.value;ce(ge)&&(ge=ie(ge));var ke=t(ge,ae.key,Y++);ke!==void 0?f(ke):ae.continue()}else f()},U.onerror=function(){l(U.error)}}catch(ae){l(ae)}})}).catch(l)});return S(u,c),u}function k(t,c,r){var u=this;t=ue(t);var f=new w(function(l,x){var M;u.ready().then(function(){return M=u._dbInfo,z.call(c)==="[object Blob]"?q(M.db).then(function(R){return R?c:H(c)}):c}).then(function(R){Se(u._dbInfo,I,function(U,Y){if(U)return x(U);try{var ae=Y.objectStore(u._dbInfo.storeName);R===null&&(R=void 0);var ge=ae.put(R,t);Y.oncomplete=function(){R===void 0&&(R=null),l(R)},Y.onabort=Y.onerror=function(){var ke=ge.error?ge.error:ge.transaction.error;x(ke)}}catch(ke){x(ke)}})}).catch(x)});return S(f,r),f}function X(t,c){var r=this;t=ue(t);var u=new w(function(f,l){r.ready().then(function(){Se(r._dbInfo,I,function(x,M){if(x)return l(x);try{var R=M.objectStore(r._dbInfo.storeName),U=R.delete(t);M.oncomplete=function(){f()},M.onerror=function(){l(U.error)},M.onabort=function(){var Y=U.error?U.error:U.transaction.error;l(Y)}}catch(Y){l(Y)}})}).catch(l)});return S(u,c),u}function se(t){var c=this,r=new w(function(u,f){c.ready().then(function(){Se(c._dbInfo,I,function(l,x){if(l)return f(l);try{var M=x.objectStore(c._dbInfo.storeName),R=M.clear();x.oncomplete=function(){u()},x.onabort=x.onerror=function(){var U=R.error?R.error:R.transaction.error;f(U)}}catch(U){f(U)}})}).catch(f)});return S(r,t),r}function le(t){var c=this,r=new w(function(u,f){c.ready().then(function(){Se(c._dbInfo,J,function(l,x){if(l)return f(l);try{var M=x.objectStore(c._dbInfo.storeName),R=M.count();R.onsuccess=function(){u(R.result)},R.onerror=function(){f(R.error)}}catch(U){f(U)}})}).catch(f)});return S(r,t),r}function be(t,c){var r=this,u=new w(function(f,l){if(t<0){f(null);return}r.ready().then(function(){Se(r._dbInfo,J,function(x,M){if(x)return l(x);try{var R=M.objectStore(r._dbInfo.storeName),U=!1,Y=R.openKeyCursor();Y.onsuccess=function(){var ae=Y.result;if(!ae){f(null);return}t===0||U?f(ae.key):(U=!0,ae.advance(t))},Y.onerror=function(){l(Y.error)}}catch(ae){l(ae)}})}).catch(l)});return S(u,c),u}function ne(t){var c=this,r=new w(function(u,f){c.ready().then(function(){Se(c._dbInfo,J,function(l,x){if(l)return f(l);try{var M=x.objectStore(c._dbInfo.storeName),R=M.openKeyCursor(),U=[];R.onsuccess=function(){var Y=R.result;if(!Y){u(U);return}U.push(Y.key),Y.continue()},R.onerror=function(){f(R.error)}}catch(Y){f(Y)}})}).catch(f)});return S(r,t),r}function Te(t,c){c=ve.apply(this,arguments);var r=this.config();t=typeof t!="function"&&t||{},t.name||(t.name=t.name||r.name,t.storeName=t.storeName||r.storeName);var u=this,f;if(!t.name)f=w.reject("Invalid arguments");else{var l=t.name===r.name&&u._dbInfo.db,x=l?w.resolve(u._dbInfo.db):Oe(t).then(function(M){var R=pe[t.name],U=R.forages;R.db=M;for(var Y=0;Y<U.length;Y++)U[Y]._dbInfo.db=M;return M});t.storeName?f=x.then(function(M){if(M.objectStoreNames.contains(t.storeName)){var R=M.version+1;b(t);var U=pe[t.name],Y=U.forages;M.close();for(var ae=0;ae<Y.length;ae++){var ge=Y[ae];ge._dbInfo.db=null,ge._dbInfo.version=R}var ke=new w(function(xe,De){var _e=j.open(t.name,R);_e.onerror=function(qe){var St=_e.result;St.close(),De(qe)},_e.onupgradeneeded=function(){var qe=_e.result;qe.deleteObjectStore(t.storeName)},_e.onsuccess=function(){var qe=_e.result;qe.close(),xe(qe)}});return ke.then(function(xe){U.db=xe;for(var De=0;De<Y.length;De++){var _e=Y[De];_e._dbInfo.db=xe,he(_e._dbInfo)}}).catch(function(xe){throw(Ce(t,xe)||w.resolve()).catch(function(){}),xe})}}):f=x.then(function(M){b(t);var R=pe[t.name],U=R.forages;M.close();for(var Y=0;Y<U.length;Y++){var ae=U[Y];ae._dbInfo.db=null}var ge=new w(function(ke,xe){var De=j.deleteDatabase(t.name);De.onerror=function(){var _e=De.result;_e&&_e.close(),xe(De.error)},De.onblocked=function(){console.warn('dropInstance blocked for database "'+t.name+'" until all open connections are closed')},De.onsuccess=function(){var _e=De.result;_e&&_e.close(),ke(_e)}});return ge.then(function(ke){R.db=ke;for(var xe=0;xe<U.length;xe++){var De=U[xe];he(De._dbInfo)}}).catch(function(ke){throw(Ce(t,ke)||w.resolve()).catch(function(){}),ke})})}return S(f,c),f}var Ve={_driver:"asyncStorage",_initStorage:re,_support:E(),iterate:Pe,getItem:je,setItem:k,removeItem:X,clear:se,length:le,key:be,keys:ne,dropInstance:Te};function Be(){return typeof openDatabase=="function"}var $e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",st="~~local_forage_type~",Ge=/^~~local_forage_type~([^~]+)~/,Ae="__lfsc__:",at=Ae.length,Je="arbf",ot="blob",ct="si08",lt="ui08",p="uic8",a="si16",A="si32",V="ur16",h="ui32",d="fl32",D="fl64",G=at+Je.length,C=Object.prototype.toString;function $(t){var c=t.length*.75,r=t.length,u,f=0,l,x,M,R;t[t.length-1]==="="&&(c--,t[t.length-2]==="="&&c--);var U=new ArrayBuffer(c),Y=new Uint8Array(U);for(u=0;u<r;u+=4)l=$e.indexOf(t[u]),x=$e.indexOf(t[u+1]),M=$e.indexOf(t[u+2]),R=$e.indexOf(t[u+3]),Y[f++]=l<<2|x>>4,Y[f++]=(x&15)<<4|M>>2,Y[f++]=(M&3)<<6|R&63;return U}function L(t){var c=new Uint8Array(t),r="",u;for(u=0;u<c.length;u+=3)r+=$e[c[u]>>2],r+=$e[(c[u]&3)<<4|c[u+1]>>4],r+=$e[(c[u+1]&15)<<2|c[u+2]>>6],r+=$e[c[u+2]&63];return c.length%3===2?r=r.substring(0,r.length-1)+"=":c.length%3===1&&(r=r.substring(0,r.length-2)+"=="),r}function W(t,c){var r="";if(t&&(r=C.call(t)),t&&(r==="[object ArrayBuffer]"||t.buffer&&C.call(t.buffer)==="[object ArrayBuffer]")){var u,f=Ae;t instanceof ArrayBuffer?(u=t,f+=Je):(u=t.buffer,r==="[object Int8Array]"?f+=ct:r==="[object Uint8Array]"?f+=lt:r==="[object Uint8ClampedArray]"?f+=p:r==="[object Int16Array]"?f+=a:r==="[object Uint16Array]"?f+=V:r==="[object Int32Array]"?f+=A:r==="[object Uint32Array]"?f+=h:r==="[object Float32Array]"?f+=d:r==="[object Float64Array]"?f+=D:c(new Error("Failed to get type for BinaryArray"))),c(f+L(u))}else if(r==="[object Blob]"){var l=new FileReader;l.onload=function(){var x=st+t.type+"~"+L(this.result);c(Ae+ot+x)},l.readAsArrayBuffer(t)}else try{c(JSON.stringify(t))}catch(x){console.error("Couldn't convert value into a JSON string: ",t),c(null,x)}}function _(t){if(t.substring(0,at)!==Ae)return JSON.parse(t);var c=t.substring(G),r=t.substring(at,G),u;if(r===ot&&Ge.test(c)){var f=c.match(Ge);u=f[1],c=c.substring(f[0].length)}var l=$(c);switch(r){case Je:return l;case ot:return F([l],{type:u});case ct:return new Int8Array(l);case lt:return new Uint8Array(l);case p:return new Uint8ClampedArray(l);case a:return new Int16Array(l);case V:return new Uint16Array(l);case A:return new Int32Array(l);case h:return new Uint32Array(l);case d:return new Float32Array(l);case D:return new Float64Array(l);default:throw new Error("Unkown type: "+r)}}var oe={serialize:W,deserialize:_,stringToBuffer:$,bufferToString:L};function P(t,c,r,u){t.executeSql("CREATE TABLE IF NOT EXISTS "+c.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],r,u)}function N(t){var c=this,r={db:null};if(t)for(var u in t)r[u]=typeof t[u]!="string"?t[u].toString():t[u];var f=new w(function(l,x){try{r.db=openDatabase(r.name,String(r.version),r.description,r.size)}catch(M){return x(M)}r.db.transaction(function(M){P(M,r,function(){c._dbInfo=r,l()},function(R,U){x(U)})},x)});return r.serializer=oe,f}function y(t,c,r,u,f,l){t.executeSql(r,u,f,function(x,M){M.code===M.SYNTAX_ERR?x.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[c.storeName],function(R,U){U.rows.length?l(R,M):P(R,c,function(){R.executeSql(r,u,f,l)},l)},l):l(x,M)},l)}function ye(t,c){var r=this;t=ue(t);var u=new w(function(f,l){r.ready().then(function(){var x=r._dbInfo;x.db.transaction(function(M){y(M,x,"SELECT * FROM "+x.storeName+" WHERE key = ? LIMIT 1",[t],function(R,U){var Y=U.rows.length?U.rows.item(0).value:null;Y&&(Y=x.serializer.deserialize(Y)),f(Y)},function(R,U){l(U)})})}).catch(l)});return S(u,c),u}function Ee(t,c){var r=this,u=new w(function(f,l){r.ready().then(function(){var x=r._dbInfo;x.db.transaction(function(M){y(M,x,"SELECT * FROM "+x.storeName,[],function(R,U){for(var Y=U.rows,ae=Y.length,ge=0;ge<ae;ge++){var ke=Y.item(ge),xe=ke.value;if(xe&&(xe=x.serializer.deserialize(xe)),xe=t(xe,ke.key,ge+1),xe!==void 0){f(xe);return}}f()},function(R,U){l(U)})})}).catch(l)});return S(u,c),u}function Le(t,c,r,u){var f=this;t=ue(t);var l=new w(function(x,M){f.ready().then(function(){c===void 0&&(c=null);var R=c,U=f._dbInfo;U.serializer.serialize(c,function(Y,ae){ae?M(ae):U.db.transaction(function(ge){y(ge,U,"INSERT OR REPLACE INTO "+U.storeName+" (key, value) VALUES (?, ?)",[t,Y],function(){x(R)},function(ke,xe){M(xe)})},function(ge){if(ge.code===ge.QUOTA_ERR){if(u>0){x(Le.apply(f,[t,R,r,u-1]));return}M(ge)}})})}).catch(M)});return S(l,r),l}function Qe(t,c,r){return Le.apply(this,[t,c,r,1])}function Ke(t,c){var r=this;t=ue(t);var u=new w(function(f,l){r.ready().then(function(){var x=r._dbInfo;x.db.transaction(function(M){y(M,x,"DELETE FROM "+x.storeName+" WHERE key = ?",[t],function(){f()},function(R,U){l(U)})})}).catch(l)});return S(u,c),u}function tt(t){var c=this,r=new w(function(u,f){c.ready().then(function(){var l=c._dbInfo;l.db.transaction(function(x){y(x,l,"DELETE FROM "+l.storeName,[],function(){u()},function(M,R){f(R)})})}).catch(f)});return S(r,t),r}function Xe(t){var c=this,r=new w(function(u,f){c.ready().then(function(){var l=c._dbInfo;l.db.transaction(function(x){y(x,l,"SELECT COUNT(key) as c FROM "+l.storeName,[],function(M,R){var U=R.rows.item(0).c;u(U)},function(M,R){f(R)})})}).catch(f)});return S(r,t),r}function Re(t,c){var r=this,u=new w(function(f,l){r.ready().then(function(){var x=r._dbInfo;x.db.transaction(function(M){y(M,x,"SELECT key FROM "+x.storeName+" WHERE id = ? LIMIT 1",[t+1],function(R,U){var Y=U.rows.length?U.rows.item(0).key:null;f(Y)},function(R,U){l(U)})})}).catch(l)});return S(u,c),u}function Pt(t){var c=this,r=new w(function(u,f){c.ready().then(function(){var l=c._dbInfo;l.db.transaction(function(x){y(x,l,"SELECT key FROM "+l.storeName,[],function(M,R){for(var U=[],Y=0;Y<R.rows.length;Y++)U.push(R.rows.item(Y).key);u(U)},function(M,R){f(R)})})}).catch(f)});return S(r,t),r}function bt(t){return new w(function(c,r){t.transaction(function(u){u.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(f,l){for(var x=[],M=0;M<l.rows.length;M++)x.push(l.rows.item(M).name);c({db:t,storeNames:x})},function(f,l){r(l)})},function(u){r(u)})})}function Me(t,c){c=ve.apply(this,arguments);var r=this.config();t=typeof t!="function"&&t||{},t.name||(t.name=t.name||r.name,t.storeName=t.storeName||r.storeName);var u=this,f;return t.name?f=new w(function(l){var x;t.name===r.name?x=u._dbInfo.db:x=openDatabase(t.name,"","",0),t.storeName?l({db:x,storeNames:[t.storeName]}):l(bt(x))}).then(function(l){return new w(function(x,M){l.db.transaction(function(R){function U(ke){return new w(function(xe,De){R.executeSql("DROP TABLE IF EXISTS "+ke,[],function(){xe()},function(_e,qe){De(qe)})})}for(var Y=[],ae=0,ge=l.storeNames.length;ae<ge;ae++)Y.push(U(l.storeNames[ae]));w.all(Y).then(function(){x()}).catch(function(ke){M(ke)})},function(R){M(R)})})}):f=w.reject("Invalid arguments"),S(f,c),f}var ft={_driver:"webSQLStorage",_initStorage:N,_support:Be(),iterate:Ee,getItem:ye,setItem:Qe,removeItem:Ke,clear:tt,length:Xe,key:Re,keys:Pt,dropInstance:Me};function Bt(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function ht(t,c){var r=t.name+"/";return t.storeName!==c.storeName&&(r+=t.storeName+"/"),r}function ze(){var t="_localforage_support_test";try{return localStorage.setItem(t,!0),localStorage.removeItem(t),!1}catch{return!0}}function xt(){return!ze()||localStorage.length>0}function de(t){var c=this,r={};if(t)for(var u in t)r[u]=t[u];return r.keyPrefix=ht(t,c._defaultConfig),xt()?(c._dbInfo=r,r.serializer=oe,w.resolve()):w.reject()}function Fe(t){var c=this,r=c.ready().then(function(){for(var u=c._dbInfo.keyPrefix,f=localStorage.length-1;f>=0;f--){var l=localStorage.key(f);l.indexOf(u)===0&&localStorage.removeItem(l)}});return S(r,t),r}function Ye(t,c){var r=this;t=ue(t);var u=r.ready().then(function(){var f=r._dbInfo,l=localStorage.getItem(f.keyPrefix+t);return l&&(l=f.serializer.deserialize(l)),l});return S(u,c),u}function Ie(t,c){var r=this,u=r.ready().then(function(){for(var f=r._dbInfo,l=f.keyPrefix,x=l.length,M=localStorage.length,R=1,U=0;U<M;U++){var Y=localStorage.key(U);if(Y.indexOf(l)===0){var ae=localStorage.getItem(Y);if(ae&&(ae=f.serializer.deserialize(ae)),ae=t(ae,Y.substring(x),R++),ae!==void 0)return ae}}});return S(u,c),u}function Ue(t,c){var r=this,u=r.ready().then(function(){var f=r._dbInfo,l;try{l=localStorage.key(t)}catch{l=null}return l&&(l=l.substring(f.keyPrefix.length)),l});return S(u,c),u}function Ze(t){var c=this,r=c.ready().then(function(){for(var u=c._dbInfo,f=localStorage.length,l=[],x=0;x<f;x++){var M=localStorage.key(x);M.indexOf(u.keyPrefix)===0&&l.push(M.substring(u.keyPrefix.length))}return l});return S(r,t),r}function it(t){var c=this,r=c.keys().then(function(u){return u.length});return S(r,t),r}function mt(t,c){var r=this;t=ue(t);var u=r.ready().then(function(){var f=r._dbInfo;localStorage.removeItem(f.keyPrefix+t)});return S(u,c),u}function Yn(t,c,r){var u=this;t=ue(t);var f=u.ready().then(function(){c===void 0&&(c=null);var l=c;return new w(function(x,M){var R=u._dbInfo;R.serializer.serialize(c,function(U,Y){if(Y)M(Y);else try{localStorage.setItem(R.keyPrefix+t,U),x(l)}catch(ae){(ae.name==="QuotaExceededError"||ae.name==="NS_ERROR_DOM_QUOTA_REACHED")&&M(ae),M(ae)}})})});return S(f,r),f}function qn(t,c){if(c=ve.apply(this,arguments),t=typeof t!="function"&&t||{},!t.name){var r=this.config();t.name=t.name||r.name,t.storeName=t.storeName||r.storeName}var u=this,f;return t.name?f=new w(function(l){t.storeName?l(ht(t,u._defaultConfig)):l(t.name+"/")}).then(function(l){for(var x=localStorage.length-1;x>=0;x--){var M=localStorage.key(x);M.indexOf(l)===0&&localStorage.removeItem(M)}}):f=w.reject("Invalid arguments"),S(f,c),f}var Hn={_driver:"localStorageWrapper",_initStorage:de,_support:Bt(),iterate:Ie,getItem:Ye,setItem:Yn,removeItem:mt,clear:Fe,length:it,key:Ue,keys:Ze,dropInstance:qn},Gn=function(c,r){return c===r||typeof c=="number"&&typeof r=="number"&&isNaN(c)&&isNaN(r)},Kn=function(c,r){for(var u=c.length,f=0;f<u;){if(Gn(c[f],r))return!0;f++}return!1},un=Array.isArray||function(t){return Object.prototype.toString.call(t)==="[object Array]"},Et={},dn={},pt={INDEXEDDB:Ve,WEBSQL:ft,LOCALSTORAGE:Hn},Xn=[pt.INDEXEDDB._driver,pt.WEBSQL._driver,pt.LOCALSTORAGE._driver],Ct=["dropInstance"],Rt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(Ct),Jn={description:"",driver:Xn.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Qn(t,c){t[c]=function(){var r=arguments;return t.ready().then(function(){return t[c].apply(t,r)})}}function Ut(){for(var t=1;t<arguments.length;t++){var c=arguments[t];if(c)for(var r in c)c.hasOwnProperty(r)&&(un(c[r])?arguments[0][r]=c[r].slice():arguments[0][r]=c[r])}return arguments[0]}var Zn=function(){function t(c){v(this,t);for(var r in pt)if(pt.hasOwnProperty(r)){var u=pt[r],f=u._driver;this[r]=f,Et[f]||this.defineDriver(u)}this._defaultConfig=Ut({},Jn),this._config=Ut({},this._defaultConfig,c),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return t.prototype.config=function(r){if((typeof r>"u"?"undefined":o(r))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var u in r){if(u==="storeName"&&(r[u]=r[u].replace(/\W/g,"_")),u==="version"&&typeof r[u]!="number")return new Error("Database version must be a number.");this._config[u]=r[u]}return"driver"in r&&r.driver?this.setDriver(this._config.driver):!0}else return typeof r=="string"?this._config[r]:this._config},t.prototype.defineDriver=function(r,u,f){var l=new w(function(x,M){try{var R=r._driver,U=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!r._driver){M(U);return}for(var Y=Rt.concat("_initStorage"),ae=0,ge=Y.length;ae<ge;ae++){var ke=Y[ae],xe=!Kn(Ct,ke);if((xe||r[ke])&&typeof r[ke]!="function"){M(U);return}}var De=function(){for(var St=function(nr){return function(){var rr=new Error("Method "+nr+" is not implemented by the current driver"),fn=w.reject(rr);return S(fn,arguments[arguments.length-1]),fn}},$t=0,tr=Ct.length;$t<tr;$t++){var Ft=Ct[$t];r[Ft]||(r[Ft]=St(Ft))}};De();var _e=function(St){Et[R]&&console.info("Redefining LocalForage driver: "+R),Et[R]=r,dn[R]=St,x()};"_support"in r?r._support&&typeof r._support=="function"?r._support().then(_e,M):_e(!!r._support):_e(!0)}catch(qe){M(qe)}});return B(l,u,f),l},t.prototype.driver=function(){return this._driver||null},t.prototype.getDriver=function(r,u,f){var l=Et[r]?w.resolve(Et[r]):w.reject(new Error("Driver not found."));return B(l,u,f),l},t.prototype.getSerializer=function(r){var u=w.resolve(oe);return B(u,r),u},t.prototype.ready=function(r){var u=this,f=u._driverSet.then(function(){return u._ready===null&&(u._ready=u._initDriver()),u._ready});return B(f,r,r),f},t.prototype.setDriver=function(r,u,f){var l=this;un(r)||(r=[r]);var x=this._getSupportedDrivers(r);function M(){l._config.driver=l.driver()}function R(ae){return l._extend(ae),M(),l._ready=l._initStorage(l._config),l._ready}function U(ae){return function(){var ge=0;function ke(){for(;ge<ae.length;){var xe=ae[ge];return ge++,l._dbInfo=null,l._ready=null,l.getDriver(xe).then(R).catch(ke)}M();var De=new Error("No available storage method found.");return l._driverSet=w.reject(De),l._driverSet}return ke()}}var Y=this._driverSet!==null?this._driverSet.catch(function(){return w.resolve()}):w.resolve();return this._driverSet=Y.then(function(){var ae=x[0];return l._dbInfo=null,l._ready=null,l.getDriver(ae).then(function(ge){l._driver=ge._driver,M(),l._wrapLibraryMethodsWithReady(),l._initDriver=U(x)})}).catch(function(){M();var ae=new Error("No available storage method found.");return l._driverSet=w.reject(ae),l._driverSet}),B(this._driverSet,u,f),this._driverSet},t.prototype.supports=function(r){return!!dn[r]},t.prototype._extend=function(r){Ut(this,r)},t.prototype._getSupportedDrivers=function(r){for(var u=[],f=0,l=r.length;f<l;f++){var x=r[f];this.supports(x)&&u.push(x)}return u},t.prototype._wrapLibraryMethodsWithReady=function(){for(var r=0,u=Rt.length;r<u;r++)Qn(this,Rt[r])},t.prototype.createInstance=function(r){return new t(r)},t}(),er=new Zn;s.exports=er},{3:3}]},{},[4])(4)})})(xn);var ir=xn.exports;const Wt=or(ir);function At(n){if(typeof n!="string"||!n)throw new Error("expected a non-empty string, got: "+n)}function Vt(n){if(typeof n!="number")throw new Error("expected a number, got: "+n)}const sr=1,cr=1,dt="emoji",gt="keyvalue",rn="favorites",lr="tokens",Cn="tokens",ur="unicode",In="count",dr="group",fr="order",An="group-order",Jt="eTag",Mt="url",pn="skinTone",yt="readonly",an="readwrite",_n="skinUnicodes",hr="skinUnicodes",mr="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",pr="en";function vr(n,e){const i=new Set,s=[];for(const m of n){const o=e(m);i.has(o)||(i.add(o),s.push(m))}return s}function vn(n){return vr(n,e=>e.unicode)}function gr(n){function e(i,s,m){const o=s?n.createObjectStore(i,{keyPath:s}):n.createObjectStore(i);if(m)for(const[v,[g,j]]of Object.entries(m))o.createIndex(v,g,{multiEntry:j});return o}e(gt),e(dt,ur,{[Cn]:[lr,!0],[An]:[[dr,fr]],[_n]:[hr,!0]}),e(rn,void 0,{[In]:[""]})}const Qt={},Nt={},Ot={};function Dn(n,e,i){i.onerror=()=>e(i.error),i.onblocked=()=>e(new Error("IDB blocked")),i.onsuccess=()=>n(i.result)}async function yr(n){const e=await new Promise((i,s)=>{const m=indexedDB.open(n,sr);Qt[n]=m,m.onupgradeneeded=o=>{o.oldVersion<cr&&gr(m.result)},Dn(i,s,m)});return e.onclose=()=>on(n),e}function br(n){return Nt[n]||(Nt[n]=yr(n)),Nt[n]}function rt(n,e,i,s){return new Promise((m,o)=>{const v=n.transaction(e,i,{durability:"relaxed"}),g=typeof e=="string"?v.objectStore(e):e.map(E=>v.objectStore(E));let j;s(g,v,E=>{j=E}),v.oncomplete=()=>m(j),v.onerror=()=>o(v.error)})}function on(n){const e=Qt[n],i=e&&e.result;if(i){i.close();const s=Ot[n];if(s)for(const m of s)m()}delete Qt[n],delete Nt[n],delete Ot[n]}function Er(n){return new Promise((e,i)=>{on(n);const s=indexedDB.deleteDatabase(n);Dn(e,i,s)})}function Sr(n,e){let i=Ot[n];i||(i=Ot[n]=[]),i.push(e)}const wr=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function vt(n){return n.split(/[\s_]+/).map(e=>!e.match(/\w/)||wr.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/‚Äô/g,"'").toLowerCase()).filter(Boolean)}const Tr=2;function Nn(n){return n.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=Tr)}function kr(n){return n.map(({annotation:i,emoticon:s,group:m,order:o,shortcodes:v,skins:g,tags:j,emoji:E,version:F})=>{const w=[...new Set(Nn([...(v||[]).map(vt).flat(),...j.map(vt).flat(),...vt(i),s]))].sort(),S={annotation:i,group:m,order:o,tags:j,tokens:w,unicode:E,version:F};if(s&&(S.emoticon=s),v&&(S.shortcodes=v),g){S.skinTones=[],S.skinUnicodes=[],S.skinVersions=[];for(const{tone:B,emoji:ue,version:ve}of g)S.skinTones.push(B),S.skinUnicodes.push(ue),S.skinVersions.push(ve)}return S})}function Ln(n,e,i,s){n[e](i).onsuccess=m=>s&&s(m.target.result)}function ut(n,e,i){Ln(n,"get",e,i)}function Mn(n,e,i){Ln(n,"getAll",e,i)}function sn(n){n.commit&&n.commit()}function xr(n,e){let i=n[0];for(let s=1;s<n.length;s++){const m=n[s];e(i)>e(m)&&(i=m)}return i}function On(n,e){const i=xr(n,m=>m.length),s=[];for(const m of i)n.some(o=>o.findIndex(v=>e(v)===e(m))===-1)||s.push(m);return s}async function Cr(n){return!await cn(n,gt,Mt)}async function Ir(n,e,i){const[s,m]=await Promise.all([Jt,Mt].map(o=>cn(n,gt,o)));return s===i&&m===e}async function Ar(n,e){return rt(n,dt,yt,(s,m,o)=>{let v;const g=()=>{s.getAll(v&&IDBKeyRange.lowerBound(v,!0),50).onsuccess=j=>{const E=j.target.result;for(const F of E)if(v=F.unicode,e(F))return o(F);if(E.length<50)return o();g()}};g()})}async function jn(n,e,i,s){try{const m=kr(e);await rt(n,[dt,gt],an,([o,v],g)=>{let j,E,F=0;function w(){++F===2&&S()}function S(){if(!(j===s&&E===i)){o.clear();for(const B of m)o.put(B);v.put(s,Jt),v.put(i,Mt),sn(g)}}ut(v,Jt,B=>{j=B,w()}),ut(v,Mt,B=>{E=B,w()})})}finally{}}async function _r(n,e){return rt(n,dt,yt,(i,s,m)=>{const o=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);Mn(i.index(An),o,m)})}async function Pn(n,e){const i=Nn(vt(e));return i.length?rt(n,dt,yt,(s,m,o)=>{const v=[],g=()=>{v.length===i.length&&j()},j=()=>{const E=On(v,F=>F.unicode);o(E.sort((F,w)=>F.order<w.order?-1:1))};for(let E=0;E<i.length;E++){const F=i[E],w=E===i.length-1?IDBKeyRange.bound(F,F+"Ôøø",!1,!0):IDBKeyRange.only(F);Mn(s.index(Cn),w,S=>{v.push(S),g()})}}):[]}async function Dr(n,e){const i=await Pn(n,e);return i.length?i.filter(s=>(s.shortcodes||[]).map(o=>o.toLowerCase()).includes(e.toLowerCase()))[0]||null:await Ar(n,m=>(m.shortcodes||[]).includes(e.toLowerCase()))||null}async function Nr(n,e){return rt(n,dt,yt,(i,s,m)=>ut(i,e,o=>{if(o)return m(o);ut(i.index(_n),e,v=>m(v||null))}))}function cn(n,e,i){return rt(n,e,yt,(s,m,o)=>ut(s,i,o))}function Lr(n,e,i,s){return rt(n,e,an,(m,o)=>{m.put(s,i),sn(o)})}function Mr(n,e){return rt(n,rn,an,(i,s)=>ut(i,e,m=>{i.put((m||0)+1,e),sn(s)}))}function Or(n,e,i){return i===0?[]:rt(n,[rn,dt],yt,([s,m],o,v)=>{const g=[];s.index(In).openCursor(void 0,"prev").onsuccess=j=>{const E=j.target.result;if(!E)return v(g);function F(B){if(g.push(B),g.length===i)return v(g);E.continue()}const w=E.primaryKey,S=e.byName(w);if(S)return F(S);ut(m,w,B=>{if(B)return F(B);E.continue()})}})}const _t="";function jr(n,e){const i=new Map;for(const m of n){const o=e(m);for(const v of o){let g=i;for(let E=0;E<v.length;E++){const F=v.charAt(E);let w=g.get(F);w||(w=new Map,g.set(F,w)),g=w}let j=g.get(_t);j||(j=[],g.set(_t,j)),j.push(m)}}return(m,o)=>{let v=i;for(let E=0;E<m.length;E++){const F=m.charAt(E),w=v.get(F);if(w)v=w;else return[]}if(o)return v.get(_t)||[];const g=[],j=[v];for(;j.length;){const F=[...j.shift().entries()].sort((w,S)=>w[0]<S[0]?-1:1);for(const[w,S]of F)w===_t?g.push(...S):j.push(S)}return g}}const Pr=["name","url"];function Br(n){const e=n&&Array.isArray(n),i=e&&n.length&&(!n[0]||Pr.some(s=>!(s in n[0])));if(!e||i)throw new Error("Custom emojis are in the wrong format")}function gn(n){Br(n);const e=(S,B)=>S.name.toLowerCase()<B.name.toLowerCase()?-1:1,i=n.sort(e),m=jr(n,S=>[...new Set((S.shortcodes||[]).map(B=>vt(B)).flat())]),o=S=>m(S,!0),v=S=>m(S,!1),g=S=>{const B=vt(S),ue=B.map((ve,ee)=>(ee<B.length-1?o:v)(ve));return On(ue,ve=>ve.name).sort(e)},j=new Map,E=new Map;for(const S of n){E.set(S.name.toLowerCase(),S);for(const B of S.shortcodes||[])j.set(B.toLowerCase(),S)}return{all:i,search:g,byShortcode:S=>j.get(S.toLowerCase()),byName:S=>E.get(S.toLowerCase())}}const Rr=typeof wrappedJSObject<"u";function wt(n){if(!n)return n;if(Rr&&(n=structuredClone(n)),delete n.tokens,n.skinTones){const e=n.skinTones.length;n.skins=Array(e);for(let i=0;i<e;i++)n.skins[i]={tone:n.skinTones[i],unicode:n.skinUnicodes[i],version:n.skinVersions[i]};delete n.skinTones,delete n.skinUnicodes,delete n.skinVersions}return n}function Bn(n){n||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const Ur=["annotation","emoji","group","order","tags","version"];function $r(n){if(!n||!Array.isArray(n)||!n[0]||typeof n[0]!="object"||Ur.some(e=>!(e in n[0])))throw new Error("Emoji data is in the wrong format")}function Rn(n,e){if(Math.floor(n.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+n.status)}async function Fr(n){const e=await fetch(n,{method:"HEAD"});Rn(e,n);const i=e.headers.get("etag");return Bn(i),i}async function Zt(n){const e=await fetch(n);Rn(e,n);const i=e.headers.get("etag");Bn(i);const s=await e.json();return $r(s),[i,s]}function Wr(n){for(var e="",i=new Uint8Array(n),s=i.byteLength,m=-1;++m<s;)e+=String.fromCharCode(i[m]);return e}function Vr(n){for(var e=n.length,i=new ArrayBuffer(e),s=new Uint8Array(i),m=-1;++m<e;)s[m]=n.charCodeAt(m);return i}async function Un(n){const e=JSON.stringify(n);let i=Vr(e);const s=await crypto.subtle.digest("SHA-1",i),m=Wr(s);return btoa(m)}async function zr(n,e){let i,s=await Fr(e);if(!s){const m=await Zt(e);s=m[0],i=m[1],s||(s=await Un(i))}await Ir(n,e,s)||(i||(i=(await Zt(e))[1]),await jn(n,i,e,s))}async function Yr(n,e){let[i,s]=await Zt(e);i||(i=await Un(s)),await jn(n,s,e,i)}class qr{constructor({dataSource:e=mr,locale:i=pr,customEmoji:s=[]}={}){this.dataSource=e,this.locale=i,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=gn(s),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await br(this._dbName);Sr(this._dbName,this._clear);const i=this.dataSource;await Cr(e)?await Yr(e,i):this._lazyUpdate=zr(e,i)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return Vt(e),await this.ready(),vn(await _r(this._db,e)).map(wt)}async getEmojiBySearchQuery(e){At(e),await this.ready();const i=this._custom.search(e),s=vn(await Pn(this._db,e)).map(wt);return[...i,...s]}async getEmojiByShortcode(e){At(e),await this.ready();const i=this._custom.byShortcode(e);return i||wt(await Dr(this._db,e))}async getEmojiByUnicodeOrName(e){At(e),await this.ready();const i=this._custom.byName(e);return i||wt(await Nr(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await cn(this._db,gt,pn)||0}async setPreferredSkinTone(e){return Vt(e),await this.ready(),Lr(this._db,gt,pn,e)}async incrementFavoriteEmojiCount(e){return At(e),await this.ready(),Mr(this._db,e)}async getTopFavoriteEmoji(e){return Vt(e),await this.ready(),(await Or(this._db,this._custom,e)).map(wt)}set customEmoji(e){this._custom=gn(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await on(this._dbName)}async delete(){await this._shutdown(),await Er(this._dbName)}}const en=[[-1,"‚ú®","custom"],[0,"üòÄ","smileys-emotion"],[1,"üëã","people-body"],[3,"üê±","animals-nature"],[4,"üçé","food-drink"],[5,"üè†Ô∏è","travel-places"],[6,"‚öΩ","activities"],[7,"üìù","objects"],[8,"‚õîÔ∏è","symbols"],[9,"üèÅ","flags"]].map(([n,e,i])=>({id:n,emoji:e,name:i})),zt=en.slice(1),Hr=2,yn=6,$n=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function bn(n){return n.unicode.includes("‚Äç")}const Gr={"ü´®":15.1,"ü´†":14,"ü•≤":13.1,"ü•ª":12.1,"ü•∞":11,"ü§©":5,"üë±‚Äç‚ôÄÔ∏è":4,"ü§£":3,"üëÅÔ∏è‚Äçüó®Ô∏è":2,"üòÄ":1,"üòêÔ∏è":.7,"üòÉ":.6},Kr=1e3,Xr="üñêÔ∏è",Jr=8,Qr=["üòä","üòí","‚ù§Ô∏è","üëçÔ∏è","üòç","üòÇ","üò≠","‚ò∫Ô∏è","üòî","üò©","üòè","üíï","üôå","üòò"],Fn='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',Zr=(n,e)=>n<e?-1:n>e?1:0,En=(n,e)=>{const i=document.createElement("canvas");i.width=i.height=1;const s=i.getContext("2d");return s.textBaseline="top",s.font=`100px ${Fn}`,s.fillStyle=e,s.scale(.01,.01),s.fillText(n,0,0),s.getImageData(0,0,1,1).data},ea=(n,e)=>{const i=[...n].join(","),s=[...e].join(",");return i===s&&!i.startsWith("0,0,0,")};function ta(n){const e=En(n,"#000"),i=En(n,"#fff");return e&&i&&ea(e,i)}function na(){const n=Object.entries(Gr);try{for(const[e,i]of n)if(ta(e))return i}catch{}finally{}return n[0][1]}let Yt;const qt=()=>(Yt||(Yt=new Promise(n=>$n(()=>n(na())))),Yt),tn=new Map,ra="Ô∏è",aa="\uD83C",oa="‚Äç",ia=127995,sa=57339;function ca(n,e){if(e===0)return n;const i=n.indexOf(oa);return i!==-1?n.substring(0,i)+String.fromCodePoint(ia+e-1)+n.substring(i):(n.endsWith(ra)&&(n=n.substring(0,n.length-1)),n+aa+String.fromCodePoint(sa+e-1))}function et(n){n.preventDefault(),n.stopPropagation()}function Ht(n,e,i){return e+=n?-1:1,e<0?e=i.length-1:e>=i.length&&(e=0),e}function Wn(n,e){const i=new Set,s=[];for(const m of n){const o=e(m);i.has(o)||(i.add(o),s.push(m))}return s}function la(n,e){const i=s=>{const m={};for(const o of s)typeof o.tone=="number"&&o.version<=e&&(m[o.tone]=o.unicode);return m};return n.map(({unicode:s,skins:m,shortcodes:o,url:v,name:g,category:j,annotation:E})=>({unicode:s,name:g,shortcodes:o,url:v,category:j,annotation:E,id:s||g,skins:m&&i(m)}))}const Lt=requestAnimationFrame;let ua=typeof ResizeObserver=="function";function da(n,e,i){let s;ua?(s=new ResizeObserver(m=>i(m[0].contentRect.width)),s.observe(n)):Lt(()=>i(n.getBoundingClientRect().width)),e.addEventListener("abort",()=>{s&&s.disconnect()})}function Sn(n){{const e=document.createRange();return e.selectNode(n.firstChild),e.getBoundingClientRect().width}}let Gt;function fa(n,e,i){for(const s of n){const m=i(s),o=Sn(m);typeof Gt>"u"&&(Gt=Sn(e));const v=o/1.8<Gt;tn.set(s.unicode,v)}}function ha(n){return Wn(n,e=>e)}function ma(n){n&&(n.scrollTop=0)}function kt(n,e,i){let s=n.get(e);return s||(s=i(),n.set(e,s)),s}function wn(n){return""+n}function pa(n){const e=document.createElement("template");return e.innerHTML=n,e}const va=new WeakMap,ga=new WeakMap,ya=Symbol("un-keyed"),ba="replaceChildren"in Element.prototype;function Ea(n,e){ba?n.replaceChildren(...e):(n.innerHTML="",n.append(...e))}function Sa(n,e){let i=n.firstChild,s=0;for(;i;){if(e[s]!==i)return!0;i=i.nextSibling,s++}return s!==e.length}function wa(n,e){const{targetNode:i}=e;let{targetParentNode:s}=e,m=!1;s?m=Sa(s,n):(m=!0,e.targetNode=void 0,e.targetParentNode=s=i.parentNode),m&&Ea(s,n)}function Ta(n,e){for(const i of e){const{targetNode:s,currentExpression:m,binding:{expressionIndex:o,attributeName:v,attributeValuePre:g,attributeValuePost:j}}=i,E=n[o];if(m!==E)if(i.currentExpression=E,v)s.setAttribute(v,g+wn(E)+j);else{let F;Array.isArray(E)?wa(E,i):E instanceof Element?(F=E,s.replaceWith(F)):s.nodeValue=wn(E),F&&(i.targetNode=F)}}}function ka(n){let e="",i=!1,s=!1,m=-1;const o=new Map,v=[];for(let j=0,E=n.length;j<E;j++){const F=n[j];if(e+=F,j===E-1)break;for(let te=0;te<F.length;te++)switch(F.charAt(te)){case"<":{F.charAt(te+1)==="/"?v.pop():(i=!0,v.push(++m));break}case">":{i=!1,s=!1;break}case"=":{s=!0;break}}const w=v[v.length-1],S=kt(o,w,()=>[]);let B,ue,ve;if(s){const te=/(\S+)="?([^"=]*)$/.exec(F);B=te[1],ue=te[2],ve=/^[^">]*/.exec(n[j+1])[0]}const ee={attributeName:B,attributeValuePre:ue,attributeValuePost:ve,expressionIndex:j};S.push(ee),!i&&!s&&(e+=" ")}return{template:pa(e),elementsToBindings:o}}function xa(n,e){const i=[],s=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT);let m=n,o=-1;do{const v=e.get(++o);if(v)for(let g=0;g<v.length;g++){const j=v[g],E=j.attributeName?m:m.firstChild,F={binding:j,targetNode:E,targetParentNode:void 0,currentExpression:void 0};i.push(F)}}while(m=s.nextNode());return i}function Ca(n){const{template:e,elementsToBindings:i}=kt(va,n,()=>ka(n)),s=e.cloneNode(!0).content.firstElementChild,m=xa(s,i);return function(v){return Ta(v,m),s}}function Ia(n){const e=kt(ga,n,()=>new Map);let i=ya;function s(o,...v){const g=kt(e,o,()=>new Map);return kt(g,i,()=>Ca(o))(v)}function m(o,v,g){return o.map((j,E)=>{const F=i;i=g(j);try{return v(j,E)}finally{i=F}})}return{map:m,html:s}}function Aa(n,e,i,s,m,o,v,g){const{labelWithSkin:j,titleForEmoji:E,unicodeWithSkin:F}=i,{html:w,map:S}=Ia(e);function B(ee,te,pe){return S(ee,(z,J)=>w`<button role="${te?"option":"menuitem"}" aria-selected="${e.searchMode?J===e.activeSearchItem:""}" aria-label="${j(z,e.currentSkinTone)}" title="${E(z)}" class="emoji ${te&&J===e.activeSearchItem?"active":""}" id="${`${pe}-${z.id}`}">${z.unicode?F(z,e.currentSkinTone):w`<img class="custom-emoji" src="${z.url}" alt="" loading="lazy">`}</button>`,z=>`${pe}-${z.id}`)}const ve=w`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:""}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${S(e.skinTones,(ee,te)=>w`<div id="skintone-${te}" class="emoji ${te===e.activeSkinTone?"active":""}" aria-selected="${te===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[te]}" aria-label="${e.i18n.skinTones[te]}">${ee}</div>`,ee=>ee)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${S(e.groups,ee=>w`<button role="tab" class="nav-button" aria-controls="tab-${ee.id}" aria-label="${e.i18n.categories[ee.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===ee.id}" title="${e.i18n.categories[ee.name]}" data-group-id="${ee.id}"><div class="nav-emoji emoji">${ee.emoji}</div></button>`,ee=>ee.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?"":`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${S(e.currentEmojisWithCategories,(ee,te)=>w`<div><div id="menu-label-${te}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:ee.category?ee.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${te}" id="${e.searchMode?"search-results":""}">${B(ee.emojis,e.searchMode,"emo")}</div></div>`,ee=>ee.category)}</div></div><div class="favorites emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" style="padding-inline-end:${`${e.scrollbarWidth}px`}" data-on-click="onEmojiClick">${B(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">üòÄ</button></section>`;if(g){n.appendChild(ve);const ee=(te,pe)=>{for(const z of n.querySelectorAll(`[${te}]`))pe(z,z.getAttribute(te))};for(const te of["click","focusout","input","keydown","keyup"])ee(`data-on-${te}`,(pe,z)=>{pe.addEventListener(te,s[z])});ee("data-ref",(te,pe)=>{o[pe]=te}),ee("data-action",(te,pe)=>{m[pe](te)}),v.addEventListener("abort",()=>{n.removeChild(ve)})}}const jt=typeof queueMicrotask=="function"?queueMicrotask:n=>Promise.resolve().then(n);function _a(n){let e=!1,i;const s=new Map,m=new Set;let o;const v=()=>{if(e)return;const E=[...m];m.clear();try{for(const F of E)F()}finally{o=!1,m.size&&(o=!0,jt(v))}},g=new Proxy({},{get(E,F){if(i){let w=s.get(F);w||(w=new Set,s.set(F,w)),w.add(i)}return E[F]},set(E,F,w){E[F]=w;const S=s.get(F);if(S){for(const B of S)m.add(B);o||(o=!0,jt(v))}return!0}}),j=E=>{const F=()=>{const w=i;i=F;try{return E()}finally{i=w}};return F()};return n.addEventListener("abort",()=>{e=!0}),{state:g,createEffect:j}}function Kt(n,e,i){if(n.length!==e.length)return!1;for(let s=0;s<n.length;s++)if(!i(n[s],e[s]))return!1;return!0}const Xt=[],{assign:Dt}=Object;function Da(n,e){const i={},s=new AbortController,m=s.signal,{state:o,createEffect:v}=_a(m);Dt(o,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),Dt(o,e),Dt(o,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:Jr,isRtl:!1,scrollbarWidth:0,currentGroupIndex:0,groups:zt,databaseLoaded:!1,activeSearchItemId:void 0}),v(()=>{o.currentGroup!==o.groups[o.currentGroupIndex]&&(o.currentGroup=o.groups[o.currentGroupIndex])});const g=k=>{n.getElementById(k).focus()},j=k=>n.getElementById(`emo-${k.id}`),E=(k,X)=>{i.rootElement.dispatchEvent(new CustomEvent(k,{detail:X,bubbles:!0,composed:!0}))},F=(k,X)=>k.id===X.id,w=(k,X)=>{const{category:se,emojis:le}=k,{category:be,emojis:ne}=X;return se!==be?!1:Kt(le,ne,F)},S=k=>{Kt(o.currentEmojis,k,F)||(o.currentEmojis=k)},B=k=>{o.searchMode!==k&&(o.searchMode=k)},ue=k=>{Kt(o.currentEmojisWithCategories,k,w)||(o.currentEmojisWithCategories=k)},ve=(k,X)=>X&&k.skins&&k.skins[X]||k.unicode,pe={labelWithSkin:(k,X)=>ha([k.name||ve(k,X),k.annotation,...k.shortcodes||Xt].filter(Boolean)).join(", "),titleForEmoji:k=>k.annotation||(k.shortcodes||Xt).join(", "),unicodeWithSkin:ve},z={onClickSkinToneButton:Se,onEmojiClick:ce,onNavClick:T,onNavKeydown:H,onSearchKeydown:O,onSkinToneOptionsClick:fe,onSkinToneOptionsFocusOut:je,onSkinToneOptionsKeydown:we,onSkinToneOptionsKeyup:re,onSearchInput:Pe},J={calculateEmojiGridStyle:K};let I=!0;v(()=>{Aa(n,o,pe,z,J,i,m,I),I=!1}),o.emojiVersion||qt().then(k=>{k||(o.message=o.i18n.emojiUnsupportedMessage)}),v(()=>{async function k(){let X=!1;const se=setTimeout(()=>{X=!0,o.message=o.i18n.loadingMessage},Kr);try{await o.database.ready(),o.databaseLoaded=!0}catch(le){console.error(le),o.message=o.i18n.networkErrorMessage}finally{clearTimeout(se),X&&(X=!1,o.message="")}}o.database&&k()}),v(()=>{o.pickerStyle=`
      --num-groups: ${o.groups.length}; 
      --indicator-opacity: ${o.searchMode?0:1}; 
      --num-skintones: ${yn};`}),v(()=>{o.customEmoji&&o.database&&Z()}),v(()=>{o.customEmoji&&o.customEmoji.length?o.groups!==en&&(o.groups=en):o.groups!==zt&&(o.currentGroupIndex&&o.currentGroupIndex--,o.groups=zt)}),v(()=>{async function k(){o.databaseLoaded&&(o.currentSkinTone=await o.database.getPreferredSkinTone())}k()}),v(()=>{o.skinTones=Array(yn).fill().map((k,X)=>ca(o.skinToneEmoji,X))}),v(()=>{o.skinToneButtonText=o.skinTones[o.currentSkinTone]}),v(()=>{o.skinToneButtonLabel=o.i18n.skinToneLabel.replace("{skinTone}",o.i18n.skinTones[o.currentSkinTone])}),v(()=>{async function k(){const{database:X}=o,se=(await Promise.all(Qr.map(le=>X.getEmojiByUnicodeOrName(le)))).filter(Boolean);o.defaultFavoriteEmojis=se}o.databaseLoaded&&k()});function Z(){o.database.customEmoji=o.customEmoji||Xt}v(()=>{async function k(){Z();const{database:X,defaultFavoriteEmojis:se,numColumns:le}=o,be=await X.getTopFavoriteEmoji(le),ne=await Ce(Wn([...be,...se],Te=>Te.unicode||Te.name).slice(0,le));o.currentFavorites=ne}o.databaseLoaded&&o.defaultFavoriteEmojis&&k()});function K(k){da(k,m,X=>{{const se=getComputedStyle(i.rootElement),le=parseInt(se.getPropertyValue("--num-columns"),10),be=se.getPropertyValue("direction")==="rtl",Te=k.parentElement.getBoundingClientRect().width-X;o.numColumns=le,o.scrollbarWidth=Te,o.isRtl=be}})}v(()=>{async function k(){const{searchText:X,currentGroup:se,databaseLoaded:le,customEmoji:be}=o;if(!le)o.currentEmojis=[],o.searchMode=!1;else if(X.length>=Hr){const ne=await Oe(X);o.searchText===X&&(S(ne),B(!0))}else{const{id:ne}=se;if(ne!==-1||be&&be.length){const Te=await Ne(ne);o.currentGroup.id===ne&&(S(Te),B(!1))}}}k()}),v(()=>{const{currentEmojis:k,emojiVersion:X}=o,se=k.filter(le=>le.unicode).filter(le=>bn(le)&&!tn.has(le.unicode));if(!X&&se.length)S(k),Lt(()=>q(se));else{const le=X?k:k.filter(b);S(le),Lt(()=>ma(i.tabpanelElement))}});function q(k){fa(k,i.baselineEmoji,j),o.currentEmojis=o.currentEmojis}function b(k){return!k.unicode||!bn(k)||tn.get(k.unicode)}async function he(k){const X=o.emojiVersion||await qt();return k.filter(({version:se})=>!se||se<=X)}async function Ce(k){return la(k,o.emojiVersion||await qt())}async function Ne(k){const X=k===-1?o.customEmoji:await o.database.getEmojiByGroup(k);return Ce(await he(X))}async function Oe(k){return Ce(await he(await o.database.getEmojiBySearchQuery(k)))}v(()=>{}),v(()=>{function k(){const{searchMode:se,currentEmojis:le}=o;if(se)return[{category:"",emojis:le}];const be=new Map;for(const ne of le){const Te=ne.category||"";let Ve=be.get(Te);Ve||(Ve=[],be.set(Te,Ve)),Ve.push(ne)}return[...be.entries()].map(([ne,Te])=>({category:ne,emojis:Te})).sort((ne,Te)=>o.customCategorySorting(ne.category,Te.category))}const X=k();ue(X)}),v(()=>{o.activeSearchItemId=o.activeSearchItem!==-1&&o.currentEmojis[o.activeSearchItem].id}),v(()=>{const{rawSearchText:k}=o;$n(()=>{o.searchText=(k||"").trim(),o.activeSearchItem=-1})});function O(k){if(!o.searchMode||!o.currentEmojis.length)return;const X=se=>{et(k),o.activeSearchItem=Ht(se,o.activeSearchItem,o.currentEmojis)};switch(k.key){case"ArrowDown":return X(!1);case"ArrowUp":return X(!0);case"Enter":if(o.activeSearchItem===-1)o.activeSearchItem=0;else return et(k),ie(o.currentEmojis[o.activeSearchItem].id)}}function T(k){const{target:X}=k,se=X.closest(".nav-button");if(!se)return;const le=parseInt(se.dataset.groupId,10);i.searchElement.value="",o.rawSearchText="",o.searchText="",o.activeSearchItem=-1,o.currentGroupIndex=o.groups.findIndex(be=>be.id===le)}function H(k){const{target:X,key:se}=k,le=be=>{be&&(et(k),be.focus())};switch(se){case"ArrowLeft":return le(X.previousElementSibling);case"ArrowRight":return le(X.nextElementSibling);case"Home":return le(X.parentElement.firstElementChild);case"End":return le(X.parentElement.lastElementChild)}}async function ie(k){const X=await o.database.getEmojiByUnicodeOrName(k),se=[...o.currentEmojis,...o.currentFavorites].find(be=>be.id===k),le=se.unicode&&ve(se,o.currentSkinTone);await o.database.incrementFavoriteEmojiCount(k),E("emoji-click",{emoji:X,skinTone:o.currentSkinTone,...le&&{unicode:le},...se.name&&{name:se.name}})}async function ce(k){const{target:X}=k;if(!X.classList.contains("emoji"))return;et(k);const se=X.id.substring(4);ie(se)}function me(k){o.currentSkinTone=k,o.skinTonePickerExpanded=!1,g("skintone-button"),E("skin-tone-change",{skinTone:k}),o.database.setPreferredSkinTone(k)}function fe(k){const{target:{id:X}}=k,se=X&&X.match(/^skintone-(\d)/);if(!se)return;et(k);const le=parseInt(se[1],10);me(le)}function Se(k){o.skinTonePickerExpanded=!o.skinTonePickerExpanded,o.activeSkinTone=o.currentSkinTone,o.skinTonePickerExpanded&&(et(k),Lt(()=>g("skintone-list")))}v(()=>{o.skinTonePickerExpanded?i.skinToneDropdown.addEventListener("transitionend",()=>{o.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):o.skinTonePickerExpandedAfterAnimation=!1});function we(k){if(!o.skinTonePickerExpanded)return;const X=async se=>{et(k),o.activeSkinTone=se};switch(k.key){case"ArrowUp":return X(Ht(!0,o.activeSkinTone,o.skinTones));case"ArrowDown":return X(Ht(!1,o.activeSkinTone,o.skinTones));case"Home":return X(0);case"End":return X(o.skinTones.length-1);case"Enter":return et(k),me(o.activeSkinTone);case"Escape":return et(k),o.skinTonePickerExpanded=!1,g("skintone-button")}}function re(k){if(o.skinTonePickerExpanded)switch(k.key){case" ":return et(k),me(o.activeSkinTone)}}async function je(k){const{relatedTarget:X}=k;(!X||X.id!=="skintone-list")&&(o.skinTonePickerExpanded=!1)}function Pe(k){o.rawSearchText=k.target.value}return{$set(k){Dt(o,k)},$destroy(){s.abort()}}}const Na="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",La="en";var Ma={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading‚Ä¶",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},Oa=":host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.custom-emoji,.emoji,button.emoji{height:var(--total-emoji-size);width:var(--total-emoji-size)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.custom-emoji{padding:var(--emoji-padding);object-fit:contain;pointer-events:none;background-repeat:no-repeat;background-position:center center;background-size:var(--emoji-size) var(--emoji-size)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}";const Vn=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],ja=`:host{--emoji-font-family:${Fn}}`;class ln extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const i=document.createElement("style");i.textContent=Oa+ja,this.shadowRoot.appendChild(i),this._ctx={locale:La,dataSource:Na,skinToneEmoji:Xr,customCategorySorting:Zr,customEmoji:null,i18n:Ma,emojiVersion:null,...e};for(const s of Vn)s!=="database"&&Object.prototype.hasOwnProperty.call(this,s)&&(this._ctx[s]=this[s],delete this[s]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=Da(this.shadowRoot,this._ctx))}disconnectedCallback(){jt(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(i=>console.error(i))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,i,s){this._set(e.replace(/-([a-z])/g,(m,o)=>o.toUpperCase()),e==="emoji-version"?parseFloat(s):s)}_set(e,i){this._ctx[e]=i,this._cmp&&this._cmp.$set({[e]:i}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:i,database:s}=this._ctx;(!s||s.locale!==e||s.dataSource!==i)&&this._set("database",new qr({locale:e,dataSource:i}))}_dbFlush(){jt(()=>this._dbCreate())}}const zn={};for(const n of Vn)zn[n]={get(){return n==="database"&&this._dbCreate(),this._ctx[n]},set(e){if(n==="database")throw new Error("database is read-only");this._set(n,e)}};Object.defineProperties(ln.prototype,zn);customElements.get("emoji-picker")||customElements.define("emoji-picker",ln);var nn={exports:{}};/*! mobile-drag-drop 2.3.0-rc.1 | Copyright (c) 2019 Tim Ruffles | MIT License */(function(n,e){(function(i,s){s(e)})(Tt,function(i){var s="dnd-poly-",m=s+"snapback",o="dnd-poly-",v=o+"dragstart-pending",g=o+"dragstart-cancel",j=["none","copy","copyLink","copyMove","link","linkMove","move","all"],E=["none","copy","move","link"],F=function(){var O=!1;try{var T=Object.defineProperty({},"passive",{get:function(){O=!0}});window.addEventListener("test",null,T)}catch{}return O}();function w(O){return O&&O.tagName}function S(O,T,H){H===void 0&&(H=!0),document.addEventListener(O,T,!!F&&{passive:H})}function B(O,T){document.removeEventListener(O,T)}function ue(O,T,H,ie){ie===void 0&&(ie=!1);var ce=F?{passive:!0,capture:ie}:ie;return O.addEventListener(T,H,ce),{off:function(){O.removeEventListener(T,H,ce)}}}function ve(O){return O.length===0?0:O.reduce(function(T,H){return H+T},0)/O.length}function ee(O,T){for(var H=0;H<O.changedTouches.length;H++)if(O.changedTouches[H].identifier===T)return!0;return!1}function te(O,T,H){for(var ie=[],ce=[],me=0;me<T.touches.length;me++){var fe=T.touches[me];ie.push(fe[O+"X"]),ce.push(fe[O+"Y"])}H.x=ve(ie),H.y=ve(ce)}var pe=["","-webkit-"];function z(O,T,H,ie,ce){ce===void 0&&(ce=!0);var me=T.x,fe=T.y;ie&&(me+=ie.x,fe+=ie.y),ce&&(me-=parseInt(O.offsetWidth,10)/2,fe-=parseInt(O.offsetHeight,10)/2);for(var Se="translate3d("+me+"px,"+fe+"px, 0)",we=0;we<pe.length;we++){var re=pe[we]+"transform";O.style[re]=Se+" "+H[we]}}var J=function(){function O(T,H){this.t=T,this.i=H,this.s=E[0]}return Object.defineProperty(O.prototype,"dropEffect",{get:function(){return this.s},set:function(T){this.t.mode!==0&&j.indexOf(T)>-1&&(this.s=T)},enumerable:!0,configurable:!0}),Object.defineProperty(O.prototype,"types",{get:function(){if(this.t.mode!==0)return Object.freeze(this.t.types)},enumerable:!0,configurable:!0}),Object.defineProperty(O.prototype,"effectAllowed",{get:function(){return this.t.effectAllowed},set:function(T){this.t.mode===2&&j.indexOf(T)>-1&&(this.t.effectAllowed=T)},enumerable:!0,configurable:!0}),O.prototype.setData=function(T,H){if(this.t.mode===2){if(T.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this.t.data[T]=H,this.t.types.indexOf(T)===-1&&this.t.types.push(T)}},O.prototype.getData=function(T){if(this.t.mode===1||this.t.mode===2)return this.t.data[T]||""},O.prototype.clearData=function(T){if(this.t.mode===2){if(T&&this.t.data[T]){delete this.t.data[T];var H=this.t.types.indexOf(T);return void(H>-1&&this.t.types.splice(H,1))}this.t.data={},this.t.types=[]}},O.prototype.setDragImage=function(T,H,ie){this.t.mode===2&&this.i(T,H,ie)},O}();function I(O,T){return O?O===j[0]?E[0]:O.indexOf(j[1])===0||O===j[7]?E[1]:O.indexOf(j[4])===0?E[3]:O===j[6]?E[2]:E[1]:T.nodeType===3&&T.tagName==="A"?E[3]:E[1]}function Z(O,T,H,ie,ce,me,fe){me===void 0&&(me=!0),fe===void 0&&(fe=null);var Se=function(re,je,Pe,k,X,se,le){le===void 0&&(le=null);var be=je.changedTouches[0],ne=new Event(Pe,{bubbles:!0,cancelable:k});ne.dataTransfer=se,ne.relatedTarget=le,ne.screenX=be.screenX,ne.screenY=be.screenY,ne.clientX=be.clientX,ne.clientY=be.clientY,ne.pageX=be.pageX,ne.pageY=be.pageY;var Te=re.getBoundingClientRect();return ne.offsetX=ne.clientX-Te.left,ne.offsetY=ne.clientY-Te.top,ne}(T,H,O,me,document.defaultView,ce,fe),we=!T.dispatchEvent(Se);return ie.mode=0,we}function K(O,T){if(!O||O===j[7])return T;if(T===E[1]){if(O.indexOf(E[1])===0)return E[1]}else if(T===E[3]){if(O.indexOf(E[3])===0||O.indexOf("Link")>-1)return E[3]}else if(T===E[2]&&(O.indexOf(E[2])===0||O.indexOf("Move")>-1))return E[2];return E[0]}var q,b=function(){function O(T,H,ie,ce){this.h=T,this.o=H,this.u=ie,this.l=ce,this.v=0,this.p=null,this.g=null,this.m=T,this.I=T.changedTouches[0],this.j=this.C.bind(this),this.S=this.k.bind(this),S("touchmove",this.j,!1),S("touchend",this.S,!1),S("touchcancel",this.S,!1)}return O.prototype.A=function(){var T=this;this.v=1,this.O=E[0],this.D={data:{},effectAllowed:void 0,mode:3,types:[]},this.M={x:null,y:null},this.F={x:null,y:null};var H=this.u;if(this.N=new J(this.D,function(Se,we,re){H=Se,typeof we!="number"&&typeof re!="number"||(T.P={x:we||0,y:re||0})}),this.D.mode=2,this.N.dropEffect=E[0],Z("dragstart",this.u,this.m,this.D,this.N))return this.v=3,this.T(),!1;te("page",this.m,this.F);var ie,ce=this.o.dragImageSetup(H);if(this.L=(ie=ce,pe.map(function(Se){var we=ie.style[Se+"transform"];return we&&we!=="none"?we.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""})),ce.style.position="absolute",ce.style.left="0px",ce.style.top="0px",ce.style.zIndex="999999",ce.classList.add("dnd-poly-drag-image"),ce.classList.add("dnd-poly-icon"),this._=ce,!this.P)if(this.o.dragImageOffset)this.P={x:this.o.dragImageOffset.x,y:this.o.dragImageOffset.y};else if(this.o.dragImageCenterOnTouch){var me=getComputedStyle(H);this.P={x:0-parseInt(me.marginLeft,10),y:0-parseInt(me.marginTop,10)}}else{var fe=H.getBoundingClientRect();me=getComputedStyle(H),this.P={x:fe.left-this.I.clientX-parseInt(me.marginLeft,10)+fe.width/2,y:fe.top-this.I.clientY-parseInt(me.marginTop,10)+fe.height/2}}return z(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch),document.body.appendChild(this._),this.V=window.setInterval(function(){T.X||(T.X=!0,T.Y(),T.X=!1)},this.o.iterationInterval),!0},O.prototype.T=function(){this.V&&(clearInterval(this.V),this.V=null),B("touchmove",this.j),B("touchend",this.S),B("touchcancel",this.S),this._&&(this._.parentNode.removeChild(this._),this._=null),this.l(this.o,this.m,this.v)},O.prototype.C=function(T){var H=this;if(ee(T,this.I.identifier)!==!1){if(this.m=T,this.v===0){var ie=void 0;if(this.o.dragStartConditionOverride)try{ie=this.o.dragStartConditionOverride(T)}catch{ie=!1}else ie=T.touches.length===1;return ie?void(this.A()===!0&&(this.h.preventDefault(),T.preventDefault())):void this.T()}if(T.preventDefault(),te("client",T,this.M),te("page",T,this.F),this.o.dragImageTranslateOverride)try{var ce=!1;if(this.o.dragImageTranslateOverride(T,{x:this.M.x,y:this.M.y},this.p,function(me,fe){H._&&(ce=!0,H.M.x+=me,H.M.y+=fe,H.F.x+=me,H.F.y+=fe,z(H._,H.F,H.L,H.P,H.o.dragImageCenterOnTouch))}),ce)return}catch{}z(this._,this.F,this.L,this.P,this.o.dragImageCenterOnTouch)}},O.prototype.k=function(T){if(ee(T,this.I.identifier)!==!1){if(this.o.dragImageTranslateOverride)try{this.o.dragImageTranslateOverride(void 0,void 0,void 0,function(){})}catch{}this.v!==0?(T.preventDefault(),this.v=T.type==="touchcancel"?3:2):this.T()}},O.prototype.Y=function(){var T=this,H=this.O;this.D.mode=3,this.N.dropEffect=E[0];var ie=Z("drag",this.u,this.m,this.D,this.N);if(ie&&(this.O=E[0]),ie||this.v===2||this.v===3)return this.q(this.v)?void function(Se,we,re,je){var Pe=getComputedStyle(Se);if(Pe.visibility!=="hidden"&&Pe.display!=="none"){we.classList.add(m);var k=getComputedStyle(we),X=parseFloat(k.transitionDuration);if(isNaN(X)||X===0)je();else{var se=Se.getBoundingClientRect(),le={x:se.left,y:se.top};le.x+=document.body.scrollLeft||document.documentElement.scrollLeft,le.y+=document.body.scrollTop||document.documentElement.scrollTop,le.x-=parseInt(Pe.marginLeft,10),le.y-=parseInt(Pe.marginTop,10);var be=parseFloat(k.transitionDelay),ne=Math.round(1e3*(X+be));z(we,le,re,void 0,!1),setTimeout(je,ne)}}else je()}(this.u,this._,this.L,function(){T.B()}):void this.B();var ce=this.o.elementFromPoint(this.M.x,this.M.y),me=this.g;ce!==this.p&&ce!==this.g&&(this.p=ce,this.g!==null&&(this.D.mode=3,this.N.dropEffect=E[0],Z("dragexit",this.g,this.m,this.D,this.N,!1)),this.p===null?this.g=this.p:(this.D.mode=3,this.N.dropEffect=I(this.D.effectAllowed,this.u),Z("dragenter",this.p,this.m,this.D,this.N)?(this.g=this.p,this.O=K(this.N.effectAllowed,this.N.dropEffect)):this.p!==document.body&&(this.g=document.body))),me!==this.g&&w(me)&&(this.D.mode=3,this.N.dropEffect=E[0],Z("dragleave",me,this.m,this.D,this.N,!1,this.g)),w(this.g)&&(this.D.mode=3,this.N.dropEffect=I(this.D.effectAllowed,this.u),Z("dragover",this.g,this.m,this.D,this.N)===!1?this.O=E[0]:this.O=K(this.N.effectAllowed,this.N.dropEffect)),H!==this.O&&this._.classList.remove(s+H);var fe=s+this.O;this._.classList.add(fe)},O.prototype.q=function(T){var H=this.O===E[0]||this.g===null||T===3;return H?w(this.g)&&(this.D.mode=3,this.N.dropEffect=E[0],Z("dragleave",this.g,this.m,this.D,this.N,!1)):w(this.g)&&(this.D.mode=1,this.N.dropEffect=this.O,Z("drop",this.g,this.m,this.D,this.N)===!0?this.O=this.N.dropEffect:this.O=E[0]),H},O.prototype.B=function(){this.D.mode=3,this.N.dropEffect=this.O,Z("dragend",this.u,this.m,this.D,this.N,!1),this.v=2,this.T()},O}(),he={iterationInterval:150,tryFindDraggableTarget:function(O){var T=O.target;do if(T.draggable!==!1&&(T.draggable===!0||T.getAttribute&&T.getAttribute("draggable")==="true"))return T;while((T=T.parentNode)&&T!==document.body)},dragImageSetup:function(O){var T=O.cloneNode(!0);return function H(ie,ce){if(ie.nodeType===1){for(var me=getComputedStyle(ie),fe=0;fe<me.length;fe++){var Se=me[fe];ce.style.setProperty(Se,me.getPropertyValue(Se),me.getPropertyPriority(Se))}if(ce.style.pointerEvents="none",ce.removeAttribute("id"),ce.removeAttribute("class"),ce.removeAttribute("draggable"),ce.nodeName==="CANVAS"){var we=ie,re=ce,je=we.getContext("2d").getImageData(0,0,we.width,we.height);re.getContext("2d").putImageData(je,0,0)}}if(ie.hasChildNodes())for(fe=0;fe<ie.childNodes.length;fe++)H(ie.childNodes[fe],ce.childNodes[fe])}(O,T),T},elementFromPoint:function(O,T){return document.elementFromPoint(O,T)}};function Ce(O){if(!q){var T=he.tryFindDraggableTarget(O);if(T)try{q=new b(O,he,T,Oe)}catch(H){throw Oe(he,O,3),H}}}function Ne(O){var T=O.target,H=function(we){ce.off(),me.off(),fe.off(),Se.off(),T&&T.dispatchEvent(new CustomEvent(g,{bubbles:!0,cancelable:!0})),clearTimeout(ie)};T&&T.dispatchEvent(new CustomEvent(v,{bubbles:!0,cancelable:!0}));var ie=window.setTimeout(function(){ce.off(),me.off(),fe.off(),Se.off(),Ce(O)},he.holdToDrag),ce=ue(T,"touchend",H),me=ue(T,"touchcancel",H),fe=ue(T,"touchmove",H),Se=ue(window,"scroll",H,!0)}function Oe(O,T,H){if(H===0&&O.defaultActionOverride)try{O.defaultActionOverride(T),T.defaultPrevented}catch{}q=null}i.polyfill=function(O){if(O&&Object.keys(O).forEach(function(ce){he[ce]=O[ce]}),!he.forceApply){var T=(H={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,userAgentSupportingNativeDnD:void 0},ie=!!window.chrome||/chrome/i.test(navigator.userAgent),H.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||ie&&"ontouchstart"in document.documentElement),H);if(T.userAgentSupportingNativeDnD&&T.draggable&&T.dragEvents)return!1}var H,ie;return he.holdToDrag?S("touchstart",Ne,!1):S("touchstart",Ce,!1),!0},Object.defineProperty(i,"__esModule",{value:!0})})})(nn,nn.exports);var Pa=nn.exports;const Ba=n=>typeof n!="string"?n:n.replace(/[&'`"<>]/g,e=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[e]),nt=(n,e)=>{n.classList.remove(e),window.requestAnimationFrame(()=>{window.requestAnimationFrame(()=>{n.classList.add(e)})})},Ra=()=>{const n=window.visualViewport,e=()=>document.documentElement.style.setProperty("--vvh",`${n.height}px`);n.addEventListener("resize",e),e()};let Tn;const Ua=(n=window)=>new Promise(e=>{const i=setTimeout(()=>{e()},100),s=()=>{clearTimeout(i),clearTimeout(Tn),Tn=setTimeout(()=>{n.removeEventListener("scroll",s),e()},100)};n.addEventListener("scroll",s)}),$a="v0.6.2 Beta";document.addEventListener("DOMContentLoaded",()=>{var be,ne,Te,Ve,Be,$e,st,Ge,Ae,at,Je,ot,ct,lt;const n=document.querySelector(".editor"),e=document.getElementById("tones"),i=document.getElementById("action"),s=document.getElementById("musical-score"),m=document.getElementById("add-track"),o=document.getElementById("remove-track"),v=document.getElementById("dialog"),g=document.forms["dialog-form"];g._title=g.querySelector(".form-title"),g.inputs=g.querySelector(".inputs"),g.buttons=g.querySelector(".buttons");const j=document.getElementById("play"),E=document.getElementById("clear"),F=document.getElementById("warn-out"),w=document.getElementById("mml"),S=document.getElementById("copy"),B=document.getElementById("paste"),ue=document.getElementById("save"),ve=document.getElementById("open"),ee=document.getElementById("ctrl"),te=document.getElementById("undo"),pe=document.getElementById("redo");class z{constructor(){We(this,be,`#COMMENT Generated by FlMML VisualSequencer ${$a}`);We(this,ne,[]);We(this,Te,(a,A)=>{});We(this,Ve,(a,A)=>{})}set onChange(a){He(this,Te,a)}set onError(a){He(this,Ve,a)}setMmlArr(a){He(this,ne,a),Q(this,Te).call(this,this.getMmlArr(),this.getMml())}setMml(a){He(this,ne,a.split(`
`)),Q(this,ne).at(-2)===""&&Q(this,ne).at(-1)===Q(this,be)&&Q(this,ne).splice(-2,2),Q(this,Te).call(this,this.getMmlArr(),this.getMml())}getMmlArr(){return Q(this,ne)}getMml(){return Q(this,ne).length?Q(this,ne).concat(["",Q(this,be)]).join(`
`):""}getMmlLine(a){return Q(this,ne)[a]}insert(a,A){Object.hasOwn(Q(this,ne),a)||a===0?(Q(this,ne).splice(a,0,A),Q(this,Te).call(this,this.getMmlArr(),this.getMml())):Q(this,Ve).call(this,"ÁØÑÂõ≤Â§ñ„ÅÆÊõ∏„ÅçÊèõ„ÅàÊåáÂÆö",`ÁØÑÂõ≤${Q(this,ne).length-1}„Åæ„Åß„ÅÆ„Å®„Åì„Çç„ÄÅ${a}`)}append(a){Q(this,ne).push(a),Q(this,Te).call(this,this.getMmlArr(),this.getMml())}appendToStr(a,A){Object.hasOwn(Q(this,ne),a)?(Q(this,ne)[a]+=A,Q(this,Te).call(this,this.getMmlArr(),this.getMml())):this.append(A)}beforeInsertToStr(a,A){Object.hasOwn(Q(this,ne),a)?(Q(this,ne)[a]=A+Q(this,ne)[a],Q(this,Te).call(this,this.getMmlArr(),this.getMml())):this.append(A)}rewrite(a,A){Object.hasOwn(Q(this,ne),a)?(Q(this,ne)[a]=A,Q(this,Te).call(this,this.getMmlArr(),this.getMml())):this.append(A)}delete(a,A=1){Object.hasOwn(Q(this,ne),a)&&Q(this,ne).splice(a,A).length!==0?Q(this,Te).call(this,this.getMmlArr(),this.getMml()):Q(this,Ve).call(this,"ÁÑ°Âäπ„Å™ÊåáÂÆö",`ÁØÑÂõ≤${Q(this,ne).length-1}„Åæ„Åß„ÅÆ‰∏≠„Åß${a}„Åã„Çâ${A}ÂâäÈô§„Åô„Çã„ÅÆ„ÅØ„Åß„Åç„Åæ„Åõ„Çì`)}}be=new WeakMap,ne=new WeakMap,Te=new WeakMap,Ve=new WeakMap;class J{constructor(a,A){We(this,Be,[]);We(this,$e,[]);We(this,st,null);We(this,Ge,null);this.tonesElem=a,this.areaElem=A,He(this,Ge,this.areaElem.querySelector(".track.active"))}set activeTrack(a){Q(this,Ge).classList.remove("active"),He(this,Ge,a),Q(this,Ge).classList.add("active")}get activeTrack(){return Q(this,Ge)}blocksDataUpdate(){He(this,Be,[...this.areaElem.querySelectorAll(".track button")].map(a=>({label:a.ariaLabel,className:a.className,trackNo:[...document.getElementsByClassName("track")].findIndex(A=>A.contains(a)),tone:{tone:a.dataset.tone,tonePitch:a.dataset.tonePitch},tempo:a.dataset.tempo,noteValue:a.dataset.noteValue,rest:a.dataset.rest,octave:a.dataset.octave,velocity:a.dataset.velocity,noteShift:a.dataset.noteShift,detune:a.dataset.detune,tieSlur:a.dataset.tieSlur,repeatStartEnd:a.dataset.repeatStartEnd,repeatBreak:a.dataset.repeatBreak,polyStartEnd:a.dataset.polyStartEnd,macroDef:a.dataset.macroDef,macroArgUse:a.dataset.macroArgUse,macroUse:a.dataset.macroUse,metaData:a.dataset.metaData,otherAction:a.dataset.otherAction,elem:a})))}saveBlocksData(){clearTimeout(Q(this,st)),He(this,st,setTimeout(()=>{const a=JSON.parse(JSON.stringify(Q(this,Be)));Wt.setItem("BlocksData",a).catch(A=>{alert("„Çª„Éº„Éñ„Åå„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ"+A)})},1e3))}checkSavedBlocksData(){Wt.getItem("BlocksData").then(a=>{a&&(He(this,Be,a),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.exportMml(q))})}parseBlocks(){const a=Q(this,Be);this.activeTrack=this.areaElem.querySelector(".track");const A=this.tonesElem.querySelector("ul");let V=0;a.forEach(h=>{if(h.trackNo!==V){const L=document.createElement("ul");L.classList.add("track"),this.activeTrack=L,this.areaElem.insertBefore(L,m),V=h.trackNo}const d=document.createElement("li"),D='<button class="material-icons note note-1" aria-label="ÁÑ°Ë™øÊï¥" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>',G=(()=>{const L=document.createElement("div");return L.innerHTML=D,L.firstElementChild})(),C=document.querySelector(`[class*="${h.className.replace(/ material-icons| droppable| bounce| pop| done/g,"")}"]`),$=(C==null?void 0:C.cloneNode(!0))||G;h.label&&($.ariaLabel=h.label),h.tone.tonePitch&&($.className=h.className,h.label!=="ÁÑ°Ë™øÊï¥"&&($.textContent=h.label),$.dataset.tone=h.tone.tone,C?C.replaceWith($.cloneNode(!0)):A.appendChild($.cloneNode(!0)),$.dataset.tonePitch=h.tone.tonePitch),h.tempo&&($.dataset.tempo=h.tempo),h.noteValue&&($.dataset.noteValue=h.noteValue),h.rest&&($.dataset.rest=h.rest),h.octave&&($.dataset.octave=h.octave),h.velocity&&($.dataset.velocity=h.velocity),h.noteShift&&($.dataset.noteShift=h.noteShift),h.detune&&($.dataset.detune=h.detune),h.tieSlur&&($.dataset.tieSlur=h.tieSlur,h.tieSlur==="&"?$.ariaLabel="„Çπ„É©„Éº":$.ariaLabel="„Çø„Ç§"),h.repeatStartEnd&&($.dataset.repeatStartEnd=h.repeatStartEnd,h.repeatStartEnd.startsWith("/:")?($.classList.remove("material-icons"),$.ariaLabel="„É™„Éî„Éº„ÉàÈñãÂßã",$.textContent="‚óÜ"):h.repeatStartEnd===":/"&&($.ariaLabel="„É™„Éî„Éº„ÉàÁµÇ‰∫Ü")),h.repeatBreak&&($.dataset.repeatBreak=h.repeatBreak),h.polyStartEnd&&($.dataset.polyStartEnd=h.polyStartEnd),h.macroDef&&($.dataset.macroDef=h.macroDef,$.textContent=h.macroDef===";"?";":"$="),h.macroArgUse&&($.dataset.macroArgUse=h.macroArgUse),h.macroUse&&($.dataset.macroUse=h.macroUse),h.metaData&&($.dataset.metaData=h.metaData),h.otherAction&&($.dataset.otherAction=h.otherAction,$.textContent=h.otherAction.length>4?"‚Ä¶":h.otherAction),d.appendChild($),this.activeTrack.appendChild(d)})}exportMml(a){a.setMmlArr([]);let A=0,V=0;const h=Q(this,Be).filter(_=>_.tone.tone!==void 0),d=()=>h.filter(_=>_.trackNo===V),D=()=>new Set(d().map(_=>_.tone.tone));let G=D(),C=0,$=!1,L=[4,0],W=!1;Q(this,Be).forEach(_=>{const{tone:oe,tonePitch:P}=_.tone;if(_.trackNo!==V&&(G.size?([...G].forEach((N,y)=>{a.appendToStr(A+y,";")}),A+=G.size):(a.appendToStr(A,";"),A++),V=_.trackNo,G=D(),$=!1),oe!==void 0)C=[...G].indexOf(oe),$||([...G].forEach((N,y)=>{N&&a.beforeInsertToStr(A+y,N+" ")}),$=!0),[...G].forEach((N,y)=>{let ye=P||"";y!==C&&(ye=ye.replace(/[a-g]/,W?"*":"r")),a.appendToStr(A+y,ye)});else if(_.rest||_.tieSlur)G.size?[...G].forEach((N,y)=>{a.appendToStr(A+y,_.rest||_.tieSlur)}):a.appendToStr(A,_.rest||_.tieSlur);else if(_.noteValue||_.repeatStartEnd||_.repeatBreak||_.polyStartEnd){const N=y=>{if(!y)return L;const ye=Number((y.match(/[0-9]+/)||[L[0]])[0]),Ee=(y.match(/\.+/)||[""])[0].length;return[ye,Ee]};_.noteValue?L=N(_.noteValue):_.polyStartEnd==="["?W=!0:_.polyStartEnd==="]"&&(W=!1),G.size?[...G].forEach((y,ye)=>{if(a.appendToStr(A+ye,_.noteValue||_.repeatStartEnd||_.repeatBreak||_.polyStartEnd||""),_.polyStartEnd==="]"){const Ee=a.getMmlLine(A+ye).match(/\[(.+?)\]/);if(Ee){const Le=Ee[1].matchAll(/([a-g*r]\+?)([0-9]*)(\.*)/g);if(Le){const Qe=[...Le].map(Xe=>({type:Xe[1]==="r"?"rest":Xe[1]==="*"?"otherNote":"note",num:N(Xe[0])}));Qe.filter(Re=>Re.type==="note").map(Re=>Re.num),Qe.filter(Re=>Re.type==="otherNote").map(Re=>Re.num),Qe.filter(Re=>Re.type==="rest").map(Re=>Re.num);let Ke=Ee[0].replace(/\*\+?[0-9]*\.*/g,"");const tt=a.getMmlLine(A+ye).replace(/\[.+?\]/,Ke);a.rewrite(A+ye,tt)}}}}):a.appendToStr(A,_.noteValue||_.repeatStartEnd||_.repeatBreak||_.polyStartEnd||"")}else if(_.metaData)_.metaData&&a.getMmlLine(A)&&A++,a.appendToStr(A,_.metaData.replace(`
`,"")||""),A++;else{const N=P||_.tempo||_.octave||_.velocity||_.noteShift||_.detune||_.tieSlur||_.macroDef||_.macroArgUse||_.macroUse||_.otherAction||"";a.appendToStr(A,N),/;/.test(N)&&(A+=G.size||1,G=D(),$=!1)}}),[...G].slice(0,-1).forEach((_,oe)=>{a.appendToStr(A+oe,";")})}importMml(a){const A=a.getMmlArr(),V=/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+|[><]*?[a-g]\+?[0-9]*\.*|t[0-9]+|l[0-9]+\.*|r[0-9]*\.*|o[0-8]|[><]+|@?v[0-9]+|[\)\(][0-9]+|@?ns-?[0-9]+|@d-?[0-9]+|&[0-9]*\.*|\/\*.*?\*\/|\/\*|\*\/|\/:[0-9]*|:\/|\/|\[|\]|\$.*?=|%[a-z0-9_]+|\$[a-z0-9_{}]+|^#.*|;| +|@pl[0-9]+|[^;]+/ig,h=[],d=new Set,D=new Set;let G=0,C="",$=!1,L=!1;A.forEach(W=>{(W.match(V)||[]).forEach(oe=>{if(oe=oe.trim(),!oe)return;const P=N=>{const y={};if(y.tone={},y.trackNo=G,/((@(l|q|x|p|u|mh|w|n|f|e|'[aeiou]?'|o|i|r|s)?|q|x)[0-9\-, ]+)+/i.test(N)){C=N,D.add(C);return}else if(/^[><]*?[a-g]\+?[0-9]*\.*$/i.test(N)){D.has(C)||D.add(C);const ye=[...D].indexOf(C)+1;y.label="ÁÑ°Ë™øÊï¥",y.className=`material-icons note note-${ye}`,y.tone.tone=C,y.tone.tonePitch=N,$&&(L=!0)}else if(N.startsWith("t"))y.className="material-icons tempo",y.tempo=N;else if(N.startsWith("l"))y.className="material-icons note-value",y.noteValue=N;else if(N.startsWith("r"))y.className="material-icons rest",y.rest=N;else if(/^o[0-8]|[><]+$/i.test(N))y.className="material-icons octave",y.octave=N;else if(/^@?v[0-9]+|[\)\(][0-9]+$/i.test(N))y.className="material-icons velocity",y.velocity=N;else if(N.startsWith("@ns")||N.startsWith("ns"))y.className="material-icons note-shift",y.noteShift=N;else if(N.startsWith("@d"))y.className="material-icons detune",y.detune=N;else if(N.startsWith("&"))y.className="tie-slur",y.tieSlur=N;else if(N.startsWith("/*"))y.className="other-action",y.otherAction=N;else if(N.startsWith("/:"))y.className="repeat-start-end",y.repeatStartEnd=N;else if(N.startsWith(":/"))y.className="material-icons repeat-start-end",y.repeatStartEnd=N;else if(N.startsWith("/"))y.className="repeat-break",y.repeatBreak=N;else if(N.startsWith("[")||N.startsWith("]"))y.className="poly-start-end",y.polyStartEnd=N;else if(/^\$.*?=$/.test(N))y.className="macro-def",y.macroDef=N.replaceAll(" ",""),d.add(y.macroDef.slice(0,-1)),$=!0;else if(N.startsWith("%"))y.className="macro-arg-use",y.macroArgUse=N;else if(N.startsWith("$")){y.className="macro-use";const ye=[...d].sort((Ee,Le)=>Le.length-Ee.length).find(Ee=>N.includes(Ee));if(ye){y.macroUse=ye,h.push(y);const Ee=N.replace(ye,"");Ee!==""&&P(Ee);return}else y.macroUse=N}else if(N.startsWith("#")){const ye={"#TITLE":"„Çø„Ç§„Éà„É´","#ARTIST":"„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà","#COMMENT":"„Ç≥„É°„É≥„Éà","#CODING":"‰ΩúÊàêËÄÖ","#PRAGMA":"PRAGMA","#OCTAVE":"Áõ∏ÂØæ„Ç™„ÇØ„Çø„Éº„ÉñÂèçËª¢","#VELOCITY REVERSE":"Áõ∏ÂØæ„Éô„É≠„Ç∑„ÉÜ„Ç£ÂèçËª¢","#WAV9":"@9 Ê≥¢ÂΩ¢„Éá„Éº„Çø","#WAV10":"@10 Ê≥¢ÂΩ¢„Éá„Éº„Çø","#WAV13":"@13 Ê≥¢ÂΩ¢„Éá„Éº„Çø","#OPM":"@14 OPMÈü≥Ëâ≤„Éá„Éº„Çø","#OPN":"@14 OPNÈü≥Ëâ≤„Éá„Éº„Çø","#FMGAIN":"@14 Èü≥ÈáèÂà©Âæó","#USING":"ÂíåÈü≥Âà©Áî®ÂÆ£Ë®Ä"};y.label=(Object.entries(ye).find(Ee=>N.startsWith(Ee[0]))||[,void 0])[1],y.className="meta-data",y.metaData=N+`
`}else if(N.startsWith(";")){if(G++,$&&!L){const ye=[...D].join(" ");ye&&(y.className="other-action",y.otherAction=ye,h.push(y),D.clear())}$=!1,L=!1;return}else y.className="other-action",y.otherAction=N;h.push(y)};P(oe)})}),this.tonesElem.querySelector("ul").textContent="",this.areaElem.querySelectorAll(".track").forEach((W,_)=>{_?W.remove():(W.textContent="",this.activeTrack=W)}),re=null,He(this,Be,h),this.parseBlocks(),this.blocksDataUpdate(),this.calcPoly(),this.saveBlocksData()}playRendering(){const a=Q(this,Be);let A=120,V=0;[e,i,s].forEach(L=>{L.classList.add("no-op")});const h=document.querySelector(".wrap"),d=document.getElementsByClassName("track"),G=(h.clientHeight-32)/d.length;[...d].forEach(L=>{L.style.setProperty("--max-height",`${G}px`)}),m.disabled=!0,o.disabled=!0;const C=(L,{scoreNoteValue:W=4}={})=>{var xt;let _=!1,oe=-1,P=-1,N=!1,y=!1;const ye=[],Ee=[],Le=[],Qe=performance.now(),Ke=(xt=L[0])==null?void 0:xt.trackNo,tt=d[Ke],Xe=V++;let Re=null;const Pt=new Promise(de=>Re=de);let bt=0,Me=0;const ft=de=>{if(!de)return W;const Fe=/(?:[a-g]\+?|[lr&])([0-9]*)(\.*)/.exec(de),Ye=Fe&&Fe[1]?Number(Fe[1]):W,Ie=Fe?Fe[2].length:0;return Ye*2**Ie/(2**(Ie+1)-1)},Bt=de=>{const Fe=Ie=>{!y&&tt.scrollTo({top:Ie,behavior:"smooth"}),y=!0,Ua(tt).then(()=>{y=!1})},Ye=Ie=>tt.clientHeight*Ie;(Me===0||de.elem.offsetTop>tt.scrollTop+Ye(.8)||de.elem.offsetTop<tt.scrollTop+Ye(.2))&&Fe(de.elem.offsetTop-Ye(.2))},ht=de=>{const Fe=Ye=>{const Ie=Ye-Qe,Ue=60/A*4/de*1e3;Ie<bt+Ue?Q(this,$e)[Xe]=requestAnimationFrame(Fe):(bt+=Ue,ze())};Q(this,$e)[Xe]=requestAnimationFrame(Fe)},ze=async()=>{var Fe,Ye;const de=L[Me];if(!de||Me>=L.length){Re({scoreNoteValue:W});return}if(Bt(de),N){de.macroDef===";"&&(N=!1),Me++,ze();return}else if(oe!==-1)(Fe=de.repeatStartEnd)!=null&&Fe.startsWith("/:")?P++:de.repeatStartEnd===":/"&&(P===oe&&(nt(de.elem,"pop"),oe=-1),P--),Me++,ze();else if(de.tone.tonePitch){const Ie=ft(de.tone.tonePitch);nt(de.elem,"bounce"),Me++,_?ze():ht(Ie)}else if(de.rest||de.tieSlur)if(nt(de.elem,"pop"),Me++,de.tieSlur==="&")ze();else{const Ie=ft(de.rest||de.tieSlur);ht(Ie)}else if(de.polyStartEnd)if(_=de.polyStartEnd==="[",nt(de.elem,"pop"),_)Me++,ze();else{const Ie=ft(L[Me++-1].tone.tonePitch);ht(Ie)}else if(de.macroDef&&de.macroDef!==";"){N=!0,Me++,ze();return}else{if(de.tempo&&(A=Number(de.tempo.replace("t",""))||A),de.noteValue&&(W=ft(de.noteValue)),nt(de.elem,"pop"),(Ye=de.repeatStartEnd)!=null&&Ye.startsWith("/:"))ye[++P]=Me,Ee[P]||(Le[P]=de.repeatStartEnd.replace("/:",""),Le[P]=Le[P]===""?2:Number(Le[P]),Le[P]||(oe=P));else if(de.repeatBreak){if(Le[P]===1){if(!Ee[P]){let Ie=P;Ee[P]=L.findIndex((Ue,Ze)=>{if(Ze>ye[P]){if(console.log(Ie),Ue.repeatStartEnd.startsWith("/:"))Ie++;else if(Ue.repeatStartEnd===":/"){if(Ie===P)return!0;Ie--}}})}Me=Ee[P],ze(),nt(de.elem,"done");return}}else if(de.repeatStartEnd===":/"){if(Le[P]--,Le[P]){Ee[P]=Me,Me=ye[P],P--,ze(),nt(de.elem,"done");return}Ee[P]=null,P--}else if(de.macroUse){const Ie=Ze=>{const it=a[Ze].trackNo;let mt=Ze+1;for(;a[mt].macroDef!==";"&&a[mt].trackNo===it;)mt++;return mt},Ue={};if(Ue.start=a.findIndex(Ze=>{var it;return(it=Ze.macroDef)==null?void 0:it.startsWith(de.macroUse)}),Ue.start>-1){Ue.end=Ie(Ue.start),Ue.blocks=a.slice(Ue.start+1,Ue.end);const Ze=performance.now();W=(await C(Ue.blocks,{scoreNoteValue:W})).scoreNoteValue;const it=performance.now();bt+=it-Ze}}Me++,ze()}nt(de.elem,"done")};return ze(),Pt},$=Math.max(...a.map(L=>L.trackNo))+1;for(let L=0;L<$;L++)C(a.filter(W=>W.trackNo===L))}stopRendering(){[e,i,s].forEach(a=>{a.classList.remove("no-op")}),m.disabled=!1,o.disabled=!1,Q(this,Be).forEach(a=>{a.elem.classList.remove("done")}),Q(this,$e).forEach(a=>{cancelAnimationFrame(a)})}calcPoly(){const a=Math.max(...Q(this,Be).map(A=>A.trackNo))+1;for(let A=0;A<a;A++)Q(this,Be).filter(h=>h.polyStartEnd&&h.trackNo===A).forEach((h,d)=>{d%2===0?(h.elem.dataset.polyStartEnd="[",h.elem.textContent="["):(h.elem.dataset.polyStartEnd="]",h.elem.textContent="]")});this.blocksDataUpdate()}}Be=new WeakMap,$e=new WeakMap,st=new WeakMap,Ge=new WeakMap;class I{constructor(){We(this,Ae,[[],[]]);We(this,at,70);We(this,Je,a=>{})}set onPopstate(a){He(this,Je,a)}pushState(a){Q(this,Ae)[0].push(a),Q(this,Ae)[0].length>Q(this,at)&&Q(this,Ae)[0].shift(),Q(this,Ae)[1].length=0,console.log(Q(this,Ae))}undo(){const a=Q(this,Ae)[0].pop();Q(this,Je).call(this,{reason:"undo",data:a}),a&&Q(this,Ae)[1].unshift(a),console.log(Q(this,Ae))}redo(){const a=Q(this,Ae)[1].shift();Q(this,Je).call(this,{reason:"redo",data:a}),a&&Q(this,Ae)[0].push(a),console.log(Q(this,Ae))}clear(){Q(this,Ae)[0].length=0,Q(this,Ae)[1].length=0,console.log(Q(this,Ae))}}Ae=new WeakMap,at=new WeakMap,Je=new WeakMap;class Z{constructor(a){We(this,ot,{tone:{title:"Èü≥Ëâ≤Ë®≠ÂÆö",inputs:[{label:"ÂêçÂâç",type:"text",name:"tone-name"},{label:"Èü≥„ÅÆÂÆöÁæ©",type:"text",name:"tone-def",autofocus:""}],buttons:[{class:"primaly",value:"set-tone",textContent:"Á¢∫ÂÆö"}]},tonePitch:{title:"Èü≥‰æ°Ë®≠ÂÆö",inputs:[{label:"Èü≥‰æ°(Èü≥„ÅÆÈï∑„Åï)",type:"number",name:"tone-pitch",min:"1",max:"384"},{label:"‰ªòÁÇπ„ÅÆÊï∞",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-tone-pitch",textContent:"Á¢∫ÂÆö"}]},tempo:{title:"„ÉÜ„É≥„ÉùË®≠ÂÆö",inputs:[{label:"„ÉÜ„É≥„ÉùÊåáÂÆö(BPM)",type:"number",name:"tempo",min:"0"}],buttons:[{class:"primaly",value:"set-tempo",textContent:"Á¢∫ÂÆö"}]},noteValue:{title:"Èü≥‰æ°Ë®≠ÂÆö",inputs:[{label:"Èü≥‰æ°(Èü≥„ÅÆÈï∑„Åï)",type:"number",name:"note-value",min:"1",max:"384"},{label:"‰ªòÁÇπ„ÅÆÊï∞",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-note-value",textContent:"Á¢∫ÂÆö"}]},rest:{title:"‰ºëÁ¨¶Ë®≠ÂÆö",inputs:[{label:"‰ºëÁ¨¶„ÅÆÈï∑„Åï",type:"number",name:"rest",min:"1",max:"384"},{label:"‰ªòÁÇπ„ÅÆÊï∞",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-rest",textContent:"Á¢∫ÂÆö"}]},octave:{title:"„Ç™„ÇØ„Çø„Éº„ÉñË®≠ÂÆö",inputs:[{label:"„Ç™„ÇØ„Çø„Éº„Éñ‰ΩçÁΩÆ",type:"number",name:"octave",min:"-8",max:"8"}],buttons:[{class:"primaly",value:"set-octave",textContent:"Áµ∂ÂØæÊåáÂÆö"},{value:"set-octave-relative",textContent:"Áõ∏ÂØæÊåáÂÆö"}]},velocity:{title:"Èü≥ÈáèË®≠ÂÆö",inputs:[{label:"Èü≥Èáè",type:"number",name:"velocity",min:"-127",max:"127"}],buttons:[{class:"primaly",value:"set-velocity",textContent:"Áµ∂ÂØæÊåáÂÆö"},{value:"set-velocity-relative",textContent:"Áõ∏ÂØæÊåáÂÆö"}]},noteShift:{title:"„Éé„Éº„Éà„Ç∑„Éï„ÉàË®≠ÂÆö",inputs:[{label:"„Ç∑„Éï„ÉàÈáè",type:"number",name:"note-shift"}],buttons:[{class:"primaly",value:"set-note-shift",textContent:"Áµ∂ÂØæÊåáÂÆö"},{value:"set-note-shift-relative",textContent:"Áõ∏ÂØæÊåáÂÆö"}]},detune:{title:"„Éá„ÉÅ„É•„Éº„É≥Ë®≠ÂÆö",inputs:[{label:"„Éá„ÉÅ„É•„Éº„É≥Èáè",type:"number",name:"detune"}],buttons:[{class:"primaly",value:"set-detune",textContent:"Á¢∫ÂÆö"}]},tieSlur:{title:"„Çø„Ç§Ë®≠ÂÆö",inputs:[{label:"Èü≥‰æ°(Èü≥„ÅÆÈï∑„Åï)",type:"number",name:"tie-slur",min:"1",max:"384"},{label:"‰ªòÁÇπ„ÅÆÊï∞",type:"number",name:"dot",min:"0"}],buttons:[{class:"primaly",value:"set-tie-slur",textContent:"Á¢∫ÂÆö"}]},repeatStartEnd:{title:"„É´„Éº„ÉóË®≠ÂÆö",inputs:[{label:"„É´„Éº„ÉóÂõûÊï∞",type:"number",name:"repeat",min:"0"}],buttons:[{class:"primaly",value:"set-repeat",textContent:"Á¢∫ÂÆö"}]},macroDef:{title:"„Éû„ÇØ„É≠ÂÆöÁæ©Ë®≠ÂÆö",inputs:[{label:"ÂêçÂâç",type:"text",name:"macro-def-name"},{label:"ÂºïÊï∞ „Ç´„É≥„ÉûÂå∫Âàá„Çä",type:"text",name:"macro-def-arg"}],buttons:[{class:"primaly",value:"set-macro-def",textContent:"Á¢∫ÂÆö"}]},macroArgUse:{title:"„Éû„ÇØ„É≠ÂºïÊï∞‰ΩøÁî®Ë®≠ÂÆö",inputs:[{label:"ÂºïÊï∞Âêç",type:"text",name:"macro-arg-use"}],buttons:[{class:"primaly",value:"set-macro-arg-use",textContent:"Á¢∫ÂÆö"}]},macroUse:{title:"„Éû„ÇØ„É≠‰ΩøÁî®Ë®≠ÂÆö",inputs:[{label:"ÂêçÂâç",type:"text",name:"macro-use-name"},{label:"ÂºïÊï∞ „Ç´„É≥„ÉûÂå∫Âàá„Çä",type:"text",name:"macro-use-arg"}],buttons:[{class:"primaly",value:"set-macro-use",textContent:"Á¢∫ÂÆö"}]},metaData:{title:"„É°„Çø„Éá„Éº„ÇøË®≠ÂÆö",inputs:[{label:"ÂÆöÁæ©ÈÅ∏Êäû",select:{"#TITLE {desc}\n":"„Çø„Ç§„Éà„É´","#ARTIST {desc}\n":"„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà","#COMMENT {desc}\n":"„Ç≥„É°„É≥„Éà","#CODING {desc}\n":"‰ΩúÊàêËÄÖ","#PRAGMA {desc}\n":"PRAGMA","#OCTAVE REVERSE\n":"Áõ∏ÂØæ„Ç™„ÇØ„Çø„Éº„ÉñÂèçËª¢","#VELOCITY REVERSE\n":"Áõ∏ÂØæ„Éô„É≠„Ç∑„ÉÜ„Ç£ÂèçËª¢","#WAV9 {n},{desc}\n":"@9 Ê≥¢ÂΩ¢„Éá„Éº„Çø","#WAV10 {n},{desc}\n":"@10 Ê≥¢ÂΩ¢„Éá„Éº„Çø","#WAV13 {n},{desc}\n":"@13 Ê≥¢ÂΩ¢„Éá„Éº„Çø","#OPM@{n} {{desc}}\n":"@14 OPMÈü≥Ëâ≤„Éá„Éº„Çø","#OPN@{n} {{desc}}\n":"@14 OPNÈü≥Ëâ≤„Éá„Éº„Çø","#FMGAIN {n}\n":"@14 Èü≥ÈáèÂà©Âæó","#USING POLY {n} force\n":"ÂíåÈü≥Âà©Áî®ÂÆ£Ë®Ä"},name:"select-meta-data"},{label:" ",type:"number",name:"number"},{label:" ",type:"text",name:"text"}],buttons:[{class:"primaly",value:"set-meta-data",textContent:"Á¢∫ÂÆö"}]},otherAction:{title:"„Åù„ÅÆ‰ªñ„ÅÆ‰ΩúÁî®Ë®≠ÂÆö",inputs:[{label:"‰ªªÊÑè„ÅÆMML",type:"text",name:"other-action"}],buttons:[{class:"primaly",value:"set-other-action",textContent:"Á¢∫ÂÆö"}]},remove:{title:"‰∏ÄÈÉ®„ÅÆÊ∂àÂéª„É°„Éã„É•„Éº",buttons:[{value:"remove-left",textContent:"„Åì„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„Åã„ÇâÂ∑¶„Çí„Åô„Åπ„Å¶Ê∂àÂéª"},{value:"remove-right",textContent:"„Åì„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„Åã„ÇâÂè≥„Çí„Åô„Åπ„Å¶Ê∂àÂéª"}]}});We(this,ct,a=>{const A=Q(this,ot)[a];Object.keys(A).forEach(V=>{switch(V){case"title":g._title.textContent=A.title;break;case"inputs":A.inputs.forEach(h=>{const d=document.createElement("input");let D=d;Object.entries(h).forEach(G=>{if(G[0]==="label"){const C=document.createElement("label");C.innerHTML=G[1],C.appendChild(d),D=C}else if(G[0]==="select"){const C=document.createElement("select");C.name=h.name;const $=G[1];Object.entries($).forEach(L=>{const W=document.createElement("option");W.value=L[0],W.textContent=L[1],C.appendChild(W)}),d.replaceWith(C)}else d.setAttribute(G[0],G[1])}),g.inputs.appendChild(D)});break;case"buttons":A.buttons.forEach(h=>{const d=document.createElement("button");Object.entries(h).forEach(D=>{D[0]==="textContent"?d.textContent=D[1]:d.setAttribute(D[0],D[1])}),g.buttons.appendChild(d)});break}})});We(this,lt,(a,A)=>{g._title.textContent="",g.inputs.textContent="",g.buttons.textContent="",Q(this,ct).call(this,a);for(const[V,h]of Object.entries(A))V==="run"?h():g.elements[V].value=h;this.type=a});this.type=null,this.submitTarget=null,this.resolve=null,a.addEventListener("submit",A=>{const V=this.submitTarget,h=A.submitter.value,d=JSON.parse(JSON.stringify(V.dataset));switch(h){case"set-tone":const G=V.className;document.querySelectorAll(`[class*="${G}"]`).forEach(_=>{_.ariaLabel=a.elements["tone-name"].value,(!_.classList.contains("material-icons")||a.elements["tone-name"].value!=="ÁÑ°Ë™øÊï¥")&&(_.classList.remove("material-icons"),_.textContent=a.elements["tone-name"].value),_.dataset.tone=a.elements["tone-def"].value});break;case"set-tone-pitch":V.dataset.tonePitch=V.dataset.tonePitch.match(/[><]*?[a-g]\+?/)[0]+a.elements["tone-pitch"].value+".".repeat(a.elements.dot.value);break;case"set-tempo":V.dataset.tempo="t"+a.elements.tempo.value;break;case"set-note-value":V.dataset.noteValue="l"+a.elements["note-value"].value+".".repeat(a.elements.dot.value);break;case"set-rest":V.dataset.rest="r"+a.elements.rest.value+".".repeat(a.elements.dot.value);break;case"set-octave":V.dataset.octave="o"+a.elements.octave.value;break;case"set-octave-relative":V.dataset.octave=a.elements.octave.value>0?"<".repeat(a.elements.octave.value):">".repeat(-a.elements.octave.value);break;case"set-velocity":V.dataset.velocity="@v"+a.elements.velocity.value;break;case"set-velocity-relative":V.dataset.velocity=(a.elements.velocity.value>=0?"(":")")+Math.abs(a.elements.velocity.value);break;case"set-note-shift":V.dataset.noteShift="ns"+a.elements["note-shift"].value;break;case"set-note-shift-relative":V.dataset.noteShift="@ns"+a.elements["note-shift"].value;break;case"set-detune":V.dataset.detune="@d"+a.elements.detune.value;break;case"set-tie-slur":V.dataset.tieSlur="&"+a.elements["tie-slur"].value+".".repeat(a.elements.dot.value),V.dataset.tieSlur==="&"?V.ariaLabel="„Çπ„É©„Éº":V.ariaLabel="„Çø„Ç§";break;case"set-repeat":V.dataset.repeatStartEnd="/:"+a.elements.repeat.value;break;case"set-macro-def":const C=V.dataset.macroDef;V.dataset.macroDef="$"+a.elements["macro-def-name"].value+(a.elements["macro-def-arg"].value!==""?`{${a.elements["macro-def-arg"].value}}`:"")+"=",s.querySelectorAll(`[data-macro-use="${C.replace("=","")}"]`).forEach(_=>{_.dataset.macroUse=V.dataset.macroDef.replace("=","")});break;case"set-macro-arg-use":V.dataset.macroArgUse="%"+a.elements["macro-arg-use"].value;break;case"set-macro-use":V.dataset.macroUse="$"+a.elements["macro-use-name"].value+(a.elements["macro-use-arg"].value!==""?`{${a.elements["macro-use-arg"].value}}`:"");break;case"set-meta-data":V.ariaLabel=a.elements["select-meta-data"].selectedOptions[0].label,V.dataset.metaData=a.elements["select-meta-data"].value.replace("{n}",a.elements.number.value).replace("{desc}",a.elements.text.value);break;case"set-other-action":V.dataset.otherAction=a.elements["other-action"].value,V.textContent=V.dataset.otherAction.length>4?"‚Ä¶":V.dataset.otherAction;break;case"remove-left":case"remove-right":const $=V.parentElement,L=b.activeTrack,W=L.children;for([...W].indexOf($),re=null;[...W].includes($);){const _=h==="remove-left",oe=_?L.firstElementChild:L.lastElementChild;he.pushState({operation:"remove",removedElem:oe,removedIndex:_?0:W.length-1,parent:L}),oe.remove()}b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q);break}const D=JSON.parse(JSON.stringify(V.dataset));JSON.stringify(d)!==JSON.stringify(D)&&he.pushState({operation:"valueChange",target:V,beforeChange:d,afterChange:D}),this.resolve()})}async prompt(a,A,V){return Q(this,lt).call(this,a,A),this.submitTarget=V,v.showModal(),new Promise(h=>this.resolve=h)}}ot=new WeakMap,ct=new WeakMap,lt=new WeakMap,mn.FlMML.prepare(".editor");const K=new mn.FlMML({workerURL:ar}),q=new z;Wt.config({name:"FlMML-VisualSequencer",version:1,storeName:"backups",description:"BlockData Object Backups"});const b=new J(e,s),he=new I,Ce=new Z(g),Ne={categories:{custom:"„Ç´„Çπ„Çø„É†","smileys-emotion":"„Çπ„Éû„Ç§„É™„Éº„Å®ÊÑüÊÉÖ","people-body":"‰∫∫„ÄÖ„Å®‰Ωì","animals-nature":"ÂãïÁâ©„Å®Ëá™ÁÑ∂","food-drink":"È£ü„ÅπÁâ©„Å®È£≤„ÅøÁâ©","travel-places":"ÊóÖË°å„Å®Â†¥ÊâÄ",activities:"Ê¥ªÂãï",objects:"„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà",symbols:"„Ç∑„É≥„Éú„É´",flags:"„Éï„É©„Ç∞"},categoriesLabel:"„Ç´„ÉÜ„Ç¥„É™„Éº",emojiUnsupportedMessage:"„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ„Ç´„É©„ÉºÁµµÊñáÂ≠ó„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ",favoritesLabel:"„ÅäÊ∞ó„Å´ÂÖ•„Çä",loadingMessage:"Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶",networkErrorMessage:"ÁµµÊñáÂ≠ó„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",regionLabel:"ÁµµÊñáÂ≠ó„Éî„ÉÉ„Ç´„Éº",searchDescription:"Ê§úÁ¥¢ÁµêÊûú„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà„ÄÅ‰∏ä‰∏ã„Ç≠„Éº„ÇíÊäº„Åó„Å¶ÈÅ∏Êäû„Åó„ÄÅEnter „Ç≠„Éº„ÇíÊäº„Åó„Å¶ÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ",searchLabel:"Ê§úÁ¥¢",searchResultsLabel:"Ê§úÁ¥¢ÁµêÊûú",skinToneDescription:"Â±ïÈñã„Åï„Çå„ÅüÁä∂ÊÖã„Åß„ÄÅ‰∏ä‰∏ã„Ç≠„Éº„ÇíÊäº„Åó„Å¶ÈÅ∏Êäû„Åó„ÄÅEnter „Ç≠„Éº„ÇíÊäº„Åó„Å¶ÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ",skinToneLabel:"„Çπ„Ç≠„É≥„Éà„Éº„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁèæÂú®„ÅÆ„Çπ„Ç≠„É≥„Éà„Éº„É≥„ÅØ {skinTone} „Åß„ÅôÔºâ",skinTones:["„Éá„Éï„Ç©„É´„Éà","„É©„Ç§„Éà","„Éü„Éá„Ç£„Ç¢„É†„É©„Ç§„Éà","„Éü„Éá„Ç£„Ç¢„É†","„Éü„Éá„Ç£„Ç¢„É†„ÉÄ„Éº„ÇØ","„ÉÄ„Éº„ÇØ"],skinTonesLabel:"„Çπ„Ç≠„É≥„Éà„Éº„É≥"},Oe=new ln({i18n:Ne,locale:"ja"});Pa.polyfill({holdToDrag:500}),Ra();const O=p=>`<span class="material-icons">${p}</span>`,T=O("play_arrow")+"ÂÜçÁîü",H=O("stop")+"ÂÅúÊ≠¢",ie=()=>{b.playRendering()},ce=()=>{F.innerHTML=K.getWarnings().replaceAll(`
`,"<br>")};K.addEventListener("compilecomplete",ce);const me=()=>{j.innerHTML=T,b.stopRendering(),K.removeEventListener("compilecomplete",ie),E.disabled=!1};K.addEventListener("complete",me),q.onChange=(p,a)=>{w.innerHTML=a?`<pre><code>${Ba(a).replaceAll(`
`,"<br>")}</code></pre>`:"(„Å™„Åó)";const A=!!p.length;[S,ue].forEach(V=>{V.disabled=!A})},q.onError=(p,a)=>{alert(p+`
`+a)},b.checkSavedBlocksData();const fe=p=>{var _,oe;const a=()=>{let P=p.parentElement;for(;P&&!("noteValue"in P.firstElementChild.dataset);)P=P.previousElementSibling;return(P==null?void 0:P.firstElementChild)||null},A=()=>{var N;let P=p.parentElement;for(;P&&!((N=P.firstElementChild.dataset.octave)!=null&&N.startsWith("o"));)P=P.previousElementSibling;return(P==null?void 0:P.firstElementChild)||null},V=()=>{var y;let P=p.parentElement.nextElementSibling,N="";for(;P&&((y=P.firstElementChild.dataset.tieSlur)!=null&&y.match(/&[0-9]+\.*/));)N+=P.firstElementChild.dataset.tieSlur,P=P.nextElementSibling;return N},h=((_=a())==null?void 0:_.dataset.noteValue)||"",d=((oe=A())==null?void 0:oe.dataset.octave)||"",D=[...b.activeTrack.children].indexOf(p.parentElement),G=[...b.activeTrack.children].slice(0,D).filter(P=>"tonePitch"in P.firstElementChild.dataset||"octave"in P.firstElementChild.dataset&&!P.firstElementChild.dataset.octave.startsWith("o")).map(P=>((P.firstElementChild.dataset.tonePitch||P.firstElementChild.dataset.octave).match(/[><]+/)||[""])[0]).join(""),C=[">","<"],$=(P,N)=>(P.match(new RegExp(N,"g"))||[]).length,L=(()=>{const P=-$(G,C[0])+$(G,C[1]);return P<0?C[0].repeat(-P):P>0?C[1].repeat(P):""})(),W=V();K.play(p.dataset.tone+h+d+L+p.dataset.tonePitch+W)};he.onPopstate=p=>{const a=p.data,A=V=>!!a.parent.closest("#"+V);switch(p.reason){case"undo":switch(a==null?void 0:a.operation){case"append":q.delete(a.index);break;case"delete":q.insert(a.index,a.mmlText);break;case"rewrite":q.rewrite(a.index,a.beforeMmlText);break;case"copy":a.newElem.remove(),A("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q));break;case"move":const V=a.fromIndex<=a.toIndex?"beforebegin":"afterend";a.parent.children[a.fromIndex].insertAdjacentElement(V,a.elem),A("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q));break;case"valueChange":for(const[h,d]of Object.entries(a.beforeChange))a.target.dataset[h]=d;"tone"in a.target.dataset&&fe(a.target),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q);break;case"remove":a.parent.insertBefore(a.removedElem,a.parent.children[a.removedIndex]),A("tones")||A("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q));break;case"clear":a.tonesChildren.forEach(h=>{e.querySelector("ul").appendChild(h)}),a.musicalScoreChildren.forEach(h=>{s.insertBefore(h,m)}),re=a.lastTouchedButton,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q);break}break;case"redo":switch(a==null?void 0:a.operation){case"append":q.append(a.mmlText);break;case"delete":q.delete(a.index);break;case"rewrite":q.rewrite(a.index,a.afterMmlText);break;case"copy":a.toIndex!==-1?a.parent.insertBefore(a.newElem,a.parent.children[a.toIndex]):a.parent.appendChild(a.newElem),A("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q)),"tonePitch"in re.dataset&&(fe(re),re.classList.add("bounce"));break;case"move":const V=a.toIndex>a.fromIndex?"beforebegin":"afterend";a.toIndex!==-1?a.parent.children[a.toIndex].insertAdjacentElement(V,a.elem):a.parent.appendChild(a.elem),A("musical-score")&&(b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q));break;case"valueChange":for(const[d,D]of Object.entries(a.afterChange))a.target.dataset[d]=D;"tone"in a.target.dataset&&fe(a.target),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q);break;case"remove":const h=a.removedElem.className;a.removedElem.remove(),A("tones")&&s.querySelectorAll(`[class*="${h}"]`).forEach(d=>{d.parentElement.remove()}),b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q);break;case"clear":e.querySelector("ul").textContent="",s.querySelectorAll(".track").forEach((d,D)=>{D?d.remove():(d.textContent="",b.activeTrack=d)}),re=null,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q);break}break}};const Se=()=>{const p=[...e.getElementsByTagName("button")].map(a=>[...a.classList].find(A=>A.includes("note-")));for(let a=1;;a++)if(!p.includes("note-"+a))return"note-"+a};document.addEventListener("keydown",p=>{var A;const a=p.ctrlKey||ee.checked;switch((A=p.key)==null?void 0:A.toLowerCase()){case" ":document.activeElement.tagName.toLowerCase()!=="input"&&(p.preventDefault(),j.click());break;case"s":a&&(p.preventDefault(),!ue.disabled&&ue.click());break;case"o":a&&(p.preventDefault(),!ve.disabled&&ve.click());break;case"z":a&&he.undo();break;case"y":a&&he.redo();break}});const we=async p=>{const a=p.dataset,A={tempo:h=>({tempo:h.replace("t","")}),noteValue:h=>({"note-value":(h.match(/[0-9]+/)||[""])[0],dot:(h.match(/\.+/)||[""])[0].length}),rest:h=>({rest:(h.match(/[0-9]+/)||[""])[0],dot:(h.match(/\.+/)||[""])[0].length}),octave:h=>({octave:h.startsWith("o")?h.replace("o",""):(h.match(/[><]+/)||[""])[0].length}),velocity:h=>({velocity:h.startsWith("@v")?h.replace("@v",""):Number((h.match(/[0-9]+/)||[""])[0])*(h.startsWith("(")?1:-1)}),noteShift:h=>({"note-shift":(h.match(/[0-9]+/)||[""])[0]}),detune:h=>({detune:h.replace("@d","")}),tieSlur:h=>({"tie-slur":(h.match(/[0-9]+/)||[""])[0],dot:(h.match(/\.+/)||[""])[0].length}),repeatStartEnd:h=>({repeat:h.replace("/:","")}),macroDef:h=>({"macro-def-name":(h.match(/\$([^\{\=]*)[\{\=]/)||[,""])[1],"macro-def-arg":(h.match(/\{([^\}]*)\}/)||[,""])[1]}),macroArgUse:h=>({"macro-arg-use":h.replace("%","")}),macroUse:h=>({"macro-use-name":(h.match(/\$([^\{]*)\{?/)||[,""])[1],"macro-use-arg":(h.match(/\{([^\}]*)\}/)||[,""])[1]}),metaData:h=>({run:()=>{const D=h.split(" "),G=["#TITLE","#ARTIST","#COMMENT","#CODING","#PRAGMA","#OCTAVE","#VELOCITY","#WAV9","#WAV10","#WAV13","#OPM","#OPN","#FMGAIN","#USING"];let C=G.findIndex(oe=>D[0].startsWith(oe));C===-1&&(C=0),g.elements["select-meta-data"].selectedIndex=C;const $=oe=>g.elements[oe].previousSibling,L=()=>g.elements["select-meta-data"].selectedOptions[0],W=(oe,P)=>{$("number").nodeValue=oe[0],g.elements.number.value=oe[1],g.elements.number.parentElement.style.display=oe[2]?"none":"",$("text").nodeValue=P[0],g.elements.text.value=P[1],g.elements.text.parentElement.style.display=P[2]?"none":""},_=oe=>{var y,ye,Ee;const P=oe===C,N=G[oe];switch(N){case"#TITLE":case"#ARTIST":case"#COMMENT":case"#CODING":case"#PRAGMA":const Le=P?D.slice(1).join(" ")??"":"";W(["ÁÑ°Âäπ","",!0],[L().label,Le,!1]);break;case"#OCTAVE":case"#VELOCITY":W(["ÁÑ°Âäπ","",!0],["ÁÑ°Âäπ","",!0]);break;case"#WAV9":case"#WAV10":case"#WAV13":const Qe=N==="#WAV9",Ke=P?((y=D.slice(1).join(" "))==null?void 0:y.split(","))??[]:[];W(["Ê≥¢ÂΩ¢Áï™Âè∑",Ke[0]??0,!1],Qe?["ÂàùÊúüÂ§â‰Ωç,„É´„Éº„Éó„Éï„É©„Ç∞,„Éá„Éº„Çø",`${Ke[1]??0},${Ke[2]??0},${Ke[3]??""}`,!1]:["„Éá„Éº„Çø",Ke[1]??"",!1]),g.elements.number.min=0,g.elements.number.max=Qe?15:31;break;case"#OPM":case"#OPN":W(["Èü≥Ëâ≤Áï™Âè∑",P?((ye=D[0])==null?void 0:ye.split("@")[1])??0:0,!1],["„Éá„Éº„Çø",P?((Ee=D.slice(1).join(" "))==null?void 0:Ee.slice(1,-1))??"":"",!1]),g.elements.number.min=0,g.elements.number.max=127;break;case"#FMGAIN":W(["Èü≥ÈáèÂà©Âæó",P?D[1].replace(`
`,"")??91:91,!1],["ÁÑ°Âäπ","",!0]),g.elements.number.min=-127,g.elements.number.max=127;break;case"#USING":W(["ÂíåÈü≥Èáç„Å≠Êï∞",P?D[2].replace(`
`,"")??2:2,!1],["ÁÑ°Âäπ","",!0]),g.elements.number.min=1,g.elements.number.max="";break}};_(C),g.elements["select-meta-data"].addEventListener("change",oe=>{_(oe.target.selectedIndex)})}}),otherAction:h=>({"other-action":h}),remove:()=>({})},V=Object.keys(a);for(const h of V)if(h in A){let d=a[h];switch(h){case"repeatStartEnd":if(d===":/"){const $=(()=>{var W;let L=p.parentElement;for(;L&&!((W=L.firstElementChild.dataset.repeatStartEnd)!=null&&W.startsWith("/:"));)L=L.previousElementSibling;return(L==null?void 0:L.firstElementChild)||null})();if($)p=$;else{const L=b.activeTrack,W=document.createElement("li"),oe=i.querySelector(".repeat-start-end").cloneNode(!0);W.appendChild(oe),L.insertBefore(W,p.parentElement),p=oe}d=p.dataset.repeatStartEnd}break;case"macroDef":if(d===";")return;break}const D=h,G=A[h](d);await Ce.prompt(D,G,p);break}};let re=e.querySelector("button");n.addEventListener("click",async p=>{const a=p.ctrlKey||ee.checked,A=h=>!!p.target.closest("#"+h),V=p.target.tagName.toLowerCase()==="button";if(![e,i,s].some(h=>h.classList.contains("no-op"))){if(A("tones"))if(V)re=p.target,await Ce.prompt("tone",{"tone-name":p.target.ariaLabel,"tone-def":p.target.dataset.tone,run:()=>{const h=g.elements["tone-name"];h.insertAdjacentElement("afterend",Oe);const d=document.querySelector("emoji-picker");h.addEventListener("focus",()=>{d.classList.add("expaned")},{once:!0}),d.addEventListener("emoji-click",D=>h.value=D.detail.unicode)}},p.target),K.play(p.target.dataset.tone+p.target.dataset.tonePitch),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q);else{const h=e.querySelector("ul"),d=document.createElement("li"),G=`<button class="material-icons note ${Se()}" aria-label="ÁÑ°Ë™øÊï¥" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>`;d.innerHTML=G;const C=d.firstElementChild;h.appendChild(d),re=C,K.play(C.dataset.tone+C.dataset.tonePitch),he.pushState({operation:"copy",toIndex:-1,newElem:d,parent:h})}else if(A("action")){if(V){"otherAction"in p.target.dataset&&await we(p.target);const h=b.activeTrack,d=document.createElement("li"),D=p.target.cloneNode(!0);if(("metaData"in D.dataset||"macroDef"in D.dataset||"macroArgUse"in D.dataset||"macroUse"in D.dataset)&&await we(D),"tieSlur"in D.dataset?D.ariaLabel="„Çπ„É©„Éº":"repeatStartEnd"in D.dataset?(D.classList.remove("material-icons"),D.ariaLabel="„É™„Éî„Éº„ÉàÈñãÂßã",D.textContent="‚óÜ",D.dataset.repeatStartEnd="/:"):"polyStartEnd"in D.dataset?(D.dataset.polyStartEnd="[",D.textContent="["):"macroDef"in D.dataset&&(D.textContent="$="),d.appendChild(D),h.appendChild(d),re=D,b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q),he.pushState({operation:"copy",toIndex:-1,newElem:d,parent:h}),"repeatStartEnd"in re.dataset||"polyStartEnd"in re.dataset||"macroDef"in re.dataset){const G=document.createElement("li"),C=p.target.cloneNode(!0);"repeatStartEnd"in re.dataset?(C.ariaLabel="„É™„Éî„Éº„ÉàÁµÇ‰∫Ü",C.dataset.repeatStartEnd=":/"):"polyStartEnd"in re.dataset?(C.dataset.polyStartEnd="]",C.textContent="]"):"macroDef"in re.dataset&&(C.dataset.macroDef=";",C.textContent=";"),G.appendChild(C),re.parentElement.insertAdjacentElement("afterend",G),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q),he.pushState({operation:"copy",toIndex:-1,newElem:G,parent:h})}}}else if(A("musical-score")){if(V&&p.target!==m&&p.target!==o)p.target.closest(".track")&&(b.activeTrack=p.target.closest(".track")),"tone"in p.target.dataset?(fe(p.target),nt(p.target,"bounce"),a&&(await Ce.prompt("tonePitch",{"tone-pitch":(p.target.dataset.tonePitch.match(/[0-9]+/)||[""])[0],dot:(p.target.dataset.tonePitch.match(/\.+/)||[""])[0].length},p.target),fe(p.target))):await we(p.target),re=p.target,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q);else if(re){p.target.closest(".track")&&(b.activeTrack=p.target.closest(".track"));const h=b.activeTrack,d=document.createElement("li"),D=re.cloneNode(!0);if("repeatStartEnd"in D.dataset&&(D.classList.remove("material-icons"),D.ariaLabel="„É™„Éî„Éº„ÉàÈñãÂßã",D.textContent="‚óÜ",D.dataset.repeatStartEnd="/:"+(D.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]),d.appendChild(D),h.appendChild(d),re=D,b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q),he.pushState({operation:"copy",toIndex:-1,newElem:d,parent:h}),"tonePitch"in D.dataset)D.dataset.tonePitch=D.dataset.tonePitch.replace(/[><]+/,""),fe(D),D.classList.add("bounce");else if("repeatStartEnd"in re.dataset){const G=document.createElement("li"),C=re.cloneNode(!0);C.classList.add("material-icons"),C.ariaLabel="„É™„Éî„Éº„ÉàÁµÇ‰∫Ü",C.textContent="repeat",C.dataset.repeatStartEnd=":/",G.appendChild(C),re.parentElement.insertAdjacentElement("afterend",G),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q),he.pushState({operation:"copy",toIndex:-1,newElem:G,parent:h})}}}}}),n.addEventListener("contextmenu",p=>{var h,d,D,G;const a=C=>C.closest("#tones, #musical-score"),A=C=>!!p.target.closest("#"+C),V=p.target.tagName.toLowerCase()==="button";if(!((h=a(p.target))!=null&&h.classList.contains("no-op"))&&a(p.target)){const C=V&&p.target!==m&&p.target!==o?p.target:re;if(!C||a(C)!==a(p.target))return;p.preventDefault(),b.activeTrack=C.closest(".track")||b.activeTrack;const $=C.parentElement,L=C.className,W=((d=C.closest("#tones"))==null?void 0:d.querySelector("ul"))||b.activeTrack,_=[...W.children].indexOf($);re=((D=$.previousElementSibling)==null?void 0:D.firstElementChild)||((G=$.nextElementSibling)==null?void 0:G.firstElementChild)||null,he.pushState({operation:"remove",removedElem:$,removedIndex:_,parent:W}),A("tones")?s.querySelectorAll(`[class*="${L}"]`).forEach(oe=>{oe.parentElement.remove()}):"macroDef"in C.dataset&&s.querySelectorAll(`[data-macro-use="${C.dataset.macroDef.replace("=","")}"]`).forEach(oe=>{oe.parentElement.remove()}),$.remove(),b.blocksDataUpdate(),b.calcPoly(),b.saveBlocksData(),b.exportMml(q)}});let je=null,Pe=!1,k=null;n.addEventListener("touchstart",p=>{je=[...p.touches].at(-1).pageY,k=setTimeout(()=>{Pe=!0},500)});const X=p=>{const a=p.ctrlKey||ee.checked,A=D=>!!p.target.closest("#"+D),V=p.target.tagName.toLowerCase()==="button";if(p.type==="touchmove"){const D=[...p.touches].at(-1).pageY;if(Pe){p.cancelable&&p.preventDefault();return}else if(D-je<-20)p.deltaY=-1,clearTimeout(k);else if(D-je>20)p.deltaY=1,clearTimeout(k);else{p.cancelable&&p.preventDefault();return}je=D,Pe=!0,setTimeout(()=>Pe=!1,50)}const h=p.deltaY<0;let d=V?p.target:(re==null?void 0:re.closest("#musical-score"))&&re;if(d){if(A("musical-score")){if(s.classList.contains("no-op"))return;p.preventDefault();let D=JSON.parse(JSON.stringify(d.dataset));if(!a&&"tone"in d.dataset){const C=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"],$=[">","<"],L=d.dataset.tonePitch,W=C.findIndex(ye=>L.match(/[a-g]\+?/)[0]===ye),_=(ye,Ee)=>(ye.match(new RegExp(Ee,"g"))||[]).length,oe=[_(L,$[0]),_(L,$[1])],P=$[0].repeat(oe[0])+$[1].repeat(oe[1]),N=(L.match(/[0-9]+/)||[""])[0],y=".".repeat((d.dataset.tonePitch.match(/\.+/)||[""])[0].length);h?W===C.length-1?oe[0]?d.dataset.tonePitch=P.substring(1)+C.at(0)+N+y:d.dataset.tonePitch=P+$[1]+C.at(0)+N+y:d.dataset.tonePitch=P+C[W+1]+N+y:W===0?oe[1]?d.dataset.tonePitch=P.substring(1)+C.at(-1)+N+y:d.dataset.tonePitch=P+$[0]+C.at(-1)+N+y:d.dataset.tonePitch=P+C[W-1]+N+y,fe(d)}else{const C=h?1:-1,$=(L,W=-1/0,_=1/0)=>L+C<W||L+C>_?0:C;if(a&&"tonePitch"in d.dataset){const L=Number((d.dataset.tonePitch.match(/[0-9]+/)||[""])[0]),W=".".repeat((d.dataset.tonePitch.match(/\.+/)||[""])[0].length),_=$(L,0,384),oe=L+_!==0?L+_:"";d.dataset.tonePitch=d.dataset.tonePitch.replace(/[0-9]*\.*/g,"")+oe+W,fe(d)}else if("tempo"in d.dataset){const L=Number(d.dataset.tempo.replace("t","")),W=$(L,0);d.dataset.tempo="t"+(L+W*10)}else if("noteValue"in d.dataset){const L=Number((d.dataset.noteValue.match(/[0-9]+/)||[""])[0]),W=$(L,1,384);d.dataset.noteValue=d.dataset.noteValue.replace(/[0-9]+/,L+W)}else if("rest"in d.dataset){const L=Number((d.dataset.rest.match(/[0-9]+/)||[""])[0]),W=".".repeat((d.dataset.rest.match(/\.+/)||[""])[0].length),_=$(L,0,384),oe=L+_!==0?L+_:"";d.dataset.rest="r"+oe+W}else if("octave"in d.dataset)if(d.dataset.octave.startsWith("o")){const W=Number(d.dataset.octave.replace("o","")),_=$(W,0,8);d.dataset.octave="o"+(W+_)}else{const W=(d.dataset.octave.match(/<+/)||[""])[0].length-(d.dataset.octave.match(/>+/)||[""])[0].length,_=$(W,-8,8);d.dataset.octave=W+_>0?"<".repeat(W+_):">".repeat(-(W+_))}else if("velocity"in d.dataset)if(d.dataset.velocity.startsWith("@v")){const W=Number(d.dataset.velocity.replace("@v","")),_=$(W,0,127);d.dataset.velocity="@v"+(W+_)}else{const W=Number((d.dataset.velocity.match(/[0-9]+/)||[""])[0])*(d.dataset.velocity.startsWith("(")?1:-1),_=$(W,-127,127);d.dataset.velocity=(W+_>=0?"(":")")+Math.abs(W+_)}else if("noteShift"in d.dataset){const L=Number((d.dataset.noteShift.match(/-?[0-9]+/)||[""])[0]),W=C;d.dataset.noteShift=d.dataset.noteShift.match(/@?ns/)[0]+(L+W)}else if("detune"in d.dataset){const L=Number(d.dataset.detune.replace("@d","")),W=C;d.dataset.detune="@d"+(L+W)}else if("tieSlur"in d.dataset){const L=Number((d.dataset.tieSlur.match(/[0-9]+/)||[""])[0]),W=".".repeat((d.dataset.tieSlur.match(/\.+/)||[""])[0].length),_=$(L,0,384),oe=L+_!==0?L+_:"";d.dataset.tieSlur="&"+oe+W,d.dataset.tieSlur==="&"?d.ariaLabel="„Çπ„É©„Éº":d.ariaLabel="„Çø„Ç§"}else if("repeatStartEnd"in d.dataset){if(d.dataset.repeatStartEnd===":/"){const P=(()=>{var y;let N=d.parentElement;for(;N&&!((y=N.firstElementChild.dataset.repeatStartEnd)!=null&&y.startsWith("/:"));)N=N.previousElementSibling;return(N==null?void 0:N.firstElementChild)||null})();if(P)d=P;else{const N=b.activeTrack,y=document.createElement("li"),Ee=i.querySelector(".repeat-start-end").cloneNode(!0);y.appendChild(Ee),N.insertBefore(y,d.parentElement),d=Ee}D=JSON.parse(JSON.stringify(d.dataset))}const L=Number((d.dataset.repeatStartEnd.match(/[0-9]+/)||[-1])[0]),W=$(L,-1),_=L+W!==-1?L+W:"";d.dataset.repeatStartEnd="/:"+_}}const G=JSON.parse(JSON.stringify(d.dataset));JSON.stringify(D)!==JSON.stringify(G)&&he.pushState({operation:"valueChange",target:d,beforeChange:D,afterChange:G}),re=d,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q)}}else return};n.addEventListener("wheel",X),n.addEventListener("touchmove",X),n.addEventListener("touchend",()=>{Pe=!1});let se={};n.addEventListener("dragstart",p=>{se={from:p.target.nodeType===1&&p.target.closest("#tones, #action, #musical-score"),item:p.target},p.dataTransfer.effectAllowed="copyMove"});let le=null;[e,i,s].forEach(p=>{const a=d=>{const D=d.ctrlKey||ee.checked,{from:G=null}=se,C=d.dataTransfer;switch(G){case e:switch(p){case e:d.preventDefault(),D?C.dropEffect="copy":C.dropEffect="move";break;case i:break;case s:d.preventDefault(),C.dropEffect="copy";break}break;case i:switch(p){case e:break;case i:break;case s:d.preventDefault(),C.dropEffect="copy";break}break;case s:switch(p){case e:break;case i:break;case s:d.preventDefault(),D?C.dropEffect="copy":C.dropEffect="move";break}break}le=C.dropEffect};p.addEventListener("dragover",a);const A=d=>{const{from:D=null}=se,G=d.target.tagName.toLowerCase()==="button",C=()=>d.target.classList.add("droppable");switch(D){case e:switch(p){case e:d.preventDefault(),G&&C();break;case i:break;case s:d.preventDefault(),G&&C();break}break;case i:switch(p){case e:break;case i:break;case s:d.preventDefault(),G&&C();break}break;case s:switch(p){case e:break;case i:break;case s:d.preventDefault(),G&&C();break}break}};p.addEventListener("dragenter",A);const V=d=>{const{from:D=null}=se,G=d.target.tagName.toLowerCase()==="button",C=()=>d.target.classList.remove("droppable");switch(D){case e:switch(p){case e:G&&C();break;case i:break;case s:G&&C();break}break;case i:switch(p){case e:break;case i:break;case s:G&&C();break}break;case s:switch(p){case e:break;case i:break;case s:G&&C();break}break}};p.addEventListener("dragleave",V),p.addEventListener("drop",async d=>{var oe,P;if(d.preventDefault(),(oe=d.dataTransfer.items)!=null&&oe.length)return;d.dataTransfer.dropEffect=d.dataTransfer.dropEffect!=="none"?d.dataTransfer.dropEffect:le;const{from:D,item:G}=se,C=((P=d.target.closest("#tones"))==null?void 0:P.querySelector("ul"))||d.target.closest(".track")||b.activeTrack,$=[...C.children].indexOf(G.parentElement),L=[...C.children].indexOf(d.target.parentElement),W=d.target.tagName.toLowerCase()==="button";let _;switch(d.dataTransfer.dropEffect){case"copy":const N=document.createElement("li"),y=G.cloneNode(!0);if(p===e){const ye=[...G.classList].find(Ee=>Ee.includes("note-"));y.classList.replace(ye,Se())}else D===i&&("tieSlur"in y.dataset?y.ariaLabel="„Çπ„É©„Éº":("metaData"in y.dataset||"macroDef"in y.dataset||"macroArgUse"in y.dataset||"macroUse"in y.dataset||"otherAction"in y.dataset)&&await we(y));"repeatStartEnd"in y.dataset?(y.classList.remove("material-icons"),y.ariaLabel="„É™„Éî„Éº„ÉàÈñãÂßã",y.textContent="‚óÜ",y.dataset.repeatStartEnd="/:"+(y.dataset.repeatStartEnd.match(/[0-9]+/)||[""])[0]):"polyStartEnd"in y.dataset?(y.dataset.polyStartEnd="[",y.textContent="["):"macroDef"in y.dataset&&(y.dataset.macroDef===";"&&(y.dataset.macroDef="$="),y.textContent="$="),N.appendChild(y),_=N;break;case"move":_=G.parentElement;break}if(W&&d.target.id!=="add-track"&&d.target.id!=="remove-track"){const N=d.dataTransfer.dropEffect==="copy"||L<$?"beforebegin":"afterend";d.target.parentElement.insertAdjacentElement(N,_)}else C.appendChild(_);switch(re=_.firstElementChild,p===s&&(b.activeTrack=C,b.blocksDataUpdate(),d.dataTransfer.dropEffect==="move"&&b.calcPoly(),b.saveBlocksData(),b.exportMml(q),"tonePitch"in re.dataset&&(re.dataset.tonePitch=re.dataset.tonePitch.replace(/[><]+/,""),fe(re),re.classList.add("bounce"))),d.dataTransfer.dropEffect){case"copy":he.pushState({operation:"copy",toIndex:L,newElem:_,parent:C});break;case"move":he.pushState({operation:"move",fromIndex:$,toIndex:L,elem:_,parent:C});break}if(d.dataTransfer.dropEffect==="copy"&&("repeatStartEnd"in re.dataset||"polyStartEnd"in re.dataset||"macroDef"in re.dataset)){const N=document.createElement("li"),y=G.cloneNode(!0);"repeatStartEnd"in re.dataset?(y.classList.add("material-icons"),y.ariaLabel="„É™„Éî„Éº„ÉàÁµÇ‰∫Ü",y.textContent="repeat",y.dataset.repeatStartEnd=":/"):"polyStartEnd"in re.dataset?(y.dataset.polyStartEnd="]",y.textContent="]"):"macroDef"in re.dataset&&(y.dataset.macroDef=";",y.textContent=";"),N.appendChild(y),_.insertAdjacentElement("afterend",N),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q),he.pushState({operation:"copy",toIndex:L+1,newElem:N,parent:C})}});const h=d=>{[...document.getElementsByClassName("droppable")].forEach(D=>{D.classList.remove("droppable")})};p.addEventListener("dragend",h)}),n.addEventListener("animationend",p=>{p.target.classList.remove("bounce"),p.target.classList.remove("pop")}),m.addEventListener("click",p=>{p.stopPropagation();const a=document.createElement("ul");a.classList.add("track"),b.activeTrack=a,s.insertBefore(a,m)}),o.addEventListener("click",p=>{p.stopPropagation();const a=[...document.getElementsByClassName("track")].at(-1),A=a.previousElementSibling;a.remove(),b.activeTrack=A,b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q)}),v.addEventListener("pointerdown",p=>{p.target===v&&v.addEventListener("pointerup",a=>{a.target===v&&v.close()},{once:!0})}),v.addEventListener("close",()=>{switch(Ce.type){case"tone":document.querySelector("emoji-picker").classList.remove("expaned");break}}),j.addEventListener("click",()=>{const p=K.isPlaying();p?(K.stop(),b.stopRendering(),K.removeEventListener("compilecomplete",ie),E.disabled=!1):(K.play(q.getMml()),K.addEventListener("compilecomplete",ie),E.disabled=!0),j.innerHTML=p?T:H}),E.addEventListener("click",()=>{if(confirm("Èü≥Ëâ≤„Å®ËøΩÂä†„Åó„Åü„Éñ„É≠„ÉÉ„ÇØ„ÇíÂÖ®„Å¶Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")){const p=[...s.children];p.pop(),he.pushState({operation:"clear",tonesChildren:[...e.querySelector("ul").children],musicalScoreChildren:p,lastTouchedButton:re}),e.querySelector("ul").textContent="";const a=e.querySelector("ul"),A=document.createElement("li"),V='<button class="material-icons note note-1" aria-label="ÁÑ°Ë™øÊï¥" draggable="true" data-tone="" data-tone-pitch="c">music_note</button>';A.innerHTML=V;const h=A.firstElementChild;a.appendChild(A),re=h,s.querySelectorAll(".track").forEach((d,D)=>{D?d.remove():(d.textContent="",b.activeTrack=d)}),b.blocksDataUpdate(),b.saveBlocksData(),b.exportMml(q)}}),S.addEventListener("click",()=>{const p=q.getMml(),a=S.innerHTML;S.disabled=!0,navigator.clipboard.writeText(p).then(()=>{S.disabled=!0,S.innerHTML=O("content_copy")+"„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü",setTimeout(()=>{S.innerHTML=a,S.disabled=!1},1500)}).catch(A=>alert(`„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü
`+A))}),B.addEventListener("click",()=>{const p=B.innerHTML;B.disabled=!0,navigator.clipboard.readText().then(a=>{B.disabled=!0,a?(q.setMml(a.replace(/\r/g,"")),b.importMml(q),B.innerHTML=O("content_paste")+"Ë≤º„Çä‰ªò„Åë„Åæ„Åó„Åü"):B.innerHTML=O("content_paste")+"ÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",setTimeout(()=>{B.innerHTML=p,B.disabled=!1},1500)}).catch(a=>alert(`Ë≤º„Çä‰ªò„Åë„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü
`+a))}),ue.addEventListener("click",()=>{var d;const p=q.getMml(),A=((d=q.getMmlArr().find(D=>D.startsWith("#TITLE")))==null?void 0:d.split(" ").slice(1).join(" "))??"ÁÑ°È°å",V=new Blob([p],{type:"text/plain"}),h=document.createElement("a");h.download=A+".mml",h.href=URL.createObjectURL(V),h.click(),URL.revokeObjectURL(h.href),A==="ÁÑ°È°å"&&alert("„Éï„Ç°„Ç§„É´Âêç„Çí‰ªò„Åë„Çã„Å´„ÅØ„ÄÅÂÖàÈ†≠„Å´„É°„Çø„Éá„Éº„Çø„Éñ„É≠„ÉÉ„ÇØ„ÇíËøΩÂä†->„Çø„Ç§„Éà„É´„ÇíÈÅ∏Êäû„Åó„Å¶ÂÖ•Âäõ->Á¢∫ÂÆö„Åó„Å¶„Çø„Ç§„Éà„É´„Çí‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ")}),ve.addEventListener("click",()=>{const p=document.createElement("input"),a=new FileReader;p.type="file",p.accept=".mml,.flmml,.txt",p.click(),p.onchange=()=>{a.onload=()=>{q.setMml(a.result),b.importMml(q)},a.readAsText(p.files[0])}}),("ontouchstart"in window||navigator.maxTouchPoints)&&document.body.classList.add("mobile"),te.addEventListener("click",()=>he.undo()),pe.addEventListener("click",()=>he.redo())});
